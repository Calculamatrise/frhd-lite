(()=>{"use strict";function t(e,t,s,i,a){var o=[],r=e,n=t,h=(i-t)/(s-e),l=s>e?1:-1,c=i>t?1:-1,d=0;o.push(e,t);do{var p=Math.floor(r/a)==Math.floor(s/a),u=Math.floor(n/a)==Math.floor(i/a);if(p&&u)break;var g,m=0;m=Math.round(Math.floor(r/a+l)*a),0>l&&(m=Math.round(Math.ceil((r+1)/a+l)*a)-1),g=Math.round(t+(m-e)*h);var y,w=0;w=Math.round(Math.floor(n/a+c)*a),0>c&&(w=Math.round(Math.ceil((n+1)/a+c)*a)-1),y=Math.round(e+(w-t)/h),Math.pow(m-e,2)+Math.pow(g-t,2)<Math.pow(y-e,2)+Math.pow(w-t,2)?(r=m,n=g,o.push(m,g)):(r=y,n=w,o.push(y,w))}while(d++<5e3);return o}window.lite=new class{#e=null;featuredGhostsLoaded=!1;loaded=!1;snapshots=new class extends Array{push(...e){this.length>=parseInt(lite.storage.get("snapshots"))&&this.splice(0,this.length-parseInt(lite.storage.get("snapshots"))),super.push(...e)}};storage=new Map(Object.entries(JSON.parse(sessionStorage.getItem("lite"))));styleSheet=new Proxy(new Map,{get:(...e)=>{let[t,s,i]=e,a=Reflect.get(...e);return"function"==typeof a?(...e)=>{switch(s){case"delete":a=a.apply(t,e),this.updateCustomStyleSheet(this.styleSheet.entries());break;case"set":let[s,o]=e;a.call(t,s,new Proxy(o,{set:(...e)=>{let t=Reflect.set(...e);return this.updateCustomStyleSheet(this.styleSheet.entries()),t}})),a=i,this.updateCustomStyleSheet(this.styleSheet.entries());break;default:a=a.apply(t,e)}return a}:a}});constructor(){Application.events.subscribe("route",(()=>this.loaded=!1)),Application.events.subscribe("mainview.loaded",this.childLoad.bind(this)),GameManager.on("stateChange",(e=>{!1===e.preloading&&!1===this.loaded&&(this.loaded=this.load()),this.loaded&&this.refresh()})),this.#t(),this.childLoad(),addEventListener("message",(({data:e})=>{if(e&&"updateStorage"===e.action){let t=new Map(this.storage);this.storage=new Map(Object.entries(e.storage));let s=new Map;for(const[e,i]of this.storage.entries())JSON.stringify(i)!=JSON.stringify(t.get(e))&&s.set(e,i);this.updateFromSettings(s)}}))}get scene(){return GameManager.game&&GameManager.game.currentScene}#t(){this.#e=document.head.appendChild(document.createElement("style")),this.#e.setAttribute("id","frhd-lite-style")}updateCustomStyleSheet(e){const t=Array.from(e).filter((([e,t])=>Object.values(t).length));let s="";for(let[e,i]of t){i=Object.entries(i);for(let e of i)e[0]=e[0].replace(/([A-Z])/g,(e=>"-"+e.toLowerCase()));s+=e+"{"+i.map((e=>e.join(":"))).join(";")+"}"}this.#e.textContent=s}load(){return this.snapshots.splice(0,this.snapshots.length),this.updateFromSettings(this.storage),!0}childLoad(){this.storage.get("accountManager")&&this.initAccountManager(),this.storage.get("dailyAchievementsDisplay")&&this.initAchievementsDisplay(),location.pathname.match(/^\/t\//i)&&(this.initBestDate(),this.initGhostPlayer(),Application.settings.user.u_id===GameSettings.track.u_id&&this.initDownloadTracks(),this.initDownloadGhosts()),this.storage.get("featuredGhostsDisplay")&&this.initFeaturedGhosts(),location.pathname.match(/^\/u\//i)&&this.initFriendsLastPlayed(),location.pathname.match(/^\/account\/settings\/?/i)&&this.initRequestTrackData()}updateFromSettings(e=this.storage){if(this.scene){for(const[t,s]of e.entries())switch(t){case"keymap":this.scene.playerManager.firstPlayer._gamepad.setKeyMap("Editor"!==GameManager.scene?GameSettings.playHotkeys:GameSettings.editorHotkeys);break;case"theme":{let e="#".padEnd(7,"midnight"==this.storage.get("theme")?"1d2328":"dark"==this.storage.get("theme")?"1b":"f");GameManager.game.canvas.style.setProperty("background-color",e),this.styleSheet.set(".gameFocusOverlay",{backgroundColor:GameManager.game.canvas.style.getPropertyValue("background-color").replace(/[,]/g,"").replace(/(?=\))/,"/90%"),color:"#".padEnd(7,"midnight"==this.storage.get("theme")?"d":"dark"==this.storage.get("theme")?"eb":"2d")}),this.scene.message.color=/^#(0|3){3,6}$/.test(this.scene.message.color)&&/^(dark|midnight)$/i.test(this.storage.get("theme"))?"#ccc":"#333",this.scene.message.outline=e;let t="#".padEnd(7,/^(dark|midnight)$/i.test(this.storage.get("theme"))?"6":"9");this.scene.score.best_time.color=t,this.scene.score.best_time_title.color=t;let s="#".padEnd(7,"midnight"==this.storage.get("theme")?"d":"dark"==this.storage.get("theme")?"f":"0");this.scene.score.goals.color=s,this.scene.score.time.color=s,this.scene.score.time_title.color=t,this.scene.hasOwnProperty("campaignScore")&&(this.scene.campaignScore.container.color=s,this.scene.campaignScore.container.children.forEach((e=>{e.color=s}))),this.scene.hasOwnProperty("raceTimes")&&(this.scene.raceTimes.container.color=s),GameSettings.physicsLineColor="#".padEnd(7,"midnight"==this.storage.get("theme")?"c":"dark"==this.storage.get("theme")?"fd":"0"),GameSettings.sceneryLineColor="#".padEnd(7,"midnight"==this.storage.get("theme")?"4":"dark"==this.storage.get("theme")?"6":"a"),this.scene.toolHandler.options.gridMinorLineColor="#".padEnd(7,"midnight"==this.storage.get("theme")?"20282e":"dark"==this.storage.get("theme")?"25":"e"),this.scene.toolHandler.options.gridMajorLineColor="#".padEnd(7,"midnight"==this.storage.get("theme")?"161b20":"dark"==this.storage.get("theme")?"3e":"c")}case"isometricGrid":this.scene.redraw()}this.refresh()}}refresh(){let e=this.storage.get("keymap");for(let t in e)this.scene.playerManager.firstPlayer._gamepad.keymap[t.charCodeAt()]=e[t];for(const e of this.scene.playerManager._players)e._user.u_id==this.scene.playerManager.firstPlayer._user.u_id&&(e._baseVehicle.color="#000000"!=this.storage.get("bikeFrameColor")&&this.storage.get("bikeFrameColor")||"#".padEnd(7,"midnight"==this.storage.get("theme")?"C":"dark"==this.storage.get("theme")?"FB":"0"))}draw(e){this.storage.get("inputDisplay")&&this.drawInputDisplay(e||GameManager.game.canvas.getContext("2d"))}drawInputDisplay(e){let{downButtons:t}=this.scene.playerManager.getPlayerByIndex(this.scene.camera.focusIndex)._gamepad,s=parseInt(this.storage.get("inputDisplaySize"))+3,i={x:s,y:e.canvas.height-10*s};e.save(),e.fillStyle=GameSettings.physicsLineColor,e.globalAlpha=this.storage.get("inputDisplayOpacity"),e.lineWidth=s/2,e.strokeStyle=GameSettings.physicsLineColor;let a=s/2,o=4*s;e.beginPath(),e.roundRect(i.x,i.y,o,o,a),t.z&&e.fill(),e.stroke(),e.beginPath(),e.roundRect(i.x+5*s,i.y,o,o,a),t.up&&e.fill(),e.stroke(),e.beginPath(),e.roundRect(i.x,i.y+5*s,o,o,a),t.left&&e.fill(),e.stroke(),e.beginPath(),e.roundRect(i.x+5*s,i.y+5*s,o,o,a),t.down&&e.fill(),e.stroke(),e.beginPath(),e.roundRect(i.x+10*s,i.y+5*s,o,o,a),t.right&&e.fill(),e.stroke(),e.globalCompositeOperation="xor",e.lineWidth=s/3,e.beginPath(),e.moveTo(i.x+2.7*s,i.y+3*s),e.lineTo(i.x+1.2*s,i.y+3*s),e.lineTo(i.x+2.7*s,i.y+1*s),e.lineTo(i.x+1.2*s,i.y+1*s),e.moveTo(i.x+6.2*s,i.y+2.7*s),e.lineTo(i.x+7*s,i.y+1.2*s),e.lineTo(i.x+7.8*s,i.y+2.7*s),e.moveTo(i.x+2.5*s,i.y+7.8*s),e.lineTo(i.x+1.2*s,i.y+7*s),e.lineTo(i.x+2.5*s,i.y+6.2*s),e.moveTo(i.x+6.2*s,i.y+6.2*s),e.lineTo(i.x+7*s,i.y+7.8*s),e.lineTo(i.x+7.8*s,i.y+6.2*s),e.moveTo(i.x+11.5*s,i.y+7.8*s),e.lineTo(i.x+12.8*s,i.y+7*s),e.lineTo(i.x+11.5*s,i.y+6.2*s),e.stroke(),e.restore()}initAccountManager(){let e=document.querySelector("a.logout");e.removeAttribute("id"),e.innerText="Switch",e.addEventListener("click",(()=>{let e=this.constructor.createElement("div",{className:"simplemodal-overlay",id:"simplemodal-overlay",style:{inset:0,opacity:.5,position:"fixed",zIndex:1001}}),t=this.constructor.createElement("div",{children:[this.constructor.createElement("span",{className:"core_icons core_icons-icon_close signup-login-modal-close",onclick(){e.remove(),t.remove()}}),this.constructor.createElement("div",{children:(JSON.parse(localStorage.getItem("switcher-accounts"))??[]).map((e=>this.constructor.createAccountContainer(e))),id:"accounts-container",style:{display:"flex",flexDirection:"column",gap:"0.4rem"}}),this.constructor.createElement("button",{className:"btn new-button button-type-2",innerText:"Add account",onclick(){if(document.querySelector("div#login-container"))return this.innerText="Add account",this.classList.remove("moderator-remove-race"),void document.querySelector("div#login-container").remove();this.before(lite.constructor.createElement("div",{children:[lite.constructor.createElement("input",{className:"field auth-field",id:"save-account-login",placeholder:"Username or Email",style:{borderRadius:"2rem"},type:"text"}),lite.constructor.createElement("input",{className:"field auth-field",id:"save-account-password",placeholder:"Password",style:{borderRadius:"2rem"},type:"password"}),lite.constructor.createElement("button",{className:"new-button button-type-1",innerText:"Save account",onclick(){Application.Helpers.AjaxHelper.post("/auth/standard_login",{login:document.querySelector("#save-account-login")?.value,password:document.querySelector("#save-account-password")?.value}).done((e=>{if(e.result){let t=JSON.parse(localStorage.getItem("switcher-accounts"))||[];if(t.find((({login:t})=>t===e.data.user.d_name)))return;t.push({login:e.data.user.d_name,password:document.querySelector("#save-account-password")?.value}),document.querySelector("#accounts-container")?.append(lite.constructor.createAccountContainer(t[t.length-1])),localStorage.setItem("switcher-accounts",JSON.stringify(t)),this.parentElement.remove()}}))}})],id:"login-container",style:{display:"flex",flexDirection:"column",gap:"0.4rem",marginTop:"1rem"}})),this.classList.add("moderator-remove-race"),this.innerText="Cancel"}})],className:"simplemodal-container",id:"signup_login_container",style:{display:"flex",flexDirection:"column",gap:"0.6rem",height:"fit-content",inset:0,margin:"auto",maxHeight:"50vmin",maxWidth:"360px",minWidth:"230px",overflow:"hidden auto",padding:"2.5rem",position:"fixed",width:"40vmin",zIndex:1002}});document.body.append(e,t)}))}achievements=null;achievementsContainer=null;countdown=null;countdownTimer=null;initAchievementsDisplay(){this.notificationEvent||this.initNotificationEvent(),Application.events.subscribe("notification.received",(({data:e})=>{void 0!==e&&void 0!==e.achievements_earned&&Application.events.publish("achievementsEarned",e.achievements_earned),this.refreshAchievements()})),this.achievementsContainer||=this.constructor.createElement("div",{children:[this.constructor.createElement("a",{children:[this.constructor.createElement("span",{innerText:"Daily Achievements",style:{float:"left"}}),this.countdown=this.constructor.createElement("span",{className:"time-remaining",innerText:"00:00:00",style:{float:"right"}})],href:"/achievements",style:{borderBottom:"1px solid gray",color:"white",fontFamily:"helsinki",paddingBottom:"5px"}}),this.achievements=this.constructor.createElement("div",{id:"achievements-container",style:{display:"flex",flexDirection:"column",fontFamily:"riffic",gap:"0.4rem"}})],className:"simplemodal-container",style:{backgroundColor:"rgb(27 82 100)",backgroundImage:"linear-gradient(transparent, rgb(20, 63, 77))",borderRadius:"1rem",boxShadow:"0px 4px 8px 0px black",color:"white",display:"flex",flexDirection:"column",gap:"0.6rem",margin:"0 10px",padding:"1.5rem",width:"-webkit-fill-available"}}),this.refreshAchievements().then((e=>{this.countdown.innerText=[String(Math.floor(e.time_left/3600)).padStart(2,"0"),String(Math.floor(e.time_left%3600/60)).padStart(2,"0"),String(Math.floor(e.time_left%60)).padStart(2,"0")].join(":"),this.countdownTimer=setInterval((()=>{let e=this.countdown.innerText.split(":").map((e=>parseInt(e)));0===e[2]&&(0===e[1]&&(e[0]--,e[1]=59),e[1]--,e[2]=59),e[2]--,0===e.reduce(((e,t)=>e+t),0)&&clearInterval(this.countdownTimer),this.countdown.innerText=e.map((e=>String(e).padStart(2,"0"))).join(":")}),1e3),document.querySelector("#right_content").prepend(this.achievementsContainer)}))}initBestDate(){this.leaderboardEvent||this.initLeaderboardEvent(),Application.router.current_view.on("leaderboard.rendered",(()=>{Application.Helpers.AjaxHelper.get(location.pathname).done((({user_track_stats:{best_date:e}={}}={})=>{document.querySelectorAll(`.track-leaderboard-race-row[data-u_id="${Application.settings.user.u_id}"]`).forEach((t=>{t.setAttribute("title",e??"Failed to load")}))}))}))}async initDownloadGhosts(){this.leaderboardEvent||this.initLeaderboardEvent(),this.styleSheet.set(".track-page .track-leaderboard .track-leaderboard-action",{textAlign:"right"}),this.styleSheet.set(".track-page .track-leaderboard .track-leaderboard-action > :is(span.core_icons, div.moderator-remove-race)",{right:"6px"}),Application.router.current_view.on("leaderboard.rendered",(()=>{for(let e of document.querySelectorAll('.track-leaderboard-race-row[data-u_id="'+Application.settings.user.u_id+'"] > .track-leaderboard-action')){let t=document.createElement("span");t.style.setProperty("background-image","linear-gradient(hsl(200 81% 65% / 1), hsl(200 60% 40% / 1))"),t.style.setProperty("clip-path","polygon(30% 5%, 30% 45%, 10% 45%, 50% 95%, 90% 45%, 70% 45%, 70% 5%)"),t.classList.add("core_icons","core_icons-btn_add_race"),t.title="Download Race",t.addEventListener("click",(function(){Application.Helpers.AjaxHelper.get("/track_api/load_races",{t_id:GameSettings.track.id,u_ids:t.parentElement.parentElement.dataset.u_id}).done((function(e){e.result&&Object.assign(document.createElement("a"),{href:URL.createObjectURL(new Blob([JSON.stringify(e.data[0].race)],{type:"application/json"})),download:"frhd_ghost_"+GameSettings.track.id}).click()}))})),e.style.setProperty("width","20%"),e.prepend(t),e.textContent.length>0&&e.replaceChildren(...e.children)}}))}async initDownloadTracks(){let e=document.querySelector(".subscribe-to-author"),t=e.cloneNode(!0),s=t.querySelector("#subscribe_to_author_count");s&&s.remove();let i=t.querySelector("#subscribe_to_author");i.removeAttribute("id"),i.innerText="Download",i.addEventListener("click",(()=>{this.constructor.downloadTrack(GameSettings.track.id)})),e.after(t)}featuredGhosts=null;initFeaturedGhosts(){this.leaderboardEvent||this.initLeaderboardEvent(),Application.router.current_view.on("leaderboard.rendered",(async({track_leaderboard:e})=>{this.featuredGhosts||=await fetch("https://raw.githubusercontent.com/calculamatrise/frhd-featured-ghosts/master/data.json").then((e=>e.json()));const t=Object.fromEntries(Object.entries(lite.featuredGhosts).filter((e=>Object.keys(e[1]=Object.fromEntries(Object.entries(e[1]).filter((([e])=>parseInt(e.split("/t/")[1])==Application.router.current_view._get_track_id())))).length)));for(const e in t)for(const s in t[e]){let i=s.split("/r/")[1];for(const a of document.querySelectorAll('.track-page .track-leaderboard .track-leaderboard-race-row[data-d_name="'+i+'" i]')){let i=10;switch(t[e][s]){case"fast":i=180;break;case"vehicle":i=40;break;case"trick":i=120}let o=a.querySelector(".num");o.classList.add("core_icons","core_icons-icon_featured_badge"),o.classList.remove("num"),o.innerText=null,o.setAttribute("title","Featured"),a.style.setProperty("background-color",`hsl(${i}deg 60% 50% / 40%)`)}}}))}initFriendsLastPlayed(){Application.Helpers.AjaxHelper.get(location.pathname).done((({friends:e,is_profile_owner:t})=>{t||document.querySelectorAll(".friend-list-item-name").forEach((t=>{t.after(this.constructor.createElement("div",{className:"friend-list-item-date",innerText:"Last Played "+e.friends_data.find((({d_name:e})=>e==t.innerText)).activity_time_ago}))}))}))}initGhostPlayer(){this.replayGui||=this.constructor.createElement("div",{style:{display:"none",inset:0,pointerEvents:"none",position:"absolute"}}),this.replayGui.progress||=this.replayGui.appendChild(this.constructor.createElement("progress",{className:"ghost-player-progress",id:"replay-seeker",max:100,min:0,value:0,style:{border:"none",bottom:0,height:"4px",pointerEvents:"all",position:"absolute",transition:"height 100ms",width:"100%"},type:"range",onchange(e){GameManager.game.currentScene.state.playing=!1;let t=GameManager.game.currentScene.playerManager.getPlayerByIndex(GameManager.game.currentScene.camera.focusIndex);t.isGhost()&&t._replayIterator.next(this.value)},onpointerdown(e){this.setPointerCapture(e.pointerId),this.value=Math.round(e.offsetX/parseInt(getComputedStyle(this).getPropertyValue("width"))*this.max),this.dispatchEvent(new InputEvent("change")),this.wasPlaying=GameManager.game.currentScene.state.playing},onpointermove(e){!0&e.buttons&&(this.value=Math.round(e.offsetX/parseInt(getComputedStyle(this).getPropertyValue("width"))*this.max),this.dispatchEvent(new InputEvent("change")))},onpointerup(e){this.releasePointerCapture(e.pointerId),GameManager.game.currentScene.state.playing=this.wasPlaying}})),this.styleSheet.set(".ghost-player-progress::-webkit-progress-value",{backgroundColor:"hsl(195deg 57% 25%)"}).set(".ghost-player-progress:hover",{cursor:"pointer",filter:"brightness(1.25)",height:"6px !important"}),this.constructor.waitForElm("#game-container").then((e=>{e.appendChild(this.replayGui)}))}leaderboardEvent=null;initLeaderboardEvent(){const e=this.leaderboardEvent=Application.Views.TrackView.prototype._render_leaderboards;Application.Views.TrackView.prototype._render_leaderboards=function(t){e.apply(this,arguments),t.result&&(this.trigger("leaderboard.rendered",...arguments),Application.events.publish("leaderboard.rendered",...arguments))}}notificationEvent=null;initNotificationEvent(){const e=Object.getPrototypeOf(Application.Helpers.AjaxHelper),t=this.notificationEvent=e._check_event_notification;e._check_event_notification=function(e){t.apply(this,arguments),e.result&&Application.events.publish("notification.received",...arguments)},Object.setPrototypeOf(Application.Helpers.AjaxHelper,e)}initRequestTrackData(){let e=document.querySelector("#delete-all-personal-data").parentElement.appendChild(document.createElement("button"));e.classList.add("blue-button","settings-header","new-button"),e.style.setProperty("float","right"),e.style.setProperty("font-size","13px"),e.style.setProperty("height","auto"),e.style.setProperty("line-height","23px"),e.style.setProperty("margin-top","6px"),e.style.setProperty("margin-right","14px"),e.style.setProperty("padding","0 1rem"),e.innerText="Request All Data",e.addEventListener("click",(()=>{this.constructor.downloadAllTracks()}))}refreshAchievements(){return fetch("/achievements?ajax").then((e=>e.json())).then((async e=>{let t=await Promise.all(e.achievements.filter((e=>!e.complete)).sort(((e,t)=>t.tot_num-e.tot_num)).slice(0,3).map(this.constructor.createProgressElement.bind(this.constructor)));return this.achievements.replaceChildren(...t),e}))}static createAccountContainer({login:e,password:t}){let s=this.createElement("div",{children:[this.createElement("button",{className:"new-button button-type-1",innerText:e,style:{width:"-webkit-fill-available"},onclick(){document.querySelector("#simplemodal-overlay")?.remove(),document.querySelector("#signup_login_container")?.remove(),Application.Helpers.AjaxHelper.post("/auth/standard_login",{login:e,password:t}).done((function(e){e.result&&Application.events.publish("auth.login",e.data.user,e.data.user_stats)}))}}),this.createElement("button",{className:"btn new-button button-type-1",innerText:"X",style:{aspectRatio:1,backgroundImage:"linear-gradient(#ee5f5b,#c43c35)",marginRight:0},onclick(){let t=JSON.parse(localStorage.getItem("switcher-accounts"))??[];t.splice(t.indexOf(t.find((t=>t.login===e))),1),localStorage.setItem("switcher-accounts",JSON.stringify(t)),s.remove()}})],style:{display:"flex",gap:"0.25rem"}});return s}static async createProgressElement(e){let t=this.createElement("div",{children:[this.createElement("div",{children:[this.createElement("span",{className:"achievements-coin store_icons store_icons-coin_icon_lg achievement-coin-value",innerText:e.coins,style:{lineHeight:"45px",textAlign:"center",textShadow:"0 -1px 1px #9E8500"}}),this.createElement("div",{children:[this.createElement("a",{className:"title",children:[this.createElement("b",{innerText:e.title})],href:await(e=>{switch(e){case"Buy 1 item from the shop":return"store/gear";case"Complete 1 friend race":case"Win 5 friend(s) race":return Application.Helpers.AjaxHelper.get("u/"+Application.settings.user.u_name).then((async({friends:e})=>{if(e.friend_cnt>0){let t;for(let s of e.friends_data)if(t=await Application.Helpers.AjaxHelper.get("u/"+s.u_name).then((({recently_ghosted_tracks:{tracks:e}})=>e[Math.floor(Math.random()*e.length)])))return t}return"random/track"}));case"Improve 5 best times":case"Send 5 friend race challenges":return Application.Helpers.AjaxHelper.get("u/"+Application.settings.user.u_name).then((({recently_ghosted_tracks:{tracks:e}})=>{let t=e[Math.floor(Math.random()*e.length)];return t?t.slug:"random/track"}));default:return"random/track"}})(e.desc),style:{width:"-webkit-fill-available"}}),this.createElement("h6",{className:"achievement-info-desc condensed",innerText:e.desc,style:{color:"darkgray",fontFamily:"roboto_bold",margin:0}})],className:"achievement-info"})],style:{alignItems:"center",display:"flex",gap:"0.5rem"}}),this.createElement("span",{innerText:e.progress,style:{fontSize:"1.25rem"}})],className:"achievement-info",style:{alignItems:"center",display:"flex",justifyContent:"space-between"}});return t}static createElement(e,t={}){const s=arguments[arguments.length-1],i=document.createElement(e);"innerText"in t&&(i.innerText=t.innerText,delete t.innerText);for(const e in t)if("object"==typeof t[e]){if(t[e]instanceof Array){if(/^children$/i.test(e))i.append(...t[e]);else if(/^on/i.test(e))for(const s of t[e])i.addEventListener(e.slice(2),s)}else/^style$/i.test(e)&&Object.assign(i[e.toLowerCase()],t[e]);delete t[e]}return Object.assign(i,t),"function"==typeof s&&s(i),i}static downloadTrack(e){fetch("/track_api/load_track?id="+e+"&fields[]=code&fields[]=id&fields[]=title").then((e=>e.json())).then((({data:e,result:t})=>{if(!t)return;let{track:s}=e,i=new Blob([s.code],{type:"text/plain"}),a=document.createElement("a");a.href=URL.createObjectURL(i),a.download=s.title+"-"+s.id,a.click(),URL.revokeObjectURL(a.href)}))}static zipHelperScript=null;static downloadAllTracks(){fetch("/u/"+Application.settings.user.u_name+"/created?ajax").then((e=>e.json())).then((async({created_tracks:e})=>{this.zipHelperScript||(this.zipHelperScript=document.body.appendChild(document.createElement("script")),this.zipHelperScript.textContent=await fetch("https://raw.githubusercontent.com/Stuk/jszip/main/dist/jszip.min.js").then((e=>e.text())));let t=new JSZip,s=await Promise.all(e.tracks.map((e=>fetch("/track_api/load_track?id="+e.id+"&fields[]=code&fields[]=id&fields[]=title").then((e=>e.json()))))).then((e=>e.filter((({result:e})=>e)).map((({data:e})=>e.track))));for(let e of s)t.file(e.title+"-"+e.id+".txt",e.code);t.generateAsync({type:"uint8array"}).then((e=>{let t=new Blob([e],{type:"application/zip"}),s=document.createElement("a");s.href=URL.createObjectURL(t),s.download="created-tracks",s.click(),URL.revokeObjectURL(s.href)}))}))}static waitForElm(e){return new Promise((t=>{if(document.querySelector(e))return t(document.querySelector(e));const s=new MutationObserver((i=>{document.querySelector(e)&&(t(document.querySelector(e)),s.disconnect())}));s.observe(document.body,{childList:!0,subtree:!0})}))}};const s=class{x=0;y=0;constructor(e,t){this.x=e,this.y=t}toReal(e){var t=e.camera,s=e.screen,i=(this.x-s.center.x)/t.zoom+t.position.x,a=(this.y-s.center.y)/t.zoom+t.position.y;return new this.constructor(i,a)}toScreen(e){var t=e.camera,s=e.screen,i=(this.x-t.position.x)*t.zoom+s.center.x,a=(this.y-t.position.y)*t.zoom+s.center.y;return new this.constructor(i,a)}lenSqr(){return Math.pow(this.x,2)+Math.pow(this.y,2)}len(){return Math.sqrt(Math.pow(this.x,2)+Math.pow(this.y,2))}dot(e){return this.x*e.x+this.y*e.y}factor(e){return new this.constructor(this.x*e,this.y*e)}factorSelf(e){this.x=this.x*e,this.y=this.y*e}factorOut(e,t){t.x=this.x*e,t.y=this.y*e}add(e){return new this.constructor(this.x+e.x,this.y+e.y)}inc(e){this.x+=e.x,this.y+=e.y}addOut(e,t){t.x=this.x+e.x,t.y=this.y+e.y}sub(e){return new this.constructor(this.x-e.x,this.y-e.y)}subOut(e,t){t.x=this.x-e.x,t.y=this.y-e.y}subSelf(e){this.x=this.x-e.x,this.y=this.y-e.y}equ(e){this.x=e.x,this.y=e.y}normalize(){let e=Math.sqrt(Math.pow(this.x,2)+Math.pow(this.y,2));return new this.constructor(this.x/e,this.y/e)}getAngleInDegrees(e){var t=e.sub(this),s=Math.atan2(t.x,-t.y)*(180/Math.PI);return 0>s&&(s+=360),s}getAngleInRadians(e){var t=e.sub(this);return Math.atan2(t.x,-t.y)}},a=class{sectors=null;p1=null;p2=null;pp=null;len=0;collided=!1;remove=!1;highlight=!1;recorded=!1;type="physics";constructor(e,t,i,a){this.p1=new s(e,t),this.p2=new s(i,a),this.pp=this.p2.sub(this.p1),this.len=this.pp.len(),this.sectors=[],this.collided=!1,this.remove=!1,this.highlight=!1,this.recorded=!1}move(e,t){return this.p1.x+=0|parseInt(e),this.p1.y+=0|parseInt(t),this.p2.x+=0|parseInt(e),this.p2.y+=0|parseInt(t),this}getCode(e){this.recorded=!0;let t=" "+this.p2.x.toString(32)+" "+this.p2.y.toString(32),s=this.checkForConnectedLine(e,this.p2);return s&&(t+=s.getCode(e)),t}checkForConnectedLine(e,t){var s=e.settings.physicsSectorSize,i=e.sectors.physicsSectors,a=Math.floor(t.x/s),o=Math.floor(t.y/s);return i[a][o].searchForLine("physicsLines",t)}addSectorReference(e){this.sectors.push(e)}removeAllReferences(){this.remove=!0;for(var e=this.sectors,t=e.length,s=0;t>s;s++)e[s].drawn=!1,e[s].dirty=!0;this.sectors=[]}erase(e,t){var s=!1;if(!this.remove){var i=this.p1,a=e,o=t,r=this.p2.sub(i),n=i.sub(a),h=r.dot(r),l=2*n.dot(r),c=l*l-4*h*(n.dot(n)-o*o);if(c>0){var d=(-l-(c=Math.sqrt(c)))/(2*h),p=(-l+c)/(2*h);d>=0&&1>=d&&(s=!0,this.removeAllReferences()),p>=0&&1>=p&&(s=!0,this.removeAllReferences())}(this.intersects(this.p1.x,this.p1.y,e.x,e.y,t)||this.intersects(this.p2.x,this.p2.y,e.x,e.y,t))&&(s=!0,this.removeAllReferences())}return s}intersects(e,t,s,i,a){var o=e-s,r=t-i;return a*a>=o*o+r*r}collide(e){if(!this.collided){this.collided=!0;var t=e.pos,s=e.vel,i=e.radius,a=0,o=0,r=0,n=this.p1,h=this.p2,l=t.x-n.x,c=t.y-n.y,d=this.pp,p=this.len,u=(l*d.x+c*d.y)/p/p;if(u>=0&&1>=u){var g=(l*d.y-c*d.x)*((l-s.x)*d.y-(c-s.y)*d.x)<0?-1:1;if(a=l-d.x*u,o=c-d.y*u,0===(r=Math.sqrt(Math.pow(a,2)+Math.pow(o,2)))&&(r=1),i>r||0>g){var m=(i*g-r)/r;return t.x+=a*m,t.y+=o*m,void e.drive(-o/r,a/r)}}if(!(-i>u*p||u*p>p+i)){var y=u>0?h:n;if(a=t.x-y.x,o=t.y-y.y,0===(r=Math.sqrt(Math.pow(a,2)+Math.pow(o,2)))&&(r=1),i>r)return m=(i-r)/r,t.x+=a*m,t.y+=o*m,void e.drive(-o/r,a/r)}}}},o=class{scene=null;angle=0;x=0;y=0;name=null;sector=null;settings=null;outline="#000";remove=!1;constructor(e){this.game=e.scene.game,this.scene=e.scene,this.settings=this.game.settings,this.remove=!1}getCode(){}draw(e,t,s,i){if(!this.hit){this.constructor.cache.dirty&&this.recache(s);let a=this.constructor.cache.width*s,o=this.constructor.cache.height*s,r=a/2,n=o/2;i.drawImage(this.constructor.cache.canvas,e-r,t-n,a,o)}}erase(e,t){var s=!1;return this.remove||t>=Math.sqrt(Math.pow(e.x-this.x,2)+Math.pow(e.y-this.y,2))&&(s=[this],this.removeAllReferences()),s}removeAllReferences(){this.remove=!0,this.sector&&(this.sector.powerupCanvasDrawn=!1,this.sector.dirty=!0,this.sector=null),this.scene.track.cleanPowerups()}collide(e){var t=e.pos.x-this.x,s=e.pos.y-this.y,i=Math.sqrt(Math.pow(t,2)+Math.pow(s,2));!this.hit&&26>i&&(this.hit=!0,this.sector.powerupCanvasDrawn=!1)}addSectorReference(e){this.sector=e}move(e,t){return this.x+=0|parseInt(e),this.y+=0|parseInt(t),this}setDirty(e){this.constructor.cache.dirty=e}static cache={canvas:document.createElement("canvas"),dirty:!0,width:25,height:25}},r=class extends o{name="antigravity";constructor(e,t,s){super(s),this.x=e,this.y=t}getCode(){return"A "+this.x.toString(32)+" "+this.y.toString(32)}recache(e){this.constructor.cache.dirty=!1;var t=this.constructor.cache.canvas;t.width=this.constructor.cache.width*e,t.height=this.constructor.cache.height*e;var s=t.getContext("2d"),i=t.width/2,a=t.height/2;this.drawPowerup(i,a,e,s),this.settings.developerMode&&(s.beginPath(),s.rect(0,0,t.width,t.height),s.strokeStyle="red",s.strokeWidth=1*e,s.stroke())}draw(e,t,s,i){this.constructor.cache.dirty&&this.recache(s);var a=this.constructor.cache.width*s,o=this.constructor.cache.height*s,r=a/2,n=o/2,h=e,l=t;i.translate(h,l),i.drawImage(this.constructor.cache.canvas,-r,-n,a,o),i.translate(-h,-l)}drawPowerup(e,t,s,i){s*=.5,i.save(),i.beginPath(),i.scale(s,s),i.moveTo(0,0),i.lineTo(50,0),i.lineTo(50,50),i.lineTo(0,50),i.closePath(),i.clip(),i.translate(0,0),i.translate(0,0),i.scale(1,1),i.translate(0,0),i.strokeStyle="rgba(0, 0, 0, 0)",i.lineCap="butt",i.lineJoin="miter",i.miterLimit=4,i.save(),i.restore(),i.save(),i.restore(),i.save(),i.fillStyle="rgba(0, 0, 0, 0)",i.strokeStyle="rgba(0, 0, 0, 0)",i.lineWidth=1,i.translate(-726,-131),i.save(),i.translate(726,131),i.save(),i.fillStyle="#08faf3",i.strokeStyle=/^(dark|midnight)$/i.test(lite.storage.get("theme"))?"#FBFBFB":this.outline,i.lineWidth=2,i.beginPath(),i.moveTo(25,36),i.bezierCurveTo(18.9251591,36,14,31.0751824,14,25),i.bezierCurveTo(14,18.9248176,18.9251591,14,25,14),i.bezierCurveTo(31.0751824,14,36,18.9248176,36,25),i.bezierCurveTo(36,31.0751824,31.0751824,36,25,36),i.closePath(),i.fill(),i.stroke(),i.restore(),i.save(),i.fillStyle=/^(dark|midnight)$/i.test(lite.storage.get("theme"))?"#FBFBFB":this.outline,i.beginPath(),i.moveTo(25,35),i.bezierCurveTo(30.5228976,35,35,30.5228976,35,25),i.bezierCurveTo(35,19.4771024,30.5228976,15,25,15),i.bezierCurveTo(19.4773211,15,15,19.4772251,15,25),i.bezierCurveTo(15,30.5227749,19.4773211,35,25,35),i.closePath(),i.moveTo(25,37),i.bezierCurveTo(18.3727612,37,13,31.627354,13,25),i.bezierCurveTo(13,18.372646,18.3727612,13,25,13),i.bezierCurveTo(31.6274671,13,37,18.3725329,37,25),i.bezierCurveTo(37,31.6274671,31.6274671,37,25,37),i.closePath(),i.fill(),i.stroke(),i.restore(),i.save(),i.fillStyle=/^(dark|midnight)$/i.test(lite.storage.get("theme"))?"#FBFBFB":this.outline,i.beginPath(),i.moveTo(1.0370609,29.702878),i.lineTo(.571767448,27.3196417),i.lineTo(10.8190136,27.3196417),i.lineTo(11.2235626,28.7886215),i.bezierCurveTo(12.5553335,33.6244869,16.3752072,37.4442862,21.2110994,38.7761385),i.lineTo(22.6800518,39.1807024),i.lineTo(22.6800518,49.4279421),i.lineTo(20.2968028,48.9626301),i.bezierCurveTo(10.5816525,47.0658182,2.93381735,39.4180779,1.0370609,29.702878),i.closePath(),i.moveTo(48.9629391,20.297122),i.lineTo(49.4282326,22.6803583),i.lineTo(39.1809639,22.6803583),i.lineTo(38.7764299,21.2113511),i.bezierCurveTo(37.4446547,16.3752014,33.624798,12.5554192,28.7886215,11.2235626),i.lineTo(27.3196417,10.8190136),i.lineTo(27.3196417,.571783441),i.lineTo(29.7028653,1.03705842),i.bezierCurveTo(39.418382,2.93381152,47.0661305,10.5816549,48.9629391,20.297122),i.closePath(),i.moveTo(11.2235701,21.2113511),i.lineTo(10.8190361,22.6803583),i.lineTo(.571767448,22.6803583),i.lineTo(1.0370609,20.297122),i.bezierCurveTo(2.93380373,10.5819918,10.5815702,2.93422536,20.2967378,1.03707606),i.lineTo(22.6800518,.571669532),i.lineTo(22.6800518,10.8189911),i.lineTo(21.2110994,11.223555),i.bezierCurveTo(16.3751604,12.5554202,12.5553324,16.3752482,11.2235701,21.2113511),i.closePath(),i.moveTo(29.7028653,48.9626351),i.lineTo(27.3196417,49.4279101),i.lineTo(27.3196417,39.1806799),i.lineTo(28.7886215,38.7761309),i.bezierCurveTo(33.6247513,37.4442873,37.4446537,33.6245336,38.7764374,28.7886215),i.lineTo(39.1809864,27.3196417),i.lineTo(49.4282326,27.3196417),i.lineTo(48.9629391,29.702878),i.bezierCurveTo(47.0661446,39.4182726,39.4184545,47.0658678,29.7028653,48.9626351),i.closePath(),i.fill(),i.stroke(),i.restore(),i.save(),i.fillStyle="#08faf3",i.beginPath(),i.moveTo(3,29.3196417),i.bezierCurveTo(4.74079001,38.2359804,11.7640196,45.2589035,20.6800518,46.9996935),i.lineTo(20.6800518,40.7043471),i.bezierCurveTo(15.1649961,39.1854465,10.814247,34.8350039,9.29534642,29.3196417),i.lineTo(3,29.3196417),i.closePath(),i.moveTo(47,20.6803583),i.bezierCurveTo(45.25921,11.7640196,38.2362869,4.74079001,29.3196417,3),i.lineTo(29.3196417,9.29534642),i.bezierCurveTo(34.8350039,10.814247,39.185753,15.1646897,40.7046536,20.6803583),i.lineTo(47,20.6803583),i.closePath(),i.moveTo(9.29534642,20.6803583),i.bezierCurveTo(10.814247,15.1646897,15.1649961,10.814247,20.6800518,9.29534642),i.lineTo(20.6800518,3),i.bezierCurveTo(11.7640196,4.74109649,4.74079001,11.7640196,3,20.6803583),i.lineTo(9.29534642,20.6803583),i.closePath(),i.moveTo(29.3196417,46.9996935),i.bezierCurveTo(38.2362869,45.2589035,45.25921,38.2359804,47,29.3196417),i.lineTo(40.7046536,29.3196417),i.bezierCurveTo(39.185753,34.8350039,34.8350039,39.1854465,29.3196417,40.7043471),i.lineTo(29.3196417,46.9996935),i.closePath(),i.fill(),i.stroke(),i.restore(),i.restore(),i.restore(),i.restore()}collide(e){var t=e.parent,s=t.player,i=e.pos.x-this.x,a=e.pos.y-this.y;1e3>Math.pow(i,2)+Math.pow(a,2)&&s.isAlive()&&(!1===s.isGhost()&&((0!=t.gravity.x||0!=t.gravity.y)&&this.scene.sound.play("antigravity_sound",.3),this.scene.message.show("Antigravity Engaged",50,"#08faf3")),t.gravity.x=0,t.gravity.y=0)}static cache=Object.assign({},this.cache,{canvas:document.createElement("canvas")})},n=class extends o{name="bomb";constructor(e,t,s){super(s),this.x=e,this.y=t}getCode(){return"O "+this.x.toString(32)+" "+this.y.toString(32)}recache(e){this.constructor.cache.dirty=!1;var t=this.constructor.cache.canvas;t.width=this.constructor.cache.width*e,t.height=this.constructor.cache.height*e;var s=t.getContext("2d"),i=t.width/2,a=t.height/2;this.drawCircle(i,a,e,s),this.settings.developerMode&&(s.beginPath(),s.rect(0,0,t.width,t.height),s.strokeStyle="red",s.strokeWidth=1*e,s.stroke())}drawCircle(e,t,s,i){s*=.2,i.fillStyle=/^(dark|midnight)$/i.test(lite.storage.get("theme"))?"#FBFBFB":this.outline,i.strokeStyle=/^(dark|midnight)$/i.test(lite.storage.get("theme"))?"#FBFBFB":this.outline,i.lineWidth=8*s,i.beginPath(),i.moveTo(53*s,105*s),i.lineTo(41.5*s,115*s),i.lineTo(43*s,100*s),i.bezierCurveTo(35.5*s,95*s,30*s,88.5*s,26.5*s,80*s),i.lineTo(11*s,78*s),i.lineTo(24*s,69.5*s),i.bezierCurveTo(24*s,68*s,24*s,67*s,24*s,66*s),i.bezierCurveTo(24*s,58.5*s,26*s,51*s,30*s,45*s),i.lineTo(22*s,31.5*s),i.lineTo(37.5*s,36*s),i.bezierCurveTo(43.5*s,31*s,51*s,27.5*s,60*s,26*s),i.lineTo(66*s,11*s),i.lineTo(72*s,26.5*s),i.bezierCurveTo(80.5*s,27.5*s,88*s,31*s,93.5*s,36.5*s),i.lineTo(110*s,31.5*s),i.lineTo(101.5*s,46*s),i.bezierCurveTo(105*s,52*s,107*s,59*s,107*s,66*s),i.bezierCurveTo(107*s,67*s,107*s,68*s,107*s,69*s),i.lineTo(121*s,78*s),i.lineTo(104.5*s,80.5*s),i.bezierCurveTo(101.5*s,88*s,96*s,95*s,89*s,99.5*s),i.lineTo(90.5*s,115*s),i.lineTo(78.5*s,104.5*s),i.bezierCurveTo(74.5*s,106*s,70*s,107*s,65.5*s,107*s),i.bezierCurveTo(61*s,107*s,57*s,106*s,53*s,105*s),i.lineTo(53*s,105*s),i.closePath(),i.fill(),i.stroke(),i.beginPath(),i.arc(66*s,66*s,40*s,0*s,2*Math.PI,!0),i.lineWidth=2*s,i.fillStyle="#d12929",i.fill(),i.stroke(),i.beginPath(),i.arc(66*s,66*s,8*s,0*s,2*Math.PI,!0),i.lineWidth=2*s,i.fillStyle=/^(dark|midnight)$/i.test(lite.storage.get("theme"))?"#FBFBFB":this.outline,i.fill(),i.stroke()}collide(e){var t=e.parent,s=t.player,i=e.pos.x-this.x,a=e.pos.y-this.y;20>Math.sqrt(Math.pow(i,2)+Math.pow(a,2))&&s.isAlive()&&(t.explode(),!1===s.isGhost()&&(this.hit=!0,this.sector.powerupCanvasDrawn=!1))}static cache=Object.assign({},this.cache,{canvas:document.createElement("canvas"),width:26,height:26})},h=class extends o{name="boost";realAngle=0;directionX=0;directionY=0;constructor(e,t,s,i){super(i),this.x=e,this.y=t,this.angle=s,this.realAngle=s;let a=(s-180)/360*2*Math.PI;this.directionX=(-Math.sin(a)).toFixed(15)/1,this.directionY=Math.cos(a).toFixed(15)/1}getCode(){return"B "+this.x.toString(32)+" "+this.y.toString(32)+" "+this.realAngle.toString(32)}recache(e){this.constructor.cache.dirty=!1;var t=this.constructor.cache.canvas;t.width=this.constructor.cache.width*e,t.height=this.constructor.cache.height*e;var s=t.getContext("2d"),i=t.width/2,a=t.height/2;this.drawCircle(i,a,e,s),this.settings.developerMode&&(s.beginPath(),s.rect(0,0,t.width,t.height),s.strokeStyle="red",s.strokeWidth=1*e,s.stroke())}draw(e,t,s,i){this.constructor.cache.dirty&&this.recache(s);var a=this.constructor.cache.width*s,o=this.constructor.cache.height*s,r=a/2,n=o/2,h=e,l=t,c=(this.angle-90)*(Math.PI/180);i.translate(h,l),i.rotate(c),i.drawImage(this.constructor.cache.canvas,-r,-n,a,o),i.rotate(-c),i.translate(-h,-l)}drawCircle(e,t,s,i){i.save(),i.strokeStyle="rgba(0,0,0,0)",i.lineCap="round",i.fillStyle="#8ac832",i.strokeStyle=/^(dark|midnight)$/i.test(lite.storage.get("theme"))?"#FBFBFB":this.outline,s*=.2,i.lineWidth=Math.max(8*s,1),i.beginPath(),i.moveTo(0*s,0*s),i.lineTo(118*s,0*s),i.lineTo(118*s,81*s),i.lineTo(0*s,81*s),i.closePath(),i.beginPath(),i.moveTo(3*s,1.5*s),i.lineTo(35*s,1.7*s),i.lineTo(66*s,40*s),i.lineTo(34*s,78*s),i.lineTo(4*s,78*s),i.lineTo(36*s,39*s),i.lineTo(3*s,1.5*s),i.closePath(),i.moveTo(53*s,1.5*s),i.lineTo(85*s,1.7*s),i.lineTo(116*s,40*s),i.lineTo(84*s,78*s),i.lineTo(54*s,78*s),i.lineTo(85*s,39*s),i.lineTo(53*s,1.5*s),i.closePath(),i.fill(),i.stroke()}collide(e){var t=e.parent,s=t.player,i=e.pos.x-this.x,a=e.pos.y-this.y,o=Math.pow(i,2)+Math.pow(a,2),r=t.masses,n=r.length,h=this.directionX,l=this.directionY;if(1e3>o&&s.isAlive()){for(var c=n-1;c>=0;c--){var d=r[c].pos;d.x+=h,d.y+=l}!1===s.isGhost()&&(this.scene.sound.play("boost_sound"),this.scene.message.show("Boost Engaged",50,"#8ac832"))}}static cache=Object.assign({},this.cache,{canvas:document.createElement("canvas"),width:24,height:16})},l=class extends o{name="checkpoint";constructor(e,t,s){super(s),this.x=e,this.y=t,this.id=Math.random().toString(36).slice(2)}getCode(){return"C "+this.x.toString(32)+" "+this.y.toString(32)}recache(e){this.constructor.cache.dirty=!1;var t=this.constructor.cache.canvas;t.width=this.constructor.cache.width*e,t.height=this.constructor.cache.height*e;var s=t.getContext("2d"),i=t.width/2,a=t.height/2;this.drawCircle(i,a,e,s),this.settings.developerMode&&(s.beginPath(),s.rect(0,0,t.width,t.height),s.strokeStyle="red",s.strokeWidth=1*e,s.stroke())}draw(e,t,s,i){this.constructor.cache.dirty&&this.recache(s);var a=this.constructor.cache.width*s,o=this.constructor.cache.height*s,r=a/2,n=o/2;i.save(),this.hit&&(i.globalAlpha=.3),i.drawImage(this.constructor.cache.canvas,e-r,t-n,a,o),i.restore()}drawCircle(e,t,s,i){s*=.15,i.save(),i.translate(1,1),i.beginPath(),i.moveTo(0*s,0*s),i.lineTo(112*s,0*s),i.lineTo(112*s,95*s),i.lineTo(0*s,95*s),i.closePath(),i.fillStyle="#826cdc",i.strokeStyle=/^(dark|midnight)$/i.test(lite.storage.get("theme"))?"#FBFBFB":this.outline,i.lineWidth=8*s,i.beginPath(),i.moveTo(3*s,10*s),i.bezierCurveTo(3*s,10*s,33.5*s,27*s,55*s,10*s),i.bezierCurveTo(76*s,-6*s,108*s,10*s,108*s,10*s),i.lineTo(109*s,86*s),i.bezierCurveTo(109*s,86*s,74*s,73.5*s,56.5*s,86*s),i.bezierCurveTo(40*s,98*s,3*s,88.5*s,3*s,88.5*s),i.lineTo(3*s,10*s),i.closePath(),i.fill(),i.stroke(),i.beginPath(),i.lineWidth=15*s,i.moveTo(3*s,10*s),i.lineTo(3*s,180*s),i.stroke(),i.restore()}collide(e){var t=e.parent.player,s=e.pos.x-this.x,i=e.pos.y-this.y,a=Math.sqrt(Math.pow(s,2)+Math.pow(i,2)),o=t._powerupsConsumed.checkpoints;26>a&&t.isAlive()&&-1===o.indexOf(this.id)&&(o.push(this.id),t.setCheckpointOnUpdate(),!1===t.isGhost()&&(this.hit=!0,this.sector.powerupCanvasDrawn=!1,this.scene.message.show("Checkpoint Saved",50,"#826cdc","#FFFFFF"),this.scene.sound.play("checkpoint_sound")))}static cache=Object.assign({},this.cache,{canvas:document.createElement("canvas"),width:20,height:32})},c=class extends o{realAngle=0;name="gravity";constructor(e,t,s,i){super(i),this.x=e,this.y=t,this.angle=s-180,this.realAngle=s;let a=this.angle/360*2*Math.PI;this.directionX=(-.3*Math.sin(a)).toFixed(15)/1,this.directionY=(.3*Math.cos(a)).toFixed(15)/1}recache(e){this.constructor.cache.dirty=!1;var t=this.constructor.cache.canvas;t.width=this.constructor.cache.width*e,t.height=this.constructor.cache.height*e;var s=t.getContext("2d"),i=t.width/2,a=t.height/2;this.drawArrow(i,a,e,s),this.settings.developerMode&&(s.beginPath(),s.rect(0,0,t.width,t.height),s.strokeStyle="red",s.strokeWidth=3*e,s.stroke())}getCode(){return"G "+this.x.toString(32)+" "+this.y.toString(32)+" "+this.realAngle.toString(32)}draw(e,t,s,i){this.constructor.cache.dirty&&this.recache(s);var a=this.constructor.cache.width*s,o=this.constructor.cache.height*s,r=a/2,n=o/2,h=e,l=t,c=(this.angle+90)*(Math.PI/180);i.translate(h,l),i.rotate(c),i.drawImage(this.constructor.cache.canvas,-r,-n,a,o),i.rotate(-c),i.translate(-h,-l)}drawArrow(e,t,s,i){s*=.2,i.beginPath(),i.moveTo(0*s,0*s),i.lineTo(97*s,0*s),i.lineTo(97*s,96*s),i.lineTo(0*s,96*s),i.closePath(),i.clip(),i.fillStyle="rgba(0, 0, 0, 0)",i.strokeStyle="rgba(0, 0, 0, 0)",i.lineWidth=Math.max(6*s,1),i.save(),i.fillStyle="#376eb7",i.strokeStyle=/^(dark|midnight)$/i.test(lite.storage.get("theme"))?"#FBFBFB":this.outline,i.beginPath(),i.moveTo(41*s,70*s),i.lineTo(41*s,95*s),i.lineTo(97*s,48*s),i.lineTo(41*s,1*s),i.lineTo(41*s,25*s),i.lineTo(1*s,25*s),i.lineTo(1*s,70*s),i.lineTo(41*s,70*s),i.closePath(),i.closePath(),i.fill(),i.stroke()}collide(e){var t=e.parent,s=t.player,i=e.pos.x-this.x,a=e.pos.y-this.y,o=Math.pow(i,2)+Math.pow(a,2),r=(t.masses.length,this.directionX),n=this.directionY;1e3>o&&s.isAlive()&&(t.gravity.x=r,t.gravity.y=n,!1===s.isGhost()&&(this.scene.message.show("Gravity Changed",50,"#1F80C3","#FFFFFF"),this.scene.sound.play("gravity_down_sound")))}static cache=Object.assign({},this.cache,{canvas:document.createElement("canvas"),width:20,height:20})},d=class extends o{name="slowmo";constructor(e,t,s){super(s),this.x=e,this.y=t}recache(e){this.constructor.cache.dirty=!1;var t=this.constructor.cache.canvas;t.width=this.constructor.cache.width*e,t.height=this.constructor.cache.height*e;var s=t.getContext("2d"),i=t.width/2,a=t.height/2;this.drawCircle(i,a,e,s),this.settings.developerMode&&(s.beginPath(),s.rect(0,0,t.width,t.height),s.strokeStyle="red",s.strokeWidth=1*e,s.stroke())}getCode(){return"S "+this.x.toString(32)+" "+this.y.toString(32)}draw(e,t,s,i){this.constructor.cache.dirty&&this.recache(s);var a=this.constructor.cache.width*s,o=this.constructor.cache.height*s,r=a/2,n=o/2;i.drawImage(this.constructor.cache.canvas,e-r,t-n,a,o)}collide(e){var t=e.parent,s=t.player,i=e.pos.x-this.x,a=e.pos.y-this.y,o=Math.sqrt(Math.pow(i,2)+Math.pow(a,2));!this.hit&&26>o&&s.isAlive()&&(t.slow=!0,!1===s.isGhost()&&(this.scene.sound.play("slowmo_sound"),this.scene.message.show("Slow Motion",50,"#FFFFFF","#000000")))}drawCircle(e,t,s,i){i.save(),i.beginPath(),s*=.2,i.moveTo(0*s,0*s),i.lineTo(116*s,0*s),i.lineTo(116*s,114*s),i.lineTo(0*s,114*s),i.closePath(),i.fillStyle="#ffffff00",i.strokeStyle=/^(dark|midnight)$/i.test(lite.storage.get("theme"))?"#FBFBFB":this.outline,i.lineWidth=Math.max(3*s,.5),i.beginPath(),i.moveTo(58*s,111*s),i.bezierCurveTo(89*s,111*s,114*s,87*s,114*s,56*s),i.bezierCurveTo(114*s,26*s,89*s,2*s,58*s,2*s),i.bezierCurveTo(27.1748289*s,2*s,2*s,26*s,2*s,56*s),i.bezierCurveTo(2*s,87*s,27.1748289*s,111*s,58*s,111*s),i.closePath(),i.moveTo(58*s,103*s),i.bezierCurveTo(84*s,103*s,106*s,82*s,106*s,56*s),i.bezierCurveTo(106*s,30*s,84*s,9*s,58*s,9*s),i.bezierCurveTo(31*s,9*s,10*s,30*s,10*s,56*s),i.bezierCurveTo(10*s,82*s,31*s,103*s,58*s,103*s),i.closePath(),i.moveTo(58*s,55*s),i.lineTo(37*s,23*s),i.lineTo(35*s,25*s),i.lineTo(56*s,57*s),i.lineTo(58*s,55*s),i.closePath(),i.moveTo(58.5*s,59*s),i.lineTo(81.5*s,59*s),i.lineTo(81.5*s,56*s),i.lineTo(58.5*s,56*s),i.lineTo(58.5*s,59*s),i.closePath(),i.moveTo(98.5*s,59*s),i.lineTo(105.5*s,59*s),i.lineTo(105.5*s,56*s),i.lineTo(98.5*s,56*s),i.lineTo(98.5*s,59*s),i.closePath(),i.moveTo(11.5*s,59*s),i.lineTo(18.5*s,59*s),i.lineTo(18.5*s,56*s),i.lineTo(11.5*s,56*s),i.lineTo(11.5*s,59*s),i.closePath(),i.moveTo(57*s,96*s),i.lineTo(57*s,101.5*s),i.lineTo(60*s,101.5*s),i.lineTo(60*s,96*s),i.lineTo(57*s,96*s),i.closePath(),i.moveTo(57*s,12*s),i.lineTo(57*s,17.5*s),i.lineTo(60*s,17.5*s),i.lineTo(60*s,12*s),i.lineTo(57*s,12*s),i.closePath(),i.fill(),i.stroke()}static cache=Object.assign({},this.cache,{canvas:document.createElement("canvas"),width:24,height:24})},p=class extends o{dirty=!0;name="goal";hit=!1;constructor(e,t,s){super(s),this.x=e,this.y=t,this.id=Math.random().toString(36).slice(2)}getCode(){return"T "+this.x.toString(32)+" "+this.y.toString(32)}recache(e){this.dirty=!1,this.cacheStar(e),this.cacheEmptyStar(e)}cacheStar(e){var t=this.constructor.cache.canvas;t.width=this.constructor.cache.width*e,t.height=this.constructor.cache.height*e;var s=t.getContext("2d"),i=t.width/2,a=t.height/2;this.drawStar(i,a,5,10,5,!0,e,s),this.settings.developerMode&&(s.beginPath(),s.rect(0,0,t.width,t.height),s.strokeStyle="red",s.strokeWidth=1*e,s.stroke())}cacheEmptyStar(e){var t=this.constructor.hitCache.canvas;t.width=this.constructor.hitCache.width*e,t.height=this.constructor.hitCache.height*e;var s=t.getContext("2d"),i=t.width/2,a=t.height/2;this.drawStar(i,a,5,10,5,!1,e,s),this.settings.developerMode&&(s.beginPath(),s.rect(0,0,t.width,t.height),s.strokeStyle="red",s.strokeWidth=1*e,s.stroke())}setDirty(e){this.dirty=e}draw(e,t,s,i){if(this.hit){var a=(r=this.constructor.hitCache.width*s)/2,o=(n=this.constructor.hitCache.height*s)/2;i.drawImage(this.constructor.hitCache.canvas,e-a,t-o,r,n)}else{var r,n;this.dirty&&this.recache(s),a=(r=this.constructor.cache.width*s)/2,o=(n=this.constructor.cache.height*s)/2,i.drawImage(this.constructor.cache.canvas,e-a,t-o,r,n)}}drawStar(e,t,s,i,a,o,r,n){var h=Math.PI/2*3,l=e,c=t,d=Math.PI/s;i*=r,a*=r,n.strokeSyle=/^(dark|midnight)$/i.test(lite.storage.get("theme"))?"#FBFBFB":this.outline,n.beginPath(),n.moveTo(e,t-i);for(var p=0;s>p;p++)l=e+Math.cos(h)*i,c=t+Math.sin(h)*i,n.lineTo(l,c),h+=d,l=e+Math.cos(h)*a,c=t+Math.sin(h)*a,n.lineTo(l,c),h+=d;n.lineTo(e,t-i),n.closePath(),n.lineWidth=Math.max(2*r,1),n.strokeStyle=/^(dark|midnight)$/i.test(lite.storage.get("theme"))?"#FBFBFB":this.outline,n.stroke(),n.fillStyle=o?"#FAE335":"#FFFFFF",n.fill()}collide(e){var t=e.parent.player,s=e.pos.x-this.x,i=e.pos.y-this.y,a=Math.sqrt(Math.pow(s,2)+Math.pow(i,2)),o=t._powerupsConsumed.targets,r=this.scene;if(26>a&&t.isAlive()&&-1===o.indexOf(this.id)){o.push(this.id);var n=o.length,h=r.track.targetCount;!1===t.isGhost()&&(this.hit=!0,this.sector.powerupCanvasDrawn=!1,r.sound.play("goal_sound"),r.message.show(n+" of "+h+" Stars",50,"#FAE335","#666666")),n>=h&&(t.complete=!0)}}static cache=Object.assign({},this.cache,{canvas:document.createElement("canvas"),width:35,height:35});static hitCache=Object.assign({},this.cache,{canvas:document.createElement("canvas")})},u=class extends o{id=null;otherPortal=null;hit=!1;name="teleport";recorded=!1;constructor(e,t,s){super(s),this.x=e,this.y=t,this.id=Math.random().toString(36).slice(2)}erase(e,t){var s=!1;return this.remove||t>=Math.sqrt(Math.pow(e.x-this.x,2)+Math.pow(e.y-this.y,2))&&(s=[this,this.otherPortal],this.removeAllReferences(),this.otherPortal.removeAllReferences()),s}addOtherPortalRef(e){this.otherPortal=e}getCode(){var e="";return!1===this.recorded&&!0===this.otherPortal.recorded?this.recorded=!0:!1===this.recorded&&!1===this.otherPortal.recorded?(this.recorded=!0,e="W "+this.x.toString(32)+" "+this.y.toString(32)+" "+this.otherPortal.x.toString(32)+" "+this.otherPortal.y.toString(32)):!0===this.recorded&&!0===this.otherPortal.recorded&&(this.otherPortal.recorded=!1,e="W "+this.x.toString(32)+" "+this.y.toString(32)+" "+this.otherPortal.x.toString(32)+" "+this.otherPortal.y.toString(32)),e}recache(e){this.constructor.cache.dirty=!1,this.drawPowerup(e,this.constructor.cache)}drawPowerup(e,t){var s=t.canvas;s.width=t.width*e,s.height=t.height*e;var i=s.getContext("2d"),a=.65*e;i.save(),i.scale(a,a),i.save(),i.beginPath(),i.moveTo(0,0),i.lineTo(44,0),i.lineTo(44,48),i.lineTo(0,48),i.closePath(),i.clip(),i.translate(0,0),i.translate(0,0),i.scale(1,1),i.translate(0,0),i.strokeStyle="rgba(0,0,0,0)",i.lineCap="butt",i.lineJoin="miter",i.miterLimit=4,i.save(),i.restore(),i.save(),i.restore(),i.save(),i.fillStyle="rgba(0, 0, 0, 0)",i.strokeStyle="rgba(0, 0, 0, 0)",i.lineWidth=1,i.translate(-788,-50),i.save(),i.translate(790,52),i.save(),i.fillStyle=/^(dark|midnight)$/i.test(lite.storage.get("theme"))?"#FBFBFB":this.outline,i.beginPath(),i.moveTo(17,3),i.bezierCurveTo(16.9424049,2.83458834,16.4420628,2.62968665,15.9196825,2.4515011),i.lineTo(8.51063934,-.0757469011),i.lineTo(16.223952,-1.41205186),i.bezierCurveTo(21.2423806,-2.2814774,25.8773816,-1.40451316,29.9447883,.583562762),i.bezierCurveTo(31.7394578,1.46076529,33.0361403,2.35169307,33.7316821,2.95217334),i.bezierCurveTo(35.1972328,4.14751314,36.509471,5.52829294,37.6336956,7.05811132),i.bezierCurveTo(39.8993675,10.1439271,41.2801108,13.6041318,41.7252304,17.3208639),i.bezierCurveTo(41.7397043,17.4414782,41.7543021,17.5670407,41.7704814,17.7094344),i.bezierCurveTo(41.7921038,17.9009058,41.7921038,17.9009058,41.8132645,18.0904969),i.lineTo(41.840873,18.3390683),i.lineTo(41.8856209,18.735971),i.lineTo(41.8856209,21.4226506),i.lineTo(41.8542399,21.5977061),i.bezierCurveTo(41.8009577,21.89487,41.7866262,21.9747988,41.7740749,22.044061),i.bezierCurveTo(41.759051,22.1809078,41.759051,22.1809078,41.7559584,22.2091488),i.bezierCurveTo(41.6872107,22.8267498,41.6438556,23.1562694,41.5609313,23.6049736),i.bezierCurveTo(40.8769441,27.3127264,39.3221077,30.5993535,36.9456235,33.3462518),i.bezierCurveTo(32.8945821,38.029004,27.65733,40.5391341,21.868366,40.5391341),i.bezierCurveTo(21.742671,40.5391341,21.6184358,40.538205,21.4955986,40.5363608),i.bezierCurveTo(22.1492681,41.0434881,22.8806236,41.5794806,23.6943816,42.1440112),i.lineTo(28.4276887,45.4276613),i.lineTo(22.6779106,45.7834802),i.bezierCurveTo(18.1741264,46.062192,14.0554746,45.155711,10.4302114,43.4736066),i.bezierCurveTo(8.54152696,42.5972663,7.17424655,41.7066293,6.38621142,41.0629331),i.bezierCurveTo(4.99599225,40.025971,3.38305673,38.3146562,2.25448469,36.778713),i.bezierCurveTo(-.0125398982,33.6943248,-1.39399999,30.2338948,-1.84021156,26.5118367),i.bezierCurveTo(-1.86468983,26.3063181,-1.88762639,26.1042985,-1.92006182,25.811651),i.lineTo(-1.95463612,25.5020237),i.lineTo(-2.00013072,25.1020716),i.lineTo(-2.00013072,22.4141906),i.lineTo(-1.96885958,22.2394346),i.bezierCurveTo(-1.92214724,21.9784071,-1.90657901,21.8914122,-1.89618079,21.8334198),i.bezierCurveTo(-1.83478692,21.2274076,-1.79887919,20.9331002,-1.72945035,20.5323584),i.bezierCurveTo(-.927733904,15.885014,1.1979378,11.9079902,4.5664052,8.76464131),i.bezierCurveTo(8.29993169,5.27968493,12.7861394,3.24768826,17.4210789,3.06365477),i.closePath(),i.fill(),i.stroke(),i.restore(),i.save(),i.fillStyle="#dd45ec",i.beginPath(),i.moveTo(23.9052288,5.91261647),i.bezierCurveTo(23.9052288,5.91261647,22.5543791,5.13614588,18.1099346,5.04995765),i.bezierCurveTo(13.6479739,5.05021647,9.39411765,6.99424,5.93111111,10.2266871),i.bezierCurveTo(2.88431373,13.0698635,.969542484,16.6517224,.241437908,20.8723576),i.bezierCurveTo(.169019608,21.2903576,.131372549,21.6617694,.101045752,21.9601929),i.bezierCurveTo(.0960784314,22.0104047,.0911111111,22.0611341,.0858823529,22.1113459),i.bezierCurveTo(.0837908497,22.1227341,.0816993464,22.1341224,.0796078431,22.1452518),i.lineTo(-.000130718954,22.5917224),i.lineTo(-.000130718954,23.0451812),i.lineTo(-.000130718954,24.6993224),i.lineTo(-.000130718954,24.9886871),i.lineTo(.0325490196,25.2759812),i.lineTo(.0675816993,25.5896753),i.bezierCurveTo(.0929411765,25.8184753,.118562092,26.0470165,.145751634,26.2752988),i.bezierCurveTo(.550457516,29.6511341,1.80196078,32.7860047,3.86601307,35.59424),i.bezierCurveTo(4.76326797,36.8153694,6.27176471,38.4928047,7.6179085,39.4864282),i.bezierCurveTo(7.6179085,39.4864282,13.4911111,44.3481694,22.5543791,43.7872988),i.bezierCurveTo(16.5849673,39.6461224,15.7624837,37.5460282,15.7624837,37.5460282),i.bezierCurveTo(16.4521569,37.6208282,18.1535948,38.5391341,21.868366,38.5391341),i.bezierCurveTo(27.0628758,38.5391341,31.7535948,36.2909929,35.4330719,32.0377459),i.bezierCurveTo(37.5739869,29.5631341,38.9739869,26.6037459,39.5941176,23.2421459),i.bezierCurveTo(39.6816993,22.76824,39.7295425,22.3354871,39.7682353,21.9878871),i.bezierCurveTo(39.7768627,21.9092047,39.7852288,21.8300047,39.7946405,21.7510635),i.bezierCurveTo(39.7983007,21.7319106,39.8019608,21.7124988,39.8053595,21.6930871),i.lineTo(39.8856209,21.2448047),i.lineTo(39.8856209,20.7895341),i.lineTo(39.8856209,19.1356518),i.lineTo(39.8856209,18.8483576),i.lineTo(39.8534641,18.5631341),i.lineTo(39.8254902,18.3112988),i.bezierCurveTo(39.7975163,18.0607576,39.7695425,17.8096988,39.7394771,17.5591576),i.bezierCurveTo(39.3355556,14.1864282,38.0845752,11.0515576,36.0215686,8.24176941),i.bezierCurveTo(34.9975163,6.84826353,33.8019608,5.59038118,32.4675817,4.50202824),i.bezierCurveTo(32.4675817,4.50202824,25.996732,-1.07536,16.5653595,.558592941),i.bezierCurveTo(21.6393464,2.28934588,23.9052288,5.91261647,23.9052288,5.91261647),i.fill(),i.stroke(),i.restore(),i.save(),i.fillStyle=lite.storage.get("dark")?"#1e1e1e":"#fefefe",i.beginPath(),i.moveTo(5.22875817,24.6992965),i.lineTo(5.22875817,23.0451553),i.bezierCurveTo(5.24078431,22.97812,5.25647059,22.9113435,5.26457516,22.8437906),i.bezierCurveTo(5.30823529,22.4770376,5.33254902,22.1071788,5.39555556,21.7440494),i.bezierCurveTo(5.9179085,18.7173671,7.26117647,16.0988494,9.5179085,13.9930612),i.bezierCurveTo(12.7882353,10.9404965,16.6520261,9.83428471,21.0614379,10.8020259),i.bezierCurveTo(23.1579085,11.2619553,24.9563399,12.2887082,26.3997386,13.8804729),i.bezierCurveTo(27.8005229,15.4251318,28.5681046,17.2482847,28.8130719,19.3033435),i.bezierCurveTo(29.0044444,20.9103788,28.7861438,22.4467553,28.0836601,23.9122141),i.bezierCurveTo(26.5186928,27.1764965,23.3458824,28.74652,19.8862745,27.9666847),i.bezierCurveTo(17.6018301,27.4518847,16.0658824,25.7762612,15.7793464,23.4833435),i.bezierCurveTo(15.7513725,23.2566141,15.7422222,23.0278141,15.7233987,22.7920259),i.bezierCurveTo(15.6826144,22.7959082,15.6577778,22.7959082,15.6345098,22.8013435),i.bezierCurveTo(15.2580392,22.8929671,15.0844444,23.1867318,14.9532026,23.5037906),i.bezierCurveTo(14.6407843,24.2592965,14.6128105,25.0383553,14.8180392,25.8238847),i.bezierCurveTo(15.1252288,26.9999788,15.8075817,27.9480494,16.7301961,28.7162376),i.bezierCurveTo(19.105098,30.6939082,21.8201307,31.2356259,24.7777778,30.3869435),i.bezierCurveTo(27.9027451,29.4903788,30.1628758,27.5002847,31.6556863,24.6703082),i.bezierCurveTo(33.1751634,21.7893435,33.4169935,18.73652,32.7003922,15.5969906),i.bezierCurveTo(32.1134641,13.0263553,30.9056209,10.7471553,29.2807843,8.67397882),i.bezierCurveTo(29.2345098,8.61496706,29.1887582,8.55595529,29.1427451,8.49694353),i.bezierCurveTo(30.1487582,9.31767294,31.0295425,10.2476259,31.7918954,11.2855082),i.bezierCurveTo(33.305098,13.3460024,34.2433987,15.6329671,34.5471895,18.1681435),i.bezierCurveTo(34.5856209,18.4903788,34.6206536,18.8131318,34.6569935,19.1356259),i.lineTo(34.6569935,20.7897671),i.bezierCurveTo(34.6449673,20.8565435,34.629281,20.92332,34.620915,20.9908729),i.bezierCurveTo(34.5644444,21.4313906,34.5309804,21.8763082,34.4501961,22.3121671),i.bezierCurveTo(34.0122876,24.6873906,33.0475817,26.8374376,31.4616993,28.6706847),i.bezierCurveTo(28.1134641,32.5408729,23.9121569,34.11012,18.8256209,33.0287553),i.bezierCurveTo(16.5994771,32.5553671,14.72,31.4287082,13.2504575,29.68372),i.bezierCurveTo(11.9879739,28.1846141,11.2983007,26.4463553,11.0705882,24.5126847),i.bezierCurveTo(10.871634,22.8236024,11.1286275,21.2212259,11.9113725,19.7042612),i.bezierCurveTo(13.5228758,16.5810376,16.6386928,15.0982376,19.9803922,15.8646141),i.bezierCurveTo(22.303268,16.3975318,23.7997386,18.0288965,24.1079739,20.3696965),i.bezierCurveTo(24.136732,20.5899553,24.1440523,20.8128024,24.1662745,21.1008729),i.bezierCurveTo(24.343268,20.9921671,24.5147712,20.9334141,24.6146405,20.8153906),i.bezierCurveTo(24.7620915,20.6414612,24.8909804,20.4375082,24.970719,20.2255318),i.bezierCurveTo(25.28,19.4032494,25.2648366,18.5688024,24.9890196,17.7405671),i.bezierCurveTo(24.5738562,16.4935553,23.7654902,15.5263318,22.715817,14.7615082),i.bezierCurveTo(20.315817,13.0147082,17.6664052,12.6334612,14.8541176,13.5207082),i.bezierCurveTo(11.8538562,14.4672259,9.67267974,16.4187553,8.23006536,19.1622847),i.bezierCurveTo(6.68470588,22.1014847,6.45960784,25.2078847,7.22352941,28.3996965),i.bezierCurveTo(7.82248366,30.8996729,9.0096732,33.1206376,10.5921569,35.1438612),i.bezierCurveTo(10.6420915,35.2083082,10.692549,35.2724965,10.743268,35.3364259),i.bezierCurveTo(9.97568627,34.7698612,8.83764706,33.5606376,8.09385621,32.5486376),i.bezierCurveTo(6.57986928,30.4886612,5.6420915,28.2016965,5.33830065,25.66652),i.bezierCurveTo(5.29960784,25.3442847,5.26535948,25.0215318,5.22875817,24.6992965),i.fill(),i.stroke(),i.restore(),i.restore(),i.restore(),i.restore()}draw(e,t,s,i){this.constructor.cache.dirty&&this.recache(s);let a=this.constructor.cache.width*s,o=this.constructor.cache.height*s,r=a/2,n=o/2,h=e,l=t;i.globalAlpha=!1===this.hit?1:.2,i.translate(h,l),i.drawImage(this.constructor.cache.canvas,-r,-n,a,o),i.translate(-h,-l)}collide(e){let t=e.parent,s=t.player,i=s._powerupsConsumed.misc;if(-1===i.indexOf(this.id)){let a=e.pos.x-this.x,o=e.pos.y-this.y;1e3>Math.pow(a,2)+Math.pow(o,2)&&s.isAlive()&&(i.push(this.id),i.push(this.otherPortal.id),t.moveVehicle(this.otherPortal.x-this.x,this.otherPortal.y-this.y),!1===s.isGhost()&&(this.hit=!0,this.otherPortal.hit=!0,this.sector.powerupCanvasDrawn=!1,this.otherPortal.sector.powerupCanvasDrawn=!1,this.scene.sound.play("teleport_sound",.3),this.scene.message.show("Teleport Engaged",50,"#8ac832")))}}move(e,t){return this.x+=0|parseInt(e),this.y+=0|parseInt(t),this.otherPortal.x+=0|parseInt(e),this.otherPortal.y+=0|parseInt(t),this}static cache=Object.assign({},this.cache,{canvas:document.createElement("canvas"),width:29,height:32})},g=class{sectors=null;p1=null;p2=null;pp=null;len=0;collided=!1;remove=!1;recorded=!1;type="scenery";constructor(e,t,i,a){this.p1=new s(e,t),this.p2=new s(i,a),this.pp=this.p2.sub(this.p1),this.len=this.pp.len(),this.sectors=[]}move(e,t){return this.p1.x+=0|parseInt(e),this.p1.y+=0|parseInt(t),this.p2.x+=0|parseInt(e),this.p2.y+=0|parseInt(t),this}getCode(e){this.recorded=!0;var t=this.p2,s=" "+t.x.toString(32)+" "+t.y.toString(32),i=this.checkForConnectedLine(e,t);return i&&(s+=i.getCode(e)),s}checkForConnectedLine(e,t){var s=e.settings.drawSectorSize,i=e.sectors.drawSectors,a=Math.floor(t.x/s),o=Math.floor(t.y/s);return i[a][o].searchForLine("sceneryLines",t)}erase(e,t){var s=!1;if(!this.remove){var i=this.p1,a=e,o=t,r=this.p2.sub(i),n=i.sub(a),h=r.dot(r),l=2*n.dot(r),c=l*l-4*h*(n.dot(n)-o*o);if(c>0){var d=(-l-(c=Math.sqrt(c)))/(2*h),p=(-l+c)/(2*h);d>=0&&1>=d&&(s=!0,this.removeAllReferences()),p>=0&&1>=p&&(s=!0,this.removeAllReferences())}(this.intersects(this.p1.x,this.p1.y,e.x,e.y,t)||this.intersects(this.p2.x,this.p2.y,e.x,e.y,t))&&(s=!0,this.removeAllReferences())}return s}intersects(e,t,s,i,a){var o=e-s,r=t-i;return a*a>=o*o+r*r}addSectorReference(e){this.sectors.push(e)}removeAllReferences(){this.remove=!0;for(var e=this.sectors,t=e.length,s=0;t>s;s++)e[s].drawn=!1,e[s].dirty=!0;this.sectors=[]}},m=class extends o{recache(e){this.constructor.cache.dirty=!1;let t=this.constructor.cache.canvas;t.width=this.constructor.cache.width*e,t.height=this.constructor.cache.height*e;let s=t.getContext("2d"),i=t.width/2,a=t.height/2;this.drawIcon(i,a,e,s)}static cache=Object.assign({},this.cache,{canvas:document.createElement("canvas"),width:32,height:42})},y=class extends m{name="balloon";constructor(e,t,s,i){super(i),this.x=e,this.y=t,this.time=s,this.id=Math.random().toString(36).slice(2),this.hit=!1}collide(e){var t=e.parent,s=t.player,i=e.pos.x-this.x,a=e.pos.y-this.y,o=Math.sqrt(Math.pow(i,2)+Math.pow(a,2)),r=s._powerupsConsumed.misc,n=this.scene;if(30>o&&s.isAlive()&&-1===r.indexOf(this.id)){r.push(this.id);var h=this.time*n.settings.drawFPS;s.setTempVehicle("BALLOON",h,{x:this.x,y:this.y},t.dir),n.camera.playerFocus===s&&(n.camera.focusOnPlayer(),n.vehicleTimer.playerAddedTime(s)),!1===s.isGhost()&&(this.hit=!0,this.sector.powerupCanvasDrawn=!1,this.scene.message.show("Balloon Powerup!",50,"#f02728",!1))}}drawIcon(e,t,s,i){i.save(),i.scale(s,s),i.beginPath(),i.moveTo(0,0),i.lineTo(21,0),i.lineTo(21,31),i.lineTo(0,31),i.closePath(),i.clip(),i.translate(0,0),i.translate(0,0),i.scale(1,1),i.translate(0,0),i.strokeStyle="rgba(0,0,0,0)",i.lineCap="butt",i.lineJoin="miter",i.miterLimit=4,i.save(),i.restore(),i.save(),i.restore(),i.save(),i.fillStyle="rgba(0, 0, 0, 0)",i.strokeStyle="rgba(0, 0, 0, 0)",i.lineWidth=1,i.translate(-1322,-440),i.save(),i.translate(251,28),i.save(),i.translate(1056,265),i.save(),i.translate(3,141),i.save(),i.translate(12,6),i.save(),i.fillStyle=/^(dark|midnight)$/i.test(lite.storage.get("theme"))?"#FBFBFB":this.outline,i.beginPath(),i.moveTo(7,23),i.lineTo(14,23),i.quadraticCurveTo(15,23,15,24),i.lineTo(15,30),i.quadraticCurveTo(15,31,14,31),i.lineTo(7,31),i.quadraticCurveTo(6,31,6,30),i.lineTo(6,24),i.quadraticCurveTo(6,23,7,23),i.closePath(),i.fill(),i.stroke(),i.restore(),i.save(),i.strokeStyle=/^(dark|midnight)$/i.test(lite.storage.get("theme"))?"#FBFBFB":this.outline,i.lineWidth=2,i.lineCap="round",i.beginPath(),i.moveTo(15,19),i.lineTo(12.9375,24.6875),i.fill(),i.stroke(),i.restore(),i.save(),i.strokeStyle=/^(dark|midnight)$/i.test(lite.storage.get("theme"))?"#FBFBFB":this.outline,i.lineWidth=2,i.lineCap="round",i.translate(7.03125,21.84375),i.scale(-1,1),i.translate(-7.03125,-21.84375),i.beginPath(),i.moveTo(8.0625,19),i.lineTo(6,24.6875),i.fill(),i.stroke(),i.restore(),i.save(),i.save(),i.fillStyle="#f02728",i.save(),i.beginPath(),i.arc(10.5,11.125,10.5,0,6.283185307179586,!0),i.closePath(),i.fill(),i.stroke(),i.restore(),i.restore(),i.save(),i.strokeStyle=/^(dark|midnight)$/i.test(lite.storage.get("theme"))?"#FBFBFB":this.outline,i.lineWidth=2,i.beginPath(),i.arc(10.5,11.125,9.5,0,6.283185307179586,!0),i.closePath(),i.fill(),i.stroke(),i.restore(),i.restore(),i.restore(),i.restore(),i.restore(),i.restore(),i.restore(),i.restore()}getCode(){return"V "+this.x.toString(32)+" "+this.y.toString(32)+" 3 "+this.time.toString(32)}static cache=Object.assign({},this.cache,{canvas:document.createElement("canvas"),width:22})},w=class extends m{name="blob";constructor(e,t,s,i){super(i),this.x=e,this.y=t,this.time=s,this.id=Math.random().toString(36).slice(2),this.hit=!1}collide(e){var t=e.parent,s=t.player,i=e.pos.x-this.x,a=e.pos.y-this.y,o=Math.sqrt(Math.pow(i,2)+Math.pow(a,2)),r=s._powerupsConsumed.misc,n=this.scene;if(30>o&&s.isAlive()&&-1===r.indexOf(this.id)){r.push(this.id);var h=this.time*n.settings.drawFPS;s.setTempVehicle("BLOB",h,{x:this.x,y:this.y},t.dir),n.camera.playerFocus===s&&(n.camera.focusOnPlayer(),n.vehicleTimer.playerAddedTime(s)),!1===s.isGhost()&&(this.hit=!0,this.sector.powerupCanvasDrawn=!1,this.scene.message.show("Blob Powerup!",50,"#A784C5",!1))}}getCode(){return"V "+this.x.toString(32)+" "+this.y.toString(32)+" 4 "+this.time.toString(32)}drawIcon(e,t,s,i){s*=1,i.lineCap="butt",i.lineJoin="miter",i.miterLimit=4*s,i.save(),i.scale(s,s),i.beginPath(),i.moveTo(0,0),i.lineTo(24,0),i.lineTo(24,22),i.lineTo(0,22),i.closePath(),i.clip(),i.translate(0,0),i.translate(0,0),i.scale(1,1),i.translate(0,0),i.strokeStyle="rgba(0,0,0,0)",i.lineCap="butt",i.lineJoin="miter",i.miterLimit=4,i.save(),i.restore(),i.save(),i.restore(),i.save(),i.fillStyle="rgba(0, 0, 0, 0)",i.strokeStyle="rgba(0, 0, 0, 0)",i.lineWidth=1,i.translate(-1320,-491),i.save(),i.translate(251,28),i.save(),i.translate(1056,265),i.save(),i.translate(3,187),i.save(),i.translate(10,11),i.save(),i.save(),i.fillStyle="#a784c5",i.save(),i.beginPath(),i.moveTo(4,0),i.lineTo(20,0),i.quadraticCurveTo(24,0,24,4),i.lineTo(24,18),i.quadraticCurveTo(24,22,20,22),i.lineTo(4,22),i.quadraticCurveTo(0,22,0,18),i.lineTo(0,4),i.quadraticCurveTo(0,0,4,0),i.closePath(),i.fill(),i.stroke(),i.restore(),i.restore(),i.save(),i.strokeStyle=/^(dark|midnight)$/i.test(lite.storage.get("theme"))?"#FBFBFB":this.outline,i.lineWidth=2,i.beginPath(),i.moveTo(5,1),i.lineTo(19,1),i.quadraticCurveTo(23,1,23,5),i.lineTo(23,17),i.quadraticCurveTo(23,21,19,21),i.lineTo(5,21),i.quadraticCurveTo(1,21,1,17),i.lineTo(1,5),i.quadraticCurveTo(1,1,5,1),i.closePath(),i.fill(),i.stroke(),i.restore(),i.restore(),i.restore(),i.restore(),i.restore(),i.restore(),i.restore(),i.restore()}static cache=Object.assign({},this.cache,{canvas:document.createElement("canvas")})},v=class extends m{name="helicopter";constructor(e,t,s,i){super(i),this.x=e,this.y=t,this.time=s,this.id=Math.random().toString(36).slice(2),this.hit=!1}collide(e){var t=e.parent,s=t.player,i=e.pos.x-this.x,a=e.pos.y-this.y,o=Math.sqrt(Math.pow(i,2)+Math.pow(a,2)),r=s._powerupsConsumed.misc,n=this.scene;if(30>o&&s.isAlive()&&-1===r.indexOf(this.id)){r.push(this.id);var h=this.time*n.settings.drawFPS;s.setTempVehicle("HELI",h,{x:this.x,y:this.y},t.dir),n.camera.playerFocus===s&&(n.camera.focusOnPlayer(),n.vehicleTimer.playerAddedTime(s)),!1===s.isGhost()&&(this.hit=!0,this.sector.powerupCanvasDrawn=!1,this.scene.message.show("Helicopter Powerup!",50,"#F2902E",!1))}}drawIcon(e,t,s,i){s*=1,i.lineCap="butt",i.lineJoin="miter",i.miterLimit=4*s,i.strokeStyle=/^(dark|midnight)$/i.test(lite.storage.get("theme"))?"#FBFBFB":this.outline,i.fillStyle=/^(dark|midnight)$/i.test(lite.storage.get("theme"))?"#FBFBFB":this.outline,i.beginPath(),i.moveTo(15*s,4.5*s),i.lineTo(15*s,2.5*s),i.bezierCurveTo(15*s,1.4*s,14.1*s,.5*s,13*s,.5*s),i.bezierCurveTo(11.9*s,.5*s,11*s,1.4*s,11*s,2.5*s),i.lineTo(11*s,4.5*s),i.bezierCurveTo(11*s,5.6*s,11.9*s,6.5*s,13*s,6.5*s),i.bezierCurveTo(14.1*s,6.5*s,15*s,5.6*s,15*s,4.5*s),i.lineTo(15*s,4.5*s),i.closePath(),i.fill(),i.beginPath(),i.lineCap="round",i.lineWidth=2*s,i.moveTo(1*s,3*s),i.lineTo(25*s,3*s),i.stroke(),i.lineCap="butt",i.lineWidth=1*s,i.beginPath(),i.moveTo(6.1*s,26.9*s),i.lineTo(4.1*s,31.9*s),i.bezierCurveTo(3.8*s,32.7*s,4.2*s,33.6*s,4.9*s,33.9*s),i.bezierCurveTo(5.7*s,34.2*s,6.6*s,33.8*s,6.9*s,33*s),i.lineTo(8.9*s,28*s),i.bezierCurveTo(9.2*s,27.3*s,8.8*s,26.4*s,8*s,26.1*s),i.bezierCurveTo(7.3*s,25.8*s,6.4*s,26.1*s,6.1*s,26.9*s),i.lineTo(6.1*s,26.9*s),i.closePath(),i.fill(),i.stroke(),i.beginPath(),i.moveTo(17*s,28*s),i.lineTo(19*s,33*s),i.bezierCurveTo(19.4*s,33.8*s,20.3*s,34.2*s,21*s,33.9*s),i.bezierCurveTo(21.8*s,33.6*s,22.2*s,32.7*s,21.9*s,31.9*s),i.lineTo(19.9*s,26.9*s),i.bezierCurveTo(19.6*s,26.2*s,18.7*s,25.8*s,17.9*s,26.1*s),i.bezierCurveTo(17.2*s,26.4*s,16.8*s,27.3*s,17.1*s,28*s),i.lineTo(17*s,28*s),i.closePath(),i.fill(),i.stroke(),i.fillStyle="#f59423",i.strokeStyle=/^(dark|midnight)$/i.test(lite.storage.get("theme"))?"#FBFBFB":this.outline,i.lineWidth=2*s,i.beginPath(),i.arc(13*s,17*s,11*s,0*s,2*Math.PI,!0),i.closePath(),i.fill(),i.stroke(),i.fillStyle=/^(dark|midnight)$/i.test(lite.storage.get("theme"))?"#FBFBFB":this.outline,i.beginPath(),i.moveTo(21*s,17*s),i.bezierCurveTo(21*s,12.6*s,17.4*s,9*s,13*s,9*s),i.bezierCurveTo(8.6*s,9*s,5*s,12.6*s,5*s,17*s),i.lineTo(21*s,17*s),i.closePath(),i.fill()}getCode(){return"V "+this.x.toString(32)+" "+this.y.toString(32)+" 1 "+this.time.toString(32)}static cache=Object.assign({},this.cache,{canvas:document.createElement("canvas")})},f=class extends m{name="truck";constructor(e,t,s,i){super(i),this.x=e,this.y=t,this.time=s,this.id=Math.random().toString(36).slice(2),this.hit=!1}collide(e){var t=e.parent,s=t.player,i=e.pos.x-this.x,a=e.pos.y-this.y,o=Math.sqrt(Math.pow(i,2)+Math.pow(a,2)),r=s._powerupsConsumed.misc,n=this.scene;if(30>o&&s.isAlive()&&-1===r.indexOf(this.id)){r.push(this.id);var h=this.time*n.settings.drawFPS;s.setTempVehicle("TRUCK",h,{x:this.x,y:this.y},t.dir),n.camera.playerFocus===s&&(n.camera.focusOnPlayer(),n.vehicleTimer.playerAddedTime(s)),!1===s.isGhost()&&(this.hit=!0,this.sector.powerupCanvasDrawn=!1,this.scene.message.show("Truck Powerup!",50,"#94d44e",!1))}}drawIcon(e,t,s,i){s*=1,i.save(),i.scale(s,s),i.beginPath(),i.moveTo(0,0),i.lineTo(24,0),i.lineTo(24,26),i.lineTo(0,26),i.closePath(),i.clip(),i.translate(0,0),i.translate(0,0),i.scale(1,1),i.translate(0,0),i.strokeStyle="rgba(0,0,0,0)",i.lineCap="butt",i.lineJoin="miter",i.miterLimit=4,i.save(),i.restore(),i.save(),i.restore(),i.save(),i.fillStyle="rgba(0, 0, 0, 0)",i.strokeStyle="rgba(0, 0, 0, 0)",i.lineWidth=1,i.translate(-1320,-352),i.save(),i.translate(251,28),i.save(),i.translate(1056,265),i.save(),i.translate(3,49),i.save(),i.translate(10,8),i.save(),i.fillStyle=/^(dark|midnight)$/i.test(lite.storage.get("theme"))?"#FBFBFB":this.outline,i.beginPath(),i.moveTo(2,17),i.lineTo(4,17),i.quadraticCurveTo(6,17,6,19),i.lineTo(6,26),i.quadraticCurveTo(6,28,4,28),i.lineTo(2,28),i.quadraticCurveTo(0,28,0,26),i.lineTo(0,19),i.quadraticCurveTo(0,17,2,17),i.closePath(),i.fill(),i.stroke(),i.restore(),i.save(),i.fillStyle=/^(dark|midnight)$/i.test(lite.storage.get("theme"))?"#FBFBFB":this.outline,i.beginPath(),i.moveTo(20,17),i.lineTo(22,17),i.quadraticCurveTo(24,17,24,19),i.lineTo(24,26),i.quadraticCurveTo(24,28,22,28),i.lineTo(20,28),i.quadraticCurveTo(18,28,18,26),i.lineTo(18,19),i.quadraticCurveTo(18,17,20,17),i.closePath(),i.fill(),i.stroke(),i.restore(),i.save(),i.strokeStyle=/^(dark|midnight)$/i.test(lite.storage.get("theme"))?"#FBFBFB":this.outline,i.lineWidth=2,i.lineCap="square",i.beginPath(),i.moveTo(3.5,23),i.lineTo(20.5,23),i.fill(),i.stroke(),i.restore(),i.save(),i.save(),i.fillStyle="#94d44e",i.save(),i.beginPath(),i.moveTo(23,11.2672237),i.bezierCurveTo(23.5979157,11.6115707,24,12.2552568,24,12.999615),i.lineTo(24,19.000385),i.bezierCurveTo(24,20.1047419,23.1029738,21,21.9950534,21),i.lineTo(2.00494659,21),i.bezierCurveTo(.897645164,21,0,20.1125667,0,19.000385),i.lineTo(0,12.999615),i.bezierCurveTo(0,12.2603805,.401930294,11.6148368,1,11.268783),i.lineTo(1,3.99742191),i.bezierCurveTo(1,2.89427625,1.88967395,2,2.991155,2),i.lineTo(21.008845,2),i.bezierCurveTo(22.1085295,2,23,2.89092539,23,3.99742191),i.lineTo(23,11.2672237),i.closePath(),i.fill(),i.stroke(),i.restore(),i.restore(),i.save(),i.strokeStyle=/^(dark|midnight)$/i.test(lite.storage.get("theme"))?"#FBFBFB":this.outline,i.lineWidth=2,i.beginPath(),i.moveTo(22.5009348,12.1337882),i.lineTo(22,11.8452936),i.lineTo(22,3.99742191),i.bezierCurveTo(22,3.44392402,21.5569554,3,21.008845,3),i.lineTo(2.991155,3),i.bezierCurveTo(2.44342393,3,2,3.44509694,2,3.99742191),i.lineTo(2,11.8455),i.lineTo(1.50082265,12.1343329),i.bezierCurveTo(1.19247839,12.3127464,1,12.6390115,1,12.999615),i.lineTo(1,19.000385),i.bezierCurveTo(1,19.5563739,1.44601448,20,2.00494659,20),i.lineTo(21.9950534,20),i.bezierCurveTo(22.5510229,20,23,19.5521213,23,19.000385),i.lineTo(23,12.999615),i.bezierCurveTo(23,12.6352349,22.8086914,12.311029,22.5009348,12.1337882),i.closePath(),i.fill(),i.stroke(),i.restore(),i.restore(),i.save(),i.fillStyle=/^(dark|midnight)$/i.test(lite.storage.get("theme"))?"#FBFBFB":this.outline,i.beginPath(),i.moveTo(5,6),i.lineTo(19,6),i.quadraticCurveTo(19,6,19,6),i.lineTo(19,12),i.quadraticCurveTo(19,12,19,12),i.lineTo(5,12),i.quadraticCurveTo(5,12,5,12),i.lineTo(5,6),i.quadraticCurveTo(5,6,5,6),i.closePath(),i.fill(),i.stroke(),i.restore(),i.save(),i.fillStyle=/^(dark|midnight)$/i.test(lite.storage.get("theme"))?"#FBFBFB":this.outline,i.beginPath(),i.arc(5.03571429,16.0357143,1.39285714,0,6.283185307179586,!0),i.closePath(),i.fill(),i.stroke(),i.restore(),i.save(),i.fillStyle=/^(dark|midnight)$/i.test(lite.storage.get("theme"))?"#FBFBFB":this.outline,i.beginPath(),i.arc(18.9642857,16.0357143,1.39285714,0,6.283185307179586,!0),i.closePath(),i.fill(),i.stroke(),i.restore(),i.restore(),i.restore(),i.restore(),i.restore(),i.restore(),i.restore()}getCode(){return"V "+this.x.toString(32)+" "+this.y.toString(32)+" 2 "+this.time.toString(32)}static cache=Object.assign({},this.cache,{canvas:document.createElement("canvas")})};let x=[];const T=class{defaultLine={p1:new s(-40,50),p2:new s(40,50)};game=null;scene=null;camera=null;canvas=null;canvasPool=null;settings=null;physicsLines=[];sceneryLines=[];powerups=[];powerupsLookupTable={};targets=[];targetCount=0;sectors={};totalSectors=[];allowedVehicles=null;dirty=!1;constructor(e){this.scene=e,this.game=e.game,this.settings=e.game.settings,this.settings.track||(this.settings.track={vehicle:this.settings.startVehicle}),this.camera=e.camera,this.sectors.drawSectors=[],this.sectors.physicsSectors=[],this.allowedVehicles=["MTB","BMX"],this.canvasPool=new class{canvasPool=null;poolCap=5e3;setToScreen=!0;options=null;constructor(e){this.options=e,this.canvasPool=[],e.screen&&(this.setToScreen=!0,this.update()),e.cap&&(this.setToScreen=!1,this.poolCap=e.cap)}update(){this.setToScreen&&(this.getPoolCapFromScreen(),this.cleanPool())}getPoolCapFromScreen(){this.poolCap=Math.ceil(this.options.screen.width/Math.floor(this.options.settings.drawSectorSize*this.options.camera.zoom))*Math.ceil(this.options.screen.height/Math.floor(this.options.settings.drawSectorSize*this.options.camera.zoom))+Math.ceil(this.options.screen.width/Math.floor(this.options.settings.drawSectorSize*this.options.camera.zoom))+Math.ceil(this.options.screen.height/Math.floor(this.options.settings.drawSectorSize*this.options.camera.zoom))}getCanvas(){let e=this.canvasPool.pop();return null==e&&(e=document.createElement("canvas")),e}releaseCanvas(e){this.canvasPool.length<this.poolCap&&this.canvasPool.push(e)}cleanPool(){this.canvasPool.length>this.poolCap&&(this.canvasPool=this.canvasPool.slice(0,this.poolCap+1))}}(e),this.createPowerupCache()}createPowerupCache(){x.push(new h(0,0,0,this)),x.push(new d(0,0,this)),x.push(new n(0,0,this)),x.push(new c(0,0,0,this)),x.push(new l(0,0,this)),x.push(new p(0,0,this)),x.push(new r(0,0,this)),x.push(new u(0,0,this)),x.push(new v(0,0,0,this)),x.push(new f(0,0,0,this)),x.push(new y(0,0,0,this)),x.push(new w(0,0,0,this))}recachePowerups(e){for(const t of x)t.recache(e)}read(e){var t=e.split("#"),s=t[0].split(","),i=[],a=[];t.length>2?(i=t[1].split(","),a=t[2].split(",")):t.length>1&&(a=t[1].split(",")),this.addLines(s,this.addPhysicsLine),this.addLines(i,this.addSceneryLine),this.addPowerups(a)}move(e=0,t=0){for(const s in this.physicsLines)this.physicsLines[s].p1.x-=e,this.physicsLines[s].p1.y-=t,this.physicsLines[s].p2.x-=e,this.physicsLines[s].p2.y-=t,this.addPhysicsLineToTrack(this.physicsLines[s]),this.physicsLines.splice(i,1);for(const s in this.sceneryLines)this.sceneryLines[s].p1.x-=e,this.sceneryLines[s].p1.y-=t,this.sceneryLines[s].p2.x-=e,this.sceneryLines[s].p2.y-=t,this.addSceneryLineToTrack(s),this.sceneryLines.splice(i,1);for(const s in this.powerups)this.powerups[s].x-=e,this.powerups[s].y-=t,this.powerups[s].otherPortal&&(this.powerups[s].otherPortal.x-=e,this.powerups[s].otherPortal.y-=t),this.addPowerup(this.powerups[s]),this.powerups.splice(s,1);this.scene.redraw()}addPowerups(e){for(var t=e.length,s=[],i=0;t>i;i++)if((s=e[i].split(" ")).length>=2){for(var a=[],o=s.length,g=1;o>g;g++){var m=parseInt(s[g],32);a.push(m)}var x=Math.round(a[0]),T=Math.round(a[1]),b=null;switch(s[0]){case"B":b=new h(x,T,a[2],this),this.addPowerup(b);break;case"S":b=new d(x,T,this),this.addPowerup(b);break;case"O":b=new n(x,T,this),this.addPowerup(b);break;case"G":b=new c(x,T,a[2],this),this.addPowerup(b);break;case"C":b=new l(x,T,this),this.addPowerup(b);break;case"T":b=new p(x,T,this),this.addTarget(b),this.addPowerup(b);break;case"A":b=new r(x,T,this),this.addPowerup(b);break;case"V":var k=a[2],S=a[3],P=this.settings.vehiclePowerup.minTime,C=this.settings.vehiclePowerup.maxTime;switch(S=S||P,S=Math.min(S,C),S=Math.max(S,P),k){case 1:b=new v(x,T,S,this);break;case 2:b=new f(x,T,S,this);break;case 3:b=new y(x,T,S,this);break;case 4:b=new w(x,T,S,this);break;default:continue}this.addPowerup(b);break;case"W":var _=a[0],M=a[1],z=a[2],B=a[3],A=new u(_,M,this),F=new u(z,B,this);A.addOtherPortalRef(F),F.addOtherPortalRef(A),this.addPowerup(A),this.addPowerup(F)}}}addTarget(e){this.dirty=!0,this.targetCount++,this.targets.push(e)}addPowerup(e){this.addRef(e.x,e.y,e,2,this.sectors.physicsSectors,this.settings.physicsSectorSize);let t=this.addRef(e.x,e.y,e,2,this.sectors.drawSectors,this.settings.drawSectorSize);return!1!==t&&this.totalSectors.push(t),null!==e&&(this.powerups.push(e),e.id&&(this.powerupsLookupTable[e.id]=e)),e}addLines(e,t){for(let s=e.length,i=0;s>i;i++){let s=e[i].split(" "),a=s.length;if(a>3)for(let e=0;a-2>e;e+=2){let i=parseInt(s[e],32),a=parseInt(s[e+1],32),o=parseInt(s[e+2],32),r=parseInt(s[e+3],32);isNaN(i+a+o+r)||t.call(this,i,a,o,r)}}}addPhysicsLine(e,t,s,i){if(Math.sqrt(Math.pow(Math.round(s)-Math.round(e),2)+Math.pow(Math.round(i)-Math.round(t),2))>=2)return this.addPhysicsLineToTrack(new a(Math.round(e),Math.round(t),Math.round(s),Math.round(i)))}addPhysicsLineToTrack(e){for(let s=t(e.p1.x,e.p1.y,e.p2.x,e.p2.y,this.settings.drawSectorSize),i=0;s.length>i;i+=2){let t=this.addRef(s[i],s[i+1],e,1,this.sectors.drawSectors,this.settings.drawSectorSize);!1!==t&&this.totalSectors.push(t)}for(let s=t(e.p1.x,e.p1.y,e.p2.x,e.p2.y,this.settings.physicsSectorSize),i=0;s.length>i;i+=2)this.addRef(s[i],s[i+1],e,1,this.sectors.physicsSectors,this.settings.physicsSectorSize);return this.physicsLines.push(e),e}addSceneryLine(e,t,s,i){if(Math.sqrt(Math.pow(Math.round(s)-Math.round(e),2)+Math.pow(Math.round(i)-Math.round(t),2))>=2)return this.addSceneryLineToTrack(new g(Math.round(e),Math.round(t),Math.round(s),Math.round(i)))}addSceneryLineToTrack(e){for(let s=this.settings.drawSectorSize,i=e.p1,a=e.p2,o=t(i.x,i.y,a.x,a.y,s),r=this.sectors.drawSectors,n=o.length,h=0;n>h;h+=2){let t=this.addRef(o[h],o[h+1],e,1,r,s);!1!==t&&this.totalSectors.push(t)}return this.sceneryLines.push(e),e}addRef(e,t,s,i,o,r){let n=Math.floor(e/r),h=Math.floor(t/r),l=!1;if(void 0===o[n]&&(o[n]=[]),void 0===o[n][h]){let e=new class{image=!1;scene=null;settings=null;drawSectorSize=null;row=0;column=0;camera=null;zoom=0;x=0;y=0;realX=0;realY=0;lineCount=0;powerupsCount=0;drawn=!1;physicsLines=[];sceneryLines=[];powerups=[];canvasPool=null;canvas=null;ctx=null;powerupCanvas=null;powerupCanvasOffset=30;powerupCanvasDrawn=!1;dirty=!1;constructor(e,t,s){this.track=s,this.scene=s.scene,this.settings=s.settings,this.drawSectorSize=this.settings.drawSectorSize,this.row=t,this.column=e,this.camera=s.camera,this.zoom=s.camera.zoom,this.canvasPool=s.canvasPool,this.x=e*this.drawSectorSize,this.y=t*this.drawSectorSize,this.realX=this.x*this.zoom,this.realY=this.y*this.zoom,this.lineCount=0,this.powerupsCount=0,this.drawn=!1,this.dirty=!1,this.physicsLines=[],this.sceneryLines=[],this.hasPowerups=!1,this.powerups={all:[],goals:[],gravitys:[],boosts:[],slowmos:[],checkpoints:[],bombs:[],antigravitys:[],teleports:[],helicopters:[],trucks:[],balloons:[],blobs:[],gliders:[]}}addLine(e){e instanceof a&&this.physicsLines.push(e),e instanceof g&&this.sceneryLines.push(e),this.lineCount++,this.drawn=!1}searchForLine(e,t){for(const s in this[e])if(this[e][s].p1.x===t.x&&this[e][s].p1.y===t.y&&!1===this[e][s].recorded&&!1===this[e][s].remove)return this[e][s]}addPowerup(e){this.powerups.all.push(e),["goal","gravity","slowmo","boost","checkpoint","bomb","antigravity","teleport","helicopter","truck","balloon","blob","glider"].includes(e.name)&&this.powerups[e.name+"s"].push(e),this.powerupsCount++,this.hasPowerups=!0,this.powerupCanvasDrawn=!1}erase(e,t,s){var i=[...this.physicsLines.map(!0===s.physics?s=>(s.erase(e,t),s):e=>e),...this.sceneryLines.map(!0===s.scenery?s=>(s.erase(e,t),s):e=>e)];if(!0===s.powerups)for(const s of this.powerups.all){let a=s.erase(e,t);!1!==a&&i.push.apply(i,a)}return i}cleanSector(){this.cleanSectorType("physicsLines"),this.cleanSectorType("sceneryLines"),this.cleanSectorType("powerups","all"),0===this.powerups.all.length?(this.hasPowerups=!1,this.powerupCanvas&&(this.canvasPool.releaseCanvas(this.powerupCanvas),this.powerupCanvas=null)):(this.hasPowerups=!0,this.dirty=!1)}cleanSectorType(e,t){let s=this[e];t&&(s=s[t]);for(const e in s)s[e].remove&&s.splice(e,1)}draw(){this.canvas=this.canvasPool.getCanvas(),this.canvas.width=this.drawSectorSize*this.scene.camera.zoom|0,this.canvas.height=this.drawSectorSize*this.scene.camera.zoom|0,this.ctx=this.canvas.getContext("2d"),this.ctx.lineCap="round",this.ctx.lineWidth=Math.max(2*this.scene.camera.zoom,.5),this.ctx.clearRect(0,0,this.canvas.width,this.canvas.height),this.ctx.beginPath(),this.ctx.strokeStyle=this.settings.sceneryLineColor,this.drawLines(this.sceneryLines,this.scene.camera.zoom,this.ctx),this.ctx.stroke(),this.ctx.beginPath(),this.ctx.strokeStyle=this.settings.physicsLineColor,this.drawLines(this.physicsLines,this.scene.camera.zoom,this.ctx),this.ctx.stroke(),this.settings.developerMode&&(this.ctx.beginPath(),this.ctx.strokeStyle="blue",this.ctx.rect(0,0,this.drawSectorSize*this.scene.camera.zoom|0,this.drawSectorSize*this.scene.camera.zoom|0),this.ctx.stroke()),this.drawn=!0}drawLine(e,t){this.canvas||(this.canvas=this.canvasPool.getCanvas(),this.canvas.width=this.drawSectorSize*this.scene.camera.zoom|0,this.canvas.height=this.drawSectorSize*this.scene.camera.zoom|0,this.ctx=this.canvas.getContext("2d"),this.ctx.lineCap="round",this.ctx.lineWidth=Math.max(2*this.scene.camera.zoom,.5)),this.ctx.beginPath(),this.ctx.strokeStyle=t,this.ctx.moveTo((e.p1.x-this.x)*this.scene.camera.zoom,(e.p1.y-this.y)*this.scene.camera.zoom),this.ctx.lineTo((e.p2.x-this.x)*this.scene.camera.zoom,(e.p2.y-this.y)*this.scene.camera.zoom),this.ctx.stroke()}cachePowerupSector(){if(this.powerupCanvasDrawn=!0,this.powerups.all.length>0){this.powerupCanvas=this.canvasPool.getCanvas(),this.powerupCanvas.width=(this.drawSectorSize*this.scene.camera.zoom|0)+this.powerupCanvasOffset*this.scene.camera.zoom,this.powerupCanvas.height=(this.drawSectorSize*this.scene.camera.zoom|0)+this.powerupCanvasOffset*this.scene.camera.zoom;const e=this.powerupCanvas.getContext("2d");e.clearRect(0,0,this.powerupCanvas.width,this.powerupCanvas.height),this.drawPowerups(this.powerups.slowmos,this.scene.camera.zoom,e),this.drawPowerups(this.powerups.checkpoints,this.scene.camera.zoom,e),this.drawPowerups(this.powerups.boosts,this.scene.camera.zoom,e),this.drawPowerups(this.powerups.gravitys,this.scene.camera.zoom,e),this.drawPowerups(this.powerups.bombs,this.scene.camera.zoom,e),this.drawPowerups(this.powerups.goals,this.scene.camera.zoom,e),this.drawPowerups(this.powerups.antigravitys,this.scene.camera.zoom,e),this.drawPowerups(this.powerups.teleports,this.scene.camera.zoom,e),this.drawPowerups(this.powerups.helicopters,this.scene.camera.zoom,e),this.drawPowerups(this.powerups.trucks,this.scene.camera.zoom,e),this.drawPowerups(this.powerups.balloons,this.scene.camera.zoom,e),this.drawPowerups(this.powerups.blobs,this.scene.camera.zoom,e),this.drawPowerups(this.powerups.gliders,this.scene.camera.zoom,e),this.settings.developerMode&&(e.beginPath(),e.strokeStyle="red",e.rect(0,0,this.powerupCanvas.width,this.powerupCanvas.height),e.stroke())}}update(){this.realX=this.x*this.camera.zoom|0,this.realY=this.y*this.camera.zoom|0,this.zoom=this.camera.zoom}resetCollided(){for(let e=this.physicsLines.length-1;e>=0;e--)this.physicsLines[e]&&(this.physicsLines[e].collided=!1)}collide(e){for(let t=this.physicsLines.length-1;t>=0;t--)this.physicsLines[t]&&(this.physicsLines[t].remove?this.physicsLines.splice(t,1):this.physicsLines[t].collide(e));if(e.parent.powerupsEnabled)for(let t=this.powerups.all.length-1;t>=0;t--)this.powerups.all[t].remove?this.powerups.all.splice(t,1):this.powerups.all[t].collide(e)}drawLines(e,t,s){for(const i in e)e[i].remove?e.splice(i,1):(s.moveTo((e[i].p1.x-this.x)*t,(e[i].p1.y-this.y)*t),s.lineTo((e[i].p2.x-this.x)*t,(e[i].p2.y-this.y)*t))}drawPowerups(e,t,s){for(const i in e)e[i].remove?e.splice(i,1):e[i].draw((e[i].x-this.x)*t+this.powerupCanvasOffset*t/2,(e[i].y-this.y)*t+this.powerupCanvasOffset*t/2,t,s)}drawBackground(e,t,s){e.beginPath(),e.rect(0,0,this.drawSectorSize*t|0,this.drawSectorSize*t|0),e.fillStyle=s,e.fill()}clear(){this.drawn=!1,this.powerupCanvasDrawn=!1,this.canvas&&(this.canvas=null,this.ctx=null,this.canvasPool.releaseCanvas(this.canvas)),this.powerupCanvas&&(this.canvasPool.releaseCanvas(this.powerupCanvas),this.powerupCanvas=null)}close(){this.track=null,this.scene=null,this.settings=null,this.drawSectorSize=null,this.row=null,this.column=null,this.camera=null,this.zoom=null,this.canvasPool=null,this.x=null,this.y=null,this.realX=null,this.realY=null,this.lineCount=null,this.drawn=null,this.physicsLines=null,this.sceneryLines=null,this.canvas=null,this.ctx=null}}(n,h,this);o[n][h]=e,l=e}switch(i){case 1:o[n][h].addLine(s),s.addSectorReference(o[n][h]);break;case 2:o[n][h].addPowerup(s),s.addSectorReference(o[n][h])}return this.dirty=!0,l}cleanTrack(){this.cleanLines(),this.cleanPowerups()}cleanLines(){for(var e=this.physicsLines,t=this.sceneryLines,s=e.length,i=t.length,a=s-1;a>=0;a--)e[a].remove&&e.splice(a,1);for(var o=i-1;o>=0;o--)t[o].remove&&t.splice(o,1)}cleanPowerups(){for(const e in this.powerups)this.powerups[e].remove&&this.powerups.splice(e,1);for(const e in this.targets)this.targets[e].remove&&this.targets.splice(e,1);this.targetCount=this.targets.length}updatePowerupState(e){this.resetPowerups(),this.setPowerupStates(e._powerupsConsumed.targets),this.setPowerupStates(e._powerupsConsumed.checkpoints),this.setPowerupStates(e._powerupsConsumed.misc)}setPowerupStates(e){for(const t of e)this.powerupsLookupTable[t].remove&&this.powerupsLookupTable[t].id&&(delete this.powerupsLookupTable[t],delete e[t]),this.powerupsLookupTable[t].hit=!0,this.powerupsLookupTable[t].sector.powerupCanvasDrawn=!1}select(e,t){const s=[];if(e.y<t.y)for(const i of[...this.physicsLines,...this.sceneryLines,...this.powerups].filter((e=>!e.remove)))i.p1||i.p2?(i.p1.x>e.x&&i.p1.y>e.y||i.p2.x>e.x&&i.p2.y>e.y)&&(i.p1.x<t.x&&i.p1.y<t.y||i.p2.x<t.x&&i.p2.y<t.y)&&s.push(i):i.x>e.x&&i.y>e.y&&i.x<t.x&&i.y<t.y&&s.push(i);else for(const i of[...this.physicsLines,...this.sceneryLines,...this.powerups].filter((e=>!e.remove)))i.p1||i.p2?(i.p1.x<=e.x&&i.p1.y<=e.y||i.p2.x<=e.x&&i.p2.y<=e.y&&i.p1.x>=t.x&&i.p1.y>=t.y||i.p2.x>=t.x&&i.p2.y>=t.y)&&s.push(i):i.x<e.x&&i.y<e.y&&i.x>t.x&&i.y>t.y&&s.push(i);return s}getCode(){this.cleanTrack();var e=this.powerups,t=this.physicsLines,s=this.sceneryLines,i="",a=t.length,o=s.length,r=e.length;if(a>0){for(var n in t)(l=t[n]).recorded||(i+=l.p1.x.toString(32)+" "+l.p1.y.toString(32)+l.getCode(this)+",");for(var n in i=i.slice(0,-1),t)t[n].recorded=!1}if(i+="#",o>0){for(var h in s){var l;(l=s[h]).recorded||(i+=l.p1.x.toString(32)+" "+l.p1.y.toString(32)+l.getCode(this)+",")}for(var h in i=i.slice(0,-1),s)s[h].recorded=!1}if(i+="#",r>0){for(var c in e){var d=e[c].getCode();d&&(i+=d+",")}i=i.slice(0,-1)}return i}resetPowerups(){for(const e of this.powerups)e.hit&&!e.remove&&(e.hit=!1,e.sector.powerupCanvasDrawn=!1)}addDefaultLine(){this.addPhysicsLine(this.defaultLine.p1.x,this.defaultLine.p1.y,this.defaultLine.p2.x,this.defaultLine.p2.y)}erase(e,t,s){let i=[];this.dirty=!0;for(var a=Math.floor(Math.min(e.x-t,e.x+t)/this.settings.drawSectorSize);Math.floor(Math.max(e.x-t,e.x+t)/this.settings.drawSectorSize)>=a;a++)for(var o=Math.floor(Math.min(e.y-t,e.y+t)/this.settings.drawSectorSize);Math.floor(Math.max(e.y-t,e.y+t)/this.settings.drawSectorSize)>=o;o++)this.sectors.drawSectors[a]&&this.sectors.drawSectors[a][o]&&i.push(this.sectors.drawSectors[a][o].erase(e,t,s));return i.flatMap((e=>e))}drawAndCache(){for(var e=performance.now(),t=this.totalSectors,s=t.length,i=0;s>i;i++)!function(e){setTimeout((function(){e.draw(),e.cacheAsImage()}),250*i)}(t[i]);let a=performance.now();console.log("Track :: Time to draw entire track : "+(a-e)+"ms")}undraw(){for(const e of this.totalSectors)e.drawn&&e.clear(!0);this.recachePowerups(Math.max(this.camera.zoom,1)),this.canvasPool.update()}collide(e){let t=Math.floor(e.pos.x/this.settings.physicsSectorSize-.5),s=Math.floor(e.pos.y/this.settings.physicsSectorSize-.5);this.sectors.physicsSectors[t]&&this.sectors.physicsSectors[t][s]&&this.sectors.physicsSectors[t][s].resetCollided(),this.sectors.physicsSectors[t+1]&&this.sectors.physicsSectors[t+1][s]&&this.sectors.physicsSectors[t+1][s].resetCollided(),this.sectors.physicsSectors[t+1]&&this.sectors.physicsSectors[t+1][s+1]&&this.sectors.physicsSectors[t+1][s+1].resetCollided(),this.sectors.physicsSectors[t]&&this.sectors.physicsSectors[t][s+1]&&this.sectors.physicsSectors[t][s+1].resetCollided(),this.sectors.physicsSectors[t]&&this.sectors.physicsSectors[t][s]&&this.sectors.physicsSectors[t][s].collide(e),this.sectors.physicsSectors[t+1]&&this.sectors.physicsSectors[t+1][s]&&this.sectors.physicsSectors[t+1][s].collide(e),this.sectors.physicsSectors[t+1]&&this.sectors.physicsSectors[t+1][s+1]&&this.sectors.physicsSectors[t+1][s+1].collide(e),this.sectors.physicsSectors[t]&&this.sectors.physicsSectors[t][s+1]&&this.sectors.physicsSectors[t][s+1].collide(e)}getDrawSector(e,t){let s=Math.floor(e/this.settings.drawSectorSize),i=Math.floor(t/this.settings.drawSectorSize),a=!1;return void 0!==this.sectors.drawSectors[s]&&void 0!==this.sectors.drawSectors[s][i]&&(a=this.sectors.drawSectors[s][i]),a}draw(e){let t=this.scene.camera.position.x*this.scene.camera.zoom/(this.settings.drawSectorSize*this.scene.camera.zoom)-this.scene.screen.width/(this.settings.drawSectorSize*this.scene.camera.zoom)/2-1,s=this.scene.camera.position.y*this.scene.camera.zoom/(this.settings.drawSectorSize*this.scene.camera.zoom)-this.scene.screen.height/(this.settings.drawSectorSize*this.scene.camera.zoom)/2-1,i=this.scene.camera.position.x*this.scene.camera.zoom/(this.settings.drawSectorSize*this.scene.camera.zoom)+this.scene.screen.width/(this.settings.drawSectorSize*this.scene.camera.zoom)/2,a=this.scene.camera.position.y*this.scene.camera.zoom/(this.settings.drawSectorSize*this.scene.camera.zoom)+this.scene.screen.height/(this.settings.drawSectorSize*this.scene.camera.zoom)/2;e.imageSmoothingEnabled=!1;for(const o of this.totalSectors)if(o.dirty&&o.cleanSector(),o.column>=t&&i>=o.column&&o.row>=s&&a>=o.row){!1===o.drawn&&o.draw(),o.hasPowerups&&(o.powerupCanvasDrawn||o.cachePowerupSector());let t=o.column*(this.settings.drawSectorSize*this.scene.camera.zoom)-(this.scene.camera.position.x*this.scene.camera.zoom/(this.settings.drawSectorSize*this.scene.camera.zoom)*(this.settings.drawSectorSize*this.scene.camera.zoom)-this.scene.screen.center.x)|0,s=o.row*(this.settings.drawSectorSize*this.scene.camera.zoom)-(this.scene.camera.position.y*this.scene.camera.zoom/(this.settings.drawSectorSize*this.scene.camera.zoom)*(this.settings.drawSectorSize*this.scene.camera.zoom)-this.scene.screen.center.y)|0;e.drawImage(o.canvas,t,s,this.settings.drawSectorSize*this.scene.camera.zoom,this.settings.drawSectorSize*this.scene.camera.zoom),o.hasPowerups&&o.powerupCanvasDrawn&&e.drawImage(o.powerupCanvas,t-o.powerupCanvasOffset*this.scene.camera.zoom/2,s-o.powerupCanvasOffset*this.scene.camera.zoom/2,this.settings.drawSectorSize*this.scene.camera.zoom+o.powerupCanvasOffset*this.scene.camera.zoom,this.settings.drawSectorSize*this.scene.camera.zoom+o.powerupCanvasOffset*this.scene.camera.zoom)}else o.drawn&&o.clear()}closeSectors(){for(const e of this.totalSectors)e.close()}close(){this.scene=null,this.closeSectors(),this.totalSectors=null,this.canvasPool=null,this.sectors=null,this.physicsLines=null,this.sceneryLines=null,this.powerups=null,this.camera=null}};function b(e){e=parseInt(e,10);let t=Math.floor(e/6e4),s=(e-6e4*t)/1e3;return s=s.toFixed(2),10>s&&(s="0"+s),t+":"+s}const k=class{constructor(){this._events=this._events||{},this._maxListeners=this._maxListeners||void 0,this._events=void 0,this._maxListeners=void 0,this.defaultMaxListeners=10}setMaxListeners(e){if("number"!=typeof e||0>e||isNaN(e))throw TypeError("n must be a positive number");return this._maxListeners=e,this}emit(e){var t,s,i,a,o,r;if(this._events||(this._events={}),"error"===e&&(!this._events.error||"object"==typeof this._events.error&&null!==this._events.error&&!this._events.error.length)){if((t=arguments[1])instanceof Error)throw t;throw TypeError('Uncaught, unspecified "error" event.')}if(void 0===(s=this._events[e]))return!1;if("function"==typeof s)switch(arguments.length){case 1:s.call(this);break;case 2:s.call(this,arguments[1]);break;case 3:s.call(this,arguments[1],arguments[2]);break;default:for(i=arguments.length,a=new Array(i-1),o=1;i>o;o++)a[o-1]=arguments[o];s.apply(this,a)}else if("object"==typeof s&&null!==s){for(i=arguments.length,a=new Array(i-1),o=1;i>o;o++)a[o-1]=arguments[o];for(i=(r=s.slice()).length,o=0;i>o;o++)r[o].apply(this,a)}return!0}addListener(e,t){var s;if("function"!=typeof t)throw TypeError("listener must be a function");return this._events||(this._events={}),this._events.newListener&&this.emit("newListener",e,"function"==typeof t.listener?t.listener:t),this._events[e]?"object"==typeof this._events[e]&&null!==this._events[e]?this._events[e].push(t):this._events[e]=[this._events[e],t]:this._events[e]=t,"object"!=this._events[e]||null===this._events[e]||this._events[e].warned||(s=void 0===this._maxListeners?i.defaultMaxListeners:this._maxListeners)&&s>0&&this._events[e].length>s&&(this._events[e].warned=!0,console.error("(node) warning: possible EventEmitter memory leak detected. %d listeners added. Use emitter.setMaxListeners() to increase limit.",this._events[e].length),"function"==typeof console.trace&&console.trace()),this}on=this.addListener;once(e,t){function s(){this.removeListener(e,s),i||(i=!0,t.apply(this,arguments))}if("function"!=typeof t)throw TypeError("listener must be a function");var i=!1;return s.listener=t,this.on(e,s),this}removeListener(e,t){var s,i,a,o;if("function"!=typeof t)throw TypeError("listener must be a function");if(!this._events||!this._events[e])return this;if(a=(s=this._events[e]).length,i=-1,s===t||"function"==typeof s.listener&&s.listener===t)delete this._events[e],this._events.removeListener&&this.emit("removeListener",e,t);else if("object"==typeof s&&null!==s){for(o=a;o-- >0;)if(s[o]===t||s[o].listener&&s[o].listener===t){i=o;break}if(0>i)return this;1===s.length?(s.length=0,delete this._events[e]):s.splice(i,1),this._events.removeListener&&this.emit("removeListener",e,t)}return this}removeAllListeners(e){var t,s;if(!this._events)return this;if(!this._events.removeListener)return 0===arguments.length?this._events={}:this._events[e]&&delete this._events[e],this;if(0===arguments.length){for(t in this._events)"removeListener"!==t&&this.removeAllListeners(t);return this.removeAllListeners("removeListener"),this._events={},this}if("function"==typeof(s=this._events[e]))this.removeListener(e,s);else for(;s.length;)this.removeListener(e,s[s.length-1]);return delete this._events[e],this}listeners(e){return this._events&&this._events[e]?"function"==typeof this._events[e]?[this._events[e]]:this._events[e].slice():[]}listenerCount(e,t){return e._events&&e._events[t]?"function"==typeof e._events[t]?1:e._events[t].length:0}},S=class extends k{scene=null;touch=null;touches=[];wheel=!1;mousewheel=!1;mouseMoveListener=null;mouseUpListener=null;mouseDownListener=null;throttledMouseWheel=null;analytics=null;constructor(e){super(),this.scene=e,this.enabled=!0,this.touch=this.getTouchObject(),this.touch.old=this.getTouchObject(),this.secondaryTouch=this.getTouchObject(),this.secondaryTouch.old=this.getTouchObject(),this.initAnalytics(),this.bindToMouseEvents(),this.updateCallback=!1}contextMenuHandler(e){return e.stopPropagation(),e.preventDefault(),!1}initAnalytics(){this.analytics={clicks:0}}getTouchObject(){return{id:null,down:!1,press:!1,release:!1,pos:new s(0,0),real:new s(0,0),type:1}}bindToMouseEvents(){let e=this.scene.game.canvas,t=this.onMouseMove.bind(this),s=this.onMouseDown.bind(this),i=this.onMouseUp.bind(this);e.addEventListener("pointermove",t),e.addEventListener("pointerdown",s),e.addEventListener("pointerup",i),this.mouseMoveListener=t,this.mouseDownListener=s,this.mouseUpListener=i;let a=this.onMouseWheel.bind(this);e.addEventListener("mousewheel",a),e.addEventListener("wheel",a),e.addEventListener("DOMMouseScroll",a),this.mouseWheelListener=a}onMouseDown(e){this.scene.game.canvas.setPointerCapture(e.pointerId),this.analytics.clicks++,2===e.button?!1===this.secondaryTouch.down&&(this.updatePosition(e,this.secondaryTouch),this.secondaryTouch.down=!0):!1===this.touch.down&&(this.updatePosition(e,this.touch),this.scene.interactWithControls(),this.touch.down=!0)}disableContextMenu(){this.scene.game.canvas.oncontextmenu=function(){return!1}}onMouseUp(e){this.scene.game.canvas.releasePointerCapture(e.pointerId),2===e.button?!0===this.secondaryTouch.down&&(this.updatePosition(e,this.secondaryTouch),this.secondaryTouch.down=!1):!0===this.touch.down&&(this.updatePosition(e,this.touch),this.touch.down=!1)}updatePosition(e,t){t.id=e.pointerId,t.type=e.button;let s=t.pos;s.x=e.offsetX*window.devicePixelRatio,s.y=e.offsetY*window.devicePixelRatio,this.updateRealPosition(t)}updateRealPosition(e){let t=e.real;if(t.x=Math.round((e.pos.x-this.scene.screen.center.x)/this.scene.camera.zoom+this.scene.camera.position.x),t.y=Math.round((e.pos.y-this.scene.screen.center.y)/this.scene.camera.zoom+this.scene.camera.position.y),this.scene.toolHandler.options.grid){let s=0|this.scene.settings.toolHandler.gridSize;if(lite.storage.get("isometricGrid")){function i(e,t){return(e%t+t)%t}let a=s/2,o=Math.round(t.x/s);t.x=o*s,t.y=t.y-i(t.y+a*(i(o,2)+1),s)-a*(i(o,2)-1)+i(o,2)*a}else t.x=Math.round(t.x/s)*s,t.y=Math.round(t.y/s)*s}this.updateCallback=!0}onMouseWheel(e){(e=window.event||e).preventDefault(),e.stopPropagation();let t=Math.max(-1,Math.min(1,-e.deltaY||-e.detail));return 0==t&&(t=Math.max(-1,Math.min(1,e.deltaX||-e.detail))),this.wheel=t,!1}onMouseMove(e){this.updatePosition(e,this.touch),this.updatePosition(e,this.secondaryTouch)}update(){this.enabled&&(this.updateTouch(this.touch),this.updateTouch(this.secondaryTouch),this.updateWheel())}updateTouch(e){e.old.pos.x=e.pos.x,e.old.pos.y=e.pos.y,e.old.real.x=e.real.x,e.old.real.y=e.real.y,!e.old.down&&e.down&&(e.press=!0),e.old.down&&!e.down&&(e.release=!0),e.old.press&&(e.press=!1),e.old.release&&(e.release=!1),this.updateRealPosition(e),e.old.down=e.down,e.old.press=e.press,e.old.release=e.release}updateWheel(){this.mousewheel=this.wheel,this.wheel=!1}close(){let e=this.scene.game.canvas;e.removeEventListener("mousewheel",this.mouseWheelListener),e.removeEventListener("DOMMouseScroll",this.mouseWheelListener),this.touches=null,this.touch=null,this.scene=null,this.wheel=null,this.mouseMoveListener=null,this.mouseDownListener=null,this.mouseUpListener=null}},P=class{pos=null;old=null;vel=null;parent=null;radius=0;friction=0;collide=!1;contact=!1;scene=null;drawPos=null;constructor(e,t){this.pos=new s,this.old=new s,this.vel=new s(0,0),this.drawPos=new s(0,0),this.radius=10,this.friction=0,this.parent=t,this.collide=!0,this.contact=!1,this.scene=t.scene,this.pos.equ(e),this.old.equ(e),this.drawPos=this.pos}drive(e,t){let s=this.friction,i=-(e*this.vel.x+t*this.vel.y)*s;e*=i,t*=i,this.pos.x+=e,this.pos.y+=t,this.contact=!0}fixedUpdate(){let e=this.vel;e.inc(this.parent.gravity);let t=this.parent.gravity;(0!=t.x||0!=t.y)&&(e.x=.99*e.x,e.y=.99*e.y),this.pos.inc(this.vel),this.contact=!1,this.collide&&this.scene.track.collide(this),e.x=this.pos.x-this.old.x,e.y=this.pos.y-this.old.y,this.old.equ(this.pos),this.drawPos=this.pos}update(e){this.drawPos=this.pos.add(this.vel.factor(e))}draw(e){let t=this.pos.toScreen(this.scene),s=this.scene.camera.zoom;e.beginPath(),e.fillStyle="rgba(0,0,0,1)",e.arc(t.x,t.y,this.radius*s,0,2*Math.PI,!1),e.fill(),e.closePath()}},C=class extends P{constructor(e,t,i){super(new s(e,t),i),this.radius=10,this.collide=!0,this.wind=!0}drive(e,t){this.pos.x+=.05*e*-e*(e*this.vel.x+t*this.vel.y),this.contact=!0}fixedUpdate(){var e=this.vel,t=this.pos,s=this.old,i=this.parent.gravity,a=this.parent.gamepad,o=a.isButtonDown("up"),r=a.isButtonDown("left"),n=a.isButtonDown("right");(0!==i.x||0!==i.y)&&(e.x=.9*e.x,e.y=.99*e.y),r&&(t.x+=-.05),n&&(t.x+=.05),(0!==i.x||0!==i.y)&&(t.y+=-.1),o&&(t.y+=-.5),this.wind&&(t.x+=.3),t.x+=e.x,t.y+=e.y,this.collide&&this.scene.track.collide(this),(0!==i.x||0!==i.y)&&(e.x=t.x-s.x,e.y=t.y-s.y),s.x=t.x,s.y=t.y,this.drawPos=this.pos}draw(e){var t=this.parent.scene,s=this.pos.toScreen(t),i=this.radius*t.camera.zoom;e.beginPath(),e.fillStyle="midnight"===window.lite.storage.get("theme")?"#ccc":"dark"===window.lite.storage.get("theme")?"#fbfbfb":"#000",e.arc(s.x,s.y,i,0,2*Math.PI,!1),e.closePath(),e.fill()}},_=class{m1=null;m2=null;parent=null;lrest=40;leff=40;dampConstant=0;springConstant=0;constructor(e,t,s){this.m1=e,this.m2=t,this.parent=s,this.lrest=40,this.leff=40,this.dampConstant=.5,this.springConstant=.7}swap(){var e=new s,t=this.m1,i=this.m2;e.equ(t.pos),t.pos.equ(i.pos),i.pos.equ(e),e.equ(t.old),t.old.equ(i.old),i.old.equ(e),e.equ(t.vel),t.vel.equ(i.vel),i.vel.equ(e);var a=t.angle;t.angle=i.angle,i.angle=a}fixedUpdate(){var e=new s(0,0),t=this.m1,i=this.m2,a=t.pos,o=i.pos,r=t.vel,n=i.vel;e.x=o.x-a.x,e.y=o.y-a.y;var h=e.len();if(!(1>h)){var l=1/h;e.x*=l,e.y*=l;var c=(h-this.leff)*this.springConstant,d={x:e.x*c,y:e.y*c},p=n.x-r.x,u=n.y-r.y,g=(p*e.x+u*e.y)*this.dampConstant,m=e.x*g,y=e.y*g;d.x+=m,d.y+=y,n.x+=-d.x,n.y+=-d.y,r.x+=d.x,r.y+=d.y}}rotate(e){var t=this.m1,s=this.m2,i=s.pos.x-t.pos.x,a=-(s.pos.y-t.pos.y)/this.leff,o=i/this.leff;t.pos.x+=a*e,t.pos.y+=o*e,s.pos.x+=a*-e,s.pos.y+=o*-e}contract(e,t){this.leff+=(this.lrest-e-this.leff)/t}setMasses(e,t){this.m1=e,this.m2=t}};let M=[1,.7,.8,.9,.5,1,.7,1];const z=class extends P{color="black";constructor(e,t,s){super(e,t),this.color=s,this.pos.x=e.x+5*(Math.random()-Math.random()),this.pos.y=e.y+5*(Math.random()-Math.random()),this.old.x=this.pos.x,this.old.y=this.pos.y,this.vel.y=11*(Math.random()-Math.random()),this.vel.x=11*(Math.random()-Math.random()),this.radius=2*Math.random()*5,this.angle=6.2*Math.random(),this.speed=1*Math.random()-1*Math.random(),this.friction=.05}drive(e,t){var s=this.vel,i=this.pos;this.speed=(e*s.x+t*s.y)/this.radius,this.angle+=this.speed;var a=-(e*s.x+t*s.y)*this.friction;i.x+=e*a,i.y+=t*a;var o=Math.sqrt(Math.pow(e,2)+Math.pow(t,2));if(o>0){var r=-t/o,n=e/o,h=.8*(r*s.x+n*s.y);this.old.x+=r*h,this.old.y+=n*h}}fixedUpdate(){this.angle+=this.speed,super.update()}draw(){var e=this.scene.screen,t=this.scene.camera,s=e.realToScreen(this.pos.x,"x"),i=e.realToScreen(this.pos.y,"y"),a=0,o=t.zoom,r=this.angle,n=M[0]*o*this.radius,h=s+n*Math.cos(r),l=i+n*Math.sin(r),c=this.scene.game.canvas.getContext("2d");for(c.lineWidth=1*o,c.strokeStyle="midnight"===window.lite.storage.get("theme")?"#ccc":"dark"===window.lite.storage.get("theme")?"#fbfbfb":"#000",c.beginPath(),c.moveTo(h,l),c.fillStyle=this.color;a++<8;)h=s+(n=M[a-1]*o*this.radius)*Math.cos(r+6.283*a/8),l=i+n*Math.sin(r+6.283*a/8),c.lineTo(h,l);c.fill(),c.stroke()}},B=class{complete=!1;time=0;powerupsEnabled=!1;constructor(e,t){this.time=20,this.gravity=new s(0,.3),this.scene=t,this.createMasses(e),this.positionX=e.x,this.positionY=e.y}draw(e){var t=this.time,s=this.positionX,i=this.positionY,a=this.scene.camera.zoom,o=this.scene.screen,r=this.scene.game.canvas.getContext("2d");if(r.globalAlpha=e,t>0){t-=10;var n=o.realToScreen(s,"x"),h=o.realToScreen(i,"y"),l=0,c=6.2*Math.random(),d=t*a,p=n+d*Math.cos(c),u=h+d*Math.sin(c);for(r.lineWidth=0,r.strokeStyle="midnight"===lite.storage.get("theme")?"#ccc":"dark"===lite.storage.get("theme")?"#fff":"#000",r.beginPath(),r.moveTo(p,u),r.fillStyle="midnight"===lite.storage.get("theme")?"#ccc":"dark"===lite.storage.get("theme")?"#fff":"#000";l++<16;)p=n+(d=(t+30*Math.random())*a)*Math.cos(c+6.283*l/16),u=h+d*Math.sin(c+6.283*l/16),r.lineTo(p,u);r.fill(),r.stroke()}var g=this.masses;for(var m in g)g[m].draw();r.globalAlpha=1,this.time=t}createMasses(e){this.masses=[],this.masses.push(new z(e,this,"midnight"===lite.storage.get("theme")?"#ccc":"dark"===lite.storage.get("theme")?"#fff":"#000")),this.masses.push(new z(e,this,"midnight"===lite.storage.get("theme")?"#ccc":"dark"===lite.storage.get("theme")?"#fff":"#000")),this.masses.push(new z(e,this,"midnight"===lite.storage.get("theme")?"#ccc":"dark"===lite.storage.get("theme")?"#fff":"#000")),this.masses.push(new z(e,this,"midnight"===lite.storage.get("theme")?"#ccc":"dark"===lite.storage.get("theme")?"#fff":"#000")),this.masses.push(new z(e,this,"midnight"===lite.storage.get("theme")?"#ccc":"dark"===lite.storage.get("theme")?"#fff":"#000")),this.masses.push(new z(e,this,"midnight"===lite.storage.get("theme")?"#ccc":"dark"===lite.storage.get("theme")?"#fff":"#000")),this.masses.push(new z(e,this,"midnight"===lite.storage.get("theme")?"#ccc":"dark"===lite.storage.get("theme")?"#fff":"#000"))}fixedUpdate(){for(let e of this.masses)e.fixedUpdate()}update(e,t){for(let s of this.masses)s.update(e,t)}},A=class{masses=null;springs=null;slow=!1;slowParity=0;constructor(e){this.player=e,this.scene=e._scene,this.gamepad=e._gamepad,this.settings=e._settings,this.gravity=new s(0,.3),this.complete=!1,this.alive=!0,this.crashed=!1,this.dir=1,this.ghost=!1,this.ragdoll=!1,this.explosion=!1,this.speed=0,this.powerupsEnabled=!0,this.createCosmetics()}explode(){this.scene.sound.play("bomb_sound",1),this.explosion=new B(this.masses[0].pos,this.scene),this.dead()}createCosmetics(){this.cosmetics=this.player._user.cosmetics}updateSpeed(){this.speed=Math.abs(Math.round(this.focalPoint.vel.x+this.focalPoint.vel.y))}close(){this.scene=null,this.settings=null,this.gravity=null,this.speed=null,this.cosmetics=null,this.explosion=null,this.ragdoll=null,this.ghost=null,this.crashed=null,this.alive=null,this.gamepad=null}dead(){this.stopSounds(),this.player.dead(),this.crashed=!0,this.alive=!1}moveVehicle(e,t){for(var s=this.masses,i=s.length-1;i>=0;i--)s[i].pos.x+=e,s[i].pos.y+=t,s[i].old.x+=e,s[i].old.y+=t}stopSounds(){}};let F="balloon_on";const D=class extends P{motor=0;brake=!1;angle=0;speed=0;constructor(e,t){super(e,t),this.motor=0,this.brake=!1,this.angle=0,this.speed=0,this.rotationSpeed=0}drive(e,t){var s=this.pos,i=this.motor*this.parent.dir,a=i*e,o=i*t;if(s.x+=a,s.y+=o,this.brake){var r=.3*-(e*this.vel.x+t*this.vel.y),n=e*r,h=t*r;s.x+=n,s.y+=h}this.speed=(e*this.vel.x+t*this.vel.y)/this.radius,this.rotationSpeed=this.speed,this.angle+=this.speed,this.contact=!0}fixedUpdate(){var e=this.parent.gravity,t=this.pos,s=this.old,i=this.vel;i.x+=e.x,i.y+=e.y,(0!=e.x||0!=e.y)&&(i.x=.99*i.x,i.y=.99*i.y),t.x+=i.x,t.y+=i.y,this.contact=!1,this.collide&&this.scene.track.collide(this),i.x=t.x-s.x,i.y=t.y-s.y,this.old.equ(this.pos),this.rotationSpeed=.999*this.rotationSpeed,this.drawPos=this.pos}};let L="blob_sound",O="bike_ground",I="bike_air";const R=class extends A{color="#".padEnd(7,"midnight"==lite.storage.get("theme")?"C":"dark"==lite.storage.get("theme")?"FB":"0");cosmeticHead=null;cosmeticRearWheel=null;cosmeticFrontWheel=null;pedala=0;swapped=!1;ragdoll=null;createSprings(){this.springs=[];var e=new _(this.head,this.rearWheel,this),t=new _(this.rearWheel,this.frontWheel,this),s=new _(this.frontWheel,this.head,this);this.springs.push(e),this.springs.push(t),this.springs.push(s),this.rearSpring=e,this.chasse=t,this.frontSpring=s}createRagdoll(){this.ragdoll=new class{parent=null;constructor(e,t){this.parent=t;var i,a,o,r,n,h,l,c,d,p,u=[],g=[],m=new s(0,0);for(var y in i=new P(m,t),a=new P(m,t),o=new P(m,t),r=new P(m,t),h=new P(m,t),n=new P(m,t),l=new P(m,t),c=new P(m,t),d=new P(m,t),p=new P(m,t),u.push(i),u.push(a),u.push(o),u.push(r),u.push(h),u.push(n),u.push(l),u.push(c),u.push(d),u.push(p),g.push(new _(i,a,this)),g.push(new _(i,o,this)),g.push(new _(o,h,this)),g.push(new _(i,r,this)),g.push(new _(r,n,this)),g.push(new _(a,l,this)),g.push(new _(l,d,this)),g.push(new _(a,c,this)),g.push(new _(c,p,this)),u)u[y].radius=3;for(var y in u)u[y].friction=.05;for(var y in i.radius=a.radius=8,g)g[y].springConstant=.4;for(var y in g)g[y].dampConstant=.7;for(var y in this.masses=u,this.springs=g,this.head=i,this.waist=a,this.lElbow=o,this.rElbow=r,this.rHand=n,this.lHand=h,this.lKnee=l,this.rKnee=c,this.lFoot=d,this.rFoot=p,e)this[y].pos.equ(e[y])}zero(e,t){e=e.factor(.7),t=t.factor(.7);var s=this.springs,i=this.masses;for(var a in s){var o=s[a].m2.pos.sub(s[a].m1.pos).len();s[a].lrest=o,s[a].leff=o}for(a=1;4>=a;a++)s[a].lrest=13,s[a].leff=13;for(var a in s)s[a].leff>20&&(s[a].lrest=20,s[a].leff=20);var r=[this.head,this.lElbow,this.rElbow,this.lHand,this.rHand],n=[this.waist,this.lKnee,this.rKnee,this.lFoot,this.rFoot];for(var a in r)r[a].old=r[a].pos.sub(e);for(var a in n)n[a].old=n[a].pos.sub(t);for(var a in i)i[a].vel.equ(i[a].pos.sub(i[a].old)),i[a].vel.x+=1*(Math.random()-Math.random()),i[a].vel.y+=1*(Math.random()-Math.random())}draw(e){var t=this.head,s=this.waist,i=this.lElbow,a=this.rElbow,o=this.rHand,r=this.lHand,n=this.lKnee,h=this.rKnee,l=this.lFoot,c=this.rFoot,d=this.parent.scene,p=d.camera.zoom,u=this.parent.alpha||1;e.strokeStyle="rgba("+("midnight"===window.lite.storage.get("theme")?"204,204,204,":"dark"===lite.storage.get("theme")?"255,255,255,":"rgba(0,0,0,")+.5*u+")",e.lineWidth=5*p;var g=t.drawPos.toScreen(d);e.beginPath(),e.moveTo(g.x,g.y);var m=i.drawPos.toScreen(d);e.lineTo(m.x,m.y);var y=r.drawPos.toScreen(d);e.lineTo(y.x,y.y),e.stroke(),e.strokeStyle="rgba("+("midnight"===window.lite.storage.get("theme")?"204,204,204,":"dark"===lite.storage.get("theme")?"255,255,255,":"rgba(0,0,0,")+u+")",e.beginPath(),e.moveTo(g.x,g.y);var w=a.drawPos.toScreen(d);e.lineTo(w.x,w.y);var v=o.drawPos.toScreen(d);e.lineTo(v.x,v.y),e.stroke(),e.strokeStyle="rgba("+("midnight"===window.lite.storage.get("theme")?"204,204,204,":"dark"===lite.storage.get("theme")?"255,255,255,":"rgba(0,0,0,")+u+")",e.lineWidth=8*p,e.beginPath(),e.moveTo(g.x,g.y);var f=s.drawPos.toScreen(d);e.lineTo(f.x,f.y),e.stroke(),e.lineWidth=5*p,e.beginPath(),e.moveTo(f.x,f.y);var x=n.drawPos.toScreen(d);e.lineTo(x.x,x.y);var T=l.drawPos.toScreen(d);e.lineTo(T.x,T.y);var b=n.pos.sub(s.pos).normalize(),k=(b=b.factor(4).add(l.pos)).toScreen(d);e.lineTo(k.x,k.y),e.stroke(),e.strokeStyle="rgba("+("midnight"===window.lite.storage.get("theme")?"204,204,204,":"dark"===lite.storage.get("theme")?"255,255,255,":"rgba(0,0,0,")+.5*u+")",e.lineWidth=5*p,e.beginPath(),e.moveTo(f.x,f.y);var S=h.drawPos.toScreen(d);e.lineTo(S.x,S.y);var P=h.pos.sub(s.pos).normalize();P=P.factor(4).add(c.pos);var C=c.drawPos.toScreen(d);e.lineTo(C.x,C.y);var _=P.toScreen(d);e.lineTo(_.x,_.y),e.stroke(),g.inc(g.sub(f).factor(.25));var M=GameInventoryManager.getItem(this.parent.cosmetics.head),z=this.drawHeadAngle;M.draw(e,g.x,g.y,z,p,this.dir,1)}fixedUpdate(){for(let e of this.springs)e.fixedUpdate();for(let e of this.masses)e.fixedUpdate();this.updateDrawHeadAngle()}update(e){for(let t of this.masses)t.update(e)}updateDrawHeadAngle(){var e,t;this.dir<0?(t=this.head.pos,e=this.waist.pos):(e=this.head.pos,t=this.waist.pos);var s=e.x,i=e.y,a=s-t.x,o=i-t.y;this.drawHeadAngle=-(Math.atan2(a,o)+Math.PI)}}(this.getStickMan(),this),this.ragdoll.zero(this.head.vel,this.rearWheel.vel),this.ragdoll.dir=this.dir,this.rearWheel.motor=0,this.rearWheel.brake=!1,this.frontWheel.brake=!1,this.head.collide=!1,this.updateCameraFocalPoint(),this.player.isInFocus()&&this.playBailSound(),this.dead()}playBailSound(){var e=this.scene.sound,t=Math.min(this.speed/50,1);switch(Math.floor(3*Math.random())+1){case 1:e.play("bike_fall_1",t);break;case 2:e.play("bike_fall_2",t);break;case 3:e.play("bike_fall_3",t)}}updateCameraFocalPoint(){this.focalPoint=this.ragdoll?this.ragdoll.head:this.head}getStickMan(){var e=this.dir,t=this.head,i=this.frontWheel,a=this.rearWheel,o=this.pedala,r=i.pos.sub(a.pos),n=t.pos.sub(i.pos.add(a.pos).factor(.5)),h=new s(r.y*e,-r.x*e),l={};l.head=a.pos.add(r.factor(.35)).add(n.factor(1.2)),l.lHand=l.rHand=a.pos.add(r.factor(.8)).add(h.factor(.68));var c=l.head.sub(l.lHand);c=new s(c.y*e,-c.x*e),l.lElbow=l.rElbow=l.head.add(l.lHand).factor(.5).add(c.factor(130/c.lenSqr())),l.waist=a.pos.add(r.factor(.2)).add(h.factor(.5));var d=new s(6*Math.cos(o),6*Math.sin(o));return l.lFoot=a.pos.add(r.factor(.4)).add(h.factor(.05)).add(d),c=l.waist.sub(l.lFoot),c=new s(-c.y*e,c.x*e),l.lKnee=l.waist.add(l.lFoot).factor(.5).add(c.factor(160/c.lenSqr())),l.rFoot=a.pos.add(r.factor(.4)).add(h.factor(.05)).sub(d),c=l.waist.sub(l.rFoot),c=new s(-c.y*e,c.x*e),l.rKnee=l.waist.add(l.rFoot).factor(.5).add(c.factor(160/c.lenSqr())),l}fixedUpdate(){if(this.scene.game.ups<60)return this.nativeUpdate();if(!1===this.crashed&&(this.updateSound(),this.control()),this.explosion)this.explosion.fixedUpdate();else{if(this.slow&&(this.slowParity=1-this.slowParity),this.rearWheel.contact&&this.frontWheel.contact&&(this.slow=!1,this.slowParity=0),0===this.slowParity){for(var e=this.springs,t=e.length-1;t>=0;t--)e[t].fixedUpdate();for(var s=this.masses,i=s.length-1;i>=0;i--)s[i].fixedUpdate()}this.ragdoll?this.ragdoll.fixedUpdate():this.updateDrawHeadAngle()}this.updateCameraFocalPoint()}update(e){if(this.explosion)this.explosion.update(e);else{for(var t=this.masses,s=t.length-1;s>=0;s--)t[s].update(e);this.ragdoll&&this.ragdoll.update(e)}}nativeUpdate(){if(!1===this.crashed&&(this.updateSound(),this.control()),this.explosion)this.explosion.fixedUpdate();else{for(var e=(s=this.springs).length-1;e>=0;e--)s[e].fixedUpdate();for(var t=(i=this.masses).length-1;t>=0;t--)i[t].fixedUpdate();if(this.rearWheel.contact&&this.frontWheel.contact&&(this.slow=!1),!1===this.slow){var s,i;for(!1===this.crashed&&this.control(),e=(s=this.springs).length-1;e>=0;e--)s[e].fixedUpdate();for(t=(i=this.masses).length-1;t>=0;t--)i[t].fixedUpdate()}this.ragdoll?this.ragdoll.fixedUpdate():this.updateDrawHeadAngle()}this.updateCameraFocalPoint()}updateSound(){if(this.player.isInFocus()){this.updateSpeed();var e=Math.min(this.speed/50,1),t=this.scene.sound;this.rearWheel.contact||this.frontWheel.contact?(t.play(O,e),t.stop(I)):(t.play(I,e),t.stop(O))}}stopSounds(){var e=this.scene.sound;e.stop(I),e.stop(O)}swap(){this.dir=-1*this.dir,this.chasse.swap();var e=this.rearSpring.leff;this.rearSpring.leff=this.frontSpring.leff,this.frontSpring.leff=e}draw(e){if(this.explosion)this.explosion.draw(1);else{if(this.scene.ticks>0&&!this.player.isGhost()){if(!this.scene.state.playing){let s=window.lite.storage.get("snapshots");if(s>0){for(let t in this.player._checkpoints)t<=this.player._checkpoints.length-(parseInt(s)+1)||!this.player._checkpoints[t]||!this.player._checkpoints[t]._baseVehicle||this.drawBikeFrame.call(Object.assign({},this,JSON.parse(this.player._checkpoints[t]._baseVehicle)),e,s/300*parseInt(t)%1);for(let i in this.player._cache)i<=this.player._cache.length-(parseInt(s)+1)||!this.player._cache[i]||!this.player._cache[i]._baseVehicle||this.drawBikeFrame.call(Object.assign({},this,JSON.parse(this.player._cache[i]._baseVehicle)),e,s/300*++t%1)}}if(window.lite.storage.get("playerTrail"))for(let t in window.lite.snapshots)window.lite.snapshots[t]&&window.lite.snapshots[t]._baseVehicle&&this.drawBikeFrame.call(Object.assign({},this,JSON.parse(window.lite.snapshots[t]._baseVehicle)),e,window.lite.snapshots.length/(200*window.lite.snapshots.length)*parseInt(t)%1)}if(e.imageSmoothingEnabled=!0,e.mozImageSmoothingEnabled=!0,e.webkitImageSmoothingEnabled=!0,this.settings.developerMode)for(var t=this.masses,s=t.length-1;s>=0;s--)t[s].draw(e);this.drawBikeFrame(e)}}updateDrawHeadAngle(){var e=this.frontWheel.pos,t=this.rearWheel.pos,s=e.x,i=e.y,a=s-t.x,o=i-t.y;this.drawHeadAngle=-(Math.atan2(a,o)-Math.PI/2)}},E=class extends P{motor=0;angle=0;speed=0;constructor(e,t){super(e,t),this.motor=0,this.angle=new s(0,0),this.radius=10,this.speed=0}fixedUpdate(){var e=this.vel,t=this.angle,s=this.pos,i=this.old,a=this.motor;e.y+=0,e.inc(t.factor(2*a)),e=e.factor(.99),s.inc(e),this.contact=!1,this.collide&&this.scene.track.collide(this),this.vel=s.sub(i),i.equ(s),this.drawPos=this.pos}};let W="helicopter",V={},j={},q={};window.GameInventoryManager=new class{getItem(e){let t=e.classname,s=e.script,i=e.options,a=e.type;V[t]||("1"===a&&(t="forward_cap",i={back:"white"}),q[s]||(q[s]=!0,GameManager.loadFile(s)));let o=this.generateID(a,t,i);return j[o]||(j[o]=new V[t](i)),j[o]}redraw(){for(const e in j)j.hasOwnProperty(e)&&j[e].setDirty()}generateID(e,t,s){if(t=e+t,s)for(const e in s)s.hasOwnProperty(e)&&(t+=s[e]);return t}register(e,t){V[e]=t}clear(){}},GameInventoryManager.HeadClass=class{createVersion(){var e=this.colors,t=this.getVersions(),s="";for(var i in e)e.hasOwnProperty(i)&&(s+=e[i]);this.versionName=s,t[s]||(t[s]={dirty:!0,canvas:document.createElement("canvas")})}draw(e,t,s,i,a,o){var r=this.getCache(a),n=this.getBaseWidth(),h=this.getBaseHeight(),l=this.getScale(),c=n*a*l,d=h*a*l,p=this.getDrawOffsetX()*a-c/2,u=this.getDrawOffsetY()*a-d/2,g=-1===o;e.translate(t,s),e.rotate(i),g&&e.scale(1,-1),e.drawImage(r,p,u,c,d),g&&e.scale(1,-1),e.rotate(-i),e.translate(-t,-s)}getCache(e){var t=this.getVersions();return t[this.versionName].dirty&&this.cache(e),t[this.versionName].canvas}setDirty(){this.getVersions()[this.versionName].dirty=!0}};let G={};class H extends GameInventoryManager.HeadClass{dirty=!0;drawAngle=0;constructor(e){super(),this.colors=e,this.createVersion()}getVersions(){return G}cache(e){var t=G[this.versionName];t.dirty=!1;let s=this.getBaseWidth(),i=this.getBaseHeight(),a=this.getScale(),o=s*(e=Math.max(e,1))*a,r=i*e*a,n=t.canvas;n.width=o,n.height=r;var h=n.getContext("2d"),l=a*e,c=this.colors;h.save(),h.scale(l,l),h.translate(0,0),h.beginPath(),h.strokeStyle=lite.storage.get("dark")?"#FBFBFB":"rgba(0,0,0,0)",h.lineCap="butt",h.lineJoin="miter",h.miterLimit=4,h.save(),h.fillStyle="#ffffff",h.beginPath(),h.arc(42.4,52.5,30.3,0,6.283185307179586,!0),h.closePath(),h.fill(),h.stroke(),h.restore(),h.save(),h.fillStyle=c.back,h.beginPath(),h.moveTo(71.624,44.496),h.bezierCurveTo(68.112,31.647,56.363,22.2,42.4,22.2),h.bezierCurveTo(25.665999999999997,22.2,12.099999999999998,35.765,12.099999999999998,52.5),h.bezierCurveTo(12.099999999999998,55.771,12.623999999999999,58.916,13.582999999999998,61.867000000000004),h.lineTo(71.624,44.496),h.closePath(),h.fill(),h.stroke(),h.restore(),c.front&&(h.save(),h.beginPath(),h.moveTo(76.917,38.393),h.bezierCurveTo(71.677,25.617,59.54900000000001,16.371000000000002,45.172,15.309000000000001),h.bezierCurveTo(47.57899999999999,22.559,50.918,33.862,52.501,44.894999999999996),h.bezierCurveTo(60.643,42.731,68.775,40.566,76.917,38.393),h.closePath(),h.fillStyle=c.front,h.fill(),h.stroke(),h.restore()),h.save(),h.beginPath(),h.moveTo(42.4,22.2),h.bezierCurveTo(59.134,22.2,72.7,35.765,72.7,52.5),h.bezierCurveTo(72.7,69.235,59.135,82.8,42.4,82.8),h.bezierCurveTo(25.665,82.8,12.1,69.234,12.1,52.5),h.bezierCurveTo(12.1,35.766000000000005,25.666,22.2,42.4,22.2),h.moveTo(42.4,15.2),h.bezierCurveTo(21.833,15.2,5.100000000000001,31.932,5.100000000000001,52.5),h.bezierCurveTo(5.100000000000001,73.068,21.832,89.8,42.4,89.8),h.bezierCurveTo(62.967999999999996,89.8,79.69999999999999,73.068,79.69999999999999,52.5),h.bezierCurveTo(79.69999999999999,31.932000000000002,62.968,15.2,42.4,15.2),h.lineTo(42.4,15.2),h.closePath(),h.fill(),h.stroke(),h.restore(),h.save(),h.beginPath(),h.moveTo(16.3,66.85),h.bezierCurveTo(41.8,60.148999999999994,67.2,53.449999999999996,92.601,46.648999999999994),h.bezierCurveTo(96.201,45.648999999999994,99.8,44.748999999999995,103.5,43.748999999999995),h.bezierCurveTo(111,41.748999999999995,107.8,30.148999999999994,100.3,32.148999999999994),h.bezierCurveTo(74.901,38.94899999999999,49.400999999999996,45.748999999999995,24,52.449),h.bezierCurveTo(20.4,53.449,16.8,54.349,13.101,55.349),h.bezierCurveTo(5.7,57.35,8.9,68.85,16.3,66.85),h.lineTo(16.3,66.85),h.closePath(),h.fill(),h.stroke(),h.restore()}setDirty(){G[this.versionName].dirty=!0}getBaseWidth(){return 115}getBaseHeight(){return 112}getDrawOffsetX(){return 2.2}getDrawOffsetY(){return 1}getScale(){return.17}}GameInventoryManager&&GameInventoryManager.register("forward_cap",H);let U="truck_idle",N=0,Z={BMX:class extends R{vehicleName="BMX";constructor(e,t,s,i){super(e),this.createMasses(t,i),this.createSprings(),this.updateCameraFocalPoint(),this.stopSounds(),-1===s&&this.swap()}createMasses(e,t){this.masses=[];var i=new P(new s(e.x,e.y-36),this),a=new D(new s(e.x+21,e.y+3),this),o=new D(new s(e.x+-21,e.y+3),this);i.drive=this.createRagdoll.bind(this),o.radius=11.7,a.radius=11.7,i.radius=14,i.vel.equ(t),o.vel.equ(t),a.vel.equ(t),this.masses.push(i),this.masses.push(o),this.masses.push(a),this.head=i,this.frontWheel=a,this.rearWheel=o}createSprings(){super.createSprings(),this.chasse.lrest=42,this.chasse.leff=42,this.chasse.springConstant=.35,this.chasse.dampConstant=.3,this.rearSpring.lrest=45,this.rearSpring.leff=45,this.rearSpring.springConstant=.35,this.rearSpring.dampConstant=.3,this.frontSpring.lrest=45,this.frontSpring.leff=45,this.frontSpring.springConstant=.35,this.frontSpring.dampConstant=.3}control(){var e=this.gamepad,t=e.isButtonDown("up"),s=e.isButtonDown("down"),i=e.isButtonDown("left"),a=e.isButtonDown("right"),o=e.isButtonDown("z"),r=t?1:0,n=this.rearWheel;n.motor+=(r-n.motor)/10,o&&!this.swapped&&(this.swap(),this.swapped=!0),o||(this.swapped=!1),t&&(this.pedala+=this.rearWheel.speed/5),n.brake=s,s&&this.frontSpring.contract(-10,10),this.frontWheel.brake=!!(this.dir>0&&a&&s)||!!(this.dir<0&&i&&s);var h=i?1:0;h+=a?-1:0,this.rearSpring.contract(5*h*this.dir,5),this.frontSpring.contract(5*-h*this.dir,5),this.chasse.rotate(h/6),!h&&t&&(this.rearSpring.contract(-7,5),this.frontSpring.contract(7,5))}drawBikeFrame(e,t=this.player._opacity){var i=this.scene,a=new s(this.rearWheel.drawPos.x,this.rearWheel.drawPos.y),o=new s(this.frontWheel.drawPos.x,this.frontWheel.drawPos.y),r=new s(this.head.drawPos.x,this.head.drawPos.y),n=a.toScreen(i),h=o.toScreen(i),l=r.toScreen(i),c=h.sub(n),d=this.dir,p=new s((h.y-n.y)*d,(n.x-h.x)*d),u=this.pedala,g=i.camera.zoom;e.globalAlpha=t,e.strokeStyle=i.settings.physicsLineColor,e.lineWidth=3*g,e.beginPath(),e.fillStyle="rgba(200,200, 200, 0.2)",e.arc(h.x,h.y,10.5*g,0,2*Math.PI,!1),e.fill(),e.stroke(),e.beginPath(),e.arc(n.x,n.y,10.5*g,0,2*Math.PI,!1),e.fill(),e.stroke();var m=n.add(c.factor(.3)).add(p.factor(.25)),y=n.add(c.factor(.4)).add(p.factor(.05)),w=n.add(c.factor(.84)).add(p.factor(.42)),v=n.add(c.factor(.84)).add(p.factor(.37));e.beginPath(),e.strokeStyle=this.color,e.moveTo(n.x,n.y),e.lineTo(m.x,m.y),e.lineTo(w.x,w.y),e.moveTo(v.x,v.y),e.lineTo(y.x,y.y),e.lineTo(n.x,n.y),e.stroke(),e.beginPath(),e.strokeStyle=this.color,e.lineWidth=Math.max(1*g,.5),e.arc(y.x,y.y,3*g,0,2*Math.PI,!1),e.stroke();var f=new s(6*Math.cos(u)*g,6*Math.sin(u)*g),x=y.add(f),T=y.sub(f);e.beginPath(),e.moveTo(x.x,x.y),e.lineTo(T.x,T.y),e.stroke();var b=n.add(c.factor(.25)).add(p.factor(.4)),k=n.add(c.factor(.17)).add(p.factor(.38)),S=n.add(c.factor(.3)).add(p.factor(.45));e.beginPath(),e.strokeStyle=this.color,e.lineWidth=3*g,e.moveTo(k.x,k.y),e.lineTo(S.x,S.y),e.moveTo(y.x,y.y),e.lineTo(b.x,b.y);var P=n.add(c.factor(1)).add(p.factor(0)),C=n.add(c.factor(.97)).add(p.factor(0)),_=n.add(c.factor(.8)).add(p.factor(.48));e.moveTo(P.x,P.y),e.lineTo(C.x,C.y),e.lineTo(_.x,_.y);var M=n.add(c.factor(.86)).add(p.factor(.5)),z=n.add(c.factor(.82)).add(p.factor(.65)),B=n.add(c.factor(.78)).add(p.factor(.67));if(e.moveTo(_.x,_.y),e.lineTo(M.x,M.y),e.lineTo(z.x,z.y),e.lineTo(B.x,B.y),e.stroke(),e.strokeStyle=i.settings.physicsLineColor,this.crashed)this.ragdoll&&this.ragdoll.draw(e);else{p=l.sub(n.add(c.factor(.5)));var A=m.add(c.factor(-.1)).add(p.factor(.3)),F=x.sub(A),D=new s(F.y*d,-F.x*d);D=D.factor(g*g);var L=A.add(F.factor(.5)).add(D.factor(200/F.lenSqr())),O=x.add(F.factor(.12)).add(D.factor(50/F.lenSqr()));F=T.sub(A),D=(D=new s(F.y*d,-F.x*d)).factor(g*g);var I=A.add(F.factor(.5)).add(D.factor(200/F.lenSqr())),R=T.add(F.factor(.12)).add(D.factor(50/F.lenSqr()));e.strokeStyle="midnight"===window.lite.storage.get("theme")?"#cccccca5":"dark"===window.lite.storage.get("theme")?"#fdfdfda5":"#000000a5",e.lineWidth=6*g,e.beginPath(),e.moveTo(T.x,T.y),e.lineTo(I.x,I.y),e.lineTo(A.x,A.y),e.stroke(),e.lineWidth=4*g,e.beginPath(),e.moveTo(T.x,T.y),e.lineTo(R.x,R.y),e.stroke(),e.lineWidth=6*g,e.strokeStyle=i.settings.physicsLineColor,e.beginPath(),e.moveTo(x.x,x.y),e.lineTo(L.x,L.y),e.lineTo(A.x,A.y),e.stroke(),e.lineWidth=6*g,e.beginPath(),e.moveTo(x.x,x.y),e.lineTo(O.x,O.y),e.stroke();var E=m.add(c.factor(.05)).add(p.factor(.9));e.lineWidth=8*g,e.beginPath(),e.moveTo(A.x,A.y),e.lineTo(E.x,E.y),e.stroke();var W=m.add(c.factor(.15)).add(p.factor(1.05));c=E.sub(B),p=(p=new s(c.y*d,-c.x*d)).factor(g*g);var V=B.add(c.factor(.4)).add(p.factor(130/c.lenSqr()));e.lineWidth=5*g,e.beginPath(),e.moveTo(E.x,E.y),e.lineTo(V.x,V.y),e.lineTo(B.x,B.y),e.stroke(),GameInventoryManager.getItem(this.cosmetics.head).draw(e,W.x,W.y,this.drawHeadAngle,g,this.dir),e.globalAlpha=1}}},MTB:class extends R{vehicleName="MTB";constructor(e,t,s,i){super(e),this.createMasses(t,i),this.createSprings(),this.updateCameraFocalPoint(),this.stopSounds(),-1===s&&this.swap()}createMasses(e,t){this.masses=[];var i=new P(new s(e.x+2,e.y+-38),this),a=new D(new s(e.x+23,e.y),this),o=new D(new s(e.x+-23,e.y),this);i.drive=this.createRagdoll.bind(this),o.radius=14,a.radius=14,i.radius=14,i.vel.equ(t),o.vel.equ(t),a.vel.equ(t),this.masses.push(i),this.masses.push(o),this.masses.push(a),this.head=i,this.frontWheel=a,this.rearWheel=o}createSprings(){super.createSprings(),this.chasse.lrest=45,this.chasse.leff=45,this.chasse.springConstant=.2,this.chasse.dampConstant=.3,this.rearSpring.lrest=47,this.rearSpring.leff=47,this.rearSpring.springConstant=.2,this.rearSpring.dampConstant=.3,this.frontSpring.lrest=45,this.frontSpring.leff=45,this.frontSpring.springConstant=.2,this.frontSpring.dampConstant=.3}control(){var e=this.gamepad,t=e.isButtonDown("up"),s=e.isButtonDown("down"),i=(e.isButtonDown("back"),e.isButtonDown("left")),a=e.isButtonDown("right"),o=e.isButtonDown("z"),r=t?1:0,n=this.rearWheel;n.motor+=(r-n.motor)/10,o&&!this.swapped&&(this.swap(),this.swapped=!0),o||(this.swapped=!1),t&&(this.pedala+=this.rearWheel.speed/5),n.brake=s,this.frontWheel.brake=!!(this.dir>0&&a&&s)||!!(this.dir<0&&i&&s);var h=i?1:0;h+=a?-1:0,this.rearSpring.contract(5*h*this.dir,5),this.frontSpring.contract(5*-h*this.dir,5),this.chasse.rotate(h/8),!h&&t&&(this.rearSpring.contract(-7,5),this.frontSpring.contract(7,5))}drawBikeFrame(e,t=this.player._opacity){var i=this.scene,a=new s(this.frontWheel.drawPos.x,this.frontWheel.drawPos.y),o=new s(this.rearWheel.drawPos.x,this.rearWheel.drawPos.y),r=new s(this.head.drawPos.x,this.head.drawPos.y),n=a.toScreen(i),h=o.toScreen(i),l=r.toScreen(i),c=i.camera.zoom,d=n.sub(h),p=new s((n.y-h.y)*this.dir,(h.x-n.x)*this.dir),u=d.factor(.5);h.addOut(u,u),l.subOut(u,u),e.globalAlpha=t,e.strokeStyle=i.settings.physicsLineColor,e.lineWidth=3*c,e.beginPath(),e.fillStyle="rgba(200,200, 200,0.2)",e.arc(n.x,n.y,12.5*c,0,2*Math.PI,!1),e.fill(),e.stroke(),e.beginPath(),e.arc(h.x,h.y,12.5*c,0,2*Math.PI,!1),e.fill(),e.stroke(),e.strokeStyle="rgba(153, 153, 153,1)",e.fillStyle="rgba(204, 204, 204,1)",e.lineWidth=1,e.beginPath(),e.arc(n.x,n.y,6*c,0,2*Math.PI,!1),e.fill(),e.stroke(),e.beginPath(),e.arc(h.x,h.y,6*c,0,2*Math.PI,!1),e.fill(),e.stroke(),e.beginPath(),e.strokeStyle=this.color,e.lineWidth=5*c,e.moveTo(h.x,h.y),e.lineTo(h.x+.4*d.x+.05*p.x,h.y+.4*d.y+.05*p.y),e.moveTo(h.x+.72*d.x+.64*u.x,h.y+.72*d.y+.64*u.y),e.lineTo(h.x+.46*d.x+.4*u.x,h.y+.46*d.y+.4*u.y),e.lineTo(h.x+.4*d.x+.05*p.x,h.y+.4*d.y+.05*p.y),e.stroke(),e.beginPath(),e.lineWidth=2*c,e.moveTo(h.x+.72*d.x+.64*u.x,h.y+.72*d.y+.64*u.y),e.lineTo(h.x+.43*d.x+.05*p.x,h.y+.43*d.y+.05*p.y),e.stroke(),e.beginPath(),e.lineWidth=1*c,e.moveTo(h.x+.46*d.x+.4*u.x,h.y+.46*d.y+.4*u.y),e.lineTo(h.x+.28*d.x+.5*u.x,h.y+.28*d.y+.5*u.y),e.stroke(),e.beginPath(),e.lineWidth=2*c,e.moveTo(h.x+.45*d.x+.3*u.x,h.y+.45*d.y+.3*u.y),e.lineTo(h.x+.3*d.x+.4*u.x,h.y+.3*d.y+.4*u.y),e.lineTo(h.x+.25*d.x+.6*u.x,h.y+.25*d.y+.6*u.y),e.moveTo(h.x+.17*d.x+.6*u.x,h.y+.17*d.y+.6*u.y),e.lineTo(h.x+.3*d.x+.6*u.x,h.y+.3*d.y+.6*u.y),e.stroke(),e.beginPath(),e.lineWidth=3*c,e.moveTo(n.x,n.y),e.lineTo(h.x+.71*d.x+.73*u.x,h.y+.71*d.y+.73*u.y),e.lineTo(h.x+.73*d.x+.77*u.x,h.y+.73*d.y+.77*u.y),e.lineTo(h.x+.7*d.x+.8*u.x,h.y+.7*d.y+.8*u.y),e.stroke(),e.beginPath(),e.lineWidth=1*c;var g=new s(6*Math.cos(this.pedala)*c,6*Math.sin(this.pedala)*c);if(e.moveTo(h.x+.43*d.x+.05*p.x+g.x,h.y+.43*d.y+.05*p.y+g.y),e.lineTo(h.x+.43*d.x+.05*p.x-g.x,h.y+.43*d.y+.05*p.y-g.y),e.stroke(),e.strokeStyle="midnight"===window.lite.storage.get("theme")?"#ccc":"dark"===window.lite.storage.get("theme")?"#fbfbfb":"#000",this.crashed)this.ragdoll&&this.ragdoll.draw&&this.ragdoll.draw(e);else{d.factorOut(.5,p),h.addOut(p,p),l.subOut(p,p);var m=d.factor(.3);m.x=h.x+m.x+.25*p.x,m.y=h.y+m.y+.25*p.y;var y=d.factor(.4);y.x=h.x+y.x+.05*p.x,y.y=h.y+y.y+.05*p.y;var w=y.add(g),v=y.sub(g),f=d.factor(.67);f.x=h.x+f.x+.8*p.x,f.y=h.y+f.y+.8*p.y;var x=d.factor(-.05);x.x=m.x+x.x+.42*p.x,x.y=m.y+x.y+.42*p.y;var T=w.sub(x),b=T.lenSqr();u.x=T.y*this.dir,u.y=-T.x*this.dir,u.factorSelf(c**2);var k=T.factor(.5);k.x=x.x+k.x+u.x*(200/T.lenSqr()),k.y=x.y+k.y+u.y*(200/T.lenSqr());var S=T.factor(.12);S.x=w.x+S.x+u.x*(50/b),S.y=w.y+S.y+u.y*(50/b),v.subOut(x,T),b=T.lenSqr(),u.x=T.y*this.dir,u.y=-T.x*this.dir,u.factorSelf(c*c);var P=T.factor(.5);P.x=x.x+P.x+u.x*(200/b),P.y=x.y+P.y+u.y*(200/b);var C=T.factor(.12);C.x=v.x+C.x+u.x*(50/b),C.y=v.y+C.y+u.y*(50/b),e.strokeStyle="midnight"===window.lite.storage.get("theme")?"#cccccca5":"dark"===window.lite.storage.get("theme")?"#fdfdfda5":"rgba(0,0,0,"+.5*t+")",e.lineWidth=6*c,e.beginPath(),e.moveTo(v.x,v.y),e.lineTo(P.x,P.y),e.lineTo(x.x,x.y),e.stroke(),e.lineWidth=4*c,e.beginPath(),e.moveTo(v.x,v.y),e.lineTo(C.x,C.y),e.stroke(),e.lineWidth=6*c,e.strokeStyle="midnight"===window.lite.storage.get("theme")?"#ccc":"dark"===window.lite.storage.get("theme")?"#fbfbfb":"#000000",e.beginPath(),e.moveTo(w.x,w.y),e.lineTo(k.x,k.y),e.lineTo(x.x,x.y),e.stroke(),e.lineWidth=4*c,e.beginPath(),e.moveTo(w.x,w.y),e.lineTo(S.x,S.y),e.stroke();var _=d.factor(.1);_.x=m.x+_.x+.95*p.x,_.y=m.y+_.y+.95*p.y,e.lineWidth=8*c,e.beginPath(),e.moveTo(x.x,x.y),e.lineTo(_.x,_.y),e.stroke();var M=d.factor(.2);M.x=m.x+M.x+1.09*p.x,M.y=m.y+M.y+1.09*p.y,e.beginPath(),e.lineWidth=2*c,_.subOut(f,d);var z=d.lenSqr();p.x=d.y*this.dir,p.y=-d.x*this.dir,p.factorSelf(c*c);var B=d.factor(.3);B.x=f.x+B.x+p.x*(80/z),B.y=f.y+B.y+p.y*(80/z),e.lineWidth=5*c,e.beginPath(),e.moveTo(_.x,_.y),e.lineTo(B.x,B.y),e.lineTo(f.x,f.y),e.stroke(),GameInventoryManager.getItem(this.cosmetics.head).draw(e,M.x,M.y,this.drawHeadAngle,c,this.dir),e.globalAlpha=1}}},HELI:class extends A{swapped=!1;vehicleName="Helicopter";constructor(e,t,s){super(e),this.createMasses(t),this.createSprings(),this.createCockpit(),this.updateCameraFocalPoint(),this.stopSounds(),-1===s&&this.swap()}createCockpit(){var e=document.createElement("canvas");this.canvasCockpit=e}drawCockpit(){var e=this.canvasCockpit,t=this.masses,s=this.scene.camera.zoom,i=t[0].radius*s*.9,a=50*s,o=50*s;e.width=a,e.height=o;var r=Math.max(2*s,1),n=e.getContext("2d");n.save(),n.translate(a/2,o/2),n.scale(1.3,1),n.beginPath(),n.arc(0,0,i,0,1.5*Math.PI,!1),n.lineTo(0,0),n.lineTo(0+i,0),n.closePath(),n.restore(),n.fillStyle="midnight"===window.lite.storage.get("theme")?"#ccc":"dark"===window.lite.storage.get("theme")?"#fff":"#000",n.fill(),n.lineWidth=r,n.strokeStyle="midnight"===window.lite.storage.get("theme")?"#ccc":"dark"===window.lite.storage.get("theme")?"#fff":"#000",n.stroke(),n.save(),n.translate(a/2,o/2),n.scale(1.3,1),n.beginPath(),n.arc(0,0,i,0,1.5*Math.PI,!0),n.restore(),n.lineWidth=r,n.strokeStyle="midnight"===window.lite.storage.get("theme")?"#ccc":"dark"===window.lite.storage.get("theme")?"#fff":"#000",n.stroke()}createMasses(e){var t=[];t.push(new E(new s(e.x+0,e.y+18),this));var i=new P(new s(e.x+-17,e.y+42),this),a=new P(new s(e.x+17,e.y+42),this),o=new P(new s(e.x+-40,e.y+15),this),r=new P(new s(e.x+40,e.y+15),this);t.push(i),t.push(a),t.push(o),t.push(r),t[0].radius=18,t[1].radius=8,t[2].radius=8,t[3].grav=!1,t[4].grav=t[4].collide=!1,t[1].friction=.2,t[2].friction=.2,this.head=t[0],this.mass2=t[1],this.mass3=t[2],this.mass4=t[3],this.rotor=0,this.rotor2=0,this.dir=1;var n=this;t[3].drive=this.head.drive=function(){n.explode()},this.focalPoint=t[0],this.masses=t}createSprings(){var e=this.masses,t=[];for(var s in t.push(new _(e[0],e[1],this)),t.push(new _(e[2],e[0],this)),t.push(new _(e[2],e[1],this)),t.push(new _(e[0],e[3],this)),t.push(new _(e[1],e[3],this)),t.push(new _(e[0],e[4],this)),t.push(new _(e[2],e[4],this)),this.spring1=t[0],this.spring2=t[1],this.spring3=t[2],this.spring4=t[3],this.spring5=t[4],this.spring6=t[5],this.spring7=t[6],t[0].leff=t[4].lrest=30,t[1].leff=t[4].lrest=30,t[2].leff=t[4].lrest=35,t[4].leff=t[4].lrest=35,t[6].leff=t[4].lrest=35,t)t[s].dampConstant=.4;for(var s in t)t[s].springConstant=.5;this.springs=t}updateCameraFocalPoint(){}fixedUpdate(){if(!1===this.crashed&&(this.updateSound(),this.control()),this.explosion)this.explosion.fixedUpdate();else{for(var e=this.springs,t=e.length,s=t-1;s>=0;s--)e[s].fixedUpdate();for(var i=this.masses,a=i.length,o=a-1;o>=0;o--)i[o].fixedUpdate();if((this.masses[1].contact||this.masses[2].contact)&&(this.slow=!1),!1===this.slow){for(!1===this.crashed&&this.control(),s=t-1;s>=0;s--)e[s].fixedUpdate();for(o=a-1;o>=0;o--)i[o].fixedUpdate()}this.updateCockpitAngle()}}update(e){for(var t=this.masses,s=t.length-1;s>=0;s--)t[s].update(e)}updateSound(){if(this.player.isInFocus()){var e=this.scene.sound,t=Math.min(this.head.motor,1);e.play(W,t)}}stopSounds(){this.scene.sound.stop(W)}swap(){var e=this.dir,t=this.springs,i=this.masses;e*=-1,t[2].swap();var a=new s(0,0),o=new s(0,0),r=new s(0,0);a.equ(i[3].pos),o.equ(i[3].old),r.equ(i[3].vel),i[3].pos.equ(i[4].pos),i[3].old.equ(i[4].old),i[3].vel.equ(i[4].vel),i[4].pos.equ(a),i[4].old.equ(o),i[4].vel.equ(r),this.dir=e}control(){var e=this.player.getGamepad(),t=e.isButtonDown("up"),s=e.isButtonDown("back"),i=e.isButtonDown("left"),a=e.isButtonDown("right"),o=e.isButtonDown("z"),r=this.masses,n=this.springs;o&&!this.swapped&&(this.swap(),this.swapped=!0),o||(this.swapped=!1);var h=r[1].pos.add(r[2].pos).factor(.5);h=(h=r[0].pos.sub(h)).factor(1/h.len()),r[0].angle.equ(h);var l=t?1:0;r[0].motor+=(l-r[0].motor)/10;var c=i?1:0;c+=a?-1:0,n[2].rotate(c/6),s&&(this.scene.restartTrack=!0)}updateCockpitAngle(){var e=this.masses,t=e[0].pos,s=e[3].pos,i=t.x,a=t.y,o=i-s.x,r=a-s.y;this.cockpitAngle=-(Math.atan2(o,r)-Math.PI/2)}draw(t){if(this.explosion)this.explosion.draw(1);else{if(t.imageSmoothingEnabled=!0,t.webkitImageSmoothingEnabled=!0,t.mozImageSmoothingEnabled=!0,this.scene.ticks>0&&!this.player.isGhost()){if(!this.scene.state.playing){let s=window.lite.storage.get("snapshots");if(s>0){for(let e in this.player._checkpoints)e<=this.player._checkpoints.length-(parseInt(s)+1)||!this.player._checkpoints[e]||!this.player._checkpoints[e]._tempVehicle||this.drawHelicopter.call(Object.assign({},this,JSON.parse(this.player._checkpoints[e]._tempVehicle),{canvasCockpit:document.createElement("canvas"),drawCockpit:this.drawCockpit}),t,s/300*parseInt(e)%1);for(let i in this.player._cache)i<=this.player._cache.length-(parseInt(s)+1)||!this.player._cache[i]||!this.player._cache[i]._tempVehicle||this.drawHelicopter.call(Object.assign({},this,JSON.parse(this.player._cache[i]._tempVehicle),{canvasCockpit:document.createElement("canvas"),drawCockpit:this.drawCockpit}),t,s/300*++e%1)}}if(window.lite.storage.get("playerTrail"))for(let e in window.lite.snapshots)window.lite.snapshots[e]&&window.lite.snapshots[e]._tempVehicle&&this.drawHelicopter.call(Object.assign({},this,JSON.parse(window.lite.snapshots[e]._tempVehicle),{canvasCockpit:document.createElement("canvas"),drawCockpit:this.drawCockpit}),t,window.lite.snapshots.length/(200*window.lite.snapshots.length)*parseInt(e)%1)}this.drawHelicopter(t)}}drawHelicopter(e,t=this.player._opacity){e.globalAlpha=t;var i=this.dir,a=this.rotor,o=this.rotor2,r=this.scene,n=r.camera.zoom,h=new s(this.head.pos.x,this.head.pos.y),l=new s(this.mass2.pos.x,this.mass2.pos.y).add(this.mass3.pos).factor(.5),c=h.sub(l).factor(n),d=new s(-c.y*i,c.x*i),p=h.toScreen(r);(a+=.5*this.head.motor+.05)>6.2831&&(a-=6.2831),(o+=.5)>6.2831&&(o-=6.2831),this.rotor=a,this.rotor2=o,e.strokeStyle="midnight"==lite.storage.get("theme")?"#ccc":"dark"==lite.storage.get("theme")?"#fff":"#000",e.lineWidth=5*n,e.beginPath(),e.moveTo(p.x+.5*c.x,p.y+.5*c.y),e.lineTo(p.x+.8*c.x,p.y+.8*c.y),e.stroke(),e.lineWidth=3*n,e.beginPath();var u=.9*Math.cos(a);e.moveTo(p.x+.9*c.x+d.x*u,p.y+.8*c.y+d.y*u),e.lineTo(p.x+.9*c.x-d.x*u,p.y+.8*c.y-d.y*u),e.stroke();var g=new s(this.mass2.pos.x,this.mass2.pos.y).toScreen(r),m=new s(this.mass3.pos.x,this.mass3.pos.y).toScreen(r);e.lineWidth=4*n,e.stokeStyle="#666666",e.beginPath(),e.moveTo(g.x-.2*d.x-.1*c.x,g.y-.2*d.y-.1*c.y),e.lineTo(g.x-.25*c.x,g.y-.25*c.y),e.lineTo(m.x-.25*c.x,m.y-.25*c.y),e.lineTo(m.x+.2*d.x-.1*c.x,m.y+.2*d.y-.1*c.y),e.stroke(),e.lineWidth=3*n,e.beginPath(),e.moveTo(g.x-.2*c.x,g.y-.2*c.y),e.lineTo(p.x,p.y),e.lineTo(m.x-.2*c.x,m.y-.2*c.y),e.stroke(),e.lineWidth=6*n,e.stokeStyle="#000000",e.beginPath();var y=new s(this.mass4.pos.x,this.mass4.pos.y).toScreen(r);e.moveTo(p.x,p.y),e.lineTo(y.x,y.y),e.lineTo(p.x-.1*c.x,p.y-.3*c.y),e.stroke(),e.lineWidth=2*n,e.stokeStyle="#000000",e.beginPath();var w=7*n,v=new s(w*Math.sin(-o),w*Math.cos(-o));e.moveTo(y.x+v.x,y.y+v.y),e.lineTo(y.x-v.x,y.y-v.y),e.moveTo(y.x-v.y,y.y+v.x),e.lineTo(y.x+v.y,y.y-v.x),e.stroke(),e.beginPath(),e.lineWidth=2*n,e.arc(y.x,y.y,this.mass4.radius*n,0,2*Math.PI,!1),e.stroke(),this.drawCockpit();var f=(l=this.canvasCockpit).width,x=l.height,T=p.x+5*n*this.dir,b=p.y+2*n,k=f,S=x,P=0*n-k/2,C=0*n-S/2,_=this.cockpitAngle,M=-1===i,z=this.cosmetics,B=GameInventoryManager.getItem(z.head),A=this.cockpitAngle;B.draw(e,T+5*n*i,b-5*n,A,.7*n,i),e.translate(T,b),e.rotate(_),M&&e.scale(1,-1),e.drawImage(l,P,C,k,S),M&&e.scale(1,-1),e.rotate(-_),e.translate(-T,-b),e.globalAlpha=1}},TRUCK:class extends A{vehicleName="TRUCK";pedala=0;swapped=!1;constructor(e,t,s){super(e),this.createMasses(t),this.createSprings(),this.stopSounds(),this.updateCameraFocalPoint(),-1===s&&this.swap()}createMasses(e){this.masses=[],this.masses.push(new P(new s(e.x-15,e.y+7),this)),this.masses.push(new P(new s(e.x+15,e.y+7),this)),this.masses[0].friction=.1,this.masses[1].friction=.1,this.masses.push(new D(new s(e.x-20,e.y+35),this)),this.masses.push(new D(new s(e.x+20,e.y+35),this)),this.masses[2].radius=this.masses[3].radius=14,this.masses[0].radius=this.masses[1].radius=7,this.head=this.masses[0],this.backMass=this.masses[1],this.rearWheel=this.masses[2],this.frontWheel=this.masses[3]}createSprings(){this.springs=[];var e=this.masses;for(var t in this.springs.push(new _(e[0],e[1],this)),this.springs.push(new _(e[0],e[2],this)),this.springs.push(new _(e[1],e[3],this)),this.springs.push(new _(e[0],e[3],this)),this.springs.push(new _(e[1],e[2],this)),this.springs.push(new _(e[2],e[3],this)),this.springs[0].leff=this.springs[0].lrest=30,this.springs[1].leff=this.springs[1].lrest=30,this.springs[2].leff=this.springs[2].lrest=30,this.springs[3].leff=this.springs[3].lrest=45,this.springs[4].leff=this.springs[4].lrest=45,this.springs)this.springs[t].springConstant=.3}updateCameraFocalPoint(){}fixedUpdate(){if(!1===this.crashed&&(this.updateSound(),this.control()),this.explosion)this.explosion.fixedUpdate();else{for(var e=this.springs,t=e.length,s=t-1;s>=0;s--)e[s].fixedUpdate();for(var i=this.masses,a=i.length,o=a-1;o>=0;o--)i[o].fixedUpdate();if(this.rearWheel.contact&&this.frontWheel.contact&&(this.slow=!1),!1===this.slow){for(!1===this.crashed&&this.control(),s=t-1;s>=0;s--)e[s].fixedUpdate();for(o=a-1;o>=0;o--)i[o].fixedUpdate()}this.updateDrawHeadAngle(),this.updateCameraFocalPoint()}}update(e){for(var t=this.masses,s=t.length-1;s>=0;s--)t[s].fixedUpdate()}updateSound(){if(this.player.isInFocus()){var e=this.scene.sound;if(this.rearWheel.contact){var t=Math.min(this.rearWheel.motor,1);e.play(U,t)}else this.frontWheel.contact?(t=Math.min(this.frontWheel.motor,1),e.play(U,t)):e.stop(U)}}updateCameraFocalPoint(){this.focalPoint=1===this.dir?this.head:this.backMass}stopSounds(){this.scene.sound.stop(U)}updateDrawHeadAngle(){var e=this.frontWheel.pos,t=this.rearWheel.pos,s=e.x,i=e.y,a=s-t.x,o=i-t.y;this.drawHeadAngle=-(Math.atan2(a,o)-Math.PI/2)}swap(){this.dir=-1*this.dir,this.springs[0].swap(),this.springs[5].swap()}control(){var e=this.gamepad,t=e.isButtonDown("up"),s=e.isButtonDown("down"),i=e.isButtonDown("left"),a=e.isButtonDown("right"),o=e.isButtonDown("z");o&&!this.swapped&&(this.swap(),this.swapped=!0),o||(this.swapped=!1);var r=t?1:0,n=this.rearWheel,h=this.frontWheel;n.motor+=(.8*r-n.motor)/10,h.motor+=(.8*r-h.motor)/10,n.brake=s,h.brake=s;var l=i?1:0;l+=a?-1:0;var c=this.springs;c[0].rotate(l/8),c[5].rotate(l/8)}draw(e){if(this.explosion)this.explosion.draw(1);else{if(this.scene.ticks>0&&!this.player.isGhost()){if(!this.scene.state.playing){let e=window.lite.storage.get("snapshots");if(e>0){for(let t in this.player._checkpoints)t<=this.player._checkpoints.length-(parseInt(e)+1)||!this.player._checkpoints[t]||!this.player._checkpoints[t]._tempVehicle||(e.globalAlpha=e/300*parseInt(t)%1,this.drawTruck.call(Object.assign({},this,JSON.parse(this.player._checkpoints[t]._tempVehicle),{tire:this.tire}),e),e.globalAlpha=1);for(let t in this.player._cache)t<=this.player._cache.length-(parseInt(e)+1)||!this.player._cache[t]||!this.player._cache[t]._tempVehicle||(e.globalAlpha=e/300*parseInt(t)%1,this.drawTruck.call(Object.assign({},this,JSON.parse(this.player._cache[t]._tempVehicle),{tire:this.tire}),e),e.globalAlpha=1)}}if(window.lite.storage.get("playerTrail"))for(let t in window.lite.snapshots)window.lite.snapshots[t]&&window.lite.snapshots[t]._tempVehicle&&(e.globalAlpha=window.lite.snapshots.length/(200*window.lite.snapshots.length)*parseInt(t)%1,this.drawTruck.call(Object.assign({},this,JSON.parse(window.lite.snapshots[t]._tempVehicle),{tire:this.tire}),e),e.globalAlpha=1)}if(e.imageSmoothingEnabled=!0,e.mozImageSmoothingEnabled=!0,e.webkitImageSmoothingEnabled=!0,this.settings.developerMode)for(var t=this.masses,s=t.length-1;s>=0;s--)t[s].draw();e.globalAlpha=this.player._opacity,this.drawTruck(e),e.globalAlpha=1}}drawTruck(e){var t=this.scene,i=t.camera.zoom,a=GameInventoryManager.getItem(this.cosmetics.head),o=this.drawHeadAngle,r=this.dir,n=new s(this.frontWheel.pos.x,this.frontWheel.pos.y).toScreen(t),h=new s(this.rearWheel.pos.x,this.rearWheel.pos.y).toScreen(t),l=new s(this.head.pos.x,this.head.pos.y).toScreen(t),c=new s(this.backMass.pos.x,this.backMass.pos.y).toScreen(t),d=(this.backMass.pos.x-this.head.pos.x)*i,p=(this.backMass.pos.y-this.head.pos.y)*i,u=(.5*(this.head.pos.x+this.backMass.pos.x)-.5*(this.rearWheel.pos.x+this.frontWheel.pos.x))*i,g=(.5*(this.head.pos.y+this.backMass.pos.y)-.5*(this.rearWheel.pos.y+this.frontWheel.pos.y))*i;e.lineWidth=3*i;var m=c.x-l.x,y=c.y-l.y,w=Math.sqrt(Math.pow(m,2)+Math.pow(y,2)),v=m/w,f=y/w;a.draw(e,c.x-.5*v*i*20,c.y-f*i*20*.5,o,.45*i,r),e.strokeStyle="midnight"===window.lite.storage.get("theme")?"#aaa":"dark"===window.lite.storage.get("theme")?"#bbb":"#444",e.beginPath(),e.moveTo(l.x-.4*d-.9*u,l.y-.4*p-.9*g),e.lineTo(l.x+.8*d-.9*u,l.y+.8*p-.9*g),e.stroke(),e.closePath(),e.save(),e.fillStyle="midnight"===window.lite.storage.get("theme")?"#999":"dark"===window.lite.storage.get("theme")?"#888":"#777",e.beginPath(),e.moveTo(l.x-.4*d-.7*u,l.y-.4*p-.7*g),e.lineTo(l.x-.4*d-.7*u,l.y-.4*p-.7*g),e.lineTo(l.x+1.4*d-.7*u,l.y+1.4*p-.7*g),e.lineTo(l.x+1.35*d-.2*u,l.y+1.35*p-.2*g),e.lineTo(l.x+.9*d-.1*u,l.y+.9*p-.1*g),e.lineTo(l.x+.5*d-.1*u,l.y+.5*p-.1*g),e.lineTo(l.x+.5*d+.2*u,l.y+.5*p+.2*g),e.lineTo(l.x-.35*d+.2*u,l.y-.35*p+.2*g),e.closePath(),e.fill(),e.save(),e.lineWidth=2*i,e.strokeStyle="midnight"===window.lite.storage.get("theme")?"#aaa":"dark"===window.lite.storage.get("theme")?"#bbb":"#444",e.beginPath(),e.moveTo(l.x-.4*d-.7*u,l.y-.4*p-.7*g),e.lineTo(l.x-.35*d+.2*u,l.y-.35*p+.2*g),e.lineTo(l.x+.8*d+.2*u,l.y+.8*p+.2*g),e.lineTo(l.x+.9*d-.1*u,l.y+.9*p-.1*g),e.lineTo(l.x+1.35*d-.2*u,l.y+1.35*p-.2*g),e.lineTo(l.x+1.4*d-.7*u,l.y+1.4*p-.7*g),e.lineTo(l.x-.4*d-.7*u,l.y-.4*p-.7*g),e.closePath(),e.stroke(),e.strokeStyle="midnight"===window.lite.storage.get("theme")?"#aaa":"dark"===window.lite.storage.get("theme")?"#bbb":"#444",e.lineWidth=i,e.beginPath(),e.moveTo(l.x+.5*d-.1*u,l.y+.5*p-.1*g),e.lineTo(l.x+.9*d-.1*u,l.y+.9*p-.1*g),e.lineTo(l.x+.8*d+.2*u,l.y+.8*p+.2*g),e.lineTo(l.x+.5*d+.2*u,l.y+.5*p+.2*g),e.lineTo(l.x+.5*d-.1*u,l.y+.5*p-.1*g),e.closePath(),e.stroke(),e.beginPath(),this.tire(e,h.x,h.y,10*i,i,this.rearWheel.angle),e.closePath(),e.beginPath(),this.tire(e,n.x,n.y,10*i,i,this.frontWheel.angle),e.closePath(),e.restore()}tire(e,t,s,i,a,o){let r;for(e.beginPath(),e.arc(t,s,10*a,0,2*Math.PI,!1),e.fillStyle="#888888",e.fill(),e.lineWidth=5.9*a,e.strokeStyle="midnight"===window.lite.storage.get("theme")?"#ccc":"dark"===window.lite.storage.get("theme")?"#fbfbfb":"#000",e.closePath(),e.stroke(),e.beginPath(),e.lineWidth=2*a,e.strokeStyle="midnight"===window.lite.storage.get("theme")?"#ccc":"dark"===window.lite.storage.get("theme")?"#fbfbfb":"#000",r=0,i+=3*a;r++<8;)e.moveTo(t+i*Math.cos(o+6.283*r/8),s+i*Math.sin(o+6.283*r/8)),e.lineTo(t+i*Math.cos(o+6.283*(r+.5)/8),s+i*Math.sin(o+6.283*(r+.5)/8));for(e.stroke(),e.closePath(),e.beginPath(),e.lineWidth=2*a,e.strokeStyle="midnight"===window.lite.storage.get("theme")?"#ccc":"dark"===window.lite.storage.get("theme")?"#fbfbfb":"#000",r=0,i+=-9*a;r++<5;)e.moveTo(t+i*Math.cos(o+6.283*r/5),s+i*Math.sin(o+6.283*r/5)),e.lineTo(t+i*Math.cos(o+6.283*(r+.2)/5),s+i*Math.sin(o+6.283*(r+.2)/5));e.closePath(),e.stroke()}},BALLOON:class extends A{vehicleName="BALLOON";head=null;basket=null;constructor(e,t){super(e),this.createMasses(t),this.createSprings(),this.stopSounds(),this.focalPoint=this.head}createMasses(e){this.masses=[];var t=new C(e.x,e.y-10,this);t.radius=30;var i=new P(new s(e.x,e.y+35),this);i.friction=.1,this.masses.push(t),this.masses.push(i),this.head=this.masses[0],this.basket=this.masses[1];var a=this;this.masses[0].drive=this.head.drive=function(){a.explode()}}updateCameraFocalPoint(){}createSprings(){this.springs=[];var e=new _(this.head,this.basket,this);e.springConstant=.2,e.dampConstant=.2,e.lrest=e.leff=45,this.springs.push(e)}fixedUpdate(){if(!1===this.crashed&&this.updateSound(),this.explosion)this.explosion.fixedUpdate();else{this.head.wind=!this.basket.contact,this.slow=!1;for(var e=this.springs,t=e.length,s=t-1;s>=0;s--)e[s].fixedUpdate();for(var i=this.masses,a=i.length,o=a-1;o>=0;o--)i[o].fixedUpdate();for(s=t-1;s>=0;s--)e[s].fixedUpdate();for(o=a-1;o>=0;o--)i[o].fixedUpdate()}}update(e){for(var t=this.masses,s=t.length-1;s>=0;s--)t[s].update(e)}updateSound(){if(this.player.isInFocus()){var e=this.scene.sound,t=this.gamepad;t.isButtonDown("up")?e.play(F,.6):t.isButtonDown("up")||e.stop(F)}}stopSounds(){this.scene.sound.stop(F)}draw(e){if(this.explosion)this.explosion.draw(1);else{if(this.scene.ticks>0&&!this.player.isGhost()){if(!this.scene.state.playing){let e=window.lite.storage.get("snapshots");if(e>0){for(let t in this.player._checkpoints)t<=this.player._checkpoints.length-(parseInt(e)+1)||!this.player._checkpoints[t]||!this.player._checkpoints[t]._tempVehicle||(e.globalAlpha=e/300*parseInt(t)%1,this.drawBalloon.call(Object.assign({},this,JSON.parse(this.player._checkpoints[t]._tempVehicle)),e),e.globalAlpha=1);for(let t in this.player._cache)t<=this.player._cache.length-(parseInt(e)+1)||!this.player._cache[t]||!this.player._cache[t]._tempVehicle||(e.globalAlpha=e/300*parseInt(t)%1,this.drawBalloon.call(Object.assign({},this,JSON.parse(this.player._cache[t]._tempVehicle)),e),e.globalAlpha=1)}}if(window.lite.storage.get("playerTrail"))for(let t in window.lite.snapshots)window.lite.snapshots[t]&&window.lite.snapshots[t]._tempVehicle&&(e.globalAlpha=window.lite.snapshots.length/(200*window.lite.snapshots.length)*parseInt(t)%1,this.drawBalloon.call(Object.assign({},this,JSON.parse(window.lite.snapshots[t]._tempVehicle)),e),e.globalAlpha=1)}if(this.settings.developerMode)for(var t=this.masses,s=t.length-1;s>=0;s--)t[s].draw();e.globalAlpha=this.player._opacity,this.drawBalloon(e),e.globalAlpha=1}}drawBalloon(e){var t=this.scene,i=new s(this.basket.pos.x,this.basket.pos.y).toScreen(t),a=new s(this.head.pos.x,this.head.pos.y).toScreen(t),o=t.camera.zoom,r=a.x-i.x,n=a.y-i.y,h=-n,l=r;e.save(),e.strokeStyle="dark"===window.lite.storage.get("theme")?"#666":"#999",e.lineWidth=1,e.beginPath(),e.moveTo(i.x+.1*h,i.y+.1*l),e.lineTo(i.x+.5*r+.4*h,i.y+.5*n+.4*l),e.moveTo(i.x-.1*h,i.y-.1*l),e.lineTo(i.x+.5*r-.4*h,i.y+.5*n-.4*l),e.moveTo(i.x+.1*h,i.y+.1*l),e.lineTo(i.x+.36*r+.2*h,i.y+.36*n+.2*l),e.moveTo(i.x-.1*h,i.y-.1*l),e.lineTo(i.x+.36*r-.2*h,i.y+.36*n-.2*l),e.closePath(),e.stroke();const c=new C(this.head.pos.x,this.head.pos.y,this);c.radius=30,c.draw(e),this.gamepad.isButtonDown("up")&&(e.beginPath(),e.strokeStyle="#FFFF00",e.lineWidth=8*o,e.moveTo(i.x,i.y),e.lineTo(i.x+.1*r,i.y+.1*n),e.closePath(),e.stroke(),e.beginPath(),e.strokeStyle="#FFAA00",e.lineWidth=3*o,e.moveTo(i.x,i.y),e.lineTo(i.x+.1*r,i.y+.1*n),e.closePath(),e.stroke()),e.beginPath(),e.fillStyle="midnight"===window.lite.storage.get("theme")?"#ccc":"dark"===window.lite.storage.get("theme")?"#fbfbfb":"#000",e.moveTo(i.x+.1*h,i.y+.1*l),e.lineTo(i.x-.1*h,i.y-.1*l),e.lineTo(i.x-.22*r-.1*h,i.y-.22*n-.1*l),e.lineTo(i.x-.22*r+.1*h,i.y-.22*n+.1*l),e.lineTo(i.x+.1*h,i.y+.1*l),e.closePath(),e.fill(),e.restore()}},BLOB:class extends A{vehicleName="Blob";constructor(e,t){super(e),this.createMasses(t),this.createSprings(),this.stopSounds()}createMasses(e){var t=[];t.push(new D(new s(e.x+15,e.y+40),this)),t.push(new D(new s(e.x+-15,e.y+40),this)),t.push(new D(new s(e.x+-15,e.y+10),this)),t.push(new D(new s(e.x+15,e.y+10),this));var i=new P(new s(0,0),this);i.vel=new s(0,0),this.m0=t[0],this.m1=t[1],this.m2=t[2],this.m3=t[3],this.head=i,this.masses=t,this.focalPoint=this.head}createSprings(){let e=this.masses,t=[],s=this.spring0=new _(e[0],e[1],this),i=this.spring1=new _(e[1],e[2],this),a=this.spring2=new _(e[2],e[3],this),o=this.spring3=new _(e[3],e[0],this),r=this.spring4=new _(e[0],e[2],this),n=this.spring5=new _(e[1],e[3],this);for(var h in t.push(s),t.push(i),t.push(a),t.push(o),t.push(r),t.push(n),t)t[h].springConstant=.2,t[h].dampConstant=.2;this.springs=t}fixedUpdate(){if(!1===this.crashed&&(this.updateSound(),this.control()),this.explosion)this.explosion.fixedUpdate();else{let s=this.masses,i=s.length,a=this.springs,o=a.length;for(var e=o-1;e>=0;e--)a[e].fixedUpdate();for(var t=i-1;t>=0;t--)s[t].fixedUpdate();if((s[0].contact||s[1].contact||s[2].contact||s[3].contact)&&(this.slow=!1),!this.slow){for(this.control(),e=o-1;e>=0;e--)a[e].fixedUpdate();for(t=i-1;t>=0;t--)s[t].fixedUpdate()}let r=0,n=0;for(const e of this.masses)r+=e.pos.x,n+=e.pos.y;let h=this.head;h.pos.x=.25*r,h.pos.y=.25*n,h.vel=s[0].vel}}update(e){for(var t=this.masses,s=t.length-1;s>=0;s--)t[s].update(e)}updateSound(){this.player.isInFocus()&&this.scene.sound.play(L,.4)}stopSounds(){this.scene.sound.stop(L)}updateCameraFocalPoint(){}control(){var e,t,s=this.player.getGamepad(),i=s.isButtonDown("up"),a=s.isButtonDown("down"),o=s.isButtonDown("left"),r=s.isButtonDown("right"),n=s.isButtonDown("z"),h=this.masses,l=this.springs,c=h.length,d=l.length,p=this.dir;p=r?1:-1;var u=r||o?1:0;for(a&&(u=0),e=c-1;e>=0;e--)h[e].motor+=(u*p*1-h[e].motor)/10,0==u&&(h[e].motor=0),h[e].brake=a;var g=o?1:0;if(g+=r?-1:0,l[4].rotate(g/9),l[5].rotate(g/9),n||i)for(t=d-1;t>=0;t--)l[t].contract(30,10);else for(t=d-1;t>=0;t--)l[t].contract(0,1.5)}draw(t){if(this.explosion)this.explosion.draw(1);else{if(this.scene.ticks>0&&!this.player.isGhost()){if(!this.scene.state.playing){let s=window.lite.storage.get("snapshots");if(s>0){for(let e in this.player._checkpoints)e<=this.player._checkpoints.length-(parseInt(s)+1)||!this.player._checkpoints[e]||!this.player._checkpoints[e]._tempVehicle||this.drawBlob.call(Object.assign({},this,JSON.parse(this.player._checkpoints[e]._tempVehicle)),t,s/300*parseInt(e)%1);for(let i in this.player._cache)i<=this.player._cache.length-(parseInt(s)+1)||!this.player._cache[i]||!this.player._cache[i]._tempVehicle||this.drawBlob.call(Object.assign({},this,JSON.parse(this.player._cache[i]._tempVehicle)),t,s/300*++e%1)}}if(window.lite.storage.get("playerTrail"))for(let e in window.lite.snapshots)window.lite.snapshots[e]&&window.lite.snapshots[e]._tempVehicle&&this.drawBlob.call(Object.assign({},this,JSON.parse(window.lite.snapshots[e]._tempVehicle)),t,window.lite.snapshots.length/(200*window.lite.snapshots.length)*parseInt(e)%1)}this.drawBlob(t)}}drawBlob(e,t=this.player._opacity){var i=this.scene,a=i.camera.zoom,o=new s(this.m0.pos.x,this.m0.pos.y).toScreen(i),r=new s(this.m1.pos.x,this.m1.pos.y).toScreen(i),n=new s(this.m2.pos.x,this.m2.pos.y).toScreen(i),h=new s(this.m3.pos.x,this.m3.pos.y).toScreen(i);e.globalAlpha=t,e.beginPath(),e.fillStyle=e.strokeStyle,e.lineWidth=20*a,e.lineCap="round",e.moveTo(o.x,o.y),e.lineTo(r.x,r.y),e.lineTo(n.x,n.y),e.lineTo(h.x,h.y),e.lineTo(o.x,o.y),e.fill(),e.stroke(),e.globalAlpha=1}}};function X(e,t){for(var s in t)try{e[s]=t[s].constructor==Object?X(e[s],t[s]):t[s]}catch(i){e[s]=t[s]}return e}const Y=class{game=null;assets=null;settings=null;camera=null;screen=null;mouse=null;track=null;player=null;players=null;ticks=0;state=null;oldState=null;stateDirty=!0;onStateChange=null;vehicle="Mtb";showDialog=!1;importCode=!1;pauseControls=null;controls=null;message=null;analytics=null;constructor(e){this.game=e,this.assets=e.assets,this.settings=e.settings,this.sound=new class{muted=!1;sounds=null;constructor(e){this.scene=e,this.sounds={}}update(){let e=this.scene;for(let t in this.sounds)this.sounds[t]&&(this.sounds[t].muted=e.state.paused||!1===e.settings.soundsEnabled),this.sounds[t]&&this.sounds[t].paused&&!e.state.paused?this.sounds[t].play():this.sounds[t]&&!this.sounds[t].paused&&e.state.paused&&this.sounds[t].pause()}setVolume(e,t){this.sounds[e]&&(this.sounds[e].volume=t)}mute_all(){let e=this.sounds;for(var t in e)e.hasOwnProperty(t)&&(e[t].volume=0);this.muted=!0}stop_all(){let e=this.sounds;for(var t in e)e.hasOwnProperty(t)&&this.stop(e)}play(e,t){if(null==t&&(t=1),this.sounds[e])this.sounds[e].volume=t;else if(this.scene.settings.soundsEnabled){let s=this.scene.assets.getItem(e),i=new Audio(s.src),a=this;i.volume=t,i.addEventListener("ended",(()=>{a.sounds[e]=null})),i.play(),this.sounds[e]=i}}stop(e){this.sounds[e]&&(this.sounds[e].pause(),this.sounds[e]=null)}close(){this.sounds=null}}(this),this.mouse=new S(this),this.score=new class{cached=!1;paused=!1;scene=null;state=null;sprites={};container={children:[],x:10*window.devicePixelRatio/2.5,y:10*window.devicePixelRatio/2.5,scaleX:.4,scaleY:.4,width:508,height:58};spriteSheet={timer:[2,2,58,58],timer_paused:[2,62,116,118],target:[2,2,58,58]};offset={y:0,x:0};time={color:"#000000",font:40*window.devicePixelRatio/2.5,text:"0:00.00",x:57,y:18};time_title={color:"#999999",font:20*window.devicePixelRatio/2.5,text:"TIME:",x:59,y:3};timer_sprite={image:"timer",x:0,y:0};best_time={color:"#999999",font:35*window.devicePixelRatio/2.5,text:"-- : --.--",x:237,y:21};best_time_title={color:"#999999",font:20*window.devicePixelRatio/2.5,text:"BEST:",x:240,y:3};goals={color:"#000000",font:40*window.devicePixelRatio/2.5,text:"0/0",x:460,y:15};target_sprite={image:"target",x:400,y:0};constructor(e){this.scene=e,this.container.children.push(this.time),this.container.children.push(this.time_title),this.container.children.push(this.timer_sprite),this.container.children.push(this.best_time),this.container.children.push(this.best_time_title),this.container.children.push(this.goals),this.container.children.push(this.target_sprite),this.sprites.timer=this.scene.assets.getResult("time_icon"),this.sprites.target=this.scene.assets.getResult("targets_icon")}draw(e){e.save(),e.textAlign="left",e.textBaseline="top",e.imageSmoothingEnabled=!0;for(const t of this.container.children)if(t.hasOwnProperty("image")){let s=this.spriteSheet[t.image];e.drawImage(this.sprites[t.image.replace("_paused","")],...s,this.container.x+t.x*this.container.scaleX*window.devicePixelRatio,this.container.y+t.y*this.container.scaleY*window.devicePixelRatio,s[2]*this.container.scaleX*window.devicePixelRatio,s[3]*this.container.scaleY*window.devicePixelRatio)}else t.hasOwnProperty("text")&&(e.font=t.font*window.devicePixelRatio+"px helsinki",e.fillStyle=t.color,e.fillText(t.text,this.container.x+t.x*this.container.scaleX*window.devicePixelRatio,this.container.y+t.y*this.container.scaleY*window.devicePixelRatio));e.restore()}update(){let e=this.scene.state.paused;this.paused!==e&&(e?(this.timer_sprite.image="timer_paused",this.paused=!0):(this.timer_sprite.image="timer",this.paused=!1)),!1===this.cached&&this.scene.ticks>50&&(this.cached=!0),this.time.text=b(1e3*((this.scene.camera.focusIndex>0?this.scene.playerManager.getPlayerByIndex(this.scene.camera.focusIndex)._gamepad.playbackTicks:null)??this.scene.ticks)/this.scene.settings.drawFPS),this.goals.text=this.scene.playerManager.firstPlayer.getTargetsHit()+"/"+this.scene.track.targetCount,this.best_time.text="-- : --.--",this.scene.settings.isCampaign&&this.scene.settings.campaignData.user.best_time?this.best_time.text=this.scene.settings.campaignData.user.best_time:this.scene.settings.userTrackStats&&this.scene.settings.userTrackStats.best_time&&(this.best_time.text=this.scene.settings.userTrackStats.best_time),this.scene.settings.mobile&&this.center_container()}center_container(){var e=this.container,t=e.width,s=this.scene.screen;e.x=s.width/2-t/2*e.scaleY,e.y=10*window.devicePixelRatio}}(this),this.camera=new class{settings=null;scene=null;zoom=1;position=null;desiredZoom=1;zoomPercentage=0;focusIndex=0;playerFocus=null;constructor(e){this.settings=e.settings,this.scene=e,this.zoom=e.settings.cameraStartZoom*e.game.pixelRatio,this.desiredZoom=e.settings.cameraStartZoom*e.game.pixelRatio,this.zooming=!1,this.position=new s(0,0),this.zoomPercentage=this.getZoomAsPercentage(),this.zoomPoint=!1}focusOnNextPlayer(){this.focusIndex=(this.focusIndex+1)%this.scene.playerManager.getPlayerCount(),this.focusOnPlayer()}focusOnPlayer(){this.scene.playerManager.getPlayerCount()<=this.focusIndex&&(this.focusIndex=0);let e=this.scene.playerManager.getPlayerByIndex(this.focusIndex);this.playerFocus!==e&&(0===this.focusIndex&&(this.scene.playerManager._players.filter((e=>e.isGhost())).forEach((e=>e._replayIterator.next(this.scene.ticks))),this.focusIndex=0),this.playerFocus=e,this.scene.vehicleTimer.setPlayer(e),this.playerFocus?e.getDistanceBetweenPlayers(this.playerFocus)>1500&&this.fastforward():this.fastforward()),window.hasOwnProperty("lite")&&window.lite.replayGui&&(window.lite.replayGui.style.setProperty("display",0!==this.focusIndex?"block":"none"),0!==this.focusIndex&&(e=this.scene.races.find((({user:t})=>t.u_id==e._user.u_id)))&&(window.lite.replayGui.progress.max=e.race.run_ticks??100))}focusOnMainPlayer(){0===this.focusIndex&&this.playerFocus||(this.focusIndex=0,this.focusOnPlayer())}update(){if(this.playerFocus){let e=this.playerFocus.getActiveVehicle(),t=3;Math.sqrt(Math.pow(e.focalPoint.pos.x-this.position.x,2)+Math.pow(e.focalPoint.pos.y-this.position.y,2))>1500&&(t=1),this.position.x+=(e.focalPoint.pos.x-this.position.x)/t,this.position.y+=(e.focalPoint.pos.y-this.position.y)/t}}updateZoom(){this.desiredZoom!==this.zoom&&(this.scene.loading=!0,this._performZoom(),this.zoom===this.desiredZoom&&this.zoomComplete())}zoomToPoint(e){this.position.x=this.scene.screen.toReal(this.zoomPoint.x,"x")-this.scene.screen.width/e*this.zoomPoint.x/this.scene.screen.width+this.scene.screen.width/e/2,this.position.y=this.scene.screen.toReal(this.zoomPoint.y,"y")-this.scene.screen.height/e*this.zoomPoint.y/this.scene.screen.height+this.scene.screen.height/e/2}_performZoom(){let e=this.zoom+(this.desiredZoom-this.zoom)/3;Math.abs(this.desiredZoom-this.zoom)<.05&&(e=this.desiredZoom),this.zoomPoint&&this.zoomToPoint(e),this.zoom=e}zoomComplete(){this.scene.redraw(),this.zooming=!1,this.scene.loading=!1}setZoom(e,t){this.desiredZoom=Math.round(e*window.devicePixelRatio*10)/10,this.zooming=!0,this.desiredZoom===this.zoom&&(this.zooming=!1,this.scene.state.loading=!1),this.zoomPoint=!1,null===this.playerFocus&&t&&(this.zoomPoint=t),this.zoomPercentage=this.getZoomAsPercentage(),this.scene.stateChanged()}resetZoom(){this.setZoom(this.settings.cameraStartZoom)}getZoomAsPercentage(){return this.desiredZoom/window.devicePixelRatio/this.scene.settings.cameraStartZoom*100|0}increaseZoom(){this.setZoom((this.desiredZoom+2*this.scene.settings.cameraSensitivity)/window.devicePixelRatio),this.desiredZoom>this.scene.settings.cameraZoomMax*window.devicePixelRatio&&this.setZoom(this.scene.settings.cameraZoomMax)}decreaseZoom(){this.setZoom((this.desiredZoom-2*this.scene.settings.cameraSensitivity)/window.devicePixelRatio),this.desiredZoom<this.scene.settings.cameraZoomMin*window.devicePixelRatio&&this.setZoom(this.scene.settings.cameraZoomMin)}unfocus(){this.playerFocus=null,this.scene.vehicleTimer.removePlayer()}fastforward(){if(this.playerFocus){let e=this.playerFocus.getActiveVehicle();this.position.x=e.focalPoint.pos.x,this.position.y=e.focalPoint.pos.y}}close(){this.zoom=null,this.scene=null,this.position=null,this.playerFocus=null}}(this),this.screen=new class{game=null;scene=null;size=null;center=null;width=0;height=0;constructor(e){this.scene=e,this.game=e.game,this.size=new s(0,0),this.center=new s(0,0),this.setScreen()}setScreen(){this.width=this.game.width,this.height=this.game.height,this.size.x=this.game.width,this.size.y=this.game.height,this.center.x=this.game.width/2,this.center.y=this.game.height/2}update(){(this.game.width!==this.width||this.game.height!==this.height)&&this.setScreen()}realToScreen(e,t){return(e-this.scene.camera.position[t])*this.scene.camera.zoom+this.scene.screen.center[t]}toReal(e,t){return(e-this.scene.screen.center[t])/this.scene.camera.zoom+this.scene.camera.position[t]}close(){this.width=null,this.height=null,this.center=null,this.size=null,this.game=null,this.scene=null}}(this),this.message=new class{message=null;timeout=null;constructor(e){this.scene=e,this.message=!1,this.timeout=!1,this.color="#000"}draw(e){var t=this.message,s=this.timeout,i=this.color,a=this.outline;if(!1!==s&&0>=s&&(t=!1),this.scene.state.paused&&(i=!1,a=!1,t=this.scene.settings.mobile?"Paused":"Paused - Press Spacebar to Continue"),!1===i&&(i="midnight"==lite.storage.get("theme")?"#888":"dark"==lite.storage.get("theme")?"#ccc":"#333333"),t){var o=this.scene.game,r=this.scene,n=o.pixelRatio,h=r.screen.center.x,l=100;"phone"===r.settings.controls&&(l=80),e.save(),e.fillStyle=/^#(0|3){3,6}$/.test(this.color)?"midnight"==lite.storage.get("theme")?"#ccc":"dark"==lite.storage.get("theme")?"#fbfbfb":"#000":i,e.lineWidth=n/2*4,e.font=12*n+"pt helsinki",e.textAlign="center",a&&(e.strokeStyle="midnight"==lite.storage.get("theme")?"#1d2328":"dark"==lite.storage.get("theme")?"#1b1b1b":a,e.strokeText(t,h,l*n),e.strokeStyle="#000"),e.fillText(t,h,l*n),e.restore()}}show(e,t,s,i){this.message=e,this.timeout=t,this.color=s,this.outline=i}hide(){this.message=!1,this.color=!1,this.outline=!1}update(){!1!==this.timeout&&this.timeout--}}(this),this.createTrack(),this.loadingcircle=new class{scene=null;clockwise=!1;context=null;screen=null;pixelRatio=1;settings={radius:10,color:"#1884cf"};constructor(e){this.scene=e,this.screen=e.screen,this.context=e.game.canvas.getContext("2d")}draw(e=this.context){let t=this.screen,s=this.settings,i=this.scene.game.pixelRatio,a=s.radius,o=this.clockwise,r=this.scene.game.tickCount%25/25*2*Math.PI;0===r&&(this.clockwise&&(r=2*Math.PI),this.clockwise=!this.clockwise);let n=o?0:r,h=o?r:0,l=t.width-25*i,c=t.height-25*i;e.beginPath(),e.arc(l,c,a*i,n,h,!1),e.lineWidth=3*i,e.strokeStyle=s.color,e.stroke()}}(this),this.playerManager=new class{constructor(e){this.scene=e,this.game=e.game,this.settings=e.settings,this.firstPlayer=null,this._players=[],this._playerLookup={}}fixedUpdate(){if(!this.scene.camera.focusIndex)for(var e=this._players.filter((e=>!e.complete&&!e.isGhost())),t=e.length,s=0;t>s;s++)e[s].fixedUpdate();for(t=(e=this._players.filter((e=>!e.complete&&e.isGhost()))).length,s=0;t>s;s++)e[s]._replayIterator.next()}update(e){for(var t=this._players,s=t.length,i=0;s>i;i++)t[i].update(e)}mutePlayers(){for(var e=this._players,t=e.length,s=0;t>s;s++)e[s].getActiveVehicle().stopSounds()}updateGamepads(){for(var e=this._players.filter((e=>!e.isGhost())),t=e.length,s=0;t>s;s++)e[s]._gamepad.update()}createPlayer(e,t){return new class{constructor(e,t){this.id=N++,this._scene=e,this._game=e.game,this._user=t,this._settings=e.settings;let i=e.settings.startVehicle;e.settings.track&&(i=e.settings.track.vehicle),this._baseVehicleType=i,this._gamepad=new class{tickDownButtons=null;previousTickDownButtons=null;downButtons=null;paused=!1;keymap=null;records=null;keysToRecord=null;keysToPlay=null;recording=!1;playback=null;numberOfKeysDown=0;tickNumberOfKeysDown=0;replaying=!1;constructor(e){this.scene=e,this.tickDownButtons={},this.previousTickDownButtons={},this.downButtons={},this.keymap={},this.records={},this.numberOfKeysDown=0,this.tickNumberOfKeysDown=0}listen(){document.onkeydown=this.handleButtonDown.bind(this),document.onkeyup=this.handleButtonUp.bind(this),window.onblur=this.handleBlur.bind(this),window.onfocus=this.handleFocus.bind(this)}unlisten(){this.downButtons={},document.onkeydown=null,document.onkeyup=null}pause(){this.paused=!0}unpause(){this.paused=!1}recordKeys(e){this.keysToRecord=e,this.recording=!0}loadPlayback(e,t){this.keysToPlay=t,this.playback=e,this.replaying=!0}setKeyMap(e){var t={};for(var s in e)if(e[s]instanceof Array)for(var i in e[s])t[e[s][i]]=s;else t[e[s]]=s;this.keymap=t}handleButtonDown(e){var t=this.getInternalCode(e.keyCode);"string"==typeof t&&e.preventDefault(),this.setButtonDown(t)}handleButtonUp(e){var t=this.getInternalCode(e.keyCode);"string"==typeof t&&e.preventDefault(),this.setButtonUp(t)}blurred=!1;previousDownButtons={};handleBlur(){this.blurred=!0,this.previousDownButtons=Object.assign({},this.tickDownButtons)}handleFocus(){this.blurred&&(this.tickDownButtons=Object.assign({},this.previousDownButtons),this.downButtons=Object.fromEntries(Object.keys(this.tickDownButtons).map((e=>[e,!1]))))}getInternalCode(e){return this.keymap[e]||e}setButtonsDown(e){for(var t=0,s=e.length;s>t;t++)this.setButtonDown(e[t])}setButtonUp(e){this.blurred=!1,this.downButtons[e]&&(this.onButtonUp&&this.onButtonUp(e),this.downButtons[e]=!1,this.numberOfKeysDown--)}setButtonDown(e,t){this.blurred=!1,this.downButtons[e]||(this.onButtonDown&&this.onButtonDown(e),this.downButtons[e]=t||!0,this.numberOfKeysDown++)}isButtonDown(e){return this.tickDownButtons[e]>0}getButtonDownOccurances(e){var t=0;if(this.isButtonDown(e)){t=1;var s=this.tickDownButtons[e];!0!==s&&(t=s)}return t}getDownButtons(){var e=[];for(var t in this.tickDownButtons)this.tickDownButtons[t]&&e.push(t);return e}reset(e){(this.replaying||e)&&(this.downButtons={},this.playbackTicks=0),this.tickDownButtons={},this.previousDownButtons={},this.previousTickDownButtons={},this.records={}}update(){this.replaying&&this.updatePlayback(),this.blurred||(this.previousTickDownButtons=Object.assign({},this.tickDownButtons),this.tickDownButtons=Object.assign({},this.downButtons)),this.tickNumberOfKeysDown=this.numberOfKeysDown,this.recording&&this.updateRecording()}areKeysDown(){for(var e in this.downButtons)if(!0===this.downButtons[e])return!0;return!1}updatePlayback(){var e=this.keysToPlay,t=this.playback,s=this.playbackTicks??this.scene.ticks;for(var i in e){var a=e[i],o=a+"_up",r=a+"_down";if(void 0!==t[r]&&void 0!==t[r][s]){var n=t[r][s];this.setButtonDown(a,n)}void 0!==t[o]&&void 0!==t[o][s]&&this.setButtonUp(a)}}updateRecording(){var e=this.scene.ticks,t=this.records,s=this.tickDownButtons,i=this.previousTickDownButtons;for(var a of this.keysToRecord)if(void 0!==s[a]){var o=s[a];if(o!==(void 0!==i[a]&&i[a])){var r=a+"_down",n=a+"_up";o&&(n=r),!o&&t[r]&&-1!==t[r].indexOf(e)?/^(backspace|enter)$/.test(a)?(t[n]||(t[n]=[]),t[n].push(e+1)):(t[r].splice(t[r].indexOf(e),1),t[r].length||delete t[r]):(t[n]||(t[n]=[]),t[n].push(e))}}}buttonWasRecentlyDown(e){var t=this.records;this.replaying&&(t=this.playback);var s=e+"_down",i=!1;if(t[s]){var a=(this.replaying&&this.playbackTicks)??this.scene.ticks,o=t[s];-1!==(this.replaying?void 0!==o[a]:o.indexOf(a))&&(i=!0)}return i}getReplayString(){return JSON.stringify(this.records)}encodeReplayString(e){var t={version:this.scene.settings.replayVersion};for(var s in e){var i=e[s];for(var a in t[s]="",i){var o=i[a];t[s]+=o.toString(32)+" "}}return t}close(){this.unlisten(),this.handleButtonUp=null,this.handleButtonDown=null,this.onButtonDown=null,this.onButtonUp=null,this.scene=null,this.tickDownButtons=null,this.downButtons=null,this.keymap=null,this.records=null,this.keysToRecord=null}}(e),this._ghost=!1,this._color=t.color?t.color:"#000000",this.setDefaults(),this.createBaseVehicle(new s(0,35),1,new s(0,0))}getCheckpointCount(){return this._checkpoints.length}setDefaults(){this._baseVehicle=!1,this._tempVehicleType=null,this._tempVehicle=!1,this._tempVehicleTicks=0,this._temp_vehicle_options=null,this._addCheckpoint=!1,this._checkpoints=[],this._cache=[],this._crashed=!1,this._effect=!1,this._effectTicks=0,this._opacity=1,this.complete=!1,this._powerupsConsumed={checkpoints:[],targets:[],misc:[]}}hasCheckpoints(){return this._checkpoints.length>0}setColor(e){this._color=e}dead(){if(this._crashed=!0,!1===this._ghost){let e=this._scene,t=e.settings,s=e.message;e.state.playerAlive=this.isAlive(),this._checkpoints.length>0?t.mobile?s.show("Tap to go to checkpoint!",!1,"#000000","#FFFFFF"):s.show("Press Enter For Checkpoint",!1,"#000000","#FFFFFF"):t.mobile?s.show("Tap to Restart!",!1,"#000000","#FFFFFF"):s.show("Press Enter To Restart",!1,"#000000","#FFFFFF")}}setAsGhost(){this._ghost=!0,this._replayIterator=this.createReplayIterator()}isGhost(){return this._ghost}isAlive(){return!this._crashed}getTargetsHit(){return this._powerupsConsumed.targets.length}getGamepad(){return this._gamepad}setBaseVehicle(e){this._baseVehicleType=e,this.reset()}createBaseVehicle(e,t,s){this._tempVehicle&&this._tempVehicle.stopSounds(),this._baseVehicle=new Z[this._baseVehicleType](this,e,t,s),this._tempVehicle=!1,this._tempVehicleType=!1,this._tempVehicleTicks=0}setTempVehicle(e,t,s,i){this._temp_vehicle_options&&this._temp_vehicle_options.type===e&&(t=this._temp_vehicle_options.ticks+t),this._temp_vehicle_options={type:e,ticks:t,position:s,direction:i}}createTempVehicle(e,t,s,i){if(this._temp_vehicle_options){let a=this._temp_vehicle_options;e=a.type,t=a.ticks,s=a.position,i=a.direction,this._temp_vehicle_options=null}this._tempVehicleType===e?this._tempVehicleTicks+=t:(this.getActiveVehicle().stopSounds(),this._effect=new B(s,this._scene),this._effectTicks=45,this._tempVehicleType=e,this._tempVehicle=new Z[e](this,s,i),this._tempVehicleTicks=t)}fixedUpdate(){if(!1===this.complete){let e=this._baseVehicle;this._temp_vehicle_options&&this.createTempVehicle(),this._tempVehicleTicks>0&&(e=this._tempVehicle,!1===this._crashed&&this._tempVehicleTicks--,this._tempVehicleTicks<=0&&!1===this._crashed&&(this._effectTicks=45,this._effect=new B(this._tempVehicle.focalPoint.pos,this._scene),this.createBaseVehicle(this._tempVehicle.focalPoint.pos,this._tempVehicle.dir,this._tempVehicle.masses[0].vel),e=this._baseVehicle)),this._effectTicks>0&&(this._effectTicks--,this._effect.fixedUpdate()),lite.storage.get("playerTrail")&&this.isGhost()||this.isAlive()&&lite.snapshots.push(this._createSnapshot()),e.fixedUpdate(),this._addCheckpoint&&(this._createCheckpoint(),this._addCheckpoint=!1)}}update(e){if(!1===this.complete){let t=this._baseVehicle;this._tempVehicleTicks>0&&(t=this._tempVehicle),this._effectTicks>0&&this._effect.update(e),t.update(e)}}*createReplayIterator(e=0){const t=new Map;for(this._gamepad.playbackTicks=0;!1===this.complete;){if(t.has(this._gamepad.playbackTicks)||this.isAlive()&&t.set(this._gamepad.playbackTicks,{downButtons:Object.assign({},this._gamepad.downButtons),snapshot:this._createSnapshot()}),this._gamepad.playbackTicks>=e){const s=yield this._gamepad.playbackTicks;if(isFinite(s)){if(t.has(s)){let{downButtons:e,snapshot:i}=t.get(s);this._checkpoints.push(i),this.gotoCheckpoint(),this._checkpoints.pop(),this._gamepad.playbackTicks=s,this._gamepad.downButtons=Object.assign({},e)}else s<e&&this.reset();this._scene.camera.focusIndex=this._scene.playerManager._players.indexOf(this),this._scene.camera.focusOnPlayer(),e=s;continue}e=this._gamepad.playbackTicks+1}this._gamepad.update(),this.checkKeys(),this.fixedUpdate(),this._gamepad.playbackTicks++,this.isInFocus()&&window.hasOwnProperty("lite")&&window.lite.replayGui&&(window.lite.replayGui.progress.value=this._gamepad.playbackTicks)}return this.loop&&(this.reset(),this._replayIterator=this.createReplayIterator()),t}isInFocus(){return this._scene.camera.playerFocus&&this._scene.camera.playerFocus===this}updateOpacity(){let e=1;if(this._scene.camera.playerFocus&&this._scene.camera.playerFocus!==this){var t=this.getDistanceBetweenPlayers(this._scene.camera.playerFocus);1200>t&&(e=Math.min(t/500,1))}this._opacity=e}drawName(e){let t=this.getActiveVehicle().focalPoint.pos.toScreen(this._scene);e.globalAlpha=this._opacity,e.beginPath(),e.fillStyle=this._color,e.moveTo(t.x,t.y-40*this._scene.camera.zoom),e.lineTo(t.x-5*this._scene.camera.zoom,t.y-50*this._scene.camera.zoom),e.lineTo(t.x+5*this._scene.camera.zoom,t.y-50*this._scene.camera.zoom),e.lineTo(t.x,t.y-40*this._scene.camera.zoom),e.fill(),e.font=9*this._scene.game.pixelRatio*Math.max(this._scene.camera.zoom,1)+"pt helsinki",e.textAlign="center",e.fillStyle=this._color,e.fillText(this._user.d_name,t.x,t.y-60*this._scene.camera.zoom),e.globalAlpha=1}draw(e){this.updateOpacity();let t=this._baseVehicle;this._tempVehicleTicks>0&&(t=this._tempVehicle),this._effectTicks>0&&this._effect.draw(this._effectTicks/100),t.draw(e),this.isGhost()&&this.drawName(e)}checkKeys(){var e=this._gamepad,t=this._ghost,s=this._scene;if(!e.isButtonDown("enter")&&!e.isButtonDown("backspace")&&e.areKeysDown()&&this._cache.length>0&&(this._cache=[]),e.isButtonDown("shift")&&e.isButtonDown("enter")){var i=e.getButtonDownOccurances("enter");this.returnToCheckpoint(i),e.setButtonUp("enter")}!1===t&&(e.areKeysDown()&&!this._crashed&&s.play(),e.isButtonDown("restart")&&(s.restartTrack=!0,e.setButtonUp("restart")),(e.isButtonDown("up")||e.isButtonDown("down")||!s.camera.focusIndex&&(e.isButtonDown("left")||e.isButtonDown("right")))&&s.camera.focusOnMainPlayer()),e.isButtonDown("enter")&&(this.gotoCheckpoint(),e.setButtonUp("enter")),e.isButtonDown("backspace")&&(i=e.getButtonDownOccurances("backspace"),this.removeCheckpoint(i),e.setButtonUp("backspace"))}getDistanceBetweenPlayers(e){let t=e.getActiveVehicle(),s=this.getActiveVehicle(),i=t.focalPoint.pos.x-s.focalPoint.pos.x,a=t.focalPoint.pos.y-s.focalPoint.pos.y;return Math.sqrt(Math.pow(i,2)+Math.pow(a,2))}getActiveVehicle(){return this._tempVehicleTicks>0?this._tempVehicle:this._baseVehicle}_createCheckpoint(){this._checkpoints.push(this._createSnapshot())}_createSnapshot(){let e={};return this._tempVehicleTicks>0?(e._tempVehicleType=this._tempVehicleType,e._tempVehicle=JSON.stringify(this._tempVehicle,this._snapshotFilter),e._tempVehicleTicks=this._tempVehicleTicks):(e._baseVehicleType=this._baseVehicleType,e._baseVehicle=JSON.stringify(this._baseVehicle,this._snapshotFilter)),e._powerupsConsumed=JSON.stringify(this._powerupsConsumed),e._crashed=this._crashed,e}_snapshotFilter(e,t){switch(e){case"parent":case"player":case"scene":case"settings":case"masses":case"springs":case"focalPoint":case"gamepad":return;case"explosion":return!1;default:return t}}setCheckpointOnUpdate(){this._addCheckpoint=!0}crashed(){this._crashed=!0}gotoCheckpoint(){var e=this._gamepad.replaying,t=this._scene;if(this._checkpoints.length>0){var s=this._checkpoints[this._checkpoints.length-1];if(s._tempVehicle){this._baseVehicle.stopSounds();var i=this._tempVehicle;this._tempVehicleType!==s._tempVehicleType&&(i=new Z[s._tempVehicleType](this,{x:0,y:0})),X(i,JSON.parse(s._tempVehicle)),this._tempVehicle=i,this._tempVehicleType=s._tempVehicleType,this._tempVehicleTicks=s._tempVehicleTicks,i.updateCameraFocalPoint()}else X(i=this._baseVehicle,JSON.parse(s._baseVehicle)),this._tempVehicle&&this._tempVehicle.stopSounds(),this._baseVehicle=i,this._tempVehicleTicks=0,this._tempVehicleType=!1,i.updateCameraFocalPoint();if(this._powerupsConsumed=JSON.parse(s._powerupsConsumed),this._crashed=s._crashed,!1===e){var a=t.settings;t.state.playerAlive=this.isAlive(),t.settings.mobile?t.message.show("Tap to resume",5,"#826cdc","#FFFFFF"):t.message.show("Press Backspace To Go Back Further",5,"#826cdc","#FFFFFF"),t.track.updatePowerupState(this),a.waitAtCheckpoints&&(t.state.playing=!1),t.camera.focusOnMainPlayer()}t.camera.playerFocus===this&&t.camera.fastforward()}else!1===e&&this.restartScene()}restartScene(){!1===this._gamepad.replaying&&(this._scene.restartTrack=!0)}removeCheckpoint(e){if(this._checkpoints.length>1){for(var t=0;e>t;t++)this._cache.push(this._checkpoints.pop());this.gotoCheckpoint()}else this.restartScene()}returnToCheckpoint(e){if(this._cache.length>0){for(var t=0;e>t;t++)this._checkpoints.push(this._cache.pop());this.gotoCheckpoint()}}close(){this.id=null,this._scene=null,this._game=null,this._user=null,this._settings=null,this._baseVehicleType=null,this._gamepad.close(),this._gamepad=null,this._baseVehicle=null,this._tempVehicleType=null,this._tempVehicle=null,this._tempVehicleTicks=null,this._addCheckpoint=null,this._checkpoints=null,this._cache=null,this._crashed=null,this._effect=null,this._effectTicks=null,this._powerupsConsumed=null}reset(){this._tempVehicle&&this._tempVehicle.stopSounds(),this._baseVehicle.stopSounds(),this.setDefaults(),this.createBaseVehicle(new s(0,35),1,new s(0,0)),this._gamepad.reset(),this._scene.state.playerAlive=this.isAlive(),window.hasOwnProperty("lite")&&(window.lite.snapshots.splice(0),window.lite.replayGui&&(window.lite.replayGui.progress.value=0))}}(this.scene,t)}addPlayer(e){this._players.push(e),this._playerLookup[e.id]=e}checkKeys(){for(var e=this._players.filter((e=>!e.isGhost())),t=e.length,s=0;t>s;s++)e[s].checkKeys()}draw(e){for(let t of this._players)t.draw(e)}getPlayerByIndex(e){return this._players[e]}getPlayerById(e){return this._playerLookup[e]}getPlayerCount(){return this._players.length}reset(){for(var e=(s=this._players).length,t=0;e>t;t++)s[t].reset();var s=this._players.filter((e=>e.isGhost()));for(e=s.length,t=0;e>t;t++)s[t]._replayIterator=s[t].createReplayIterator()}clear(){this._players=[],this._playerLookup={},this._players.push(this.firstPlayer),this._playerLookup[this.firstPlayer.id]=this.firstPlayer}_closePlayers(){for(var e=this._players,t=e.length,s=0;t>s;s++)e[s].close()}close(){this._closePlayers(),this._players=null,this.firstPlayer=null,this._playerLookup=null,this.scene=null,this.game=null,this.settings=null}}(this),this.vehicleTimer=new class{scene=null;cached=!1;container={borderRadius:25,font:35*window.devicePixelRatio/2,text:"00:00",scaleX:window.devicePixelRatio/2,scaleY:window.devicePixelRatio/2,width:200,height:60,x:100,y:30};constructor(e){this.scene=e,this.settings=e.settings,this.player=!1,this.createPulseTween()}setPlayer(e){this.player=e}removePlayer(){this.player=!1}playerAddedTime(e){this.player===e&&this.createPulseTween()}createPulseTween(){let e=this.scene.game.pixelRatio/2;this.tweenRemaining=200,this.tweenStart=e,this.tweenScale=1.2*e}center_container(){var e=this.scene.screen,t=this.container;t.x=e.width/2-100*t.scaleX,t.y=e.height-100*t.scaleY}draw(e){e.save(),e.fillStyle="rgba(242,144,66,0.5)",e.strokeStyle="rgba(242,144,66,1)",e.lineWidth=5*window.devicePixelRatio/2,e.beginPath(),e.roundRect(this.container.x,this.container.y,this.container.width*this.container.scaleX,this.container.height*this.container.scaleY,this.container.borderRadius*this.container.scaleY),e.fill(),e.stroke(),e.font=this.container.font+"px helsinki",e.fillStyle="#000000",e.textAlign="center",e.textBaseline="middle",e.fillText(this.container.text,this.container.x+this.container.width/2*this.container.scaleX,this.container.y+this.container.height/2*this.container.scaleY),e.restore()}update(){if(this.tweenRemaining>0){this.tweenRemaining=Math.max(this.tweenRemaining-1e3/this.scene.game.settings.drawFPS);let e=this.container;e.scaleX=e.scaleY=e.scaleX*(1-this.tweenRemaining/100)+this.tweenScale*(this.tweenRemaining/100),e.scaleX==this.tweenScale&&(this.tweenScale=this.tweenStart)}this.player&&this.player._tempVehicleTicks>0?(this.center_container(),this.updateTime()):this.container.visible=!1}updateTime(){var e=this.player._tempVehicleTicks/this.scene.settings.drawFPS,t="";10>(e=e.toFixed(2))&&(t="0"),t+=e,this.container.text=t,this.container.visible=!0}close(){this.container=null,this.player=null,this.scene=null,this.settings=null}}(this)}createMainPlayer(){var e=this.playerManager.createPlayer(this,this.settings.user),t=e.getGamepad();t.setKeyMap(this.settings.editorHotkeys),t.onButtonDown=this.buttonDown.bind(this),t.listen(),this.playerManager.firstPlayer=e,this.playerManager.addPlayer(e)}createTrack(){this.track&&this.track.close();let e=new T(this),t=this.getAvailableTrackCode();0!=t?(e.read(t),this.track=e,this.state.preloading=!1,this.state.loading=!1):e.addDefaultLine(),this.importCode=!1,this.restartTrack=!0,this.clear=!1,this.track=e}getAvailableTrackCode(){let e=this.settings,t=!1;return e.importCode&&"false"!==e.importCode?(t=e.importCode,e.importCode=null):this.importCode&&(t=this.importCode,this.importCode=null),t}updateControls(){if(this.controls){var e=this.state.paused;this.controls.isVisible()===e&&(e||(this.state.playing=!1,this.camera.focusOnMainPlayer(),this.toolHandler.setTool("camera")),this.controls.setVisibility(!e),this.updateState()),this.controls.update()}this.pauseControls.update()}interactWithControls(){this.controls&&this.controls.click(),this.pauseControls.click()}isStateDirty(){let e=!1;for(let t in this.state)this.state[t]!==this.oldState[t]&&(e=!0,this.oldState[t]=this.state[t]);return e}draw(e){e.clearRect(0,0,e.canvas.width,e.canvas.height),this.toolHandler.drawGrid(e),this.track.draw(e),this.score.draw(e),this.playerManager.draw(e),this.vehicleTimer.player&&this.vehicleTimer.player._tempVehicleTicks>0&&this.vehicleTimer.draw(e),this.controls&&!1!==this.controls.isVisible()||this.toolHandler.draw(e),this.state.loading&&this.loadingcircle.draw(e),this.message.draw(e),this.pauseControls.draw(e),this.controls&&this.controls.draw(e)}redraw(){this.track.undraw(),GameInventoryManager.redraw(),this.toolHandler.resize()}fixedUpdate(){let e,t;this.controls&&!1!==this.controls.isVisible()||this.toolHandler.update(),this.mouse.update(),this.state.paused||this.state.showDialog||(this.playerManager.updateGamepads(),this.playerManager.checkKeys()),this.camera.focusIndex>0&&(e=this.playerManager.firstPlayer._gamepad.downButtons.right-this.playerManager.firstPlayer._gamepad.downButtons.left)&&((t=this.playerManager.getPlayerByIndex(this.camera.focusIndex))&&t.isGhost()&&t._replayIterator.next((t._gamepad.playbackTicks??this.ticks)+5*e),this.state.playing=!1),this.screen.update(),this.updateControls(),this.camera.update(),this.sound.update(),this.restartTrack&&this.restart(),!this.state.paused&&this.state.playing&&(this.message.update(),this.playerManager.fixedUpdate(),!this.camera.focusIndex&&(this.playerManager.firstPlayer.complete?this.trackComplete():this.ticks++)),this.score.update(),this.vehicleTimer.update(),this.isStateDirty()&&this.updateState(),this.camera.updateZoom()}update(e,t){!this.state.paused&&this.state.playing&&this.playerManager.update(e)}resize(){this.controls&&this.controls.resize()}stateChanged(){this.updateState()}toggleVehicle(){var e=this.track.allowedVehicles,t=e.length,s=(this.state.vehicle||this.vehicle).toUpperCase(),i=e.indexOf(s);++i>=t&&(i=0),s=e[i],this.selectVehicle(s)}selectVehicle(e){-1!==this.track.allowedVehicles.indexOf(e)&&(this.settings.track.vehicle=e,this.vehicle=e,this.playerManager.firstPlayer.setBaseVehicle(e),this.restartTrack=!0)}listen(){this.playerManager.firstPlayer.getGamepad().listen()}unlisten(){this.playerManager.firstPlayer.getGamepad().unlisten()}stopAudio(){this.sound&&this.sound.stop_all()}command(){var e=Array.prototype.slice.call(arguments,0);switch(e.shift()){case"resize":this.resize();break;case"dialog":var t=e[0];!1===t?this.listen():this.unlisten(),this.openDialog(t);break;case"focused":!0===e[0]?(this.state.inFocus=!0,!1===this.state.showDialog&&this.listen()):(this.state.inFocus=!1,this.unlisten(),this.state.playing=!1);break;case"add track":this.importCode=e[0].code}}close(){this.pauseControls=null,this.score=null,this.mouse.close(),this.mouse=null,this.camera.close(),this.camera=null,this.screen.close(),this.screen=null,this.vehicleTimer.close(),this.vehicleTimer=null,this.playerManager.close(),this.playerManager=null,this.sound.close(),this.sound=null,this.track.close(),this.toolHandler.close(),this.game=null,this.assets=null,this.settings=null,this.track=null,this.state=null,this.stopAudio()}},J=class{defaultControlOptions={visible:!0};name=null;controlsSpriteSheetData={};controlData=null;game=null;scene=null;settings=null;controlsSprite=null;gamepad=null;properties={alpha:1,right:0,scaleX:window.devicePixelRatio/2,scaleY:window.devicePixelRatio/2,top:60,visible:!0,x:0,y:0};init(e){this.scene=e,this.game=e.game,this.assets=e.assets,this.settings=e.settings,this.mouse=e.mouse,this.playerManager=e.playerManager,this.createSprite(),this.resize()}isMouseOverComponent(e){const{x:t,y:s}=this.mouse.touch.pos;return Math.sqrt((t-e.x)**2+(s-e.y)**2)<e.width/2*e.scaleX}click(){}createSprite(){let e=this.scene.assets.getResult(this.name);this.controlsSpriteSheetData.images=[e],this.controlsSprite=e}draw(e){if(this.properties.visible){e.save(),e.globalAlpha=this.properties.alpha;for(const t in this.controlData){const s=this.controlData[t];let i=this.controlsSpriteSheetData[(s.image||t)+"_btn"],a=i[2]*this.properties.scaleX,o=i[3]*this.properties.scaleY;e.globalAlpha=this.properties.alpha*s.alpha,e.drawImage(this.controlsSpriteSheetData.images[0],...i,this.game.width-s.right*this.properties.scaleX-a/2,s.top*this.properties.scaleY-o/2,a,o)}e.restore()}}isVisible(){return this.properties.visible}hide(){this.setVisibility(!1)}show(){this.setVisibility(!0)}setVisibility(e){this.properties.visible=e}mouseOver(e){e&&(e.alpha=this.mouse.touch.down?1:.8),this.mouse.enabled=!1}mouseOut(e){e&&(e.alpha=.5),this.mouse.enabled=!0}controlDown(e){let t=this.playerManager.firstPlayer.getGamepad();if(e.target.buttonDetails.key&&t.setButtonDown(e.target.buttonDetails.key),e.target.buttonDetails.keys)for(var s=e.target.buttonDetails.keys,i=s.length,a=0;i>a;a++)t.setButtonDown(s[a]);e.target.buttonDetails.downCallback&&e.target.buttonDetails.downCallback(e),this.settings.mobile&&(this.mouse.enabled=!1),e.target.alpha=1}controlUp(e){var t=e.target,s=t.buttonDetails,i=this.playerManager.firstPlayer.getGamepad();if(s.key){var a=s.key;i.setButtonUp(a)}if(s.keys)for(var o=s.keys,r=o.length,n=0;r>n;n++)a=o[n],i.setButtonUp(a);s.upCallback&&s.upCallback(e),this.settings.mobile?(this.mouse.enabled=!0,t.alpha=.5):t.alpha=.8}click(){}close(){}update(){for(const e in this.controlData){const t=this.controlData[e];this.isMouseOverComponent(t)?(this.mouseOver(t),t.hovering=!0):t.hovering&&!this.mouse.enabled&&(this.mouseOut(t),delete t.hovering)}}resize(){let e=this.scene.game,t=e.width,s=e.height;this.properties.scaleX=this.properties.scaleY=window.devicePixelRatio/2,this.properties.bottom&&(this.properties.y=s-this.properties.bottom*this.properties.scaleY),this.properties.left&&(this.properties.x=this.properties.left*this.properties.scaleX),this.properties.right&&(this.properties.x=t-this.properties.right*this.properties.scaleX),this.properties.top&&(this.properties.y=this.properties.top*this.properties.scaleY);for(const e in this.controlData){const i=this.controlData[e];i.scaleX=i.scaleY=window.devicePixelRatio/2,i.bottom&&(i.y=s-i.bottom*i.scaleY),i.left&&(i.x=i.left*i.scaleX),i.right&&(i.x=t-i.right*i.scaleX),i.top&&(i.y=i.top*i.scaleY)}}},K=class extends J{name="pause_controls";paused=!1;controlsSpriteSheetData={pause_btn:[230,2,76,76],play_btn:[78,2,76,76]};controlData={pause:{alpha:.5,key:"pause",top:60,right:70,width:76,height:76}};constructor(e){super(...arguments),this.init(...arguments)}click(e=Object.values(this.controlData).find(this.isMouseOverComponent.bind(this))){for(const e in this.controlData){const t=this.controlData[e];this.isMouseOverComponent(t)&&this.scene.buttonDown(t.key)}}update(){let e=this.scene.state.paused;this.paused!==e&&(e?(this.controlData.pause.image="play",this.paused=!0):(this.controlData.pause.image="pause",this.paused=!1)),super.update()}},Q=class extends J{name="redo_undo_controls";controlsSpriteSheetData={redo_btn:[78,2,76,76],undo_btn:[2,2,76,76]};controlData={redo:{keys:["ctrl","y"],alpha:.5,top:60,right:160,width:76,height:76},undo:{keys:["ctrl","z"],alpha:.5,top:60,right:240,width:76,height:76}};constructor(e){super(...arguments),this.init(...arguments)}click(e=Object.values(this.controlData).find(this.isMouseOverComponent.bind(this))){for(const e in this.controlData){const t=this.controlData[e];this.isMouseOverComponent(t)&&this.playerManager.firstPlayer._gamepad.setButtonsDown(t.keys)}}update(){let e=this.scene,t=e.state.paused;e.controls&&this.properties.visible!==t&&(this.properties.visible=t),super.update()}},ee=class{name="";toolhandler=null;camera=null;mouse=null;scene=null;constructor(e){this.toolhandler=e,this.scene=e.scene,this.game=e.scene.game,this.camera=e.scene.camera,this.mouse=e.scene.mouse,this.gamepad=e.gamepad}press(){}hold(){}release(){}update(){var e=this.mouse,t=e.touch,s=e.secondaryTouch,i=this.toolhandler.gamepad,a=this.toolhandler.options,o=i.isButtonDown("shift");a.rightClickMove&&(o=s.old.down),o?(t.old.down||a.rightClickMove)&&this.moveCamera():(t.press&&this.press(),t.old.down&&this.hold(),t.release&&this.release()),!1!==e.mousewheel&&!1===i.isButtonDown("shift")&&this.mousewheel(e.mousewheel)}moveCamera(){var e=this.mouse.secondaryTouch,t=e.pos,s=this.camera,i=e.old.pos.sub(t).factor(1/s.zoom);s.position.inc(i)}draw(){}reset(){}mousewheel(e){var t=this.scene.settings,s=this.scene.game.pixelRatio,i=t.cameraSensitivity,a=t.cameraZoomMin,o=t.cameraZoomMax,r=a*s,n=o*s,h=this.camera,l=this.mouse.touch,c=h.desiredZoom;c+=e*i,h.setZoom(c/s,l.pos),h.desiredZoom<r?h.setZoom(a,l.pos):h.desiredZoom>n&&h.setZoom(o,l.pos)}checkKeys(){var e=this.gamepad,t=this.name.toLowerCase(),s=this.toolhandler;e.isButtonDown(t)&&(s.setTool(t),e.setButtonUp(t))}getOptions(){return{}}close(){}},te=class extends ee{name="Brush";p1=null;p2=null;active=!1;options=null;constructor(e){super(e),this.p1=new s(0,0),this.p2=new s(0,0),this.active=!1;var t=e.scene.settings.brush;this.addedObjects=[],this.options={breakLength:t.breakLength,maxBreakLength:t.maxBreakLength,minBreakLength:t.minBreakLength,breakLengthSensitivity:t.breakLengthSensitivity,trailSpeed:t.trailSpeed,maxTrailSpeed:t.maxTrailSpeed,minTrailSpeed:t.minTrailSpeed,trailSpeedSensitivity:t.trailSpeedSensitivity}}reset(){this.recordActionsToToolhandler(),this.active=!1}recordActionsToToolhandler(){var e,t=this.addedObjects,s=t.length;if(s)for(e=0;s>e;e++)this.toolhandler.addActionToTimeline({type:"add",objects:[t[e]]});this.addedObjects=[]}press(){if(this.recordActionsToToolhandler(),!this.active){var e=this.mouse.touch.real;this.p1.x=e.x,this.p1.y=e.y,this.p2.x=e.x,this.p2.y=e.y,this.active=!0}}hold(){var e=this.mouse.touch.real,t=this.p1,s=this.p2,i=this.options.trailSpeed,a=this.options.breakLength;s.inc(e.sub(s).factor(i));var o=screen.height+e.sub(s).len();if(o*=a,s.sub(t).lenSqr()>o){var r,n=this.scene.track;(r="physics"===this.toolhandler.options.lineType?n.addPhysicsLine(t.x,t.y,s.x,s.y):n.addSceneryLine(t.x,t.y,s.x,s.y))&&this.addedObjects.push(r),t.equ(s),this.toolhandler.snapPoint.x=s.x,this.toolhandler.snapPoint.y=s.y}this.toolhandler.moveCameraTowardsMouse()}release(){var e,t=this.p1,s=this.p2,i=this.scene.track;(e="physics"===this.toolhandler.options.lineType?i.addPhysicsLine(t.x,t.y,s.x,s.y):i.addSceneryLine(t.x,t.y,s.x,s.y))&&this.addedObjects.push(e),this.recordActionsToToolhandler();var a=this.toolhandler.snapPoint;a.x=s.x,a.y=s.y,this.active=!1}update(){var e=this.toolhandler.gamepad,t=this.mouse;e.isButtonDown("alt")?!1!==t.mousewheel&&this.adjustTrailSpeed(t.mousewheel):e.isButtonDown("shift")&&!1!==t.mousewheel&&this.adjustBreakLength(t.mousewheel);var s=this.toolhandler;s.options.snap&&(this.active=!0,this.p1.x=s.snapPoint.x,this.p1.y=s.snapPoint.y,this.p2.x=t.touch.real.x,this.p2.y=t.touch.real.y),super.update()}adjustTrailSpeed(e){var t=this.options.trailSpeed,s=this.options.trailSpeedSensitivity,i=this.options.maxTrailSpeed,a=this.options.minTrailSpeed;e>0?(t+=s)>i&&(t=i):a>(t-=s)&&(t=a),this.setOption("trailSpeed",t)}adjustBreakLength(e){var t=this.options.breakLength,s=this.options.breakLengthSensitivity,i=this.options.maxBreakLength,a=this.options.minBreakLength;e>0?(t+=s)>i&&(t=i):a>(t-=s)&&(t=a),this.setOption("breakLength",t)}setOption(e,t){this.options[e]=t}getOptions(){var e=this.toolhandler,t=this.options;return t.lineType=e.options.lineType,t.snap=e.options.snap,t}draw(e){var t=this.scene.camera.zoom;this.drawCursor(e),this.active&&(this.drawLine(e,t),this.drawPoint(e,this.p1,t),this.drawPoint(e,this.p2,t))}drawText(e){var t=this.name,s=this.options.breakLength,i=this.options.trailSpeed,a=this.game.pixelRatio;e.fillStyle="dark"===window.lite.storage.get("theme")?"#FBFBFB":"#000",e.font=12*a+"pt arial",e.fillText(t,10*a,20*a),e.font=8*a+"pt arial",i|=0,e.fillText("Trail speed : "+i,10*a,40*a),e.fillText("Break length : "+s,10*a,60*a)}drawCursor(e){var t=this.mouse.touch.real.toScreen(this.scene),s=this.camera.zoom;if(this.toolhandler.options.grid){var i=5*s;e.beginPath(),e.moveTo(t.x,t.y-i),e.lineTo(t.x,t.y+i),e.moveTo(t.x-i,t.y),e.lineTo(t.x+i,t.y),e.lineWidth=1*s,e.stroke()}else e.beginPath(),e.arc(t.x,t.y,1*s,0,2*Math.PI,!1),e.lineWidth=1,e.fillStyle="#1884cf",e.fill()}drawPoint(e,t,s){var i=t.toScreen(this.scene);e.beginPath(),e.arc(i.x,i.y,1*s,0,2*Math.PI,!1),e.lineWidth=1,e.fillStyle="#1884cf",e.fill()}drawLine(e,t){this.scene;var s=2*t>.5?2*t:.5,i="physics"===this.toolhandler.options.lineType?"midnight"===window.lite.storage.get("theme")?"#ddd":"dark"===window.lite.storage.get("theme")?"#fff":"#000":"midnight"===window.lite.storage.get("theme")?"#888":"dark"===window.lite.storage.get("theme")?"#666":"#aaa";e.beginPath(),e.lineWidth=s,e.lineCap="round",e.strokeStyle=i;var a=this.p1.toScreen(this.scene),o=this.p2.toScreen(this.scene);e.moveTo(a.x,a.y),e.lineTo(o.x,o.y),e.stroke()}},se=class extends ee{name="Camera";hold(){var e=this.mouse.touch,t=e.pos,s=this.camera,i=e.old.pos.sub(t).factor(1/s.zoom);s.position.inc(i)}drawText(e){e.fillStyle="dark"===window.lite.storage.get("theme")?"#fbfbfb":"#000000",e.font=12*this.game.pixelRatio+"pt arial",e.fillText(this.name,10*this.game.pixelRatio,20*this.game.pixelRatio),e.font=8*this.game.pixelRatio+"pt arial"}};function ie(e,t,s){function i(e,t,s,a,o,r,n){if(!(n>p)){var h=(e+s)/2,l=(t+a)/2,y=(s+o)/2,w=(a+r)/2,v=(h+y)/2,f=(l+w)/2,x=o-e,T=r-t,b=Math.abs((s-o)*T-(a-r)*x);if(b>u){if(d*(x*x+T*T)>=b*b){if(m>g)return void c.push(v,f);var k=Math.abs(Math.atan2(r-a,o-s)-Math.atan2(a-t,s-e));if(k>=Math.PI&&(k=2*Math.PI-k),g>k)return void c.push(v,f)}}else if(d>=(x=v-(e+o)/2)*x+(T=f-(t+r)/2)*T)return void c.push(v,f);i(e,t,h,l,v,f,n+1),i(v,f,y,w,o,r,n+1)}}var a=e.x,o=e.y,r=t.x,n=t.y,h=s.x,l=s.y,c=[],d=.25,p=10,u=1e-30,g=0,m=.01;return function(e,t,s,a,o,r){c.push(e,t),i(e,t,s,a,o,r,0),c.push(o,r)}(a,o,r,n,h,l),c}const ae=class extends ee{name="Curve";active=!1;p1=null;p2=null;midpoint=null;anchoring=!1;options=null;constructor(e){super(e),this.p1=new s(0,0),this.p2=new s(0,0),this.midpoint=new s(0,0),this.active=!1,this.options={}}getOptions(){var e=this.toolhandler,t=this.options;return t.lineType=e.options.lineType,t.snap=e.options.snap,t}reset(){this.active=!1,this.anchoring=!1}press(){if(!this.active){this.active=!0;var e=this.mouse.touch.real;this.p1.x=e.x,this.p1.y=e.y}}hold(){var e=this.mouse.touch.real;this.p2.x=e.x,this.p2.y=e.y;var t=this.p1,s=this.p2;this.midpoint.x=(t.x+s.x)/2,this.midpoint.y=(t.y+s.y)/2,this.toolhandler.moveCameraTowardsMouse()}release(){var e=this.p1,t=this.p2,s=this.midpoint,i=this.toolhandler;if(this.anchoring){if(s.x===t.x&&s.y===t.y){var a,o=this.scene.track;(a="physics"===i.options.lineType?o.addPhysicsLine(e.x,e.y,t.x,t.y):o.addSceneryLine(e.x,e.y,t.x,t.y))&&i.addActionToTimeline({type:"add",objects:[a]}),i.snapPoint.x=t.x,i.snapPoint.y=t.y}else this.splitAndAddCurve();this.anchoring=!1,this.active=!1}else{var r=t.x-e.x,n=t.y-e.y;Math.sqrt(Math.pow(r,2)+Math.pow(n,2))>0?this.anchoring=!0:this.active=!1}}updateAnchor(){var e=this.mouse.touch.real;this.midpoint.x=e.x,this.midpoint.y=e.y}splitAndAddCurve(){for(var e=ie(this.p1,this.midpoint,this.p2),t=this.scene.track,s=e.length,i=this.toolhandler,a=[],o=0;s-2>o;o+=2){var r,n=e[o],h=e[o+1],l=e[o+2],c=e[o+3];(r="physics"===i.options.lineType?t.addPhysicsLine(n,h,l,c):t.addSceneryLine(n,h,l,c))&&a.push(r),i.snapPoint.x=l,i.snapPoint.y=c}a.length>0&&i.addActionToTimeline({type:"add",objects:a})}update(){var e=this.mouse,t=e.touch,s=e.secondaryTouch,i=this.toolhandler.gamepad,a=this.toolhandler;a.options.snap&&(this.active=!0,this.p1=a.snapPoint,this.anchoring||this.hold());var o=this.toolhandler.options,r=i.isButtonDown("shift");o.rightClickMove&&(r=s.old.down),r?(t.old.down||o.rightClickMove)&&this.moveCamera():(t.press&&!this.anchoring&&this.press(),t.old.down&&!this.anchoring&&this.hold(),t.release&&this.release(),this.anchoring&&this.updateAnchor()),!1!==e.mousewheel&&!1===i.isButtonDown("shift")&&this.mousewheel(e.mousewheel)}draw(e){var t=this.scene.camera.zoom;this.drawCursor(e,t),this.active&&(this.drawLine(e,t),this.drawPoint(e,this.p1,t),this.drawPoint(e,this.p2,t))}toScreen(e,t){var s=this.scene.camera,i=this.scene.screen;return(e-s.position[t])*s.zoom+i.center[t]}drawCursor(e,t){var s=this.mouse.touch.real.toScreen(this.scene);if(this.toolhandler.options.grid){var i=5*t;e.beginPath(),e.moveTo(s.x,s.y-i),e.lineTo(s.x,s.y+i),e.moveTo(s.x-i,s.y),e.lineTo(s.x+i,s.y),e.lineWidth=1*t,e.stroke()}else e.beginPath(),e.arc(s.x,s.y,1*t,0,2*Math.PI,!1),e.lineWidth=1,e.fillStyle="#1884cf",e.fill()}drawPoint(e,t,s){var i=t.toScreen(this.scene);e.beginPath(),e.arc(i.x,i.y,1*s,0,2*Math.PI,!1),e.lineWidth=1,e.fillStyle="#1884cf",e.fill()}drawText(e){var t=this.name,s=this.game.pixelRatio;e.fillStyle="dark"===window.lite.storage.get("theme")?"#FBFBFB":"#000",e.font=12*s+"pt arial",e.fillText(t,10*s,20*s),e.font=8*s+"pt arial"}drawLine(e,t){var s=(this.scene.game.canvas,2*t>.5?2*t:.5),i="physics"===this.toolhandler.options.lineType?"midnight"===window.lite.storage.get("theme")?"#ccc":"dark"===window.lite.storage.get("theme")?"#fbfbfb":"#000":"midnight"===window.lite.storage.get("theme")?"#888":"dark"===window.lite.storage.get("theme")?"#666":"#aaa";e.beginPath(),e.lineWidth=s,e.lineCap="round",e.strokeStyle=i;var a=this.p1.toScreen(this.scene),o=this.p2.toScreen(this.scene),r=this.midpoint.toScreen(this.scene);e.moveTo(a.x,a.y),e.quadraticCurveTo(r.x,r.y,o.x,o.y),e.stroke()}},oe=class extends ee{name="Eraser";options=null;constructor(e){super(e),this.options=e.scene.settings.eraser,this.eraserPoint=new s,this.erasedObjects=[]}reset(){this.recordActionsToToolhandler()}press(){this.recordActionsToToolhandler()}recordActionsToToolhandler(){this.erasedObjects.length>0&&this.toolhandler.addActionToTimeline({type:"remove",objects:this.erasedObjects.flatMap((e=>e))}),this.erasedObjects=[]}release(){this.recordActionsToToolhandler()}hold(){var e=this.mouse.touch.pos,t=this.scene.track,s=this.scene.screen,i=this.scene.camera,a=s.center,o=i.position,r=(e.x-a.x)/i.zoom+o.x,n=(e.y-a.y)/i.zoom+o.y;this.eraserPoint.x=Math.round(r),this.eraserPoint.y=Math.round(n);var h=t.erase(this.eraserPoint,this.options.radius/this.scene.camera.zoom,this.options.types);h.length>0&&this.erasedObjects.push(h)}draw(e){this.drawEraser(e)}drawEraser(e){var t=this.mouse.touch.pos;e.save(),e.beginPath(),e.arc(t.x,t.y,this.options.radius,0,2*Math.PI,!1),e.lineWidth=1,e.fillStyle="dark"===window.lite.storage.get("theme")?"rgba(33,33,33,0.8)":"rgba(255,255,255,0.8)",e.fill(),e.strokeStyle="dark"===window.lite.storage.get("theme")?"#fbfbfb":"#000",e.stroke(),e.restore()}setOption(e,t){this.options[e]=t}getOptions(){return this.options}update(){var e=this.toolhandler.gamepad,t=this.mouse;e.isButtonDown("shift")&&!1!==t.mousewheel&&this.adjustRadius(t.mousewheel),super.update()}adjustRadius(e){var t=this.options.radius,s=this.options.radiusSizeSensitivity,i=this.options.maxRadius,a=this.options.minRadius;a>(t+=e>0?s:-s)?t=a:t>i&&(t=i),this.setOption("radius",t)}},re=class extends ee{powerup=null;name="antigravity";p1=null;p2=null;active=!1;constructor(e){super(e),this.powerup=new r(0,0,e.scene.track),this.p1=new s(0,0),this.p2=new s(0,0),this.active=!1}draw(e){var t=this.mouse.touch,s=this.camera.zoom,i=this.scene.settings.device,a=this.scene.screen;if(!0===this.active){var o=a.realToScreen(this.p1.x,"x"),r=a.realToScreen(this.p1.y,"y");e.globalAlpha=.4,this.powerup.draw(o,r,s,e),e.globalAlpha=1}else"desktop"===i&&(o=a.realToScreen(t.real.x,"x"),r=a.realToScreen(t.real.y,"y"),e.globalAlpha=.8,this.powerup.draw(o,r,s,e),e.globalAlpha=1)}press(){var e=this.mouse.touch.real;this.p1.x=e.x,this.p1.y=e.y;var t=this.scene.track,s=new r(this.p1.x,this.p1.y,t);t.addPowerup(s),this.toolhandler.addActionToTimeline({type:"add",objects:[s]})}},ne=class extends ee{powerup=null;name="bomb";p1=null;p2=null;active=!1;constructor(e){super(e),this.powerup=new n(0,0,e.scene.track),this.p1=new s(0,0),this.p2=new s(0,0),this.active=!1}draw(e){var t=this.mouse.touch,s=(t.pos,this.camera.zoom),i=this.scene.settings.device,a=this.scene.screen;if(!0===this.active){var o=a.realToScreen(this.p1.x,"x"),r=a.realToScreen(this.p1.y,"y");e.globalAlpha=.4,this.powerup.draw(o,r,s,e),e.globalAlpha=1}else"desktop"===i&&(o=a.realToScreen(t.real.x,"x"),r=a.realToScreen(t.real.y,"y"),e.globalAlpha=.8,this.powerup.draw(o,r,s,e),e.globalAlpha=1)}press(){var e=this.mouse.touch.real;this.p1.x=e.x,this.p1.y=e.y,this.p2.x=e.x,this.p2.y=e.y,this.active=!0}hold(){var e=this.mouse.touch.real;this.p2.x=e.x,this.p2.y=e.y}release(){var e=(this.scene.screen,this.scene.track),t=new n(this.p1.x,this.p1.y,e);e.addPowerup(t),this.active=!1,this.toolhandler.addActionToTimeline({type:"add",objects:[t]})}},he=class extends ee{powerup=null;name="boost";p1=null;p2=null;active=!1;constructor(e){super(e),this.powerup=new h(0,0,0,e.scene.track),this.p1=new s(0,0),this.p2=new s(0,0),this.active=!1}press(){var e=this.mouse.touch.real;this.p1.x=e.x,this.p1.y=e.y,this.p2.x=e.x,this.p2.y=e.y,this.active=!0}hold(){var e=this.mouse.touch.real;this.p2.x=e.x,this.p2.y=e.y}release(){var e=this.scene.track,t=new h(this.p1.x,this.p1.y,this.powerup.angle,e);e.addPowerup(t),this.active=!1,this.toolhandler.addActionToTimeline({type:"add",objects:[t]})}draw(e){var t=this.mouse.touch,s=this.camera.zoom,i=this.scene.screen,a=this.scene.settings.device;if(!0===this.active){var o=i.realToScreen(this.p1.x,"x"),r=i.realToScreen(this.p1.y,"y"),n=this.p1,h=this.p2,l=n.y-h.y,c=n.x-h.x,d=Math.atan2(n.y-h.y,n.x-h.x);0===c&&0===l&&(d=Math.PI-Math.PI/2),0>d&&(d+=2*Math.PI),this.drawPathToMouse(e,d),this.powerup.angle=d*(180/Math.PI)-90|0,this.powerup.draw(o,r,s,e)}else"desktop"===a&&(e.globalAlpha=.8,this.powerup.angle=0,o=i.realToScreen(t.real.x,"x"),r=i.realToScreen(t.real.y,"y"),this.powerup.draw(o,r,s,e),e.globalAlpha=1)}drawPathToMouse(e,t){var s=this.p1,i=this.p2,a=this.scene.screen,o=this.scene.camera.zoom,r=a.realToScreen(s.x,"x"),n=a.realToScreen(s.y,"y"),h=a.realToScreen(i.x,"x"),l=a.realToScreen(i.y,"y"),c=Math.sqrt(Math.pow(h-r,2)+Math.pow(l-n,2));30*o>c&&(c=30*o),e.strokeStyle="#ADCF7D",e.lineWidth=Math.max(1,2*o),e.beginPath(),e.moveTo(r,n),e.lineTo(r+c,n),e.stroke(),e.beginPath(),e.moveTo(r,n),e.lineTo(h,l),e.stroke(),e.closePath();var d=t+Math.PI/180*180,p=Math.min(c,50*o);e.beginPath(),e.moveTo(r,n),e.arc(r,n,p,d,0,!1),e.moveTo(r,n),e.stroke(),e.fillStyle="rgba(173, 207, 125,0.2)",e.fill(),e.closePath()}},le=class extends ee{powerup=null;name="checkpoint";p1=null;p2=null;active=!1;constructor(e){super(e),this.powerup=new l(0,0,e.scene.track),this.p1=new s(0,0),this.p2=new s(0,0),this.active=!1}draw(e){var t=this.mouse.touch,s=(t.pos,this.camera.zoom),i=this.scene.settings.device,a=this.scene.screen;if(!0===this.active){var o=a.realToScreen(this.p1.x,"x"),r=a.realToScreen(this.p1.y,"y");e.globalAlpha=.4,this.powerup.draw(o,r,s,e),e.globalAlpha=1}else"desktop"===i&&(o=a.realToScreen(t.real.x,"x"),r=a.realToScreen(t.real.y,"y"),e.globalAlpha=.8,this.powerup.draw(o,r,s,e),e.globalAlpha=1)}press(){var e=this.mouse.touch.real;this.p1.x=e.x,this.p1.y=e.y,this.p2.x=e.x,this.p2.y=e.y,this.active=!0}hold(){var e=this.mouse.touch.real;this.p2.x=e.x,this.p2.y=e.y}release(){var e=(this.scene.screen,this.scene.track),t=new l(this.p1.x,this.p1.y,e);e.addPowerup(t),this.active=!1,this.toolhandler.addActionToTimeline({type:"add",objects:[t]})}},ce=class extends ee{powerup=null;name="goal";p1=null;p2=null;active=!1;constructor(e){super(e),this.powerup=new p(0,0,e.scene.track),this.p1=new s(0,0),this.p2=new s(0,0),this.active=!1}draw(e){var t=this.mouse.touch,s=this.camera.zoom,i=this.scene.settings.device,a=this.scene.screen;if(!0===this.active){var o=a.realToScreen(this.p1.x,"x"),r=a.realToScreen(this.p1.y,"y");e.globalAlpha=.4,this.powerup.draw(o,r,s,e),e.globalAlpha=1}else"desktop"===i&&(o=a.realToScreen(t.real.x,"x"),r=a.realToScreen(t.real.y,"y"),e.globalAlpha=.8,this.powerup.draw(o,r,s,e),e.globalAlpha=1)}press(){var e=this.mouse.touch.real;this.p1.x=e.x,this.p1.y=e.y,this.p2.x=e.x,this.p2.y=e.y,this.active=!0}hold(){var e=this.mouse.touch.real;this.p2.x=e.x,this.p2.y=e.y}release(){var e=this.scene.track,t=new p(this.p1.x,this.p1.y,e);e.addTarget(t),e.addPowerup(t),this.active=!1,this.toolhandler.addActionToTimeline({type:"add",objects:[t]})}},de=class extends ee{powerup=null;name="gravity";p1=null;p2=null;active=!1;constructor(e){super(e),this.powerup=new c(0,0,0,e.scene.track),this.p1=new s(0,0),this.p2=new s(0,0),this.active=!1}press(){var e=this.mouse.touch.real;this.p1.x=e.x,this.p1.y=e.y,this.p2.x=e.x,this.p2.y=e.y,this.active=!0}hold(){var e=this.mouse.touch.real;this.p2.x=e.x,this.p2.y=e.y}release(){var e=this.scene.track,t=new c(this.p1.x,this.p1.y,this.powerup.angle-180,e);e.addPowerup(t),this.active=!1,this.toolhandler.addActionToTimeline({type:"add",objects:[t]})}draw(e){var t=this.mouse.touch,s=(t.pos,this.camera.zoom),i=this.scene.screen,a=this.scene.settings.device;if(!0===this.active){var o=i.realToScreen(this.p1.x,"x"),r=i.realToScreen(this.p1.y,"y"),n=this.p1,h=this.p2,l=n.y-h.y,c=n.x-h.x,d=Math.atan2(n.y-h.y,n.x-h.x);0===c&&0===l&&(d=Math.PI-Math.PI/2),0>d&&(d+=2*Math.PI),this.drawPathToMouse(e,d),this.powerup.angle=d*(180/Math.PI)+90|0,this.powerup.draw(o,r,s,e)}else"desktop"===a&&(e.globalAlpha=.8,this.powerup.angle=180,o=i.realToScreen(t.real.x,"x"),r=i.realToScreen(t.real.y,"y"),this.powerup.draw(o,r,s,e),e.globalAlpha=1)}drawPathToMouse(e,t){var s=this.p1,i=this.p2,a=this.scene.screen,o=this.scene.camera.zoom,r=a.realToScreen(s.x,"x"),n=a.realToScreen(s.y,"y"),h=a.realToScreen(i.x,"x"),l=a.realToScreen(i.y,"y"),c=Math.sqrt(Math.pow(h-r,2)+Math.pow(l-n,2));30*o>c&&(c=30*o),e.strokeStyle="#A2B7D2",e.lineWidth=Math.max(1,2*o),e.beginPath(),e.moveTo(r,n),e.lineTo(r+c,n),e.stroke(),e.beginPath(),e.moveTo(r,n),e.lineTo(h,l),e.stroke(),e.closePath();var d=t+Math.PI/180*180,p=Math.min(c,50*o);e.beginPath(),e.moveTo(r,n),e.arc(r,n,p,d,0,!1),e.moveTo(r,n),e.stroke(),e.fillStyle="rgba(162, 183, 210,0.2)",e.fill(),e.closePath()}},pe=class extends ee{powerup=null;name="slowmo";p1=null;p2=null;active=!1;constructor(e){super(e),this.powerup=new d(0,0,e.scene.track),this.p1=new s(0,0),this.p2=new s(0,0),this.active=!1}draw(e){var t=this.mouse.touch,s=(t.pos,this.camera.zoom),i=this.scene.settings.device,a=this.scene.screen;if(!0===this.active){var o=a.realToScreen(this.p1.x,"x"),r=a.realToScreen(this.p1.y,"y");e.globalAlpha=.4,this.powerup.draw(o,r,s,e),e.globalAlpha=1}else"desktop"===i&&(o=a.realToScreen(t.real.x,"x"),r=a.realToScreen(t.real.y,"y"),e.globalAlpha=.8,this.powerup.draw(o,r,s,e),e.globalAlpha=1)}press(){var e=this.mouse.touch.real;this.p1.x=e.x,this.p1.y=e.y,this.p2.x=e.x,this.p2.y=e.y,this.active=!0}hold(){var e=this.mouse.touch.real;this.p2.x=e.x,this.p2.y=e.y}release(){var e=(this.scene.screen,this.scene.track),t=new d(this.p1.x,this.p1.y,e);e.addPowerup(t),this.active=!1,this.toolhandler.addActionToTimeline({type:"add",objects:[t]})}},ue=class extends ee{powerup=null;name="teleport";p1=null;p2=null;active=!1;constructor(e){super(e),this.powerup=new u(0,0,e.scene.track),this.p1=new s(0,0),this.p2=new s(0,0),this.active=!1}press(){var e=this.mouse.touch.real,t=(this.scene.screen,this.scene.track);this.p1.x=e.x,this.p1.y=e.y,this.portal1=new u(this.p1.x,this.p1.y,t),this.active=!0}hold(){var e=this.mouse.touch.real;this.p2.x=e.x,this.p2.y=e.y}release(){var e=Math.abs(this.p2.x-this.p1.x),t=Math.abs(this.p2.y-this.p1.y);if(e>40||t>40){var s=this.scene.track;this.portal2=new u(this.p2.x,this.p2.y,s),this.portal1.addOtherPortalRef(this.portal2),this.portal2.addOtherPortalRef(this.portal1),s.addPowerup(this.portal1),s.addPowerup(this.portal2),this.toolhandler.addActionToTimeline({type:"add",objects:[this.portal1,this.portal2]}),this.active=!1}else this.active=!1,this.portal1=null}draw(e){var t=this.mouse.touch,s=(t.pos,this.camera.zoom),i=this.scene.screen,a=this.scene.settings.device;if(!0===this.active){var o=i.realToScreen(this.p1.x,"x"),r=i.realToScreen(this.p1.y,"y"),n=i.realToScreen(this.p2.x,"x"),h=i.realToScreen(this.p2.y,"y"),l=this.p1,c=this.p2,d=l.y-c.y,p=l.x-c.x,u=Math.atan2(l.y-c.y,l.x-c.x);0===p&&0===d&&(u=Math.PI-Math.PI/2),0>u&&(u+=2*Math.PI),this.drawPathToMouse(e,u),this.portal1.draw(o,r,s,e),this.powerup.draw(n,h,s,e)}else if("desktop"===a){e.globalAlpha=.8;var g=i.realToScreen(t.real.x,"x"),m=i.realToScreen(t.real.y,"y");this.powerup.draw(g,m,s,e),e.globalAlpha=1}}drawPathToMouse(e){var t=this.p1,s=this.p2,i=this.scene.screen,a=this.scene.camera.zoom,o=i.realToScreen(t.x,"x"),r=i.realToScreen(t.y,"y"),n=i.realToScreen(s.x,"x"),h=i.realToScreen(s.y,"y"),l=Math.sqrt(Math.pow(n-o,2)+Math.pow(h-r,2));30*a>l&&(l=30*a),e.strokeStyle="#dd45ec",e.lineWidth=Math.max(1,2*a),e.beginPath(),e.moveTo(o,r),e.lineTo(n,h),e.stroke(),e.closePath()}},ge=class extends ee{name="Powerup";options={selected:"goal"};powerupTools={};constructor(e){super(e),this.registerPowerupTools()}registerPowerupTools(){this.registerTool(new ce(this.toolhandler)),this.registerTool(new he(this.toolhandler)),this.registerTool(new de(this.toolhandler)),this.registerTool(new pe(this.toolhandler)),this.registerTool(new ne(this.toolhandler)),this.registerTool(new le(this.toolhandler)),this.registerTool(new re(this.toolhandler)),this.registerTool(new ue(this.toolhandler))}registerTool(e){this.powerupTools[e.name]=e}setOption(e,t){this.options[e]=t}getOptions(){return this.options}update(){var e=this.toolhandler.gamepad,t=this.options;e.isButtonDown("opt1")&&(t.selected="goal",e.setButtonUp("opt1"),this.scene.stateChanged()),e.isButtonDown("opt2")&&(t.selected="boost",e.setButtonUp("opt2"),this.scene.stateChanged()),e.isButtonDown("opt3")&&(t.selected="gravity",e.setButtonUp("opt3"),this.scene.stateChanged()),e.isButtonDown("opt4")&&(t.selected="slowmo",e.setButtonUp("opt4"),this.scene.stateChanged()),e.isButtonDown("opt5")&&(t.selected="bomb",e.setButtonUp("opt5"),this.scene.stateChanged()),e.isButtonDown("opt6")&&(t.selected="checkpoint",e.setButtonUp("opt6"),this.scene.stateChanged()),e.isButtonDown("opt7")&&(t.selected="antigravity",e.setButtonUp("opt7"),this.scene.stateChanged()),e.isButtonDown("opt8")&&Application.User.get("classic")&&(t.selected="teleport",e.setButtonUp("opt8"),this.scene.stateChanged()),super.update()}press(){var e=this.options.selected;this.powerupTools[e].press()}hold(){var e=this.options.selected;this.powerupTools[e].hold()}release(){var e=this.options.selected;this.powerupTools[e].release()}draw(e){this.powerupTools[this.options.selected].draw(e)}},me=class{start=null;end=null;verticies=[];build(e){var t=e.pop();this.start=t.p1,this.end=t.p2,this.verticies.push(t);for(var s=e.length-1;s>=0;s--){var i=e[s],a=i.p1,o=i.p2;this.start.x===o.x&&this.start.y===o.y?(this.verticies.unshift(i),this.start=i.p1,e.splice(s,1)):this.end.x===a.x&&this.end.y===a.y&&(this.verticies.push(i),this.end=i.p2,e.splice(s,1))}}},ye=class extends ee{name="Select";passive=!1;active=!1;p1=null;p2=null;travelDistance=1;selectedElements=[];selectedSegments=[];constructor(e){super(e),this.p1=new s(0,0),this.p2=new s(0,0),this.addedObjects=[],this.selectedElements=[],this.selectedSegments=[],this.dashOffset=0}press(){var e=this.mouse.touch.real;this.passive=!1,this.active=!0,this.p1.x=e.x,this.p1.y=e.y,this.p2.x=e.x,this.p2.y=e.y}hold(){var e=this.mouse.touch.real;this.p2.x=e.x,this.p2.y=e.y}unselectElements(){this.selectedElements=[],this.selectedSegments=[]}moveSelected(e){for(const t in this.selectedSegments)this.selectedSegments.find((t=>t.otherPortal==e))?this.selectedSegments.splice(selectedSegments.indexOf(e),1):(this.selectedSegments[t]=this.selectedSegments[t].move("ArrowLeft"==e?-this.travelDistance:"ArrowRight"==e?this.travelDistance:0,"ArrowUp"==e?-this.travelDistance:"ArrowDown"==e?this.travelDistance:0),this.scene.track.undraw())}fillSelected(){if(this.p1.y<this.p2.y)for(let e=this.p1.y;e<this.p2.y;e++)this.selectedSegments.push(this.scene.track.addPhysicsLine(this.p1.x,e,this.p2.x,e));else for(let e=this.p2.y;e<this.p1.y;e++)this.selectedSegments.push(this.scene.track.addPhysicsLine(this.p2.x,e,this.p1.x,e));this.selectedElements.push(...this.selectedSegments),this.selectedSegments.length>0&&this.toolhandler.addActionToTimeline({type:"add",objects:this.selectedSegments.flatMap((e=>e))})}rotateSelected(){const e=(this.travelDistance||0)*Math.PI/180;let t=this.selectedSegments;this.selectedSegments=[];for(const s of t)s.p2&&!s.name&&(this.selectedSegments.push(this.scene.track["physics"==s.type?"addPhysicsLine":"addSceneryLine"](Math.cos(e)*s.p1.x+Math.sin(e)*s.p1.y,-Math.sin(e)*s.p1.x+Math.cos(e)*s.p1.y,Math.cos(e)*s.p2.x+Math.sin(e)*s.p2.y,-Math.sin(e)*s.p2.x+Math.cos(e)*s.p2.y)),s.removeAllReferences())}copyAndPasteSelected(){for(const e of this.selectedSegments)"physics"==e.type?this.scene.track.addPhysicsLine(e.p1.x,e.p1.y,e.p2.x,e.p2.y):"scenery"==e.type&&this.scene.track.addSceneryLine(e.p1.x,e.p1.y,e.p2.x,e.p2.y)}release(){this.unselectElements();for(const e of this.scene.track.select(this.p1,this.p2))this.intersectsLine(e.x?e:e.p1,e.x?e:e.p2)&&this.selectedSegments.push(e);this.selectedElements=this.selectedSegments,this.active=!1,this.passive=!0,document.onkeydown=e=>{switch(e.preventDefault(),e.key){case"=":case"+":this.travelDistance++,this.scene.message.show("Increased travel distance for the Select Tool - "+this.travelDistance,!1,"#000000","#FFFFFF");break;case"-":this.travelDistance--,this.scene.message.show("Decreased travel distance for the Select Tool - "+this.travelDistance,!1,"#000000","#FFFFFF");break;case"c":this.copyAndPasteSelected(e.key),this.scene.message.show("Copied selected area",!1,"#000000","#FFFFFF");break;case"Delete":this.selectedElements.length>0&&this.toolhandler.addActionToTimeline({type:"remove",objects:this.selectedElements.flatMap((e=>e))});for(const e of this.selectedElements)e.removeAllReferences();this.reset(),this.scene.message.show("Deleted selected area",!1,"#000000","#FFFFFF");break;case"f":confirm("Are you sure you would you like to fill the selected area?")&&(this.fillSelected(),this.scene.message.show("Filled selected area",!1,"#000000","#FFFFFF"));break;case"r":this.rotateSelected(),this.scene.message.show("Rotated selected area",!1,"#000000","#FFFFFF");break;case"ArrowUp":case"ArrowDown":case"ArrowLeft":case"ArrowRight":this.moveSelected(e.key),this.scene.message.show("Moved Selected Area",!1,"#000000","#FFFFFF");break;case"`":case"Escape":this.reset()}this.timeout=setTimeout((()=>this.scene.message.hide()),1e3)}}buildPaths(e){for(var t=[];e.length>0;){var s=new me;s.build(e),t.push(s)}}intersectsLine(e,t){var s=Math.min(this.p1.y,this.p2.y),i=Math.min(this.p1.x,this.p2.x),a=Math.max(this.p1.y,this.p2.y),o=Math.max(this.p1.x,this.p2.x),r=Math.abs(o-i),n=Math.abs(s-a),h=e.x,l=t.x;if(e.x>t.x&&(h=t.x,l=e.x),l>i+r&&(l=i+r),i>h&&(h=i),h>l)return!1;var c=e.y,d=t.y,p=t.x-e.x;if(Math.abs(p)>1e-7){var u=(t.y-e.y)/p,g=e.y-u*e.x;c=u*h+g,d=u*l+g}if(c>d){var m=d;d=c,c=m}return d>s+n&&(d=s+n),s>c&&(c=s),!(c>d)}toScreen(e,t){let s=this.scene.camera,i=this.scene.screen;return(e-s.position[t])*s.zoom+i.center[t]}draw(e){if(this.scene,this.active||this.passive){let t=this.p1.toScreen(this.scene),s=this.p2.toScreen(this.scene),i=s.x-t.x,a=s.y-t.y;e.save(),this.active?(e.beginPath(),e.rect(t.x,t.y,i,a),e.fillStyle="rgba(24, 132, 207, 0.2)",e.fill(),e.lineWidth=2,e.strokeStyle="rgba(24, 132, 207, 0.7)",e.stroke()):this.passive&&(e.strokeStyle="rgba(24, 132, 207, 0.7)",e.lineWidth=2,e.strokeRect(t.x,t.y,i,a)),e.restore()}}reset(){this.p1.x=0,this.p1.y=0,this.p2.x=0,this.p2.y=0,this.active=!1,this.passive=!1,this.unselectElements()}drawSectors(){for(var e=this.scene,t=e.camera,s=e.screen,i=e.game.canvas.getContext("2d"),a=t.zoom,o=t.position,r=e.screen.center,n=this.settings.drawSectorSize*a,h=o.x*a/n,l=o.y*a/n,c=s.width/n,d=s.height/n/2,p=c/2,u=h-p-1,g=l-d-1,m=h+p,y=l+d,w=this.totalSectors,v=w.length,f=0;v>f;f++){var x=w[f],T=x.row,b=x.column;if(b>=u&&m>=b&&T>=g&&y>=T){!1===x.drawn&&!1===x.image&&x.draw();var k=b*n-h*n+r.x,S=T*n-l*n+r.y;k|=0,S|=0,x.image?i.drawImage(x.image,k,S):i.drawImage(x.canvas,k,S)}else x.drawn&&x.clear()}}close(){this.dashOffset=0,this.selectedElements=[],this.mouse=null,this.camera=null,this.scene=null,this.toolHandler=null,this.p2=null,this.p1=null,this.active=!1,this.passive=!1}},we=class extends ee{constructor(e){super(e),this.p1=new s(0,0),this.p2=new s(0,0),this.active=!1,this.shouldDrawMetadata=!1,this.options={}}name="StraightLine";p1=null;p2=null;active=!1;reset(){this.active=!1}press(){if(!this.active){var e=this.mouse.touch.real;this.p1.x=e.x,this.p1.y=e.y,this.active=!0}}getOptions(){var e=this.toolhandler,t=this.options;return t.lineType=e.options.lineType,t.snap=e.options.snap,t}hold(){var e=this.mouse.touch.real;this.p2.x=e.x,this.p2.y=e.y,this.toolhandler.moveCameraTowardsMouse()}release(){var e,t=this.p1,s=this.p2,i=this.scene.track,a=this.toolhandler;(e="physics"===a.options.lineType?i.addPhysicsLine(t.x,t.y,s.x,s.y):i.addSceneryLine(t.x,t.y,s.x,s.y))&&a.addActionToTimeline({type:"add",objects:[e]});var o=a.snapPoint;o.x=s.x,o.y=s.y,this.active=!1}update(){super.update();var e=this.toolhandler,t=e.gamepad;e.options.snap&&(this.active=!0,this.p1=e.snapPoint,this.hold()),this.shouldDrawMetadata=!!t.isButtonDown("ctrl")}draw(e){var t=this.scene.camera.zoom;e.save(),this.drawCursor(e),this.active&&(this.drawLine(e,t),this.drawPoint(e,this.p1,t),this.drawPoint(e,this.p2,t),this.drawPointData(e,this.p2,t)),e.restore()}drawCursor(e){var t=this.mouse.touch.real.toScreen(this.scene),s=this.camera.zoom;if(this.toolhandler.options.grid){var i=5*s;e.beginPath(),e.moveTo(t.x,t.y-i),e.lineTo(t.x,t.y+i),e.moveTo(t.x-i,t.y),e.lineTo(t.x+i,t.y),e.lineWidth=1*s,e.closePath(),e.stroke()}else e.lineWidth=1,e.fillStyle="#1884cf",e.beginPath(),e.arc(t.x,t.y,1*s,0,2*Math.PI,!1),e.closePath(),e.fill()}drawPoint(e,t,s){var i=t.toScreen(this.scene);e.beginPath(),e.arc(i.x,i.y,1*s,0,2*Math.PI,!1),e.lineWidth=1,e.fillStyle="#1884cf",e.fill()}drawPointData(e,t){var s=t.toScreen(this.scene);if(this.shouldDrawMetadata){var i=this.p1.getAngleInDegrees(this.p2);i=i.toFixed(2);var a=this.game.pixelRatio;e.fillStyle="midnight"===window.lite.storage.get("theme")?"#ccc":"dark"===window.lite.storage.get("theme")?"#fbfbfb":"#000",e.font=8*a+"pt arial",e.fillText(i+"",s.x+10,s.y+10),e.strokeText(i+"",s.x+10,s.y+10)}}drawLine(e,t){var s=(this.scene.game.canvas,2*t>.5?2*t:.5),i="physics"===this.toolhandler.options.lineType?"midnight"===window.lite.storage.get("theme")?"#ccc":"dark"===window.lite.storage.get("theme")?"#fbfbfb":"#000":"midnight"===window.lite.storage.get("theme")?"#888":"dark"===window.lite.storage.get("theme")?"#666":"#aaa";e.beginPath(),e.lineWidth=s,e.lineCap="round",e.strokeStyle=i;var a=this.p1.toScreen(this.scene),o=this.p2.toScreen(this.scene);e.moveTo(a.x,a.y),e.lineTo(o.x,o.y),e.stroke()}},ve=class{currentTool="";scene=null;camera=null;mouse=null;tools={};gamepad=null;gridCache=!1;gridCacheAlpha=1;gridUseEnabled=!1;snapPoint=!1;options=null;constructor(e){this.currentTool="",this.scene=e,this.camera=e.camera,this.mouse=e.mouse,this.mouse.updateCallback=this.draw.bind(this),this.gamepad=e.playerManager.firstPlayer.getGamepad(),this.tools={},this.options=e.settings.toolHandler,this.snapPoint=new s,this.snapPoint.equ(this.scene.track.defaultLine.p2),this.gridCache=!1,this.initAnalytics(),this.actionTimeline=[],this.actionTimelinePointer=0}initAnalytics(){this.analytics={actions:0}}enableGridUse(){this.gridUseEnabled=!0}getToolOptions(){return this.tools[this.currentTool].getOptions()}setToolOption(e,t,s){void 0!==s&&void 0!==this.tools[s]?this.tools[s].setOption(e,t):this.tools[this.currentTool].setOption(e,t),this.scene.stateChanged()}registerTool(e){var t=(e=new e(this)).name.toLowerCase();this.tools[t]=e}setTool(e){e=e.toLowerCase(),this.currentTool!==e&&(this.resetTool(),this.currentTool=e,this.scene.stateChanged(),this.analytics.actions++)}addActionToTimeline(e){this.actionTimeline.length>=50&&(this.actionTimeline.splice(0,this.actionTimeline.length-50),this.actionTimelinePointer=50),this.actionTimeline.splice(this.actionTimelinePointer),this.actionTimeline.push(e),this.actionTimelinePointer++}revertAction(){var e=this.actionTimelinePointer;if(e>0){var t=this.actionTimeline[e-1];switch(e--,t.type){case"add":this.removeObjects(t.objects);break;case"remove":this.addObjects(t.objects)}this.actionTimelinePointer=e}}applyAction(){var e=this.actionTimeline,t=this.actionTimelinePointer;if(t<e.length){var s=this.actionTimeline[t];switch(t++,s.type){case"add":this.addObjects(s.objects);break;case"remove":this.removeObjects(s.objects)}this.actionTimelinePointer=t}}removeObjects(e){for(var t=e.length,s=0;t>s;s++){var i=e[s];i.remove=!0,i.removeAllReferences()}this.scene.track.cleanTrack()}addObjects(e){for(var t=e.length,s=this.scene.track,i=0;t>i;i++){var o=e[i];o instanceof a?(o.remove=!1,s.addPhysicsLineToTrack(o)):o instanceof g?(o.remove=!1,s.addSceneryLineToTrack(o)):o instanceof p?(o.remove=!1,s.addTarget(o),s.addPowerup(o)):(o.remove=!1,s.addPowerup(o))}}resetTool(){""!==this.currentTool&&this.tools[this.currentTool].reset()}update(){this.checkGrid(),this.mouse.enabled&&this.tools[this.currentTool].update(),this.checkHotkeys(),this.checkMouse(),this.checkSnap()}checkGrid(){var e=this.scene.camera;e.zoom!==e.desiredZoom&&(this.gridCache=!1)}checkSnap(){this.options.snapLocked&&(this.options.snap=!0)}moveCameraTowardsMouse(){if(!1===this.options.cameraLocked){var e=this.scene.screen,t=e.height-100,s=e.width-100,i=this.options.cameraMoveSpeed,a=e.center,o=this.camera,r=this.mouse.touch,n=r.pos.x,h=r.pos.y,l=.8*(n-a.x),c=h-a.y;(n>=s||100>=n||h>=t||100>=h)&&(o.position.x+=l*i*(1/o.zoom),o.position.y+=c*i*(1/o.zoom))}}checkMouse(){var e=this.mouse.touch,t=this.mouse.secondaryTouch;(e.press||t.press)&&this.press()}press(){this.camera.unfocus()}checkHotkeys(){var e=this.gamepad,t=this.options.snap,s=this.options.snapLocked,i=this.options.rightClickMove,a=e.isButtonDown("alt");i&&(a=e.isButtonDown("shift")),a&&!t?this.toggleQuickSnap():a||!t||s||this.toggleQuickSnap(),e.isButtonDown("ctrl")&&e.isButtonDown("z")&&(e.setButtonUp("z"),this.revertAction()),e.isButtonDown("ctrl")&&e.isButtonDown("y")&&(e.setButtonUp("y"),this.applyAction());var o=this.tools;for(var r in o)o[r].checkKeys();this.gridUseEnabled&&e.isButtonDown("grid")&&(e.setButtonUp("grid"),this.toggleGrid()),e.isButtonDown("zoom_increase")&&(e.setButtonUp("zoom_increase"),this.scene.camera.increaseZoom()),e.isButtonDown("zoom_decrease")&&(e.setButtonUp("zoom_decrease"),this.scene.camera.decreaseZoom()),e.isButtonDown("zoom_100")&&(e.setButtonUp("zoom_100"),this.scene.camera.resetZoom()),e.isButtonDown("lineType")&&(e.setButtonUp("lineType"),this.toggleLineType())}toggleLineType(){var e=this.options.lineType;this.options.lineType="physics"===e?"scenery":"physics",this.scene.stateChanged()}toggleGrid(){this.options.grid=this.scene.state.grid=!this.options.grid,this.scene.stateChanged()}toggleSnap(){this.options.snap=!this.options.snap,this.options.snapLocked=!this.options.snapLocked,this.resetTool(),this.scene.stateChanged()}toggleQuickSnap(){this.options.snapLocked||(this.options.snap=!this.options.snap,this.resetTool(),this.scene.stateChanged())}toggleCameraLock(){this.options.cameraLocked=!this.options.cameraLocked,this.scene.stateChanged()}draw(e){this.mouse.enabled&&this.tools[this.currentTool].draw(e)}drawGrid(e){var t=this.scene.game.pixelRatio;!0===this.options.grid&&this.options.visibleGrid&&(lite.storage.get("isometricGrid")?this.drawCachedIsometricGrid(e,t):this.drawCachedGrid(e,t))}drawCachedGrid(e,t){!1===this.gridCache&&this.cacheGrid(t);var s=this.gridCache,i=s.width,a=s.height,o=this.scene.screen.center,r=2+(o.x/i|0),n=2+(o.y/a|0),h=this.camera.zoom,l=this.camera.position.x*h%i,c=this.camera.position.y*h%a;e.globalAlpha=this.gridCacheAlpha;for(var d=-r;r>d;d++)for(var p=-n;n>p;p++){var u=d*i-l+o.x,g=p*a-c+o.y;e.drawImage(s,0,0,a,i,u,g,i,a)}e.globalAlpha=1}drawCachedIsometricGrid(e,t){this.cacheIsometricGrid(t);var s=this.gridCache,i=s.width,a=s.height,o=this.scene.screen.center,r=2+(o.x/i|0),n=2+(o.y/a|0),h=this.camera.zoom,l=this.camera.position.x*h%i,c=this.camera.position.y*h%a;e.globalAlpha=this.gridCacheAlpha;for(var d=-r;r>d;d++)for(var p=-n;n>p;p++){var u=d*i-l+o.x,g=p*a-c+o.y;e.drawImage(s,0,0,a,i,u,g,i,a)}e.globalAlpha=1}cacheGrid(){var e=this.scene.camera.zoom,t=200*e,s=200*e,i=this.options.gridSize*e,a=document.createElement("canvas");a.width=t,a.height=s;var o=a.getContext("2d");o.strokeStyle=this.options.gridMinorLineColor,o.strokeWidth=1*window.devicePixelRatio,o.beginPath();var r=null,n=null,h=null,l=null;for(r=Math.floor(t/i),n=0;r>=n;n++)h=n*i,o.moveTo(h,0),o.lineTo(h,s),o.stroke();for(r=Math.floor(s/i),n=0;r>=n;n++)l=n*i,o.moveTo(0,l),o.lineTo(t,l),o.stroke();o.beginPath(),o.rect(0,0,t,s),o.lineWidth=2*window.devicePixelRatio,o.strokeStyle=this.options.gridMajorLineColor,o.stroke(),o.closePath(),this.gridCache=a,this.gridCacheAlpha=Math.min(e+.2,1)}cacheIsometricGrid(){var e=this.scene.camera.zoom,t=200*e,s=200*e,i=this.options.gridSize*e,a=document.createElement("canvas");a.width=t,a.height=s;var o=a.getContext("2d");o.fillStyle=this.options.gridMinorLineColor;var r=null,n=null,h=null,l=null,c=null;for(r=Math.floor(t/i),h=0;r>=h;h++)for(r=Math.floor(s/i),n=0;r>=n;n+=.5)o.beginPath(),n-Math.floor(n)==0?(l=n*i,c=h*i,o.arc(2*l,c,1*e,0,2*Math.PI)):(l=n*i,c=(h+.5)*i,o.arc(2*l,c,1*e,0,2*Math.PI)),o.fill();this.gridCache=a,this.gridCacheAlpha=Math.min(e+.2,1)}resize(){var e=this.scene.game.pixelRatio;this.cacheGrid(e)}undo(){}redo(){}close(){this.actionTimeline=[],this.actionTimelinePointer=0,this.tools=null,this.mouse=null,this.scene=null,this.camera=null,this.options.grid=!1,this.options=null,this.gridCache=null}},fe=class extends ee{powerup=null;name="balloon";p1=null;p2=null;active=!1;constructor(e,t){super(t),this.powerup=new y(0,0,0,t.scene.track),this.p1=new s(0,0),this.p2=new s(0,0),this.options=e.options,this.active=!1}draw(e){var t=this.mouse.touch.pos,s=this.camera.zoom;if(("desktop"===this.scene.settings.device||this.active)&&(e.globalAlpha=.8,this.powerup.draw(t.x,t.y,s,e),e.globalAlpha=1),!0===this.active){var i=this.scene.screen,a=i.realToScreen(this.p1.x,"x"),o=i.realToScreen(this.p1.y,"y");e.globalAlpha=.4,this.powerup.draw(a,o,s,e),e.globalAlpha=1}}press(){var e=this.mouse.touch.real;this.p1.x=e.x,this.p1.y=e.y,this.p2.x=e.x,this.p2.y=e.y,this.active=!0}hold(){var e=this.mouse.touch.real;this.p2.x=e.x,this.p2.y=e.y}release(){var e=(this.scene.screen,this.scene.track),t=new y(this.p1.x,this.p1.y,this.options.time,e);e.addPowerup(t),this.active=!1,this.toolhandler.addActionToTimeline({type:"add",objects:[t]})}},xe=class extends ee{powerup=null;name="blob";p1=null;active=!1;constructor(e,t){super(t),this.powerup=new w(0,0,0,t.scene.track),this.p1=new s(0,0),this.options=e.options,this.active=!1}draw(e){var t=this.mouse.touch.pos,s=this.camera.zoom;if(("desktop"===this.scene.settings.device||this.active)&&(e.globalAlpha=.8,this.powerup.draw(t.x,t.y,s,e),e.globalAlpha=1),!0===this.active){var i=this.scene.screen,a=i.realToScreen(this.p1.x,"x"),o=i.realToScreen(this.p1.y,"y");e.globalAlpha=.4,this.powerup.draw(a,o,s,e),e.globalAlpha=1}}press(){var e=this.mouse.touch.real;this.p1.x=e.x,this.p1.y=e.y,this.active=!0}release(){var e=(this.scene.screen,this.scene.track),t=new w(this.p1.x,this.p1.y,this.options.time,e);e.addPowerup(t),this.active=!1,this.toolhandler.addActionToTimeline({type:"add",objects:[t]})}},Te=class extends ee{powerup=null;name="helicopter";p1=null;p2=null;active=!1;constructor(e,t){super(t),this.powerup=new v(0,0,0,t.scene.track),this.p1=new s(0,0),this.p2=new s(0,0),this.options=e.options,this.active=!1}draw(e){var t=this.mouse.touch.pos,s=this.camera.zoom;if(("desktop"===this.scene.settings.device||this.active)&&(e.globalAlpha=.8,this.powerup.draw(t.x,t.y,s,e),e.globalAlpha=1),!0===this.active){var i=this.scene.screen,a=i.realToScreen(this.p1.x,"x"),o=i.realToScreen(this.p1.y,"y");e.globalAlpha=.4,this.powerup.draw(a,o,s,e),e.globalAlpha=1}}press(){var e=this.mouse.touch.real;this.p1.x=e.x,this.p1.y=e.y,this.p2.x=e.x,this.p2.y=e.y,this.active=!0}hold(){var e=this.mouse.touch.real;this.p2.x=e.x,this.p2.y=e.y}release(){var e=(this.scene.screen,this.scene.track),t=new v(this.p1.x,this.p1.y,this.options.time,e);e.addPowerup(t),this.active=!1,this.toolhandler.addActionToTimeline({type:"add",objects:[t]})}},be=class extends ee{powerup=null;name="truck";p1=null;p2=null;active=!1;constructor(e,t){super(t),this.powerup=new f(0,0,0,t.scene.track),this.p1=new s(0,0),this.p2=new s(0,0),this.options=e.options,this.active=!1}draw(e){var t=this.mouse.touch.pos,s=this.camera.zoom;if(("desktop"===this.scene.settings.device||this.active)&&(e.globalAlpha=.8,this.powerup.draw(t.x,t.y,s,e),e.globalAlpha=1),!0===this.active){var i=this.scene.screen,a=i.realToScreen(this.p1.x,"x"),o=i.realToScreen(this.p1.y,"y");e.globalAlpha=.4,this.powerup.draw(a,o,s,e),e.globalAlpha=1}}press(){var e=this.mouse.touch.real;this.p1.x=e.x,this.p1.y=e.y,this.p2.x=e.x,this.p2.y=e.y,this.active=!0}hold(){var e=this.mouse.touch.real;this.p2.x=e.x,this.p2.y=e.y}release(){var e=(this.scene.screen,this.scene.track),t=new f(this.p1.x,this.p1.y,this.options.time,e);e.addPowerup(t),this.active=!1,this.toolhandler.addActionToTimeline({type:"add",objects:[t]})}},ke=class extends ee{name="vehiclepowerup";powerupTools=null;constructor(e){super(e),this.powerupTools={},this.options=e.scene.settings.vehiclePowerup,this.registerPowerupTools()}registerPowerupTools(){this.registerTool(new Te(this,this.toolhandler)),this.registerTool(new be(this,this.toolhandler)),this.registerTool(new fe(this,this.toolhandler)),this.registerTool(new xe(this,this.toolhandler))}registerTool(e){this.powerupTools[e.name]=e}setOption(e,t){this.options[e]=t}getOptions(){return this.options}press(){var e=this.options.selected;this.powerupTools[e].press()}hold(){var e=this.options.selected;this.powerupTools[e].hold()}release(){var e=this.options.selected;this.powerupTools[e].release()}draw(e){this.powerupTools[this.options.selected].draw(e)}},Se=class extends Y{canvas=null;dialogOptions=!1;clear=!1;redoundoControls=null;inFocus=!0;verified=!1;constructor(e){super(e),this.mouse.disableContextMenu(),this.createMainPlayer(),this.createControls(),this.registerTools(),this.state=this.setStateDefaults(),this.oldState=this.setStateDefaults(),this.restart(),this.initializeAnalytics(),this.injectLiteFeatures()}injectLiteFeatures(){if(!this.game||!GameManager.game)return;let e=setInterval((()=>{this.game||null!==GameManager.game&&(this.game=GameManager.game),this.game.gameContainer.querySelector(".bottomToolOptions_straightline")&&(this.game.gameContainer.querySelector(".bottomToolOptions_straightline").after(Object.assign(document.createElement("div"),{className:"bottomMenu-button bottomMenu-button-left bottomMenu-button",id:"trackMover",innerHTML:"Move Track",onclick:()=>{let e=this.game.gameContainer.querySelector("#trackMover"),t=e.onclick,s=this.toolHandler.currentTool;e.innerHTML="Stop",this.toolHandler.setTool("camera"),this.toolHandler.tools.camera.frozen=!0,e.onclick=()=>{e.innerHTML="Move Track",this.toolHandler.setTool(s),this.toolHandler.tools.camera.frozen=!1,e.onclick=t}}})),clearInterval(e))})),t=setInterval((()=>{this.game||null!==GameManager.game&&(this.game=GameManager.game),this.game.gameContainer.querySelector(".sideButton_cameraTool")&&!this.game.gameContainer.querySelector(".sideButton-bottom.sideButton_selectTool")&&([...document.getElementsByClassName("sideButton")].forEach((e=>{e.onclick=()=>{e.classList.contains("active")&&setTimeout((()=>{e.classList.remove("active"),this.toolHandler.setTool("select")}))}})),clearInterval(t))}),1e3)}getCanvasOffset(){return{height:this.settings.isStandalone?202:90,width:0}}initializeAnalytics(){this.analytics={deaths:0,mouseEvents:0},this.trackAction("editor-open","open")}createControls(){this.redoundoControls=new Q(this),this.pauseControls=new K(this)}registerTools(){this.toolHandler=new ve(this),this.toolHandler.enableGridUse(),this.toolHandler.registerTool(se),this.toolHandler.registerTool(ae),this.toolHandler.registerTool(we),this.toolHandler.registerTool(te),this.toolHandler.registerTool(ye),this.toolHandler.registerTool(oe),this.toolHandler.registerTool(ge),this.toolHandler.registerTool(ke),this.toolHandler.setTool(this.settings.startTool)}play(){this.state.playing=!0}interactWithControls(){super.interactWithControls(),this.redoundoControls.click()}updateControls(){super.updateControls(),this.redoundoControls.update()}fixedUpdate(){super.fixedUpdate(),(this.importCode||this.clear)&&this.createTrack()}draw(e){super.draw(...arguments),this.redoundoControls.draw(e)}restart(){this.verified=!this.settings.requireTrackVerification,this.track.dirty=!1,this.track.resetPowerups(),this.message.hide(),this.restartTrack=!1,this.state.playing=!1,this.ticks=0,this.playerManager.reset(),this.camera.focusOnPlayer(),this.camera.fastforward(),this.score.update()}buttonDown(e){let t=this.camera;switch(this.state.playing=!0,e){case"up":case"down":case"left":case"right":t.focusOnMainPlayer();break;case"change_camera":t.focusOnNextPlayer();break;case"pause":this.state.paused=!this.state.paused;break;case"settings":this.command("dialog","settings");break;case"change_vehicle":this.toggleVehicle(),this.stateChanged();break;case"zoom_increase":t.increaseZoom(),this.stateChanged();break;case"zoom_decrease":t.decreaseZoom(),this.stateChanged();break;case"fullscreen":this.toggleFullscreen(),this.stateChanged()}}toggleFullscreen(){this.settings.embedded?window.open(this.settings.basePlatformUrl+"/t/"+this.settings.track.url):this.settings.fullscreenAvailable&&(this.settings.fullscreen=this.state.fullscreen=!this.settings.fullscreen)}resize(){this.pauseControls.resize(),this.redoundoControls.resize(),super.resize()}updateState(){if(null!==this.game.onStateChange){var e=this.state;e.tool=this.toolHandler.currentTool,e.toolOptions=this.toolHandler.getToolOptions(),e.grid=this.toolHandler.options.grid,e.cameraLocked=this.toolHandler.options.cameraLocked,e.zoomPercentage=this.camera.zoomPercentage,e.vehicle=this.vehicle,this.game.onStateChange(this.state)}}setStateDefaults(){var e={};return e.paused=!!this.settings.mobile||this.settings.startPaused,e.loading=!1,e.playing=this.settings.waitForKeyPress,e.tool=this.toolHandler.currentTool,e.toolOptions=this.toolHandler.getToolOptions(),e.grid=this.toolHandler.options.grid,e.cameraLocked=this.toolHandler.options.cameraLocked,e.zoomPercentage=this.camera.zoomPercentage,e.vehicle=this.vehicle,e.showDialog=!1,e.dialogOptions=!1,e.preloading=!1,e.fullscreen=this.settings.fullscreen,e.inFocus=!0,this.controls&&(e.hideMenus=this.controls.isVisible()),e}trackAction(e,t){var s={category:"create",action:e,label:t,value:this.toolHandler.analytics.actions+this.mouse.analytics.clicks,non_interaction:!0};Application.Helpers.GoogleAnalyticsHelper.track_event(s)}openDialog(e){switch(this.state.dialogOptions={},e){case"import":break;case"export":setTimeout(this.getTrackCode.bind(this),750);break;case"upload":"undefined"==typeof isChromeApp&&setTimeout(this.getTrackCode.bind(this),750)}this.state.playing=!1,this.state.showDialog=e}getTrackCode(){this.state.dialogOptions={},this.state.dialogOptions.verified=this.verified,this.state.dialogOptions.code=this.track.getCode()}trackComplete(){this.verified=!this.track.dirty}hideControlPlanel(){}showControlPlanel(){}command(){var e=Array.prototype.slice.call(arguments,0);switch(e.shift()){case"change tool":var t=e[0];this.toolHandler.setTool(t);break;case"change tool option":var s=e[0],i=e[1];void 0!==e[2]?this.toolHandler.setToolOption(s,i,e[2]):this.toolHandler.setToolOption(s,i);break;case"snap":this.toolHandler.toggleSnap();break;case"redraw":this.redraw();break;case"fullscreen":this.settings.fullscreen=this.state.fullscreen=!this.settings.fullscreen;break;case"grid":this.toolHandler.toggleGrid();break;case"lock camera":this.toolHandler.toggleCameraLock();break;case"toggle vehicle":this.toggleVehicle(),this.stateChanged();break;case"reset zoom":this.camera.resetZoom();break;case"increase zoom":this.camera.increaseZoom();break;case"decrease zoom":this.camera.decreaseZoom();break;case"change lineType":var a=e[0];this.toolHandler.options.lineType=a,this.stateChanged();break;case"clear track":this.trackAction("editor-action","clear"),this.clear=!0;break;case"import":var o=e[0];o.length<=0&&(o=!1),this.importCode=o,this.clear=e[1],this.command("dialog",!1)}super.command(...arguments)}close(){this.trackAction("editor-exit","exit"),super.close()}},Pe=class extends J{name="fullscreen_controls";fullscreen=!1;controlsSpriteSheetData={exit_fullscreen_btn:[230,2,76,76],fullscreen_btn:[78,2,76,76]};controlData={fullscreen:{top:60,right:150,key:"fullscreen",alpha:.5,width:76,height:76}};constructor(){super(...arguments),this.init(...arguments)}click(e=Object.values(this.controlData).find(this.isMouseOverComponent.bind(this))){for(const e in this.controlData){const t=this.controlData[e];this.isMouseOverComponent(t)&&this.scene.buttonDown(t.key)}}update(){let e=this.scene.settings.fullscreen;this.fullscreen!==e&&(this.controlData.fullscreen.image=e?"exit_fullscreen":"fullscreen",this.fullscreen=e),super.update()}},Ce=class extends J{name="settings_controls";controlsSpriteSheetData={settings_btn:[78,2,76,76]};controlData={settings:{top:60,right:230,key:"settings",alpha:.5,width:76,height:76}};constructor(e){super(...arguments),this.init(...arguments)}click(){for(const e in this.controlData){const t=this.controlData[e];this.isMouseOverComponent(t)&&this.scene.buttonDown(t.key)}}},_e=class extends Y{races=[];playing=!1;ready=!1;preloading=!0;loading=!0;fullscreenControls=null;settingsControls=null;showSkip=!1;constructor(e){super(e),this.raceTimes=new class{raceCount=0;highlightedRace=null;raceOpacity=.3;raceYOffset=50;mobileRaceXOffset=180;maxRaces=10;container={children:[],color:"#000000",font:25,x:15,y:80,scaleX:window.devicePixelRatio/2.5,scaleY:window.devicePixelRatio/2.5,visible:!0};constructor(e){this.scene=e,this.scene.game.settings.isCampaign&&(this.container.y+=60),this.maxRaces=this.scene.settings.mobile?3:10}get raceList(){return this.container.children}clear(){this.container.children.splice(0),this.raceCount=0}centerContainer(){let e=this.scene,t=e.screen,s=this.container,i=s.children.reduce(((e,t)=>e+160),0),a=this.scene.game.pixelRatio;s.x=t.width/2-i/2*s.scaleY,e.settings.isCampaign&&(s.visible=!1),s.y=40*a}addRace(e,t){if(this.raceCount<this.maxRaces){var s=this.scene,i=e.user,a=e.race,o=s.settings,r=o.drawFPS,n={alpha:this.raceOpacity,children:[],color:i.color,initial:i.d_name.charAt(0).toUpperCase(),runTime:b(parseInt(a.run_ticks)/r*1e3),x:25,y:25};o.mobile?n.x=t*this.mobileRaceXOffset:n.y=t*this.raceYOffset,this.container.children.push(n),this.raceCount++}}draw(e){e.save(),e.textAlign="center",e.textBaseline="middle";for(const t in this.container.children){const s=this.container.children[t];e.globalAlpha=s.alpha,e.fillStyle=s.color,e.beginPath(),e.arc((this.container.x+s.x)*this.container.scaleX,(this.container.y+s.y+20)*this.container.scaleY,20*this.container.scaleY,0,2*Math.PI),e.fill(),e.fillStyle=this.container.color,e.font=this.container.font*this.container.scaleY+"px helsinki",e.fillText(s.initial,(this.container.x+s.x)*this.container.scaleX,(this.container.y+s.y+20)*this.container.scaleY),e.font=(this.container.font+5)*this.container.scaleY+"px helsinki";let i=e.measureText(s.runTime);s.width=20+i.width,s.height=20+i.actualBoundingBoxAscent+i.actualBoundingBoxDescent,e.fillText(s.runTime,(this.container.x+s.x+20+9)*this.container.scaleX+i.width/2,(this.container.y+s.y+20)*this.container.scaleY)}e.restore()}update(){if(this.raceCount>0){var e=this.scene.camera;e.focusIndex>0&&e.focusIndex<this.maxRaces?this.highlightRace(e.focusIndex-1):this.unhighlightRace(),this.scene.settings.mobile&&this.centerContainer()}}highlightRace(e){if(this.highlightedRace!==this.raceList[e]){this.unhighlightRace();var t=this.raceList[e];t.alpha=1,this.highlightedRace=t}}unhighlightRace(){this.highlightedRace&&(this.highlightedRace.alpha=this.raceOpacity,this.highlightedRace=null)}}(this),this.settings.isCampaign&&(this.campaignScore=new class{scene=null;sprite=null;cached=!1;container={children:[],color:"#000000",font:30*window.devicePixelRatio/2.5,x:0,y:80*window.devicePixelRatio/2.5,scaleX:window.devicePixelRatio/2.5,scaleY:window.devicePixelRatio/2.5};spriteSheet={bronze_medal:[548,68,44,44],center_panel:[2,68,452,56],silver_medal:[502,68,44,44],left_panel:[2,2,588,64],gold_medal:[456,68,44,44]};bronze_container={alpha:.4,image:"bronze_medal",x:16,y:7};silver_container={alpha:.4,image:"silver_medal",x:175,y:7};gold_container={alpha:.4,image:"gold_medal",x:350,y:7};constructor(e){this.scene=e,this.settings=e.settings;let{goals:t}=e.settings.campaignData;this.bronze_container.text=t.third,this.silver_container.text=t.second,this.gold_container.text=t.first,this.container.children.push(this.bronze_container),this.container.children.push(this.silver_container),this.container.children.push(this.gold_container),this.sprite=this.scene.assets.getResult("campaign_icons"),this.update_state()}update_state(){switch(this.settings.campaignData.user.has_goal){case 1:case"first":this.gold_container.alpha=1;case"second":case 2:this.silver_container.alpha=1;case"third":case 3:this.bronze_container.alpha=1}}center_container(){let e=this.scene.screen,t=this.container,s=t.children.reduce(((e,t)=>e+t.width),0);t.x=e.width/2-s/2*window.devicePixelRatio,t.y=40*window.devicePixelRatio}draw(e){e.save(),e.fillStyle=this.container.color,e.font=this.container.font+"px helsinki",e.textBaseline="middle";for(const t of this.container.children){let s=this.spriteSheet[t.image],i=this.container.x+t.x*this.container.scaleX,a=this.container.y+t.y*this.container.scaleY;e.drawImage(this.sprite,...s,i,a,s[2]*this.container.scaleX,s[3]*this.container.scaleY),e.globalAlpha=t.alpha;let o=e.measureText(t.text);t.width=s[2]+o.width,t.height=s[3]+o.actualBoundingBoxAscent+o.actualBoundingBoxDescent,e.fillText(t.text,i+s[2]*this.container.scaleX+o.width/2+8*this.container.scaleX,a+s[3]/2*this.container.scaleY)}e.restore()}update(){this.settings.mobile&&this.center_container(),this.update_state()}}(this)),this.loading=!1,this.setStartingVehicle(),this.state=this.setStateDefaults(),this.oldState=this.setStateDefaults(),this.createMainPlayer(),this.createControls(),this.registerTools(),this.setStartingVehicle(),this.restart(),this.initializeAnalytics()}getCanvasOffset(){return{height:0,width:0}}initializeAnalytics(){this.analytics={deaths:0}}createMainPlayer(){var e=this.playerManager.createPlayer(this,this.settings.user),t=e.getGamepad();t.setKeyMap(this.settings.playHotkeys),t.recordKeys(this.settings.keysToRecord),t.onButtonDown=this.buttonDown.bind(this),t.listen(),this.playerManager.firstPlayer=e,this.playerManager.addPlayer(e)}createControls(){this.pauseControls=new K(this),this.settings.fullscreenAvailable&&(this.fullscreenControls=new Pe(this)),this.settingsControls=new Ce(this)}createTrack(){this.track&&this.track.close();let e=new T(this),t=this.getAvailableTrackCode();0!=t&&(e.read(t),this.track=e,this.setTrackAllowedVehicles(),this.state.preloading=!1,this.loading=!1,this.restartTrack=!0,this.ready=!0),this.track=e}play(){this.state.playing||(this.state.playing=!0,this.hideControlPlanel())}buttonDown(e){if(!this.state.showDialog){var t=this.camera;switch(e){case"change_camera":t.focusOnNextPlayer();break;case"pause":this.state.paused=!this.state.paused;break;case"settings":this.openDialog("settings");break;case"exit_fullscreen":this.exitFullscreen();break;case"change_vehicle":this.toggleVehicle();break;case"zoom_increase":t.increaseZoom();break;case"zoom_decrease":t.decreaseZoom();break;case"fullscreen":this.toggleFullscreen()}}}exitFullscreen(){this.settings.fullscreenAvailable&&(this.settings.fullscreen=!1,this.state.fullscreen=!1,this.trackEvent("game-ui","game-fullscreen-toggle","game-out-fullscreen"))}toggleFullscreen(){if(this.settings.embedded){var e=this.settings,t=e.basePlatformUrl+"/t/"+e.track.url;window.open(t)}else this.settings.fullscreenAvailable&&(this.settings.fullscreen=!this.settings.fullscreen,this.state.fullscreen=!this.settings.fullscreen,this.trackEvent("game-ui","game-fullscreen-toggle",this.settings.fullscreen?"game-into-fullscreen":"game-out-fullscreen"))}trackEvent(e,t,s){var i={category:e,action:t,label:s,value:0,non_interaction:!0};Application.Helpers.GoogleAnalyticsHelper.track_event(i)}setTrackAllowedVehicles(){var e=this.track,t=this.settings.track;t&&(e.allowedVehicles=t.vehicles)}interactWithControls(){super.interactWithControls(),this.settings.fullscreenAvailable&&this.fullscreenControls.click(),this.settingsControls.click()}updateControls(){super.updateControls(),this.settings.fullscreenAvailable&&this.fullscreenControls.update(),this.settingsControls.update()}registerTools(){var e=new ve(this);this.toolHandler=e,e.registerTool(se),e.setTool("Camera")}fixedUpdate(){this.ready?(super.fixedUpdate(),this.updateScore()):this.importCode&&this.createTrack()}draw(e){super.draw(...arguments),this.settings.fullscreenAvailable&&this.fullscreenControls.draw(e),this.settingsControls.draw(e),this.campaignScore&&this.campaignScore.draw(e),this.raceTimes.draw(e)}isStateDirty(){let e=this.state;return e.fullscreen!=GameSettings.fullscreen&&(e.fullscreen=GameSettings.fullscreen),super.isStateDirty()}updateScore(){this.campaignScore&&this.campaignScore.update(),this.raceTimes.update()}restart(){this.settings.mobile?this.message.show("Press Any Button To Start",1,"#333333"):this.message.show("Press Any Key To Start",1,"#333333","#FFFFFF"),this.track.resetPowerups(),this.restartTrack=!1,this.state.paused=!1,this.state.playing=!this.settings.waitForKeyPress,this.ticks=0,this.playerManager.reset(),this.playerManager.getPlayerCount()>0&&(this.camera.focusIndex=1),this.camera.focusOnPlayer(),this.camera.fastforward(),this.showControlPlanel("main")}setStartingVehicle(){var e=this.settings,t=e.startVehicle;e.track&&(t=e.track.vehicle),this.vehicle=t}updatePlayers(){this.playerManager.update()}hideControlPlanel(){this.state.showSkip&&(this.state.showSkip=!1),!1!==this.state.showControls&&(this.state.showControls=!1)}showControlPlanel(e){this.settings.isCampaign&&!this.settings.mobile&&this.settings.campaignData.can_skip&&this.analytics&&this.analytics.deaths>5&&(this.state.showSkip=!0),this.stateshowControls!==e&&this.settings.showHelpControls&&(this.state.showControls=e)}resize(){this.pauseControls.resize(),this.settings.fullscreenAvailable&&this.fullscreenControls.resize(),this.settingsControls.resize(),super.resize()}updateState(){null!==this.game.onStateChange&&this.game.onStateChange(this.state)}setStateDefaults(){var e={};return e.playing=!this.settings.waitForKeyPress,e.paused=!1,e.playerAlive=!0,e.inFocus=!0,e.preloading=!0,e.fullscreen=this.settings.fullscreen,e.showControls=!1,e.showSkip=!1,e.showDialog=!1,e.dialogOptions=!1,e}openDialog(e){this.state.playing=!1,this.state.showDialog=e}command(){var e=Array.prototype.slice.call(arguments,0);switch(e.shift()){case"clear race":this.races=[],this.restartTrack=!0,this.raceTimes.clear();break;case"add race":var t=e[0],s=e[1];this.addRaces(t),s&&(this.state.dialogOptions={races:this.races},this.command("dialog","race_dialog"));break;case"change vehicle":var i=e[0];this.selectVehicle(i);break;case"restart":this.command("dialog",!1),this.restartTrack=!0;break;case"resume":this.state.paused=!1;break;case"fullscreen":this.toggleFullscreen();break;case"exit_fullscreen":this.exitFullscreen()}super.command(...arguments)}addRaces(e){this.mergeRaces(e),this.sortRaces(),this.formatRaces(),this.addRaceTimes(),this.addPlayers(),this.restartTrack=!0}addRaceTimes(){var e=this.settings.raceColors,t=e.length,s=this.races,i=this.raceTimes;for(var a in i.clear(),s){var o=s[a];o.user.color=e[a%t],i.addRace(o,a)}}addPlayers(){var e=this.races,t=this.playerManager;t.clear();var s=this.settings.keysToRecord;for(var i in e){var a=e[i],o=a.user,r=a.race,n=r.code;"string"==typeof n&&(n=JSON.parse(n));var h=t.createPlayer(this,o);h.setBaseVehicle(r.vehicle),h.setAsGhost(),h.getGamepad().loadPlayback(n,s),t.addPlayer(h)}}formatRaces(){var e=this.races;for(var t in e){var s=e[t].race,i=s.code;if("string"==typeof i){for(var a in i=JSON.parse(i))i[a]instanceof Array&&(i[a]=i[a].reduce(((e,t)=>(e[t]=1+~~e[t],e)),{}));s.code=i}}}removeDuplicateRaces(){this.races=this.races.filter(((e,t,s)=>t===s.findIndex((t=>this.uniqesByUserIdIterator(t)==this.uniqesByUserIdIterator(e)))))}uniqesByUserIdIterator(e){return e.user.u_id}sortRaces(){this.races=this.races.sort(((e,t)=>this.sortByRunTicksIterator(e)-this.sortByRunTicksIterator(t)))}mergeRaces(e){var t=this.races;e&&e.forEach((e=>{var s=t.find((t=>t.user.u_id===e.user.u_id));s?Object.assign(s,e):t.push(e)}))}sortByRunTicksIterator(e){var t=this.settings,s=parseInt(e.race.run_ticks),i=b(s/t.drawFPS*1e3);return e.runTime=i,s}verifyComplete(){var e=this.playerManager.firstPlayer._powerupsConsumed.targets,t=this.track.targets,s=!0;for(var i in t){var a=t[i].id;-1===e.indexOf(a)&&(s=!1)}return s}async trackComplete(){if(this.verifyComplete()){this.sound.play("victory_sound");var e=this.playerManager;e.mutePlayers();var t=e.firstPlayer,s=t.getGamepad(),i=s.getReplayString(),a=this.settings,o=this.ticks,r=b(o/a.drawFPS*1e3),n={t_id:$("#track-data").data("t_id"),u_id:a.user.u_id,code:i,vehicle:t._baseVehicleType,run_ticks:o,fps:25,time:r};n.sig=await async function(e){const t=(new TextEncoder).encode(e),s=await crypto.subtle.digest("SHA-256",t);return Array.from(new Uint8Array(s)).map((e=>e.toString(16).padStart(2,"0"))).join("")}(n.t_id+"|"+n.u_id+"|"+n.code+"|"+n.run_ticks+"|"+n.vehicle+"|"+n.fps+"|erxrHHcksIHHksktt8933XhwlstTekz");var h=this.races,l=h.length,c=[];if(l>0){for(var d=0;l>d;d++)c.push(h[d].user.u_id);n.races=c}a.isCampaign&&(n.is_campaign=!0),this.state.dialogOptions={postData:n,analytics:this.analytics},navigator.onLine||(localStorage.setItem("offline_races",Object.assign(Object.assign({},JSON.parse(localStorage.getItem("offline_races"))),{[this.settings.track.id]:this.state.dialogOptions})),alert("Your connection is offline! Free Rider Lite saved your ghost, and it will be published when your connection is back online!")),a.isCampaign?this.command("dialog","campaign_complete"):this.command("dialog","track_complete"),s.reset(!0),this.listen()}}close(){this.fullscreenControls=null,this.settingsControls=null,this.raceTimes=null,this.score=null,this.campaignScore=null,super.close()}};window.Game=class{gameContainer=null;lastTime=-1;progress=0;tickCount=0;ups=30;currentScene=null;assets=null;canvas=null;stats=null;width=0;height=0;fullscreen=!1;onStateChange=null;constructor(e,t,s){this.assets=t,this.settings=s,this.initCanvas(),this.setSize(),this.switchScene(e),this.setSize(),this.updateCallback=requestAnimationFrame(this.update.bind(this))}initCanvas(){this.canvas=document.createElement("canvas"),this.ctx=this.canvas.getContext("2d"),this.gameContainer=document.getElementById(this.settings.defaultContainerID),null!==this.gameContainer&&this.gameContainer.appendChild(this.canvas)}setSize(){let e=window.innerHeight,t=window.innerWidth;this.settings.fullscreen||this.settings.isStandalone||(e=this.gameContainer.clientHeight,t=this.gameContainer.clientWidth),this.currentScene&&(e-=this.currentScene.getCanvasOffset().height);let s=1;void 0!==window.devicePixelRatio&&(s=window.devicePixelRatio),this.settings.lowQualityMode&&(s=1);let i=t*s,a=e*s;(i!==this.width||a!==this.height)&&(this.width=i,this.height=a,this.canvas.width=i,this.canvas.height=a),this.pixelRatio=s,this.canvas.style.width=t+"px",this.canvas.style.height=e+"px",this.ctx.strokeStyle="#".padEnd(7,"midnight"==lite.storage.get("theme")?"C":"dark"==lite.storage.get("theme")?"FB":"0"),this.ctx.lineCap="round",this.ctx.lineJoin="round",this.currentScene&&this.currentScene.command("resize")}update(e){this.updateCallback=requestAnimationFrame(this.update.bind(this));let t=e-this.lastTime,s=1e3/this.ups;if(this.ups>30){for(t>1e3&&(t=s),this.progress+=t/s,this.lastTime=e;this.progress>=1;)this.currentScene.fixedUpdate(),this.tickCount++,this.progress--;this.currentScene.update(this.progress,t)}else t>=s&&(this.currentScene.fixedUpdate(),this.lastTime=e,this.tickCount++);this.currentScene.draw(this.ctx),lite.draw(this.ctx)}switchScene(e){null!==this.currentScene&&this.currentScene.close(),this.currentScene=new{Editor:Se,Main:_e}[e](this)}command(){this.currentScene.command.apply(this.currentScene,arguments)}close(){cancelAnimationFrame(this.updateCallback),this.currentScene.close(),this.currentScene=null,this.assets=null,this.settings=null,this.canvas.remove(),this.canvas=null,this.ctx=null,this.tickCount=null,this.height=null,this.width=null}}})();