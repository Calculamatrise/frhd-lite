(()=>{"use strict";function t(e,t,s,i,o){let a=[],r=e,n=t,h=(i-t)/(s-e),l=s>e?1:-1,c=i>t?1:-1,p=0;a.push(e,t),e%300==0&&a.push(e-.5,t),t%300==0&&a.push(e,t-.5);do{let p=Math.floor(r/o)==Math.floor(s/o),d=Math.floor(n/o)==Math.floor(i/o);if(p&&d)break;let u=0,m=0;u=Math.round(Math.floor(r/o+l)*o),0>l&&(u=Math.round(Math.ceil((r+1)/o+l)*o)-1),m=Math.round(t+(u-e)*h);let g=0,y=0;y=Math.round(Math.floor(n/o+c)*o),0>c&&(y=Math.round(Math.ceil((n+1)/o+c)*o)-1),g=Math.round(e+(y-t)/h),Math.pow(u-e,2)+Math.pow(m-t,2)<Math.pow(g-e,2)+Math.pow(y-t,2)?(r=u,n=m,a.push(u,m),u%300==0&&a.push(u-1,m),m%300==0&&a.push(u,m-1)):(r=g,n=y,a.push(g,y),g%300==0&&a.push(g-.5,y),y%300==0&&a.push(g,y-.5))}while(p++<5e3);return a}window.lite=new class{#e=null;featuredGhostsLoaded=!1;loaded=!1;snapshots=new class extends Array{push(...e){this.length>=parseInt(lite.storage.get("snapshots"))&&this.splice(0,this.length-parseInt(lite.storage.get("snapshots"))),super.push(...e)}};storage=new Map;styleSheet=new Proxy(new Map,{get:(...e)=>{let[t,s,i]=e,o=Reflect.get(...e);return"function"==typeof o?(...e)=>{switch(s){case"delete":o=o.apply(t,e),this.updateCustomStyleSheet(this.styleSheet.entries());break;case"set":let[s,a]=e;o.call(t,s,new Proxy(a,{set:(...e)=>{let t=Reflect.set(...e);return this.updateCustomStyleSheet(this.styleSheet.entries()),t}})),o=i,this.updateCustomStyleSheet(this.styleSheet.entries());break;default:o=o.apply(t,e)}return o}:o}});constructor(){new URLSearchParams(location.search).has("ajax")||(navigation.addEventListener("navigate",(()=>this.loaded=!1)),window.Application&&Application.events.subscribe("mainview.loaded",this.childLoad.bind(this)),window.GameManager&&((GameManager.clientMods||=new Map).set("frhd-lite",this),GameManager.on("stateChange",(e=>{!1===e.preloading&&!1===this.loaded&&(this.loaded=this.load()),this.loaded&&this.refresh()}))),this.#t(),this.childLoad(),addEventListener("message",(({data:e})=>{if(!e)return console.warn("data is missing");switch(e.action){case"setStorage":this.storage=new Map(Object.entries(e.storage));break;case"updateStorage":let t=new Map(this.storage);this.storage=new Map(Object.entries(e.storage));let s=new Map;for(const[e,i]of this.storage.entries())JSON.stringify(i)!=JSON.stringify(t.get(e))&&s.set(e,i);this.updateFromSettings(s)}})))}get scene(){return GameManager.game&&GameManager.game.currentScene}#t(){this.#e=document.head.appendChild(document.createElement("style")),this.#e.setAttribute("id","frhd-lite-style")}updateCustomStyleSheet(e){const t=Array.from(e).filter((([e,t])=>Object.values(t).length));let s="";for(let[e,i]of t){i=Object.entries(i);for(let e of i)e[0]=e[0].replace(/([A-Z])/g,(e=>"-"+e.toLowerCase()));s+=e+"{"+i.map((e=>e.join(":"))).join(";")+"}"}this.#e.textContent=s}load(){return this.snapshots.splice(0,this.snapshots.length),this.updateFromSettings(this.storage),!0}childLoad(){this.storage.get("accountManager")&&this.initAccountManager(),this.storage.get("dailyAchievementsDisplay")&&this.initAchievementsDisplay(),location.pathname.match(/^\/t\//i)&&(this.initBestDate(),this.initDownloadGhosts(),Application.settings.user.u_id===GameSettings.track.u_id&&this.initDownloadTracks(),this.initGhostPlayer(),this.storage.get("uploadGhosts")&&this.initUploadGhosts()),this.storage.get("featuredGhostsDisplay")&&this.initFeaturedGhosts(),location.pathname.match(/^\/u\//i)&&(this.initFriendsLastPlayed(),location.pathname.match(new RegExp("^/u/"+Application.settings.user.u_name+"/?","i"))&&this.initUserTrackAnalytics(),Application.settings.user.moderator&&this.initUserTrackModeration()),location.pathname.match(/^\/account\/settings\/?/i)&&this.initRequestTrackData()}updateFromSettings(e=this.storage){if(this.scene){for(const[t,s]of e.entries())switch(t){case"keymap":this.scene.playerManager.firstPlayer._gamepad.setKeyMap("Editor"!==GameManager.scene?GameSettings.playHotkeys:GameSettings.editorHotkeys);break;case"theme":let e="#".padEnd(7,"midnight"==s?"1d2328":"darker"==s?"0":"dark"==s?"1b":"f");GameManager.game.canvas.style.setProperty("background-color",e),this.styleSheet.set(".gameFocusOverlay",{backgroundColor:GameManager.game.canvas.style.getPropertyValue("background-color").replace(/[,]/g,"").replace(/(?=\))/,"/90%"),color:"#".padEnd(7,"midnight"==s?"d":"dark"==s?"f":"dark"==s?"eb":"2d")}),this.scene.message.color="#".padEnd(7,/^(dark(er)?|midnight)$/i.test(s)?"c":"3"),this.scene.message.outline=e;let t="#".padEnd(7,/^(dark(er)?|midnight)$/i.test(s)?"6":"9");this.scene.score.best_time.color=t,this.scene.score.best_time_title.color=t;let i="#".padEnd(7,"midnight"==s?"d":/^dark(er)?$/i.test(s)?"f":"0");this.scene.score.goals.color=i,this.scene.score.time.color=i,this.scene.score.time_title.color=t,this.scene.hasOwnProperty("campaignScore")&&(this.scene.campaignScore.container.color=i,this.scene.campaignScore.container.children.forEach((e=>{e.color=i}))),this.scene.hasOwnProperty("raceTimes")&&(this.scene.raceTimes.container.color=i),GameSettings.physicsLineColor="#".padEnd(7,"midnight"==s?"c":"darker"==s?"f":"dark"==s?"fd":"0"),GameSettings.sceneryLineColor="#".padEnd(7,"midnight"==s?"5":"darker"==s?"121319":"dark"==s?"6":"a"),this.scene.toolHandler.options.gridMinorLineColor="#".padEnd(7,"midnight"==s?"20282e":"dark"==s?"25":"e"),this.scene.toolHandler.options.gridMajorLineColor="#".padEnd(7,"midnight"==s?"161b20":"dark"==s?"3e":"c"),this.scene.track.powerups.forEach((e=>e.outline=GameSettings.physicsLineColor));for(const e of this.scene.playerManager._players)e._baseVehicle.color=GameSettings.physicsLineColor,e._tempVehicle&&(e._tempVehicle.color=GameSettings.physicsLineColor);case"isometricGrid":this.scene.redraw()}this.refresh()}}refresh(){let e=this.storage.get("keymap");for(let t in e)this.scene.playerManager.firstPlayer._gamepad.keymap[t.charCodeAt()]=e[t];for(const e of this.scene.playerManager._players.filter((e=>e._user.u_id==this.scene.playerManager.firstPlayer._user.u_id)))e._baseVehicle.color="#000000"!=this.storage.get("bikeFrameColor")&&this.storage.get("bikeFrameColor")||GameSettings.physicsLineColor}draw(e){this.storage.get("inputDisplay")&&this.drawInputDisplay(e||GameManager.game.canvas.getContext("2d"))}drawInputDisplay(e){let{downButtons:t}=this.scene.playerManager.getPlayerByIndex(this.scene.camera.focusIndex)._gamepad,s=parseInt(this.storage.get("inputDisplaySize"))+3,i={x:s,y:e.canvas.height-10*s};e.save(),e.fillStyle=GameSettings.physicsLineColor,e.globalAlpha=this.storage.get("inputDisplayOpacity"),e.lineWidth=s/2,e.strokeStyle=GameSettings.physicsLineColor;let o=s/2,a=4*s;e.beginPath(),e.roundRect(i.x,i.y,a,a,o),t.z&&e.fill(),e.stroke(),e.beginPath(),e.roundRect(i.x+5*s,i.y,a,a,o),t.up&&e.fill(),e.stroke(),e.beginPath(),e.roundRect(i.x,i.y+5*s,a,a,o),t.left&&e.fill(),e.stroke(),e.beginPath(),e.roundRect(i.x+5*s,i.y+5*s,a,a,o),t.down&&e.fill(),e.stroke(),e.beginPath(),e.roundRect(i.x+10*s,i.y+5*s,a,a,o),t.right&&e.fill(),e.stroke(),e.globalCompositeOperation="xor",e.lineWidth=s/3,e.beginPath(),e.moveTo(i.x+2.7*s,i.y+3*s),e.lineTo(i.x+1.2*s,i.y+3*s),e.lineTo(i.x+2.7*s,i.y+1*s),e.lineTo(i.x+1.2*s,i.y+1*s),e.moveTo(i.x+6.2*s,i.y+2.7*s),e.lineTo(i.x+7*s,i.y+1.2*s),e.lineTo(i.x+7.8*s,i.y+2.7*s),e.moveTo(i.x+2.5*s,i.y+7.8*s),e.lineTo(i.x+1.2*s,i.y+7*s),e.lineTo(i.x+2.5*s,i.y+6.2*s),e.moveTo(i.x+6.2*s,i.y+6.2*s),e.lineTo(i.x+7*s,i.y+7.8*s),e.lineTo(i.x+7.8*s,i.y+6.2*s),e.moveTo(i.x+11.5*s,i.y+7.8*s),e.lineTo(i.x+12.8*s,i.y+7*s),e.lineTo(i.x+11.5*s,i.y+6.2*s),e.stroke(),e.restore()}initAccountManager(){if(!Application.User.logged_in)return;let e=Application.router.left_navigation_view.el.querySelector("a.logout");e.removeAttribute("id"),e.innerText="Switch",e.addEventListener("click",(()=>{let e=this.constructor.createElement("div",{className:"simplemodal-overlay",id:"simplemodal-overlay",style:{inset:0,opacity:.5,position:"fixed",zIndex:1001}}),t=this.constructor.createElement("div",{children:[this.constructor.createElement("span",{className:"core_icons core_icons-icon_close signup-login-modal-close",onclick(){e.remove(),t.remove()}}),this.constructor.createElement("div",{children:(JSON.parse(localStorage.getItem("switcher-accounts"))??[]).map((e=>this.constructor.createAccountContainer(e))),id:"accounts-container",style:{display:"flex",flexDirection:"column",gap:"0.4rem"}}),this.constructor.createElement("button",{className:"new-button button-type-2",innerText:"Add account",onclick(){if(document.querySelector("div#login-container"))return this.innerText="Add account",this.style.removeProperty("background-image"),void document.querySelector("div#login-container").remove();this.before(lite.constructor.createElement("div",{children:[lite.constructor.createElement("input",{className:"field auth-field",id:"save-account-login",placeholder:"Username or Email",style:{borderRadius:"2rem"},type:"text"}),lite.constructor.createElement("input",{className:"field auth-field",id:"save-account-password",placeholder:"Password",style:{borderRadius:"2rem"},type:"password"}),lite.constructor.createElement("button",{className:"new-button button-type-1",innerText:"Save account",onclick(){Application.Helpers.AjaxHelper.post("/auth/standard_login",{login:document.querySelector("#save-account-login")?.value,password:document.querySelector("#save-account-password")?.value}).done((e=>{if(e.result){let t=JSON.parse(localStorage.getItem("switcher-accounts"))||[];if(t.find((({login:t})=>t===e.data.user.d_name)))return;t.push({login:e.data.user.d_name,password:document.querySelector("#save-account-password")?.value}),document.querySelector("#accounts-container")?.append(lite.constructor.createAccountContainer(t[t.length-1])),localStorage.setItem("switcher-accounts",JSON.stringify(t)),this.parentElement.remove()}}))}})],id:"login-container",style:{display:"flex",flexDirection:"column",gap:"0.4rem",marginTop:"1rem"}})),this.style.setProperty("background-image","linear-gradient(#ee5f5b,#c43c35)"),this.innerText="Cancel"}})],className:"simplemodal-container",id:"signup_login_container",style:{display:"flex",flexDirection:"column",gap:"0.6rem",height:"fit-content",inset:0,margin:"auto",maxHeight:"50vmin",maxWidth:"25vw",minWidth:"230px",overflow:"hidden auto",padding:"2.5rem",position:"fixed",width:"40vmin",zIndex:1002}});Application.User.logged_in&&t.appendChild(this.constructor.createElement("button",{className:"new-button",innerText:"Logout",style:{backgroundImage:"linear-gradient(#ee5f5b,#c43c35)"},onclick(){Application.Helpers.AjaxHelper.post("/auth/logout").done((e=>{e.result&&(Application.User.logged_in=!1,Application.User.clear(),Application.events.publish("user.change"),Application.events.unsubscribe("user.change"),Application.events.publish("user.logout"),Application.User.unset_game_settings_user(),this.remove())}))}})),document.body.append(e,t)}))}achievements=null;achievementsContainer=null;initAchievementsDisplay(){this.notificationEvent||this.initNotificationEvent(),this.achievementsContainer||(Application.events.subscribe("notification.received",(({data:e})=>{void 0!==e&&void 0!==e.achievements_earned&&(void 0!==e.achievements_earned&&Application.events.publish("achievementsEarned",e.achievements_earned),this.refreshAchievements())})),this.achievementsContainer||=this.constructor.createElement("div",{children:[this.constructor.createElement("a",{children:[this.constructor.createElement("span",{innerText:"Daily Achievements",style:{float:"left"}}),this.countdown=this.constructor.createElement("span",{className:"time-remaining",innerText:"00:00:00",style:{float:"right"}})],href:"/achievements",style:{borderBottom:"1px solid gray",color:"white",fontFamily:"helsinki",paddingBottom:"5px"}}),this.achievements=this.constructor.createElement("div",{id:"achievements-container",style:{display:"flex",flexDirection:"column",fontFamily:"riffic",gap:"0.4rem"}})],className:"simplemodal-container",style:{backgroundColor:"rgb(27 82 100)",backgroundImage:"linear-gradient(transparent, rgb(20, 63, 77))",borderRadius:"1rem",boxShadow:"0px 4px 8px 0px black",color:"white",display:"flex",flexDirection:"column",gap:"0.6rem",margin:"0 10px",padding:"1.5rem",width:"-webkit-fill-available"}})),this.refreshAchievements().then((e=>{this.countdown.innerText=[String(Math.floor(e.time_left/3600)).padStart(2,"0"),String(Math.floor(e.time_left%3600/60)).padStart(2,"0"),String(Math.floor(e.time_left%60)).padStart(2,"0")].join(":"),this.countdownTimer||=setInterval((()=>{let e=this.countdown.innerText.split(":").map((e=>parseInt(e)));0===e[2]&&(0===e[1]&&(e[0]--,e[1]=59),e[1]--,e[2]=59),e[2]--,0===e.reduce(((e,t)=>e+t),0)&&clearInterval(this.countdownTimer),this.countdown.innerText=e.map((e=>String(e).padStart(2,"0"))).join(":")}),1e3),document.querySelector("#right_content").prepend(this.achievementsContainer)}))}initBestDate(){this.leaderboardEvent||this.initLeaderboardEvent(),Application.router.current_view.on("leaderboard.rendered",(()=>{document.querySelectorAll(`.track-leaderboard-race-row[data-u_id="${Application.settings.user.u_id}"]`).forEach((e=>{e.setAttribute("title","Loading..."),e.addEventListener("mouseover",(e=>{fetch(location.pathname+"?ajax").then((e=>e.json())).then((({user_track_stats:{best_date:t}={}}={})=>{e.target.setAttribute("title",t??"Failed to load")}))}),{once:!0})}))}))}async initDownloadGhosts(){this.leaderboardEvent||this.initLeaderboardEvent(),this.styleSheet.set(".track-page .track-leaderboard .track-leaderboard-action",{textAlign:"right"}),this.styleSheet.set(".track-page .track-leaderboard .track-leaderboard-action > :is(span.core_icons, div.moderator-remove-race)",{right:"6px"}),Application.router.current_view.on("leaderboard.rendered",(()=>{for(let e of Array.from(document.querySelectorAll('.track-leaderboard-race-row[data-u_id="'+Application.settings.user.u_id+'"] > .track-leaderboard-action')).filter((e=>!e.querySelector("#download-race")))){let t=document.createElement("span");t.setAttribute("id","download-race"),t.setAttribute("title","Download Race"),t.classList.add("core_icons","core_icons-btn_add_race"),t.style.setProperty("background-image","linear-gradient(hsl(200 81% 65% / 1), hsl(200 60% 40% / 1))"),t.style.setProperty("clip-path","polygon(30% 5%, 30% 45%, 10% 45%, 50% 95%, 90% 45%, 70% 45%, 70% 5%)"),t.addEventListener("click",(function(){Application.Helpers.AjaxHelper.get("/track_api/load_races",{t_id:GameSettings.track.id,u_ids:t.parentElement.parentElement.dataset.u_id}).done((function(e){if(e.result){let[t]=e.data;t=Object.assign(t.race,{t_id:GameSettings.track.id,u_id:t.user.u_id});let s=document.createElement("a");s.setAttribute("download","frhd_ghost_"+GameSettings.track.id),s.setAttribute("href",URL.createObjectURL(new Blob([JSON.stringify(t,null,4)],{type:"application/json"}))),s.click(),URL.revokeObjectURL(s.getAttribute("href"))}}))})),e.style.setProperty("width","20%"),e.prepend(t),e.textContent.length>0&&e.replaceChildren(...e.children)}}))}async initDownloadTracks(){let e=document.querySelector(".subscribe-to-author"),t=e.cloneNode(!0),s=t.querySelector("#subscribe_to_author_count");s&&s.remove();let i=t.querySelector("#subscribe_to_author");i.removeAttribute("id"),i.innerText="Download",i.addEventListener("click",(()=>{this.constructor.downloadTrack(GameSettings.track.id)})),e.after(t)}featuredGhosts=null;initFeaturedGhosts(){this.leaderboardEvent||this.initLeaderboardEvent(),Application.router.current_view.on("leaderboard.rendered",(async({track_leaderboard:e})=>{this.featuredGhosts||=await fetch("https://raw.githubusercontent.com/calculamatrise/frhd-featured-ghosts/master/data.json").then((e=>e.json()));const t=Object.fromEntries(Object.entries(lite.featuredGhosts).filter((e=>Object.keys(e[1]=Object.fromEntries(Object.entries(e[1]).filter((([e])=>parseInt(e.split("/t/")[1])==Application.router.current_view._get_track_id())))).length)));for(const e in t)for(const s in t[e]){let i=s.split("/r/")[1];for(const o of document.querySelectorAll('.track-page .track-leaderboard .track-leaderboard-race-row[data-d_name="'+i+'" i]')){let i=10;switch(t[e][s]){case"fast":i=180;break;case"vehicle":i=40;break;case"trick":i=120}let a=o.querySelector(".num");a.classList.add("core_icons","core_icons-icon_featured_badge"),a.classList.remove("num"),a.innerText=null,a.setAttribute("title","Featured"),o.style.setProperty("background-color",`hsl(${i}deg 60% 50% / 40%)`)}}}))}initFriendsLastPlayed(){fetch(location.pathname+"?ajax").then((e=>e.json())).then((({friends:e,is_profile_owner:t})=>{t||document.querySelectorAll(".friend-list-item-name").forEach((t=>{t.after(this.constructor.createElement("div",{className:"friend-list-item-date",innerText:"Last Played "+e.friends_data.find((({d_name:e})=>e==t.innerText)).activity_time_ago}))}))}))}initGhostPlayer(){this.replayGui||=this.constructor.createElement("div",{style:{display:"none",inset:0,pointerEvents:"none",position:"absolute"}}),this.replayGui.progress||=this.replayGui.appendChild(this.constructor.createElement("progress",{className:"ghost-player-progress",id:"replay-seeker",max:100,min:0,value:0,style:{border:"none",bottom:0,height:"4px",pointerEvents:"all",position:"absolute",transition:"height 100ms",width:"100%"},type:"range",onchange(e){GameManager.game.currentScene.state.playing=!1;let t=GameManager.game.currentScene.playerManager.getPlayerByIndex(GameManager.game.currentScene.camera.focusIndex);t.isGhost()&&t._replayIterator.next(this.value)},onpointerdown(e){this.setPointerCapture(e.pointerId),this.value=Math.round(e.offsetX/parseInt(getComputedStyle(this).getPropertyValue("width"))*this.max),this.dispatchEvent(new InputEvent("change")),this.wasPlaying=GameManager.game.currentScene.state.playing},onpointermove(e){!0&e.buttons&&(this.value=Math.round(e.offsetX/parseInt(getComputedStyle(this).getPropertyValue("width"))*this.max),this.dispatchEvent(new InputEvent("change")))},onpointerup(e){this.releasePointerCapture(e.pointerId),GameManager.game.currentScene.state.playing=this.wasPlaying}})),this.styleSheet.set(".ghost-player-progress::-webkit-progress-value",{backgroundColor:"hsl(195deg 57% 25%)"}).set(".ghost-player-progress:hover",{cursor:"pointer",filter:"brightness(1.25)",height:"6px !important"}),this.constructor.waitForElm("#game-container").then((e=>{e.appendChild(this.replayGui)}))}leaderboardEvent=null;initLeaderboardEvent(){const e=this.leaderboardEvent=Application.Views.TrackView.prototype._render_leaderboards;Application.Views.TrackView.prototype._render_leaderboards=function(t){e.apply(this,arguments),t.result&&(this.trigger("leaderboard.rendered",...arguments),Application.events.publish("leaderboard.rendered",...arguments))}}notificationEvent=null;initNotificationEvent(){const e=Object.getPrototypeOf(Application.Helpers.AjaxHelper),t=this.notificationEvent=e._check_event_notification;e._check_event_notification=function(e){t.apply(this,arguments),e.result&&Application.events.publish("notification.received",...arguments)},Object.setPrototypeOf(Application.Helpers.AjaxHelper,e)}initRequestTrackData(){let e=document.querySelector("#delete-all-personal-data");if(e){let t=e.parentElement.appendChild(document.createElement("button"));t.classList.add("blue-button","settings-header","new-button"),t.style.setProperty("float","right"),t.style.setProperty("font-size","13px"),t.style.setProperty("height","auto"),t.style.setProperty("line-height","23px"),t.style.setProperty("margin-top","6px"),t.style.setProperty("margin-right","14px"),t.style.setProperty("padding","0 1rem"),t.innerText="Request All Data",t.addEventListener("click",(()=>{this.constructor.downloadAllTracks()}))}else console.warn("Request track data failed to load! Personal data is not present.")}ghostUploadDialog=null;initUploadGhosts(){this.ghostUploadDialog||=document.body.appendChild(this.constructor.createElement("dialog",{children:[this.constructor.createElement("div",{children:[this.constructor.createElement("span",{className:"editorDialog-close",innerText:"Ã—",onclick:()=>{this.ghostUploadDialog.close()}}),this.constructor.createElement("h1",{className:"editorDialog-content-title",innerText:"UPLOAD GHOST"})],className:"editorDialog-titleBar"}),this.constructor.createElement("div",{children:[this.constructor.createElement("span",{children:[this.constructor.createElement("span",{innerText:"Paste ghost data, drag and drop text files here, or "}),this.constructor.createElement("span",{className:"link",innerText:"select a file",onclick:()=>{this.ghostUploadPicker.click()}}),this.constructor.createElement("span",{innerText:" to import"}),this.ghostUploadPicker||=this.constructor.createElement("input",{accept:"application/json",type:"file",style:{display:"none"},oninput:async e=>{let[t]=e.target.files,s=JSON.parse(await t.text());s.t_id===GameSettings.track.id&&s.u_id===Application.settings.user.u_id&&(delete s.t_id,delete s.u_id,Application.Helpers.AjaxHelper.post("/track_api/track_run_complete",{t_id:GameSettings.track.id,u_id:Application.User.attributes.u_id,code:s.code,vehicle:s.vehicle,run_ticks:s.run_ticks,fps:25,time:(e=>{let t=e/30*1e3;t=parseInt(t,10);let s=Math.floor(t/6e4),i=(t-6e4*s)/1e3;return i=i.toFixed(2),10>i&&(i="0"+i),s+":"+i})(s.run_ticks),sig:await(async e=>Array.from(new Uint8Array(await crypto.subtle.digest("SHA-256",(new TextEncoder).encode(e)))).map((e=>e.toString(16).padStart(2,"0"))).join(""))(`${GameSettings.track.id}|${Application.User.attributes.u_id}|${s.code}|${+s.run_ticks}|${s.vehicle}|25|erxrHHcksIHHksktt8933XhwlstTekz`)}).done((function(e){e.result&&(Application.router.current_view.refresh_leaderboard(),Application.router.current_view.highlightLeaderboad(),setTimeout(refreshlb,1e3))})))}})],className:"importDialog-placeholder"}),this.constructor.createElement("textarea",{autocomplete:!1,className:"importDialog-code",spellcheck:!1})],className:"importDialog-codeContainer"}),this.constructor.createElement("div",{children:[this.constructor.createElement("button",{className:"primary-button primary-button-blue float-right margin-0-5",innerText:"Upload"}),this.constructor.createElement("button",{className:"primary-button primary-button-black float-right margin-0-5",innerText:"Cancel",onclick:()=>{this.ghostUploadDialog.close()}})],className:"editorDialog-bottomBar clearfix"})],className:"editorDialog-content editorDialog-content_importDialog",style:{margin:"revert",padding:0,position:"revert",top:"revert"}})),this.constructor.waitForElm("#friends-leaderboard-challenge").then((e=>{this.ghostUploadButton||(this.ghostUploadButton=e.cloneNode(!0),this.ghostUploadButton.classList.add("button-type-1"),this.ghostUploadButton.classList.remove("button-type-2"),this.ghostUploadButton.style.setProperty("margin-top",0),this.ghostUploadButton.removeAttribute("id"),this.ghostUploadButton.innerText="Upload Ghost",this.ghostUploadButton.addEventListener("click",(()=>{this.ghostUploadDialog.showModal()}))),e.after(this.ghostUploadButton)}))}initUserTrackAnalytics(){document.querySelectorAll("#created_tracks .bottom").forEach((e=>{e.innerHTML=e.innerHTML.replace(/<!--|-->/g,"")}))}initUserTrackModeration(){for(let e of document.querySelectorAll("#created_tracks .bottom")){let t=e.appendChild(document.createElement("label")),s=e.querySelector(".profileGravatarIcon");s&&s.style.setProperty("margin-right","4px"),t.appendChild(e.querySelector(".profileGravatarIcon")),t.appendChild(e.querySelector(".author")),t.style.setProperty("display","block");let i=t.appendChild(document.createElement("input"));i.setAttribute("type","checkbox"),i.style.setProperty("float","right"),i.style.setProperty("height","1.5rem")}let e=document.querySelector("#content > div > div.profile-tabs > section > div.tab_buttons > div").appendChild(document.createElement("select"));e.style.setProperty("border-radius","4px"),e.style.setProperty("float","right"),e.style.setProperty("font-family","system-ui,roboto_medium,Arial,Helvetica,sans-serif"),e.style.setProperty("letter-spacing","-.02em"),e.style.setProperty("margin-right","10px"),e.style.setProperty("margin-top","8px");let t=e.appendChild(document.createElement("option"));t.setAttribute("value","default"),t.disabled=!0,t.innerText="Select an action";let s=e.appendChild(document.createElement("option"));s.setAttribute("value","hide"),s.innerText="Delete selected";let i=e.appendChild(document.createElement("option"));i.setAttribute("value","deselect"),i.innerText="Deselect all";let o=e.appendChild(document.createElement("option"));o.setAttribute("value","select"),o.innerText="Select all",e.addEventListener("change",(async t=>{switch(t.target.disabled=!0,t.target.value){case"hide":let t=document.querySelectorAll("#created_tracks li:has(.bottom > label > input[type='checkbox']:checked)");if(t.length>0){let s=document.body.appendChild(document.createElement("dialog"));s.style.setProperty("border","none"),s.style.setProperty("box-shadow","0 0 4px 0px hsl(190deg 25% 60%)"),s.style.setProperty("max-height","75vh"),s.style.setProperty("max-width","50vw"),s.style.setProperty("padding",0),s.style.setProperty("width","120vmin");let i=s.appendChild(document.createElement("p"));i.style.setProperty("background-color","inherit"),i.style.setProperty("box-shadow","0 0 4px 0 black"),i.style.setProperty("padding","1rem"),i.style.setProperty("position","sticky"),i.style.setProperty("top",0),i.style.setProperty("z-index",3),i.innerText="Are you sure you would like to delete the following tracks?";let o=i.appendChild(document.createElement("span"));o.classList.add("core_icons","core_icons-icon_close"),o.style.setProperty("float","right"),o.addEventListener("click",(()=>s.remove()));let a=s.appendChild(document.createElement("ul"));a.classList.add("track-list","clearfix"),a.style.setProperty("max-height","50cqh"),a.style.setProperty("overflow-y","auto"),a.style.setProperty("padding","1rem"),a.style.setProperty("text-align","center"),a.append(...Array.from(t).map((e=>{let t=e.cloneNode(!0);return t.style.setProperty("width","min-content"),t})));let r=s.appendChild(document.createElement("form"));r.setAttribute("method","dialog"),r.style.setProperty("background-color","inherit"),r.style.setProperty("bottom",0),r.style.setProperty("display","flex"),r.style.setProperty("gap",".25em"),r.style.setProperty("box-shadow","0 0 4px 0 black"),r.style.setProperty("padding","1rem"),r.style.setProperty("position","sticky"),r.style.setProperty("z-index",2);let n=r.appendChild(document.createElement("button"));n.classList.add("new-button","button-type-1"),n.setAttribute("value","cancel"),n.innerText="Cancel";let h=r.appendChild(document.createElement("button"));h.classList.add("new-button","button-type-2"),h.setAttribute("value","default"),h.innerText="Confirm",h.addEventListener("click",(async e=>{e.preventDefault();for(let e of r.querySelectorAll("button"))e.disabled=!0,e.style.setProperty("opacity",.5),e.style.setProperty("pointer-events","none");r.appendChild(document.createElement("span")).classList.add("loading-hourglass");let t=[],i=a.querySelectorAll(".bottom:has(> label > input[type='checkbox']:checked)");for(let e of i){let s=e.querySelector(".name").getAttribute("href"),[i]=s.match(/(?<=\/t\/)\d+/);await fetch("/moderator/hide_track/"+i),t.push(i),e.closest("li").remove()}let o="frhd-lite_recently-hidden-tracks",n=Object.assign({},JSON.parse(sessionStorage.getItem(o)));n[Date.now()]=t,sessionStorage.setItem(o,JSON.stringify(n)),s.close(e.target.value)})),s.addEventListener("close",(t=>{e.disabled=!1,s.remove()})),s.showModal()}case"deselect":for(let e of document.querySelectorAll("#created_tracks .bottom > label > input[type='checkbox']:checked"))e.checked=!1;break;case"select":for(let e of document.querySelectorAll("#created_tracks .bottom > label > input[type='checkbox']:not(:checked)"))e.checked=!0}t.target.value="default",t.target.disabled=!1}))}refreshAchievements(){return fetch("/achievements?ajax").then((e=>e.json())).then((async e=>{let t=await Promise.all(e.achievements.filter((e=>!e.complete)).sort(((e,t)=>t.tot_num-e.tot_num)).slice(0,3).map(this.constructor.createProgressElement.bind(this.constructor)));return this.achievements.replaceChildren(...t),e}))}static createAccountContainer({login:e,password:t}){let s=this.createElement("div",{children:[this.createElement("button",{className:"new-button button-type-1",innerText:e,style:{width:"-webkit-fill-available"},onclick(){document.querySelector("#simplemodal-overlay")?.remove(),document.querySelector("#signup_login_container")?.remove(),Application.Helpers.AjaxHelper.post("/auth/standard_login",{login:e,password:t}).done((function(e){e.result&&Application.events.publish("auth.login",e.data.user,e.data.user_stats)}))}}),this.createElement("button",{className:"new-button",innerText:"X",style:{aspectRatio:1,backgroundImage:"linear-gradient(#ee5f5b,#c43c35)",marginRight:0},onclick(){let t=JSON.parse(localStorage.getItem("switcher-accounts"))??[];t.splice(t.indexOf(t.find((t=>t.login===e))),1),localStorage.setItem("switcher-accounts",JSON.stringify(t)),s.remove()}})],style:{display:"flex",gap:"0.25rem"}});return s}static async createProgressElement(e){let t=this.createElement("div",{children:[this.createElement("div",{children:[this.createElement("span",{className:"achievements-coin store_icons store_icons-coin_icon_lg achievement-coin-value",innerText:e.coins,style:{lineHeight:"45px",textAlign:"center",textShadow:"0 -1px 1px #9E8500"}}),this.createElement("div",{children:[this.createElement("a",{className:"title",children:[this.createElement("b",{innerText:e.title})],href:await(e=>{switch(e){case"Buy 1 item from the shop":return"store/gear";case"Complete 1 friend race":case"Win 5 friend(s) race":return fetch("/u/"+Application.settings.user.u_name+"?ajax").then((e=>e.json())).then((async({friends:e})=>{if(e.friend_cnt>0){let t;for(let s of e.friends_data)if(t=await fetch("/u/"+s.u_name).then((e=>e.json())).then((({recently_ghosted_tracks:{tracks:e}})=>e[Math.floor(Math.random()*e.length)])))return t}return"random/track"}));case"Improve 5 best times":case"Send 5 friend race challenges":return fetch("/u/"+Application.settings.user.u_name+"?ajax").then((e=>e.json())).then((({recently_ghosted_tracks:{tracks:e}})=>{let t=e[Math.floor(Math.random()*e.length)];return t?t.slug:"random/track"}));default:return"random/track"}})(e.desc),style:{width:"-webkit-fill-available"}}),this.createElement("h6",{className:"achievement-info-desc condensed",innerText:e.desc,style:{color:"darkgray",fontFamily:"roboto_bold",margin:0}})],className:"achievement-info"})],style:{alignItems:"center",display:"flex",gap:"0.5rem"}}),this.createElement("span",{innerText:e.progress,style:{fontSize:"1.25rem"}})],className:"achievement-info",style:{alignItems:"center",display:"flex",justifyContent:"space-between"}});return t}static createElement(e,t={}){const s=arguments[arguments.length-1],i=document.createElement(e);"innerText"in t&&(i.innerText=t.innerText,delete t.innerText);for(const e in t)if("object"==typeof t[e]){if(t[e]instanceof Array){if(/^children$/i.test(e))i.append(...t[e]);else if(/^on/i.test(e))for(const s of t[e])i.addEventListener(e.slice(2),s)}else/^style$/i.test(e)&&Object.assign(i[e.toLowerCase()],t[e]);delete t[e]}return Object.assign(i,t),"function"==typeof s&&s(i),i}static downloadTrack(e){fetch("/track_api/load_track?id="+e+"&fields[]=code&fields[]=id&fields[]=title").then((e=>e.json())).then((({data:e,result:t})=>{if(!t)return;let{track:s}=e,i=new Blob([s.code],{type:"text/plain"}),o=document.createElement("a");o.href=URL.createObjectURL(i),o.download=s.title+"-"+s.id,o.click(),URL.revokeObjectURL(o.href)}))}static zipHelperScript=null;static async downloadAllTracks(){this.zipHelperScript||(this.zipHelperScript=document.body.appendChild(document.createElement("script")),this.zipHelperScript.textContent=await fetch("https://raw.githubusercontent.com/Stuk/jszip/main/dist/jszip.min.js").then((e=>e.text()))),fetch("/u/"+Application.settings.user.u_name+"/created?ajax").then((e=>e.json())).then((async({created_tracks:e})=>{let t=new JSZip,s=await Promise.all(e.tracks.map((e=>fetch("/track_api/load_track?id="+e.id+"&fields[]=code&fields[]=id&fields[]=title").then((e=>e.json()))))).then((e=>e.filter((({result:e})=>e)).map((({data:e})=>e.track))));for(let e of s)t.file(e.title+"-"+e.id+".txt",e.code);t.generateAsync({type:"uint8array"}).then((e=>{let t=new Blob([e],{type:"application/zip"}),s=document.createElement("a");s.href=URL.createObjectURL(t),s.download="created-tracks",s.click(),URL.revokeObjectURL(s.href)}))}))}static waitForElm(e){return new Promise((t=>{if(document.querySelector(e))return t(document.querySelector(e));const s=new MutationObserver((i=>{document.querySelector(e)&&(t(document.querySelector(e)),s.disconnect())}));s.observe(document.body,{childList:!0,subtree:!0})}))}};const s=class{x=0;y=0;constructor(e,t){this.x=e,this.y=t}toReal(e){let t=e.camera,s=e.screen,i=(this.x-s.center.x)/t.zoom+t.position.x,o=(this.y-s.center.y)/t.zoom+t.position.y;return new this.constructor(i,o)}toScreen(e){let t=e.camera,s=e.screen,i=(this.x-t.position.x)*t.zoom+s.center.x,o=(this.y-t.position.y)*t.zoom+s.center.y;return new this.constructor(i,o)}lenSqr(){return Math.pow(this.x,2)+Math.pow(this.y,2)}len(){return Math.sqrt(Math.pow(this.x,2)+Math.pow(this.y,2))}dot(e){return this.x*e.x+this.y*e.y}factor(e){return new this.constructor(this.x*e,this.y*e)}factorSelf(e){this.x*=e,this.y*=e}factorOut(e,t){t.x=this.x*e,t.y=this.y*e}add(e){return new this.constructor(this.x+e.x,this.y+e.y)}inc(e){this.x+=e.x,this.y+=e.y}addOut(e,t){t.x=this.x+e.x,t.y=this.y+e.y}sub(e){return new this.constructor(this.x-e.x,this.y-e.y)}subOut(e,t){t.x=this.x-e.x,t.y=this.y-e.y}subSelf(e){this.x=this.x-e.x,this.y=this.y-e.y}equ(e){this.x=e.x,this.y=e.y}normalize(){let e=Math.sqrt(Math.pow(this.x,2)+Math.pow(this.y,2));return new this.constructor(this.x/e,this.y/e)}getAngleInDegrees(e){let t=e.sub(this),s=Math.atan2(t.x,-t.y)*(180/Math.PI);return s<0&&(s+=360),s}getAngleInRadians(e){let t=e.sub(this);return Math.atan2(t.x,-t.y)}},o=class{sectors=[];p1=null;p2=null;pp=null;len=0;collided=!1;highlight=!1;remove=!1;recorded=!1;type="scenery";constructor(e,t,i,o){this.p1=new s(e,t),this.p2=new s(i,o),this.pp=this.p2.sub(this.p1),this.len=this.pp.len()}move(e,t){return this.p1.x+=0|parseInt(e),this.p1.y+=0|parseInt(t),this.p2.x+=0|parseInt(e),this.p2.y+=0|parseInt(t),this}getCode(e){this.recorded=!0;let t=this.p2,s=" "+t.x.toString(32)+" "+t.y.toString(32),i=this.checkForConnectedLine(e,t);return i&&(s+=i.getCode(e)),s}checkForConnectedLine(e,t){let s=e.settings.drawSectorSize,i=e.sectors.drawSectors,o=Math.floor(t.x/s),a=Math.floor(t.y/s);return i[o][a].searchForLine(this.type+"Lines",t)}erase(e,t){let s=!1;if(!this.remove){let i=this.p1,o=this.p2.sub(i),a=i.sub(e),r=o.dot(o),n=2*a.dot(o),h=n*n-4*r*(a.dot(a)-t**2);if(h>0){h=Math.sqrt(h);let e=(-n-h)/(2*r),t=(-n+h)/(2*r);e>=0&&1>=e&&(s=!0,this.removeAllReferences()),t>=0&&1>=t&&(s=!0,this.removeAllReferences())}(this.intersects(this.p1.x,this.p1.y,e.x,e.y,t)||this.intersects(this.p2.x,this.p2.y,e.x,e.y,t))&&(s=!0,this.removeAllReferences())}return s}intersects(e,t,s,i,o){return o**2>=(e-s)**2+(t-i)**2}addSectorReference(e){this.sectors.push(e)}removeAllReferences(){this.remove=!0;for(let e of this.sectors)e.drawn=!1,e.dirty=!0;this.sectors=[]}},a=class extends o{type="physics";collide(e){if(!this.collided){this.collided=!0;let t=e.pos,s=e.vel,i=e.radius,o=0,a=0,r=0,n=this.p1,h=this.p2,l=t.x-n.x,c=t.y-n.y,p=this.pp,d=this.len,u=(l*p.x+c*p.y)/d/d;if(u>=0&&1>=u){let o=(l*p.y-c*p.x)*((l-s.x)*p.y-(c-s.y)*p.x)<0?-1:1,a=l-p.x*u,n=c-p.y*u;if(r=Math.sqrt(Math.pow(a,2)+Math.pow(n,2)),0===r&&(r=1),i>r||0>o){let s=(i*o-r)/r;return t.x+=a*s,t.y+=n*s,void e.drive(-n/r,a/r)}}if(!(-i>u*d||u*d>d+i)){let s=u>0?h:n;if(o=t.x-s.x,a=t.y-s.y,r=Math.sqrt(Math.pow(o,2)+Math.pow(a,2)),0===r&&(r=1),i>r){let s=(i-r)/r;return t.x+=o*s,t.y+=a*s,void e.drive(-a/r,o/r)}}}}},r=class{scene=null;color="#FFF";x=0;y=0;name=null;sector=null;settings=null;stack=0;outline="#000";remove=!1;constructor(e,t){let s=arguments[arguments.length-1];this.game=s.scene.game,this.scene=s.scene,this.settings=this.game.settings,this.x=e,this.y=t,this.remove=!1}addSectorReference(e){this.sector=e}collide(e){let t=e.pos.x-this.x,s=e.pos.y-this.y,i=Math.sqrt(Math.pow(t,2)+Math.pow(s,2));!this.hit&&26>i&&(this.hit=!0,this.sector.powerupCanvasDrawn=!1)}draw(e,t,s,i){this.constructor.cache.dirty&&this.recache(s);let o=this.constructor.cache.width*s,a=this.constructor.cache.height*s,r=o/2,n=a/2;i.drawImage(this.constructor.cache.canvas,e-r,t-n,o,a)}erase(e,t){let s=!1;return this.remove||t>=Math.sqrt(Math.pow(e.x-this.x,2)+Math.pow(e.y-this.y,2))&&(s=[this],this.removeAllReferences()),s}getCode(){let e="";return this.prefix&&(e=this.prefix+" "),e+this.x.toString(32)+" "+this.y.toString(32)}move(e,t){return this.x+=0|parseInt(e),this.y+=0|parseInt(t),this}recache(e){this.setDirty(!1);let t=this.constructor.cache.canvas;t.width=this.constructor.cache.width*e,t.height=this.constructor.cache.height*e;let s=t.getContext("2d"),i=t.width/2,o=t.height/2;this.drawPowerup(i,o,e,s),this.settings.developerMode&&(s.beginPath(),s.rect(0,0,t.width,t.height),s.strokeStyle="red",s.strokeWidth=1*e,s.stroke())}removeAllReferences(){this.remove=!0,this.sector&&(this.sector.powerupCanvasDrawn=!1,this.sector.dirty=!0,this.sector=null),this.scene.track.cleanPowerups()}setDirty(e){this.constructor.cache.dirty=e}static canvasPool=new Set;static createCache(){let e={canvas:document.createElement("canvas"),dirty:!0,width:25,height:25};return this.canvasPool.add(e),e}},n=class extends r{color="#08faf3";name="antigravity";prefix="A";constructor(e,t,s){super(s),this.x=e,this.y=t}collide(e){let t=e.parent,s=t.player,i=e.pos.x-this.x,o=e.pos.y-this.y;1e3>Math.pow(i,2)+Math.pow(o,2)&&s.isAlive()&&(!1===s.isGhost()&&((0!=t.gravity.x||0!=t.gravity.y)&&this.scene.sound.play("antigravity_sound",.3),this.scene.message.show("Antigravity Engaged",50,this.color)),t.gravity.x=0,t.gravity.y=0)}drawPowerup(e,t,s,i){let o=this.outline;/^(dark(er)?|midnight)$/i.test(lite.storage.get("theme"))&&(o=this.settings.physicsLineColor),s*=.5,i.save(),i.scale(s,s),i.fillStyle=this.color,i.strokeStyle=o,i.lineWidth=3,i.beginPath(),i.arc(25,25,11-i.lineWidth/2,0,2*Math.PI,!0),i.fill(),i.stroke(),i.beginPath(),i.moveTo(3,29.3196417),i.bezierCurveTo(4.74079001,38.2359804,11.7640196,45.2589035,20.6800518,46.9996935),i.lineTo(20.6800518,40.7043471),i.bezierCurveTo(15.1649961,39.1854465,10.814247,34.8350039,9.29534642,29.3196417),i.closePath(),i.moveTo(47,20.6803583),i.bezierCurveTo(45.25921,11.7640196,38.2362869,4.74079001,29.3196417,3),i.lineTo(29.3196417,9.29534642),i.bezierCurveTo(34.8350039,10.814247,39.185753,15.1646897,40.7046536,20.6803583),i.closePath(),i.moveTo(9.29534642,20.6803583),i.bezierCurveTo(10.814247,15.1646897,15.1649961,10.814247,20.6800518,9.29534642),i.lineTo(20.6800518,3),i.bezierCurveTo(11.7640196,4.74109649,4.74079001,11.7640196,3,20.6803583),i.closePath(),i.moveTo(29.3196417,46.9996935),i.bezierCurveTo(38.2362869,45.2589035,45.25921,38.2359804,47,29.3196417),i.lineTo(40.7046536,29.3196417),i.bezierCurveTo(39.185753,34.8350039,34.8350039,39.1854465,29.3196417,40.7043471),i.closePath(),i.lineWidth=5,i.stroke(),i.fill(),i.restore()}static cache=this.createCache()},h=class extends r{color="#d12929";name="bomb";prefix="O";collide(e){let t=e.parent,s=t.player,i=e.pos.x-this.x,o=e.pos.y-this.y;20>Math.sqrt(Math.pow(i,2)+Math.pow(o,2))&&s.isAlive()&&(t.explode(),!1===s.isGhost()&&(this.hit=!0,this.sector.powerupCanvasDrawn=!1))}drawPowerup(e,t,s,i){let o=this.outline;/^(dark(er)?|midnight)$/i.test(lite.storage.get("theme"))&&(o=this.settings.physicsLineColor),s*=.2,i.fillStyle=o,i.strokeStyle=o,i.lineWidth=8*s,i.beginPath(),i.moveTo(53*s,105*s),i.lineTo(41.5*s,115*s),i.lineTo(43*s,100*s),i.bezierCurveTo(35.5*s,95*s,30*s,88.5*s,26.5*s,80*s),i.lineTo(11*s,78*s),i.lineTo(24*s,69.5*s),i.bezierCurveTo(24*s,68*s,24*s,67*s,24*s,66*s),i.bezierCurveTo(24*s,58.5*s,26*s,51*s,30*s,45*s),i.lineTo(22*s,31.5*s),i.lineTo(37.5*s,36*s),i.bezierCurveTo(43.5*s,31*s,51*s,27.5*s,60*s,26*s),i.lineTo(66*s,11*s),i.lineTo(72*s,26.5*s),i.bezierCurveTo(80.5*s,27.5*s,88*s,31*s,93.5*s,36.5*s),i.lineTo(110*s,31.5*s),i.lineTo(101.5*s,46*s),i.bezierCurveTo(105*s,52*s,107*s,59*s,107*s,66*s),i.bezierCurveTo(107*s,67*s,107*s,68*s,107*s,69*s),i.lineTo(121*s,78*s),i.lineTo(104.5*s,80.5*s),i.bezierCurveTo(101.5*s,88*s,96*s,95*s,89*s,99.5*s),i.lineTo(90.5*s,115*s),i.lineTo(78.5*s,104.5*s),i.bezierCurveTo(74.5*s,106*s,70*s,107*s,65.5*s,107*s),i.bezierCurveTo(61*s,107*s,57*s,106*s,53*s,105*s),i.lineTo(53*s,105*s),i.closePath(),i.fill(),i.stroke(),i.beginPath(),i.arc(66*s,66*s,40*s,0*s,2*Math.PI,!0),i.lineWidth=2*s,i.fillStyle=this.color,i.fill(),i.stroke(),i.beginPath(),i.arc(66*s,66*s,8*s,0*s,2*Math.PI,!0),i.fillStyle=o,i.fill(),i.stroke()}static cache=Object.assign(this.createCache(),{width:26,height:26})},l=class extends r{angle=null;color="#8ac832";name="boost";prefix="B";realAngle=0;directionX=0;directionY=0;constructor(e,t,s,i){super(e,t,i),this.angle=s,this.realAngle=s;let o=(s-180)/360*2*Math.PI;this.directionX=(-Math.sin(o)).toFixed(15)/1,this.directionY=Math.cos(o).toFixed(15)/1}collide(e){let t=e.parent,s=t.player,i=e.pos.x-this.x,o=e.pos.y-this.y,a=Math.pow(i,2)+Math.pow(o,2),r=t.masses,n=r.length;if(1e3>a&&s.isAlive()){for(var h=n-1;h>=0;h--){var l=r[h].pos;l.x+=this.directionX*(1+this.stack),l.y+=this.directionY*(1+this.stack)}!1===s.isGhost()&&(this.scene.sound.play("boost_sound"),this.scene.message.show("Boost Engaged",50,this.color))}}draw(e,t,s,i){this.constructor.cache.dirty&&this.recache(s);let o=this.constructor.cache.width*s,a=this.constructor.cache.height*s,r=o/2,n=a/2,h=(this.angle-90)*(Math.PI/180);i.translate(e,t),i.rotate(h),i.drawImage(this.constructor.cache.canvas,-r,-n,o,a),i.rotate(-h),i.translate(-e,-t)}drawPowerup(e,t,s,i){let o=this.outline;/^(dark(er)?|midnight)$/i.test(lite.storage.get("theme"))&&(o=this.settings.physicsLineColor),s*=.2,i.save(),i.fillStyle=this.color,i.strokeStyle=o,i.lineWidth=Math.max(8*s,1),i.beginPath(),i.moveTo(8*s,4*s),i.lineTo(39*s,4*s),i.lineTo(70*s,40*s),i.lineTo(38*s,76*s),i.lineTo(8*s,76*s),i.lineTo(40*s,39*s),i.closePath(),i.moveTo(57*s,4*s),i.lineTo(89*s,4*s),i.lineTo(120*s,40*s),i.lineTo(88*s,76*s),i.lineTo(58*s,76*s),i.lineTo(89*s,39*s),i.closePath(),i.fill(),i.stroke()}getCode(){return super.getCode()+" "+this.realAngle.toString(32)}static cache=Object.assign(this.createCache(),{width:25,height:16})},c=class extends r{color="#826cdc";name="checkpoint";prefix="C";constructor(){super(...arguments),this.id=Math.random().toString(36).slice(2)}draw(e,t,s,i){i.save(),this.hit&&(i.globalAlpha=.3),super.draw(e,t,s,i),i.restore()}drawPowerup(e,t,s,i){let o=this.outline;/^(dark(er)?|midnight)$/i.test(lite.storage.get("theme"))&&(o=this.settings.physicsLineColor),s*=.15,i.save(),i.fillStyle=this.color,i.strokeStyle=o,i.lineWidth=8*s,i.beginPath(),i.moveTo(4*s,11*s),i.bezierCurveTo(4*s,11*s,34.5*s,28*s,56*s,11*s),i.bezierCurveTo(77*s,-5*s,109*s,11*s,109*s,11*s),i.lineTo(110*s,87*s),i.bezierCurveTo(110*s,87*s,75*s,74.5*s,57.5*s,87*s),i.bezierCurveTo(41*s,99*s,4*s,89.5*s,4*s,89.5*s),i.closePath(),i.fill(),i.stroke(),i.beginPath(),i.lineWidth=10*s,i.moveTo(5*s,11*s),i.lineTo(5*s,181*s),i.stroke(),i.restore()}collide(e){let t=e.parent.player,s=e.pos.x-this.x,i=e.pos.y-this.y,o=Math.sqrt(Math.pow(s,2)+Math.pow(i,2)),a=t._powerupsConsumed.checkpoints;26>o&&t.isAlive()&&-1===a.indexOf(this.id)&&(a.push(this.id),t.setCheckpointOnUpdate(),!1===t.isGhost()&&(this.hit=!0,this.sector.powerupCanvasDrawn=!1,this.scene.message.show("Checkpoint Saved",50,this.color,"#FFFFFF"),this.scene.sound.play("checkpoint_sound")))}static cache=Object.assign(this.createCache(),{width:18,height:28})},p=class extends r{angle=null;color="#376eb7";name="gravity";prefix="G";realAngle=0;constructor(e,t,s,i){super(...arguments),this.angle=s-180,this.realAngle=s;let o=this.angle/360*2*Math.PI;this.directionX=(-.3*Math.sin(o)).toFixed(15)/1,this.directionY=(.3*Math.cos(o)).toFixed(15)/1}collide(e){let t=e.parent,s=t.player,i=e.pos.x-this.x,o=e.pos.y-this.y,a=Math.pow(i,2)+Math.pow(o,2),r=(t.masses,this.directionX),n=this.directionY;1e3>a&&s.isAlive()&&(t.gravity.x=r,t.gravity.y=n,!1===s.isGhost()&&(this.scene.message.show("Gravity Changed",50,"#1F80C3","#FFFFFF"),this.scene.sound.play("gravity_down_sound")))}draw(e,t,s,i){this.constructor.cache.dirty&&this.recache(s);let o=this.constructor.cache.width*s,a=this.constructor.cache.height*s,r=o/2,n=a/2,h=(this.angle+90)*(Math.PI/180);i.translate(e,t),i.rotate(h),i.drawImage(this.constructor.cache.canvas,-r,-n,o,a),i.rotate(-h),i.translate(-e,-t)}drawPowerup(e,t,s,i){let o=this.outline;/^(dark(er)?|midnight)$/i.test(lite.storage.get("theme"))&&(o=this.settings.physicsLineColor),s*=.2,i.lineJoin="round",i.save(),i.lineWidth=Math.max(6*s,1),i.fillStyle=this.color,i.strokeStyle=o,i.beginPath(),i.moveTo(45*s,70*s),i.lineTo(45*s,95*s),i.lineTo(97*s,50*s),i.lineTo(45*s,5*s),i.lineTo(45*s,30*s),i.lineTo(3*s,30*s),i.lineTo(3*s,70*s),i.closePath(),i.fill(),i.stroke(),i.restore()}getCode(){return super.getCode()+" "+this.realAngle.toString(32)}static cache=Object.assign(this.createCache(),{width:20,height:20})},d=class extends r{name="slowmo";prefix="S";collide(e){let t=e.parent,s=t.player,i=e.pos.x-this.x,o=e.pos.y-this.y,a=Math.sqrt(Math.pow(i,2)+Math.pow(o,2));!this.hit&&26>a&&s.isAlive()&&(t.slow=!0,!1===s.isGhost()&&(this.scene.sound.play("slowmo_sound"),this.scene.message.show("Slow Motion",50,this.color,"#000000")))}drawPowerup(e,t,s,i){let o=this.outline;/^(dark(er)?|midnight)$/i.test(lite.storage.get("theme"))&&(o=this.settings.physicsLineColor),s*=.24,i.save(),i.scale(s,s),i.beginPath(),i.strokeStyle=o,i.lineWidth=3,i.arc(50,50,50-i.lineWidth/2,0,2*Math.PI),i.stroke(),i.beginPath(),i.arc(50,50,42.5-i.lineWidth/2,0,2*Math.PI),i.stroke(),i.beginPath(),i.lineWidth=5,i.moveTo(70,50),i.lineTo(50,50),i.lineTo(30,20),i.moveTo(92.5,50),i.lineTo(82.5,50),i.moveTo(50,7.5),i.lineTo(50,17.5),i.moveTo(50,92.5),i.lineTo(50,82.5),i.moveTo(7.5,50),i.lineTo(17.5,50),i.stroke(),i.restore()}static cache=Object.assign(this.createCache(),{width:26,height:24})},u=class extends r{color="#FAE335";name="goal";hit=!1;prefix="T";constructor(e,t,s){super(...arguments),this.id=Math.random().toString(36).slice(2)}cacheStar(e){let t=this.constructor.cache.canvas;t.width=this.constructor.cache.width*e,t.height=this.constructor.cache.height*e;let s=t.getContext("2d"),i=t.width/2,o=t.height/2;this.drawStar(i,o,5,10,5,!0,e,s),this.settings.developerMode&&(s.beginPath(),s.rect(0,0,t.width,t.height),s.strokeStyle="red",s.strokeWidth=1*e,s.stroke())}cacheEmptyStar(e){let t=this.constructor.hitCache.canvas;t.width=this.constructor.hitCache.width*e,t.height=this.constructor.hitCache.height*e;let s=t.getContext("2d"),i=t.width/2,o=t.height/2;this.drawStar(i,o,5,10,5,!1,e,s),this.settings.developerMode&&(s.beginPath(),s.rect(0,0,t.width,t.height),s.strokeStyle="red",s.strokeWidth=1*e,s.stroke())}collide(e){let t=e.parent.player,s=e.pos.x-this.x,i=e.pos.y-this.y,o=Math.sqrt(Math.pow(s,2)+Math.pow(i,2)),a=t._powerupsConsumed.targets,r=this.scene;if(26>o&&t.isAlive()&&-1===a.indexOf(this.id)){a.push(this.id);let e=a.length+this.stack,s=r.track.targetCount;!1===t.isGhost()&&(this.hit=!0,this.sector.powerupCanvasDrawn=!1,r.sound.play("goal_sound"),r.message.show(e+" of "+s+" Stars",50,this.color,"#666")),e>=s&&(t.complete=!0)}}draw(e,t,s,i){let o=this.constructor.hitCache;this.hit||(o=this.constructor.cache,o.dirty&&this.recache(s));let a=o.width*s,r=o.height*s,n=a/2,h=r/2;i.drawImage(o.canvas,e-n,t-h,a,r)}drawStar(e,t,s,i,o,a,r,n){let h=Math.PI/2*3,l=e,c=t,p=Math.PI/s;i*=r,o*=r,n.beginPath(),n.moveTo(e,t-i);for(let a=0;s>a;a++)l=e+Math.cos(h)*i,c=t+Math.sin(h)*i,n.lineTo(l,c),h+=p,l=e+Math.cos(h)*o,c=t+Math.sin(h)*o,n.lineTo(l,c),h+=p;n.lineTo(e,t-i),n.closePath(),n.lineWidth=Math.max(2*r,1),n.strokeStyle=/^(dark(er)?|midnight)$/i.test(lite.storage.get("theme"))?"#FBFBFB":this.outline,n.stroke(),n.fillStyle=a?this.color:"#FFFFFF",n.fill()}recache(e){this.setDirty(!1),this.cacheStar(e),this.cacheEmptyStar(e)}static cache=Object.assign(this.createCache(),{width:35,height:35});static hitCache=Object.assign(this.createCache(),{width:35,height:35})},m=class extends r{color="#dd45ec";id=null;otherPortal=null;hit=!1;name="teleport";recorded=!1;constructor(){super(...arguments),this.id=Math.random().toString(36).slice(2)}addOtherPortalRef(e){this.otherPortal=e}collide(e){let t=e.parent,s=t.player,i=s._powerupsConsumed.misc;if(-1===i.indexOf(this.id)){let o=e.pos.x-this.x,a=e.pos.y-this.y;1e3>Math.pow(o,2)+Math.pow(a,2)&&s.isAlive()&&(i.push(this.id),i.push(this.otherPortal.id),t.moveVehicle(this.otherPortal.x-this.x,this.otherPortal.y-this.y),!1===s.isGhost()&&(this.hit=!0,this.otherPortal.hit=!0,this.sector.powerupCanvasDrawn=!1,this.otherPortal.sector.powerupCanvasDrawn=!1,this.scene.sound.play("teleport_sound",.3),this.scene.message.show("Teleport Engaged",50,"#8ac832")))}}draw(e,t,s,i){i.save(),i.globalAlpha=!1===this.hit?1:.2,super.draw(e,t,s,i),i.restore()}drawPowerup(e,t,s,i){let o=this.outline;/^(dark(er)?|midnight)$/i.test(lite.storage.get("theme"))&&(o=this.settings.physicsLineColor),s*=.64,i.save(),i.scale(s,s),i.translate(2.6,3),i.fillStyle=this.color,i.strokeStyle=o,i.lineWidth=5,i.beginPath(),i.moveTo(23.9052288,5.91261647),i.bezierCurveTo(23.9052288,5.91261647,22.5543791,5.13614588,18.1099346,5.04995765),i.bezierCurveTo(13.6479739,5.05021647,9.39411765,6.99424,5.93111111,10.2266871),i.bezierCurveTo(2.88431373,13.0698635,.969542484,16.6517224,.241437908,20.8723576),i.bezierCurveTo(.0837908497,22.1227341,.0816993464,22.1341224,.0796078431,22.1452518),i.bezierCurveTo(.0929411765,25.8184753,.118562092,26.0470165,.145751634,26.2752988),i.bezierCurveTo(.550457516,29.6511341,1.80196078,32.7860047,3.86601307,35.59424),i.bezierCurveTo(4.76326797,36.8153694,6.27176471,38.4928047,7.6179085,39.4864282),i.bezierCurveTo(7.6179085,39.4864282,13.4911111,44.3481694,22.5543791,43.7872988),i.bezierCurveTo(16.5849673,39.6461224,15.7624837,37.5460282,15.7624837,37.5460282),i.bezierCurveTo(16.4521569,37.6208282,18.1535948,38.5391341,21.868366,38.5391341),i.bezierCurveTo(27.0628758,38.5391341,31.7535948,36.2909929,35.4330719,32.0377459),i.bezierCurveTo(37.5739869,29.5631341,38.9739869,26.6037459,39.5941176,23.2421459),i.lineTo(39.8856209,21.2448047),i.bezierCurveTo(39.7975163,18.0607576,39.7695425,17.8096988,39.7394771,17.5591576),i.bezierCurveTo(39.3355556,14.1864282,38.0845752,11.0515576,36.0215686,8.24176941),i.bezierCurveTo(34.9975163,6.84826353,33.8019608,5.59038118,32.4675817,4.50202824),i.bezierCurveTo(32.4675817,4.50202824,25.996732,-1.07536,16.5653595,.558592941),i.bezierCurveTo(21.6393464,2.28934588,23.9052288,5.91261647,23.9052288,5.91261647),i.stroke(),i.fill(),i.fillStyle=/^(dark(er)|midnight)?$/i.test(lite.storage.get("theme"))?"#1e1e1e":"#fefefe",i.beginPath(),i.moveTo(5.22875817,24.6992965),i.lineTo(5.22875817,23.0451553),i.bezierCurveTo(5.24078431,22.97812,5.25647059,22.9113435,5.26457516,22.8437906),i.bezierCurveTo(5.30823529,22.4770376,5.33254902,22.1071788,5.39555556,21.7440494),i.bezierCurveTo(5.9179085,18.7173671,7.26117647,16.0988494,9.5179085,13.9930612),i.bezierCurveTo(12.7882353,10.9404965,16.6520261,9.83428471,21.0614379,10.8020259),i.bezierCurveTo(23.1579085,11.2619553,24.9563399,12.2887082,26.3997386,13.8804729),i.bezierCurveTo(27.8005229,15.4251318,28.5681046,17.2482847,28.8130719,19.3033435),i.bezierCurveTo(29.0044444,20.9103788,28.7861438,22.4467553,28.0836601,23.9122141),i.bezierCurveTo(26.5186928,27.1764965,23.3458824,28.74652,19.8862745,27.9666847),i.bezierCurveTo(17.6018301,27.4518847,16.0658824,25.7762612,15.7793464,23.4833435),i.bezierCurveTo(15.7513725,23.2566141,15.7422222,23.0278141,15.7233987,22.7920259),i.bezierCurveTo(15.6826144,22.7959082,15.6577778,22.7959082,15.6345098,22.8013435),i.bezierCurveTo(15.2580392,22.8929671,15.0844444,23.1867318,14.9532026,23.5037906),i.bezierCurveTo(14.6407843,24.2592965,14.6128105,25.0383553,14.8180392,25.8238847),i.bezierCurveTo(15.1252288,26.9999788,15.8075817,27.9480494,16.7301961,28.7162376),i.bezierCurveTo(19.105098,30.6939082,21.8201307,31.2356259,24.7777778,30.3869435),i.bezierCurveTo(27.9027451,29.4903788,30.1628758,27.5002847,31.6556863,24.6703082),i.bezierCurveTo(33.1751634,21.7893435,33.4169935,18.73652,32.7003922,15.5969906),i.bezierCurveTo(32.1134641,13.0263553,30.9056209,10.7471553,29.2807843,8.67397882),i.bezierCurveTo(29.2345098,8.61496706,29.1887582,8.55595529,29.1427451,8.49694353),i.bezierCurveTo(30.1487582,9.31767294,31.0295425,10.2476259,31.7918954,11.2855082),i.bezierCurveTo(33.305098,13.3460024,34.2433987,15.6329671,34.5471895,18.1681435),i.bezierCurveTo(34.5856209,18.4903788,34.6206536,18.8131318,34.6569935,19.1356259),i.lineTo(34.6569935,20.7897671),i.bezierCurveTo(34.6449673,20.8565435,34.629281,20.92332,34.620915,20.9908729),i.bezierCurveTo(34.5644444,21.4313906,34.5309804,21.8763082,34.4501961,22.3121671),i.bezierCurveTo(34.0122876,24.6873906,33.0475817,26.8374376,31.4616993,28.6706847),i.bezierCurveTo(28.1134641,32.5408729,23.9121569,34.11012,18.8256209,33.0287553),i.bezierCurveTo(16.5994771,32.5553671,14.72,31.4287082,13.2504575,29.68372),i.bezierCurveTo(11.9879739,28.1846141,11.2983007,26.4463553,11.0705882,24.5126847),i.bezierCurveTo(10.871634,22.8236024,11.1286275,21.2212259,11.9113725,19.7042612),i.bezierCurveTo(13.5228758,16.5810376,16.6386928,15.0982376,19.9803922,15.8646141),i.bezierCurveTo(22.303268,16.3975318,23.7997386,18.0288965,24.1079739,20.3696965),i.bezierCurveTo(24.136732,20.5899553,24.1440523,20.8128024,24.1662745,21.1008729),i.bezierCurveTo(24.343268,20.9921671,24.5147712,20.9334141,24.6146405,20.8153906),i.bezierCurveTo(24.7620915,20.6414612,24.8909804,20.4375082,24.970719,20.2255318),i.bezierCurveTo(25.28,19.4032494,25.2648366,18.5688024,24.9890196,17.7405671),i.bezierCurveTo(24.5738562,16.4935553,23.7654902,15.5263318,22.715817,14.7615082),i.bezierCurveTo(20.315817,13.0147082,17.6664052,12.6334612,14.8541176,13.5207082),i.bezierCurveTo(11.8538562,14.4672259,9.67267974,16.4187553,8.23006536,19.1622847),i.bezierCurveTo(6.68470588,22.1014847,6.45960784,25.2078847,7.22352941,28.3996965),i.bezierCurveTo(7.82248366,30.8996729,9.0096732,33.1206376,10.5921569,35.1438612),i.bezierCurveTo(10.6420915,35.2083082,10.692549,35.2724965,10.743268,35.3364259),i.bezierCurveTo(9.97568627,34.7698612,8.83764706,33.5606376,8.09385621,32.5486376),i.bezierCurveTo(6.57986928,30.4886612,5.6420915,28.2016965,5.33830065,25.66652),i.bezierCurveTo(5.29960784,25.3442847,5.26535948,25.0215318,5.22875817,24.6992965),i.fill(),i.restore()}erase(e,t){let s=!1;return this.remove||t>=Math.sqrt(Math.pow(e.x-this.x,2)+Math.pow(e.y-this.y,2))&&(s=[this,this.otherPortal],this.removeAllReferences(),this.otherPortal.removeAllReferences()),s}getCode(){let e="";return!1===this.recorded&&!0===this.otherPortal.recorded?this.recorded=!0:!1===this.recorded&&!1===this.otherPortal.recorded?(this.recorded=!0,e="W "+super.getCode()+" "+this.otherPortal.x.toString(32)+" "+this.otherPortal.y.toString(32)):!0===this.recorded&&!0===this.otherPortal.recorded&&(this.otherPortal.recorded=!1,e="W "+super.getCode()+" "+this.otherPortal.x.toString(32)+" "+this.otherPortal.y.toString(32)),e}move(e,t){return this.otherPortal.x+=0|parseInt(e),this.otherPortal.y+=0|parseInt(t),super.move(e,t)}static cache=Object.assign(this.createCache(),{width:29,height:32})},g=class{scene=null;settings=null;drawSectorSize=null;row=0;column=0;camera=null;zoom=0;x=0;y=0;realX=0;realY=0;physicsLines=[];sceneryLines=[];canvasPool=null;canvas=null;ctx=null;dirty=!1;drawn=!1;hasPowerups=!1;lineCount=0;powerupCanvas=null;powerupCanvasOffset=35;powerupCanvasDrawn=!1;powerups=null;powerupsCount=0;constructor(e,t,s){this.track=s,this.scene=s.scene,this.settings=s.settings,this.drawSectorSize=this.settings.drawSectorSize,this.row=t,this.column=e,this.camera=s.camera,this.zoom=s.camera.zoom,this.canvasPool=s.canvasPool,this.x=e*this.drawSectorSize,this.y=t*this.drawSectorSize,this.realX=this.x*this.zoom,this.realY=this.y*this.zoom,this.powerups={all:[],goals:[],gravitys:[],boosts:[],slowmos:[],checkpoints:[],bombs:[],antigravitys:[],teleports:[],helicopters:[],trucks:[],balloons:[],blobs:[]}}addLine(e){e instanceof a&&this.physicsLines.push(e),e instanceof o&&this.sceneryLines.push(e),this.lineCount++,this.drawn=!1}searchForLine(e,t){return this[e].find((e=>e.p1.x===t.x&&e.p1.y===t.y&&!e.recorded&&!e.remove))}addPowerup(e){this.powerups.all.push(e),["goal","gravity","slowmo","boost","checkpoint","bomb","antigravity","teleport","helicopter","truck","balloon","blob"].includes(e.name)&&this.powerups[e.name+"s"].push(e),this.powerupsCount++,this.hasPowerups=!0,this.powerupCanvasDrawn=!1}erase(e,t,s){let i=[];if(!0===s.physics)for(let s of this.physicsLines.filter((s=>s.erase(e,t))))i.push(s);if(!0===s.scenery)for(let s of this.sceneryLines.filter((s=>s.erase(e,t))))i.push(s);if(!0===s.powerups)for(let s of this.powerups.all){let o=s.erase(e,t);o&&i.push(...o)}return i}cleanSector(){this.cleanSectorType("physicsLines"),this.cleanSectorType("sceneryLines"),this.cleanSectorType("powerups","all"),0===this.powerups.all.length?(this.hasPowerups=!1,this.powerupCanvas&&(this.canvasPool.releaseCanvas(this.powerupCanvas),this.powerupCanvas=null)):this.hasPowerups=!0,this.dirty=!1}cleanSectorType(e,t){let s=this[e];t&&(s=s[t]);for(let e=s.length-1;e>=0;e--)s[e].remove&&s.splice(e,1)}draw(){this.canvas=this.canvasPool.getCanvas(),this.canvas.width=this.drawSectorSize*this.scene.camera.zoom|0,this.canvas.height=this.drawSectorSize*this.scene.camera.zoom|0,this.ctx=this.canvas.getContext("2d"),this.ctx.lineCap="round",this.ctx.lineWidth=Math.max(2*this.scene.camera.zoom,.5),this.ctx.clearRect(0,0,this.canvas.width,this.canvas.height),this.ctx.beginPath(),this.ctx.strokeStyle=this.settings.sceneryLineColor,this.drawLines(this.sceneryLines,this.scene.camera.zoom,this.ctx),this.ctx.stroke(),this.ctx.beginPath(),this.ctx.strokeStyle=this.settings.physicsLineColor,this.drawLines(this.physicsLines,this.scene.camera.zoom,this.ctx),this.ctx.stroke(),this.settings.developerMode&&(this.ctx.beginPath(),this.ctx.strokeStyle="blue",this.ctx.rect(0,0,this.drawSectorSize*this.scene.camera.zoom|0,this.drawSectorSize*this.scene.camera.zoom|0),this.ctx.stroke()),this.drawn=!0}drawLine(e,t){this.canvas||(this.canvas=this.canvasPool.getCanvas(),this.canvas.width=this.drawSectorSize*this.scene.camera.zoom|0,this.canvas.height=this.drawSectorSize*this.scene.camera.zoom|0,this.ctx=this.canvas.getContext("2d"),this.ctx.lineCap="round",this.ctx.lineWidth=Math.max(2*this.scene.camera.zoom,.5)),this.ctx.beginPath(),this.ctx.strokeStyle=t,this.ctx.moveTo((e.p1.x-this.x)*this.scene.camera.zoom,(e.p1.y-this.y)*this.scene.camera.zoom),this.ctx.lineTo((e.p2.x-this.x)*this.scene.camera.zoom,(e.p2.y-this.y)*this.scene.camera.zoom),this.ctx.stroke()}cachePowerupSector(){if(this.powerupCanvasDrawn=!0,this.powerups.all.length>0){this.powerupCanvas=this.canvasPool.getCanvas(),this.powerupCanvas.width=this.drawSectorSize*this.scene.camera.zoom+this.powerupCanvasOffset*this.scene.camera.zoom|0,this.powerupCanvas.height=this.drawSectorSize*this.scene.camera.zoom+this.powerupCanvasOffset*this.scene.camera.zoom|0;let e=this.powerupCanvas.getContext("2d");e.clearRect(0,0,this.powerupCanvas.width,this.powerupCanvas.height),this.drawPowerups(this.powerups.slowmos,this.scene.camera.zoom,e),this.drawPowerups(this.powerups.checkpoints,this.scene.camera.zoom,e),this.drawPowerups(this.powerups.boosts,this.scene.camera.zoom,e),this.drawPowerups(this.powerups.gravitys,this.scene.camera.zoom,e),this.drawPowerups(this.powerups.bombs,this.scene.camera.zoom,e),this.drawPowerups(this.powerups.goals,this.scene.camera.zoom,e),this.drawPowerups(this.powerups.antigravitys,this.scene.camera.zoom,e),this.drawPowerups(this.powerups.teleports,this.scene.camera.zoom,e),this.drawPowerups(this.powerups.helicopters,this.scene.camera.zoom,e),this.drawPowerups(this.powerups.trucks,this.scene.camera.zoom,e),this.drawPowerups(this.powerups.balloons,this.scene.camera.zoom,e),this.drawPowerups(this.powerups.blobs,this.scene.camera.zoom,e),this.settings.developerMode&&(e.beginPath(),e.strokeStyle="red",e.rect(0,0,this.powerupCanvas.width,this.powerupCanvas.height),e.stroke())}}update(){this.realX=this.x*this.camera.zoom|0,this.realY=this.y*this.camera.zoom|0,this.zoom=this.camera.zoom}resetCollided(){let e=this.physicsLines.filter((e=>e.collided));for(let t=e.length-1;t>=0;t--)e[t].collided=!1}collide(e){let t=this.physicsLines.filter((e=>!e.collided));for(let s=t.length-1;s>=0;s--)t[s].remove?this.physicsLines.splice(this.physicsLines.indexOf(t[s],s),1):t[s].collide(e);if(e.parent.powerupsEnabled)for(let t=this.powerups.all.length-1;t>=0;t--)this.powerups.all[t].remove?this.powerups.all.splice(t,1):this.powerups.all[t].collide(e)}drawLines(e,t,s){for(let i in e)e[i].remove?e.splice(i,1):(s.moveTo((e[i].p1.x-this.x)*t,(e[i].p1.y-this.y)*t),s.lineTo((e[i].p2.x-this.x)*t,(e[i].p2.y-this.y)*t))}maxOverlapPowerups=0;drawPowerups(e,t,s){let i=e;window.hasOwnProperty("lite")&&lite.storage.get("experiments").filterOverlappingPowerups&&(i=e.reduce(((e,t)=>(e.filter((e=>t.x===e.x&&t.y===e.y)).length>this.maxOverlapPowerups||e.push(t),e)),[]));for(let o of i)o.remove?e.splice(e.indexOf(o),1):o.draw((o.x-this.x)*t+this.powerupCanvasOffset*t/2,(o.y-this.y)*t+this.powerupCanvasOffset*t/2,t,s)}drawBackground(e,t,s){e.beginPath(),e.rect(0,0,this.drawSectorSize*t|0,this.drawSectorSize*t|0),e.fillStyle=s,e.fill()}clear(){this.drawn=!1,this.powerupCanvasDrawn=!1,this.canvas&&(this.canvasPool.releaseCanvas(this.canvas),this.canvas=null,this.ctx=null),this.powerupCanvas&&(this.canvasPool.releaseCanvas(this.powerupCanvas),this.powerupCanvas=null)}close(){this.track=null,this.scene=null,this.settings=null,this.drawSectorSize=null,this.row=null,this.column=null,this.camera=null,this.zoom=null,this.canvasPool=null,this.x=null,this.y=null,this.realX=null,this.realY=null,this.lineCount=null,this.drawn=null,this.physicsLines=null,this.sceneryLines=null,this.canvas=null,this.ctx=null}},y=class extends r{hit=!1;index=0;stack=[];constructor(e,t,s,i){super(i),this.x=e,this.y=t,this.time=s,this.id=Math.random().toString(36).slice(2)}draw(e,t,s,i){this.hit||super.draw(e,t,s,i)}getCode(){let e=this.time,t="V "+super.getCode()+" "+this.index+" ",s="";return this.stack.length>0&&(s+=","+this.stack.map((e=>t+e.toString(32))).join(","),e-=this.stack.reduce(((e,t)=>e+t),0)),t+e.toString(32)+s}recache(e){this.constructor.cache.dirty=!1;let t=this.constructor.cache.canvas;t.width=this.constructor.cache.width*e,t.height=this.constructor.cache.height*e;let s=t.getContext("2d"),i=t.width/2,o=t.height/2;this.drawIcon(i,o,e,s),this.settings.developerMode&&(s.beginPath(),s.rect(0,0,t.width,t.height),s.strokeStyle="red",s.strokeWidth=1*e,s.stroke())}static createCache(){return Object.assign(super.createCache(),{width:24,height:24})}},w=class extends y{color="#f02728";index=3;name="balloon";collide(e){let t=e.parent,s=t.player,i=e.pos.x-this.x,o=e.pos.y-this.y,a=Math.sqrt(Math.pow(i,2)+Math.pow(o,2)),r=s._powerupsConsumed.misc,n=this.scene;if(30>a&&s.isAlive()&&-1===r.indexOf(this.id)){r.push(this.id);let e=this.time*n.settings.drawFPS;s.setTempVehicle(this.name.toUpperCase(),e,{x:this.x,y:this.y},t.dir),n.camera.playerFocus===s&&(n.camera.focusOnPlayer(),n.vehicleTimer.playerAddedTime(s)),!1===s.isGhost()&&(this.hit=!0,this.sector.powerupCanvasDrawn=!1,this.scene.message.show("Balloon Powerup!",50,this.color,!1))}}drawIcon(e,t,s,i){let o=this.outline;/^(dark(er)?|midnight)$/i.test(lite.storage.get("theme"))&&(o=this.settings.physicsLineColor),i.save(),i.scale(s,s),i.lineWidth=2,i.strokeStyle=o,i.fillStyle=o,i.beginPath(),i.roundRect(6,23,9,8,1),i.fill(),i.fillStyle=this.color,i.beginPath(),i.arc(10.5,10.5,10.5-i.lineWidth/2,0,2*Math.PI,!0),i.fill(),i.moveTo(15,18.5),i.lineTo(13,24),i.moveTo(8,24),i.lineTo(6,18.5),i.stroke(),i.restore()}static cache=Object.assign(this.createCache(),{width:21,height:31})},f=class extends y{color="#a784c5";index=4;name="blob";collide(e){let t=e.parent,s=t.player,i=e.pos.x-this.x,o=e.pos.y-this.y,a=Math.sqrt(Math.pow(i,2)+Math.pow(o,2)),r=s._powerupsConsumed.misc,n=this.scene;if(30>a&&s.isAlive()&&-1===r.indexOf(this.id)){r.push(this.id);var h=this.time*n.settings.drawFPS;s.setTempVehicle(this.name.toUpperCase(),h,{x:this.x,y:this.y},t.dir),n.camera.playerFocus===s&&(n.camera.focusOnPlayer(),n.vehicleTimer.playerAddedTime(s)),!1===s.isGhost()&&(this.hit=!0,this.sector.powerupCanvasDrawn=!1,this.scene.message.show("Blob Powerup!",50,this.color,!1))}}drawIcon(e,t,s,i){s*=1,i.save(),i.scale(s,s),i.beginPath(),i.strokeStyle=/^(dark(er)?|midnight)$/i.test(lite.storage.get("theme"))?"#FBFBFB":this.outline,i.fillStyle=this.color,i.lineWidth=2,i.roundRect(1,1,22,22,3.5),i.fill(),i.stroke(),i.restore()}static cache=this.createCache()},x=class extends y{color="#f59423";index=1;name="helicopter";collide(e){let t=e.parent,s=t.player,i=e.pos.x-this.x,o=e.pos.y-this.y,a=Math.sqrt(Math.pow(i,2)+Math.pow(o,2)),r=s._powerupsConsumed.misc,n=this.scene;if(30>a&&s.isAlive()&&-1===r.indexOf(this.id)){r.push(this.id);let e=this.time*n.settings.drawFPS;s.setTempVehicle("HELI",e,{x:this.x,y:this.y},t.dir),n.camera.playerFocus===s&&(n.camera.focusOnPlayer(),n.vehicleTimer.playerAddedTime(s)),!1===s.isGhost()&&(this.hit=!0,this.sector.powerupCanvasDrawn=!1,this.scene.message.show("Helicopter Powerup!",50,"#F2902E",!1))}}drawIcon(e,t,s,i){let o=this.outline;/^(dark(er)?|midnight)$/i.test(lite.storage.get("theme"))&&(o=this.settings.physicsLineColor),s*=1,i.save(),i.scale(s,s),i.lineCap="butt",i.lineJoin="miter",i.miterLimit=4,i.strokeStyle=o,i.fillStyle=o,i.beginPath(),i.moveTo(15,4.5),i.lineTo(15,2.5),i.bezierCurveTo(15,1.4,14.1,.5,13,.5),i.bezierCurveTo(11.9,.5,11,1.4,11,2.5),i.lineTo(11,4.5),i.bezierCurveTo(11,5.6,11.9,6.5,13,6.5),i.bezierCurveTo(14.1,6.5,15,5.6,15,4.5),i.lineTo(15,4.5),i.closePath(),i.fill(),i.beginPath(),i.lineCap="round",i.lineWidth=2,i.moveTo(1,3),i.lineTo(25,3),i.stroke(),i.lineCap="butt",i.lineWidth=1,i.beginPath(),i.moveTo(6.1,26.9),i.lineTo(4.1,31.9),i.bezierCurveTo(3.8,32.7,4.2,33.6,4.9,33.9),i.bezierCurveTo(5.7,34.2,6.6,33.8,6.9,33),i.lineTo(8.9,28),i.bezierCurveTo(9.2,27.3,8.8,26.4,8,26.1),i.bezierCurveTo(7.3,25.8,6.4,26.1,6.1,26.9),i.lineTo(6.1,26.9),i.closePath(),i.fill(),i.stroke(),i.beginPath(),i.moveTo(17,28),i.lineTo(19,33),i.bezierCurveTo(19.4,33.8,20.3,34.2,21,33.9),i.bezierCurveTo(21.8,33.6,22.2,32.7,21.9,31.9),i.lineTo(19.9,26.9),i.bezierCurveTo(19.6,26.2,18.7,25.8,17.9,26.1),i.bezierCurveTo(17.2,26.4,16.8,27.3,17.1,28),i.lineTo(17,28),i.closePath(),i.fill(),i.stroke(),i.fillStyle=this.color,i.lineWidth=2,i.beginPath(),i.arc(13,17,11,0,2*Math.PI,!0),i.closePath(),i.fill(),i.stroke(),i.fillStyle=o,i.beginPath(),i.moveTo(21,17),i.bezierCurveTo(21,12.6,17.4,9,13,9),i.bezierCurveTo(8.6,9,5,12.6,5,17),i.lineTo(21,17),i.closePath(),i.fill(),i.restore()}static cache=Object.assign(this.createCache(),{width:26,height:35})},v=class extends y{color="#94d44e";index=2;name="truck";collide(e){let t=e.parent,s=t.player,i=e.pos.x-this.x,o=e.pos.y-this.y,a=Math.sqrt(Math.pow(i,2)+Math.pow(o,2)),r=s._powerupsConsumed.misc,n=this.scene;if(30>a&&s.isAlive()&&-1===r.indexOf(this.id)){r.push(this.id);let e=this.time*n.settings.drawFPS;s.setTempVehicle(this.name.toUpperCase(),e,{x:this.x,y:this.y},t.dir),n.camera.playerFocus===s&&(n.camera.focusOnPlayer(),n.vehicleTimer.playerAddedTime(s)),!1===s.isGhost()&&(this.hit=!0,this.sector.powerupCanvasDrawn=!1,this.scene.message.show("Truck Powerup!",50,this.color,!1))}}drawIcon(e,t,s,i){let o=this.outline;/^(dark(er)?|midnight)$/i.test(lite.storage.get("theme"))&&(o=this.settings.physicsLineColor),s*=1,i.save(),i.scale(s,s),i.fillStyle=o,i.strokeStyle=o,i.save(),i.beginPath(),i.roundRect(1,16.5,6,10.5,1.5),i.roundRect(18,16.5,6,10.5,1.5),i.fill(),i.moveTo(4,22),i.lineTo(21,22),i.lineWidth=2,i.stroke(),i.fillStyle=this.color,i.beginPath(),i.moveTo(23,10),i.bezierCurveTo(23.5,10.5,24,11,24,12),i.lineTo(24,18),i.bezierCurveTo(23.5,19,23.5,20,21,20),i.lineTo(3,20),i.bezierCurveTo(2.5,20,1.5,19.5,1,18.5),i.lineTo(1,12),i.bezierCurveTo(1,11,1.5,10.5,2,10),i.lineTo(2,4),i.bezierCurveTo(2,2,3,1,4,1),i.lineTo(21,1),i.bezierCurveTo(22,1,23,2,23,3),i.closePath(),i.fill(),i.stroke(),i.restore(),i.beginPath(),i.rect(5.5,5,14,6),i.fill(),i.stroke(),i.beginPath(),i.arc(5.5,15,1.895,0,2*Math.PI,!0),i.arc(19.5,15,1.895,0,2*Math.PI,!0),i.fill(),i.restore()}static cache=Object.assign(this.createCache(),{width:25,height:28})},b=class{canvasPool=[];poolCap=5e3;setToScreen=!0;options=null;constructor(e){this.options=e,e.screen&&this.update(),e.cap&&(this.setToScreen=!1,this.poolCap=e.cap)}update(){this.setToScreen&&(this.getPoolCapFromScreen(),this.cleanPool())}getPoolCapFromScreen(){this.poolCap=Math.ceil(this.options.screen.width/Math.floor(this.options.settings.drawSectorSize*this.options.camera.zoom))*Math.ceil(this.options.screen.height/Math.floor(this.options.settings.drawSectorSize*this.options.camera.zoom))+Math.ceil(this.options.screen.width/Math.floor(this.options.settings.drawSectorSize*this.options.camera.zoom))+Math.ceil(this.options.screen.height/Math.floor(this.options.settings.drawSectorSize*this.options.camera.zoom))}getCanvas(){let e=this.canvasPool.pop();return e??=document.createElement("canvas")}releaseCanvas(e){this.canvasPool.length<this.poolCap&&this.canvasPool.push(e)}cleanPool(){this.canvasPool.length>this.poolCap&&(this.canvasPool=this.canvasPool.slice(0,this.poolCap+1))}};let k=[];const T=class{defaultLine={p1:new s(-40,50),p2:new s(40,50)};game=null;scene=null;camera=null;canvasPool=null;settings=null;physicsLines=[];sceneryLines=[];powerups=[];powerupsLookupTable={};targets=[];targetCount=0;sectors={};totalSectors=[];allowedVehicles=null;dirty=!1;constructor(e){this.scene=e,this.game=e.game,this.settings=e.game.settings,this.settings.track||(this.settings.track={vehicle:this.settings.startVehicle}),this.camera=e.camera,this.sectors.drawSectors=[],this.sectors.physicsSectors=[],this.allowedVehicles=["MTB","BMX"],this.canvasPool=new b(e),this.createPowerupCache()}createPowerupCache(){k.push(new l(0,0,0,this)),k.push(new d(0,0,this)),k.push(new h(0,0,this)),k.push(new p(0,0,0,this)),k.push(new c(0,0,this)),k.push(new u(0,0,this)),k.push(new n(0,0,this)),k.push(new m(0,0,this)),k.push(new x(0,0,0,this)),k.push(new v(0,0,0,this)),k.push(new w(0,0,0,this)),k.push(new f(0,0,0,this))}recachePowerups(e){for(const t of k)t.recache(e)}read(e){var t=e.split("#"),s=t[0].split(","),i=[],o=[];t.length>2?(i=t[1].split(","),o=t[2].split(",")):t.length>1&&(o=t[1].split(",")),this.addLines(s,this.addPhysicsLine),this.addLines(i,this.addSceneryLine),this.addPowerups(o)}move(e=0,t=0){for(const s in this.physicsLines)this.physicsLines[s].p1.x-=e,this.physicsLines[s].p1.y-=t,this.physicsLines[s].p2.x-=e,this.physicsLines[s].p2.y-=t,this.addPhysicsLineToTrack(this.physicsLines[s]),this.physicsLines.splice(i,1);for(const s in this.sceneryLines)this.sceneryLines[s].p1.x-=e,this.sceneryLines[s].p1.y-=t,this.sceneryLines[s].p2.x-=e,this.sceneryLines[s].p2.y-=t,this.addSceneryLineToTrack(s),this.sceneryLines.splice(i,1);for(const s in this.powerups)this.powerups[s].x-=e,this.powerups[s].y-=t,this.powerups[s].otherPortal&&(this.powerups[s].otherPortal.x-=e,this.powerups[s].otherPortal.y-=t),this.addPowerup(this.powerups[s]),this.powerups.splice(s,1);this.scene.redraw()}addPowerups(e){for(var t=e.length,s=[],i=0;t>i;i++)if((s=e[i].split(" ")).length>=2){for(var o=[],a=s.length,r=1;a>r;r++){var g=parseInt(s[r],32);o.push(g)}var y=Math.round(o[0]),b=Math.round(o[1]),k=null;switch(s[0]){case"B":k=new l(y,b,o[2],this),this.addPowerup(k);break;case"S":k=new d(y,b,this),this.addPowerup(k);break;case"O":k=new h(y,b,this),this.addPowerup(k);break;case"G":k=new p(y,b,o[2],this),this.addPowerup(k);break;case"C":k=new c(y,b,this),this.addPowerup(k);break;case"T":k=new u(y,b,this),this.addTarget(k),this.addPowerup(k);break;case"A":k=new n(y,b,this),this.addPowerup(k);break;case"V":var T=o[2],S=o[3],P=this.settings.vehiclePowerup.minTime,_=this.settings.vehiclePowerup.maxTime;if(S=S||P,S=Math.min(S,_),S=Math.max(S,P),window.hasOwnProperty("lite")&&lite.storage.get("experiments").filterDuplicatePowerups&&k&&(k=this.powerups.find((e=>e.x==y&&e.y==b)),k)){k.stack.push(S),k.time+=S;continue}switch(T){case 1:k=new x(y,b,S,this);break;case 2:k=new v(y,b,S,this);break;case 3:k=new w(y,b,S,this);break;case 4:k=new f(y,b,S,this);break;default:continue}this.addPowerup(k);break;case"W":var C=o[0],M=o[1],z=o[2],A=o[3],D=new m(C,M,this),L=new m(z,A,this);D.addOtherPortalRef(L),L.addOtherPortalRef(D),this.addPowerup(D),this.addPowerup(L)}}}addTarget(e){this.dirty=!0,this.targetCount++,this.targets.push(e)}maxDuplicatePowerups=0;addPowerup(e){this.addRef(e.x,e.y,e,2,this.sectors.physicsSectors,this.settings.physicsSectorSize);let t=this.addRef(e.x,e.y,e,2,this.sectors.drawSectors,this.settings.drawSectorSize);return!1!==t&&this.totalSectors.push(t),null!==e&&(this.powerups.push(e),e.id&&(this.powerupsLookupTable[e.id]=e)),e}addLines(e,t){for(let s=e.length,i=0;s>i;i++){let s=e[i].split(" "),o=s.length;if(o>3)for(let e=0;o-2>e;e+=2){let i=parseInt(s[e],32),o=parseInt(s[e+1],32),a=parseInt(s[e+2],32),r=parseInt(s[e+3],32);isNaN(i+o+a+r)||t.call(this,i,o,a,r)}}}addPhysicsLine(e,t,s,i){if(Math.sqrt(Math.pow(Math.round(s)-Math.round(e),2)+Math.pow(Math.round(i)-Math.round(t),2))>=2)return this.addPhysicsLineToTrack(new a(Math.round(e),Math.round(t),Math.round(s),Math.round(i)))}addPhysicsLineToTrack(e){for(let s=t(e.p1.x,e.p1.y,e.p2.x,e.p2.y,this.settings.drawSectorSize),i=0;s.length>i;i+=2){let t=this.addRef(s[i],s[i+1],e,1,this.sectors.drawSectors,this.settings.drawSectorSize);!1!==t&&this.totalSectors.push(t)}for(let s=t(e.p1.x,e.p1.y,e.p2.x,e.p2.y,this.settings.physicsSectorSize),i=0;s.length>i;i+=2)this.addRef(s[i],s[i+1],e,1,this.sectors.physicsSectors,this.settings.physicsSectorSize);return this.physicsLines.push(e),e}addSceneryLine(e,t,s,i){if(Math.sqrt(Math.pow(Math.round(s)-Math.round(e),2)+Math.pow(Math.round(i)-Math.round(t),2))>=2)return this.addSceneryLineToTrack(new o(Math.round(e),Math.round(t),Math.round(s),Math.round(i)))}addSceneryLineToTrack(e){for(let s=this.settings.drawSectorSize,i=e.p1,o=e.p2,a=t(i.x,i.y,o.x,o.y,s),r=this.sectors.drawSectors,n=a.length,h=0;n>h;h+=2){let t=this.addRef(a[h],a[h+1],e,1,r,s);!1!==t&&this.totalSectors.push(t)}return this.sceneryLines.push(e),e}addRef(e,t,s,i,o,a){let r=Math.floor(e/a),n=Math.floor(t/a),h=!1;if(void 0===o[r]&&(o[r]=[]),void 0===o[r][n]){let e=new g(r,n,this);o[r][n]=e,h=e}switch(i){case 1:o[r][n].addLine(s),s.addSectorReference(o[r][n]);break;case 2:if(window.hasOwnProperty("lite")&&lite.storage.get("experiments").filterDuplicatePowerups){let i=this.powerups.filter((s=>s.x==e&&s.y==t));if(s instanceof m&&(i=this.powerups.filter((i=>i.otherPortal!==s&&(i.x==e&&i.y==t&&i.otherPortal.x==s.otherPortal.x&&i.otherPortal.y==s.otherPortal.y||i.x==s.otherPortal.x&&i.y==s.otherPortal.y&&i.otherPortal.x==e&&i.otherPortal.y==t)))),i.length>this.maxDuplicatePowerups)return i[0].stack++,!1}o[r][n].addPowerup(s),s.addSectorReference(o[r][n])}return this.dirty=!0,h}cleanTrack(){this.cleanLines(),this.cleanPowerups()}cleanLines(){for(var e=this.physicsLines,t=this.sceneryLines,s=e.length,i=t.length,o=s-1;o>=0;o--)e[o].remove&&e.splice(o,1);for(var a=i-1;a>=0;a--)t[a].remove&&t.splice(a,1)}cleanPowerups(){for(var e=this.powerups,t=this.targets,s=this.targets.length,i=e.length-1;i>=0;i--)e[i].remove&&e.splice(i,1);for(var o=s-1;o>=0;o--)t[o].remove&&t.splice(o,1);this.targetCount=this.targets.length}updatePowerupState(e){this.resetPowerups(),this.setPowerupStates(e._powerupsConsumed.targets),this.setPowerupStates(e._powerupsConsumed.checkpoints),this.setPowerupStates(e._powerupsConsumed.misc)}setPowerupStates(e){for(const t of e)this.powerupsLookupTable[t].remove&&this.powerupsLookupTable[t].id&&(delete this.powerupsLookupTable[t],delete e[t]),this.powerupsLookupTable[t].hit=!0,this.powerupsLookupTable[t].sector.powerupCanvasDrawn=!1}select(e,t){const s=[];if(e.y<t.y)for(const i of[...this.physicsLines,...this.sceneryLines,...this.powerups].filter((e=>!e.remove)))i.p1||i.p2?(i.p1.x>e.x&&i.p1.y>e.y||i.p2.x>e.x&&i.p2.y>e.y)&&(i.p1.x<t.x&&i.p1.y<t.y||i.p2.x<t.x&&i.p2.y<t.y)&&s.push(i):i.x>e.x&&i.y>e.y&&i.x<t.x&&i.y<t.y&&s.push(i);else for(const i of[...this.physicsLines,...this.sceneryLines,...this.powerups].filter((e=>!e.remove)))i.p1||i.p2?(i.p1.x<=e.x&&i.p1.y<=e.y||i.p2.x<=e.x&&i.p2.y<=e.y&&i.p1.x>=t.x&&i.p1.y>=t.y||i.p2.x>=t.x&&i.p2.y>=t.y)&&s.push(i):i.x<e.x&&i.y<e.y&&i.x>t.x&&i.y>t.y&&s.push(i);return s}getCode(){this.cleanTrack();var e=this.powerups,t=this.physicsLines,s=this.sceneryLines,i="",o=t.length,a=s.length,r=e.length;if(o>0){for(var n in t)(l=t[n]).recorded||(i+=l.p1.x.toString(32)+" "+l.p1.y.toString(32)+l.getCode(this)+",");for(var n in i=i.slice(0,-1),t)t[n].recorded=!1}if(i+="#",a>0){for(var h in s){var l;(l=s[h]).recorded||(i+=l.p1.x.toString(32)+" "+l.p1.y.toString(32)+l.getCode(this)+",")}for(var h in i=i.slice(0,-1),s)s[h].recorded=!1}if(i+="#",r>0){for(var c in e){var p=e[c].getCode();p&&(i+=p+",")}i=i.slice(0,-1)}return i}resetPowerups(){for(let e of this.powerups.filter((e=>e.hit&&!e.remove)))e.sector.powerupCanvasDrawn=e.hit=!1}addDefaultLine(){this.addPhysicsLine(this.defaultLine.p1.x,this.defaultLine.p1.y,this.defaultLine.p2.x,this.defaultLine.p2.y)}erase(e,t,s){this.dirty=!0;for(var i=Math.floor(Math.min(e.x-t,e.x+t)/this.settings.drawSectorSize),o=[];Math.floor(Math.max(e.x-t,e.x+t)/this.settings.drawSectorSize)>=i;i++)for(var a=Math.floor(Math.min(e.y-t,e.y+t)/this.settings.drawSectorSize);Math.floor(Math.max(e.y-t,e.y+t)/this.settings.drawSectorSize)>=a;a++)this.sectors.drawSectors[i]&&this.sectors.drawSectors[i][a]&&o.push(this.sectors.drawSectors[i][a].erase(e,t,s));return o.flat()}drawAndCache(){for(var e=performance.now(),t=this.totalSectors,s=t.length,i=0;s>i;i++)!function(e){setTimeout((function(){e.draw(),e.cacheAsImage()}),250*i)}(t[i]);let o=performance.now();console.log("Track :: Time to draw entire track : "+(o-e)+"ms")}undraw(){for(let e of this.totalSectors.filter((e=>e.drawn)))e.clear(!0);this.recachePowerups(Math.max(this.camera.zoom,1)),this.canvasPool.update()}collide(e){let t=Math.floor(e.pos.x/this.settings.physicsSectorSize-.5),s=Math.floor(e.pos.y/this.settings.physicsSectorSize-.5);this.sectors.physicsSectors[t]&&this.sectors.physicsSectors[t][s]&&this.sectors.physicsSectors[t][s].resetCollided(),this.sectors.physicsSectors[t+1]&&this.sectors.physicsSectors[t+1][s]&&this.sectors.physicsSectors[t+1][s].resetCollided(),this.sectors.physicsSectors[t+1]&&this.sectors.physicsSectors[t+1][s+1]&&this.sectors.physicsSectors[t+1][s+1].resetCollided(),this.sectors.physicsSectors[t]&&this.sectors.physicsSectors[t][s+1]&&this.sectors.physicsSectors[t][s+1].resetCollided(),this.sectors.physicsSectors[t]&&this.sectors.physicsSectors[t][s]&&this.sectors.physicsSectors[t][s].collide(e),this.sectors.physicsSectors[t+1]&&this.sectors.physicsSectors[t+1][s]&&this.sectors.physicsSectors[t+1][s].collide(e),this.sectors.physicsSectors[t+1]&&this.sectors.physicsSectors[t+1][s+1]&&this.sectors.physicsSectors[t+1][s+1].collide(e),this.sectors.physicsSectors[t]&&this.sectors.physicsSectors[t][s+1]&&this.sectors.physicsSectors[t][s+1].collide(e)}getDrawSector(e,t){let s=Math.floor(e/this.settings.drawSectorSize),i=Math.floor(t/this.settings.drawSectorSize);return void 0!==this.sectors.drawSectors[s]&&void 0!==this.sectors.drawSectors[s][i]&&this.sectors.drawSectors[s][i]}draw(e){let t=this.scene.camera.position.x*this.scene.camera.zoom/(this.settings.drawSectorSize*this.scene.camera.zoom)-this.scene.screen.width/(this.settings.drawSectorSize*this.scene.camera.zoom)/2-1,s=this.scene.camera.position.y*this.scene.camera.zoom/(this.settings.drawSectorSize*this.scene.camera.zoom)-this.scene.screen.height/(this.settings.drawSectorSize*this.scene.camera.zoom)/2-1,i=this.scene.camera.position.x*this.scene.camera.zoom/(this.settings.drawSectorSize*this.scene.camera.zoom)+this.scene.screen.width/(this.settings.drawSectorSize*this.scene.camera.zoom)/2,o=this.scene.camera.position.y*this.scene.camera.zoom/(this.settings.drawSectorSize*this.scene.camera.zoom)+this.scene.screen.height/(this.settings.drawSectorSize*this.scene.camera.zoom)/2;e.imageSmoothingEnabled=!1;for(const a of this.totalSectors)if(a.dirty&&a.cleanSector(),a.column>=t&&i>=a.column&&a.row>=s&&o>=a.row){!1===a.drawn&&a.draw(),a.hasPowerups&&(a.powerupCanvasDrawn||a.cachePowerupSector());let t=a.column*(this.settings.drawSectorSize*this.scene.camera.zoom)-(this.scene.camera.position.x*this.scene.camera.zoom/(this.settings.drawSectorSize*this.scene.camera.zoom)*(this.settings.drawSectorSize*this.scene.camera.zoom)-this.scene.screen.center.x)|0,s=a.row*(this.settings.drawSectorSize*this.scene.camera.zoom)-(this.scene.camera.position.y*this.scene.camera.zoom/(this.settings.drawSectorSize*this.scene.camera.zoom)*(this.settings.drawSectorSize*this.scene.camera.zoom)-this.scene.screen.center.y)|0;e.drawImage(a.canvas,t,s,this.settings.drawSectorSize*this.scene.camera.zoom,this.settings.drawSectorSize*this.scene.camera.zoom),a.hasPowerups&&a.powerupCanvasDrawn&&e.drawImage(a.powerupCanvas,t-a.powerupCanvasOffset*this.scene.camera.zoom/2,s-a.powerupCanvasOffset*this.scene.camera.zoom/2,this.settings.drawSectorSize*this.scene.camera.zoom+a.powerupCanvasOffset*this.scene.camera.zoom,this.settings.drawSectorSize*this.scene.camera.zoom+a.powerupCanvasOffset*this.scene.camera.zoom)}else a.drawn&&a.clear()}closeSectors(){for(const e of this.totalSectors)e.close()}close(){this.scene=null,this.closeSectors(),this.totalSectors=null,this.canvasPool=null,this.sectors=null,this.physicsLines=null,this.sceneryLines=null,this.powerups=null,this.camera=null}},S=class{scene=null;clockwise=!1;screen=null;settings=null;constructor(e){this.scene=e,this.screen=e.screen,this.settings={radius:10,color:"#1884cf"}}draw(e){let t=this.screen,s=this.settings,i=this.scene.game.pixelRatio,o=s.radius,a=this.scene.game._updates%25/25*2*Math.PI;0===a&&(this.clockwise=!this.clockwise);let r=t.width-25*i,n=t.height-25*i;e.beginPath(),e.arc(r,n,o*i,0,a,!this.clockwise),e.lineWidth=3*i,e.strokeStyle=s.color,e.stroke()}},P=class{color="#000";message=!1;timeout=!1;constructor(e){this.scene=e}draw(e){let t=this.message,s=this.timeout,i=this.color,o=this.outline;if(!1!==s&&0>=s&&(t=!1),this.scene.state.paused&&(i=!1,o=!1,t="Paused"+(this.scene.settings.mobile?"":" - Press Spacebar to Continue")),!1===i&&(i="#".padEnd(7,"midnight"==lite.storage.get("theme")?"8":/^dark(er)?$/i.test(lite.storage.get("theme"))?"c":"3")),t){let s=this.scene.game,a=this.scene,r=s.pixelRatio,n=a.screen.center.x,h=100;"phone"===a.settings.controls&&(h=80),e.save(),e.fillStyle=i,e.lineWidth=r/2*4,e.font=12*r+"pt helsinki",e.textAlign="center",o&&(e.strokeStyle=o,e.strokeText(t,n,h*r)),e.fillText(t,n,h*r),e.restore()}}show(e,t,s,i){this.message=e,this.timeout=t,this.color=/^#(0|3){3,6}$/.test(s)?this.scene.settings.physicsLineColor:s,this.outline="midnight"==lite.storage.get("theme")?"#1d2328":"darker"==lite.storage.get("theme")?"#000":"dark"==lite.storage.get("theme")?"#1b1b1b":i}hide(){this.message=!1,this.color=!1,this.outline=!1}update(){!1!==this.timeout&&this.timeout--}};function _(e){let t=(e=parseInt(e,10))%6e4/1e3;return Math.floor(e/6e4)+":"+t.toFixed(2).padStart(5,0)}const C=class{cached=!1;paused=!1;scene=null;state=null;sprites={};container={children:[],color:"#000000",font:20,height:58,x:10,y:10,get scale(){return window.devicePixelRatio/2.5},get width(){return this.children.at(-1).x}};spriteSheet={timer:[2,2,58,58],timer_paused:[2,62,116,118],target:[2,2,58,58]};time={font:40,text:"0:00.00",x:57,y:18};time_title={color:"#999999",text:"TIME:",x:59,y:3};timer_sprite={image:"timer",x:0,y:0};best_time={color:"#999999",font:35,text:"-- : --.--",x:237,y:21};best_time_title={color:"#999999",text:"BEST:",x:240,y:3};goals={font:40,text:"0/0",x:460,y:15};target_sprite={image:"target",x:400,y:0};constructor(e){this.scene=e,this.container.children.push(this.time),this.container.children.push(this.time_title),this.container.children.push(this.timer_sprite),this.container.children.push(this.best_time),this.container.children.push(this.best_time_title),this.container.children.push(this.goals),this.container.children.push(this.target_sprite),this.sprites.timer=this.scene.assets.getResult("time_icon"),this.sprites.target=this.scene.assets.getResult("targets_icon")}draw(e){e.save(),e.fillStyle=this.container.color;let t=this.container.font*this.container.scale+"px helsinki";e.font=t,e.textAlign="left",e.textBaseline="top",e.imageSmoothingEnabled=!0;for(const s of this.container.children)if(s.hasOwnProperty("image")){let t=this.spriteSheet[s.image];e.drawImage(this.sprites[s.image.replace("_paused","")],...t,(this.container.x+s.x)*this.container.scale,(this.container.y+s.y)*this.container.scale,t[2]*this.container.scale,t[3]*this.container.scale)}else s.hasOwnProperty("text")&&(s.color&&(e.fillStyle=s.color),s.font&&(e.font=s.font*this.container.scale+"px helsinki"),e.fillText(s.text,(this.container.x+s.x)*this.container.scale,(this.container.y+s.y)*this.container.scale),s.color&&(e.fillStyle=this.container.color),s.font&&(e.font=t));e.restore()}update(){let e=this.scene.state.paused;this.paused!==e&&(e?(this.timer_sprite.image="timer_paused",this.paused=!0):(this.timer_sprite.image="timer",this.paused=!1)),!1===this.cached&&this.scene.ticks>50&&(this.cached=!0),this.time.text=_(1e3*((this.scene.camera.focusIndex>0?this.scene.playerManager.getPlayerByIndex(this.scene.camera.focusIndex)._gamepad.playbackTicks:null)??this.scene.ticks)/this.scene.settings.drawFPS),this.goals.text=this.scene.playerManager.firstPlayer.getTargetsHit()+"/"+this.scene.track.targetCount,this.best_time.text="-- : --.--",this.scene.settings.isCampaign&&this.scene.settings.campaignData.user.best_time?this.best_time.text=this.scene.settings.campaignData.user.best_time:this.scene.settings.userTrackStats&&this.scene.settings.userTrackStats.best_time&&(this.best_time.text=this.scene.settings.userTrackStats.best_time),this.scene.settings.mobile&&this.center_container()}center_container(){let e=this.container,t=e.width,s=this.scene.screen;e.x=10+s.width/2-t/2*e.scale,e.y=10*window.devicePixelRatio}},M=class{constructor(){this._events=this._events||{},this._maxListeners=this._maxListeners||void 0,this._events=void 0,this._maxListeners=void 0,this.defaultMaxListeners=10}setMaxListeners(e){if("number"!=typeof e||0>e||isNaN(e))throw TypeError("n must be a positive number");return this._maxListeners=e,this}emit(e){var t,s,i,o,a,r;if(this._events||(this._events={}),"error"===e&&(!this._events.error||"object"==typeof this._events.error&&null!==this._events.error&&!this._events.error.length)){if((t=arguments[1])instanceof Error)throw t;throw TypeError('Uncaught, unspecified "error" event.')}if(void 0===(s=this._events[e]))return!1;if("function"==typeof s)switch(arguments.length){case 1:s.call(this);break;case 2:s.call(this,arguments[1]);break;case 3:s.call(this,arguments[1],arguments[2]);break;default:for(i=arguments.length,o=new Array(i-1),a=1;i>a;a++)o[a-1]=arguments[a];s.apply(this,o)}else if("object"==typeof s&&null!==s){for(i=arguments.length,o=new Array(i-1),a=1;i>a;a++)o[a-1]=arguments[a];for(i=(r=s.slice()).length,a=0;i>a;a++)r[a].apply(this,o)}return!0}addListener(e,t){var s;if("function"!=typeof t)throw TypeError("listener must be a function");return this._events||(this._events={}),this._events.newListener&&this.emit("newListener",e,"function"==typeof t.listener?t.listener:t),this._events[e]?"object"==typeof this._events[e]&&null!==this._events[e]?this._events[e].push(t):this._events[e]=[this._events[e],t]:this._events[e]=t,"object"!=this._events[e]||null===this._events[e]||this._events[e].warned||(s=void 0===this._maxListeners?i.defaultMaxListeners:this._maxListeners)&&s>0&&this._events[e].length>s&&(this._events[e].warned=!0,console.error("(node) warning: possible EventEmitter memory leak detected. %d listeners added. Use emitter.setMaxListeners() to increase limit.",this._events[e].length),"function"==typeof console.trace&&console.trace()),this}on=this.addListener;once(e,t){function s(){this.removeListener(e,s),i||(i=!0,t.apply(this,arguments))}if("function"!=typeof t)throw TypeError("listener must be a function");var i=!1;return s.listener=t,this.on(e,s),this}removeListener(e,t){var s,i,o,a;if("function"!=typeof t)throw TypeError("listener must be a function");if(!this._events||!this._events[e])return this;if(o=(s=this._events[e]).length,i=-1,s===t||"function"==typeof s.listener&&s.listener===t)delete this._events[e],this._events.removeListener&&this.emit("removeListener",e,t);else if("object"==typeof s&&null!==s){for(a=o;a-- >0;)if(s[a]===t||s[a].listener&&s[a].listener===t){i=a;break}if(0>i)return this;1===s.length?(s.length=0,delete this._events[e]):s.splice(i,1),this._events.removeListener&&this.emit("removeListener",e,t)}return this}removeAllListeners(e){var t,s;if(!this._events)return this;if(!this._events.removeListener)return 0===arguments.length?this._events={}:this._events[e]&&delete this._events[e],this;if(0===arguments.length){for(t in this._events)"removeListener"!==t&&this.removeAllListeners(t);return this.removeAllListeners("removeListener"),this._events={},this}if("function"==typeof(s=this._events[e]))this.removeListener(e,s);else for(;s.length;)this.removeListener(e,s[s.length-1]);return delete this._events[e],this}listeners(e){return this._events&&this._events[e]?"function"==typeof this._events[e]?[this._events[e]]:this._events[e].slice():[]}listenerCount(e,t){return e._events&&e._events[t]?"function"==typeof e._events[t]?1:e._events[t].length:0}},z=class extends M{enabled=!0;scene=null;touch=null;touches=[];updateCallback=!1;wheel=!1;mousewheel=!1;mouseMoveListener=null;mouseUpListener=null;mouseDownListener=null;throttledMouseWheel=null;analytics=null;constructor(e){super(),this.scene=e,this.touch=this.getTouchObject(),this.touch.old=this.getTouchObject(),this.secondaryTouch=this.getTouchObject(),this.secondaryTouch.old=this.getTouchObject(),this.initAnalytics(),this.bindToMouseEvents()}contextMenuHandler(e){return e.stopPropagation(),e.preventDefault(),!1}initAnalytics(){this.analytics={clicks:0}}getTouchObject(){return{id:null,down:!1,press:!1,release:!1,pos:new s(0,0),real:new s(0,0),type:1}}bindToMouseEvents(){let e=this.scene.game.canvas,t=this.onMouseMove.bind(this),s=this.onMouseDown.bind(this),i=this.onMouseUp.bind(this);e.addEventListener("pointermove",t),e.addEventListener("pointerdown",s),e.addEventListener("pointerup",i),this.mouseMoveListener=t,this.mouseDownListener=s,this.mouseUpListener=i;let o=this.onMouseWheel.bind(this);e.addEventListener("mousewheel",o),e.addEventListener("wheel",o),e.addEventListener("DOMMouseScroll",o),this.mouseWheelListener=o}onMouseDown(e){this.scene.game.canvas.setPointerCapture(e.pointerId),this.analytics.clicks++,2===e.button?!1===this.secondaryTouch.down&&(this.updatePosition(e,this.secondaryTouch),this.secondaryTouch.down=!0):!1===this.touch.down&&(this.updatePosition(e,this.touch),this.scene.interactWithControls(),this.touch.down=!0)}disableContextMenu(){this.scene.game.canvas.oncontextmenu=function(){return!1}}onMouseUp(e){this.scene.game.canvas.releasePointerCapture(e.pointerId),2===e.button?!0===this.secondaryTouch.down&&(this.updatePosition(e,this.secondaryTouch),this.secondaryTouch.down=!1):!0===this.touch.down&&(this.updatePosition(e,this.touch),this.touch.down=!1)}updatePosition(e,t){t.id=e.pointerId,t.type=e.button;let s=t.pos;s.x=e.offsetX*window.devicePixelRatio,s.y=e.offsetY*window.devicePixelRatio,this.updateRealPosition(t)}updateRealPosition(e){let t=e.real;if(t.x=Math.round((e.pos.x-this.scene.screen.center.x)/this.scene.camera.zoom+this.scene.camera.position.x),t.y=Math.round((e.pos.y-this.scene.screen.center.y)/this.scene.camera.zoom+this.scene.camera.position.y),this.scene.toolHandler.options.grid){let s=0|this.scene.settings.toolHandler.gridSize;if(lite.storage.get("isometricGrid")){function i(e,t){return(e%t+t)%t}let o=s/2,a=Math.round(t.x/s),r=i(a,2);t.x=a*s,t.y=t.y-i(t.y+o*(r+1),s)-o*(r-1)+r*o}else t.x=Math.round(t.x/s)*s,t.y=Math.round(t.y/s)*s}this.updateCallback=!0}onMouseWheel(e){e.preventDefault(),e.stopPropagation();let t=Math.max(-1,Math.min(1,-e.deltaY||-e.detail));return 0==t&&(t=Math.max(-1,Math.min(1,e.deltaX||-e.detail))),this.wheel=t,!1}onMouseMove(e){this.updatePosition(e,this.touch),this.updatePosition(e,this.secondaryTouch)}update(){this.enabled&&(this.updateTouch(this.touch),this.updateTouch(this.secondaryTouch),this.updateWheel())}updateTouch(e){e.old.pos.x=e.pos.x,e.old.pos.y=e.pos.y,e.old.real.x=e.real.x,e.old.real.y=e.real.y,!e.old.down&&e.down&&(e.press=!0),e.old.down&&!e.down&&(e.release=!0),e.old.press&&(e.press=!1),e.old.release&&(e.release=!1),this.updateRealPosition(e),e.old.down=e.down,e.old.press=e.press,e.old.release=e.release}updateWheel(){this.mousewheel=this.wheel,this.wheel=!1}close(){let e=this.scene.game.canvas;e.removeEventListener("mousewheel",this.mouseWheelListener),e.removeEventListener("DOMMouseScroll",this.mouseWheelListener),this.touches=null,this.touch=null,this.scene=null,this.wheel=null,this.mouseMoveListener=null,this.mouseDownListener=null,this.mouseUpListener=null}},A=class{muted=!1;sounds={};constructor(e){this.scene=e}update(){let e=this.scene;this.muted=e.state.paused||!1===e.settings.soundsEnabled;for(let t in this.sounds)this.sounds[t].muted=this.muted,this.sounds[t].paused&&!e.state.paused?this.sounds[t].play():!this.sounds[t].paused&&e.state.paused&&this.sounds[t].pause()}setVolume(e,t){this.sounds[e]&&(this.sounds[e].volume=this.muted?0:t??1)}mute_all(){let e=this.sounds;for(let t in e)e[t].muted=!0,e[t].volume=0;this.muted=!0}stop_all(){for(let e in this.sounds)this.stop(e)}play(e,t){if(!this.sounds[e]&&this.scene.settings.soundsEnabled){let t=this.scene.assets.getItem(e),s=t&&new Audio(t.src);s&&(this.sounds[e]=s,s.addEventListener("ended",(()=>{delete this.sounds[e]})))}this.setVolume(e,t)}stop(e){this.sounds[e]&&(this.sounds[e].pause(),delete this.sounds[e])}close(){this.sounds=null}},D=class{name="";toolhandler=null;camera=null;mouse=null;scene=null;constructor(e){this.toolhandler=e,this.scene=e.scene,this.game=e.scene.game,this.camera=e.scene.camera,this.mouse=e.scene.mouse,this.gamepad=e.gamepad}press(){}hold(){}release(){}update(){let e=this.mouse,t=e.touch,s=e.secondaryTouch,i=this.toolhandler.gamepad,o=this.toolhandler.options,a=i.isButtonDown("shift");o.rightClickMove&&(a=s.old.down),a?(t.old.down||o.rightClickMove)&&this.moveCamera():(t.press&&this.press(),t.old.down&&this.hold(),t.release&&this.release()),!1!==e.mousewheel&&!1===i.isButtonDown("shift")&&this.mousewheel(e.mousewheel)}moveCamera(){let e=this.mouse.secondaryTouch,t=e.pos,s=this.camera,i=e.old.pos.sub(t).factor(1/s.zoom);s.position.inc(i)}draw(){}reset(){}mousewheel(e){let t=this.scene.settings,s=this.scene.game.pixelRatio,i=t.cameraSensitivity,o=t.cameraZoomMin,a=t.cameraZoomMax,r=o*s,n=a*s,h=this.camera,l=this.mouse.touch,c=h.desiredZoom;c+=e*i,h.setZoom(c/s,l.pos),h.desiredZoom<r?h.setZoom(o,l.pos):h.desiredZoom>n&&h.setZoom(a,l.pos)}checkKeys(){let e=this.gamepad,t=this.name.toLowerCase(),s=this.toolhandler;e.isButtonDown(t)&&(s.setTool(t),e.setButtonUp(t))}getOptions(){return{}}close(){}},L=class extends D{name="Camera";hold(){let e=this.mouse.touch,t=e.pos,s=this.camera,i=e.old.pos.sub(t).factor(1/s.zoom);s.position.inc(i)}drawText(e){e.fillStyle=/^(dark|midnight)$/i.test(lite.storage.get("theme"))?"#FBFBFB":"#000",e.font=12*this.game.pixelRatio+"pt arial",e.fillText(this.name,10*this.game.pixelRatio,20*this.game.pixelRatio),e.font=8*this.game.pixelRatio+"pt arial"}},B=class{currentTool="";scene=null;camera=null;mouse=null;tools={};gamepad=null;gridCache=!1;gridCacheAlpha=1;gridUseEnabled=!1;snapPoint=!1;options=null;constructor(e){this.currentTool="",this.scene=e,this.camera=e.camera,this.mouse=e.mouse,this.mouse.updateCallback=this.draw.bind(this),this.gamepad=e.playerManager.firstPlayer.getGamepad(),this.options=e.settings.toolHandler,this.snapPoint=new s,this.snapPoint.equ(this.scene.track.defaultLine.p2),this.initAnalytics(),this.actionTimeline=[],this.actionTimelineMax=50,this.actionTimelinePointer=0}initAnalytics(){this.analytics={actions:0}}enableGridUse(){this.gridUseEnabled=!0}getToolOptions(){return this.tools[this.currentTool].getOptions()}setToolOption(e,t,s){void 0!==s&&void 0!==this.tools[s]?this.tools[s].setOption(e,t):this.tools[this.currentTool].setOption(e,t),this.scene.stateChanged()}registerTool(e){let t=(e=new e(this)).name.toLowerCase();this.tools[t]=e}setTool(e){e=e.toLowerCase(),this.currentTool!==e&&(this.resetTool(),this.currentTool=e,this.scene.stateChanged(),this.analytics.actions++)}addActionToTimeline(e){this.actionTimeline.length>=this.actionTimelineMax&&(this.actionTimeline.splice(0,this.actionTimeline.length-this.actionTimelineMax),this.actionTimelinePointer=this.actionTimelineMax),this.actionTimeline.splice(this.actionTimelinePointer),this.actionTimeline.push(e),this.actionTimelinePointer++}revertAction(){let e=this.actionTimelinePointer;if(e>0){let t=this.actionTimeline[e-1];switch(e--,t.type){case"add":this.removeObjects(t.objects);break;case"remove":this.addObjects(t.objects)}this.actionTimelinePointer=e}}applyAction(){let e=this.actionTimeline,t=this.actionTimelinePointer;if(t<e.length){let e=this.actionTimeline[t];switch(t++,e.type){case"add":this.addObjects(e.objects);break;case"remove":this.removeObjects(e.objects)}this.actionTimelinePointer=t}}removeObjects(e){for(let t=e.length,s=0;t>s;s++){let t=e[s];t.remove=!0,t.removeAllReferences()}this.scene.track.cleanTrack()}addObjects(e){for(let t=e.length,s=this.scene.track,i=0;t>i;i++){let t=e[i];t instanceof a?(t.remove=!1,s.addPhysicsLineToTrack(t)):t instanceof o?(t.remove=!1,s.addSceneryLineToTrack(t)):t instanceof u?(t.remove=!1,s.addTarget(t),s.addPowerup(t)):(t.remove=!1,s.addPowerup(t))}}resetTool(){""!==this.currentTool&&this.tools[this.currentTool].reset()}update(){this.checkGrid(),this.mouse.enabled&&this.tools[this.currentTool].update(),this.checkHotkeys(),this.checkMouse(),this.checkSnap()}checkGrid(){let e=this.scene.camera;e.zoom!==e.desiredZoom&&(this.gridCache=!1)}checkSnap(){this.options.snapLocked&&(this.options.snap=!0)}moveCameraTowardsMouse(){if(!1===this.options.cameraLocked){let e=this.scene.screen,t=100,s=e.height-t,i=0+t,o=e.width-t,a=0+t,r=this.options.cameraMoveSpeed,n=e.center,h=this.camera,l=this.mouse.touch,c=l.pos.x,p=l.pos.y,d=.8*(c-n.x),u=p-n.y;(c>=o||a>=c||p>=s||i>=p)&&(h.position.x+=d*r*(1/h.zoom),h.position.y+=u*r*(1/h.zoom))}}checkMouse(){let e=this.mouse.touch,t=this.mouse.secondaryTouch;(e.press||t.press)&&this.press()}press(){this.camera.unfocus()}checkHotkeys(){let e=this.gamepad,t=this.options.snap,s=this.options.snapLocked,i=this.options.rightClickMove,o=e.isButtonDown("alt");i&&(o=e.isButtonDown("shift")),o&&!t?this.toggleQuickSnap():o||!t||s||this.toggleQuickSnap(),e.isButtonDown("ctrl")&&e.isButtonDown("z")&&(e.setButtonUp("z"),this.revertAction()),e.isButtonDown("ctrl")&&e.isButtonDown("y")&&(e.setButtonUp("y"),this.applyAction());let a=this.tools;for(let e in a)a[e].checkKeys();this.gridUseEnabled&&e.isButtonDown("grid")&&(e.setButtonUp("grid"),this.toggleGrid()),e.isButtonDown("zoom_increase")&&(e.setButtonUp("zoom_increase"),this.scene.camera.increaseZoom()),e.isButtonDown("zoom_decrease")&&(e.setButtonUp("zoom_decrease"),this.scene.camera.decreaseZoom()),e.isButtonDown("zoom_100")&&(e.setButtonUp("zoom_100"),this.scene.camera.resetZoom()),e.isButtonDown("lineType")&&(e.setButtonUp("lineType"),this.toggleLineType())}toggleLineType(){let e=this.options.lineType;this.options.lineType="physics"===e?"scenery":"physics",this.scene.stateChanged()}toggleGrid(){this.options.grid=this.scene.state.grid=!this.options.grid,this.scene.stateChanged()}toggleSnap(){this.options.snap=!this.options.snap,this.options.snapLocked=!this.options.snapLocked,this.resetTool(),this.scene.stateChanged()}toggleQuickSnap(){this.options.snapLocked||(this.options.snap=!this.options.snap,this.resetTool(),this.scene.stateChanged())}toggleCameraLock(){this.options.cameraLocked=!this.options.cameraLocked,this.scene.stateChanged()}draw(e){this.mouse.enabled&&this.tools[this.currentTool].draw(e)}drawGrid(e){let t=this.scene.game.pixelRatio;!0===this.options.grid&&this.options.visibleGrid&&this.drawCachedGrid(e,t)}drawCachedGrid(e,t){!1===this.gridCache&&this.cacheGrid(t);let s=this.gridCache,i=s.width,o=s.height,a=this.scene.screen.center,r=2+(a.x/i|0),n=2+(a.y/o|0),h=this.camera.zoom,l=this.camera.position.x*h%i,c=this.camera.position.y*h%o;e.globalAlpha=this.gridCacheAlpha;for(var p=-r;r>p;p++)for(var d=-n;n>d;d++){var u=p*i-l+a.x,m=d*o-c+a.y;e.drawImage(s,0,0,o,i,u,m,i,o)}e.globalAlpha=1}cacheGrid(){if(window.lite&&lite.storage.get("isometricGrid"))return this.cacheIsometricGrid();let e=this.scene.camera.zoom,t=200*e,s=200*e,i=this.options.gridSize*e,o=document.createElement("canvas");o.width=t,o.height=s;let a=o.getContext("2d");a.strokeStyle=this.options.gridMinorLineColor,a.strokeWidth=1*window.devicePixelRatio,a.beginPath();let r=null,n=null,h=null,l=null;for(r=Math.floor(t/i),n=0;r>=n;n++)h=n*i,a.moveTo(h,0),a.lineTo(h,s);for(r=Math.floor(s/i),n=0;r>=n;n++)l=n*i,a.moveTo(0,l),a.lineTo(t,l);a.stroke(),a.beginPath(),a.rect(0,0,t,s),a.lineWidth=2*window.devicePixelRatio,a.strokeStyle=this.options.gridMajorLineColor,a.stroke(),this.gridCache=o,this.gridCacheAlpha=Math.min(e+.2,1)}cacheIsometricGrid(){let e=this.scene.camera.zoom,t=200*e,s=200*e,i=this.options.gridSize*e,o=document.createElement("canvas");o.width=t,o.height=s;let a=o.getContext("2d");a.fillStyle=this.options.gridMinorLineColor;for(let o=Math.floor(t/i),r=0;o>=r;r++)for(let t=Math.floor(s/i),o=0;t>=o;o+=.5)a.beginPath(),a.arc(2*o*i,(r+o%1)*i,1*e,0,2*Math.PI),a.fill();this.gridCache=o,this.gridCacheAlpha=Math.min(e+.2,1)}resize(){let e=this.scene.game.pixelRatio;this.cacheGrid(e)}undo(){}redo(){}close(){this.actionTimeline=[],this.actionTimelinePointer=0,this.tools=null,this.mouse=null,this.scene=null,this.camera=null,this.options.grid=!1,this.options=null,this.gridCache=null}},O=class{scene=null;cached=!1;container={borderRadius:25,font:35*window.devicePixelRatio/2,text:"00:00",scaleX:window.devicePixelRatio/2,scaleY:window.devicePixelRatio/2,width:200,height:60,x:100,y:30};constructor(e){this.scene=e,this.settings=e.settings,this.removePlayer(),this.createPulseTween()}setPlayer(e){this.player=e}removePlayer(){this.player=!1}playerAddedTime(e){this.player===e&&this.createPulseTween()}createPulseTween(){let e=this.scene.game.pixelRatio/2;this.tweenRemaining=200,this.tweenStart=e,this.tweenScale=1.2*e}center_container(){let e=this.scene.screen,t=this.container;t.x=e.width/2-100*t.scaleX,t.y=e.height-100*t.scaleY}draw(e){e.save(),e.fillStyle="rgba(242,144,66,0.5)",e.strokeStyle="rgba(242,144,66,1)",e.lineWidth=5*window.devicePixelRatio/2,e.beginPath(),e.roundRect(this.container.x,this.container.y,this.container.width*this.container.scaleX,this.container.height*this.container.scaleY,this.container.borderRadius*this.container.scaleY),e.fill(),e.stroke(),e.font=this.container.font+"px helsinki",e.fillStyle="#000000",e.textAlign="center",e.textBaseline="middle",e.fillText(this.container.text,this.container.x+this.container.width/2*this.container.scaleX,this.container.y+this.container.height/2*this.container.scaleY),e.restore()}fixedUpdate(){if(this.tweenRemaining>0){this.tweenRemaining=Math.max(this.tweenRemaining-1e3/this.scene.game.settings.drawFPS);let e=this.container;e.scaleX=e.scaleY=e.scaleX*(1-this.tweenRemaining/100)+this.tweenScale*(this.tweenRemaining/100),e.scaleX==this.tweenScale&&(this.tweenScale=this.tweenStart)}this.player&&this.player._tempVehicleTicks>0?(this.center_container(),this.updateTime()):this.container.visible=!1}updateTime(){let e=(this.player._tempVehicleTicks/this.scene.settings.drawFPS).toFixed(2),t="";10>e&&(t="0"),t+=e,this.container.text=t,this.container.visible=!0}close(){this.container=null,this.player=null,this.scene=null,this.settings=null}},I=class{tickDownButtons={};previousTickDownButtons={};downButtons={};paused=!1;keymap={};records={};keysToRecord=null;keysToPlay=null;recording=!1;playback=null;numberOfKeysDown=0;tickNumberOfKeysDown=0;replaying=!1;constructor(e){this.scene=e}listen(){document.onkeydown=this.handleButtonDown.bind(this),document.onkeyup=this.handleButtonUp.bind(this),window.onblur=this.handleBlur.bind(this),window.onfocus=this.handleFocus.bind(this)}unlisten(){this.downButtons={},document.onkeydown=null,document.onkeyup=null}pause(){this.paused=!0}unpause(){this.paused=!1}recordKeys(e){this.keysToRecord=e,this.recording=!0}loadPlayback(e,t){this.keysToPlay=t,this.playback=e,this.replaying=!0}setKeyMap(e){let t={};for(let s in e)if(e[s]instanceof Array)for(let i of e[s])t[i]=s;else t[e[s]]=s;this.keymap=t}handleButtonDown(e){let t=this.getInternalCode(e.keyCode);"string"==typeof t&&e.preventDefault(),this.setButtonDown(t)}handleButtonUp(e){let t=this.getInternalCode(e.keyCode);"string"==typeof t&&e.preventDefault(),this.setButtonUp(t)}blurred=!1;previousDownButtons={};handleBlur(){this.blurred=!0,this.previousDownButtons=Object.assign({},this.tickDownButtons)}handleFocus(){this.blurred&&(this.tickDownButtons=Object.assign({},this.previousDownButtons),this.downButtons=Object.fromEntries(Object.keys(this.tickDownButtons).map((e=>[e,!1]))))}getInternalCode(e){return this.keymap[e]||e}setButtonsDown(e){for(let t in e)this.setButtonDown(e[t])}setButtonUp(e){this.blurred=!1,this.downButtons[e]&&(this.onButtonUp&&this.onButtonUp(e),this.downButtons[e]=!1,this.numberOfKeysDown--)}setButtonDown(e,t){this.blurred=!1,this.downButtons[e]||(this.onButtonDown&&this.onButtonDown(e),this.downButtons[e]=t||!0,this.numberOfKeysDown++)}isButtonDown(e){return this.tickDownButtons[e]>0}getButtonDownOccurances(e){let t=0;if(this.isButtonDown(e)){t=1;let s=this.tickDownButtons[e];!0!==s&&(t=s)}return t}getDownButtons(){let e=[];for(let t in this.tickDownButtons)this.tickDownButtons[t]&&e.push(t);return e}reset(e){(this.replaying||e)&&(this.downButtons={},this.playbackTicks=0),this.tickDownButtons={},this.previousDownButtons={},this.previousTickDownButtons={},this.records={}}update(){this.replaying&&this.updatePlayback(),this.blurred||(this.previousTickDownButtons=Object.assign({},this.tickDownButtons),this.tickDownButtons=Object.assign({},this.downButtons)),this.tickNumberOfKeysDown=this.numberOfKeysDown,this.recording&&this.updateRecording()}areKeysDown(){for(let e in this.downButtons)if(!0===this.downButtons[e])return!0;return!1}updatePlayback(){let e=this.playback,t=this.playbackTicks??this.scene.ticks;for(let s of this.keysToPlay){let i=s+"_up",o=s+"_down";if(void 0!==e[o]&&void 0!==e[o][t]){let i=e[o][t];this.setButtonDown(s,i)}void 0!==e[i]&&void 0!==e[i][t]&&this.setButtonUp(s)}}updateRecording(){let e=this.scene.ticks,t=this.records,s=this.tickDownButtons,i=this.previousTickDownButtons;for(let o of this.keysToRecord)if(void 0!==s[o]){let a=s[o];if(a!==(void 0!==i[o]&&i[o])){let s=o+"_down",i=o+"_up";a&&(i=s),!a&&t[s]&&-1!==t[s].indexOf(e)?/^(backspace|enter)$/.test(o)?(t[i]||(t[i]=[]),t[i].push(e+1)):(t[s].splice(t[s].indexOf(e),1),t[s].length||delete t[s]):(t[i]||(t[i]=[]),t[i].push(e))}}}buttonWasRecentlyDown(e){let t=this.records;this.replaying&&(t=this.playback);let s=e+"_down",i=!1;if(t[s]){let e=(this.replaying&&this.playbackTicks)??this.scene.ticks,o=t[s],a=-1;a=this.replaying?void 0!==o[e]:o.indexOf(e),-1!==a&&(i=!0)}return i}getReplayString(){return JSON.stringify(this.records)}encodeReplayString(e){let t={version:this.scene.settings.replayVersion};for(let s in e){let i=e[s];t[s]="";for(let e in i){let o=i[e];t[s]+=o.toString(32)+" "}}return t}close(){this.unlisten(),this.handleButtonUp=null,this.handleButtonDown=null,this.onButtonDown=null,this.onButtonUp=null,this.scene=null,this.tickDownButtons=null,this.downButtons=null,this.keymap=null,this.records=null,this.keysToRecord=null}},F=class{pos=null;old=null;vel=null;parent=null;radius=0;friction=0;collide=!1;contact=!1;scene=null;constructor(e,t){this.pos=new s,this.old=new s,this.vel=new s(0,0),this.radius=10,this.friction=0,this.parent=t,this.collide=!0,this.contact=!1,this.scene=t.scene,this.pos.equ(e),this.old.equ(e)}drive(e,t){let s=this.friction,i=-(e*this.vel.x+t*this.vel.y)*s;e*=i,t*=i,this.pos.x+=e,this.pos.y+=t,this.contact=!0}fixedUpdate(){let e=this.parent.gravity;this.vel.inc(e),(0!=e.x||0!=e.y)&&this.vel.factorSelf(.99),this.pos.inc(this.vel),this.contact=!1,this.collide&&this.scene.track.collide(this),this.vel.equ(this.pos.sub(this.old)),this.old.equ(this.pos)}draw(e){let t=this.pos.toScreen(this.scene),s=this.scene.camera.zoom;e.beginPath(),e.fillStyle="rgba(0,0,0,1)",e.arc(t.x,t.y,this.radius*s,0,2*Math.PI,!1),e.fill()}},E=class extends F{constructor(e,t,i){super(new s(e,t),i),this.radius=10,this.collide=!0,this.wind=!0}drive(e,t){this.pos.x+=.05*e*-e*(e*this.vel.x+t*this.vel.y),this.contact=!0}fixedUpdate(){let e=this.vel,t=this.pos,s=this.old,i=this.parent.gravity,o=this.parent.gamepad,a=o.isButtonDown("up"),r=o.isButtonDown("left"),n=o.isButtonDown("right");(0!==i.x||0!==i.y)&&(e.x=.9*e.x,e.y=.99*e.y),r&&(t.x+=-.05),n&&(t.x+=.05),(0!==i.x||0!==i.y)&&(t.y+=-.1),a&&(t.y+=-.5),this.wind&&(t.x+=.3),t.x+=e.x,t.y+=e.y,this.contact=!1,this.collide&&this.scene.track.collide(this),(0!==i.x||0!==i.y)&&(e.x=t.x-s.x,e.y=t.y-s.y),s.x=t.x,s.y=t.y}draw(e){let t=this.scene,s=this.pos.toScreen(t),i=this.radius*t.camera.zoom;e.beginPath(),e.fillStyle=this.scene.settings.physicsLineColor,e.arc(s.x,s.y,i,0,2*Math.PI,!1),e.closePath(),e.fill()}},R=class{m1=null;m2=null;parent=null;lrest=40;leff=40;dampConstant=0;springConstant=0;constructor(e,t,s){this.m1=e,this.m2=t,this.parent=s,this.lrest=40,this.leff=40,this.dampConstant=.5,this.springConstant=.7}swap(){let e=new s,t=this.m1,i=this.m2;e.equ(t.pos),t.pos.equ(i.pos),i.pos.equ(e),e.equ(t.old),t.old.equ(i.old),i.old.equ(e),e.equ(t.vel),t.vel.equ(i.vel),i.vel.equ(e),[t.angle,i.angle]=[i.angle,t.angle]}fixedUpdate(){let e=this.m1,t=this.m2,i=e.pos,o=t.pos,a=e.vel,r=t.vel,n=new s(o.x-i.x,o.y-i.y),h=n.len();if(!(1>h)){let e=1/h;n.x*=e,n.y*=e;let t=(h-this.leff)*this.springConstant,s={x:n.x*t,y:n.y*t},i=r.x-a.x,o=r.y-a.y,l=(i*n.x+o*n.y)*this.dampConstant,c=n.x*l,p=n.y*l;s.x+=c,s.y+=p,r.x+=-s.x,r.y+=-s.y,a.x+=s.x,a.y+=s.y}}rotate(e){let t=this.m1,s=this.m2,i=s.pos.x-t.pos.x,o=-(s.pos.y-t.pos.y)/this.leff,a=i/this.leff;t.pos.x+=o*e,t.pos.y+=a*e,s.pos.x+=o*-e,s.pos.y+=a*-e}contract(e,t){this.leff+=(this.lrest-e-this.leff)/t}setMasses(e,t){this.m1=e,this.m2=t}};let W=[1,.7,.8,.9,.5,1,.7,1];const V=class extends F{color="black";constructor(e,t,s){super(e,t),this.color=s,this.pos.x=e.x+5*(Math.random()-Math.random()),this.pos.y=e.y+5*(Math.random()-Math.random()),this.old.x=this.pos.x,this.old.y=this.pos.y,this.vel.y=11*(Math.random()-Math.random()),this.vel.x=11*(Math.random()-Math.random()),this.radius=2*Math.random()*5,this.angle=6.2*Math.random(),this.speed=1*Math.random()-1*Math.random(),this.friction=.05}drive(e,t){let s=this.vel,i=this.pos;this.speed=(e*s.x+t*s.y)/this.radius,this.angle+=this.speed;let o=-(e*s.x+t*s.y)*this.friction;i.x+=e*o,i.y+=t*o;let a=Math.sqrt(Math.pow(e,2)+Math.pow(t,2));if(a>0){let i=-t/a,o=e/a,r=.8*(i*s.x+o*s.y);this.old.x+=i*r,this.old.y+=o*r}}fixedUpdate(){this.angle+=this.speed,super.fixedUpdate()}draw(e){let t=this.scene.screen,s=this.scene.camera,i=t.realToScreen(this.pos.x,"x"),o=t.realToScreen(this.pos.y,"y"),a=0,r=s.zoom,n=this.angle,h=W[0]*r*this.radius,l=i+h*Math.cos(n),c=o+h*Math.sin(n),p=2*Math.PI;for(e.lineWidth=1*r,e.strokeStyle=this.color,e.beginPath(),e.moveTo(l,c),e.fillStyle=this.color;a++<8;)h=W[a-1]*r*this.radius,l=i+h*Math.cos(n+p*a/8),c=o+h*Math.sin(n+p*a/8),e.lineTo(l,c);e.fill(),e.stroke()}},U=class{complete=!1;time=0;powerupsEnabled=!1;constructor(e,t){this.time=20,this.gravity=new s(0,.3),this.scene=t,this.createMasses(e),this.positionX=e.x,this.positionY=e.y}draw(e,t){let s=this.time,i=this.positionX,o=this.positionY,a=this.scene.camera.zoom,r=this.scene.screen;if(e.globalAlpha=t,s>0){s-=10;let t=r.realToScreen(i,"x"),n=r.realToScreen(o,"y"),h=0,l=6.2*Math.random(),c=s*a,p=t+c*Math.cos(l),d=n+c*Math.sin(l);for(e.beginPath(),e.moveTo(p,d),e.fillStyle=this.scene.settings.physicsLineColor;h++<16;)c=(s+30*Math.random())*a,p=t+c*Math.cos(l+6.283*h/16),d=n+c*Math.sin(l+6.283*h/16),e.lineTo(p,d);e.fill()}let n=this.masses;for(let t in n)n[t].draw(e);e.globalAlpha=1,this.time=s}createMasses(e){this.masses=[],this.masses.push(new V(e,this,this.scene.settings.physicsLineColor)),this.masses.push(new V(e,this,this.scene.settings.physicsLineColor)),this.masses.push(new V(e,this,this.scene.settings.physicsLineColor)),this.masses.push(new V(e,this,this.scene.settings.physicsLineColor)),this.masses.push(new V(e,this,this.scene.settings.physicsLineColor)),this.masses.push(new V(e,this,this.scene.settings.physicsLineColor)),this.masses.push(new V(e,this,this.scene.settings.physicsLineColor))}fixedUpdate(){for(let e of this.masses)e.fixedUpdate()}update(e,t){for(let s of this.masses)s.update(e,t)}},j=class{color="#".padEnd(7,"midnight"==lite.storage.get("theme")?"C":"dark"==lite.storage.get("theme")?"FB":"0");masses=null;springs=null;slow=!1;constructor(e){this.player=e,this.scene=e._scene,this.gamepad=e._gamepad,this.settings=e._settings,this.gravity=new s(0,.3),this.complete=!1,this.alive=!0,this.crashed=!1,this.dir=1,this.ghost=!1,this.ragdoll=!1,this.explosion=!1,this.speed=0,this.powerupsEnabled=!0,this.createCosmetics()}explode(){this.scene.sound.play("bomb_sound",1),this.explosion=new U(this.masses[0].pos,this.scene),this.dead()}createCosmetics(){this.cosmetics=this.player._user.cosmetics}updateSpeed(){this.speed=Math.abs(Math.round(this.focalPoint.vel.x+this.focalPoint.vel.y))}close(){this.scene=null,this.settings=null,this.gravity=null,this.speed=null,this.cosmetics=null,this.explosion=null,this.ragdoll=null,this.ghost=null,this.crashed=null,this.alive=null,this.gamepad=null}dead(){this.stopSounds(),this.player.dead(),this.crashed=!0,this.alive=!1}moveVehicle(e,t){for(var s=this.masses,i=s.length-1;i>=0;i--)s[i].pos.x+=e,s[i].pos.y+=t,s[i].old.x+=e,s[i].old.y+=t}stopSounds(){}};let G="balloon_on";const q=class extends F{motor=0;brake=!1;angle=0;speed=0;constructor(e,t){super(e,t),this.motor=0,this.brake=!1,this.angle=0,this.speed=0,this.rotationSpeed=0}drive(e,t){let s=this.pos,i=this.motor*this.parent.dir,o=i*e,a=i*t;if(s.x+=o,s.y+=a,this.brake){let i=.3*-(e*this.vel.x+t*this.vel.y),o=e*i,a=t*i;s.x+=o,s.y+=a}this.speed=(e*this.vel.x+t*this.vel.y)/this.radius,this.rotationSpeed=this.speed,this.angle+=this.speed,this.contact=!0}fixedUpdate(){super.fixedUpdate(),this.rotationSpeed=.999*this.rotationSpeed}};let H="blob_sound";const N=class{parent=null;constructor(e,t){this.parent=t;let i,o,a,r,n,h,l,c,p,d,u=[],m=[],g=new s(0,0);i=new F(g,t),o=new F(g,t),a=new F(g,t),r=new F(g,t),h=new F(g,t),n=new F(g,t),l=new F(g,t),c=new F(g,t),p=new F(g,t),d=new F(g,t),u.push(i),u.push(o),u.push(a),u.push(r),u.push(h),u.push(n),u.push(l),u.push(c),u.push(p),u.push(d),m.push(new R(i,o,this)),m.push(new R(i,a,this)),m.push(new R(a,h,this)),m.push(new R(i,r,this)),m.push(new R(r,n,this)),m.push(new R(o,l,this)),m.push(new R(l,p,this)),m.push(new R(o,c,this)),m.push(new R(c,d,this));for(let e in u)u[e].friction=.05,u[e].radius=3;for(var y in i.radius=o.radius=8,m)m[y].dampConstant=.7,m[y].springConstant=.4;for(var y in this.masses=u,this.springs=m,this.head=i,this.waist=o,this.lElbow=a,this.rElbow=r,this.rHand=n,this.lHand=h,this.lKnee=l,this.rKnee=c,this.lFoot=p,this.rFoot=d,e)this[y].pos.equ(e[y])}zero(e,t){e=e.factor(.7),t=t.factor(.7);let s=this.springs,i=this.masses;for(let e in s){let t=s[e].m2.pos.sub(s[e].m1.pos).len();s[e].lrest=t,s[e].leff=t}for(let e=1;4>=e;e++)s[e].lrest=13,s[e].leff=13;for(let e in s)s[e].leff>20&&(s[e].lrest=20,s[e].leff=20);let o=[this.head,this.lElbow,this.rElbow,this.lHand,this.rHand],a=[this.waist,this.lKnee,this.rKnee,this.lFoot,this.rFoot];for(let t in o)o[t].old=o[t].pos.sub(e);for(let e in a)a[e].old=a[e].pos.sub(t);for(let e in i)i[e].vel.equ(i[e].pos.sub(i[e].old)),i[e].vel.x+=1*(Math.random()-Math.random()),i[e].vel.y+=1*(Math.random()-Math.random())}draw(e){let t=this.head,s=this.waist,i=this.lElbow,o=this.rElbow,a=this.rHand,r=this.lHand,n=this.lKnee,h=this.rKnee,l=this.lFoot,c=this.rFoot,p=this.parent.scene,d=p.camera.zoom,u=this.parent.alpha||1,m=p.settings.physicsLineColor,g=m.padEnd(7,m.slice(1,4));e.strokeStyle=g+Math.min(255,Math.round(127.5*u)).toString(16),e.lineWidth=5*d;let y=t.pos.toScreen(p);e.beginPath(),e.moveTo(y.x,y.y);let w=i.pos.toScreen(p);e.lineTo(w.x,w.y);let f=r.pos.toScreen(p);e.lineTo(f.x,f.y),e.stroke(),e.strokeStyle=g+Math.min(255,Math.round(255*u)).toString(16),e.beginPath(),e.moveTo(y.x,y.y);let x=o.pos.toScreen(p);e.lineTo(x.x,x.y);let v=a.pos.toScreen(p);e.lineTo(v.x,v.y),e.stroke(),e.lineWidth=8*d,e.beginPath(),e.moveTo(y.x,y.y);let b=s.pos.toScreen(p);e.lineTo(b.x,b.y),e.stroke(),e.lineWidth=5*d,e.beginPath(),e.moveTo(b.x,b.y);let k=n.pos.toScreen(p);e.lineTo(k.x,k.y);let T=l.pos.toScreen(p);e.lineTo(T.x,T.y);let S=n.pos.sub(s.pos).normalize();S.factorSelf(4),S.inc(l.pos);let P=S.toScreen(p);e.lineTo(P.x,P.y),e.stroke(),e.strokeStyle=g+Math.min(255,Math.round(127.5*u)).toString(16),e.lineWidth=5*d,e.beginPath(),e.moveTo(b.x,b.y);let _=h.pos.toScreen(p);e.lineTo(_.x,_.y);let C=h.pos.sub(s.pos).normalize();C=C.factor(4).add(c.pos);let M=c.pos.toScreen(p);e.lineTo(M.x,M.y);let z=C.toScreen(p);e.lineTo(z.x,z.y),e.stroke(),y.inc(y.sub(b).factor(.25));let A=GameInventoryManager.getItem(this.parent.cosmetics.head),D=this.drawHeadAngle;A.draw(e,y.x,y.y,D,d,this.dir,1)}fixedUpdate(){for(let e of this.springs)e.fixedUpdate();for(let e of this.masses)e.fixedUpdate();this.updateDrawHeadAngle()}update(e){for(let t of this.masses)t.update(e)}updateDrawHeadAngle(){let e=this.head.pos,t=this.waist.pos;this.dir<0&&([e,t]=[t,e]);let s=e.x,i=e.y,o=s-t.x,a=i-t.y;this.drawHeadAngle=-(Math.atan2(o,a)+Math.PI)}};let Z="bike_ground",X="bike_air";const J=class extends j{cosmeticHead=null;cosmeticRearWheel=null;cosmeticFrontWheel=null;pedala=0;swapped=!1;ragdoll=null;createSprings(){this.springs=[];let e=new R(this.head,this.rearWheel,this),t=new R(this.rearWheel,this.frontWheel,this),s=new R(this.frontWheel,this.head,this);this.springs.push(e),this.springs.push(t),this.springs.push(s),this.rearSpring=e,this.chasse=t,this.frontSpring=s}createRagdoll(){this.ragdoll=new N(this.getStickMan(),this),this.ragdoll.zero(this.head.vel,this.rearWheel.vel),this.ragdoll.dir=this.dir,this.rearWheel.motor=0,this.rearWheel.brake=!1,this.frontWheel.brake=!1,this.head.collide=!1,this.updateCameraFocalPoint(),this.player.isInFocus()&&this.playBailSound(),this.dead()}playBailSound(){let e=this.scene.sound,t=Math.min(this.speed/50,1);switch(Math.floor(3*Math.random())+1){case 1:e.play("bike_fall_1",t);break;case 2:e.play("bike_fall_2",t);break;case 3:e.play("bike_fall_3",t)}}updateCameraFocalPoint(){this.focalPoint=this.ragdoll?this.ragdoll.head:this.head}getStickMan(){let e=this.dir,t=this.head,i=this.frontWheel,o=this.rearWheel,a=this.pedala,r=i.pos.sub(o.pos),n=t.pos.sub(i.pos.add(o.pos).factor(.5)),h=new s(r.y*e,-r.x*e),l={};l.head=o.pos.add(r.factor(.35)).add(n.factor(1.2)),l.lHand=l.rHand=o.pos.add(r.factor(.8)).add(h.factor(.68));var c=l.head.sub(l.lHand);c=new s(c.y*e,-c.x*e),l.lElbow=l.rElbow=l.head.add(l.lHand).factor(.5).add(c.factor(130/c.lenSqr())),l.waist=o.pos.add(r.factor(.2)).add(h.factor(.5));var p=new s(6*Math.cos(a),6*Math.sin(a));return l.lFoot=o.pos.add(r.factor(.4)).add(h.factor(.05)).add(p),c=l.waist.sub(l.lFoot),c=new s(-c.y*e,c.x*e),l.lKnee=l.waist.add(l.lFoot).factor(.5).add(c.factor(160/c.lenSqr())),l.rFoot=o.pos.add(r.factor(.4)).add(h.factor(.05)).sub(p),c=l.waist.sub(l.rFoot),c=new s(-c.y*e,c.x*e),l.rKnee=l.waist.add(l.rFoot).factor(.5).add(c.factor(160/c.lenSqr())),l}fixedUpdate(){if(!1===this.crashed&&(this.updateSound(),this.control()),this.explosion)this.explosion.fixedUpdate();else{for(let e=this.springs,t=e.length-1;t>=0;t--)e[t].fixedUpdate();for(let e=this.masses,t=e.length-1;t>=0;t--)e[t].fixedUpdate();if(this.rearWheel.contact&&this.frontWheel.contact&&(this.slow=!1),!1===this.slow){!1===this.crashed&&this.control();for(let e=this.springs,t=e.length-1;t>=0;t--)e[t].fixedUpdate();for(let e=this.masses,t=e.length-1;t>=0;t--)e[t].fixedUpdate()}this.ragdoll?this.ragdoll.fixedUpdate():this.updateDrawHeadAngle()}this.updateCameraFocalPoint()}updateSound(){if(this.player.isInFocus()){this.updateSpeed();let e=Math.min(this.speed/50,1),t=this.scene.sound;this.rearWheel.contact||this.frontWheel.contact?(t.play(Z,e),t.stop(X)):(t.play(X,e),t.stop(Z))}}stopSounds(){let e=this.scene.sound;e.stop(X),e.stop(Z)}swap(){this.dir=-1*this.dir,this.chasse.swap();let e=this.rearSpring.leff;this.rearSpring.leff=this.frontSpring.leff,this.frontSpring.leff=e}draw(e){if(this.explosion)this.explosion.draw(e,1);else{if(this.scene.ticks>0&&!this.player.isGhost()){if(!this.scene.state.playing){let s=window.lite&&lite.storage.get("snapshots");if(s>0){for(let t in this.player._checkpoints)t<=this.player._checkpoints.length-(parseInt(s)+1)||!this.player._checkpoints[t]||!this.player._checkpoints[t]._baseVehicle||this.drawBikeFrame.call(Object.assign({},this,JSON.parse(this.player._checkpoints[t]._baseVehicle)),e,s/300*parseInt(t)%1);for(let i in this.player._cache)i<=this.player._cache.length-(parseInt(s)+1)||!this.player._cache[i]||!this.player._cache[i]._baseVehicle||this.drawBikeFrame.call(Object.assign({},this,JSON.parse(this.player._cache[i]._baseVehicle)),e,s/300*++t%1)}}if(window.lite&&lite.storage.get("playerTrail"))for(let t in lite.snapshots)lite.snapshots[t]&&lite.snapshots[t]._baseVehicle&&this.drawBikeFrame.call(Object.assign({},this,JSON.parse(lite.snapshots[t]._baseVehicle)),e,lite.snapshots.length/(200*lite.snapshots.length)*parseInt(t)%1)}if(e.imageSmoothingEnabled=!0,e.mozImageSmoothingEnabled=!0,e.webkitImageSmoothingEnabled=!0,this.settings.developerMode)for(var t=this.masses,s=t.length-1;s>=0;s--)t[s].draw(e);this.drawBikeFrame(e)}}updateDrawHeadAngle(){let e=this.frontWheel.pos,t=this.rearWheel.pos,s=e.x,i=e.y,o=s-t.x,a=i-t.y;this.drawHeadAngle=-(Math.atan2(o,a)-Math.PI/2)}},Y=class extends F{motor=0;angle=0;speed=0;constructor(e,t){super(e,t),this.motor=0,this.angle=new s(0,0),this.radius=10,this.speed=0}fixedUpdate(){let e=this.vel,t=this.angle,s=this.pos,i=this.old,o=this.motor;e.inc(t.factor(2*o)),s.inc(e.factor(.99)),this.contact=!1,this.collide&&this.scene.track.collide(this),this.vel=s.sub(i),i.equ(s)}};let K="helicopter";window.GameInventoryManager=new class{cache={};inventory={};loaded=new Set;getItem(e){let t=e.classname,s=e.script,i=e.options,o=e.type;this.inventory[t]||("1"===o&&(t="forward_cap",i={back:"white"}),this.loaded.has(s)||(this.loaded.add(s),GameManager.loadFile(s)));let a=this.generateID(o,t,i);return this.cache[a]||=new this.inventory[t](i)}redraw(){let e=this.cache;for(let t in e)e[t].setDirty()}generateID(e,t,s){if(t=e+t,s)for(let e in s)s.hasOwnProperty(e)&&(t+=s[e]);return t}register(e,t){this.inventory[e]=t}clear(){this.cache={},this.inventory={},this.loaded.clear()}},GameInventoryManager.HeadClass=class{versions={};createVersion(){let e=this.colors,t=this.getVersions(),s="";for(let t in e)s+=e[t];this.versionName=s,t[s]||={dirty:!0,canvas:document.createElement("canvas")}}draw(e,t,s,i,o,a){let r=this.getCache(o),n=this.getScale(),h=this.getBaseWidth()*o*n,l=this.getBaseHeight()*o*n,c=this.getDrawOffsetX()*o-h/2,p=this.getDrawOffsetY()*o-l/2,d=-1===a;e.translate(t,s),e.rotate(i),d&&e.scale(1,-1),e.drawImage(r,c,p,h,l),d&&e.scale(1,-1),e.rotate(-i),e.translate(-t,-s)}getCache(e){let t=this.getVersions();return t[this.versionName].dirty&&this.cache(e),t[this.versionName].canvas}getVersions(){return this.versions}setDirty(){this.getVersions()[this.versionName].dirty=!0}};class Q extends GameInventoryManager.HeadClass{drawAngle=0;constructor(e){super(),this.colors=e,this.createVersion()}cache(e){let t=this.versions[this.versionName],s=t.canvas,i=this.getScale()*Math.max(e,1);t.dirty=!1,s.width=this.getBaseWidth()*i,s.height=this.getBaseHeight()*i;let o=s.getContext("2d"),a=this.colors,r=Math.PI/12;o.scale(i,i),o.strokeStyle=a.outline||"darker"===lite.storage.get("theme")?"hsl(0, 0%, 100%)":"dark"===lite.storage.get("theme")?"hsl(0, 0%, 98%)":"midnight"===lite.storage.get("theme")?"hsl(0, 0%, 80%)":"hsl(0, 0%, 0%)",o.lineCap="round",o.lineJoin="miter",o.lineWidth=7,o.miterLimit=4,o.fillStyle=a.skin||"darker"===lite.storage.get("theme")?"hsl(231, 16%, 8%)":"dark"===lite.storage.get("theme")?"hsl(0, 0%, 11%)":"midnight"===lite.storage.get("theme")?"hsl(207, 16%, 14%)":"hsl(0, 0%, 100%)",o.save(),o.beginPath(),o.arc(42.4,52.5,30.3+o.lineWidth/2,0,2*Math.PI,!0),o.fill(),o.stroke(),o.clip(),o.beginPath(),o.arc(42.4,52.5,30.3,-r,Math.PI-r,!0),o.fillStyle=a.back,o.fill(),a.front&&(o.beginPath(),o.arc(42.4,52.5,30.3,-r,r-Math.PI/1.75,!0),o.lineTo(52.501,44.894999999999996),o.fillStyle=a.front,o.fill()),o.restore(),o.lineWidth=12,o.beginPath(),o.moveTo(16.3,60),o.lineTo(103.5,36.5),o.stroke()}setDirty(){this.versions[this.versionName].dirty=!0}getBaseWidth(){return 115}getBaseHeight(){return 112}getDrawOffsetX(){return 2.2}getDrawOffsetY(){return 1}getScale(){return.17}}GameInventoryManager&&GameInventoryManager.register("forward_cap",Q);let ee="truck_idle",te=0,se={BMX:class extends J{vehicleName="BMX";constructor(e,t,s,i){super(e),this.createMasses(t,i),this.createSprings(),this.updateCameraFocalPoint(),this.stopSounds(),-1===s&&this.swap()}createMasses(e,t){this.masses=[];var i=new F(new s(e.x,e.y-36),this),o=new q(new s(e.x+21,e.y+3),this),a=new q(new s(e.x+-21,e.y+3),this);i.drive=this.createRagdoll.bind(this),a.radius=11.7,o.radius=11.7,i.radius=14,i.vel.equ(t),a.vel.equ(t),o.vel.equ(t),this.masses.push(i),this.masses.push(a),this.masses.push(o),this.head=i,this.frontWheel=o,this.rearWheel=a}createSprings(){super.createSprings(),this.chasse.lrest=42,this.chasse.leff=42,this.chasse.springConstant=.35,this.chasse.dampConstant=.3,this.rearSpring.lrest=45,this.rearSpring.leff=45,this.rearSpring.springConstant=.35,this.rearSpring.dampConstant=.3,this.frontSpring.lrest=45,this.frontSpring.leff=45,this.frontSpring.springConstant=.35,this.frontSpring.dampConstant=.3}control(){var e=this.gamepad,t=e.isButtonDown("up"),s=e.isButtonDown("down"),i=e.isButtonDown("left"),o=e.isButtonDown("right"),a=e.isButtonDown("z"),r=t?1:0,n=this.rearWheel;n.motor+=(r-n.motor)/10,a&&!this.swapped&&(this.swap(),this.swapped=!0),a||(this.swapped=!1),t&&(this.pedala+=this.rearWheel.speed/5),n.brake=s,s&&this.frontSpring.contract(-10,10),this.frontWheel.brake=!!(this.dir>0&&o&&s)||!!(this.dir<0&&i&&s);var h=i?1:0;h+=o?-1:0,this.rearSpring.contract(5*h*this.dir,5),this.frontSpring.contract(5*-h*this.dir,5),this.chasse.rotate(h/6),!h&&t&&(this.rearSpring.contract(-7,5),this.frontSpring.contract(7,5))}drawBikeFrame(e,t=this.player._opacity){let i=this.scene,o=new s(this.rearWheel.pos.x,this.rearWheel.pos.y),a=new s(this.frontWheel.pos.x,this.frontWheel.pos.y),r=new s(this.head.pos.x,this.head.pos.y),n=o.toScreen(i),h=a.toScreen(i),l=r.toScreen(i),c=h.sub(n),p=this.dir,d=new s((h.y-n.y)*p,(n.x-h.x)*p),u=this.pedala,m=i.camera.zoom,g=i.settings.physicsLineColor;e.globalAlpha=t,e.strokeStyle=g,e.lineWidth=3*m,e.beginPath(),e.fillStyle=i.settings.sceneryLineColor.padEnd(7,i.settings.sceneryLineColor.slice(1,4))+"33",e.arc(h.x,h.y,10.5*m,0,2*Math.PI,!1),e.fill(),e.stroke(),e.beginPath(),e.arc(n.x,n.y,10.5*m,0,2*Math.PI,!1),e.fill(),e.stroke();let y=n.add(c.factor(.3)).add(d.factor(.25)),w=n.add(c.factor(.4)).add(d.factor(.05)),f=n.add(c.factor(.84)).add(d.factor(.42)),x=n.add(c.factor(.84)).add(d.factor(.37));e.beginPath(),e.strokeStyle=this.color,e.moveTo(n.x,n.y),e.lineTo(y.x,y.y),e.lineTo(f.x,f.y),e.moveTo(x.x,x.y),e.lineTo(w.x,w.y),e.lineTo(n.x,n.y),e.stroke(),e.beginPath(),e.strokeStyle=this.color,e.lineWidth=Math.max(1*m,.5),e.arc(w.x,w.y,3*m,0,2*Math.PI,!1),e.stroke();let v=new s(6*Math.cos(u)*m,6*Math.sin(u)*m),b=w.add(v),k=w.sub(v);e.beginPath(),e.moveTo(b.x,b.y),e.lineTo(k.x,k.y),e.stroke();let T=n.add(c.factor(.25)).add(d.factor(.4)),S=n.add(c.factor(.17)).add(d.factor(.38)),P=n.add(c.factor(.3)).add(d.factor(.45));e.beginPath(),e.strokeStyle=this.color,e.lineWidth=3*m,e.moveTo(S.x,S.y),e.lineTo(P.x,P.y),e.moveTo(w.x,w.y),e.lineTo(T.x,T.y);let _=n.add(c.factor(1)).add(d.factor(0)),C=n.add(c.factor(.97)).add(d.factor(0)),M=n.add(c.factor(.8)).add(d.factor(.48));e.moveTo(_.x,_.y),e.lineTo(C.x,C.y),e.lineTo(M.x,M.y);let z=n.add(c.factor(.86)).add(d.factor(.5)),A=n.add(c.factor(.82)).add(d.factor(.65)),D=n.add(c.factor(.78)).add(d.factor(.67));if(e.lineTo(z.x,z.y),e.lineTo(A.x,A.y),e.lineTo(D.x,D.y),e.stroke(),this.crashed)this.ragdoll&&this.ragdoll.draw(e);else{d=l.sub(n.add(c.factor(.5)));let i=y.add(c.factor(-.1)).add(d.factor(.3)),o=b.sub(i),a=new s(o.y*p,-o.x*p);a=a.factor(m*m);let r=i.add(o.factor(.5)).add(a.factor(200/o.lenSqr())),h=b.add(o.factor(.12)).add(a.factor(50/o.lenSqr()));o=k.sub(i),a=new s(o.y*p,-o.x*p),a=a.factor(m*m);let u=i.add(o.factor(.5)).add(a.factor(200/o.lenSqr())),w=k.add(o.factor(.12)).add(a.factor(50/o.lenSqr()));e.strokeStyle=g.padEnd(7,g.slice(1,4))+Math.min(255,Math.round(127.5*t)).toString(16),e.lineWidth=6*m,e.beginPath(),e.moveTo(k.x,k.y),e.lineTo(u.x,u.y),e.lineTo(i.x,i.y),e.stroke(),e.lineWidth=4*m,e.beginPath(),e.moveTo(k.x,k.y),e.lineTo(w.x,w.y),e.stroke(),e.lineWidth=6*m,e.strokeStyle=g,e.beginPath(),e.moveTo(i.x,i.y),e.lineTo(r.x,r.y),e.lineTo(b.x,b.y),e.lineTo(h.x,h.y),e.stroke();let f=y.add(c.factor(.05)).add(d.factor(.9));e.lineWidth=8*m,e.beginPath(),e.moveTo(i.x,i.y),e.lineTo(f.x,f.y),e.stroke();let x=y.add(c.factor(.15)).add(d.factor(1.05));c=f.sub(D),d=new s(c.y*p,-c.x*p),d=d.factor(m*m);let v=D.add(c.factor(.4)).add(d.factor(130/c.lenSqr()));e.lineWidth=5*m,e.beginPath(),e.moveTo(f.x,f.y),e.lineTo(v.x,v.y),e.lineTo(D.x,D.y),e.stroke(),GameInventoryManager.getItem(this.cosmetics.head).draw(e,x.x,x.y,this.drawHeadAngle,m,this.dir),e.globalAlpha=1}}},MTB:class extends J{vehicleName="MTB";constructor(e,t,s,i){super(e),this.createMasses(t,i),this.createSprings(),this.updateCameraFocalPoint(),this.stopSounds(),-1===s&&this.swap()}createMasses(e,t){this.masses=[];var i=new F(new s(e.x+2,e.y+-38),this),o=new q(new s(e.x+23,e.y),this),a=new q(new s(e.x+-23,e.y),this);i.drive=this.createRagdoll.bind(this),a.radius=14,o.radius=14,i.radius=14,i.vel.equ(t),a.vel.equ(t),o.vel.equ(t),this.masses.push(i),this.masses.push(a),this.masses.push(o),this.head=i,this.frontWheel=o,this.rearWheel=a}createSprings(){super.createSprings(),this.chasse.lrest=45,this.chasse.leff=45,this.chasse.springConstant=.2,this.chasse.dampConstant=.3,this.rearSpring.lrest=47,this.rearSpring.leff=47,this.rearSpring.springConstant=.2,this.rearSpring.dampConstant=.3,this.frontSpring.lrest=45,this.frontSpring.leff=45,this.frontSpring.springConstant=.2,this.frontSpring.dampConstant=.3}control(){var e=this.gamepad,t=e.isButtonDown("up"),s=e.isButtonDown("down"),i=(e.isButtonDown("back"),e.isButtonDown("left")),o=e.isButtonDown("right"),a=e.isButtonDown("z"),r=t?1:0,n=this.rearWheel;n.motor+=(r-n.motor)/10,a&&!this.swapped&&(this.swap(),this.swapped=!0),a||(this.swapped=!1),t&&(this.pedala+=this.rearWheel.speed/5),n.brake=s,this.frontWheel.brake=!!(this.dir>0&&o&&s)||!!(this.dir<0&&i&&s);var h=i?1:0;h+=o?-1:0,this.rearSpring.contract(5*h*this.dir,5),this.frontSpring.contract(5*-h*this.dir,5),this.chasse.rotate(h/8),!h&&t&&(this.rearSpring.contract(-7,5),this.frontSpring.contract(7,5))}drawBikeFrame(e,t=this.player._opacity){let i=this.scene,o=new s(this.frontWheel.pos.x,this.frontWheel.pos.y),a=new s(this.rearWheel.pos.x,this.rearWheel.pos.y),r=new s(this.head.pos.x,this.head.pos.y),n=o.toScreen(i),h=a.toScreen(i),l=r.toScreen(i),c=i.camera.zoom,p=n.sub(h),d=new s(n.y-h.y,h.x-n.x),u=p.factor(.5),m=i.settings.physicsLineColor,g=i.settings.sceneryLineColor,y=g.padEnd(7,g.slice(1,4));d.factorSelf(this.dir),h.addOut(u,u),l.subOut(u,u),e.globalAlpha=t,e.strokeStyle=m,e.lineWidth=3*c,e.beginPath(),e.fillStyle=y+"33",e.arc(n.x,n.y,12.5*c,0,2*Math.PI,!1),e.fill(),e.stroke(),e.beginPath(),e.arc(h.x,h.y,12.5*c,0,2*Math.PI,!1),e.fill(),e.stroke(),e.strokeStyle="rgba(128,128,128,0.8)",e.fillStyle=g,e.lineWidth=1,e.beginPath(),e.arc(n.x,n.y,6*c,0,2*Math.PI,!1),e.fill(),e.stroke(),e.beginPath(),e.arc(h.x,h.y,6*c,0,2*Math.PI,!1),e.fill(),e.stroke(),e.beginPath(),e.strokeStyle=this.color,e.lineWidth=5*c,e.moveTo(h.x,h.y),e.lineTo(h.x+.4*p.x+.05*d.x,h.y+.4*p.y+.05*d.y),e.moveTo(h.x+.72*p.x+.64*u.x,h.y+.72*p.y+.64*u.y),e.lineTo(h.x+.46*p.x+.4*u.x,h.y+.46*p.y+.4*u.y),e.lineTo(h.x+.4*p.x+.05*d.x,h.y+.4*p.y+.05*d.y),e.stroke(),e.beginPath(),e.lineWidth=2*c,e.moveTo(h.x+.72*p.x+.64*u.x,h.y+.72*p.y+.64*u.y),e.lineTo(h.x+.43*p.x+.05*d.x,h.y+.43*p.y+.05*d.y),e.stroke(),e.beginPath(),e.lineWidth=1*c,e.moveTo(h.x+.46*p.x+.4*u.x,h.y+.46*p.y+.4*u.y),e.lineTo(h.x+.28*p.x+.5*u.x,h.y+.28*p.y+.5*u.y),e.stroke(),e.beginPath(),e.lineWidth=2*c,e.moveTo(h.x+.45*p.x+.3*u.x,h.y+.45*p.y+.3*u.y),e.lineTo(h.x+.3*p.x+.4*u.x,h.y+.3*p.y+.4*u.y),e.lineTo(h.x+.25*p.x+.6*u.x,h.y+.25*p.y+.6*u.y),e.moveTo(h.x+.17*p.x+.6*u.x,h.y+.17*p.y+.6*u.y),e.lineTo(h.x+.3*p.x+.6*u.x,h.y+.3*p.y+.6*u.y),e.stroke(),e.beginPath(),e.lineWidth=3*c,e.moveTo(n.x,n.y),e.lineTo(h.x+.71*p.x+.73*u.x,h.y+.71*p.y+.73*u.y),e.lineTo(h.x+.73*p.x+.77*u.x,h.y+.73*p.y+.77*u.y),e.lineTo(h.x+.7*p.x+.8*u.x,h.y+.7*p.y+.8*u.y),e.stroke(),e.beginPath(),e.lineWidth=1*c;let w=new s(6*Math.cos(this.pedala)*c,6*Math.sin(this.pedala)*c);if(e.moveTo(h.x+.43*p.x+.05*d.x+w.x,h.y+.43*p.y+.05*d.y+w.y),e.lineTo(h.x+.43*p.x+.05*d.x-w.x,h.y+.43*p.y+.05*d.y-w.y),e.stroke(),this.crashed)this.ragdoll&&this.ragdoll.draw&&this.ragdoll.draw(e);else{p.factorOut(.5,d),h.addOut(d,d),l.subOut(d,d);let s=p.factor(.3);s.x=h.x+s.x+.25*d.x,s.y=h.y+s.y+.25*d.y;let i=p.factor(.4);i.x=h.x+i.x+.05*d.x,i.y=h.y+i.y+.05*d.y;let o=i.add(w),a=i.sub(w),r=p.factor(.67);r.x=h.x+r.x+.8*d.x,r.y=h.y+r.y+.8*d.y;let n=p.factor(-.05);n.x=s.x+n.x+.42*d.x,n.y=s.y+n.y+.42*d.y;let g=o.sub(n),f=g.lenSqr();u.x=g.y*this.dir,u.y=-g.x*this.dir,u.factorSelf(c**2);let x=g.factor(.5);x.x=n.x+x.x+u.x*(200/g.lenSqr()),x.y=n.y+x.y+u.y*(200/g.lenSqr());let v=g.factor(.12);v.x=o.x+v.x+u.x*(50/f),v.y=o.y+v.y+u.y*(50/f),a.subOut(n,g),f=g.lenSqr(),u.x=g.y*this.dir,u.y=-g.x*this.dir,u.factorSelf(c*c);let b=g.factor(.5);b.x=n.x+b.x+u.x*(200/f),b.y=n.y+b.y+u.y*(200/f);let k=g.factor(.12);k.x=a.x+k.x+u.x*(50/f),k.y=a.y+k.y+u.y*(50/f),y=m.padEnd(7,m.slice(1,4)),e.strokeStyle=y+Math.min(255,Math.round(127.5*t)).toString(16),e.lineWidth=6*c,e.beginPath(),e.moveTo(a.x,a.y),e.lineTo(b.x,b.y),e.lineTo(n.x,n.y),e.stroke(),e.lineWidth=4*c,e.beginPath(),e.moveTo(a.x,a.y),e.lineTo(k.x,k.y),e.stroke(),e.lineWidth=6*c,e.strokeStyle=m,e.beginPath(),e.moveTo(o.x,o.y),e.lineTo(x.x,x.y),e.lineTo(n.x,n.y),e.stroke(),e.lineWidth=4*c,e.beginPath(),e.moveTo(o.x,o.y),e.lineTo(v.x,v.y),e.stroke();let T=p.factor(.1);T.x=s.x+T.x+.95*d.x,T.y=s.y+T.y+.95*d.y,e.lineWidth=8*c,e.beginPath(),e.moveTo(n.x,n.y),e.lineTo(T.x,T.y),e.stroke();let S=p.factor(.2);S.x=s.x+S.x+1.09*d.x,S.y=s.y+S.y+1.09*d.y,e.beginPath(),e.lineWidth=2*c,T.subOut(r,p);let P=p.lenSqr();d.x=p.y*this.dir,d.y=-p.x*this.dir,d.factorSelf(c*c);let _=p.factor(.3);_.x=r.x+_.x+d.x*(80/P),_.y=r.y+_.y+d.y*(80/P),e.lineWidth=5*c,e.beginPath(),e.moveTo(T.x,T.y),e.lineTo(_.x,_.y),e.lineTo(r.x,r.y),e.stroke(),GameInventoryManager.getItem(this.cosmetics.head).draw(e,S.x,S.y,this.drawHeadAngle,c,this.dir),e.globalAlpha=1}}},HELI:class extends j{swapped=!1;vehicleName="Helicopter";constructor(e,t,s){super(e),this.createMasses(t),this.createSprings(),this.createCockpit(),this.updateCameraFocalPoint(),this.stopSounds(),-1===s&&this.swap()}createCockpit(){let e=document.createElement("canvas");this.canvasCockpit=e,this.ctx=e.getContext("2d"),this.ctx.fillStyle=this.color,this.ctx.strokeStyle=this.color}createMasses(e){var t=[];t.push(new Y(new s(e.x+0,e.y+18),this));var i=new F(new s(e.x+-17,e.y+42),this),o=new F(new s(e.x+17,e.y+42),this),a=new F(new s(e.x+-40,e.y+15),this),r=new F(new s(e.x+40,e.y+15),this);t.push(i),t.push(o),t.push(a),t.push(r),t[0].radius=18,t[1].radius=8,t[2].radius=8,t[3].grav=!1,t[4].grav=t[4].collide=!1,t[1].friction=.2,t[2].friction=.2,this.head=t[0],this.mass2=t[1],this.mass3=t[2],this.mass4=t[3],this.rotor=0,this.rotor2=0,this.dir=1;let n=this;t[3].drive=this.head.drive=function(){n.explode()},this.focalPoint=t[0],this.masses=t}createSprings(){let e=this.masses,t=[];t.push(new R(e[0],e[1],this)),t.push(new R(e[2],e[0],this)),t.push(new R(e[2],e[1],this)),t.push(new R(e[0],e[3],this)),t.push(new R(e[1],e[3],this)),t.push(new R(e[0],e[4],this)),t.push(new R(e[2],e[4],this)),this.spring1=t[0],this.spring2=t[1],this.spring3=t[2],this.spring4=t[3],this.spring5=t[4],this.spring6=t[5],this.spring7=t[6],t[0].leff=t[4].lrest=30,t[1].leff=t[4].lrest=30,t[2].leff=t[4].lrest=35,t[4].leff=t[4].lrest=35,t[6].leff=t[4].lrest=35;for(let e in t)t[e].dampConstant=.4;for(let e in t)t[e].springConstant=.5;this.springs=t}drawCockpit(){let e=this.canvasCockpit,t=this.scene.camera.zoom,s=50*t,i=50*t,o=Math.max(2*t,1),a=this.ctx;if(s!==e.width||i!==e.height||a.fillStyle!==this.color||a.strokeStyle!==this.color||a.lineWidth!==o){e.width=s,e.height=i;var r=this.masses[0].radius*t*.9;a.save(),a.translate(s/2,i/2),a.scale(1.3,1),a.beginPath(),a.arc(0,0,r,0,1.5*Math.PI,!1),a.lineTo(0,0),a.lineTo(r,0),a.closePath(),a.restore(),a.fillStyle=this.color,a.fill(),a.lineWidth=o,a.strokeStyle=this.color,a.stroke(),a.save(),a.translate(s/2,i/2),a.scale(1.3,1),a.beginPath(),a.arc(0,0,r,0,1.5*Math.PI,!0),a.restore(),a.stroke()}return e}updateCameraFocalPoint(){}fixedUpdate(){if(!1===this.crashed&&(this.updateSound(),this.control()),this.explosion)this.explosion.fixedUpdate();else{for(var e=this.springs,t=e.length,s=t-1;s>=0;s--)e[s].fixedUpdate();for(var i=this.masses,o=i.length,a=o-1;a>=0;a--)i[a].fixedUpdate();if((this.masses[1].contact||this.masses[2].contact)&&(this.slow=!1),!1===this.slow){for(!1===this.crashed&&this.control(),s=t-1;s>=0;s--)e[s].fixedUpdate();for(a=o-1;a>=0;a--)i[a].fixedUpdate()}this.updateCockpitAngle()}}update(e){for(let t=this.masses,s=t.length-1;s>=0;s--)t[s].update(e)}updateSound(){if(this.player.isInFocus()){let e=this.scene.sound,t=Math.min(this.head.motor,1);e.play(K,t)}}stopSounds(){this.scene.sound.stop(K)}swap(){let e=this.dir,t=this.springs,i=this.masses;e*=-1,t[2].swap();let o=new s(0,0),a=new s(0,0),r=new s(0,0);o.equ(i[3].pos),a.equ(i[3].old),r.equ(i[3].vel),i[3].pos.equ(i[4].pos),i[3].old.equ(i[4].old),i[3].vel.equ(i[4].vel),i[4].pos.equ(o),i[4].old.equ(a),i[4].vel.equ(r),this.dir=e}control(){let e=this.player.getGamepad(),t=e.isButtonDown("up"),s=e.isButtonDown("back"),i=e.isButtonDown("left"),o=e.isButtonDown("right"),a=e.isButtonDown("z"),r=this.masses,n=this.springs;a&&!this.swapped&&(this.swap(),this.swapped=!0),a||(this.swapped=!1);let h=r[1].pos.add(r[2].pos).factor(.5);h=r[0].pos.sub(h),h=h.factor(1/h.len()),r[0].angle.equ(h);let l=t?1:0;r[0].motor+=(l-r[0].motor)/10;let c=i?1:0;c+=o?-1:0,n[2].rotate(c/6),s&&(this.scene.restartTrack=!0)}updateCockpitAngle(){let e=this.masses,t=e[0].pos,s=e[3].pos,i=t.x,o=t.y,a=i-s.x,r=o-s.y;this.cockpitAngle=-(Math.atan2(a,r)-Math.PI/2),this.rotor+=.5*this.head.motor+.05,this.rotor>6.2831&&(this.rotor-=6.2831),this.rotor2+=.5,this.rotor2>6.2831&&(this.rotor2-=6.2831)}draw(e){if(this.explosion)this.explosion.draw(e,1);else{if(e.imageSmoothingEnabled=!0,e.webkitImageSmoothingEnabled=!0,e.mozImageSmoothingEnabled=!0,this.scene.ticks>0&&!this.player.isGhost()){if(!this.scene.state.playing){let t=window.lite&&lite.storage.get("snapshots");if(t>0){for(let s in this.player._checkpoints){if(s<=this.player._checkpoints.length-(parseInt(t)+1)||!this.player._checkpoints[s]||!this.player._checkpoints[s]._tempVehicle)continue;let i=document.createElement("canvas");this.drawHelicopter.call(Object.assign({},this,JSON.parse(this.player._checkpoints[s]._tempVehicle),{canvasCockpit:i,ctx:i.getContext("2d"),drawCockpit:this.drawCockpit}),e,t/300*parseInt(s)%1)}for(let s in this.player._cache){if(s<=this.player._cache.length-(parseInt(t)+1)||!this.player._cache[s]||!this.player._cache[s]._tempVehicle)continue;let i=document.createElement("canvas");this.drawHelicopter.call(Object.assign({},this,JSON.parse(this.player._cache[s]._tempVehicle),{canvasCockpit:i,ctx:i.getContext("2d"),drawCockpit:this.drawCockpit}),e,t/300*++i%1)}}}if(window.lite&&lite.storage.get("playerTrail"))for(let t in lite.snapshots){if(!lite.snapshots[t]||!lite.snapshots[t]._tempVehicle)continue;let s=document.createElement("canvas");this.drawHelicopter.call(Object.assign({},this,JSON.parse(lite.snapshots[t]._tempVehicle),{canvasCockpit:s,ctx:s.getContext("2d"),drawCockpit:this.drawCockpit}),e,lite.snapshots.length/(200*lite.snapshots.length)*parseInt(t)%1)}}this.drawHelicopter(e)}}drawHelicopter(e,t=this.player._opacity){e.globalAlpha=t;let i=this.dir,o=this.rotor,a=this.rotor2,r=this.scene,n=r.camera.zoom,h=new s(this.head.pos.x,this.head.pos.y),l=new s(this.mass2.pos.x,this.mass2.pos.y).add(this.mass3.pos).factor(.5),c=h.sub(l).factor(n),p=new s(-c.y*i,c.x*i),d=h.toScreen(r);e.strokeStyle=this.color,e.lineWidth=5*n,e.beginPath(),e.moveTo(d.x+.5*c.x,d.y+.5*c.y),e.lineTo(d.x+.8*c.x,d.y+.8*c.y),e.stroke(),e.lineWidth=3*n,e.beginPath();var u=.9*Math.cos(o);e.moveTo(d.x+.9*c.x+p.x*u,d.y+.8*c.y+p.y*u),e.lineTo(d.x+.9*c.x-p.x*u,d.y+.8*c.y-p.y*u),e.stroke();var m=new s(this.mass2.pos.x,this.mass2.pos.y).toScreen(r),g=new s(this.mass3.pos.x,this.mass3.pos.y).toScreen(r);e.lineWidth=3*n,e.strokeStyle="#".padEnd(7,"midnight"===window.lite.storage.get("theme")?"8":"dark"===window.lite.storage.get("theme")?"9":"6"),e.beginPath(),e.moveTo(m.x-.2*c.x,m.y-.2*c.y),e.lineTo(d.x,d.y),e.lineTo(g.x-.2*c.x,g.y-.2*c.y),e.stroke(),e.lineWidth=4*n,e.beginPath(),e.moveTo(m.x-.2*p.x-.1*c.x,m.y-.2*p.y-.1*c.y),e.lineTo(m.x-.25*c.x,m.y-.25*c.y),e.lineTo(g.x-.25*c.x,g.y-.25*c.y),e.lineTo(g.x+.2*p.x-.1*c.x,g.y+.2*p.y-.1*c.y),e.stroke(),e.lineWidth=6*n,e.strokeStyle=this.color,e.beginPath();var y=new s(this.mass4.pos.x,this.mass4.pos.y).toScreen(r);e.moveTo(d.x,d.y),e.lineTo(y.x,y.y),e.lineTo(d.x-.1*c.x,d.y-.3*c.y),e.stroke(),e.lineWidth=2*n,e.strokeStyle=this.color,e.beginPath();var w=7*n,f=new s(w*Math.sin(-a),w*Math.cos(-a));e.moveTo(y.x+f.x,y.y+f.y),e.lineTo(y.x-f.x,y.y-f.y),e.moveTo(y.x-f.y,y.y+f.x),e.lineTo(y.x+f.y,y.y-f.x),e.stroke(),e.beginPath(),e.lineWidth=2*n,e.arc(y.x,y.y,this.mass4.radius*n,0,2*Math.PI,!1),e.stroke(),l=this.drawCockpit();var x=l.width,v=l.height,b=d.x+5*n*this.dir,k=d.y+2*n,T=-x/2,S=-v/2,P=this.cockpitAngle,_=-1===i,C=this.cosmetics,M=GameInventoryManager.getItem(C.head),z=this.cockpitAngle;M.draw(e,b+5*n*i,k-5*n,z,.7*n,i),e.translate(b,k),e.rotate(P),_&&e.scale(1,-1),e.drawImage(l,T,S,x,v),_&&e.scale(1,-1),e.rotate(-P),e.translate(-b,-k),e.globalAlpha=1}},TRUCK:class extends j{color="#444";pedala=0;swapped=!1;vehicleName="TRUCK";constructor(e,t,s){super(e),this.createMasses(t),this.createSprings(),this.stopSounds(),this.updateCameraFocalPoint(),-1===s&&this.swap()}createMasses(e){this.masses=[],this.masses.push(new F(new s(e.x-15,e.y+7),this)),this.masses.push(new F(new s(e.x+15,e.y+7),this)),this.masses[0].friction=.1,this.masses[1].friction=.1,this.masses.push(new q(new s(e.x-20,e.y+35),this)),this.masses.push(new q(new s(e.x+20,e.y+35),this)),this.masses[2].radius=this.masses[3].radius=14,this.masses[0].radius=this.masses[1].radius=7,this.head=this.masses[0],this.backMass=this.masses[1],this.rearWheel=this.masses[2],this.frontWheel=this.masses[3]}createSprings(){this.springs=[];let e=this.masses;this.springs.push(new R(e[0],e[1],this)),this.springs.push(new R(e[0],e[2],this)),this.springs.push(new R(e[1],e[3],this)),this.springs.push(new R(e[0],e[3],this)),this.springs.push(new R(e[1],e[2],this)),this.springs.push(new R(e[2],e[3],this)),this.springs[0].leff=this.springs[0].lrest=30,this.springs[1].leff=this.springs[1].lrest=30,this.springs[2].leff=this.springs[2].lrest=30,this.springs[3].leff=this.springs[3].lrest=45,this.springs[4].leff=this.springs[4].lrest=45;for(let e in this.springs)this.springs[e].springConstant=.3}updateCameraFocalPoint(){}fixedUpdate(){if(!1===this.crashed&&(this.updateSound(),this.control()),this.explosion)this.explosion.fixedUpdate();else{for(var e=this.springs,t=e.length,s=t-1;s>=0;s--)e[s].fixedUpdate();for(var i=this.masses,o=i.length,a=o-1;a>=0;a--)i[a].fixedUpdate();if(this.rearWheel.contact&&this.frontWheel.contact&&(this.slow=!1),!1===this.slow){for(!1===this.crashed&&this.control(),s=t-1;s>=0;s--)e[s].fixedUpdate();for(a=o-1;a>=0;a--)i[a].fixedUpdate()}this.updateDrawHeadAngle(),this.updateCameraFocalPoint()}}update(e){for(var t=this.masses,s=t.length-1;s>=0;s--)t[s].fixedUpdate()}updateSound(){if(this.player.isInFocus()){let e=this.scene.sound;if(this.rearWheel.contact){let t=Math.min(this.rearWheel.motor,1);e.play(ee,t)}else if(this.frontWheel.contact){let t=Math.min(this.frontWheel.motor,1);e.play(ee,t)}else e.stop(ee)}}updateCameraFocalPoint(){this.focalPoint=1===this.dir?this.head:this.backMass}stopSounds(){this.scene.sound.stop(ee)}updateDrawHeadAngle(){let e=this.frontWheel.pos,t=this.rearWheel.pos,s=e.x,i=e.y,o=s-t.x,a=i-t.y;this.drawHeadAngle=-(Math.atan2(o,a)-Math.PI/2)}swap(){this.dir=-1*this.dir,this.springs[0].swap(),this.springs[5].swap()}control(){let e=this.gamepad,t=e.isButtonDown("up"),s=e.isButtonDown("down"),i=e.isButtonDown("left"),o=e.isButtonDown("right"),a=e.isButtonDown("z");a&&!this.swapped&&(this.swap(),this.swapped=!0),a||(this.swapped=!1);let r=t?1:0,n=this.rearWheel,h=this.frontWheel;n.motor+=(.8*r-n.motor)/10,h.motor+=(.8*r-h.motor)/10,n.brake=s,h.brake=s;let l=i?1:0;l+=o?-1:0;let c=this.springs;c[0].rotate(l/8),c[5].rotate(l/8)}draw(e){if(this.explosion)this.explosion.draw(e,1);else{if(this.scene.ticks>0&&!this.player.isGhost()){if(!this.scene.state.playing){let e=window.lite.storage.get("snapshots");if(e>0){for(let t in this.player._checkpoints)t<=this.player._checkpoints.length-(parseInt(e)+1)||!this.player._checkpoints[t]||!this.player._checkpoints[t]._tempVehicle||(e.globalAlpha=e/300*parseInt(t)%1,this.drawTruck.call(Object.assign({},this,JSON.parse(this.player._checkpoints[t]._tempVehicle),{tire:this.tire}),e),e.globalAlpha=1);for(let t in this.player._cache)t<=this.player._cache.length-(parseInt(e)+1)||!this.player._cache[t]||!this.player._cache[t]._tempVehicle||(e.globalAlpha=e/300*parseInt(t)%1,this.drawTruck.call(Object.assign({},this,JSON.parse(this.player._cache[t]._tempVehicle),{tire:this.tire}),e),e.globalAlpha=1)}}if(window.lite&&lite.storage.get("playerTrail"))for(let t in lite.snapshots)lite.snapshots[t]&&lite.snapshots[t]._tempVehicle&&(e.globalAlpha=lite.snapshots.length/(200*lite.snapshots.length)*parseInt(t)%1,this.drawTruck.call(Object.assign({},this,JSON.parse(lite.snapshots[t]._tempVehicle),{tire:this.tire}),e),e.globalAlpha=1)}if(e.imageSmoothingEnabled=!0,e.mozImageSmoothingEnabled=!0,e.webkitImageSmoothingEnabled=!0,this.settings.developerMode)for(let e=this.masses,t=e.length-1;t>=0;t--)e[t].draw();e.globalAlpha=this.player._opacity,this.drawTruck(e),e.globalAlpha=1}}drawTruck(e){let t=this.scene,i=t.camera.zoom,o=GameInventoryManager.getItem(this.cosmetics.head),a=this.drawHeadAngle,r=this.dir,n=new s(this.frontWheel.pos.x,this.frontWheel.pos.y).toScreen(t),h=new s(this.rearWheel.pos.x,this.rearWheel.pos.y).toScreen(t),l=new s(this.head.pos.x,this.head.pos.y).toScreen(t),c=new s(this.backMass.pos.x,this.backMass.pos.y).toScreen(t),p=(this.backMass.pos.x-this.head.pos.x)*i,d=(this.backMass.pos.y-this.head.pos.y)*i,u=(.5*(this.head.pos.x+this.backMass.pos.x)-.5*(this.rearWheel.pos.x+this.frontWheel.pos.x))*i,m=(.5*(this.head.pos.y+this.backMass.pos.y)-.5*(this.rearWheel.pos.y+this.frontWheel.pos.y))*i,g="#".padEnd(7,"midnight"===window.lite.storage.get("theme")?"a":"dark"===lite.storage.get("theme")?"b":"4");e.lineWidth=3*i;let y=c.x-l.x,w=c.y-l.y,f=Math.sqrt(Math.pow(y,2)+Math.pow(w,2)),x=y/f,v=w/f;o.draw(e,c.x-.5*x*i*20,c.y-v*i*20*.5,a,.45*i,r),e.strokeStyle=g,e.beginPath(),e.moveTo(l.x-.4*p-.9*u,l.y-.4*d-.9*m),e.lineTo(l.x+.8*p-.9*u,l.y+.8*d-.9*m),e.stroke(),e.closePath(),e.save(),e.fillStyle="#808080",e.beginPath(),e.moveTo(l.x-.4*p-.7*u,l.y-.4*d-.7*m),e.lineTo(l.x-.4*p-.7*u,l.y-.4*d-.7*m),e.lineTo(l.x+1.4*p-.7*u,l.y+1.4*d-.7*m),e.lineTo(l.x+1.35*p-.2*u,l.y+1.35*d-.2*m),e.lineTo(l.x+.9*p-.1*u,l.y+.9*d-.1*m),e.lineTo(l.x+.5*p-.1*u,l.y+.5*d-.1*m),e.lineTo(l.x+.5*p+.2*u,l.y+.5*d+.2*m),e.lineTo(l.x-.35*p+.2*u,l.y-.35*d+.2*m),e.closePath(),e.fill(),e.save(),e.lineWidth=2*i,e.strokeStyle=g,e.beginPath(),e.moveTo(l.x-.4*p-.7*u,l.y-.4*d-.7*m),e.lineTo(l.x-.35*p+.2*u,l.y-.35*d+.2*m),e.lineTo(l.x+.8*p+.2*u,l.y+.8*d+.2*m),e.lineTo(l.x+.9*p-.1*u,l.y+.9*d-.1*m),e.lineTo(l.x+1.35*p-.2*u,l.y+1.35*d-.2*m),e.lineTo(l.x+1.4*p-.7*u,l.y+1.4*d-.7*m),e.lineTo(l.x-.4*p-.7*u,l.y-.4*d-.7*m),e.closePath(),e.stroke(),e.lineWidth=i,e.beginPath(),e.moveTo(l.x+.5*p-.1*u,l.y+.5*d-.1*m),e.lineTo(l.x+.9*p-.1*u,l.y+.9*d-.1*m),e.lineTo(l.x+.8*p+.2*u,l.y+.8*d+.2*m),e.lineTo(l.x+.5*p+.2*u,l.y+.5*d+.2*m),e.lineTo(l.x+.5*p-.1*u,l.y+.5*d-.1*m),e.closePath(),e.stroke(),e.strokeStyle=t.settings.physicsLineColor,this.tire(e,h.x,h.y,10*i,i,this.rearWheel.angle),this.tire(e,n.x,n.y,10*i,i,this.frontWheel.angle),e.restore()}tire(e,t,s,i,o,a){e.beginPath(),e.arc(t,s,10*o,0,2*Math.PI,!1),e.fillStyle="#888888",e.fill(),e.lineWidth=5.9*o,e.closePath(),e.stroke(),e.beginPath(),e.lineWidth=2*o,i+=3*o;let r=0,n=2*Math.PI;for(;r++<8;)e.moveTo(t+i*Math.cos(a+n*r/8),s+i*Math.sin(a+n*r/8)),e.lineTo(t+i*Math.cos(a+n*(r+.5)/8),s+i*Math.sin(a+n*(r+.5)/8));for(e.stroke(),e.closePath(),e.beginPath(),r=0,i+=-9*o;r++<5;)e.moveTo(t+i*Math.cos(a+n*r/5),s+i*Math.sin(a+n*r/5)),e.lineTo(t+i*Math.cos(a+n*(r+.2)/5),s+i*Math.sin(a+n*(r+.2)/5));e.closePath(),e.stroke()}},BALLOON:class extends j{vehicleName="BALLOON";head=null;basket=null;constructor(e,t){super(e),this.createMasses(t),this.createSprings(),this.stopSounds(),this.focalPoint=this.head}createMasses(e){this.masses=[];let t=new E(e.x,e.y-10,this);t.radius=30;let i=new F(new s(e.x,e.y+35),this);i.friction=.1,this.masses.push(t),this.masses.push(i),this.head=this.masses[0],this.basket=this.masses[1];let o=this;this.head.drive=function(){o.explode()}}updateCameraFocalPoint(){}createSprings(){this.springs=[];var e=new R(this.head,this.basket,this);e.springConstant=.2,e.dampConstant=.2,e.lrest=e.leff=45,this.springs.push(e)}fixedUpdate(){if(!1===this.crashed&&this.updateSound(),this.explosion)this.explosion.fixedUpdate();else{this.head.wind=!this.basket.contact,this.slow=!1;for(var e=this.springs,t=e.length,s=t-1;s>=0;s--)e[s].fixedUpdate();for(var i=this.masses,o=i.length,a=o-1;a>=0;a--)i[a].fixedUpdate();for(s=t-1;s>=0;s--)e[s].fixedUpdate();for(a=o-1;a>=0;a--)i[a].fixedUpdate()}}update(e){for(var t=this.masses,s=t.length-1;s>=0;s--)t[s].update(e)}updateSound(){if(this.player.isInFocus()){var e=this.scene.sound,t=this.gamepad;t.isButtonDown("up")?e.play(G,.6):t.isButtonDown("up")||e.stop(G)}}stopSounds(){this.scene.sound.stop(G)}draw(e){if(this.explosion)this.explosion.draw(e,1);else{if(this.scene.ticks>0&&!this.player.isGhost()){if(!this.scene.state.playing){let e=window.lite.storage.get("snapshots");if(e>0){for(let t in this.player._checkpoints)t<=this.player._checkpoints.length-(parseInt(e)+1)||!this.player._checkpoints[t]||!this.player._checkpoints[t]._tempVehicle||(e.globalAlpha=e/300*parseInt(t)%1,this.drawBalloon.call(Object.assign({},this,JSON.parse(this.player._checkpoints[t]._tempVehicle)),e),e.globalAlpha=1);for(let t in this.player._cache)t<=this.player._cache.length-(parseInt(e)+1)||!this.player._cache[t]||!this.player._cache[t]._tempVehicle||(e.globalAlpha=e/300*parseInt(t)%1,this.drawBalloon.call(Object.assign({},this,JSON.parse(this.player._cache[t]._tempVehicle)),e),e.globalAlpha=1)}}if(window.lite.storage.get("playerTrail"))for(let t in window.lite.snapshots)window.lite.snapshots[t]&&window.lite.snapshots[t]._tempVehicle&&(e.globalAlpha=window.lite.snapshots.length/(200*window.lite.snapshots.length)*parseInt(t)%1,this.drawBalloon.call(Object.assign({},this,JSON.parse(window.lite.snapshots[t]._tempVehicle)),e),e.globalAlpha=1)}if(this.settings.developerMode)for(var t=this.masses,s=t.length-1;s>=0;s--)t[s].draw();e.globalAlpha=this.player._opacity,this.drawBalloon(e),e.globalAlpha=1}}drawBalloon(e){var t=this.scene,i=new s(this.basket.pos.x,this.basket.pos.y).toScreen(t),o=new s(this.head.pos.x,this.head.pos.y).toScreen(t),a=t.camera.zoom,r=o.x-i.x,n=o.y-i.y,h=-n;e.save(),e.strokeStyle="dark"===window.lite.storage.get("theme")?"#666":"#999",e.lineWidth=1,e.beginPath(),e.moveTo(i.x+.1*h,i.y+.1*r),e.lineTo(i.x+.5*r+.39*h,i.y+.5*n+.39*r),e.moveTo(i.x-.1*h,i.y-.1*r),e.lineTo(i.x+.5*r-.39*h,i.y+.5*n-.39*r),e.moveTo(i.x+.1*h,i.y+.1*r),e.lineTo(i.x+.4*r+.21*h,i.y+.4*n+.21*r),e.moveTo(i.x-.1*h,i.y-.1*r),e.lineTo(i.x+.4*r-.21*h,i.y+.4*n-.21*r),e.closePath(),e.stroke();const l=new E(this.head.pos.x,this.head.pos.y,this);l.radius=30,l.draw(e),this.gamepad.isButtonDown("up")&&(e.beginPath(),e.strokeStyle="#FFFF00",e.lineWidth=8*a,e.moveTo(i.x,i.y),e.lineTo(i.x+.1*r,i.y+.1*n),e.closePath(),e.stroke(),e.beginPath(),e.strokeStyle="#FFAA00",e.lineWidth=3*a,e.moveTo(i.x,i.y),e.lineTo(i.x+.1*r,i.y+.1*n),e.closePath(),e.stroke()),e.beginPath(),e.fillStyle="midnight"===window.lite.storage.get("theme")?"#ccc":"dark"===window.lite.storage.get("theme")?"#fbfbfb":"#000",e.moveTo(i.x+.1*h,i.y+.1*r),e.lineTo(i.x-.1*h,i.y-.1*r),e.lineTo(i.x-.22*r-.1*h,i.y-.22*n-.1*r),e.lineTo(i.x-.22*r+.1*h,i.y-.22*n+.1*r),e.lineTo(i.x+.1*h,i.y+.1*r),e.closePath(),e.fill(),e.restore()}},BLOB:class extends j{vehicleName="Blob";constructor(e,t){super(e),this.createMasses(t),this.createSprings(),this.stopSounds()}createMasses(e){let t=[];t.push(new q(new s(e.x+15,e.y+40),this)),t.push(new q(new s(e.x+-15,e.y+40),this)),t.push(new q(new s(e.x+-15,e.y+10),this)),t.push(new q(new s(e.x+15,e.y+10),this));let i=new F(new s(0,0),this);i.vel=new s(0,0),this.m0=t[0],this.m1=t[1],this.m2=t[2],this.m3=t[3],this.head=i,this.masses=t,this.focalPoint=this.head}createSprings(){let e=this.masses,t=[],s=this.spring0=new R(e[0],e[1],this),i=this.spring1=new R(e[1],e[2],this),o=this.spring2=new R(e[2],e[3],this),a=this.spring3=new R(e[3],e[0],this),r=this.spring4=new R(e[0],e[2],this),n=this.spring5=new R(e[1],e[3],this);t.push(s),t.push(i),t.push(o),t.push(a),t.push(r),t.push(n);for(let e in t)t[e].springConstant=.2,t[e].dampConstant=.2;this.springs=t}fixedUpdate(){if(!1===this.crashed&&(this.updateSound(),this.control()),this.explosion)this.explosion.fixedUpdate();else{let s=this.masses,i=s.length,o=this.springs,a=o.length;for(var e=a-1;e>=0;e--)o[e].fixedUpdate();for(var t=i-1;t>=0;t--)s[t].fixedUpdate();if((s[0].contact||s[1].contact||s[2].contact||s[3].contact)&&(this.slow=!1),!this.slow){for(this.control(),e=a-1;e>=0;e--)o[e].fixedUpdate();for(t=i-1;t>=0;t--)s[t].fixedUpdate()}let r=0,n=0;for(let e of this.masses)r+=e.pos.x,n+=e.pos.y;let h=this.head;h.pos.x=.25*r,h.pos.y=.25*n,h.vel=s[0].vel}}update(e){for(let t=this.masses,s=t.length-1;s>=0;s--)t[s].update(e)}updateSound(){this.player.isInFocus()&&this.scene.sound.play(H,.4)}stopSounds(){this.scene.sound.stop(H)}updateCameraFocalPoint(){}control(){let e,t,s=this.player.getGamepad(),i=s.isButtonDown("up"),o=s.isButtonDown("down"),a=s.isButtonDown("left"),r=s.isButtonDown("right"),n=s.isButtonDown("z"),h=this.masses,l=this.springs,c=h.length,p=l.length,d=this.dir;d=r?1:-1;let u=r||a?1:0;for(o&&(u=0),e=c-1;e>=0;e--)h[e].motor+=(u*d*1-h[e].motor)/10,0==u&&(h[e].motor=0),h[e].brake=o;let m=a?1:0;if(m+=r?-1:0,l[4].rotate(m/9),l[5].rotate(m/9),n||i)for(t=p-1;t>=0;t--)l[t].contract(30,10);else for(t=p-1;t>=0;t--)l[t].contract(0,1.5)}draw(t){if(this.explosion)this.explosion.draw(t,1);else{if(this.scene.ticks>0&&!this.player.isGhost()){if(!this.scene.state.playing){let s=window.lite&&lite.storage.get("snapshots");if(s>0){for(let e in this.player._checkpoints)e<=this.player._checkpoints.length-(parseInt(s)+1)||!this.player._checkpoints[e]||!this.player._checkpoints[e]._tempVehicle||this.drawBlob.call(Object.assign({},this,JSON.parse(this.player._checkpoints[e]._tempVehicle)),t,s/300*parseInt(e)%1);for(let i in this.player._cache)i<=this.player._cache.length-(parseInt(s)+1)||!this.player._cache[i]||!this.player._cache[i]._tempVehicle||this.drawBlob.call(Object.assign({},this,JSON.parse(this.player._cache[i]._tempVehicle)),t,s/300*++e%1)}}if(window.lite&&lite.storage.get("playerTrail"))for(let e in lite.snapshots)lite.snapshots[e]&&lite.snapshots[e]._tempVehicle&&this.drawBlob.call(Object.assign({},this,JSON.parse(lite.snapshots[e]._tempVehicle)),t,lite.snapshots.length/(200*lite.snapshots.length)*parseInt(e)%1)}this.drawBlob(t)}}drawBlob(e,t=this.player._opacity){let i=this.scene,o=i.camera.zoom,a=new s(this.m0.pos.x,this.m0.pos.y).toScreen(i),r=new s(this.m1.pos.x,this.m1.pos.y).toScreen(i),n=new s(this.m2.pos.x,this.m2.pos.y).toScreen(i),h=new s(this.m3.pos.x,this.m3.pos.y).toScreen(i);e.globalAlpha=t,e.beginPath(),e.fillStyle=e.strokeStyle,e.lineWidth=20*o,e.lineCap="round",e.moveTo(a.x,a.y),e.lineTo(r.x,r.y),e.lineTo(n.x,n.y),e.lineTo(h.x,h.y),e.closePath(),e.fill(),e.stroke(),e.globalAlpha=1}}};function ie(e,t){for(var s in t)try{e[s]=t[s].constructor==Object?ie(e[s],t[s]):t[s]}catch(i){e[s]=t[s]}return e}const oe=class{constructor(e,t){this.id=te++,this._scene=e,this._game=e.game,this._user=t,this._settings=e.settings;let i=e.settings.startVehicle;e.settings.track&&(i=e.settings.track.vehicle),this._baseVehicleType=i,this._gamepad=new I(e),this._ghost=!1,this._color=t.color?t.color:"#000000",this.setDefaults(),this.createBaseVehicle(new s(0,35),1,new s(0,0))}getCheckpointCount(){return this._checkpoints.length}setDefaults(){this._baseVehicle=!1,this._tempVehicleType=null,this._tempVehicle=!1,this._tempVehicleTicks=0,this._temp_vehicle_options=null,this._addCheckpoint=!1,this._checkpoints=[],this._cache=[],this._crashed=!1,this._effect=!1,this._effectTicks=0,this._opacity=1,this.complete=!1,this._powerupsConsumed={checkpoints:[],targets:[],misc:[]}}hasCheckpoints(){return this._checkpoints.length>0}setColor(e){this._color=e}dead(){if(this._crashed=!0,!1===this._ghost){let e=this._scene,t=e.settings,s=e.message;e.state.playerAlive=this.isAlive(),this._checkpoints.length>0?t.mobile?s.show("Tap to go to checkpoint!",!1,"#000000","#FFFFFF"):s.show("Press Enter For Checkpoint",!1,"#000000","#FFFFFF"):t.mobile?s.show("Tap to Restart!",!1,"#000000","#FFFFFF"):s.show("Press Enter To Restart",!1,"#000000","#FFFFFF")}}setAsGhost(){this._ghost=!0,this._replayIterator=this.createReplayIterator()}isGhost(){return this._ghost}isAlive(){return!this._crashed}getTargetsHit(){return this._powerupsConsumed.targets.length}getGamepad(){return this._gamepad}setBaseVehicle(e){this._baseVehicleType=e,this.reset()}createBaseVehicle(e,t,s){this._tempVehicle&&this._tempVehicle.stopSounds(),this._baseVehicle=new se[this._baseVehicleType](this,e,t,s),this._tempVehicle=!1,this._tempVehicleType=!1,this._tempVehicleTicks=0}setTempVehicle(e,t,s,i){this._temp_vehicle_options&&this._temp_vehicle_options.type===e&&(t=this._temp_vehicle_options.ticks+t),this._temp_vehicle_options={type:e,ticks:t,position:s,direction:i}}createTempVehicle(e,t,s,i){if(this._temp_vehicle_options){let o=this._temp_vehicle_options;e=o.type,t=o.ticks,s=o.position,i=o.direction,this._temp_vehicle_options=null}this._tempVehicleType===e?this._tempVehicleTicks+=t:(this.getActiveVehicle().stopSounds(),this._effect=new U(s,this._scene),this._effectTicks=45,this._tempVehicleType=e,this._tempVehicle=new se[e](this,s,i),this._tempVehicleTicks=t)}fixedUpdate(){let e=this._baseVehicle;this._temp_vehicle_options&&this.createTempVehicle(),this._tempVehicleTicks>0&&(e=this._tempVehicle,!1===this._crashed&&this._tempVehicleTicks--,this._tempVehicleTicks<=0&&!1===this._crashed&&(this._effectTicks=45,this._effect=new U(this._tempVehicle.focalPoint.pos,this._scene),this.createBaseVehicle(this._tempVehicle.focalPoint.pos,this._tempVehicle.dir,this._tempVehicle.masses[0].vel),e=this._baseVehicle)),this._effectTicks>0&&(this._effectTicks--,this._effect.fixedUpdate()),lite.storage.get("playerTrail")&&this.isGhost()||this.isAlive()&&lite.snapshots.push(this._createSnapshot()),e.fixedUpdate(),this._addCheckpoint&&(this.isAlive()&&this._createCheckpoint(),this._addCheckpoint=!1)}*createReplayIterator(e=0){const t=new Map;for(this._gamepad.playbackTicks=0;!1===this.complete;){if(t.has(this._gamepad.playbackTicks)||this.isAlive()&&t.set(this._gamepad.playbackTicks,{downButtons:Object.assign({},this._gamepad.downButtons),snapshot:this._createSnapshot()}),this._gamepad.playbackTicks>=e){const s=yield this._gamepad.playbackTicks;if(isFinite(s)){if(t.has(s)){let{downButtons:e,snapshot:i}=t.get(s);this._checkpoints.push(i),this.gotoCheckpoint(),this._checkpoints.pop(),this._gamepad.playbackTicks=s,this._gamepad.downButtons=Object.assign({},e)}else s<e&&this.reset();this._scene.camera.focusIndex=this._scene.playerManager._players.indexOf(this),this._scene.camera.focusOnPlayer(),e=s;continue}e=this._gamepad.playbackTicks+1/(this._game.ups/30)}this._gamepad.update(),this.checkKeys(),this.fixedUpdate(),this._gamepad.playbackTicks+=1/(this._game.ups/30),this.isInFocus()&&window.hasOwnProperty("lite")&&window.lite.replayGui&&(window.lite.replayGui.progress.value=this._gamepad.playbackTicks)}return this.loop&&(this.reset(),this._replayIterator=this.createReplayIterator()),t}isInFocus(){return this._scene.camera.playerFocus&&this._scene.camera.playerFocus===this}updateOpacity(){let e=1;if(this._scene.camera.playerFocus&&this._scene.camera.playerFocus!==this){var t=this.getDistanceBetweenPlayers(this._scene.camera.playerFocus);1200>t&&(e=Math.min(t/500,1))}this._opacity=e}drawName(e){let t=this.getActiveVehicle().focalPoint.pos.toScreen(this._scene);e.globalAlpha=this._opacity,e.beginPath(),e.fillStyle=this._color,e.moveTo(t.x,t.y-40*this._scene.camera.zoom),e.lineTo(t.x-5*this._scene.camera.zoom,t.y-50*this._scene.camera.zoom),e.lineTo(t.x+5*this._scene.camera.zoom,t.y-50*this._scene.camera.zoom),e.lineTo(t.x,t.y-40*this._scene.camera.zoom),e.fill(),e.font=9*this._scene.game.pixelRatio*Math.max(this._scene.camera.zoom,1)+"pt helsinki",e.textAlign="center",e.fillStyle=this._color,e.fillText(this._user.d_name,t.x,t.y-60*this._scene.camera.zoom),e.globalAlpha=1}draw(e){this.updateOpacity();let t=this._baseVehicle;this._tempVehicleTicks>0&&(t=this._tempVehicle),this._effectTicks>0&&this._effect.draw(e,this._effectTicks/100),t.draw(e),this.isGhost()&&this.drawName(e)}checkKeys(){var e=this._gamepad,t=this._ghost,s=this._scene;if(!e.isButtonDown("enter")&&!e.isButtonDown("backspace")&&e.areKeysDown()&&this._cache.length>0&&(this._cache=[]),e.isButtonDown("shift")&&e.isButtonDown("enter")){var i=e.getButtonDownOccurances("enter");this.returnToCheckpoint(i),e.setButtonUp("enter")}!1===t&&(e.areKeysDown()&&!this._crashed&&s.play(),e.isButtonDown("restart")&&(s.restartTrack=!0,e.setButtonUp("restart")),(e.isButtonDown("up")||e.isButtonDown("down")||!s.camera.focusIndex&&(e.isButtonDown("left")||e.isButtonDown("right")))&&s.camera.focusOnMainPlayer()),e.isButtonDown("enter")&&(this.gotoCheckpoint(),e.setButtonUp("enter")),e.isButtonDown("backspace")&&(i=e.getButtonDownOccurances("backspace"),this.removeCheckpoint(i),e.setButtonUp("backspace"))}getDistanceBetweenPlayers(e){let t=e.getActiveVehicle(),s=this.getActiveVehicle(),i=t.focalPoint.pos.x-s.focalPoint.pos.x,o=t.focalPoint.pos.y-s.focalPoint.pos.y;return Math.sqrt(Math.pow(i,2)+Math.pow(o,2))}getActiveVehicle(){return this._tempVehicleTicks>0?this._tempVehicle:this._baseVehicle}_createCheckpoint(){this._checkpoints.push(this._createSnapshot())}_createSnapshot(){let e={};return this._tempVehicleTicks>0?(e._tempVehicleType=this._tempVehicleType,e._tempVehicle=JSON.stringify(this._tempVehicle,this._snapshotFilter),e._tempVehicleTicks=this._tempVehicleTicks):(e._baseVehicleType=this._baseVehicleType,e._baseVehicle=JSON.stringify(this._baseVehicle,this._snapshotFilter)),e._powerupsConsumed=JSON.stringify(this._powerupsConsumed),e._crashed=this._crashed,e}_snapshotFilter(e,t){switch(e){case"parent":case"player":case"scene":case"settings":case"masses":case"springs":case"focalPoint":case"gamepad":return;case"explosion":return!1;default:return t}}setCheckpointOnUpdate(){this._addCheckpoint=!0}crashed(){this._crashed=!0}gotoCheckpoint(){let e=this._gamepad.replaying,t=this._scene;if(this._checkpoints.length>0){let s=this._checkpoints[this._checkpoints.length-1];if(s._tempVehicle){this._baseVehicle.stopSounds();let e=this._tempVehicle;this._tempVehicleType!==s._tempVehicleType&&(e=new se[s._tempVehicleType](this,{x:0,y:0})),ie(e,JSON.parse(s._tempVehicle)),this._tempVehicle=e,this._tempVehicleType=s._tempVehicleType,this._tempVehicleTicks=s._tempVehicleTicks,e.updateCameraFocalPoint()}else{let e=this._baseVehicle;ie(e,JSON.parse(s._baseVehicle)),this._tempVehicle&&this._tempVehicle.stopSounds(),this._baseVehicle=e,this._tempVehicleTicks=0,this._tempVehicleType=!1,e.updateCameraFocalPoint()}if(this._powerupsConsumed=JSON.parse(s._powerupsConsumed),this._crashed=s._crashed,!1===e){let e=t.settings;t.state.playerAlive=this.isAlive(),t.settings.mobile?t.message.show("Tap to resume",5,"#826cdc","#FFFFFF"):t.message.show("Press Backspace To Go Back Further",5,"#826cdc","#FFFFFF"),t.track.updatePowerupState(this),e.waitAtCheckpoints&&(t.state.playing=!1),t.camera.focusOnMainPlayer()}t.camera.playerFocus===this&&t.camera.fastforward()}else!1===e&&this.restartScene()}restartScene(){!1===this._gamepad.replaying&&(this._scene.restartTrack=!0)}removeCheckpoint(e){if(this._checkpoints.length>1){for(let t=0;e>t;t++)this._cache.push(this._checkpoints.pop());this.gotoCheckpoint()}else this.restartScene()}returnToCheckpoint(e){if(this._cache.length>0){for(var t=0;e>t;t++)this._checkpoints.push(this._cache.pop());this.gotoCheckpoint()}}close(){this.id=null,this._scene=null,this._game=null,this._user=null,this._settings=null,this._baseVehicleType=null,this._gamepad.close(),this._gamepad=null,this._baseVehicle=null,this._tempVehicleType=null,this._tempVehicle=null,this._tempVehicleTicks=null,this._addCheckpoint=null,this._checkpoints=null,this._cache=null,this._crashed=null,this._effect=null,this._effectTicks=null,this._powerupsConsumed=null}reset(){this._tempVehicle&&this._tempVehicle.stopSounds(),this._baseVehicle.stopSounds(),this.setDefaults(),this.createBaseVehicle(new s(0,35),1,new s(0,0)),this._gamepad.reset(),this._scene.state.playerAlive=this.isAlive(),window.hasOwnProperty("lite")&&(window.lite.snapshots.splice(0),window.lite.replayGui&&(window.lite.replayGui.progress.value=0))}},ae=class{_players=[];_playerLookup={};firstPlayer=null;constructor(e){this.scene=e,this.game=e.game,this.settings=e.settings}fixedUpdate(){if(!this.scene.camera.focusIndex)for(let e=this._players.filter((e=>!e.complete&&!e.isGhost())),t=e.length,s=0;t>s;s++)e[s].fixedUpdate();for(let e=this._players.filter((e=>!e.complete&&e.isGhost())),t=e.length,s=0;t>s;s++)e[s]._replayIterator.next()}mutePlayers(){for(let e=this._players,t=e.length,s=0;t>s;s++)e[s].getActiveVehicle().stopSounds()}updateGamepads(){for(let e=this._players.filter((e=>!e.isGhost())),t=e.length,s=0;t>s;s++)e[s]._gamepad.update()}createPlayer(e,t){return new oe(this.scene,t)}addPlayer(e){this._players.push(e),this._playerLookup[e.id]=e}checkKeys(){for(let e=this._players.filter((e=>!e.isGhost())),t=e.length,s=0;t>s;s++)e[s].checkKeys()}draw(e){for(let t of this._players)t.draw(e)}getPlayerByIndex(e){return this._players[e]}getPlayerById(e){return this._playerLookup[e]}getPlayerCount(){return this._players.length}reset(){for(let e=this._players,t=e.length,s=0;t>s;s++)e[s].reset();for(let e=this._players.filter((e=>e.isGhost())),t=e.length,s=0;t>s;s++)e[s]._replayIterator=e[s].createReplayIterator()}clear(){this._players.splice(1),this._playerLookup={},this._playerLookup[this.firstPlayer.id]=this.firstPlayer}_closePlayers(){for(let e=this._players,t=e.length,s=0;t>s;s++)e[s].close()}close(){this._closePlayers(),this._players=null,this._playerLookup=null,this.firstPlayer=null,this.scene=null,this.game=null,this.settings=null}},re=class{settings=null;scene=null;zoom=1;position=null;desiredZoom=1;zoomPercentage=0;focusIndex=0;playerFocus=null;constructor(e){this.settings=e.settings,this.scene=e,this.zoom=e.settings.cameraStartZoom*e.game.pixelRatio,this.desiredZoom=e.settings.cameraStartZoom*e.game.pixelRatio,this.zooming=!1,this.position=new s(0,0),this.zoomPercentage=this.getZoomAsPercentage(),this.zoomPoint=!1}focusOnNextPlayer(){this.focusIndex=(this.focusIndex+1)%this.scene.playerManager.getPlayerCount(),this.focusOnPlayer()}focusOnPlayer(){this.scene.playerManager.getPlayerCount()<=this.focusIndex&&(this.focusIndex=0);let e=this.scene.playerManager.getPlayerByIndex(this.focusIndex);this.playerFocus!==e&&(0===this.focusIndex&&(this.scene.playerManager._players.filter((e=>e.isGhost())).forEach((e=>e._replayIterator.next(this.scene.ticks))),this.focusIndex=0),this.playerFocus=e,this.scene.vehicleTimer.setPlayer(e),this.playerFocus?e.getDistanceBetweenPlayers(this.playerFocus)>1500&&this.fastforward():this.fastforward()),window.hasOwnProperty("lite")&&window.lite.replayGui&&(window.lite.replayGui.style.setProperty("display",0!==this.focusIndex?"block":"none"),0!==this.focusIndex&&(e=this.scene.races.find((({user:t})=>t.u_id==e._user.u_id)))&&(window.lite.replayGui.progress.max=e.race.run_ticks??100))}focusOnMainPlayer(){0===this.focusIndex&&this.playerFocus||(this.focusIndex=0,this.focusOnPlayer())}update(){if(this.playerFocus){let e=this.playerFocus.getActiveVehicle(),t=3;Math.sqrt(Math.pow(e.focalPoint.pos.x-this.position.x,2)+Math.pow(e.focalPoint.pos.y-this.position.y,2))>1500&&(t=1),this.position.x+=(e.focalPoint.pos.x-this.position.x)/t,this.position.y+=(e.focalPoint.pos.y-this.position.y)/t}}updateZoom(){this.desiredZoom!==this.zoom&&(this.scene.loading=!0,this._performZoom(),this.zoom===this.desiredZoom&&this.zoomComplete())}zoomToPoint(e){this.position.x=this.scene.screen.toReal(this.zoomPoint.x,"x")-this.scene.screen.width/e*this.zoomPoint.x/this.scene.screen.width+this.scene.screen.width/e/2,this.position.y=this.scene.screen.toReal(this.zoomPoint.y,"y")-this.scene.screen.height/e*this.zoomPoint.y/this.scene.screen.height+this.scene.screen.height/e/2}_performZoom(){let e=this.zoom+(this.desiredZoom-this.zoom)/3;Math.abs(this.desiredZoom-this.zoom)<.05&&(e=this.desiredZoom),this.zoomPoint&&this.zoomToPoint(e),this.zoom=e}zoomComplete(){this.scene.redraw(),this.zooming=!1,this.scene.loading=!1}setZoom(e,t){this.desiredZoom=Math.round(e*window.devicePixelRatio*10)/10,this.zooming=!0,this.desiredZoom===this.zoom&&(this.zooming=!1,this.scene.state.loading=!1),this.zoomPoint=!1,null===this.playerFocus&&t&&(this.zoomPoint=t),this.zoomPercentage=this.getZoomAsPercentage(),this.scene.stateChanged()}resetZoom(){this.setZoom(this.settings.cameraStartZoom)}getZoomAsPercentage(){return this.desiredZoom/window.devicePixelRatio/this.scene.settings.cameraStartZoom*100|0}increaseZoom(){this.setZoom((this.desiredZoom+2*this.scene.settings.cameraSensitivity)/window.devicePixelRatio),this.desiredZoom>this.scene.settings.cameraZoomMax*window.devicePixelRatio&&this.setZoom(this.scene.settings.cameraZoomMax)}decreaseZoom(){this.setZoom((this.desiredZoom-2*this.scene.settings.cameraSensitivity)/window.devicePixelRatio),this.desiredZoom<this.scene.settings.cameraZoomMin*window.devicePixelRatio&&this.setZoom(this.scene.settings.cameraZoomMin)}unfocus(){this.playerFocus=null,this.scene.vehicleTimer.removePlayer()}fastforward(){if(this.playerFocus){let e=this.playerFocus.getActiveVehicle();this.position.x=e.focalPoint.pos.x,this.position.y=e.focalPoint.pos.y}}close(){this.zoom=null,this.scene=null,this.position=null,this.playerFocus=null}},ne=class{game=null;scene=null;size=null;center=null;width=0;height=0;constructor(e){this.scene=e,this.game=e.game,this.size=new s(0,0),this.center=new s(0,0),this.setScreen()}setScreen(){this.width=this.game.width,this.height=this.game.height,this.size.x=this.game.width,this.size.y=this.game.height,this.center.x=this.game.width/2,this.center.y=this.game.height/2}update(){(this.game.width!==this.width||this.game.height!==this.height)&&this.setScreen()}realToScreen(e,t){return(e-this.scene.camera.position[t])*this.scene.camera.zoom+this.scene.screen.center[t]}toReal(e,t){return(e-this.scene.screen.center[t])/this.scene.camera.zoom+this.scene.camera.position[t]}close(){this.width=null,this.height=null,this.center=null,this.size=null,this.game=null,this.scene=null}},he=class{game=null;assets=null;settings=null;camera=null;screen=null;mouse=null;track=null;ticks=0;state=null;oldState=null;vehicle="Mtb";importCode=!1;pauseControls=null;controls=null;message=null;analytics=null;constructor(e){this.game=e,this.assets=e.assets,this.settings=e.settings,this.sound=new A(this),this.mouse=new z(this),this.score=new C(this),this.camera=new re(this),this.screen=new ne(this),this.message=new P(this),this.createTrack(),this.loadingcircle=new S(this),this.playerManager=new ae(this),this.vehicleTimer=new O(this)}get stateDirty(){return this.isStateDirty()}createMainPlayer(){let e=this.playerManager.createPlayer(this,this.settings.user),t=e.getGamepad();return t.onButtonDown=this.buttonDown.bind(this),t.listen(),this.playerManager.firstPlayer=e,this.playerManager.addPlayer(e),t}createTrack(){this.track&&this.track.close();let e=new T(this);return this.track=e,e}command(){var e=Array.prototype.slice.call(arguments,0);switch(e.shift()){case"resize":this.resize();break;case"dialog":var t=e[0];!1===t?this.listen():this.unlisten(),this.openDialog(t);break;case"focused":!0===e[0]?(this.state.inFocus=!0,!1===this.state.showDialog&&this.listen()):(this.state.inFocus=!1,this.unlisten(),this.state.playing=!1);break;case"add track":this.importCode=e[0].code}}draw(e){e.clearRect(0,0,e.canvas.width,e.canvas.height),this.toolHandler.drawGrid(e),this.track.draw(e),this.score.draw(e),this.playerManager.draw(e),this.vehicleTimer.player&&this.vehicleTimer.player._tempVehicleTicks>0&&this.vehicleTimer.draw(e),this.controls&&!1!==this.controls.isVisible()||this.toolHandler.draw(e),this.loading&&this.loadingcircle.draw(e),this.message.draw(e),this.pauseControls.draw(e),this.controls&&this.controls.draw(e)}fixedUpdate(){let e,t;this.camera.focusIndex>0&&(e=this.playerManager.firstPlayer._gamepad.downButtons.right-this.playerManager.firstPlayer._gamepad.downButtons.left)&&((t=this.playerManager.getPlayerByIndex(this.camera.focusIndex))&&t.isGhost()&&t._replayIterator.next((t._gamepad.playbackTicks??this.ticks)+5*e),this.state.playing=!1),this.screen.update(),this.updateControls(),this.camera.update(),this.sound.update(),this.restartTrack&&this.restart(),!this.state.paused&&this.state.playing&&(this.message.update(),this.playerManager.fixedUpdate(),!this.camera.focusIndex&&(this.playerManager.firstPlayer.complete?this.trackComplete():this.ticks++)),this.score.update(),this.vehicleTimer.fixedUpdate(),this.isStateDirty()&&this.updateState(),this.camera.updateZoom()}getAvailableTrackCode(){let e=this.settings,t=!1;return e.importCode&&t!=e.importCode?(t=e.importCode,e.importCode=null):this.importCode&&(t=this.importCode,this.importCode=null),t}hideControlPlanel(){}interactWithControls(){this.controls&&this.controls.click(),this.pauseControls.click()}isStateDirty(){let e=!1;for(let t in this.state)this.state[t]!==this.oldState[t]&&(e=!0,this.oldState[t]=this.state[t]);return e}redraw(){this.track.undraw(),GameInventoryManager.redraw(),this.toolHandler.resize()}registerTools(){let e=new B(this);return this.toolHandler=e,e.registerTool(L),e}resize(){this.controls&&this.controls.resize()}showControlPlanel(){}stateChanged(){this.updateState()}toggleVehicle(){let e=this.track.allowedVehicles,t=e.length,s=(this.state.vehicle||this.vehicle).toUpperCase(),i=e.indexOf(s);s=e[++i%t],this.selectVehicle(s)}updateControls(){if(this.controls){let e=this.state.paused;this.controls.isVisible()===e&&(e||(this.state.playing=!1,this.camera.focusOnMainPlayer(),this.toolHandler.setTool("camera")),this.controls.setVisibility(!e),this.updateState()),this.controls.update()}this.pauseControls.update()}updateToolHandler(){this.controls&&!1!==this.controls.isVisible()||this.toolHandler.update()}selectVehicle(e){-1!==this.track.allowedVehicles.indexOf(e)&&(this.settings.track.vehicle=e,this.vehicle=e,this.playerManager.firstPlayer.setBaseVehicle(e),this.restartTrack=!0)}listen(){this.playerManager.firstPlayer.getGamepad().listen()}unlisten(){this.playerManager.firstPlayer.getGamepad().unlisten()}openDialog(e){this.state.playing=!1,this.state.showDialog=e}setStateDefaults(){let e={};return e.playing=!this.settings.waitForKeyPress,e.showDialog=!1,e.dialogOptions=!1,e.preloading=!0,e.fullscreen=this.settings.fullscreen,e.inFocus=!0,e}stopAudio(){this.sound&&this.sound.stop_all()}toggleFullscreen(){if(this.settings.embedded){let e=this.settings,t=e.basePlatformUrl+"/t/"+e.track.url;window.open(t)}else if(this.settings.fullscreenAvailable){let e=!this.settings.fullscreen;return this.settings.fullscreen=e,this.state.fullscreen=e,!0}}close(){this.pauseControls=null,this.score=null,this.mouse.close(),this.mouse=null,this.camera.close(),this.camera=null,this.screen.close(),this.screen=null,this.vehicleTimer.close(),this.vehicleTimer=null,this.playerManager.close(),this.playerManager=null,this.sound.close(),this.sound=null,this.track.close(),this.toolHandler.close(),this.game=null,this.assets=null,this.settings=null,this.track=null,this.state=null,this.stopAudio()}},le=class{defaultControlOptions={visible:!0};name=null;controlsSpriteSheetData={};controlData=null;game=null;scene=null;settings=null;controlsSprite=null;gamepad=null;properties={alpha:1,right:0,scaleX:window.devicePixelRatio/2,scaleY:window.devicePixelRatio/2,top:60,visible:!0,x:0,y:0};init(e){this.scene=e,this.game=e.game,this.assets=e.assets,this.settings=e.settings,this.mouse=e.mouse,this.playerManager=e.playerManager,this.createSprite(),this.resize()}isMouseOverComponent(e){const{x:t,y:s}=this.mouse.touch.pos;return Math.sqrt((t-e.x)**2+(s-e.y)**2)<e.width/2*e.scaleX}click(){}createSprite(){let e=this.scene.assets.getResult(this.name);this.controlsSpriteSheetData.images=[e],this.controlsSprite=e}draw(e){if(this.properties.visible){e.save(),e.globalAlpha=this.properties.alpha;for(const t in this.controlData){const s=this.controlData[t];let i=this.controlsSpriteSheetData[(s.image||t)+"_btn"],o=i[2]*this.properties.scaleX,a=i[3]*this.properties.scaleY;e.globalAlpha=this.properties.alpha*s.alpha,e.drawImage(this.controlsSpriteSheetData.images[0],...i,this.game.width-s.right*this.properties.scaleX-o/2,s.top*this.properties.scaleY-a/2,o,a)}e.restore()}}isVisible(){return this.properties.visible}hide(){this.setVisibility(!1)}show(){this.setVisibility(!0)}setVisibility(e){this.properties.visible=e}mouseOver(e){e&&(e.alpha=this.mouse.touch.down?1:.8),this.mouse.enabled=!1,this.game.canvas.style.setProperty("cursor","pointer")}mouseOut(e){e&&(e.alpha=.5),this.mouse.enabled=!0,this.game.canvas.style.removeProperty("cursor","default")}controlDown(e){let t=this.playerManager.firstPlayer.getGamepad();if(e.target.buttonDetails.key&&t.setButtonDown(e.target.buttonDetails.key),e.target.buttonDetails.keys)for(var s=e.target.buttonDetails.keys,i=s.length,o=0;i>o;o++)t.setButtonDown(s[o]);e.target.buttonDetails.downCallback&&e.target.buttonDetails.downCallback(e),this.settings.mobile&&(this.mouse.enabled=!1),e.target.alpha=1}controlUp(e){var t=e.target,s=t.buttonDetails,i=this.playerManager.firstPlayer.getGamepad();if(s.key){var o=s.key;i.setButtonUp(o)}if(s.keys)for(var a=s.keys,r=a.length,n=0;r>n;n++)o=a[n],i.setButtonUp(o);s.upCallback&&s.upCallback(e),this.settings.mobile?(this.mouse.enabled=!0,t.alpha=.5):t.alpha=.8}click(){}close(){}update(){for(const e in this.controlData){const t=this.controlData[e];this.isMouseOverComponent(t)?(this.mouseOver(t),t.hovering=!0):t.hovering&&!this.mouse.enabled&&(this.mouseOut(t),delete t.hovering)}}resize(){let e=this.scene.game,t=e.width,s=e.height;this.properties.scaleX=this.properties.scaleY=window.devicePixelRatio/2,this.properties.bottom&&(this.properties.y=s-this.properties.bottom*this.properties.scaleY),this.properties.left&&(this.properties.x=this.properties.left*this.properties.scaleX),this.properties.right&&(this.properties.x=t-this.properties.right*this.properties.scaleX),this.properties.top&&(this.properties.y=this.properties.top*this.properties.scaleY);for(const e in this.controlData){const i=this.controlData[e];i.scaleX=i.scaleY=window.devicePixelRatio/2,i.bottom&&(i.y=s-i.bottom*i.scaleY),i.left&&(i.x=i.left*i.scaleX),i.right&&(i.x=t-i.right*i.scaleX),i.top&&(i.y=i.top*i.scaleY)}}},ce=class extends le{name="pause_controls";paused=!1;controlsSpriteSheetData={pause_btn:[230,2,76,76],play_btn:[78,2,76,76]};controlData={pause:{alpha:.5,key:"pause",top:60,right:70,width:76,height:76}};constructor(e){super(...arguments),this.init(...arguments)}click(e=Object.values(this.controlData).find(this.isMouseOverComponent.bind(this))){for(const e in this.controlData){const t=this.controlData[e];this.isMouseOverComponent(t)&&this.scene.buttonDown(t.key)}}update(){let e=this.scene.state.paused;this.paused!==e&&(e?(this.controlData.pause.image="play",this.paused=!0):(this.controlData.pause.image="pause",this.paused=!1)),super.update()}},pe=class extends le{name="redo_undo_controls";controlsSpriteSheetData={redo_btn:[78,2,76,76],undo_btn:[2,2,76,76]};controlData={redo:{keys:["ctrl","y"],alpha:.5,top:60,right:160,width:76,height:76},undo:{keys:["ctrl","z"],alpha:.5,top:60,right:240,width:76,height:76}};constructor(e){super(...arguments),this.init(...arguments)}click(e=Object.values(this.controlData).find(this.isMouseOverComponent.bind(this))){for(const e in this.controlData){const t=this.controlData[e];this.isMouseOverComponent(t)&&this.playerManager.firstPlayer._gamepad.setButtonsDown(t.keys)}}update(){let e=this.scene,t=e.state.paused;e.controls&&this.properties.visible!==t&&(this.properties.visible=t),super.update()}},de=class extends D{name="Brush";p1=null;p2=null;active=!1;options=null;constructor(e){super(e),this.p1=new s(0,0),this.p2=new s(0,0),this.active=!1;let t=e.scene.settings.brush;this.addedObjects=[],this.options={breakLength:t.breakLength,maxBreakLength:t.maxBreakLength,minBreakLength:t.minBreakLength,breakLengthSensitivity:t.breakLengthSensitivity,trailSpeed:t.trailSpeed,maxTrailSpeed:t.maxTrailSpeed,minTrailSpeed:t.minTrailSpeed,trailSpeedSensitivity:t.trailSpeedSensitivity}}reset(){this.recordActionsToToolhandler(),this.active=!1}recordActionsToToolhandler(){var e,t=this.addedObjects,s=t.length;if(s)for(e=0;s>e;e++)this.toolhandler.addActionToTimeline({type:"add",objects:[t[e]]});this.addedObjects=[]}press(){if(this.recordActionsToToolhandler(),!this.active){let e=this.mouse.touch.real;this.p1.x=e.x,this.p1.y=e.y,this.p2.x=e.x,this.p2.y=e.y,this.active=!0}}hold(){let e=this.mouse.touch.real,t=this.p1,s=this.p2,i=this.options.trailSpeed,o=this.options.breakLength;s.inc(e.sub(s).factor(i));let a=screen.height+e.sub(s).len();if(a*=o,s.sub(t).lenSqr()>a){let e=this.scene.track,i=!1;i="physics"===this.toolhandler.options.lineType?e.addPhysicsLine(t.x,t.y,s.x,s.y):e.addSceneryLine(t.x,t.y,s.x,s.y),i&&this.addedObjects.push(i),t.equ(s),this.toolhandler.snapPoint.x=s.x,this.toolhandler.snapPoint.y=s.y}this.toolhandler.moveCameraTowardsMouse()}release(){let e=this.p1,t=this.p2,s=this.scene.track,i=!1;i="physics"===this.toolhandler.options.lineType?s.addPhysicsLine(e.x,e.y,t.x,t.y):s.addSceneryLine(e.x,e.y,t.x,t.y),i&&this.addedObjects.push(i),this.recordActionsToToolhandler();let o=this.toolhandler.snapPoint;o.x=t.x,o.y=t.y,this.active=!1}update(){let e=this.toolhandler.gamepad,t=this.mouse;e.isButtonDown("alt")?!1!==t.mousewheel&&this.adjustTrailSpeed(t.mousewheel):e.isButtonDown("shift")&&!1!==t.mousewheel&&this.adjustBreakLength(t.mousewheel);let s=this.toolhandler;s.options.snap&&(this.active=!0,this.p1.x=s.snapPoint.x,this.p1.y=s.snapPoint.y,this.p2.x=t.touch.real.x,this.p2.y=t.touch.real.y),super.update()}adjustTrailSpeed(e){let t=this.options.trailSpeed,s=this.options.trailSpeedSensitivity,i=this.options.maxTrailSpeed,o=this.options.minTrailSpeed;e>0?(t+=s,t>i&&(t=i)):(t-=s,o>t&&(t=o)),this.setOption("trailSpeed",t)}adjustBreakLength(e){let t=this.options.breakLength,s=this.options.breakLengthSensitivity,i=this.options.maxBreakLength,o=this.options.minBreakLength;e>0?(t+=s,t>i&&(t=i)):(t-=s,o>t&&(t=o)),this.setOption("breakLength",t)}setOption(e,t){this.options[e]=t}getOptions(){let e=this.toolhandler,t=this.options;return t.lineType=e.options.lineType,t.snap=e.options.snap,t}draw(e){let t=this.scene.camera.zoom;this.drawCursor(e),this.active&&(this.drawLine(e,t),this.drawPoint(e,this.p1,t),this.drawPoint(e,this.p2,t))}drawText(e){let t=this.name,s=this.options.breakLength,i=this.options.trailSpeed,o=this.game.pixelRatio;e.fillStyle=/^(dark(er)?|midnight)$/i.test(lite.storage.get("theme"))?"#FBFBFB":"#000",e.font=12*o+"pt arial",e.fillText(t,10*o,20*o),e.font=8*o+"pt arial",i|=0,e.fillText("Trail speed : "+i,10*o,40*o),e.fillText("Break length : "+s,10*o,60*o)}drawCursor(e){let t=this.mouse.touch.real.toScreen(this.scene),s=this.camera.zoom,i=this.toolhandler.options.grid;if(e.beginPath(),i){let i=5*s;e.moveTo(t.x,t.y-i),e.lineTo(t.x,t.y+i),e.moveTo(t.x-i,t.y),e.lineTo(t.x+i,t.y),e.lineWidth=1*s,e.stroke()}else e.arc(t.x,t.y,1*s,0,2*Math.PI,!1),e.lineWidth=1,e.fillStyle="#1884cf",e.fill()}drawPoint(e,t,s){let i=t.toScreen(this.scene);e.beginPath(),e.arc(i.x,i.y,1*s,0,2*Math.PI,!1),e.lineWidth=1,e.fillStyle="#1884cf",e.fill()}drawLine(e,t){let s=this.toolhandler.options.lineType;e.beginPath(),e.lineWidth=Math.max(.5,2*t),e.lineCap="round",e.strokeStyle="#".padEnd(7,"physics"===s?/^midnight$/i.test(lite.storage.get("theme"))?"C":/^dark$/i.test(lite.storage.get("theme"))?"FB":"0":/^midnight$/i.test(lite.storage.get("theme"))?"8":/^dark$/i.test(lite.storage.get("theme"))?"6":"A");let i=this.p1.toScreen(this.scene),o=this.p2.toScreen(this.scene);e.moveTo(i.x,i.y),e.lineTo(o.x,o.y),e.stroke()}},ue=class extends D{name="Curve";active=!1;p1=null;p2=null;midpoint=null;anchoring=!1;options=null;constructor(e){super(e),this.p1=new s(0,0),this.p2=new s(0,0),this.midpoint=new s(0,0),this.active=!1,this.options={}}getOptions(){let e=this.toolhandler,t=this.options;return t.lineType=e.options.lineType,t.snap=e.options.snap,t}reset(){this.active=!1,this.anchoring=!1}press(){if(!this.active){this.active=!0;var e=this.mouse.touch.real;this.p1.x=e.x,this.p1.y=e.y}}hold(){let e=this.mouse.touch.real;this.p2.x=e.x,this.p2.y=e.y;let t=this.p1,s=this.p2;this.midpoint.x=(t.x+s.x)/2,this.midpoint.y=(t.y+s.y)/2,this.toolhandler.moveCameraTowardsMouse()}release(){let e=this.p1,t=this.p2,s=this.midpoint,i=this.toolhandler;if(this.anchoring){var o;if(s.x===t.x&&s.y===t.y)(o=this.scene.track["add"+("physics"===i.options.lineType?"Physics":"Scenery")+"Line"](e.x,e.y,t.x,t.y))&&i.addActionToTimeline({type:"add",objects:[o]}),i.snapPoint.x=t.x,i.snapPoint.y=t.y;else this.splitAndAddCurve();this.anchoring=!1,this.active=!1}else{var a=t.x-e.x,r=t.y-e.y;Math.sqrt(Math.pow(a,2)+Math.pow(r,2))>0?this.anchoring=!0:this.active=!1}}updateAnchor(){let e=this.mouse.touch.real;this.midpoint.x=e.x,this.midpoint.y=e.y}splitAndAddCurve(){for(var e=function(e,t,s){let i=e.x,o=e.y,a=t.x,r=t.y,n=s.x,h=s.y,l=[];return l.push(i,o),function e(t,s,i,o,a,r,n){if(!(n>10)){var h=(t+i)/2,c=(s+o)/2,p=(i+a)/2,d=(o+r)/2,u=(h+p)/2,m=(c+d)/2,g=a-t,y=r-s,w=Math.abs((i-a)*y-(o-r)*g);if(w>1e-30){if(.25*(g*g+y*y)>=w*w)return void l.push(u,m)}else if(.25>=(g=u-(t+a)/2)*g+(y=m-(s+r)/2)*y)return void l.push(u,m);e(t,s,h,c,u,m,n+1),e(u,m,p,d,a,r,n+1)}}(i,o,a,r,n,h,0),l.push(n,h),l}(this.p1,this.midpoint,this.p2),t=this.scene.track,s=e.length,i=this.toolhandler,o=[],a=0;s-2>a;a+=2){let s=e[a],r=e[a+1],n=e[a+2],h=e[a+3],l=t["add"+("physics"===i.options.lineType?"Physics":"Scenery")+"Line"](s,r,n,h);l&&o.push(l),i.snapPoint.x=n,i.snapPoint.y=h}o.length>0&&i.addActionToTimeline({type:"add",objects:o})}update(){var e=this.mouse,t=e.touch,s=e.secondaryTouch,i=this.toolhandler.gamepad,o=this.toolhandler;o.options.snap&&(this.active=!0,this.p1=o.snapPoint,this.anchoring||this.hold());var a=this.toolhandler.options,r=i.isButtonDown("shift");a.rightClickMove&&(r=s.old.down),r?(t.old.down||a.rightClickMove)&&this.moveCamera():(t.press&&!this.anchoring&&this.press(),t.old.down&&!this.anchoring&&this.hold(),t.release&&this.release(),this.anchoring&&this.updateAnchor()),!1!==e.mousewheel&&!1===i.isButtonDown("shift")&&this.mousewheel(e.mousewheel)}draw(e){let t=this.scene.camera.zoom;this.drawCursor(e,t),this.active&&(this.drawLine(e,t),this.drawPoint(e,this.p1,t),this.drawPoint(e,this.p2,t))}toScreen(e,t){let s=this.scene.camera,i=this.scene.screen;return(e-s.position[t])*s.zoom+i.center[t]}drawCursor(e,t){var s=this.mouse.touch.real.toScreen(this.scene),i=this.toolhandler.options.grid;if(e.beginPath(),i){let i=5*t;e.moveTo(s.x,s.y-i),e.lineTo(s.x,s.y+i),e.moveTo(s.x-i,s.y),e.lineTo(s.x+i,s.y),e.lineWidth=1*t,e.stroke()}else e.arc(s.x,s.y,1*t,0,2*Math.PI,!1),e.lineWidth=1,e.fillStyle="#1884cf",e.fill()}drawPoint(e,t,s){let i=t.toScreen(this.scene);e.beginPath(),e.arc(i.x,i.y,1*s,0,2*Math.PI,!1),e.lineWidth=1,e.fillStyle="#1884cf",e.fill()}drawText(e){let t=this.name,s=this.game.pixelRatio;e.fillStyle=/^(dark|midnight)$/i.test(lite.storage.get("theme"))?"#FBFBFB":"#000",e.font=12*s+"pt arial",e.fillText(t,10*s,20*s),e.font=8*s+"pt arial"}drawLine(e,t){let s=this.toolhandler.options.lineType;e.beginPath(),e.lineWidth=Math.max(.5,2*t),e.lineCap="round",e.strokeStyle="#".padEnd(7,"physics"===s?/^midnight$/i.test(lite.storage.get("theme"))?"C":/^dark$/i.test(lite.storage.get("theme"))?"FB":"0":/^midnight$/i.test(lite.storage.get("theme"))?"8":/^dark$/i.test(lite.storage.get("theme"))?"6":"A");let i=this.p1.toScreen(this.scene),o=this.p2.toScreen(this.scene),a=this.midpoint.toScreen(this.scene);e.moveTo(i.x,i.y),e.quadraticCurveTo(a.x,a.y,o.x,o.y),e.stroke()}},me=class extends D{name="Eraser";options=null;constructor(e){super(e),this.options=e.scene.settings.eraser,this.eraserPoint=new s,this.erasedObjects=[]}reset(){this.recordActionsToToolhandler()}press(){this.recordActionsToToolhandler()}recordActionsToToolhandler(){this.erasedObjects.length>0&&this.toolhandler.addActionToTimeline({type:"remove",objects:this.erasedObjects.flat()}),this.erasedObjects=[]}release(){this.recordActionsToToolhandler()}hold(){let e=this.mouse.touch.pos,t=this.scene.track,s=this.scene.screen,i=this.scene.camera,o=s.center,a=i.position,r=(e.x-o.x)/i.zoom+a.x,n=(e.y-o.y)/i.zoom+a.y;this.eraserPoint.x=Math.round(r),this.eraserPoint.y=Math.round(n);let h=t.erase(this.eraserPoint,this.options.radius/this.scene.camera.zoom,this.options.types);h.length>0&&this.erasedObjects.push(h)}draw(e){this.drawEraser(e)}drawEraser(e){let t=this.mouse.touch.pos,s=window.lite&&lite.storage.get("theme");e.save(),e.beginPath(),e.arc(t.x,t.y,this.options.radius,0,2*Math.PI,!1),e.lineWidth=1,e.fillStyle=/^midnight$/i.test(s)?"rgba(29,35,40,0.8)":/^dark$/i.test(s)?"rgba(33,33,33,0.8)":"rgba(255,255,255,0.8)",e.fill(),e.strokeStyle=this.scene.settings.physicsLineColor,e.stroke(),e.restore()}setOption(e,t){this.options[e]=t}getOptions(){return this.options}update(){let e=this.toolhandler.gamepad,t=this.mouse;e.isButtonDown("shift")&&!1!==t.mousewheel&&this.adjustRadius(t.mousewheel),super.update()}adjustRadius(e){let t=this.options.radius,s=this.options.radiusSizeSensitivity,i=this.options.maxRadius,o=this.options.minRadius;t+=e>0?s:-s,this.setOption("radius",Math.min(i,Math.max(o,t)))}},ge=class extends D{active=!1;name="powerup";p1=null;powerup=null;constructor(e){super(e),this.p1=new s(0,0)}draw(e){let t=this.mouse.touch,s=this.camera.zoom,i=this.scene.settings.device,o=this.scene.screen;if(!0===this.active){let t=o.realToScreen(this.p1.x,"x"),i=o.realToScreen(this.p1.y,"y");e.globalAlpha=.4,this.powerup.draw(t,i,s,e),e.globalAlpha=1}else if("desktop"===i){let i=o.realToScreen(t.real.x,"x"),a=o.realToScreen(t.real.y,"y");e.globalAlpha=.8,this.powerup.draw(i,a,s,e),e.globalAlpha=1}}press(){let e=this.mouse.touch.real;this.p1.x=e.x,this.p1.y=e.y,this.active=!0}release(){let e=this.scene.track,t=new this.powerup.constructor(this.p1.x,this.p1.y,e);e.addPowerup(t),this.active=!1,this.toolhandler.addActionToTimeline({type:"add",objects:[t]})}},ye=class extends ge{name="antigravity";constructor(e){super(e),this.powerup=new n(0,0,e.scene.track)}press(){let e=this.mouse.touch.real;this.p1.x=e.x,this.p1.y=e.y;let t=this.scene.track,s=new n(this.p1.x,this.p1.y,t);t.addPowerup(s),this.toolhandler.addActionToTimeline({type:"add",objects:[s]})}release(){}},we=class extends ge{name="bomb";constructor(e){super(e),this.powerup=new h(0,0,e.scene.track)}},fe=class extends ge{name="boost";p2=null;constructor(e){super(e),this.p2=new s(0,0),this.powerup=new l(0,0,0,e.scene.track)}press(){let e=this.mouse.touch.real;this.p1.x=e.x,this.p1.y=e.y,this.p2.x=e.x,this.p2.y=e.y,this.active=!0}hold(){let e=this.mouse.touch.real;this.p2.x=e.x,this.p2.y=e.y}release(){let e=this.scene.track,t=new l(this.p1.x,this.p1.y,this.powerup.angle,e);e.addPowerup(t),this.active=!1,this.toolhandler.addActionToTimeline({type:"add",objects:[t]})}draw(e){let t=this.mouse.touch,s=this.camera.zoom,i=this.scene.screen,o=this.scene.settings.device;if(!0===this.active){let t=i.realToScreen(this.p1.x,"x"),o=i.realToScreen(this.p1.y,"y"),a=this.p1,r=this.p2,n=a.y-r.y,h=a.x-r.x,l=Math.atan2(a.y-r.y,a.x-r.x);0===h&&0===n&&(l=Math.PI-Math.PI/2),0>l&&(l+=2*Math.PI),this.drawPathToMouse(e,l),this.powerup.angle=l*(180/Math.PI)-90|0,this.powerup.draw(t,o,s,e)}else if("desktop"===o){e.globalAlpha=.8,this.powerup.angle=0;let o=i.realToScreen(t.real.x,"x"),a=i.realToScreen(t.real.y,"y");this.powerup.draw(o,a,s,e),e.globalAlpha=1}}drawPathToMouse(e,t){let s=this.p1,i=this.p2,o=this.scene.screen,a=this.scene.camera.zoom,r=o.realToScreen(s.x,"x"),n=o.realToScreen(s.y,"y"),h=o.realToScreen(i.x,"x"),l=o.realToScreen(i.y,"y"),c=Math.sqrt(Math.pow(h-r,2)+Math.pow(l-n,2));30*a>c&&(c=30*a),e.strokeStyle="#ADCF7D",e.lineWidth=Math.max(1,2*a),e.beginPath(),e.moveTo(r+c,n),e.lineTo(r,n),e.lineTo(h,l),e.stroke();let p=t+Math.PI/180*180,d=Math.min(c,50*a);e.beginPath(),e.moveTo(r,n),e.arc(r,n,d,p,0,!1),e.stroke(),e.fillStyle="rgba(173, 207, 125,0.2)",e.fill()}},xe=class extends ge{name="checkpoint";constructor(e){super(e),this.powerup=new c(0,0,e.scene.track)}},ve=class extends ge{name="goal";constructor(e){super(e),this.powerup=new u(0,0,e.scene.track)}release(){this.scene.track.addTarget(e),super.release()}},be=class extends ge{name="gravity";p2=null;constructor(e){super(e),this.p2=new s(0,0),this.powerup=new p(0,0,0,e.scene.track)}press(){let e=this.mouse.touch.real;this.p1.x=e.x,this.p1.y=e.y,this.p2.x=e.x,this.p2.y=e.y,this.active=!0}hold(){let e=this.mouse.touch.real;this.p2.x=e.x,this.p2.y=e.y}release(){let e=this.scene.track,t=new p(this.p1.x,this.p1.y,this.powerup.angle-180,e);e.addPowerup(t),this.active=!1,this.toolhandler.addActionToTimeline({type:"add",objects:[t]})}draw(e){var t=this.mouse.touch,s=(t.pos,this.camera.zoom),i=this.scene.screen,o=this.scene.settings.device;if(!0===this.active){var a=i.realToScreen(this.p1.x,"x"),r=i.realToScreen(this.p1.y,"y"),n=this.p1,h=this.p2,l=n.y-h.y,c=n.x-h.x,p=Math.atan2(n.y-h.y,n.x-h.x);0===c&&0===l&&(p=Math.PI-Math.PI/2),0>p&&(p+=2*Math.PI),this.drawPathToMouse(e,p),this.powerup.angle=p*(180/Math.PI)+90|0,this.powerup.draw(a,r,s,e)}else"desktop"===o&&(e.globalAlpha=.8,this.powerup.angle=180,a=i.realToScreen(t.real.x,"x"),r=i.realToScreen(t.real.y,"y"),this.powerup.draw(a,r,s,e),e.globalAlpha=1)}drawPathToMouse(e,t){let s=this.p1,i=this.p2,o=this.scene.screen,a=this.scene.camera.zoom,r=o.realToScreen(s.x,"x"),n=o.realToScreen(s.y,"y"),h=o.realToScreen(i.x,"x"),l=o.realToScreen(i.y,"y"),c=Math.sqrt(Math.pow(h-r,2)+Math.pow(l-n,2));30*a>c&&(c=30*a),e.strokeStyle="#A2B7D2",e.lineWidth=Math.max(1,2*a),e.beginPath(),e.moveTo(r+c,n),e.lineTo(r,n),e.lineTo(h,l),e.stroke();let p=t+Math.PI/180*180,d=Math.min(c,50*a);e.beginPath(),e.moveTo(r,n),e.arc(r,n,d,p,0,!1),e.stroke(),e.fillStyle="rgba(162, 183, 210,0.2)",e.fill()}},ke=class extends ge{name="slowmo";constructor(e){super(e),this.powerup=new d(0,0,e.scene.track)}},Te=class extends ge{name="teleport";p2=null;constructor(e){super(e),this.p2=new s(0,0),this.powerup=new m(0,0,e.scene.track)}press(){super.press(),this.portal1=new m(this.p1.x,this.p1.y,this.scene.track)}hold(){let e=this.mouse.touch.real;this.p2.x=e.x,this.p2.y=e.y}release(){let e=Math.abs(this.p2.x-this.p1.x),t=Math.abs(this.p2.y-this.p1.y);if(e>40||t>40){let e=this.scene.track;this.portal2=new m(this.p2.x,this.p2.y,e),this.portal1.addOtherPortalRef(this.portal2),this.portal2.addOtherPortalRef(this.portal1),e.addPowerup(this.portal1),e.addPowerup(this.portal2),this.toolhandler.addActionToTimeline({type:"add",objects:[this.portal1,this.portal2]})}else this.portal1=null;this.active=!1}draw(e){let t=this.mouse.touch,s=this.camera.zoom,i=this.scene.screen,o=this.scene.settings.device;if(!0===this.active){let t=i.realToScreen(this.p1.x,"x"),o=i.realToScreen(this.p1.y,"y"),a=i.realToScreen(this.p2.x,"x"),r=i.realToScreen(this.p2.y,"y"),n=this.p1,h=this.p2,l=n.y-h.y,c=n.x-h.x,p=Math.atan2(n.y-h.y,n.x-h.x);0===c&&0===l&&(p=Math.PI-Math.PI/2),0>p&&(p+=2*Math.PI),this.drawPathToMouse(e,p),this.portal1.draw(t,o,s,e),this.powerup.draw(a,r,s,e)}else if("desktop"===o){e.globalAlpha=.8;let o=i.realToScreen(t.real.x,"x"),a=i.realToScreen(t.real.y,"y");this.powerup.draw(o,a,s,e),e.globalAlpha=1}}drawPathToMouse(e){let t=this.p1,s=this.p2,i=this.scene.screen,o=this.scene.camera.zoom,a=i.realToScreen(t.x,"x"),r=i.realToScreen(t.y,"y"),n=i.realToScreen(s.x,"x"),h=i.realToScreen(s.y,"y"),l=Math.sqrt(Math.pow(n-a,2)+Math.pow(h-r,2));30*o>l&&(l=30*o),e.strokeStyle="#dd45ec",e.lineWidth=Math.max(1,2*o),e.beginPath(),e.moveTo(a,r),e.lineTo(n,h),e.stroke(),e.closePath()}},Se=class extends D{name="Powerup";options={selected:"goal"};powerupTools={};constructor(e){super(e),this.registerPowerupTools()}registerPowerupTools(){this.registerTool(new ve(this.toolhandler)),this.registerTool(new fe(this.toolhandler)),this.registerTool(new be(this.toolhandler)),this.registerTool(new ke(this.toolhandler)),this.registerTool(new we(this.toolhandler)),this.registerTool(new xe(this.toolhandler)),this.registerTool(new ye(this.toolhandler)),this.registerTool(new Te(this.toolhandler))}registerTool(e){this.powerupTools[e.name]=e}setOption(e,t){this.options[e]=t}getOptions(){return this.options}update(){let e=this.toolhandler.gamepad,t=this.options;e.isButtonDown("opt1")&&(t.selected="goal",e.setButtonUp("opt1"),this.scene.stateChanged()),e.isButtonDown("opt2")&&(t.selected="boost",e.setButtonUp("opt2"),this.scene.stateChanged()),e.isButtonDown("opt3")&&(t.selected="gravity",e.setButtonUp("opt3"),this.scene.stateChanged()),e.isButtonDown("opt4")&&(t.selected="slowmo",e.setButtonUp("opt4"),this.scene.stateChanged()),e.isButtonDown("opt5")&&(t.selected="bomb",e.setButtonUp("opt5"),this.scene.stateChanged()),e.isButtonDown("opt6")&&(t.selected="checkpoint",e.setButtonUp("opt6"),this.scene.stateChanged()),e.isButtonDown("opt7")&&(t.selected="antigravity",e.setButtonUp("opt7"),this.scene.stateChanged()),e.isButtonDown("opt8")&&Application.User.get("classic")&&(t.selected="teleport",e.setButtonUp("opt8"),this.scene.stateChanged()),super.update()}press(){let e=this.options.selected;this.powerupTools[e].press()}hold(){let e=this.options.selected;this.powerupTools[e].hold()}release(){let e=this.options.selected;this.powerupTools[e].release()}draw(e){this.powerupTools[this.options.selected].draw(e)}},Pe=class{start=null;end=null;verticies=[];build(e){let t=e.pop();this.start=t.p1,this.end=t.p2,this.verticies.push(t);for(let t=e.length-1;t>=0;t--){let s=e[t],i=s.p1,o=s.p2;this.start.x===o.x&&this.start.y===o.y?(this.verticies.unshift(s),this.start=s.p1,e.splice(t,1)):this.end.x===i.x&&this.end.y===i.y&&(this.verticies.push(s),this.end=s.p2,e.splice(t,1))}}},_e=class extends D{name="Select";passive=!1;active=!1;dashOffset=0;p1=null;p2=null;travelDistance=1;addedObjects=[];selectedElements=[];selectedSegments=[];constructor(e){super(e),this.p1=new s(0,0),this.p2=new s(0,0)}press(){let e=this.mouse.touch.real;this.passive=!1,this.active=!0,this.p1.x=e.x,this.p1.y=e.y,this.p2.x=e.x,this.p2.y=e.y}hold(){let e=this.mouse.touch.real;this.p2.x=e.x,this.p2.y=e.y}unselectElements(){this.selectedElements=[],this.selectedSegments=[]}moveSelected(e){for(let t in this.selectedSegments)this.selectedSegments.find((t=>t.otherPortal==e))?this.selectedSegments.splice(t,1):(this.selectedSegments[t]=this.selectedSegments[t].move("ArrowLeft"==e?-this.travelDistance:"ArrowRight"==e?this.travelDistance:0,"ArrowUp"==e?-this.travelDistance:"ArrowDown"==e?this.travelDistance:0),this.scene.track.undraw())}fillSelected(){if(this.p1.y<this.p2.y)for(let e=this.p1.y;e<this.p2.y;e++)this.selectedSegments.push(this.scene.track.addPhysicsLine(this.p1.x,e,this.p2.x,e));else for(let e=this.p2.y;e<this.p1.y;e++)this.selectedSegments.push(this.scene.track.addPhysicsLine(this.p2.x,e,this.p1.x,e));this.selectedElements.push(...this.selectedSegments),this.selectedSegments.length>0&&this.toolhandler.addActionToTimeline({type:"add",objects:this.selectedSegments.flat()})}rotateSelected(){const e=(this.travelDistance||0)*Math.PI/180;let t=this.selectedSegments;this.selectedSegments=[];for(const s of t)s.p2&&!s.name&&(this.selectedSegments.push(this.scene.track["physics"==s.type?"addPhysicsLine":"addSceneryLine"](Math.cos(e)*s.p1.x+Math.sin(e)*s.p1.y,-Math.sin(e)*s.p1.x+Math.cos(e)*s.p1.y,Math.cos(e)*s.p2.x+Math.sin(e)*s.p2.y,-Math.sin(e)*s.p2.x+Math.cos(e)*s.p2.y)),s.removeAllReferences())}copyAndPasteSelected(){for(let e of this.selectedSegments.filter((e=>"physics"==e.type||"scenery"==e.type)))this.scene.track["add"+("physics"==e.type?"Physics":"Scenery")+"Line"](e.p1.x,e.p1.y,e.p2.x,e.p2.y)}release(){this.unselectElements();for(const e of this.scene.track.select(this.p1,this.p2))this.intersectsLine(e.x?e:e.p1,e.x?e:e.p2)&&this.selectedSegments.push(e);this.selectedElements=this.selectedSegments,this.active=!1,this.passive=!0,document.onkeydown=e=>{switch(e.preventDefault(),e.key){case"=":case"+":this.travelDistance++,this.scene.message.show("Increased travel distance for the Select Tool - "+this.travelDistance,!1,"#000","#FFF");break;case"-":this.travelDistance--,this.scene.message.show("Decreased travel distance for the Select Tool - "+this.travelDistance,!1,"#000","#FFF");break;case"c":this.copyAndPasteSelected(e.key),this.scene.message.show("Copied selected area",!1,"#000000","#FFFFFF");break;case"Delete":this.selectedElements.length>0&&this.toolhandler.addActionToTimeline({type:"remove",objects:this.selectedElements.flatMap((e=>e))});for(const e of this.selectedElements)e.removeAllReferences();this.reset(),this.scene.message.show("Deleted selected area",!1,"#000","#FFF");break;case"f":confirm("Are you sure you would you like to fill the selected area?")&&(this.fillSelected(),this.scene.message.show("Filled selected area",!1,"#000","#FFF"));break;case"r":this.rotateSelected(),this.scene.message.show("Rotated selected area",!1,"#000","#FFF");break;case"ArrowUp":case"ArrowDown":case"ArrowLeft":case"ArrowRight":this.moveSelected(e.key),this.scene.message.show("Moved Selected Area",!1,"#000","#FFF");break;case"`":case"Escape":this.reset()}this.timeout=setTimeout((()=>this.scene.message.hide()),1e3)}}buildPaths(e){for(let t=[];e.length>0;){let s=new Pe;s.build(e),t.push(s)}}intersectsLine(e,t){let s=Math.min(this.p1.y,this.p2.y),i=Math.min(this.p1.x,this.p2.x),o=Math.max(this.p1.y,this.p2.y),a=Math.max(this.p1.x,this.p2.x),r=Math.abs(a-i),n=Math.abs(s-o),h=e.x,l=t.x;if(e.x>t.x&&(h=t.x,l=e.x),l>i+r&&(l=i+r),i>h&&(h=i),h>l)return!1;let c=e.y,p=t.y,d=t.x-e.x;if(Math.abs(d)>1e-7){let s=(t.y-e.y)/d,i=e.y-s*e.x;c=s*h+i,p=s*l+i}return c>p&&([p,c]=[c,p]),p>s+n&&(p=s+n),s>c&&(c=s),!(c>p)}toScreen(e,t){let s=this.scene.camera,i=this.scene.screen;return(e-s.position[t])*s.zoom+i.center[t]}draw(e){let t=this.scene;if(this.active||this.passive){let s=this.p1.toScreen(t),i=this.p2.toScreen(t),o=i.x-s.x,a=i.y-s.y;e.save(),this.active?(e.beginPath(),e.rect(s.x,s.y,o,a),e.fillStyle="rgba(24, 132, 207, 0.2)",e.fill(),e.lineWidth=2,e.strokeStyle="rgba(24, 132, 207, 0.7)",e.stroke()):this.passive&&(e.strokeStyle="rgba(24, 132, 207, 0.7)",e.lineWidth=2,e.strokeRect(s.x,s.y,o,a)),e.restore()}}reset(){this.p1.x=0,this.p1.y=0,this.p2.x=0,this.p2.y=0,this.active=!1,this.passive=!1,this.unselectElements()}close(){this.dashOffset=0,this.selectedElements=null,this.mouse=null,this.camera=null,this.scene=null,this.toolHandler=null,this.p2=null,this.p1=null,this.active=!1,this.passive=!1}},Ce=class extends D{name="StraightLine";p1=null;p2=null;active=!1;constructor(e){super(e),this.p1=new s(0,0),this.p2=new s(0,0),this.active=!1,this.shouldDrawMetadata=!1,this.options={}}reset(){this.active=!1}press(){if(!this.active){let e=this.mouse.touch.real;this.p1.x=e.x,this.p1.y=e.y,this.active=!0}}getOptions(){let e=this.toolhandler,t=this.options;return t.lineType=e.options.lineType,t.snap=e.options.snap,t}hold(){let e=this.mouse.touch.real;this.p2.x=e.x,this.p2.y=e.y,this.toolhandler.moveCameraTowardsMouse()}release(){let e=this.p1,t=this.p2,s=this.scene.track,i=this.toolhandler,o=!1;o="physics"===i.options.lineType?s.addPhysicsLine(e.x,e.y,t.x,t.y):s.addSceneryLine(e.x,e.y,t.x,t.y),o&&i.addActionToTimeline({type:"add",objects:[o]});let a=i.snapPoint;a.x=t.x,a.y=t.y,this.active=!1}update(){super.update();let e=this.toolhandler,t=e.gamepad;e.options.snap&&(this.active=!0,this.p1=e.snapPoint,this.hold()),this.shouldDrawMetadata=!!t.isButtonDown("ctrl")}draw(e){let t=this.scene.camera.zoom;e.save(),this.drawCursor(e),this.active&&(this.drawLine(e,t),this.drawPoint(e,this.p1,t),this.drawPoint(e,this.p2,t),this.drawPointData(e,this.p2,t)),e.restore()}drawCursor(e){let t=this.mouse.touch.real.toScreen(this.scene),s=this.camera.zoom,i=this.toolhandler.options.grid;if(e.beginPath(),i){let i=5*s;e.moveTo(t.x,t.y-i),e.lineTo(t.x,t.y+i),e.moveTo(t.x-i,t.y),e.lineTo(t.x+i,t.y),e.lineWidth=1*s,e.closePath(),e.stroke()}else e.lineWidth=1,e.fillStyle="#1884cf",e.arc(t.x,t.y,1*s,0,2*Math.PI,!1),e.closePath(),e.fill()}drawPoint(e,t,s){let i=t.toScreen(this.scene);e.beginPath(),e.arc(i.x,i.y,1*s,0,2*Math.PI,!1),e.lineWidth=1,e.fillStyle="#1884cf",e.fill()}drawPointData(e,t){let s=t.toScreen(this.scene);if(this.shouldDrawMetadata){let t=this.p1.getAngleInDegrees(this.p2);t=t.toFixed(2);let i=this.game.pixelRatio;e.fillStyle=/^midnight$/i.test(lite.storage.get("theme"))?"C":/^dark$/i.test(lite.storage.get("theme"))?"FB":"0",e.font=8*i+"pt arial",e.fillText(t+"Â°",s.x+10,s.y+10),e.strokeText(t+"Â°",s.x+10,s.y+10)}}drawLine(e,t){let s=this.toolhandler.options.lineType;e.beginPath(),e.lineWidth=Math.max(.5,2*t),e.lineCap="round",e.strokeStyle="#".padEnd(7,"physics"===s?/^midnight$/i.test(lite.storage.get("theme"))?"C":/^dark$/i.test(lite.storage.get("theme"))?"FB":"0":/^midnight$/i.test(lite.storage.get("theme"))?"8":/^dark$/i.test(lite.storage.get("theme"))?"6":"A");let i=this.p1.toScreen(this.scene),o=this.p2.toScreen(this.scene);e.moveTo(i.x,i.y),e.lineTo(o.x,o.y),e.stroke()}},Me=class extends ge{name="vehiclepowerup";options=null;constructor(e,t){super(t),this.options=e.options}release(){let e=this.scene.track,t=new this.powerup.constructor(this.p1.x,this.p1.y,this.options.time,e);e.addPowerup(t),this.active=!1,this.toolhandler.addActionToTimeline({type:"add",objects:[t]})}},ze=class extends Me{name="balloon";constructor(e,t){super(e,t),this.powerup=new w(0,0,0,t.scene.track)}},Ae=class extends Me{name="blob";constructor(e,t){super(e,t),this.powerup=new f(0,0,0,t.scene.track)}},De=class extends Me{name="helicopter";constructor(e,t){super(e,t),this.powerup=new x(0,0,0,t.scene.track)}},Le=class extends Me{name="truck";constructor(e,t){super(e,t),this.powerup=new v(0,0,0,t.scene.track)}},Be=class extends D{name="vehiclepowerup";powerupTools={};constructor(e){super(e),this.options=e.scene.settings.vehiclePowerup,this.registerPowerupTools()}registerPowerupTools(){this.registerTool(new De(this,this.toolhandler)),this.registerTool(new Le(this,this.toolhandler)),this.registerTool(new ze(this,this.toolhandler)),this.registerTool(new Ae(this,this.toolhandler))}registerTool(e){this.powerupTools[e.name]=e}setOption(e,t){this.options[e]=t}getOptions(){return this.options}press(){let e=this.options.selected;this.powerupTools[e].press()}hold(){let e=this.options.selected;this.powerupTools[e].hold()}release(){let e=this.options.selected;this.powerupTools[e].release()}draw(e){this.powerupTools[this.options.selected].draw(e)}},Oe=class extends he{clear=!1;redoundoControls=null;verified=!1;constructor(e){super(e),this.mouse.disableContextMenu(),this.createMainPlayer(),this.createControls(),this.registerTools(),this.state=this.setStateDefaults(),this.oldState=this.setStateDefaults(),this.restart(),this.initializeAnalytics()}createMainPlayer(){super.createMainPlayer().setKeyMap(this.settings.editorHotkeys)}createTrack(){let e=super.createTrack(),t=this.getAvailableTrackCode();0!=t?(e.read(t),this.state.preloading=!1,this.state.loading=!1):e.addDefaultLine(),this.importCode=!1,this.restartTrack=!0,this.clear=!1}getCanvasOffset(){return{height:this.settings.isStandalone?202:90,width:0}}initializeAnalytics(){this.analytics={deaths:0,mouseEvents:0},this.trackAction("editor-open","open")}createControls(){this.redoundoControls=new pe(this),this.pauseControls=new ce(this)}registerTools(){let e=super.registerTools();e.enableGridUse(),e.registerTool(ue),e.registerTool(Ce),e.registerTool(de),e.registerTool(_e),e.registerTool(me),e.registerTool(Se),e.registerTool(Be),e.setTool(this.settings.startTool)}play(){this.state.playing=!0}interactWithControls(){super.interactWithControls(),this.redoundoControls.click()}updateControls(){super.updateControls(),this.redoundoControls.update()}fixedUpdate(){this.updateToolHandler(),this.mouse.update(),this.state.showDialog||(this.playerManager.updateGamepads(),this.playerManager.checkKeys()),super.fixedUpdate(),(this.importCode||this.clear)&&this.createTrack()}draw(e){super.draw(...arguments),this.redoundoControls.draw(e)}restart(){this.verified=!this.settings.requireTrackVerification,this.track.dirty=!1,this.track.resetPowerups(),this.message.hide(),this.restartTrack=!1,this.state.playing=!1,this.ticks=0,this.playerManager.reset(),this.camera.focusOnPlayer(),this.camera.fastforward(),this.score.update()}buttonDown(e){let t=this.camera;switch(this.state.playing=!0,e){case"up":case"down":case"left":case"right":t.focusOnMainPlayer();break;case"change_camera":t.focusOnNextPlayer();break;case"pause":this.state.paused=!this.state.paused;break;case"settings":this.command("dialog","settings");break;case"change_vehicle":this.toggleVehicle(),this.stateChanged();break;case"zoom_increase":t.increaseZoom(),this.stateChanged();break;case"zoom_decrease":t.decreaseZoom(),this.stateChanged();break;case"fullscreen":this.toggleFullscreen(),this.stateChanged()}}resize(){this.pauseControls.resize(),this.redoundoControls.resize(),super.resize()}updateState(){if(null!==this.game.onStateChange){let e=this.state;e.tool=this.toolHandler.currentTool,e.toolOptions=this.toolHandler.getToolOptions(),e.grid=this.toolHandler.options.grid,e.cameraLocked=this.toolHandler.options.cameraLocked,e.zoomPercentage=this.camera.zoomPercentage,e.vehicle=this.vehicle,this.game.onStateChange(this.state)}}setStateDefaults(){let e=super.setStateDefaults();return e.paused=!!this.settings.mobile||this.settings.startPaused,e.loading=!1,e.preloading=!1,e.tool=this.toolHandler.currentTool,e.toolOptions=this.toolHandler.getToolOptions(),e.grid=this.toolHandler.options.grid,e.cameraLocked=this.toolHandler.options.cameraLocked,e.zoomPercentage=this.camera.zoomPercentage,e.vehicle=this.vehicle,this.controls&&(e.hideMenus=this.controls.isVisible()),e}trackAction(e,t){var s={category:"create",action:e,label:t,value:this.toolHandler.analytics.actions+this.mouse.analytics.clicks,non_interaction:!0};Application.Helpers.GoogleAnalyticsHelper.track_event(s)}openDialog(e){switch(this.state.dialogOptions={},e){case"import":break;case"export":setTimeout(this.getTrackCode.bind(this),750);break;case"upload":"undefined"==typeof isChromeApp&&setTimeout(this.getTrackCode.bind(this),750)}super.openDialog(e)}getTrackCode(){this.state.dialogOptions={},this.state.dialogOptions.verified=this.verified,this.state.dialogOptions.code=this.track.getCode()}trackComplete(){this.verified=!this.track.dirty}hideControlPlanel(){}showControlPlanel(){}command(){let e=Array.prototype.slice.call(arguments,0);switch(e.shift()){case"change tool":let t=e[0];this.toolHandler.setTool(t);break;case"change tool option":let s=e[0],i=e[1];void 0!==e[2]?this.toolHandler.setToolOption(s,i,e[2]):this.toolHandler.setToolOption(s,i);break;case"snap":this.toolHandler.toggleSnap();break;case"redraw":this.redraw();break;case"fullscreen":this.settings.fullscreen=this.state.fullscreen=!this.settings.fullscreen;break;case"grid":this.toolHandler.toggleGrid();break;case"lock camera":this.toolHandler.toggleCameraLock();break;case"toggle vehicle":this.toggleVehicle(),this.stateChanged();break;case"reset zoom":this.camera.resetZoom();break;case"increase zoom":this.camera.increaseZoom();break;case"decrease zoom":this.camera.decreaseZoom();break;case"change lineType":let o=e[0];this.toolHandler.options.lineType=o,this.stateChanged();break;case"clear track":this.trackAction("editor-action","clear"),this.clear=!0;break;case"import":let a=e[0];a.length<=0&&(a=!1),this.importCode=a,this.clear=e[1],this.command("dialog",!1)}super.command(...arguments)}close(){this.trackAction("editor-exit","exit"),super.close()}},Ie=class extends le{name="fullscreen_controls";fullscreen=!1;controlsSpriteSheetData={exit_fullscreen_btn:[230,2,76,76],fullscreen_btn:[78,2,76,76]};controlData={fullscreen:{top:60,right:150,key:"fullscreen",alpha:.5,width:76,height:76}};constructor(){super(...arguments),this.init(...arguments)}click(e=Object.values(this.controlData).find(this.isMouseOverComponent.bind(this))){for(const e in this.controlData){const t=this.controlData[e];this.isMouseOverComponent(t)&&this.scene.buttonDown(t.key)}}update(){let e=this.scene.settings.fullscreen;this.fullscreen!==e&&(this.controlData.fullscreen.image=e?"exit_fullscreen":"fullscreen",this.fullscreen=e),super.update()}},Fe=class extends le{name="settings_controls";controlsSpriteSheetData={settings_btn:[78,2,76,76]};controlData={settings:{top:60,right:230,key:"settings",alpha:.5,width:76,height:76}};constructor(e){super(...arguments),this.init(...arguments)}click(){for(const e in this.controlData){const t=this.controlData[e];this.isMouseOverComponent(t)&&this.scene.buttonDown(t.key)}}},Ee=class{scene=null;sprite=null;cached=!1;container={children:[],color:"#000",font:30*window.devicePixelRatio/2.5,x:0,y:80*window.devicePixelRatio/2.5,scaleX:window.devicePixelRatio/2.5,scaleY:window.devicePixelRatio/2.5};spriteSheet={bronze_medal:[548,68,44,44],center_panel:[2,68,452,56],silver_medal:[502,68,44,44],left_panel:[2,2,588,64],gold_medal:[456,68,44,44]};bronze_container={alpha:.4,image:"bronze_medal",x:16,y:7};silver_container={alpha:.4,image:"silver_medal",x:175,y:7};gold_container={alpha:.4,image:"gold_medal",x:350,y:7};constructor(e){this.scene=e,this.settings=e.settings;let{goals:t}=e.settings.campaignData;this.bronze_container.text=t.third,this.silver_container.text=t.second,this.gold_container.text=t.first,this.container.children.push(this.bronze_container),this.container.children.push(this.silver_container),this.container.children.push(this.gold_container),this.sprite=this.scene.assets.getResult("campaign_icons"),this.update_state()}update_state(){switch(this.settings.campaignData.user.has_goal){case 1:case"first":this.gold_container.alpha=1;case 2:case"second":this.silver_container.alpha=1;case 3:case"third":this.bronze_container.alpha=1}}center_container(){let e=this.scene.screen,t=this.container,s=t.children.reduce(((e,t)=>e+t.width),0);t.x=e.width/2-s/2*window.devicePixelRatio,t.y=40*window.devicePixelRatio}draw(e){e.save(),e.fillStyle=this.container.color,e.font=this.container.font+"px helsinki",e.textBaseline="middle";for(const t of this.container.children){let s=this.spriteSheet[t.image],i=this.container.x+t.x*this.container.scaleX,o=this.container.y+t.y*this.container.scaleY;e.drawImage(this.sprite,...s,i,o,s[2]*this.container.scaleX,s[3]*this.container.scaleY),e.globalAlpha=t.alpha;let a=e.measureText(t.text);t.width=s[2]+a.width,t.height=s[3]+a.actualBoundingBoxAscent+a.actualBoundingBoxDescent,e.fillText(t.text,i+s[2]*this.container.scaleX+a.width/2+8*this.container.scaleX,o+s[3]/2*this.container.scaleY)}e.restore()}update(){this.settings.mobile&&this.center_container(),this.update_state()}},Re=class{raceCount=0;highlightedRace=null;raceOpacity=.3;raceYOffset=50;mobileRaceXOffset=180;maxRaces=10;container={children:[],color:"#000",font:25,x:15,y:80,visible:!0,get scale(){return window.devicePixelRatio/2.5}};constructor(e){this.scene=e,this.scene.game.settings.isCampaign&&(this.container.y+=60),this.maxRaces=this.scene.settings.mobile?3:10}get raceList(){return this.container.children}clear(){this.container.children.splice(0),this.raceCount=0}centerContainer(){let e=this.scene,t=e.screen,s=this.container,i=s.children.reduce(((e,t)=>e+160),0),o=this.scene.game.pixelRatio;s.x=t.width/2-i/2*s.scale,e.settings.isCampaign&&(s.visible=!1),s.y=40*o}addRace(e,t){if(this.raceCount<this.maxRaces){let s=this.scene,i=e.user,o=e.race,a=s.settings,r=a.drawFPS,n={alpha:this.raceOpacity,children:[],color:i.color,initial:i.d_name.charAt(0).toUpperCase(),runTime:_(parseInt(o.run_ticks)/r*1e3),x:25,y:25};a.mobile?n.x=t*this.mobileRaceXOffset:n.y=t*this.raceYOffset,this.container.children.push(n),this.raceCount++}}draw(e){if(this.raceCount>0){e.save(),e.textAlign="center",e.textBaseline="middle";for(const t in this.container.children){const s=this.container.children[t];e.globalAlpha=s.alpha,e.fillStyle=s.color,e.beginPath(),e.arc((this.container.x+s.x)*this.container.scale,(this.container.y+s.y+20)*this.container.scale,20*this.container.scale,0,2*Math.PI),e.fill(),e.fillStyle=this.container.color,e.font=this.container.font*this.container.scale+"px helsinki",e.fillText(s.initial,(this.container.x+s.x)*this.container.scale,(this.container.y+s.y+20)*this.container.scale),e.font=(this.container.font+5)*this.container.scale+"px helsinki";let i=e.measureText(s.runTime);s.width=20+i.width,s.height=20+i.actualBoundingBoxAscent+i.actualBoundingBoxDescent,e.fillText(s.runTime,(this.container.x+s.x+20+9)*this.container.scale+i.width/2,(this.container.y+s.y+20)*this.container.scale)}e.restore()}}update(){if(this.raceCount>0){let e=this.scene.camera;e.focusIndex>0&&e.focusIndex<this.maxRaces?this.highlightRace(e.focusIndex-1):this.unhighlightRace(),this.scene.settings.mobile&&this.centerContainer()}}highlightRace(e){if(this.highlightedRace!==this.raceList[e]){this.unhighlightRace();let t=this.raceList[e];t.alpha=1,this.highlightedRace=t}}unhighlightRace(){this.highlightedRace&&(this.highlightedRace.alpha=this.raceOpacity,this.highlightedRace=null)}},We=class extends he{races=[];playing=!1;ready=!1;loading=!1;fullscreenControls=null;settingsControls=null;constructor(e){super(e),this.raceTimes=new Re(this),this.settings.isCampaign&&(this.campaignScore=new Ee(this)),this.setStartingVehicle(),this.state=this.setStateDefaults(),this.oldState=this.setStateDefaults(),this.createMainPlayer(),this.createControls(),this.registerTools(),this.setStartingVehicle(),this.restart(),this.initializeAnalytics()}getCanvasOffset(){return{height:0,width:0}}initializeAnalytics(){this.analytics={deaths:0}}createMainPlayer(){let e=super.createMainPlayer();e.setKeyMap(this.settings.playHotkeys),e.recordKeys(this.settings.keysToRecord)}createControls(){this.pauseControls=new ce(this),this.settings.fullscreenAvailable&&(this.fullscreenControls=new Ie(this)),this.settingsControls=new Fe(this)}createTrack(){let e=super.createTrack(),t=this.getAvailableTrackCode();0!=t&&(e.read(t),this.setTrackAllowedVehicles(),this.state.preloading=!1,this.loading=!1,this.restartTrack=!0,this.ready=!0)}play(){this.state.playing||(this.state.playing=!0,this.hideControlPlanel())}buttonDown(e){if(!this.state.showDialog){let t=this.camera;switch(e){case"change_camera":t.focusOnNextPlayer();break;case"pause":this.state.paused=!this.state.paused;break;case"settings":this.openDialog("settings");break;case"exit_fullscreen":this.exitFullscreen();break;case"change_vehicle":this.toggleVehicle();break;case"zoom_increase":t.increaseZoom();break;case"zoom_decrease":t.decreaseZoom();break;case"fullscreen":this.toggleFullscreen()}}}exitFullscreen(){this.settings.fullscreenAvailable&&(this.settings.fullscreen=!1,this.state.fullscreen=!1,this.trackEvent("game-ui","game-fullscreen-toggle","game-out-fullscreen"))}toggleFullscreen(){super.toggleFullscreen()&&this.trackEvent("game-ui","game-fullscreen-toggle",this.settings.fullscreen?"game-into-fullscreen":"game-out-fullscreen")}trackEvent(e,t,s){Application.Helpers.GoogleAnalyticsHelper.track_event({category:e,action:t,label:s,value:0,non_interaction:!0})}setTrackAllowedVehicles(){let e=this.track,t=this.settings.track;t&&(e.allowedVehicles=t.vehicles)}interactWithControls(){super.interactWithControls(),this.settings.fullscreenAvailable&&this.fullscreenControls.click(),this.settingsControls.click()}updateControls(){super.updateControls(),this.settings.fullscreenAvailable&&this.fullscreenControls.update(),this.settingsControls.update()}registerTools(){super.registerTools().setTool("Camera")}fixedUpdate(){this.ready?(this.updateToolHandler(),this.mouse.update(),this.state.paused||this.state.showDialog||(this.playerManager.updateGamepads(),this.playerManager.checkKeys()),super.fixedUpdate(),this.updateScore()):this.importCode&&this.createTrack()}draw(e){super.draw(...arguments),this.settings.fullscreenAvailable&&this.fullscreenControls.draw(e),this.settingsControls.draw(e),this.campaignScore&&this.campaignScore.draw(e),this.raceTimes.draw(e)}isStateDirty(){let e=this.state;return e.fullscreen!=GameSettings.fullscreen&&(e.fullscreen=GameSettings.fullscreen),super.isStateDirty()}updateScore(){this.campaignScore&&this.campaignScore.update(),this.raceTimes.update()}restart(){this.settings.mobile?this.message.show("Press Any Button To Start",1,"#333333"):this.message.show("Press Any Key To Start",1,"#333333","#FFFFFF"),this.track.resetPowerups(),this.restartTrack=!1,this.state.paused=!1,this.state.playing=!this.settings.waitForKeyPress,this.ticks=0,this.playerManager.reset(),this.playerManager.getPlayerCount()>0&&(this.camera.focusIndex=1),this.camera.focusOnPlayer(),this.camera.fastforward(),this.showControlPlanel("main")}setStartingVehicle(){let e=this.settings,t=e.startVehicle;e.track&&(t=e.track.vehicle),this.vehicle=t}updatePlayers(){this.playerManager.update()}hideControlPlanel(){this.state.showSkip&&(this.state.showSkip=!1),!1!==this.state.showControls&&(this.state.showControls=!1)}showControlPlanel(e){this.settings.isCampaign&&!this.settings.mobile&&this.settings.campaignData.can_skip&&this.analytics&&this.analytics.deaths>5&&(this.state.showSkip=!0),this.stateshowControls!==e&&this.settings.showHelpControls&&(this.state.showControls=e)}resize(){this.pauseControls.resize(),this.settings.fullscreenAvailable&&this.fullscreenControls.resize(),this.settingsControls.resize(),super.resize()}updateState(){null!==this.game.onStateChange&&this.game.onStateChange(this.state)}setStateDefaults(){let e=super.setStateDefaults();return e.paused=!1,e.playerAlive=!0,e.showControls=!1,e.showSkip=!1,e}command(){let e=Array.prototype.slice.call(arguments,0);switch(e.shift()){case"clear race":this.races.splice(0),this.restartTrack=!0,this.raceTimes.clear();break;case"add race":let t=e[0],s=e[1];this.addRaces(t),s&&(this.state.dialogOptions={races:this.races},this.command("dialog","race_dialog"));break;case"change vehicle":let i=e[0];this.selectVehicle(i);break;case"restart":this.command("dialog",!1),this.restartTrack=!0;break;case"resume":this.state.paused=!1;break;case"fullscreen":this.toggleFullscreen();break;case"exit_fullscreen":this.exitFullscreen()}super.command(...arguments)}addRaces(e){this.mergeRaces(e),this.sortRaces(),this.formatRaces(),this.addRaceTimes(),this.addPlayers(),this.restartTrack=!0}addRaceTimes(){let e=this.settings.raceColors,t=e.length,s=this.races,i=this.raceTimes;i.clear();for(let o in s){let a=s[o];a.user.color=e[o%t],i.addRace(a,o)}}addPlayers(){let e=this.playerManager;e.clear();let t=this.settings.keysToRecord;for(let{user:s,race:i}of this.races){let o=i.code;"string"==typeof o&&(o=JSON.parse(o));let a=e.createPlayer(this,s);a.setBaseVehicle(i.vehicle),a.setAsGhost(),a.getGamepad().loadPlayback(o,t),e.addPlayer(a)}}formatRaces(){for(let{race:e}of this.races){let t=e.code;if("string"==typeof t){t=JSON.parse(t);for(let e in t)t[e]instanceof Array&&(t[e]=t[e].reduce(((e,t)=>(e[t]=1+~~e[t],e)),{}));e.code=t}}}removeDuplicateRaces(){this.races=this.races.filter(((e,t,s)=>t===s.findIndex((t=>this.uniqesByUserIdIterator(t)==this.uniqesByUserIdIterator(e)))))}uniqesByUserIdIterator(e){return e.user.u_id}sortRaces(){this.races=this.races.sort(((e,t)=>this.sortByRunTicksIterator(e)-this.sortByRunTicksIterator(t)))}mergeRaces(e){let t=this.races;e&&e.forEach((e=>{let s=t.find((t=>t.user.u_id===e.user.u_id));s?Object.assign(s,e):t.push(e)}))}sortByRunTicksIterator(e){let t=this.settings,s=parseInt(e.race.run_ticks),i=_(s/t.drawFPS*1e3);return e.runTime=i,s}verifyComplete(){let e=this.playerManager.firstPlayer._powerupsConsumed.targets,t=this.track.targets,s=!0;for(let i of t){let t=i.id;-1===e.indexOf(t)&&(s=!1)}return s}async trackComplete(){if(this.verifyComplete()){this.sound.play("victory_sound");let e=this.playerManager;e.mutePlayers();let t=e.firstPlayer,s=t.getGamepad(),i=s.getReplayString(),o=this.settings,a=this.ticks,r=_(a/o.drawFPS*1e3),n={t_id:$("#track-data").data("t_id"),u_id:o.user.u_id,code:i,vehicle:t._baseVehicleType,run_ticks:a,fps:25,time:r};n.sig=await async function(e){const t=(new TextEncoder).encode(e),s=await crypto.subtle.digest("SHA-256",t);return Array.from(new Uint8Array(s)).map((e=>e.toString(16).padStart(2,"0"))).join("")}(n.t_id+"|"+n.u_id+"|"+n.code+"|"+n.run_ticks+"|"+n.vehicle+"|"+n.fps+"|erxrHHcksIHHksktt8933XhwlstTekz");let h=this.races;h.length>0&&(n.races=h.map((({user:e})=>e.u_id))),o.isCampaign&&(n.is_campaign=!0),this.state.dialogOptions={postData:n,analytics:this.analytics},navigator.onLine||(localStorage.setItem("offline_races",Object.assign(Object.assign({},JSON.parse(localStorage.getItem("offline_races"))),{[this.settings.track.id]:this.state.dialogOptions})),alert("Your connection is offline! Free Rider Lite saved your ghost, and it will be published when your connection is back online!")),this.command("dialog",(o.isCampaign?"campaign":"track")+"_complete"),s.reset(!0),this.listen()}}close(){this.fullscreenControls=null,this.settingsControls=null,this.raceTimes=null,this.score=null,this.campaignScore=null,super.close()}};window.Game=class{gameContainer=null;_frames=0;frames=0;lastTime=-1;timer=performance.now();_updates=0;updates=0;ups=30;tickCount=0;currentScene=null;assets=null;canvas=null;stats=null;width=0;height=0;fullscreen=!1;onStateChange=null;constructor(e,t,s){this.assets=t,this.settings=s,this.initCanvas(),this.setSize(),this.switchScene(e),this.setSize(),this.updateCallback=requestAnimationFrame(this.update.bind(this))}initCanvas(){this.canvas=document.createElement("canvas"),this.ctx=this.canvas.getContext("2d"),this.gameContainer=document.getElementById(this.settings.defaultContainerID),null!==this.gameContainer&&this.gameContainer.appendChild(this.canvas)}setSize(){let e=window.innerHeight,t=window.innerWidth;this.settings.fullscreen||this.settings.isStandalone||(e=this.gameContainer.clientHeight,t=this.gameContainer.clientWidth),this.currentScene&&(e-=this.currentScene.getCanvasOffset().height);let s=1;window.devicePixelRatio&&(s=window.devicePixelRatio),this.settings.lowQualityMode&&(s=1);let i=t*s,o=e*s;(i!==this.width||o!==this.height)&&(this.width=i,this.height=o,this.canvas.width=i,this.canvas.height=o),this.pixelRatio=s,this.canvas.style.width=t+"px",this.canvas.style.height=e+"px",this.ctx.strokeStyle=this.settings.physicsLineColor,this.ctx.lineCap="round",this.ctx.lineJoin="round",this.currentScene&&this.currentScene.command("resize")}progress=0;update(e){this.updateCallback=requestAnimationFrame(this.update.bind(this));let t=e-this.lastTime,s=1e3/this.ups;for(t>1e3&&(t=s),this.progress+=t/s,this.lastTime=e;this.progress>=1;)this.currentScene.fixedUpdate(),this._updates++,this.progress--;this.currentScene.draw(this.ctx),lite.draw(this.ctx),this._frames++,e-this.timer>1e3&&(this.timer=e,this.updates=this._updates,this._updates=0,this.frames=this._frames,this._frames=0)}switchScene(e){null!==this.currentScene&&this.currentScene.close(),this.currentScene=new{Editor:Oe,Main:We}[e](this)}command(){this.currentScene.command.apply(this.currentScene,arguments)}close(){cancelAnimationFrame(this.updateCallback),this.currentScene.close(),this.currentScene=null,this.assets=null,this.settings=null,this.canvas.remove(),this.canvas=null,this.ctx=null,this.tickCount=null,this.height=null,this.width=null}}})();