(()=>{"use strict";var __webpack_modules__={459:(__unused_webpack___webpack_module__,__webpack_exports__,__webpack_require__)=>{__webpack_require__.d(__webpack_exports__,{A:()=>__WEBPACK_DEFAULT_EXPORT__});const __WEBPACK_DEFAULT_EXPORT__=class{actualHeight=0;actualWidth=0;alpha=null;aspectRatio=null;aspectRatioLock=!1;background=null;cached=!1;canvas=null;color=null;container=null;font={size:null};height=0;overflow=!0;padding=0;scale={x:1,y:1};text=null;image=null;visible=!0;width=0;x=0;y=0;constructor(e,t){Object.defineProperty(this,"cached",{enumerable:!1}),Object.defineProperty(this,"canvas",{enumerable:!1}),Object.defineProperty(this,"container",{enumerable:!1}),Object.defineProperty(this,"data",{value:null,writable:!0}),Object.assign(this,e),t&&t.addChild(this)}_calculateInheritance(e){self=this;let t,s=self[e];switch(e){case"x":e="actualWidth";break;case"y":e="actualHeight"}for(;/^\d+%/.test(s);)self=self.container,t=(self&&self[e])??0,s=Math.floor(t*(parseFloat(s)/100));return s??0}_calculateScale(e){self=this;let t=self.scale[e];for(;self=self.container;)t*=self.scale[e];return t??1}_calculateRelativeFontSize({height:e,initial:t,max:s,min:i,padding:a,width:o}={}){let r,n=new OffscreenCanvas(1,1).getContext("2d"),h=this._inherit("font"),l=t??16;for(;(!r||isFinite(e)&&r.actualHeight>e-(a??.1*e)||isFinite(o)&&r.actualWidth>o-(a??.1*o))&&(n.font=l--*this.scale.y+"px "+(h.family||"helsinki"),r=n.measureText(this.text),r.actualHeight=r.fontBoundingBoxAscent+r.fontBoundingBoxDescent,r.actualWidth=r.actualBoundingBoxLeft+r.actualBoundingBoxRight,this.textOutline&&(r.actualWidth+=2,r.actualHeight+=2),!(l<(i??3))););return l}_calculateTextMetrics(){let e=new OffscreenCanvas(1,1).getContext("2d"),t=Object.assign({},this._inherit("font"));return t.size??=this._calculateRelativeFontSize(...arguments),e.font=t.size*this.scale.y+"px "+(t.family||"helsinki"),t=Object.assign(e.measureText(this.text),t),t.actualHeight=t.fontBoundingBoxAscent+t.fontBoundingBoxDescent,t.actualWidth=t.actualBoundingBoxLeft+t.actualBoundingBoxRight,t}_caclulateActual(property){let initial=this._calculateInheritance(property),t=this.radius??this.size;return t&&(t=Math.round(2*(parseFloat(t)||0)),initial=Math.max(initial,t)),this.text&&(t=this._calculateTextMetrics({[property]:initial}),initial=Math.max(initial,Math.ceil(t["actual"+property.replace(/^\w/,(e=>e.toUpperCase()))]))),this.padding&&(initial+=2*this.padding),/^\d+%.+/.test(this[property])&&(initial=Math.floor(eval(this[property].replace(/\d+%/,initial)))),Math.floor(initial*this._calculateScale("height"===property?"y":"x"))}_getBoundingClientRect(){let e=this._calculateInheritance("x")*this._calculateScale("x"),t=this._calculateInheritance("y")*this._calculateScale("y"),s=this._caclulateActual("width"),i=this._caclulateActual("height");return this.container&&this.container.inline&&this.container.gap&&this.container.children.indexOf(this)>0&&(e+=this.gap),{bottom:t+i,height:i,left:e,right:e+s,top:t,width:s,x:e,y:t}}_inherit(e){self=this;let t=this[e];for(;(!t||t instanceof Object)&&(self=self.container);)t=t instanceof Object?Object.assign({},self[e],Object.fromEntries(Object.entries(t).filter((([,e])=>null!==e)))):self[e];return t??null}_drawText(e,t){let s=[t,"center"===e.textAlign?this.actualWidth/2:0,"middle"===e.textBaseline?this.actualHeight/2:0];this.textOutline&&e.strokeText(...s),e.fillText(...s)}_setSize(e,t){let s=this._getBoundingClientRect();s.width>0&&s.width!==e.width&&(e.width=s.width,this.actualWidth=s.width),s.height>0&&s.height!==e.height&&(e.height=s.height,this.actualHeight=s.height),this.alpha&&(t.globalAlpha=this.alpha),e=this._inherit("color"),this.background&&(t.fillStyle=this.background),e&&(t.strokeStyle=e,!this.background&&(t.fillStyle=e)),this.text&&(e=this._inherit("font"),t.font=(e.size??this._calculateRelativeFontSize(s))*this.scale.y+"px "+(e.family||"helsinki"),(e=this._inherit("textAlign"))&&(t.textAlign=e),(e=this._inherit("textBaseline")||"top")&&(t.textBaseline=e))}createCanvas(){let e=this.canvas;return e||(e=document.createElement("canvas"),this.canvas=e),e}cache(e=window.devicePixelRatio){if(this.cached||this.image)return;let t=this.createCanvas(),s=t.getContext("2d");s.clearRect(0,0,t.width,t.height),this._setSize(t,s),this.background&&(s.roundRect(0,0,t.width,t.height,(/%$/.test(this.borderRadius)?Math.floor(Math.min(t.width,t.height)/2*(parseFloat(this.borderRadius)/100)):parseFloat(this.borderRadius))||0),s.fill(),t=this._inherit("color"),t&&(s.fillStyle=t)),this.text&&this._drawText(s,this.text),this.cached=!0}draw(e,t=0,s=0,{padding:i=0}={}){if(!this.visible)return;let a=window.devicePixelRatio,o=this.actualWidth*a,r=this.actualHeight*a;i>0&&(t+=i,s+=i),this.image?(e.imageSmoothingEnabled=!0,e.drawImage(this.image.canvas,this.image.x,this.image.y,this.image.width,this.image.height,t+this.x*a,s+this.y*a,this.width,this.height),e.imageSmoothingEnabled=!1):o>0&&r>0&&(this.cached||this.cache(a),this.canvas.width>0&&this.canvas.height>0&&e.drawImage(this.canvas,t+this.x*this._calculateScale("x")*a,s+this.y*this._calculateScale("y")*a,o,r))}setDirty(){this.cached=!1,this.container&&(this.container.cached=!1)}}}},__webpack_module_cache__={};function __webpack_require__(e){var t=__webpack_module_cache__[e];if(void 0!==t)return t.exports;var s=__webpack_module_cache__[e]={exports:{}};return __webpack_modules__[e](s,s.exports,__webpack_require__),s.exports}__webpack_require__.d=(e,t)=>{for(var s in t)__webpack_require__.o(t,s)&&!__webpack_require__.o(e,s)&&Object.defineProperty(e,s,{enumerable:!0,get:t[s]})},__webpack_require__.o=(e,t)=>Object.prototype.hasOwnProperty.call(e,t);var __webpack_exports__={};class EventEmitter{#e=null;#t=-1;defaultMaxListeners=10;setMaxListeners(e){if("number"!=typeof e||0>e)throw TypeError("n must be a positive number");return this.#t=e,this}emit(e,...t){const s="error"===e;s&&t.length<1&&t.push(Error('Unspecified "error" event.'));const i=this.#e?.[e];if(!i){if(s)throw t[0];return!1}let a=!1;const o="function"==typeof i?[i]:[...i];for(const e of o)!1===e.apply(this,t)&&(a=!0);return a}addListener(e,t){if("function"!=typeof t)throw TypeError("listener must be a function");if(this.#e||(this.#e={}),this.#e.newListener&&this.emit("newListener",e,"function"==typeof t.listener?t.listener:t),this.#e[e]?"object"==typeof this.#e[e]&&null!==this.#e[e]?this.#e[e].add(t):this.#e[e]=new Set([this.#e[e],t]):this.#e[e]=t,"object"==this.#e[e]&&null!==this.#e[e]&&!this.#e[e].warned){var s=this.#t<0?this.defaultMaxListeners:this.#t;s&&s>0&&this.#e[e].size>s&&(this.#e[e].warned=!0,console.warn("Warning: possible EventEmitter memory leak detected. %d listeners added. Use emitter.setMaxListeners() to increase limit.",this.#e[e].size))}return this}once(e,t){if("function"!=typeof t)throw TypeError("listener must be a function");const s=(...i)=>{this.removeListener(e,s),t.apply(this,i)};this.on(e,Object.defineProperty(s,"listener",{value:t}))}removeListener(e,t){if("function"!=typeof t)throw TypeError("listener must be a function");if(!this.#e||!this.#e[e])return this;let s=this.#e[e];if(s===t||"function"==typeof s.listener&&s.listener===t)delete this.#e[e],this.#e.removeListener&&this.emit("removeListener",e,t);else if("object"==typeof s&&null!==s)for(let i of s.values())if(i===t||"function"==typeof i.listener&&i.listener===t){s.delete(i),s.size<2&&(0===s.size?delete this.#e[e]:this.#e[e]=this.#e[e].values().next().value),this.#e.removeListener&&this.emit("removeListener",e,t);break}return Object.keys(this.#e).length<1&&(this.#e=null),this}removeAllListeners(e){if(!this.#e)return this;if(!this.#e.removeListener)return 0===arguments.length?this.#e=null:this.#e[e]&&delete this.#e[e],Object.keys(this.#e).length<1&&(this.#e=null),this;let t;if(0===arguments.length){for(t in this.#e)"removeListener"!==t&&this.removeAllListeners(t);return this.removeAllListeners("removeListener")}if(t=this.#e[e],"function"==typeof t)this.removeListener(e,t);else for(let s of t.values())this.removeListener(e,s);return delete this.#e[e],Object.keys(this.#e).length<1&&(this.#e=null),this}listeners(e){return this.#e&&this.#e[e]?"function"==typeof this.#e[e]?[this.#e[e]]:Array.from(this.#e[e]):[]}listenerCount(e){return this.#e&&this.#e[e]?"function"==typeof this.#e[e]?1:this.#e[e].size:0}}function bresenham(e,t,s,i,a,o){let r=[],n=e,h=t,l=(i-t)/(s-e),c=s>e?1:-1,p=i>t?1:-1,d=0;r.push(e,t),!0===o&&(e%a==0&&r.push(e-.5,t),t%a==0&&r.push(e,t-.5));do{let d=Math.floor(n/a)==Math.floor(s/a),u=Math.floor(h/a)==Math.floor(i/a);if(d&&u)break;let m=0,g=0;m=Math.round(Math.floor(n/a+c)*a),0>c&&(m=Math.round(Math.ceil((n+1)/a+c)*a)-1),g=Math.round(t+(m-e)*l);let y=0,w=0;w=Math.round(Math.floor(h/a+p)*a),0>p&&(w=Math.round(Math.ceil((h+1)/a+p)*a)-1),y=Math.round(e+(w-t)/l),Math.pow(m-e,2)+Math.pow(g-t,2)<Math.pow(y-e,2)+Math.pow(w-t,2)?(n=m,h=g,r.push(m,g),!0===o&&(m%a==0&&r.push(m-1,g),g%a==0&&r.push(m,g-1))):(n=y,h=w,r.push(y,w),!0===o&&(y%a==0&&r.push(y-.5,w),w%a==0&&r.push(y,w-.5)))}while(d++<5e3);return r}Object.defineProperties(EventEmitter.prototype,{off:{value:EventEmitter.prototype.removeListener},on:{value:EventEmitter.prototype.addListener}});const cartesian=class{x=0;y=0;constructor(e,t){isFinite(e)&&(this.x=e),isFinite(t)&&(this.y=t)}toReal(e){let t=e.camera,s=e.screen,i=(this.x-s.center.x)/t.zoom+t.position.x,a=(this.y-s.center.y)/t.zoom+t.position.y;return new this.constructor(i,a)}toScreen(e){let t=e.camera,s=e.screen,i=(this.x-t.position.x)*t.zoom+s.center.x,a=(this.y-t.position.y)*t.zoom+s.center.y;return new this.constructor(i,a)}lenSqr(){return this.dot(this)}len(){return Math.sqrt(this.lenSqr())}delta(e){return this.sub(e).len()}dot(e){return this.x*e.x+this.y*e.y}factor(e){return new this.constructor(this.x*e,this.y*e)}factorSelf(e){this.x*=e,this.y*=e}factorOut(e,t){t.x=this.x*e,t.y=this.y*e}add(e){return new this.constructor(this.x+e.x,this.y+e.y)}inc(e){this.x+=e.x,this.y+=e.y}addOut(e,t){t.x=this.x+e.x,t.y=this.y+e.y}sub(e){return new this.constructor(this.x-e.x,this.y-e.y)}subOut(e,t){t.x=this.x-e.x,t.y=this.y-e.y}subSelf(e){this.x-=e.x,this.y-=e.y}equ(e){this.x=e.x,this.y=e.y}lerp(e,t){return new this.constructor(this.x+(e.x-this.x)*t,this.y+(e.y-this.y)*t)}lerpTo(e,t){this.x+=(e.x-this.x)*t,this.y+=(e.y-this.y)*t}normalize(){let e=this.len();return 0===e?new this.constructor(0,0):new this.constructor(this.x/e,this.y/e)}getAngleInDegrees(e){let t=e.sub(this),s=Math.atan2(t.x,-t.y)*(180/Math.PI);return s<0&&(s+=360),s}getAngleInRadians(e){let t=e.sub(this);return Math.atan2(t.x,-t.y)}static max(...e){return e.length>0&&e.sort(((e,t)=>e.dot(1)-t.dot(1)))[0]||new this(-1/0,-1/0)}static min(...e){return e.length>0&&e.sort(((e,t)=>t.dot(1)-e.dot(1)))[0]||new this(1/0,1/0)}},sceneryline=class{sectors=[];p1=null;p2=null;pp=null;len=0;collided=!1;highlight=!1;recorded=!1;remove=!1;constructor(e,t,s,i){Object.defineProperties(this,{recorded:{enumerable:!1},remove:{enumerable:!1},sectors:{enumerable:!1}}),this.p1=new cartesian(e,t),this.p2=new cartesian(s,i),this.pp=this.p2.sub(this.p1),this.len=this.pp.len()}move(e,t){this.p1.x+=0|parseInt(e),this.p1.y+=0|parseInt(t),this.p2.x+=0|parseInt(e),this.p2.y+=0|parseInt(t)}getCode(e){this.recorded=!0;let t=this.p2,s=" "+t.x.toString(32)+" "+t.y.toString(32),i=this.checkForConnectedLine(e,t);return i&&(s+=i.getCode(e)),s}checkForConnectedLine(e,t){let s=e.settings.drawSectorSize,i=e.sectors.drawSectors,a=Math.floor(t.x/s),o=Math.floor(t.y/s);return i[a][o].searchForLine(this.constructor.type+"Lines",t)}erase(e,t){let s=!1;if(!this.remove){let i=this.p1,a=this.p2.sub(i),o=i.sub(e),r=a.dot(a),n=2*o.dot(a),h=n*n-4*r*(o.dot(o)-t**2);if(h>0){h=Math.sqrt(h);let e=(-n-h)/(2*r),t=(-n+h)/(2*r);e>=0&&1>=e&&(s=!0,this.removeAllReferences()),t>=0&&1>=t&&(s=!0,this.removeAllReferences())}(this.intersects(this.p1.x,this.p1.y,e.x,e.y,t)||this.intersects(this.p2.x,this.p2.y,e.x,e.y,t))&&(s=!0,this.removeAllReferences())}return s}intersects(e,t,s,i,a){return a**2>=(e-s)**2+(t-i)**2}addSectorReference(e){this.sectors.push(e)}removeAllReferences(){this.remove=!0;for(let e of this.sectors)e.drawn=!1,e.dirty=!0;this.sectors=[]}static type="scenery"},physicsline=class extends sceneryline{collide(e){if(this.collided)return;this.collided=!0;let t=e.pos,s=e.vel,i=e.radius,a=0,o=0,r=0,n=this.p1,h=this.p2,l=t.x-n.x,c=t.y-n.y,p=this.pp,d=this.len,u=(l*p.x+c*p.y)/d/d;if(u>=0&&1>=u){let a=(l*p.y-c*p.x)*((l-s.x)*p.y-(c-s.y)*p.x)<0?-1:1,o=l-p.x*u,n=c-p.y*u;if(r=Math.sqrt(Math.pow(o,2)+Math.pow(n,2)),0===r&&(r=1),i>r||0>a){let s=(i*a-r)/r;return t.x+=o*s,t.y+=n*s,void e.drive(-n/r,o/r)}}if(!(-i>u*d||u*d>d+i)){let s=u>0?h:n;if(a=t.x-s.x,o=t.y-s.y,r=Math.sqrt(a**2+o**2),0===r&&(r=1),i>r){let s=(i-r)/r;return t.x+=a*s,t.y+=o*s,void e.drive(-o/r,a/r)}}}static type="physics"},powerup=class{game=null;scene=null;color="#FFF";x=0;y=0;multiplier=1;name=null;sector=null;settings=null;outline="#000";remove=!1;constructor(e,t){Object.defineProperty(this,"game",{enumerable:!1}),Object.defineProperty(this,"scene",{enumerable:!1});let s=arguments[arguments.length-1];this.game=s.scene.game,this.scene=s.scene,this.settings=this.game.settings,this.settings.accentColor&&(this.outline=this.settings.accentColor),this.x=e,this.y=t,this.remove=!1}addSectorReference(e){this.sector=e}collide(e){let t=e.pos.x-this.x,s=e.pos.y-this.y,i=Math.sqrt(t**2+s**2);!this.hit&&26>i&&(this.hit=!0,this.sector.powerupCanvasDrawn=!1)}draw(e,t,s,i){this.constructor.cache.dirty&&this.recache(s);let a=this.constructor.cache.width*s,o=this.constructor.cache.height*s,r=a/2,n=o/2;i.drawImage(this.constructor.cache.canvas,e-r,t-n,a,o)}drawPowerup(){}erase(e,t){let s=!1;return this.remove||t>=Math.sqrt(Math.pow(e.x-this.x,2)+Math.pow(e.y-this.y,2))&&(s=[this],this.removeAllReferences()),s}getCode(){let e="";return this.prefix&&(e=this.prefix+" "),e+this.x.toString(32)+" "+this.y.toString(32)}move(e,t){return this.x+=0|parseInt(e),this.y+=0|parseInt(t),this}recache(e){this.setDirty(!1);let t=this.constructor.cache.canvas,s=t.getContext("2d");this.updateCache(s,e)||s.clearRect(0,0,t.width,t.height);let i=t.width/2,a=t.height/2;s.clearRect(0,0,t.width,t.height),this.drawPowerup(s,e,i,a),this.settings.developerMode&&(s.beginPath(),s.rect(0,0,t.width,t.height),s.strokeStyle="red",s.strokeWidth=1*e,s.stroke())}removeAllReferences(){this.remove=!0,this.sector&&(this.sector.powerupCanvasDrawn=!1,this.sector.dirty=!0,this.sector=null),this.scene.track.cleanPowerups()}setDirty(e){this.constructor.cache.dirty=e}updateCache(e,t){let s=this.constructor.cache,i=s.canvas,a=s.width*t,o=s.height*t,r=a!==i.width,n=o!==i.height;return r&&(i.width=a),n&&(i.height=o),r||n}static createCache(e,t){let s=Object.assign({canvas:document.createElement("canvas"),dirty:!0,width:25,height:25},e);return"function"==typeof t&&t(s.canvas.getContext("2d")),s}},antigravity=class extends powerup{color="#08faf3";hitboxRadius=Math.sqrt(1e3);name="antigravity";prefix="A";collide(e){let t=e.parent,s=t.player,i=e.pos.x-this.x,a=e.pos.y-this.y;1e3>Math.pow(i,2)+Math.pow(a,2)&&s.isAlive()&&(!1===s.isGhost()&&((0!=t.gravity.x||0!=t.gravity.y)&&this.scene.sound.play("antigravity_sound",.3),this.scene.message.show("Antigravity Engaged",50,this.color)),t.gravity.x=0,t.gravity.y=0)}drawPowerup(e,t){t*=this.constructor.cache.scale,e.scale(t,t),e.beginPath();let s=e.lineWidth;e.arc(25,25,11-s/2,0,2*Math.PI,!0),e.fill(),e.stroke(),e.beginPath(),e.moveTo(3,29.3196417),e.bezierCurveTo(4.74079001,38.2359804,11.7640196,45.2589035,20.6800518,46.9996935),e.lineTo(20.6800518,40.7043471),e.bezierCurveTo(15.1649961,39.1854465,10.814247,34.8350039,9.29534642,29.3196417),e.closePath(),e.moveTo(47,20.6803583),e.bezierCurveTo(45.25921,11.7640196,38.2362869,4.74079001,29.3196417,3),e.lineTo(29.3196417,9.29534642),e.bezierCurveTo(34.8350039,10.814247,39.185753,15.1646897,40.7046536,20.6803583),e.closePath(),e.moveTo(9.29534642,20.6803583),e.bezierCurveTo(10.814247,15.1646897,15.1649961,10.814247,20.6800518,9.29534642),e.lineTo(20.6800518,3),e.bezierCurveTo(11.7640196,4.74109649,4.74079001,11.7640196,3,20.6803583),e.closePath(),e.moveTo(29.3196417,46.9996935),e.bezierCurveTo(38.2362869,45.2589035,45.25921,38.2359804,47,29.3196417),e.lineTo(40.7046536,29.3196417),e.bezierCurveTo(39.185753,34.8350039,34.8350039,39.1854465,29.3196417,40.7043471),e.closePath(),e.lineWidth=5,e.stroke(),e.lineWidth=s,e.fill(),e.resetTransform()}updateCache(e,t){let s=super.updateCache(e,t);return e.fillStyle=this.color,e.strokeStyle=this.outline,e.lineWidth=3,s}static cache=this.createCache({scale:.5})},bomb=class extends powerup{color="#d12929";hit=!1;name="bomb";prefix="O";collide(e){let t=e.parent,s=t.player,i=e.pos.x-this.x,a=e.pos.y-this.y;20>Math.sqrt(i**2+a**2)&&s.isAlive()&&(t.explode(),!1===s.isGhost()&&(this.hit=!0,this.sector.powerupCanvasDrawn=!1))}draw(...e){this.hit||super.draw(...e)}drawPowerup(e,t){t*=this.constructor.cache.scale,e.beginPath(),e.moveTo(53*t,105*t),e.lineTo(41.5*t,115*t),e.lineTo(43*t,100*t),e.bezierCurveTo(35.5*t,95*t,30*t,88.5*t,26.5*t,80*t),e.lineTo(11*t,78*t),e.lineTo(24*t,69.5*t),e.bezierCurveTo(24*t,68*t,24*t,67*t,24*t,66*t),e.bezierCurveTo(24*t,58.5*t,26*t,51*t,30*t,45*t),e.lineTo(22*t,31.5*t),e.lineTo(37.5*t,36*t),e.bezierCurveTo(43.5*t,31*t,51*t,27.5*t,60*t,26*t),e.lineTo(66*t,11*t),e.lineTo(72*t,26.5*t),e.bezierCurveTo(80.5*t,27.5*t,88*t,31*t,93.5*t,36.5*t),e.lineTo(110*t,31.5*t),e.lineTo(101.5*t,46*t),e.bezierCurveTo(105*t,52*t,107*t,59*t,107*t,66*t),e.bezierCurveTo(107*t,67*t,107*t,68*t,107*t,69*t),e.lineTo(121*t,78*t),e.lineTo(104.5*t,80.5*t),e.bezierCurveTo(101.5*t,88*t,96*t,95*t,89*t,99.5*t),e.lineTo(90.5*t,115*t),e.lineTo(78.5*t,104.5*t),e.bezierCurveTo(74.5*t,106*t,70*t,107*t,65.5*t,107*t),e.bezierCurveTo(61*t,107*t,57*t,106*t,53*t,105*t),e.lineTo(53*t,105*t),e.closePath(),e.fill(),e.stroke(),e.beginPath(),e.arc(66*t,66*t,40*t,0*t,2*Math.PI,!0),e.save(),e.lineWidth=2*t,e.save(),e.fillStyle=this.color,e.fill(),e.stroke(),e.restore(),e.beginPath(),e.arc(66*t,66*t,8*t,0*t,2*Math.PI,!0),e.fill(),e.stroke(),e.restore()}updateCache(e,t){let s=super.updateCache(e,t);return e.fillStyle=this.outline,e.strokeStyle=this.outline,e.lineWidth=8*t*this.constructor.cache.scale,s}static cache=this.createCache({width:26,height:26,scale:.2})},directional=class extends powerup{angle=null;directionX=0;directionY=0;realAngle=0;constructor(e,t,s,i){super(e,t,i),this.realAngle=s}draw(e,t,s,i){this.constructor.cache.dirty&&this.recache(s);let a=this.constructor.cache.width*s,o=this.constructor.cache.height*s,r=a/2,n=o/2,h=(this.angle+this.constructor.angleOffset)*(Math.PI/180);i.translate(e,t),i.rotate(h),i.drawImage(this.constructor.cache.canvas,-r,-n,a,o),i.rotate(-h),i.translate(-e,-t)}getCode(){return(super.getCode()+" "+this.realAngle.toString(32)+",").repeat(this.multiplier).slice(0,-1)}},boost=class extends directional{color="#8ac832";name="boost";prefix="B";constructor(e,t,s,i){super(e,t,s,i),this.angle=s;let a=(s-180)/360*2*Math.PI;this.directionX=(-Math.sin(a)).toFixed(15)/1,this.directionY=Math.cos(a).toFixed(15)/1}collide(e){let t=e.parent,s=t.player,i=(e.pos.x-this.x)**2+(e.pos.y-this.y)**2,a=t.masses,o=a.length;if(1e3>i&&s.isAlive()){for(let e=0;e<this.multiplier;e++)for(var r=o-1;r>=0;r--){var n=a[r].pos;n.x+=this.directionX,n.y+=this.directionY}!1===s.isGhost()&&(this.scene.sound.play("boost_sound"),this.scene.message.show("Boost Engaged",50,this.color))}}drawPowerup(e,t){t*=this.constructor.cache.scale,e.beginPath(),e.moveTo(8*t,4*t),e.lineTo(39*t,4*t),e.lineTo(70*t,40*t),e.lineTo(38*t,76*t),e.lineTo(8*t,76*t),e.lineTo(40*t,39*t),e.closePath(),e.moveTo(57*t,4*t),e.lineTo(89*t,4*t),e.lineTo(120*t,40*t),e.lineTo(88*t,76*t),e.lineTo(58*t,76*t),e.lineTo(89*t,39*t),e.closePath(),e.fill(),e.stroke()}updateCache(e,t){let s=super.updateCache(e,t);return e.fillStyle=this.color,e.strokeStyle=this.outline,e.lineWidth=Math.max(8*t*this.constructor.cache.scale,1),s}static angleOffset=-90;static cache=this.createCache({width:25,height:16,scale:.2})},consumable=class extends powerup{hit=!1;id=crypto.randomUUID()},checkpoint=class extends consumable{color="#826cdc";name="checkpoint";prefix="C";collide(e){let t=e.parent.player,s=e.pos.x-this.x,i=e.pos.y-this.y,a=Math.sqrt(Math.pow(s,2)+Math.pow(i,2)),o=t._powerupsConsumed.checkpoints;26>a&&t.isAlive()&&-1===o.indexOf(this.id)&&(o.push(this.id),t.setCheckpointOnUpdate(),!1===t.isGhost()&&(this.hit=!0,this.sector.powerupCanvasDrawn=!1,this.scene.message.show("Checkpoint Saved",50,this.color,"#FFFFFF"),this.scene.sound.play("checkpoint_sound")))}draw(e,t,s,i){i.save(),this.hit&&(i.globalAlpha=.3),super.draw(e,t,s,i),i.restore()}drawPowerup(e,t){t*=this.constructor.cache.scale,e.beginPath(),e.moveTo(4*t,11*t),e.bezierCurveTo(4*t,11*t,34.5*t,28*t,56*t,11*t),e.bezierCurveTo(77*t,-5*t,109*t,11*t,109*t,11*t),e.lineTo(110*t,87*t),e.bezierCurveTo(110*t,87*t,75*t,74.5*t,57.5*t,87*t),e.bezierCurveTo(41*t,99*t,4*t,89.5*t,4*t,89.5*t),e.closePath(),e.fill(),e.stroke(),e.beginPath(),e.moveTo(5*t,11*t),e.lineTo(5*t,181*t);let s=e.lineWidth;e.lineWidth=10*t,e.stroke(),e.lineWidth=s}updateCache(e,t){let s=super.updateCache(e,t);return e.fillStyle=this.color,e.strokeStyle=this.outline,e.lineWidth=8*t*this.constructor.cache.scale,s}static cache=this.createCache({width:18,height:28,scale:.15})},gravity=class extends directional{angle=-180;color="#376eb7";name="gravity";prefix="G";constructor(e,t,s,i){super(e,t,s,i),this.angle=s-180;let a=this.angle/360*2*Math.PI;this.directionX=(-.3*Math.sin(a)).toFixed(15)/1,this.directionY=(.3*Math.cos(a)).toFixed(15)/1}collide(e){let t=e.parent,s=t.player;1e3>(e.pos.x-this.x)**2+(e.pos.y-this.y)**2&&s.isAlive()&&(t.gravity.x=this.directionX,t.gravity.y=this.directionY,!1===s.isGhost()&&(this.scene.message.show("Gravity Changed",50,"#1F80C3","#FFFFFF"),this.scene.sound.play("gravity_down_sound")))}drawPowerup(e,t){t*=this.constructor.cache.scale,e.beginPath(),e.moveTo(45*t,70*t),e.lineTo(45*t,95*t),e.lineTo(97*t,50*t),e.lineTo(45*t,5*t),e.lineTo(45*t,30*t),e.lineTo(3*t,30*t),e.lineTo(3*t,70*t),e.closePath(),e.fill(),e.stroke()}updateCache(e,t){let s=super.updateCache(e,t);return e.lineJoin="round",e.lineWidth=Math.max(6*t*this.constructor.cache.scale,1),e.fillStyle=this.color,e.strokeStyle=this.outline,s}static angleOffset=90;static cache=this.createCache({width:20,height:20,scale:.2})},slowmo=class extends powerup{name="slowmo";prefix="S";collide(e){let t=e.parent,s=t.player,i=e.pos.x-this.x,a=e.pos.y-this.y;26>Math.sqrt(Math.pow(i,2)+Math.pow(a,2))&&s.isAlive()&&(t.slow=!0,!1===s.isGhost()&&(this.scene.sound.play("slowmo_sound"),this.scene.message.show("Slow Motion",50,this.color,"#000000")))}drawPowerup(e,t){t*=.24,e.scale(t,t),e.beginPath(),e.arc(50,50,50-e.lineWidth/2,0,2*Math.PI),e.stroke(),e.beginPath(),e.arc(50,50,42.5-e.lineWidth/2,0,2*Math.PI),e.stroke(),e.beginPath(),e.moveTo(70,50),e.lineTo(50,50),e.lineTo(30,20),e.moveTo(92.5,50),e.lineTo(82.5,50),e.moveTo(50,7.5),e.lineTo(50,17.5),e.moveTo(50,92.5),e.lineTo(50,82.5),e.moveTo(7.5,50),e.lineTo(17.5,50);let s=e.lineWidth;e.lineWidth=5,e.stroke(),e.lineWidth=s}updateCache(e,t){let s=super.updateCache(e,t);return e.strokeStyle=this.outline,e.lineWidth=3,s}static cache=this.createCache({width:26,height:24})},target=class extends consumable{color="#FAE335";name="goal";prefix="T";cacheStar(e){let t=this.constructor.cache.canvas,s=t.getContext("2d");this.updateCache(s,e)||s.clearRect(0,0,t.width,t.height);let i=t.width/2,a=t.height/2;this.drawStar(i,a,5,10,5,!0,e,s),this.settings.developerMode&&(s.beginPath(),s.rect(0,0,t.width,t.height),s.strokeStyle="red",s.strokeWidth=1*e,s.stroke())}cacheEmptyStar(e){let t=this.constructor.hitCache.canvas;t.width=this.constructor.hitCache.width*e,t.height=this.constructor.hitCache.height*e;let s=t.getContext("2d"),i=t.width/2,a=t.height/2;this.drawStar(i,a,5,10,5,!1,e,s),this.settings.developerMode&&(s.beginPath(),s.rect(0,0,t.width,t.height),s.strokeStyle="red",s.strokeWidth=1*e,s.stroke())}collide(e){let t=e.parent.player,s=e.pos.x-this.x,i=e.pos.y-this.y,a=Math.sqrt(s**2+i**2),o=t._powerupsConsumed.targets,r=this.scene;if(26>a&&t.isAlive()&&-1===o.indexOf(this.id)){o.push(this.id);let e=t.getTargetsHit(),s=r.track.targetCount;if(!1===t.isGhost()&&(this.hit=!0,this.sector.powerupCanvasDrawn=!1,r.sound.play("goal_sound"),r.message.show(e+" of "+s+" Stars",50,this.color,"#666")),e>=s&&(t.complete=!0),this.game.emit("targetCollect",this,t),t.isGhost()){let i=this.scene.raceTimes.container.children.find((({data:e})=>e.user.u_id===t._user.u_id));i&&i.children.length>0&&(i.children[i.children.length-1].text=e+"/"+s,this.scene.raceTimes.redraw())}}}draw(e,t,s,i){let a=this.constructor.hitCache;this.hit||(a=this.constructor.cache,a.dirty&&this.recache(s));let o=a.width*s,r=a.height*s,n=o/2,h=r/2;i.drawImage(a.canvas,e-n,t-h,o,r)}drawStar(e,t,s,i,a,o,r,n){let h=Math.PI/2*3,l=e,c=t,p=Math.PI/s;i*=r,a*=r,n.beginPath(),n.moveTo(e,t-i);for(let o=0;s>o;o++)l=e+Math.cos(h)*i,c=t+Math.sin(h)*i,n.lineTo(l,c),h+=p,l=e+Math.cos(h)*a,c=t+Math.sin(h)*a,n.lineTo(l,c),h+=p;n.lineTo(e,t-i),n.closePath(),n.lineWidth=Math.max(2*r,1),n.strokeStyle=this.outline,n.stroke(),n.fillStyle=o?this.color:this.game.canvas?.computedStyleMap().get("background-color")?.toString()||"#FFFFFF",n.fill()}recache(e){this.setDirty(!1),this.cacheStar(e),this.cacheEmptyStar(e)}static cache=this.createCache({width:35,height:35});static hitCache=this.createCache({width:35,height:35})},teleport=class extends consumable{color="#dd45ec";otherPortal=null;name="teleport";prefix="W";recorded=!1;addOtherPortalRef(e){this.otherPortal=e}collide(e){let t=e.parent,s=t.player,i=s._powerupsConsumed.misc;-1===i.indexOf(this.id)&&1e3>(e.pos.x-this.x)**2+(e.pos.y-this.y)**2&&s.isAlive()&&(i.push(this.id),i.push(this.otherPortal.id),t.moveVehicle(this.otherPortal.x-this.x,this.otherPortal.y-this.y),!1===s.isGhost()&&(this.hit=!0,this.otherPortal.hit=!0,this.sector.powerupCanvasDrawn=!1,this.otherPortal.sector.powerupCanvasDrawn=!1,this.scene.sound.play("teleport_sound",.3),this.scene.message.show("Teleport Engaged",50,this.color)))}draw(e,t,s,i){i.save(),i.globalAlpha=!1===this.hit?1:.2,super.draw(e,t,s,i),i.restore()}drawPowerup(e,t){t*=this.constructor.cache.scale,e.save(),e.scale(t,t),e.translate(2.6,3),e.fillStyle=this.color,e.strokeStyle=this.outline,e.lineWidth=5,e.beginPath(),e.moveTo(23.9052288,5.91261647),e.bezierCurveTo(23.9052288,5.91261647,22.5543791,5.13614588,18.1099346,5.04995765),e.bezierCurveTo(13.6479739,5.05021647,9.39411765,6.99424,5.93111111,10.2266871),e.bezierCurveTo(2.88431373,13.0698635,.969542484,16.6517224,.241437908,20.8723576),e.bezierCurveTo(.0837908497,22.1227341,.0816993464,22.1341224,.0796078431,22.1452518),e.bezierCurveTo(.0929411765,25.8184753,.118562092,26.0470165,.145751634,26.2752988),e.bezierCurveTo(.550457516,29.6511341,1.80196078,32.7860047,3.86601307,35.59424),e.bezierCurveTo(4.76326797,36.8153694,6.27176471,38.4928047,7.6179085,39.4864282),e.bezierCurveTo(7.6179085,39.4864282,13.4911111,44.3481694,22.5543791,43.7872988),e.bezierCurveTo(16.5849673,39.6461224,15.7624837,37.5460282,15.7624837,37.5460282),e.bezierCurveTo(16.4521569,37.6208282,18.1535948,38.5391341,21.868366,38.5391341),e.bezierCurveTo(27.0628758,38.5391341,31.7535948,36.2909929,35.4330719,32.0377459),e.bezierCurveTo(37.5739869,29.5631341,38.9739869,26.6037459,39.5941176,23.2421459),e.lineTo(39.8856209,21.2448047),e.bezierCurveTo(39.7975163,18.0607576,39.7695425,17.8096988,39.7394771,17.5591576),e.bezierCurveTo(39.3355556,14.1864282,38.0845752,11.0515576,36.0215686,8.24176941),e.bezierCurveTo(34.9975163,6.84826353,33.8019608,5.59038118,32.4675817,4.50202824),e.bezierCurveTo(32.4675817,4.50202824,25.996732,-1.07536,16.5653595,.558592941),e.bezierCurveTo(21.6393464,2.28934588,23.9052288,5.91261647,23.9052288,5.91261647),e.stroke(),e.fill(),e.fillStyle=/^(dark(er)|midnight)?$/i.test(lite.storage.get("theme"))?"#1e1e1e":"#fefefe",e.beginPath(),e.moveTo(5.22875817,24.6992965),e.lineTo(5.22875817,23.0451553),e.bezierCurveTo(5.24078431,22.97812,5.25647059,22.9113435,5.26457516,22.8437906),e.bezierCurveTo(5.30823529,22.4770376,5.33254902,22.1071788,5.39555556,21.7440494),e.bezierCurveTo(5.9179085,18.7173671,7.26117647,16.0988494,9.5179085,13.9930612),e.bezierCurveTo(12.7882353,10.9404965,16.6520261,9.83428471,21.0614379,10.8020259),e.bezierCurveTo(23.1579085,11.2619553,24.9563399,12.2887082,26.3997386,13.8804729),e.bezierCurveTo(27.8005229,15.4251318,28.5681046,17.2482847,28.8130719,19.3033435),e.bezierCurveTo(29.0044444,20.9103788,28.7861438,22.4467553,28.0836601,23.9122141),e.bezierCurveTo(26.5186928,27.1764965,23.3458824,28.74652,19.8862745,27.9666847),e.bezierCurveTo(17.6018301,27.4518847,16.0658824,25.7762612,15.7793464,23.4833435),e.bezierCurveTo(15.7513725,23.2566141,15.7422222,23.0278141,15.7233987,22.7920259),e.bezierCurveTo(15.6826144,22.7959082,15.6577778,22.7959082,15.6345098,22.8013435),e.bezierCurveTo(15.2580392,22.8929671,15.0844444,23.1867318,14.9532026,23.5037906),e.bezierCurveTo(14.6407843,24.2592965,14.6128105,25.0383553,14.8180392,25.8238847),e.bezierCurveTo(15.1252288,26.9999788,15.8075817,27.9480494,16.7301961,28.7162376),e.bezierCurveTo(19.105098,30.6939082,21.8201307,31.2356259,24.7777778,30.3869435),e.bezierCurveTo(27.9027451,29.4903788,30.1628758,27.5002847,31.6556863,24.6703082),e.bezierCurveTo(33.1751634,21.7893435,33.4169935,18.73652,32.7003922,15.5969906),e.bezierCurveTo(32.1134641,13.0263553,30.9056209,10.7471553,29.2807843,8.67397882),e.bezierCurveTo(29.2345098,8.61496706,29.1887582,8.55595529,29.1427451,8.49694353),e.bezierCurveTo(30.1487582,9.31767294,31.0295425,10.2476259,31.7918954,11.2855082),e.bezierCurveTo(33.305098,13.3460024,34.2433987,15.6329671,34.5471895,18.1681435),e.bezierCurveTo(34.5856209,18.4903788,34.6206536,18.8131318,34.6569935,19.1356259),e.lineTo(34.6569935,20.7897671),e.bezierCurveTo(34.6449673,20.8565435,34.629281,20.92332,34.620915,20.9908729),e.bezierCurveTo(34.5644444,21.4313906,34.5309804,21.8763082,34.4501961,22.3121671),e.bezierCurveTo(34.0122876,24.6873906,33.0475817,26.8374376,31.4616993,28.6706847),e.bezierCurveTo(28.1134641,32.5408729,23.9121569,34.11012,18.8256209,33.0287553),e.bezierCurveTo(16.5994771,32.5553671,14.72,31.4287082,13.2504575,29.68372),e.bezierCurveTo(11.9879739,28.1846141,11.2983007,26.4463553,11.0705882,24.5126847),e.bezierCurveTo(10.871634,22.8236024,11.1286275,21.2212259,11.9113725,19.7042612),e.bezierCurveTo(13.5228758,16.5810376,16.6386928,15.0982376,19.9803922,15.8646141),e.bezierCurveTo(22.303268,16.3975318,23.7997386,18.0288965,24.1079739,20.3696965),e.bezierCurveTo(24.136732,20.5899553,24.1440523,20.8128024,24.1662745,21.1008729),e.bezierCurveTo(24.343268,20.9921671,24.5147712,20.9334141,24.6146405,20.8153906),e.bezierCurveTo(24.7620915,20.6414612,24.8909804,20.4375082,24.970719,20.2255318),e.bezierCurveTo(25.28,19.4032494,25.2648366,18.5688024,24.9890196,17.7405671),e.bezierCurveTo(24.5738562,16.4935553,23.7654902,15.5263318,22.715817,14.7615082),e.bezierCurveTo(20.315817,13.0147082,17.6664052,12.6334612,14.8541176,13.5207082),e.bezierCurveTo(11.8538562,14.4672259,9.67267974,16.4187553,8.23006536,19.1622847),e.bezierCurveTo(6.68470588,22.1014847,6.45960784,25.2078847,7.22352941,28.3996965),e.bezierCurveTo(7.82248366,30.8996729,9.0096732,33.1206376,10.5921569,35.1438612),e.bezierCurveTo(10.6420915,35.2083082,10.692549,35.2724965,10.743268,35.3364259),e.bezierCurveTo(9.97568627,34.7698612,8.83764706,33.5606376,8.09385621,32.5486376),e.bezierCurveTo(6.57986928,30.4886612,5.6420915,28.2016965,5.33830065,25.66652),e.bezierCurveTo(5.29960784,25.3442847,5.26535948,25.0215318,5.22875817,24.6992965),e.fill(),e.restore()}erase(e,t){let s=!1;return this.remove||t>=Math.sqrt(Math.pow(e.x-this.x,2)+Math.pow(e.y-this.y,2))&&(s=[this,this.otherPortal],this.removeAllReferences(),this.otherPortal.removeAllReferences()),s}getCode(){let e="";return!1===this.recorded&&!0===this.otherPortal.recorded?this.recorded=!0:!1===this.recorded&&!1===this.otherPortal.recorded?(this.recorded=!0,e=super.getCode()+" "+this.otherPortal.x.toString(32)+" "+this.otherPortal.y.toString(32)):!0===this.recorded&&!0===this.otherPortal.recorded&&(this.otherPortal.recorded=!1,e=super.getCode()+" "+this.otherPortal.x.toString(32)+" "+this.otherPortal.y.toString(32)),e}move(e,t){return this.otherPortal.x+=0|parseInt(e),this.otherPortal.y+=0|parseInt(t),super.move(e,t)}static cache=this.createCache({width:29,height:32,scale:.64})},sector=class{scene=null;settings=null;drawSectorSize=null;row=0;column=0;camera=null;zoom=0;x=0;y=0;realX=0;realY=0;physicsLines=[];sceneryLines=[];canvasPool=null;canvas=null;ctx=null;dirty=!1;drawn=!1;hasPowerups=!1;lineCount=0;powerupCanvas=null;powerupCanvasOffset=35;powerupCanvasDrawn=!1;powerups={all:[],goals:[],gravitys:[],boosts:[],slowmos:[],checkpoints:[],bombs:[],antigravitys:[],teleports:[],helicopters:[],trucks:[],balloons:[],blobs:[]};powerupsCount=0;constructor(e,t,s){this.track=s,this.scene=s.scene,this.settings=s.settings,this.drawSectorSize=s.settings.drawSectorSize,this.row=t,this.column=e,this.camera=s.camera,this.zoom=s.camera.zoom,this.canvasPool=s.canvasPool,this.x=e*this.drawSectorSize,this.y=t*this.drawSectorSize,this.realX=this.x*this.zoom,this.realY=this.y*this.zoom}addLine(e){e instanceof physicsline&&this.physicsLines.push(e)||e instanceof sceneryline&&this.sceneryLines.push(e),this.lineCount++,this.drawn=!1}searchForLine(e,t){return this[e].find((e=>e.p1.x===t.x&&e.p1.y===t.y&&!e.recorded&&!e.remove))}addPowerup(e){this.powerups.all.push(e),this.powerups.hasOwnProperty(e.name+"s")&&this.powerups[e.name+"s"].push(e),this.powerupsCount++,this.hasPowerups=!0,this.powerupCanvasDrawn=!1}cachePowerupSector(){if(this.powerupCanvasDrawn=!0,this.powerups.all.length>0){this.powerupCanvas=this.canvasPool.getCanvas(),this.powerupCanvas.width=this.drawSectorSize*this.scene.camera.zoom+this.powerupCanvasOffset*this.scene.camera.zoom|0,this.powerupCanvas.height=this.drawSectorSize*this.scene.camera.zoom+this.powerupCanvasOffset*this.scene.camera.zoom|0;let e=this.powerupCanvas.getContext("2d");e.clearRect(0,0,this.powerupCanvas.width,this.powerupCanvas.height),this.drawPowerups(this.powerups.slowmos,this.scene.camera.zoom,e),this.drawPowerups(this.powerups.checkpoints,this.scene.camera.zoom,e),this.drawPowerups(this.powerups.boosts,this.scene.camera.zoom,e),this.drawPowerups(this.powerups.gravitys,this.scene.camera.zoom,e),this.drawPowerups(this.powerups.bombs,this.scene.camera.zoom,e),this.drawPowerups(this.powerups.goals,this.scene.camera.zoom,e),this.drawPowerups(this.powerups.antigravitys,this.scene.camera.zoom,e),this.drawPowerups(this.powerups.teleports,this.scene.camera.zoom,e),this.drawPowerups(this.powerups.helicopters,this.scene.camera.zoom,e),this.drawPowerups(this.powerups.trucks,this.scene.camera.zoom,e),this.drawPowerups(this.powerups.balloons,this.scene.camera.zoom,e),this.drawPowerups(this.powerups.blobs,this.scene.camera.zoom,e),this.settings.developerMode&&(e.beginPath(),e.strokeStyle="red",e.rect(0,0,this.powerupCanvas.width,this.powerupCanvas.height),e.stroke())}}createCanvas(){if("TrackRenderer"in window)return this.canvas=document.createElement("canvas"),void TrackRenderer.postMessage({type:"CREATE_SECTOR",sector:{column:this.column,row:this.row,size:this.drawSectorSize,x:this.x,y:this.y},physicsLines:this.physicsLines,sceneryLines:this.sceneryLines,settings:{physicsLineColor:this.settings.physicsLineColor,sceneryLineColor:this.settings.sceneryLineColor},zoom:this.scene.camera.zoom});this.canvas=this.canvasPool.getCanvas();let e=this.drawSectorSize*this.scene.camera.zoom|0,t=this.canvas.width!==e||this.canvas.height!==e;this.canvas.width=e,this.canvas.height=e,this.ctx=this.canvas.getContext("2d"),this.ctx.lineCap="round",this.ctx.lineWidth=Math.max(2*this.scene.camera.zoom,.5),!t&&this.ctx.clearRect(0,0,e,e)}cleanSector(){this.cleanSectorType("physicsLines"),this.cleanSectorType("sceneryLines"),this.cleanSectorType("powerups","all"),0===this.powerups.all.length?(this.hasPowerups=!1,this.powerupCanvas&&(this.canvasPool.releaseCanvas(this.powerupCanvas),this.powerupCanvas=null)):this.hasPowerups=!0,this.dirty=!1}cleanSectorType(e,t){let s=this[e];t&&(s=s[t]);for(let e of s.filter((e=>e.remove)))s.splice(s.indexOf(e),1)}draw(){!this.canvas&&this.createCanvas(),"TrackRenderer"in window?TrackRenderer.postMessage({type:"CACHE_SECTOR",sector:{column:this.column,row:this.row,size:this.drawSectorSize,x:this.x,y:this.y},settings:{physicsLineColor:this.settings.physicsLineColor,sceneryLineColor:this.settings.sceneryLineColor},zoom:this.scene.camera.zoom}):(this.ctx.beginPath(),this.ctx.strokeStyle=this.settings.sceneryLineColor,this.drawLines(this.sceneryLines,this.scene.camera.zoom,this.ctx),this.ctx.stroke(),this.ctx.beginPath(),this.ctx.strokeStyle=this.settings.physicsLineColor,this.drawLines(this.physicsLines,this.scene.camera.zoom,this.ctx),this.ctx.stroke(),this.settings.developerMode&&(this.ctx.beginPath(),this.ctx.strokeStyle="blue",this.ctx.rect(0,0,this.canvas.width,this.canvas.height),this.ctx.stroke())),this.drawn=!0}drawLine(e,t){!this.canvas&&this.createCanvas(),this.ctx.beginPath(),this.ctx.strokeStyle=t,this.ctx.moveTo((e.p1.x-this.x)*this.scene.camera.zoom,(e.p1.y-this.y)*this.scene.camera.zoom),this.ctx.lineTo((e.p2.x-this.x)*this.scene.camera.zoom,(e.p2.y-this.y)*this.scene.camera.zoom),this.ctx.stroke()}erase(e,t,s){let i=[];if(!0===s.physics)for(let s of this.physicsLines.filter((s=>s.erase(e,t))))i.push(s);if(!0===s.scenery)for(let s of this.sceneryLines.filter((s=>s.erase(e,t))))i.push(s);if(!0===s.powerups)for(let s of this.powerups.all.map((s=>s.erase(e,t))).filter((e=>e)))i.push(...s);return i}update(){this.realX=this.x*this.camera.zoom|0,this.realY=this.y*this.camera.zoom|0,this.zoom=this.camera.zoom}resetCollided(){let e=this.physicsLines.filter((e=>e.collided));for(let t=e.length-1;t>=0;t--)e[t].collided=!1}collide(e){let t=this.physicsLines.filter((e=>!e.collided));for(let s=t.length-1;s>=0;s--)t[s].remove?this.physicsLines.splice(this.physicsLines.indexOf(t[s]),1):t[s].collide(e);if(e.parent.powerupsEnabled){let t=e.parent.player,s=this.powerups.all.filter((e=>-1===t._powerupsConsumed.misc.indexOf(e.id)));!t.isGhost()&&(s=s.filter((e=>!e.hit)));for(let t=s.length-1;t>=0;t--)s[t].remove?this.powerups.all.splice(this.powerups.all.indexOf(s[t]),1):s[t].collide(e)}}drawLines(e,t,s){for(const{p1:i,p2:a}of e)s.moveTo((i.x-this.x)*t,(i.y-this.y)*t),s.lineTo((a.x-this.x)*t,(a.y-this.y)*t)}drawPowerups(e,t,s){let i=e.reduce(((e,t)=>{let s=e.filter((e=>e.name===t.name&&e.x===t.x&&e.y===t.y));switch(t.prefix){case"B":case"G":s=s.filter((e=>e.angle===t.angle));break;case"C":case"O":case"T":case"V":s=s.filter((e=>e.hit===t.hit))}return s.length>0||e.push(t),e}),[]);for(let a of i)a.remove?e.splice(e.indexOf(a),1):a.draw((a.x-this.x)*t+this.powerupCanvasOffset*t/2,(a.y-this.y)*t+this.powerupCanvasOffset*t/2,t,s)}drawBackground(e,t,s){e.fillStyle=s,e.fillRect(0,0,this.drawSectorSize*t|0,this.drawSectorSize*t|0)}clear(){this.drawn=!1,this.powerupCanvasDrawn=!1,this.canvas&&("TrackRenderer"in window?TrackRenderer.postMessage({type:"CLEAR_SECTOR",sector:{column:this.column,row:this.row}}):(this.canvasPool.releaseCanvas(this.canvas),this.canvas=null,this.ctx=null)),this.powerupCanvas&&(this.canvasPool.releaseCanvas(this.powerupCanvas),this.powerupCanvas=null)}close(){this.track=null,this.scene=null,this.settings=null,this.drawSectorSize=null,this.row=null,this.column=null,this.camera=null,this.zoom=null,this.canvasPool=null,this.x=null,this.y=null,this.realX=null,this.realY=null,this.lineCount=null,this.drawn=null,this.physicsLines=null,this.sceneryLines=null,this.canvas=null,this.ctx=null}},vehiclepowerup=class extends consumable{index=null;prefix="V";stack=[];constructor(e,t,s,i){super(i),this.x=e,this.y=t,this.time=s}draw(e,t,s,i){this.hit||super.draw(e,t,s,i)}drawIcon(){}drawPowerup(){this.drawIcon(...arguments)}getCode(){let e=this.time,t=super.getCode()+" "+this.index+" ",s="";return this.stack.length>0&&(s+=","+this.stack.map((e=>t+e.toString(32))).join(","),e-=this.stack.reduce(((e,t)=>e+t),0)),t+e.toString(32)+s}},balloon=class extends vehiclepowerup{color="#f02728";index=3;name="balloon";collide(e){let t=e.parent,s=t.player,i=e.pos.x-this.x,a=e.pos.y-this.y,o=Math.sqrt(Math.pow(i,2)+Math.pow(a,2)),r=s._powerupsConsumed.misc,n=this.scene;if(30>o&&s.isAlive()&&-1===r.indexOf(this.id)){r.push(this.id);let e=this.time*n.settings.drawFPS;s.setTempVehicle(this.name.toUpperCase(),e,{x:this.x,y:this.y},t.dir),n.camera.playerFocus===s&&(n.camera.focusOnPlayer(),n.vehicleTimer.playerAddedTime(s)),!1===s.isGhost()&&(this.hit=!0,this.sector.powerupCanvasDrawn=!1,this.scene.message.show("Balloon Powerup!",50,this.color))}}drawIcon(e,t){e.scale(t,t),e.beginPath(),e.roundRect(6,23,9,8,1),e.fill(),e.beginPath(),e.arc(10.5,10.5,10.5-e.lineWidth/2,0,2*Math.PI);let s=e.fillStyle;e.fillStyle=this.color,e.fill(),e.fillStyle=s,e.moveTo(15,18.5),e.lineTo(13,24),e.moveTo(8,24),e.lineTo(6,18.5),e.stroke(),e.resetTransform()}updateCache(e,t){let s=super.updateCache(e,t);return e.lineWidth=2,e.strokeStyle=this.outline,e.fillStyle=this.outline,s}static cache=this.createCache({width:21,height:31})},blob=class extends vehiclepowerup{color="#a784c5";index=4;name="blob";collide(e){let t=e.parent,s=t.player,i=e.pos.x-this.x,a=e.pos.y-this.y,o=Math.sqrt(Math.pow(i,2)+Math.pow(a,2)),r=s._powerupsConsumed.misc,n=this.scene;if(30>o&&s.isAlive()&&-1===r.indexOf(this.id)){r.push(this.id);var h=this.time*n.settings.drawFPS;s.setTempVehicle(this.name.toUpperCase(),h,{x:this.x,y:this.y},t.dir),n.camera.playerFocus===s&&(n.camera.focusOnPlayer(),n.vehicleTimer.playerAddedTime(s)),!1===s.isGhost()&&(this.hit=!0,this.sector.powerupCanvasDrawn=!1,this.scene.message.show("Blob Powerup!",50,this.color))}}drawIcon(e,t){e.scale(t,t),e.beginPath(),e.roundRect(1,1,22,22,3.5),e.fill(),e.stroke(),e.resetTransform()}updateCache(e,t){let s=super.updateCache(e,t);return e.strokeStyle=this.outline,e.fillStyle=this.color,e.lineWidth=2,s}static cache=this.createCache({width:24,height:24})},helicopter=class extends vehiclepowerup{color="#f59423";index=1;name="helicopter";collide(e){let t=e.parent,s=t.player,i=e.pos.x-this.x,a=e.pos.y-this.y,o=Math.sqrt(Math.pow(i,2)+Math.pow(a,2)),r=s._powerupsConsumed.misc,n=this.scene;if(30>o&&s.isAlive()&&-1===r.indexOf(this.id)){r.push(this.id);let e=this.time*n.settings.drawFPS;s.setTempVehicle("HELI",e,{x:this.x,y:this.y},t.dir),n.camera.playerFocus===s&&(n.camera.focusOnPlayer(),n.vehicleTimer.playerAddedTime(s)),!1===s.isGhost()&&(this.hit=!0,this.sector.powerupCanvasDrawn=!1,this.scene.message.show("Helicopter Powerup!",50,"#F2902E"))}}drawIcon(e,t){e.scale(t,t),e.beginPath(),e.moveTo(15,4.5),e.lineTo(15,2.5),e.bezierCurveTo(15,1.4,14.1,.5,13,.5),e.bezierCurveTo(11.9,.5,11,1.4,11,2.5),e.lineTo(11,4.5),e.bezierCurveTo(11,5.6,11.9,6.5,13,6.5),e.bezierCurveTo(14.1,6.5,15,5.6,15,4.5),e.lineTo(15,4.5),e.closePath(),e.fill(),e.beginPath(),e.lineCap="round",e.moveTo(1,3),e.lineTo(25,3),e.stroke(),e.lineCap="butt",e.lineWidth=1,e.beginPath(),e.moveTo(6.1,26.9),e.lineTo(4.1,31.9),e.bezierCurveTo(3.8,32.7,4.2,33.6,4.9,33.9),e.bezierCurveTo(5.7,34.2,6.6,33.8,6.9,33),e.lineTo(8.9,28),e.bezierCurveTo(9.2,27.3,8.8,26.4,8,26.1),e.bezierCurveTo(7.3,25.8,6.4,26.1,6.1,26.9),e.lineTo(6.1,26.9),e.closePath(),e.fill(),e.stroke(),e.beginPath(),e.moveTo(17,28),e.lineTo(19,33),e.bezierCurveTo(19.4,33.8,20.3,34.2,21,33.9),e.bezierCurveTo(21.8,33.6,22.2,32.7,21.9,31.9),e.lineTo(19.9,26.9),e.bezierCurveTo(19.6,26.2,18.7,25.8,17.9,26.1),e.bezierCurveTo(17.2,26.4,16.8,27.3,17.1,28),e.lineTo(17,28),e.closePath(),e.fill(),e.stroke();let s=e.fillStyle;e.fillStyle=this.color,e.lineWidth=2,e.beginPath(),e.arc(13,17,11,0,2*Math.PI,!0),e.closePath(),e.fill(),e.stroke(),e.fillStyle=s,e.beginPath(),e.moveTo(21,17),e.bezierCurveTo(21,12.6,17.4,9,13,9),e.bezierCurveTo(8.6,9,5,12.6,5,17),e.lineTo(21,17),e.closePath(),e.fill(),e.resetTransform()}updateCache(e,t){let s=super.updateCache(e,t);return e.lineCap="butt",e.lineJoin="miter",e.lineWidth=2,e.miterLimit=4,e.strokeStyle=this.outline,e.fillStyle=this.outline,s}static cache=this.createCache({width:26,height:35})},truck=class extends vehiclepowerup{color="#94d44e";index=2;name="truck";collide(e){let t=e.parent,s=t.player,i=e.pos.x-this.x,a=e.pos.y-this.y,o=Math.sqrt(Math.pow(i,2)+Math.pow(a,2)),r=s._powerupsConsumed.misc,n=this.scene;if(30>o&&s.isAlive()&&-1===r.indexOf(this.id)){r.push(this.id);let e=this.time*n.settings.drawFPS;s.setTempVehicle(this.name.toUpperCase(),e,{x:this.x,y:this.y},t.dir),n.camera.playerFocus===s&&(n.camera.focusOnPlayer(),n.vehicleTimer.playerAddedTime(s)),!1===s.isGhost()&&(this.hit=!0,this.sector.powerupCanvasDrawn=!1,this.scene.message.show("Truck Powerup!",50,this.color))}}drawIcon(e,t){e.scale(t,t),e.save(),e.beginPath(),e.roundRect(1,16.5,6,10.5,1.5),e.roundRect(18,16.5,6,10.5,1.5),e.fill(),e.moveTo(4,22),e.lineTo(21,22),e.stroke(),e.beginPath(),e.moveTo(23,10),e.bezierCurveTo(23.5,10.5,24,11,24,12),e.lineTo(24,18),e.bezierCurveTo(23.5,19,23.5,20,21,20),e.lineTo(3,20),e.bezierCurveTo(2.5,20,1.5,19.5,1,18.5),e.lineTo(1,12),e.bezierCurveTo(1,11,1.5,10.5,2,10),e.lineTo(2,4),e.bezierCurveTo(2,2,3,1,4,1),e.lineTo(21,1),e.bezierCurveTo(22,1,23,2,23,3),e.closePath();let s=e.fillStyle;e.fillStyle=this.color,e.fill(),e.fillStyle=s,e.stroke(),e.restore(),e.beginPath(),e.rect(5.5,5,14,6),e.fill(),e.stroke(),e.beginPath(),e.arc(5.5,15,1.895,0,2*Math.PI,!0),e.arc(19.5,15,1.895,0,2*Math.PI,!0),e.fill(),e.resetTransform()}updateCache(e,t){let s=super.updateCache(e,t);return e.fillStyle=this.outline,e.strokeStyle=this.outline,e.lineWidth=2,s}static cache=this.createCache({width:25,height:28})},canvaspool=class{canvasPool=[];poolCap=5e3;setToScreen=!0;constructor(e){Object.defineProperty(this,"options",{value:e,writable:!0}),e.screen&&this.update(),e.cap&&(this.setToScreen=!1,this.poolCap=e.cap)}update(){this.setToScreen&&(this.getPoolCapFromScreen(),this.cleanPool())}getPoolCapFromScreen(){let e=this.options,t=e.screen,s=e.camera,i=e.settings;this.poolCap=Math.ceil(t.width/Math.floor(i.drawSectorSize*s.zoom))*Math.ceil(t.height/Math.floor(i.drawSectorSize*s.zoom))+Math.ceil(t.width/Math.floor(i.drawSectorSize*s.zoom))+Math.ceil(t.height/Math.floor(i.drawSectorSize*s.zoom))}getCanvas(){let e=this.canvasPool.pop();return e??=document.createElement("canvas")}releaseCanvas(e){this.canvasPool.length<this.poolCap&&this.canvasPool.push(e)}cleanPool(){this.canvasPool.length>this.poolCap&&(this.canvasPool=this.canvasPool.slice(0,this.poolCap+1))}},track=class{defaultLine={p1:new cartesian(-40,50),p2:new cartesian(40,50)};camera=null;canvasPool=null;settings=null;physicsLines=[];sceneryLines=[];powerups=[];powerupsLookupTable={};targets=[];targetCount=0;sectors={drawSectors:[],physicsSectors:[]};totalSectors=[];allowedVehicles=["MTB","BMX"];dirty=!1;constructor(e){Object.defineProperties(this,{scene:{value:e,writable:!0},game:{value:e.game,writable:!0}}),this.settings=e.game.settings,this.settings.track||(this.settings.track={vehicle:this.settings.startVehicle}),this.camera=e.camera,this.canvasPool=new canvaspool(e),this.createPowerupCache(),"TrackRenderer"in window&&(Object.defineProperty(this,"_boundRenderer",{configurable:!0,value:this._handleRenderer.bind(this),writable:!0}),TrackRenderer.addEventListener("message",this._boundRenderer))}_handleRenderer({data:e}){let t=this.sectors.drawSectors[e.column];if(void 0===t)return;let s=t[e.row];void 0!==s&&(s.initialRender&&e.partial||(!s.initialRender&&!1===e.partial&&(s.initialRender=!0),s.bitmap=e.bitmap,s.canvas=e.bitmap))}createPowerupCache(){let e=this.constructor.powerupCache;e.push(new boost(0,0,0,this)),e.push(new slowmo(0,0,this)),e.push(new bomb(0,0,this)),e.push(new gravity(0,0,0,this)),e.push(new checkpoint(0,0,this)),e.push(new target(0,0,this)),e.push(new antigravity(0,0,this)),e.push(new teleport(0,0,this)),e.push(new helicopter(0,0,0,this)),e.push(new truck(0,0,0,this)),e.push(new balloon(0,0,0,this)),e.push(new blob(0,0,0,this))}updatePowerups(e){if("function"!=typeof e)throw new TypeError("'t' must be of type: function");for(let t of this.constructor.powerupCache)e(t);this.recachePowerups(Math.max(this.camera.zoom,1))}recachePowerups(e){for(const t of this.constructor.powerupCache)t.recache(e)}read(e){var t=e.split("#"),s=t.length>0&&t[0].split(","),i=t.length>1&&t[1].split(","),a=t.length>2&&t[2].split(",");s&&s.length>0&&this.addLines(s,this.addPhysicsLine),i&&i.length>0&&this.addLines(i,this.addSceneryLine),a&&a.length>0&&this.addPowerups(a)}move(e=0,t=0){for(const s in this.physicsLines)this.physicsLines[s].p1.x-=e,this.physicsLines[s].p1.y-=t,this.physicsLines[s].p2.x-=e,this.physicsLines[s].p2.y-=t,this.addPhysicsLineToTrack(this.physicsLines[s]),this.physicsLines.splice(i,1);for(const s in this.sceneryLines)this.sceneryLines[s].p1.x-=e,this.sceneryLines[s].p1.y-=t,this.sceneryLines[s].p2.x-=e,this.sceneryLines[s].p2.y-=t,this.addSceneryLineToTrack(s),this.sceneryLines.splice(i,1);for(const s in this.powerups)this.powerups[s].x-=e,this.powerups[s].y-=t,this.powerups[s].otherPortal&&(this.powerups[s].otherPortal.x-=e,this.powerups[s].otherPortal.y-=t),this.addPowerup(this.powerups[s]),this.powerups.splice(s,1);this.scene.redraw()}addPowerups(e){for(var t=e.length,s=[],i=0;t>i;i++)if((s=e[i].split(" ")).length>=2){for(var a=[],o=s.length,r=1;o>r;r++){var n=parseInt(s[r],32);a.push(n)}var h=Math.round(a[0]),l=Math.round(a[1]),c=null;switch(s[0]){case"B":c=new boost(h,l,a[2],this);break;case"S":c=new slowmo(h,l,this);break;case"O":c=new bomb(h,l,this);break;case"G":c=new gravity(h,l,a[2],this);break;case"C":c=new checkpoint(h,l,this);break;case"T":c=new target(h,l,this),this.addTarget(c);break;case"A":c=new antigravity(h,l,this);break;case"V":var p=a[2],d=a[3],u=this.settings.vehiclePowerup.minTime,m=this.settings.vehiclePowerup.maxTime;switch(d=d||u,d=Math.min(d,m),d=Math.max(d,u),p){case 1:c=new helicopter(h,l,d,this);break;case 2:c=new truck(h,l,d,this);break;case 3:c=new balloon(h,l,d,this);break;case 4:c=new blob(h,l,d,this);break;default:continue}break;case"W":var g=a[0],y=a[1],w=a[2],f=a[3],x=new teleport(g,y,this),v=new teleport(w,f,this);x.addOtherPortalRef(v),v.addOtherPortalRef(x),this.addPowerup(x),this.addPowerup(v);default:continue}this.addPowerup(c)}}addTarget(e){this.dirty=!0,this.targetCount++,this.targets.push(e)}addPowerup(e){if(window.hasOwnProperty("lite")&&lite.storage.get("filterDuplicatePowerups")){let t=this.powerups.filter((t=>t.name===e.name&&t.x==e.x&&t.y==e.y)),s=t.length>0&&t[0];if(t.length>0)switch(e.prefix){case"B":case"G":if(t=t.filter((t=>t.angle==e.angle)),s=t.length>0&&t[0],t.length<1)break;return s.multiplier++,s;case"V":case"W":break;case"T":this.dirty=!0,this.targets.pop();default:return s.multiplier++,s}}this.addRef(e.x,e.y,e,this.constructor.types.POWERUPS,this.sectors.physicsSectors,this.settings.physicsSectorSize);let t=this.addRef(e.x,e.y,e,this.constructor.types.POWERUPS,this.sectors.drawSectors,this.settings.drawSectorSize);return!1!==t&&this.totalSectors.push(t),null!==e&&(this.powerups.push(e),e.id&&(this.powerupsLookupTable[e.id]=e)),e}addLines(e,t){for(let s=e.length,i=0;s>i;i++){let s=e[i].split(" "),a=s.length;if(a>3)for(let e=0;a-2>e;e+=2){let i=parseInt(s[e],32),a=parseInt(s[e+1],32),o=parseInt(s[e+2],32),r=parseInt(s[e+3],32);isNaN(i+a+o+r)||t.call(this,i,a,o,r)}}}addPhysicsLine(e,t,s,i){if(Math.sqrt(Math.pow(Math.round(s)-Math.round(e),2)+Math.pow(Math.round(i)-Math.round(t),2))>=2)return this.addPhysicsLineToTrack(new physicsline(Math.round(e),Math.round(t),Math.round(s),Math.round(i)))}addPhysicsLineToTrack(e){for(let t=bresenham(e.p1.x,e.p1.y,e.p2.x,e.p2.y,this.settings.drawSectorSize,!0),s=0;t.length>s;s+=2){let i=this.addRef(t[s],t[s+1],e,this.constructor.types.LINE,this.sectors.drawSectors,this.settings.drawSectorSize);!1!==i&&this.totalSectors.push(i)}for(let t=bresenham(e.p1.x,e.p1.y,e.p2.x,e.p2.y,this.settings.physicsSectorSize),s=0;t.length>s;s+=2)this.addRef(t[s],t[s+1],e,this.constructor.types.LINE,this.sectors.physicsSectors,this.settings.physicsSectorSize);return this.physicsLines.push(e),e}addSceneryLine(e,t,s,i){if(Math.sqrt(Math.pow(Math.round(s)-Math.round(e),2)+Math.pow(Math.round(i)-Math.round(t),2))>=2)return this.addSceneryLineToTrack(new sceneryline(Math.round(e),Math.round(t),Math.round(s),Math.round(i)))}addSceneryLineToTrack(e){for(let t=this.settings.drawSectorSize,s=e.p1,i=e.p2,a=bresenham(s.x,s.y,i.x,i.y,t,!0),o=this.sectors.drawSectors,r=a.length,n=0;r>n;n+=2){let s=this.addRef(a[n],a[n+1],e,this.constructor.types.LINE,o,t);!1!==s&&this.totalSectors.push(s)}return this.sceneryLines.push(e),e}addRef(e,t,s,i,a,o){let r=Math.floor(e/o),n=Math.floor(t/o),h=!1;if(void 0===a[r]&&(a[r]=[]),void 0===a[r][n]){let e=new sector(r,n,this);a[r][n]=e,h=e}switch(i){case this.constructor.types.LINE:a[r][n].addLine(s),s.addSectorReference(a[r][n]);break;case this.constructor.types.POWERUPS:a[r][n].addPowerup(s),s.addSectorReference(a[r][n])}return this.dirty=!0,h}cleanTrack(){this.cleanLines(),this.cleanPowerups()}cleanLines(){let e=this.physicsLines,t=this.sceneryLines;for(let t of e.filter((e=>e.remove)))e.splice(e.indexOf(t),1);for(let e of t.filter((e=>e.remove)))t.splice(t.indexOf(e),1)}cleanPowerups(){let e=this.powerups,t=this.targets;for(let t of e.filter((e=>e.remove)))e.splice(e.indexOf(t),1);for(let e of t.filter((e=>e.remove)))t.splice(t.indexOf(e),1);this.targetCount=this.targets.length}updatePowerupState(e){this.resetPowerups(),this.setPowerupStates(e._powerupsConsumed.targets),this.setPowerupStates(e._powerupsConsumed.checkpoints),this.setPowerupStates(e._powerupsConsumed.misc)}setPowerupStates(e){for(let t of e)this.powerupsLookupTable[t].remove&&this.powerupsLookupTable[t].id&&(delete this.powerupsLookupTable[t],delete e[t]),this.powerupsLookupTable[t].hit=!0,this.powerupsLookupTable[t].sector.powerupCanvasDrawn=!1}select(e,t){const s=[];let i=new cartesian(Math.min(e.x,t.x),Math.min(e.y,t.y)),a=new cartesian(Math.max(e.x,t.x),Math.max(e.y,t.y));for(const e of[...this.physicsLines,...this.sceneryLines,...this.powerups].filter((e=>!e.remove)))e.p1&&e.p2?(e.p1.x>i.x&&e.p1.y>i.y||e.p2.x>i.x&&e.p2.y>i.y)&&(e.p1.x<a.x&&e.p1.y<a.y||e.p2.x<a.x&&e.p2.y<a.y)&&s.push(e):e.x>i.x&&e.y>i.y&&e.x<a.x&&e.y<a.y&&s.push(e);return s}getCode(){this.cleanTrack();var e=this.powerups,t=this.physicsLines,s=this.sceneryLines,i="";if(t.length>0){for(var a of t)a.recorded||(i+=a.p1.x.toString(32)+" "+a.p1.y.toString(32)+a.getCode(this)+",");for(var a of(i=i.slice(0,-1),t))a.recorded=!1}if(i+="#",s.length>0){for(var o of s)o.recorded||(i+=o.p1.x.toString(32)+" "+o.p1.y.toString(32)+o.getCode(this)+",");for(var o of(i=i.slice(0,-1),s))o.recorded=!1}if(i+="#",e.length>0){for(var r of e.map((e=>e.getCode())).filter((e=>e)))i+=r+",";i=i.slice(0,-1)}return i}resetPowerups(){for(let e of this.powerups.filter((e=>e.hit&&!e.remove)))e.sector.powerupCanvasDrawn=e.hit=!1}addDefaultLine(){this.addPhysicsLine(this.defaultLine.p1.x,this.defaultLine.p1.y,this.defaultLine.p2.x,this.defaultLine.p2.y)}erase(e,t,s){this.dirty=!0;for(var i=Math.floor(Math.min(e.x-t,e.x+t)/this.settings.drawSectorSize),a=[];Math.floor(Math.max(e.x-t,e.x+t)/this.settings.drawSectorSize)>=i;i++)for(var o=Math.floor(Math.min(e.y-t,e.y+t)/this.settings.drawSectorSize);Math.floor(Math.max(e.y-t,e.y+t)/this.settings.drawSectorSize)>=o;o++)this.sectors.drawSectors[i]&&this.sectors.drawSectors[i][o]&&a.push(this.sectors.drawSectors[i][o].erase(e,t,s));return a.flat()}drawAndCache(){for(var e=performance.now(),t=this.totalSectors,s=t.length,i=0;s>i;i++)!function(e){setTimeout((function(){e.draw(),e.cacheAsImage()}),250*i)}(t[i]);let a=performance.now();console.log("Track :: Time to draw entire track : "+(a-e)+"ms")}undraw(){for(let e of this.totalSectors.filter((e=>e.drawn)))e.clear(!0);this.recachePowerups(Math.max(this.camera.zoom,1)),this.canvasPool.update()}collide(e){let t=Math.floor(e.pos.x/this.settings.physicsSectorSize-.5),s=Math.floor(e.pos.y/this.settings.physicsSectorSize-.5);this.sectors.physicsSectors[t]&&this.sectors.physicsSectors[t][s]&&this.sectors.physicsSectors[t][s].resetCollided(),this.sectors.physicsSectors[t+1]&&this.sectors.physicsSectors[t+1][s]&&this.sectors.physicsSectors[t+1][s].resetCollided(),this.sectors.physicsSectors[t+1]&&this.sectors.physicsSectors[t+1][s+1]&&this.sectors.physicsSectors[t+1][s+1].resetCollided(),this.sectors.physicsSectors[t]&&this.sectors.physicsSectors[t][s+1]&&this.sectors.physicsSectors[t][s+1].resetCollided(),this.sectors.physicsSectors[t]&&this.sectors.physicsSectors[t][s]&&this.sectors.physicsSectors[t][s].collide(e),this.sectors.physicsSectors[t+1]&&this.sectors.physicsSectors[t+1][s]&&this.sectors.physicsSectors[t+1][s].collide(e),this.sectors.physicsSectors[t+1]&&this.sectors.physicsSectors[t+1][s+1]&&this.sectors.physicsSectors[t+1][s+1].collide(e),this.sectors.physicsSectors[t]&&this.sectors.physicsSectors[t][s+1]&&this.sectors.physicsSectors[t][s+1].collide(e)}getDrawSector(e,t){let s=Math.floor(e/this.settings.drawSectorSize),i=Math.floor(t/this.settings.drawSectorSize);return void 0!==this.sectors.drawSectors[s]&&void 0!==this.sectors.drawSectors[s][i]&&this.sectors.drawSectors[s][i]}draw(e){const t=this.scene,s=t.camera,i=this.settings,a=i.drawSectorSize*s.zoom,o=s.position.x/i.drawSectorSize+t.screen.width/(2*a)|0,r=s.position.y/i.drawSectorSize+t.screen.height/(2*a)|0,n=s.position.x/i.drawSectorSize-t.screen.width/(2*a)-1|0,h=s.position.y/i.drawSectorSize-t.screen.height/(2*a)-1|0;for(const l of this.totalSectors)if(l.dirty&&l.cleanSector(),l.column>=n&&o>=l.column&&l.row>=h&&r>=l.row){!1===l.drawn&&l.draw(),l.hasPowerups&&(l.powerupCanvasDrawn||l.cachePowerupSector());let o=(l.column*i.drawSectorSize-s.position.x)*s.zoom+t.screen.center.x|0,r=(l.row*i.drawSectorSize-s.position.y)*s.zoom+t.screen.center.y|0;if(e.drawImage(l.canvas,o,r,a,a),l.hasPowerups&&l.powerupCanvasDrawn){const t=(i.drawSectorSize+l.powerupCanvasOffset)*s.zoom;e.drawImage(l.powerupCanvas,o-l.powerupCanvasOffset*s.zoom/2,r-l.powerupCanvasOffset*s.zoom/2,t,t)}}else l.drawn&&l.clear()}closeSectors(){for(const e of this.totalSectors)e.close()}close(){"TrackRenderer"in window&&(TrackRenderer.removeEventListener("message",this._boundRenderer),delete this._boundRenderer),this.scene=null,this.closeSectors(),this.totalSectors=null,this.canvasPool=null,this.sectors=null,this.physicsLines=null,this.sceneryLines=null,this.powerups=null,this.camera=null}static powerupCache=[];static types={LINE:1,POWERUPS:2}},loadingcircle=class{scene=null;clockwise=!1;screen=null;settings={radius:10,color:"#1884cf"};constructor(e){this.scene=e,this.screen=e.screen}draw(e){let t=this.screen,s=this.settings,i=this.scene.game.pixelRatio,a=s.radius,o=performance.now()/60%30/30*2*Math.PI;0===o&&(this.clockwise=!this.clockwise);let r=t.width-25*i,n=t.height-25*i;e.beginPath(),e.arc(r,n,a*i,0,o,!this.clockwise),e.lineWidth=3*i,e.strokeStyle=s.color,e.stroke()}},messagemanager=class{color="#000";message=null;timeout=!1;constructor(e){Object.defineProperty(this,"scene",{value:e,writable:!0})}draw(e){let t=this.message,s=this.timeout,i=this.color,a=this.outline;if(!1!==s&&0>=s&&(t=!1),this.scene.state.paused&&(i=!1,a=!1,t="Paused - Press Spacebar to Continue"),!1===i&&(i=this.scene.settings.UITextColor),t){let s=this.scene.game,o=this.scene,r=s.pixelRatio,n=o.screen.center.x,h=100;e.save(),e.fillStyle=i,e.lineWidth=r/2*4,e.font=12*r+"pt helsinki",e.textAlign="center",a&&(e.strokeStyle=a,e.strokeText(t,n,h*r)),e.fillText(t,n,h*r),e.restore()}}show(e,t,s,i){this.hide(),this.message=e,this.timeout=t,s&&(this.color=s),i&&(this.outline=i)}hide(){this.message=null,this.color=!1,this.outline=!1}update(){!1!==this.timeout&&this.timeout--}};var component=__webpack_require__(459);const container=class extends component.A{children=[];gap=0;inline=null;constructor(e,t){super(e,t),Object.assign(this,e);for(let e of this.children)e.container=this}_applyProperties(...e){for(let t in e)this.padding&&(e[t]+=2*this.padding);return e.length>0?e:e[0]}_caclulateActual(e){let t=super._caclulateActual(...arguments);if(this.children.length>0&&this.overflow){let s=0,i="height"===e?"y":"x";if("x"===i&&this.inline)for(let t of this.children)s+=t._calculateInheritance(i)*t._calculateScale(i)+t._caclulateActual(e),this.gap&&0<this.children.indexOf(t)&&(s+=this.gap);else for(let t of this.children)s=Math.max(s,t._calculateInheritance(i)*t._calculateScale(i)+t._caclulateActual(e));t=Math.max(t,s)}return t}addChild(){let e=arguments,t=this.children;for(let t of e)t.container=this;return t.push(...Array.prototype.filter.call(e,(e=>-1===t.indexOf(e)))),e}cache(e=window.devicePixelRatio){if(!this.cached){let t=(this.createCanvas(),this.canvas.getContext("2d"));super.cache.call(this,e),t.imageSmoothingEnabled=!1;for(let s in this.children){let i=this.children[s],a=Boolean(this.inline),o=this.children.slice(0,s),r=o.reduce(((e,t)=>e+((t.image?t.width:t.actualWidth)+t.x)),0)*e;o.reduce(((e,t)=>e+((t.image?t.height:t.actualHeight)+t.y)),0),i.cached||i.cache(e),i.draw(t,a&&r+(s>0&&this.gap),0)}this.cached=!0}}draw(e,t=0,s=0){if(!this.visible)return;let i=window.devicePixelRatio;this.cached||this.cache(i);let a=this.canvas,o=1!==this.scale.x&&a.width-this._calculateInheritance("width"),r=1!==this.scale.y&&a.height-this._calculateInheritance("height");"left"!==this.horizontalAlign&&(o/=2),"bottom"!==this.verticalAlign&&(r/=2),a.width>0&&a.height>0&&e.drawImage(a,t+(this.x-o)*i,s+(this.y-r)*i,a.width,a.height)}setDirty(){super.setDirty();for(let e of this.children.filter((e=>!e.image)))e.setDirty()}},gui=class{cached=!1;canvas=null;container=new container;enabled=!0;constructor(e,t){Object.defineProperty(this,"scene",{value:e,writable:!0}),Object.assign(this.container,t)}draw(e){this.enabled&&this.container.draw(e)}redraw(){this.container.setDirty()}resize(){this.redraw()}update(){let e=this.container;e.cached||=-1===e.children.findIndex((e=>!e.cached))}};function formatnumber(e){let t=(e=parseInt(e,10))%6e4/1e3;return Math.floor(e/6e4)+":"+t.toFixed(2).padStart(5,0)}const score=class extends gui{paused=!1;sprites={};spriteSheet={timer:[2,2,58,58],timer_paused:[2,62,116,118],target:[2,2,58,58]};time=new component.A({text:"0:00.00",font:{size:16},x:23,y:7},this.container);time_title=new component.A({text:"TIME:",color:"#999",x:24,y:2},this.container);timer_sprite=new component.A({cached:!0,image:{x:2,y:2,width:58,height:58},width:24,height:24},this.container);best_time=new component.A({text:"-- : --.--",color:"#999",font:{size:14},x:95,y:8},this.container);best_time_title=new component.A({text:"BEST:",color:"#999",x:96,y:2},this.container);goals=new component.A({text:"0/0",font:{size:16},x:185,y:6},this.container);target_sprite=new component.A({cached:!0,image:{x:2,y:2,width:58,height:58},x:160,width:24,height:24},this.container);constructor(e){super(e,{font:{size:8},x:6,y:4}),this.sprites.timer=e.assets.getResult("time_icon"),this.sprites.target=e.assets.getResult("targets_icon"),this.timer_sprite.image.canvas=this.sprites.timer,this.target_sprite.image.canvas=this.sprites.target,"Editor"===GameManager.scene&&(this.best_time.visible=!1,this.best_time_title.visible=!1)}update(){let e=this.scene,t=e.state.paused,s=formatnumber(1e3*((null!==e.camera.playerFocus&&e.camera.playerFocus._gamepad.playbackTicks||null)??e.ticks)/e.settings.drawFPS),i=(e.camera.playerFocus||e.playerManager.firstPlayer).getTargetsHit()+"/"+e.track.targetCount,a=e.settings.isCampaign&&e.settings.campaignData.user.best_time||e.settings.userTrackStats&&e.settings.userTrackStats.best_time;this.paused!==t&&(this.timer_sprite.image.y=t?62:2,this.container.cached=!1,this.paused=t),this.time.text!==s&&(this.time.text=s,this.time.setDirty()),this.goals.text!==i&&(this.goals.text=i,this.goals.setDirty()),a&&this.best_time.text!==a&&(this.best_time.text=a,this.best_time.setDirty())}centerContainer(){let e=this.container,t=e.width,s=this.scene.screen;e.x=s.width/2/window.devicePixelRatio-t/2,e.y=10}},mousehandler=class{enabled=!0;touch=null;touches=[];updateCallback=!1;wheel=!1;mousewheel=!1;throttledMouseWheel=null;constructor(e){Object.defineProperty(this,"scene",{value:e||null,writable:!0}),this.touch=this.getTouchObject(),this.touch.old=this.getTouchObject(),this.secondaryTouch=this.getTouchObject(),this.secondaryTouch.old=this.getTouchObject(),!1!==e.settings.analyticsEnabled&&this.initAnalytics(),this.bindToMouseEvents()}initAnalytics(){Object.defineProperty(this,"analytics",{value:{clicks:0},writable:!0})}getTouchObject(){return{id:null,down:!1,press:!1,release:!1,pos:new cartesian(0,0),real:new cartesian(0,0),type:1}}bindToMouseEvents(){let e=this.scene.game.canvas,t=this.onMouseMove.bind(this),s=this.onMouseDown.bind(this),i=this.onMouseUp.bind(this);e.addEventListener("pointermove",t,{passive:!0}),e.addEventListener("pointerdown",s,{passive:!0}),e.addEventListener("pointerup",i,{passive:!0}),Object.defineProperties(this,{_moveListener:{value:t,writable:!0},_upListener:{value:i,writable:!0},_downListener:{value:s,writable:!0}});let a=this.onMouseWheel.bind(this);e.addEventListener("mousewheel",a),e.addEventListener("wheel",a),Object.defineProperty(this,"_wheelListener",{value:a,writable:!0})}contextMenuHandler(e){return e.stopPropagation(),e.preventDefault(),!1}disableContextMenu(){this.scene.game.canvas.oncontextmenu=function(){return!1}}onMouseDown(e){this.scene.game.canvas.setPointerCapture(e.pointerId),this.analytics&&this.analytics.clicks++,2===e.button?!1===this.secondaryTouch.down&&(this.updatePosition(e,this.secondaryTouch),this.secondaryTouch.down=!0):!1===this.touch.down&&(this.updatePosition(e,this.touch),this.touch.down=!0,this.scene.redrawControls())}onMouseMove(e){this.updatePosition(e,this.touch),this.scene.redrawControls(),this.updatePosition(e,this.secondaryTouch)}onMouseUp(e){this.scene.game.canvas.releasePointerCapture(e.pointerId),2===e.button?!0===this.secondaryTouch.down&&(this.updatePosition(e,this.secondaryTouch),this.secondaryTouch.down=!1):!0===this.touch.down&&(this.updatePosition(e,this.touch),this.scene.interactWithControls(),this.touch.down=!1,this.scene.redrawControls())}onMouseWheel(e){e.preventDefault(),e.stopPropagation();let t=Math.max(-1,Math.min(1,-e.deltaY||-e.detail));return 0==t&&(t=Math.max(-1,Math.min(1,e.deltaX||-e.detail))),this.wheel=t,!1}update(){this.enabled&&(this.updateTouch(this.touch),this.updateTouch(this.secondaryTouch),this.updateWheel())}updatePosition(e,t){t.id=e.pointerId,t.type=e.button;let s=t.pos;s.x=e.offsetX*window.devicePixelRatio,s.y=e.offsetY*window.devicePixelRatio,this.updateRealPosition(t)}updateRealPosition(e){let t=e.real;if(t.x=Math.round((e.pos.x-this.scene.screen.center.x)/this.scene.camera.zoom+this.scene.camera.position.x),t.y=Math.round((e.pos.y-this.scene.screen.center.y)/this.scene.camera.zoom+this.scene.camera.position.y),this.scene.toolHandler.options.grid){let e=0|this.scene.settings.toolHandler.gridSize;if(lite.storage.get("isometricGrid")){const s=(e,t)=>(e%t+t)%t;let i=e/2,a=Math.round(t.x/e),o=s(a,2);t.x=a*e,t.y=t.y-s(t.y+i*(o+1),e)-i*(o-1)+o*i}else t.x=Math.round(t.x/e)*e,t.y=Math.round(t.y/e)*e}this.updateCallback=!0}updateTouch(e){e.old.pos.x=e.pos.x,e.old.pos.y=e.pos.y,e.old.real.x=e.real.x,e.old.real.y=e.real.y,!e.old.down&&e.down&&(e.press=!0),e.old.down&&!e.down&&(e.release=!0),e.old.press&&(e.press=!1),e.old.release&&(e.release=!1),this.updateRealPosition(e),e.old.down=e.down,e.old.press=e.press,e.old.release=e.release}updateWheel(){this.mousewheel=this.wheel,this.wheel=!1}close(){let e=this.scene.game.canvas;e.removeEventListener("mousewheel",this._wheelListener),e.removeEventListener("wheel",this._wheelListener),this.touches=null,this.touch=null,this.scene=null,this.wheel=null,this._moveListener=null,this._downListener=null,this._upListener=null,this._wheelListener=null}},soundmanager=class{muted=!1;sounds=new Map;volume=1;constructor(e){Object.defineProperty(this,"scene",{value:e||null,writable:!0}),this.muted=!1!==e.settings.soundsEnabled,Number.isFinite(e.settings.volume)&&(this.volume=e.settings.volume)}update(){let e=this.scene,t=e.settings,s=e.state.paused||!e.state.playing;this.muted=s||!1===t.soundsEnabled,this.volume!==t.volume&&Number.isFinite(t.volume)&&(this.volume=t.volume);for(let e of this.sounds.values())e.muted=this.muted,e.paused&&!s?e.play().catch((()=>!1)):!e.paused&&s&&e.pause(),this.scene.game.emit(this.scene.game.constructor.Events.SoundUpdate,e)}setVolume(e,t){const s=this.sounds.get(e);s&&(s.volume=(t??1)*this.volume)}mute_all(){for(let e of this.sounds.values())e.muted=!0;this.muted=!0}stop_all(){for(let e in this.sounds)this.stop(e)}play(e,t){if(this.scene.settings.soundsEnabled){if(!this.sounds.has(e)){const t=this.scene.assets.getItem(e),s=t&&this.constructor.play(t);s&&(this.sounds.set(e,s),this.scene.game.emit(this.scene.game.constructor.Events.SoundCreate,s),s.addEventListener("ended",(()=>this.sounds&&this.sounds.delete(e)),{passive:!0}))}this.setVolume(e,t)}}stop(e){const t=this.sounds.get(e);t&&(t.pause(),this.scene.game.emit(this.scene.game.constructor.Events.SoundDelete,t),this.sounds.delete(e))}close(){this.sounds=null}static play(e){if("object"!=typeof e||null===e)throw new TypeError("First positional argument: asset must be of type: object");return new Audio(e.src)}};class Tool{toolhandler=null;camera=null;mouse=null;name="";scene=null;constructor(e){this.toolhandler=e,this.scene=e.scene,this.game=e.scene.game,this.camera=e.scene.camera,this.mouse=e.scene.mouse,this.gamepad=e.gamepad}checkKeys(){let e=this.gamepad,t=this.toolhandler.constructor.parseToolName(this.constructor.name),s=this.toolhandler;e.isButtonDown(t)&&(s.setTool(t),e.setButtonUp(t))}draw(e){let t=this.toolhandler,s=t.gamepad,i=t.tools.select;i&&(s.isButtonDown("ctrl")||i.selectedElements.length>0)&&i.draw(e)}getOptions(){return this.options||{}}press(){}hold(){}release(){}reset(){}update(){let e=this.mouse,t=e.touch,s=e.secondaryTouch,i=this.toolhandler.gamepad,a=this.toolhandler.options,o=i.isButtonDown("shift"),r=i.isButtonDown("ctrl");a.rightClickMove&&(o=s.old.down),o?(t.old.down||a.rightClickMove)&&this.moveCamera():!this.toolhandler.tools[this.toolhandler.currentTool].active&&r?this.selectArea(t):(t.press&&this.press(),t.old.down&&this.hold(),t.release&&this.release()),!1!==e.mousewheel&&!1===o&&this.mousewheel(e.mousewheel)}moveCamera(){return this.toolhandler.tools.camera.hold()}mousewheel(e){let t=this.scene.settings,s=this.scene.game.pixelRatio,i=t.cameraSensitivity,a=t.cameraZoomMin,o=t.cameraZoomMax,r=a*s,n=o*s,h=this.camera,l=this.mouse.touch,c=h.desiredZoom;c+=e*i,h.setZoom(c/s,l.pos),h.desiredZoom<r?h.setZoom(a,l.pos):h.desiredZoom>n&&h.setZoom(o,l.pos)}selectArea(e){let t=this.toolhandler.tools.select;t&&(e.press&&t.press(),e.old.down&&t.hold(),e.release&&t.release())}close(){this.camera=null,this.mouse=null,this.scene=null,this.toolhandler=null}}class Camera extends Tool{name="camera";hold(){let e=this.mouse.touch,t=e.pos,s=this.camera,i=e.old.pos.sub(t).factor(1/s.zoom);s.position.inc(i)}}const toolhandler=class{currentTool="";scene=null;camera=null;mouse=null;tools={};gamepad=null;gridCache=!1;gridCacheAlpha=1;gridUseEnabled=!1;snapPoint=!1;previousTool="";options=null;constructor(e){this.scene=e,this.camera=e.camera,this.mouse=e.mouse,this.mouse.updateCallback=this.draw.bind(this),this.gamepad=e.playerManager.firstPlayer.getGamepad(),this.options=e.settings.toolHandler,this.snapPoint=new cartesian,this.snapPoint.equ(this.scene.track.defaultLine.p2),!1!==e.settings.analyticsEnabled&&this.initAnalytics(),this.actionTimeline=[],this.actionTimelineMax=50,this.actionTimelinePointer=0}initAnalytics(){Object.defineProperty(this,"analytics",{value:{actions:0},writable:!0})}enableGridUse(){this.gridUseEnabled=!0}getToolOptions(){return this.tools[this.currentTool].getOptions()}setToolOption(e,t,s){void 0!==s&&void 0!==this.tools[s]?this.tools[s].setOption(e,t):this.tools[this.currentTool].setOption(e,t),this.scene.updateState()}registerTool(e){e=new e(this),this.tools[this.constructor.parseToolName(e.name)]=e}setTool(e){e=this.constructor.parseToolName(e),this.currentTool!==e&&this.tools.hasOwnProperty(e)&&(this.resetTool(),this.previousTool=this.currentTool,this.currentTool=e,this.scene.updateState(),this.analytics&&this.analytics.actions++)}addActionToTimeline(e){this.actionTimeline.length>=this.actionTimelineMax&&(this.actionTimeline.splice(0,this.actionTimeline.length-this.actionTimelineMax),this.actionTimelinePointer=this.actionTimelineMax),this.actionTimeline.splice(this.actionTimelinePointer),this.actionTimeline.push(e),this.actionTimelinePointer++}revertAction(){let e=this.actionTimelinePointer;if(e>0){let t=this.actionTimeline[e-1];switch(e--,t.type){case"add":this.removeObjects(t.objects);break;case"remove":this.addObjects(t.objects)}this.actionTimelinePointer=e}}applyAction(){let e=this.actionTimeline,t=this.actionTimelinePointer;if(t<e.length){let e=this.actionTimeline[t];switch(t++,e.type){case"add":this.addObjects(e.objects);break;case"remove":this.removeObjects(e.objects)}this.actionTimelinePointer=t}}removeObjects(e){for(let t=0;t<e.length;t++){let s=e[t];s.remove=!0,s.removeAllReferences()}this.scene.track.cleanTrack()}addObjects(e){for(let t=e.length,s=this.scene.track,i=0;t>i;i++){let t=e[i];t instanceof physicsline?(t.remove=!1,s.addPhysicsLineToTrack(t)):t instanceof sceneryline?(t.remove=!1,s.addSceneryLineToTrack(t)):t instanceof target?(t.remove=!1,s.addTarget(t),s.addPowerup(t)):(t.remove=!1,s.addPowerup(t))}}resetTool(){""!==this.currentTool&&this.tools[this.currentTool].reset()}update(){this.checkGrid(),this.mouse.enabled&&this.tools[this.currentTool].update(),this.checkHotkeys(),this.checkMouse(),this.checkSnap()}checkGrid(){let e=this.scene.camera;e.zoom!==e.desiredZoom&&(this.gridCache=!1)}checkSnap(){this.options.snapLocked&&(this.options.snap=!0)}moveCameraTowardsMouse(){if(!1===this.options.cameraLocked){let e=this.scene.screen,t=100,s=e.height-t,i=0+t,a=e.width-t,o=0+t,r=this.options.cameraMoveSpeed,n=e.center,h=this.camera,l=this.mouse.touch,c=l.pos.x,p=l.pos.y,d=.8*(c-n.x),u=p-n.y;(c>=a||o>=c||p>=s||i>=p)&&(h.position.x+=d*r*(1/h.zoom),h.position.y+=u*r*(1/h.zoom))}}checkMouse(){let e=this.mouse.touch,t=this.mouse.secondaryTouch;(e.press||t.press)&&this.press()}press(){this.camera.unfocus()}checkHotkeys(){let e=this.gamepad,t=this.options.snap,s=this.options.snapLocked,i=this.options.rightClickMove,a=e.isButtonDown("alt");i&&(a=e.isButtonDown("shift")),a&&!t?this.toggleQuickSnap():a||!t||s||this.toggleQuickSnap(),e.isButtonDown("ctrl")&&e.isButtonDown("z")&&(e.setButtonUp("z"),this[(e.isButtonDown("shift")?"apply":"revert")+"Action"]()),e.isButtonDown("ctrl")&&e.isButtonDown("y")&&(e.setButtonUp("y"),this.applyAction());let o=this.tools;for(let e in o)o[e].checkKeys();this.gridUseEnabled&&e.isButtonDown("grid")&&(e.setButtonUp("grid"),this.toggleGrid()),e.isButtonDown("zoom_increase")&&(e.setButtonUp("zoom_increase"),this.scene.camera.increaseZoom()),e.isButtonDown("zoom_decrease")&&(e.setButtonUp("zoom_decrease"),this.scene.camera.decreaseZoom()),e.isButtonDown("zoom_100")&&(e.setButtonUp("zoom_100"),this.scene.camera.resetZoom()),e.isButtonDown("lineType")&&(e.setButtonUp("lineType"),this.toggleLineType())}toggleLineType(){let e=this.options.lineType;this.options.lineType="physics"===e?"scenery":"physics",this.scene.updateState()}toggleGrid(){this.options.grid=this.scene.state.grid=!this.options.grid,this.scene.updateState()}toggleSnap(){this.options.snap=!this.options.snap,this.options.snapLocked=!this.options.snapLocked,this.resetTool(),this.scene.updateState()}toggleQuickSnap(){this.options.snapLocked||(this.options.snap=!this.options.snap,this.resetTool(),this.scene.updateState())}toggleCameraLock(){this.options.cameraLocked=!this.options.cameraLocked,this.scene.updateState()}draw(e){this.mouse.enabled&&this.tools[this.currentTool].draw(e)}drawGrid(e){let t=this.scene.game.pixelRatio;!0===this.options.grid&&this.options.visibleGrid&&this.drawCachedGrid(e,t)}drawCachedGrid(e,t){!1===this.gridCache&&this.cacheGrid(t);let s=this.gridCache,i=s.width,a=s.height,o=this.scene.screen.center,r=2+(o.x/i|0),n=2+(o.y/a|0),h=this.camera.zoom,l=this.camera.position.x*h%i,c=this.camera.position.y*h%a;e.globalAlpha=this.gridCacheAlpha;for(var p=-r;r>p;p++)for(var d=-n;n>d;d++){var u=p*i-l+o.x,m=d*a-c+o.y;e.drawImage(s,0,0,a,i,u,m,i,a)}e.globalAlpha=1}cacheGrid(){if(window.lite&&lite.storage.get("isometricGrid"))return this.cacheIsometricGrid();let e=this.scene.camera.zoom,t=200*e,s=200*e,i=this.options.gridSize*e,a=document.createElement("canvas");a.width=t,a.height=s;let o=a.getContext("2d");o.strokeStyle=this.options.gridMinorLineColor,o.strokeWidth=1*window.devicePixelRatio,o.beginPath();let r=null,n=null,h=null,l=null;for(r=Math.floor(t/i),n=0;r>=n;n++)h=n*i,o.moveTo(h,0),o.lineTo(h,s);for(r=Math.floor(s/i),n=0;r>=n;n++)l=n*i,o.moveTo(0,l),o.lineTo(t,l);o.stroke(),o.beginPath(),o.rect(0,0,t,s),o.lineWidth=2*window.devicePixelRatio,o.strokeStyle=this.options.gridMajorLineColor,o.stroke(),this.gridCache=a,this.gridCacheAlpha=Math.min(e+.2,1)}cacheIsometricGrid(){let e=this.scene.camera.zoom,t=200*e,s=200*e,i=this.options.gridSize*e,a=document.createElement("canvas");a.width=t,a.height=s;let o=a.getContext("2d");o.fillStyle=this.options.gridMinorLineColor;for(let a=Math.floor(t/i),r=0;a>=r;r++)for(let t=Math.floor(s/i),a=0;t>=a;a+=.5)o.beginPath(),o.arc(2*a*i,(r+a%1)*i,1*e,0,2*Math.PI),o.fill();this.gridCache=a,this.gridCacheAlpha=Math.min(e+.2,1)}resize(){let e=this.scene.game.pixelRatio;this.cacheGrid(e)}undo(){}redo(){}close(){this.actionTimeline=[],this.actionTimelinePointer=0,this.tools=null,this.mouse=null,this.scene=null,this.camera=null,this.options.grid=!1,this.options=null,this.gridCache=null}static parseToolName(e){return"object"==typeof e&&null!=e&&(e=e.name),e.toLowerCase().replace(/tool$/i,"")}},vehicletimer=class{settings=null;container={borderRadius:25,font:17.5,text:"00:00",scaleX:window.devicePixelRatio/2,scaleY:window.devicePixelRatio/2,width:200,height:60,x:100,y:30};constructor(e){Object.defineProperty(this,"scene",{value:e,writable:!0}),this.settings=e.settings,this.removePlayer(),this.createPulseTween()}setPlayer(e){this.player=e}removePlayer(){this.player=!1}playerAddedTime(e){this.player===e&&this.createPulseTween()}createPulseTween(){let e=this.scene.game.pixelRatio/2;this.tweenRemaining=200,this.tweenStart=e,this.tweenScale=1.2*e}center_container(){let e=this.scene.screen,t=this.container;t.x=e.width/2-100*t.scaleX,t.y=e.height-100*t.scaleY}draw(e){e.save(),e.fillStyle="rgba(242,144,66,0.5)",e.strokeStyle="rgba(242,144,66,1)",e.lineWidth=5*window.devicePixelRatio/2,e.beginPath(),e.roundRect(this.container.x,this.container.y,this.container.width*this.container.scaleX,this.container.height*this.container.scaleY,this.container.borderRadius*this.container.scaleY),e.fill(),e.stroke(),e.font=this.container.font*window.devicePixelRatio+"px helsinki",e.fillStyle="#000",e.textAlign="center",e.textBaseline="middle",e.fillText(this.container.text,this.container.x+this.container.width/2*this.container.scaleX,this.container.y+this.container.height/2*this.container.scaleY),e.restore()}fixedUpdate(){if(this.tweenRemaining>0){this.tweenRemaining=Math.max(this.tweenRemaining-1e3/this.scene.game.settings.drawFPS);let e=this.container;e.scaleX=e.scaleY=e.scaleX*(1-this.tweenRemaining/100)+this.tweenScale*(this.tweenRemaining/100),e.scaleX==this.tweenScale&&(this.tweenScale=this.tweenStart)}this.player&&this.player._tempVehicleTicks>0?(this.center_container(),this.updateTime()):this.container.visible=!1}updateTime(){let e=(this.player._tempVehicleTicks/this.scene.settings.drawFPS).toFixed(2),t="";10>e&&(t="0"),t+=e,this.container.text=t,this.container.visible=!0}close(){this.container=null,this.player=null,this.scene=null,this.settings=null}},gamepad=class extends EventTarget{tickDownButtons={};previousTickDownButtons={};downButtons={};inactiveDownButtons=new Set;keymap={};records={};keysToRecord=null;keysToPlay=null;recording=!1;playback=null;numberOfKeysDown=0;tickNumberOfKeysDown=0;replaying=!1;constructor(e){super(),Object.defineProperty(this,"scene",{value:e,writable:!0}),Object.defineProperty(this,"inactiveDownButtons",{enumerable:!1})}listen(){document.onkeydown=this.handleButtonDown.bind(this),document.onkeyup=this.handleButtonUp.bind(this),window.addEventListener("blur",this._handleBlur=this.handleBlur.bind(this)),window.addEventListener("focus",this._handleFocus=this.handleFocus.bind(this))}unlisten(){document.onkeydown=null,document.onkeyup=null,window.removeEventListener("blur",this._handleBlur),window.removeEventListener("focus",this._handleFocus),this._handleBlur=null,this._handleFocus=null}recordKeys(e){this.keysToRecord=e,this.recording=!0}loadPlayback(e,t){this.keysToPlay=t,this.playback=e,this.replaying=!0}setKeyMap(e){let t={};for(let s in e)if(e[s]instanceof Array)for(let i of e[s])t[i]=s;else t[e[s]]=s;this.keymap=t}handleButtonDown(e){let t=this.getInternalCode(e.keyCode);"string"==typeof t&&!e.ctrlKey&&e.preventDefault(),this.setButtonDown(t)}handleButtonUp(e){let t=this.getInternalCode(e.keyCode);"string"==typeof t&&e.preventDefault(),this.setButtonUp(t)}blurred=!1;previousDownButtons={};handleBlur(){this.blurred=!0,this.previousDownButtons=Object.assign({},this.tickDownButtons)}handleFocus(){this.blurred&&(this.tickDownButtons=Object.assign({},this.previousDownButtons),this.downButtons=Object.fromEntries(Object.keys(this.tickDownButtons).map((e=>[e,!1]))))}getInternalCode(e){return this.keymap[e]||e}setButtonsDown(e){for(let t in e)this.setButtonDown(e[t])}setButtonUp(e){this.blurred=!1,!this.dispatchEvent(this.constructor.createEvent("Up",e))||this.downButtons[e]&&(this.onButtonUp&&this.onButtonUp(e),this.downButtons[e]=!1,this.inactiveDownButtons.delete(e),this.inactiveDownButtons.delete("left"==e?"right":"right"==e?"left":null),this.numberOfKeysDown--)}setButtonDown(e,t){this.blurred=!1,this.downButtons[e]||!this.dispatchEvent(this.constructor.createEvent("Down",e))||(this.onButtonDown&&this.onButtonDown(e),this.downButtons[e]=t||!0,(t="left"==e?"right":"right"==e?"left":null)&&this.downButtons[t]&&this.inactiveDownButtons.add(t),this.numberOfKeysDown++)}isButtonDown(e){return this.tickDownButtons[e]>0}getButtonDownOccurances(e){let t=0;if(this.isButtonDown(e)){t=1;let s=this.tickDownButtons[e];!0!==s&&(t=s)}return t}getDownButtons(){let e=[];for(let t in this.tickDownButtons)this.tickDownButtons[t]&&e.push(t);return e}reset(e){(this.replaying||e)&&(this.downButtons={},this.playbackTicks=0),this.tickDownButtons={},this.previousDownButtons={},this.previousTickDownButtons={},this.records={}}update(){this.replaying&&this.updatePlayback(),!this.blurred&&(this.previousTickDownButtons=Object.assign({},this.tickDownButtons),this.tickDownButtons=window.hasOwnProperty("lite")&&lite.storage.get("inputRollover")&&this.recording?Object.fromEntries(Object.entries(this.downButtons).map((([e,t])=>[e,(!t||!this.inactiveDownButtons.has(e))&&t]))):Object.assign({},this.downButtons)),this.tickNumberOfKeysDown=this.numberOfKeysDown,this.recording&&this.updateRecording()}areKeysDown(){for(let e in this.downButtons)if(!0===this.downButtons[e])return!0;return!1}updatePlayback(){let e=this.playback,t=this.playbackTicks??this.scene.ticks;for(let s of this.keysToPlay){let i=s+"_up",a=s+"_down";if(void 0!==e[a]&&void 0!==e[a][t]){let i=e[a][t];this.setButtonDown(s,i)}void 0!==e[i]&&void 0!==e[i][t]&&this.setButtonUp(s)}}updateRecording(){let e=this.scene.ticks,t=this.records,s=this.tickDownButtons,i=this.previousTickDownButtons;for(let a of this.keysToRecord.filter((e=>void 0!==s[e]))){let o=s[a];if(o!==(void 0!==i[a]&&i[a])){let s=a+"_down",i=a+"_up";o&&(i=s),!o&&t[s]&&-1!==t[s].indexOf(e)?/^(backspace|enter)$/.test(a)?(t[i]||(t[i]=[]),t[i].push(e+1)):(t[s].splice(t[s].indexOf(e),1),t[s].length||delete t[s]):(t[i]||(t[i]=[]),t[i].push(e))}}}buttonWasRecentlyDown(e){let t=this.records;this.replaying&&(t=this.playback);let s=e+"_down",i=!1;if(t[s]){let e=(this.replaying&&this.playbackTicks)??this.scene.ticks,a=t[s],o=-1;o=this.replaying?void 0!==a[e]:a.indexOf(e),-1!==o&&(i=!0)}return i}getReplayString(){return window.hasOwnProperty("lite")&&lite.storage.get("showCustomizations")&&Object.assign(this.records,lite._appendRecords()),JSON.stringify(this.records)}encodeReplayString(){return window.hasOwnProperty("lite")&&lite.constructor.encodeReplayString(this.records,this.scene.settings)}close(){this.unlisten(),this.onButtonDown=null,this.onButtonUp=null,this.scene=null,this.tickDownButtons=null,this.downButtons=null,this.keymap=null,this.records=null,this.keysToRecord=null}static createEvent(e,t){const s="string"==typeof t?t:String.fromCharCode(t),i="number"==typeof t?t:t.charCodeAt();return new KeyboardEvent(`button${e}`,{key:s,code:t,keyCode:i,bubbles:!0,cancelable:!0})}static decodeReplayString(e){let t=JSON.parse(atob(e)),s={version:t.replayVersion??1};for(let e in t){if(!/_(?:down|up)$/.test(e))continue;let i=t[e].split(" ");s[e]=[];for(let t in i){let a=i[t];s[e].push(parseInt(a,32))}}return s}},mass=class{pos=new cartesian;old=new cartesian;vel=new cartesian;displayPos=this.pos;lastFixedPos=Object.assign(new cartesian,{recorded:!0,rendered:!1});collide=!0;contact=!1;friction=0;radius=10;constructor(e,t){Object.defineProperties(this,{parent:{value:t,writable:!0},scene:{value:t.scene,writable:!0}}),this.pos.equ(e),this.old.equ(e),this.lastFixedPos.equ(e)}drive(e,t){let s=this.friction,i=-(e*this.vel.x+t*this.vel.y)*s;e*=i,t*=i,this.pos.x+=e,this.pos.y+=t,this.contact=!0}fixedUpdate(){let e=this.parent.gravity;this.vel.inc(e),(0!=e.x||0!=e.y)&&this.vel.factorSelf(.99),this.pos.inc(this.vel),this.contact=!1,this.collide&&this.scene.track.collide(this),this.vel.equ(this.pos.sub(this.old)),this.lastFixedPos.recorded&&(this.lastFixedPos.equ(this.old),this.lastFixedPos.recorded=!1,this.lastFixedPos.rendered=!1,this.lastTime=0),this.old.equ(this.pos),this.displayPos=this.pos}lastTime=-1;update(e){if(!this.lastFixedPos.rendered){if(e<this.lastTime)return this.lastFixedPos.equ(this.pos),this.lastFixedPos.rendered=!0,void(this.lastTime=0);this.displayPos=this.lastFixedPos.lerp(this.pos,e),this.lastTime=e}}lateUpdate(){this.lastFixedPos.recorded||(this.lastFixedPos.recorded=!0)}translate(e,t){const s={x:e,y:t};this.pos.inc(s),this.old.inc(s),this.displayPos.inc(s),this.lastFixedPos.inc(s)}draw(e){const t=this.displayPos.toScreen(this.scene),s=this.scene.camera.zoom;e.beginPath(),e.arc(t.x,t.y,this.radius*s-e.lineWidth/2,0,2*Math.PI,!1),this.fill&&(e.fillStyle=this.fill,e.fill()),this.stroke&&(e.strokeStyle=this.stroke,e.stroke())}},canopy=class extends mass{wind=!0;constructor(e,t,s){super(new cartesian(e,t),s)}drive(e,t){this.pos.x+=.05*e*-e*(e*this.vel.x+t*this.vel.y),this.contact=!0}fixedUpdate(){let e=this.vel,t=this.pos,s=this.old,i=this.parent.gravity,a=this.parent.gamepad,o=a.isButtonDown("up"),r=a.isButtonDown("left"),n=a.isButtonDown("right");(0!==i.x||0!==i.y)&&(e.x=.9*e.x,e.y=.99*e.y),r&&(t.x+=-.05),n&&(t.x+=.05),(0!==i.x||0!==i.y)&&(t.y+=-.1),o&&(t.y+=-.5),this.wind&&(t.x+=.3),t.inc(e),this.contact=!1,this.collide&&this.scene.track.collide(this),(0!==i.x||0!==i.y)&&e.equ(t.sub(s)),this.lastFixedPos.recorded&&(this.lastFixedPos.equ(s),this.lastFixedPos.recorded=!1,this.lastFixedPos.rendered=!1,this.lastTime=0),s.equ(t)}draw(e){let t=this.scene,s=this.displayPos.toScreen(t),i=this.radius*t.camera.zoom;e.beginPath(),e.fillStyle=this.scene.settings.physicsLineColor,e.arc(s.x,s.y,i,0,2*Math.PI),e.closePath(),e.fill()}},spring=class{m1=null;m2=null;lrest=40;leff=40;dampConstant=.5;springConstant=.7;constructor(e,t,s){Object.defineProperty(this,"parent",{value:s}),this.m1=e,this.m2=t}swap(){let e=new cartesian,t=this.m1,s=this.m2;e.equ(t.pos),t.pos.equ(s.pos),s.pos.equ(e),e.equ(t.old),t.old.equ(s.old),s.old.equ(e),e.equ(t.vel),t.vel.equ(s.vel),s.vel.equ(e),e=t.angle,t.angle=s.angle,s.angle=e}fixedUpdate(){let e=this.m1,t=this.m2,s=e.pos,i=t.pos,a=e.vel,o=t.vel,r=new cartesian(i.x-s.x,i.y-s.y),n=r.len();if(!(1>n)){let e=1/n;r.x*=e,r.y*=e;let t=(n-this.leff)*this.springConstant,s={x:r.x*t,y:r.y*t},i=o.x-a.x,h=o.y-a.y,l=(i*r.x+h*r.y)*this.dampConstant,c=r.x*l,p=r.y*l;s.x+=c,s.y+=p,o.x+=-s.x,o.y+=-s.y,a.x+=s.x,a.y+=s.y}}rotate(e){let t=this.m1,s=this.m2,i=s.pos.x-t.pos.x,a=-(s.pos.y-t.pos.y)/this.leff,o=i/this.leff;t.pos.x+=a*e,t.pos.y+=o*e,s.pos.x+=a*-e,s.pos.y+=o*-e}contract(e,t){this.leff+=(this.lrest-e-this.leff)/t}setMasses(e,t){this.m1=e,this.m2=t}};let l=[1,.7,.8,.9,.5,1,.7,1];const debris=class extends mass{angle=6.2*Math.random();color="black";friction=.05;radius=2*Math.random()*5;speed=1*Math.random()-1*Math.random();constructor(e,t,s){super(e,t),this.color=s,this.pos.x=e.x+5*(Math.random()-Math.random()),this.pos.y=e.y+5*(Math.random()-Math.random()),this.old.equ(this.pos),this.vel.y=11*(Math.random()-Math.random()),this.vel.x=11*(Math.random()-Math.random())}drive(e,t){let s=this.vel,i=this.pos;this.speed=(e*s.x+t*s.y)/this.radius,this.angle+=this.speed;let a=-(e*s.x+t*s.y)*this.friction;i.x+=e*a,i.y+=t*a;let o=Math.sqrt(Math.pow(e,2)+Math.pow(t,2));if(o>0){let i=-t/o,a=e/o,r=.8*(i*s.x+a*s.y);this.old.x+=i*r,this.old.y+=a*r}}fixedUpdate(){this.angle+=this.speed,super.fixedUpdate()}draw(e){let t=this.scene.screen,s=this.scene.camera,i=t.realToScreen(this.displayPos.x,"x"),a=t.realToScreen(this.displayPos.y,"y"),o=0,r=s.zoom,n=this.angle,h=l[0]*r*this.radius,c=i+h*Math.cos(n),p=a+h*Math.sin(n),d=2*Math.PI;for(e.lineWidth=1*r,e.strokeStyle=this.color,e.beginPath(),e.moveTo(c,p),e.fillStyle=this.color;o++<8;)h=l[o-1]*r*this.radius,c=i+h*Math.cos(n+d*o/8),p=a+h*Math.sin(n+d*o/8),e.lineTo(c,p);e.fill(),e.stroke()}},explosion=class{complete=!1;gravity=new cartesian(0,.3);powerupsEnabled=!1;time=20;constructor(e,t){Object.defineProperty(this,"scene",{value:t,writable:!0}),this.positionX=e.x,this.positionY=e.y,this.createMasses(e)}draw(e,t){let s=this.time,i=this.positionX,a=this.positionY,o=this.scene.camera.zoom,r=this.scene.screen;if(e.globalAlpha=t,s>0){s-=10;let t=r.realToScreen(i,"x"),n=r.realToScreen(a,"y"),h=0,l=6.2*Math.random(),c=s*o,p=t+c*Math.cos(l),d=n+c*Math.sin(l);for(e.beginPath(),e.moveTo(p,d),e.fillStyle=this.scene.settings.physicsLineColor;h++<16;)c=(s+30*Math.random())*o,p=t+c*Math.cos(l+6.283*h/16),d=n+c*Math.sin(l+6.283*h/16),e.lineTo(p,d);e.fill()}let n=this.masses;for(let t in n)n[t].draw(e);e.globalAlpha=1,this.time=s}createMasses(e){this.masses=[],this.masses.push(new debris(e,this,this.scene.settings.physicsLineColor)),this.masses.push(new debris(e,this,this.scene.settings.physicsLineColor)),this.masses.push(new debris(e,this,this.scene.settings.physicsLineColor)),this.masses.push(new debris(e,this,this.scene.settings.physicsLineColor)),this.masses.push(new debris(e,this,this.scene.settings.physicsLineColor)),this.masses.push(new debris(e,this,this.scene.settings.physicsLineColor)),this.masses.push(new debris(e,this,this.scene.settings.physicsLineColor))}fixedUpdate(){for(let e of this.masses)e.fixedUpdate()}update(){for(let e of this.masses)e.update(...arguments)}lateUpdate(){for(let e of this.masses)e.lateUpdate()}},vehicle=class{static Sounds={};alive=!0;color="#000000";complete=!1;cosmetics=null;crashed=!1;dir=1;explosion=!1;gravity=new cartesian(0,.3);masses=[];powerupsEnabled=!0;speed=0;springs=[];slow=!1;constructor(e){Object.defineProperty(this,"player",{value:e,writable:!0}),Object.defineProperty(this,"scene",{value:e._scene,writable:!0}),this.gamepad=e._gamepad,this.settings=e._settings,this.createCosmetics()}createCosmetics(){this.cosmetics=this.player._user.cosmetics}dead(){this.stopSounds(),this.player.dead(),this.crashed=!0,this.alive=!1}explode(){this.scene.sound.play("bomb_sound",1),this.explosion=new explosion(this.masses[0].displayPos,this.scene),this.dead()}fixedUpdate(){return!1===this.crashed&&(this.updateSound(),this.control?.()),this.explosion&&(this.explosion.fixedUpdate(),!0)}update(){for(let e=this.masses,t=e.length-1;t>=0;t--)e[t].update(...arguments)}lateUpdate(){for(let e=this.masses,t=e.length-1;t>=0;t--)e[t].lateUpdate(...arguments)}draw(e){return!!this.scene.game.emit(this.scene.game.constructor.Events.PlayerVehicleDraw,this)||this.explosion&&(this.explosion.draw(e,1),!0)}moveVehicle(e,t){for(var s=this.masses,i=s.length-1;i>=0;i--)s[i].move(e,t)}stopSounds(){for(const e in this.constructor.Sounds){const t=this.constructor.Sounds[e];"string"==typeof t&&this.scene.sound.stop(t)}}close(){this.scene=null,this.settings=null,this.gravity=null,this.speed=null,this.cosmetics=null,this.explosion=null,this.crashed=null,this.alive=null,this.gamepad=null}},vehicles_balloon=class extends vehicle{static Sounds={BalloonOn:"balloon_on"};basket=null;head=null;outline="#999";vehicleName="BALLOON";constructor(e,t){super(e),this.createMasses(t),this.createSprings(),this.stopSounds(),this.focalPoint=this.head}createMasses(e){let t=new canopy(e.x,e.y-10,this);t.radius=30;let s=new mass(new cartesian(e.x,e.y+35),this);s.friction=.1,this.masses.push(t),this.masses.push(s),this.head=this.masses[0],this.basket=this.masses[1],this.head.drive=this.explode.bind(this)}updateCameraFocalPoint(){}createSprings(){var e=new spring(this.head,this.basket,this);e.springConstant=.2,e.dampConstant=.2,e.lrest=e.leff=45,this.springs.push(e)}fixedUpdate(){if(!super.fixedUpdate()){this.head.wind=!this.basket.contact,this.slow=!1;for(var e=this.springs,t=e.length-1;t>=0;t--)e[t].fixedUpdate();for(var s=this.masses,i=s.length-1;i>=0;i--)s[i].fixedUpdate()}}updateSound(){if(this.player.isInFocus()){var e=this.scene.sound,t=this.gamepad;t.isButtonDown("up")?e.play(this.constructor.Sounds.BalloonOn,.6):t.isButtonDown("up")||e.stop(this.constructor.Sounds.BalloonOn)}}draw(e){if(!super.draw(...arguments)){if(this.scene.ticks>0&&!this.player.isGhost()){if(!this.scene.state.playing){let t=window.lite&&parseInt(lite.storage.get("snapshots"));if(t>0){for(let s of this.player._checkpoints.filter(((e,s,i)=>s>i.length-(t+1)&&e._tempVehicle)))e.globalAlpha=t/300*this.player._checkpoints.indexOf(s)%1,this.drawBalloon.call(Object.assign({},this,{player:this.player,scene:this.scene},JSON.parse(s._tempVehicle)),e);for(let s of this.player._cache.filter(((e,s,i)=>s>i.length-(t+1)&&e._tempVehicle)))e.globalAlpha=e/300*this.player._cache.indexOf(s)%1,this.drawBalloon.call(Object.assign({},this,{player:this.player,scene:this.scene},JSON.parse(s._tempVehicle)),e)}}if(window.lite&&lite.storage.get("playerTrail"))for(let t of lite.snapshots.filter((e=>e._tempVehicle)))e.globalAlpha=lite.snapshots.length/(200*lite.snapshots.length)*lite.snapshots.indexOf(t)%1,this.drawBalloon.call(Object.assign({},this,{player:this.player,scene:this.scene},JSON.parse(t._tempVehicle)),e)}if(this.settings.developerMode)for(var t=this.masses,s=t.length-1;s>=0;s--)t[s].draw();e.globalAlpha=this.player._opacity,this.drawBalloon(e),e.globalAlpha=1}}drawBalloon(e){var t=this.scene,s=new cartesian(this.basket.displayPos.x,this.basket.displayPos.y).toScreen(t),i=new cartesian(this.head.displayPos.x,this.head.displayPos.y).toScreen(t),a=t.camera.zoom,o=i.x-s.x,r=i.y-s.y,n=-r;e.save(),e.strokeStyle="dark"===window.lite.storage.get("theme")?"#666":this.outline,e.lineWidth=1,e.beginPath(),e.moveTo(s.x+.1*n,s.y+.1*o),e.lineTo(s.x+.5*o+.39*n,s.y+.5*r+.39*o),e.moveTo(s.x-.1*n,s.y-.1*o),e.lineTo(s.x+.5*o-.39*n,s.y+.5*r-.39*o),e.moveTo(s.x+.1*n,s.y+.1*o),e.lineTo(s.x+.4*o+.21*n,s.y+.4*r+.21*o),e.moveTo(s.x-.1*n,s.y-.1*o),e.lineTo(s.x+.4*o-.21*n,s.y+.4*r-.21*o),e.closePath(),e.stroke();let h=new canopy(this.head.displayPos.x,this.head.displayPos.y,this);h.radius=30,h.draw(e),this.gamepad.isButtonDown("up")&&(e.beginPath(),e.strokeStyle="#FFFF00",e.lineWidth=8*a,e.moveTo(s.x,s.y),e.lineTo(s.x+.1*o,s.y+.1*r),e.closePath(),e.stroke(),e.beginPath(),e.strokeStyle="#FFAA00",e.lineWidth=3*a,e.moveTo(s.x,s.y),e.lineTo(s.x+.1*o,s.y+.1*r),e.closePath(),e.stroke()),e.beginPath(),e.fillStyle=this.color,e.moveTo(s.x+.1*n,s.y+.1*o),e.lineTo(s.x-.1*n,s.y-.1*o),e.lineTo(s.x-.22*o-.1*n,s.y-.22*r-.1*o),e.lineTo(s.x-.22*o+.1*n,s.y-.22*r+.1*o),e.lineTo(s.x+.1*n,s.y+.1*o),e.closePath(),e.fill(),e.restore()}},wheel=class extends mass{angle=0;brake=!1;motor=0;rotationSpeed=0;speed=0;drive(e,t){let s=this.pos,i=this.motor*this.parent.dir,a=i*e,o=i*t;if(s.x+=a,s.y+=o,this.brake){let i=.3*-(e*this.vel.x+t*this.vel.y),a=e*i,o=t*i;s.x+=a,s.y+=o}this.speed=(e*this.vel.x+t*this.vel.y)/this.radius,this.rotationSpeed=this.speed,this.angle+=this.speed,this.contact=!0}fixedUpdate(){super.fixedUpdate(),this.rotationSpeed=.999*this.rotationSpeed}draw(e){const t=this.displayPos.toScreen(this.scene),s=this.scene.camera.zoom;e.beginPath(),e.arc(t.x,t.y,this.radius*s-e.lineWidth/2,0,2*Math.PI,!1),this.fill&&(e.fillStyle=this.fill,e.fill()),this.stroke&&(e.strokeStyle=this.stroke,e.stroke())}},vehicles_blob=class extends vehicle{static Sounds={Blob:"blob_sound"};vehicleName="Blob";constructor(e,t){super(e),this.createMasses(t),this.createSprings(),this.stopSounds()}createMasses(e){let t=this.masses;t.push(new wheel(new cartesian(e.x+15,e.y+40),this)),t.push(new wheel(new cartesian(e.x+-15,e.y+40),this)),t.push(new wheel(new cartesian(e.x+-15,e.y+10),this)),t.push(new wheel(new cartesian(e.x+15,e.y+10),this));let s=new mass(new cartesian(0,0),this);s.vel=new cartesian(0,0),this.m0=t[0],this.m1=t[1],this.m2=t[2],this.m3=t[3],this.head=s,this.focalPoint=this.head}createSprings(){let e=this.masses,t=this.springs,s=this.spring0=new spring(e[0],e[1],this),i=this.spring1=new spring(e[1],e[2],this),a=this.spring2=new spring(e[2],e[3],this),o=this.spring3=new spring(e[3],e[0],this),r=this.spring4=new spring(e[0],e[2],this),n=this.spring5=new spring(e[1],e[3],this);t.push(s),t.push(i),t.push(a),t.push(o),t.push(r),t.push(n);for(let e in t)t[e].springConstant=.2,t[e].dampConstant=.2}fixedUpdate(){if(super.fixedUpdate())return;let e=this.masses,t=e.length,s=this.springs,i=s.length;for(var a=i-1;a>=0;a--)s[a].fixedUpdate();for(var o=t-1;o>=0;o--)e[o].fixedUpdate();if((e[0].contact||e[1].contact||e[2].contact||e[3].contact)&&(this.slow=!1),!this.slow){for(this.control(),a=i-1;a>=0;a--)s[a].fixedUpdate();for(o=t-1;o>=0;o--)e[o].fixedUpdate()}let r=0,n=0;for(let e of this.masses)r+=e.pos.x,n+=e.pos.y;let h=this.head;h.pos.x=.25*r,h.pos.y=.25*n,h.vel=e[0].vel}updateSound(){this.player.isInFocus()&&this.scene.sound.play(this.constructor.Sounds.Blob,.4)}updateCameraFocalPoint(){}control(){let e,t,s=this.player.getGamepad(),i=s.isButtonDown("up"),a=s.isButtonDown("down"),o=s.isButtonDown("left"),r=s.isButtonDown("right"),n=s.isButtonDown("z"),h=this.masses,l=this.springs,c=h.length,p=l.length,d=this.dir;d=r?1:-1;let u=r||o?1:0;for(a&&(u=0),e=c-1;e>=0;e--)h[e].motor+=(u*d*1-h[e].motor)/10,0==u&&(h[e].motor=0),h[e].brake=a;let m=o?1:0;if(m+=r?-1:0,l[4].rotate(m/9),l[5].rotate(m/9),n||i)for(t=p-1;t>=0;t--)l[t].contract(30,10);else for(t=p-1;t>=0;t--)l[t].contract(0,1.5)}draw(e){if(!super.draw(...arguments)){if(this.scene.ticks>0&&!this.player.isGhost()){if(!this.scene.state.playing){let t=window.lite&&lite.storage.get("snapshots");if(t>0){for(let s of this.player._checkpoints.filter(((e,s,i)=>s>i.length-(t+1)&&e._tempVehicle)))this.drawBlob.call(Object.assign({},this,{player:this.player,scene:this.scene},JSON.parse(s._tempVehicle)),e,t/300*this.player._checkpoints.indexOf(s)%1);for(let s of this.player._cache.filter(((e,s,i)=>s>i.length-(t+1)&&e._tempVehicle)))this.drawBlob.call(Object.assign({},this,{player:this.player,scene:this.scene},JSON.parse(s._tempVehicle)),e,t/300*this.player._cache.indexOf(s)%1)}}if(window.lite&&lite.storage.get("playerTrail"))for(let t of lite.snapshots.filter((e=>e._tempVehicle)))this.drawBlob.call(Object.assign({},this,{player:this.player,scene:this.scene},JSON.parse(t._tempVehicle)),e,lite.snapshots.length/(200*lite.snapshots.length)*lite.snapshots.indexOf(t)%1)}this.drawBlob(e)}}drawBlob(e,t=this.player._opacity){let s=this.scene,i=s.camera.zoom,a=new cartesian(this.m0.displayPos.x,this.m0.displayPos.y).toScreen(s),o=new cartesian(this.m1.displayPos.x,this.m1.displayPos.y).toScreen(s),r=new cartesian(this.m2.displayPos.x,this.m2.displayPos.y).toScreen(s),n=new cartesian(this.m3.displayPos.x,this.m3.displayPos.y).toScreen(s);e.globalAlpha=t,e.beginPath(),e.fillStyle=this.color,e.lineWidth=20*i,e.lineCap="round",e.moveTo(a.x,a.y),e.lineTo(o.x,o.y),e.lineTo(r.x,r.y),e.lineTo(n.x,n.y),e.closePath(),e.fill(),e.stroke(),e.globalAlpha=1}},ragdoll=class{constructor(e,t){Object.defineProperty(this,"parent",{value:t});let s,i,a,o,r,n,h,l,c,p,d=[],u=[],m=new cartesian(0,0);s=new mass(m,t),i=new mass(m,t),a=new mass(m,t),o=new mass(m,t),n=new mass(m,t),r=new mass(m,t),h=new mass(m,t),l=new mass(m,t),c=new mass(m,t),p=new mass(m,t),d.push(s),d.push(i),d.push(a),d.push(o),d.push(n),d.push(r),d.push(h),d.push(l),d.push(c),d.push(p),u.push(new spring(s,i,this)),u.push(new spring(s,a,this)),u.push(new spring(a,n,this)),u.push(new spring(s,o,this)),u.push(new spring(o,r,this)),u.push(new spring(i,h,this)),u.push(new spring(h,c,this)),u.push(new spring(i,l,this)),u.push(new spring(l,p,this));for(let e in d)d[e].friction=.05,d[e].radius=3;for(var g in s.radius=i.radius=8,u)u[g].dampConstant=.7,u[g].springConstant=.4;this.masses=d,this.springs=u,this.head=s,this.waist=i,this.lElbow=a,this.rElbow=o,this.rHand=r,this.lHand=n,this.lKnee=h,this.rKnee=l,this.lFoot=c,this.rFoot=p;for(const t in e)this[t].pos.equ(e[t]),this[t].old.equ(e[t]),this[t].lastFixedPos.equ(e[t])}zero(e,t){e=e.factor(.7),t=t.factor(.7);let s=this.springs,i=this.masses;for(let e in s){let t=s[e].m2.pos.sub(s[e].m1.pos).len();s[e].lrest=t,s[e].leff=t}for(let e=1;4>=e;e++)s[e].lrest=13,s[e].leff=13;for(let e in s.filter((e=>e.leff>20)))s[e].lrest=20,s[e].leff=20;let a=[this.head,this.lElbow,this.rElbow,this.lHand,this.rHand],o=[this.waist,this.lKnee,this.rKnee,this.lFoot,this.rFoot];for(let t in a)a[t].old=a[t].pos.sub(e);for(let e in o)o[e].old=o[e].pos.sub(t);for(let e in i)i[e].vel.equ(i[e].pos.sub(i[e].old)),i[e].vel.x+=1*(Math.random()-Math.random()),i[e].vel.y+=1*(Math.random()-Math.random())}draw(e){let t=this.head,s=this.waist,i=this.lElbow,a=this.rElbow,o=this.rHand,r=this.lHand,n=this.lKnee,h=this.rKnee,l=this.lFoot,c=this.rFoot,p=this.parent.scene,d=p.camera.zoom,u=this.parent.alpha??1,m=this.parent.player.color;e.strokeStyle=m+Math.min(255,Math.round(127.5*u)).toString(16).padStart(Math.floor(m.length/3),0),e.lineWidth=5*d;let g=t.displayPos.toScreen(p);e.beginPath(),e.moveTo(g.x,g.y);let y=i.displayPos.toScreen(p);e.lineTo(y.x,y.y);let w=r.displayPos.toScreen(p);e.lineTo(w.x,w.y),e.stroke(),e.strokeStyle=m+Math.min(255,Math.round(255*u)).toString(16).padStart(Math.floor(m.length/3),0),e.beginPath(),e.moveTo(g.x,g.y);let f=a.displayPos.toScreen(p);e.lineTo(f.x,f.y);let x=o.displayPos.toScreen(p);e.lineTo(x.x,x.y),e.stroke(),e.lineWidth=8*d,e.beginPath(),e.moveTo(g.x,g.y);let v=s.displayPos.toScreen(p);e.lineTo(v.x,v.y),e.stroke(),e.lineWidth=5*d,e.beginPath(),e.moveTo(v.x,v.y);let b=n.displayPos.toScreen(p);e.lineTo(b.x,b.y);let T=l.displayPos.toScreen(p);e.lineTo(T.x,T.y);let k=n.displayPos.sub(s.displayPos).normalize();k.factorSelf(4),k.inc(l.displayPos);let P=k.toScreen(p);e.lineTo(P.x,P.y),e.stroke(),e.strokeStyle=m+Math.min(255,Math.round(127.5*u)).toString(16).padStart(Math.floor(m.length/3),0),e.lineWidth=5*d,e.beginPath(),e.moveTo(v.x,v.y);let S=h.displayPos.toScreen(p);e.lineTo(S.x,S.y);let _=h.displayPos.sub(s.displayPos).normalize();_=_.factor(4).add(c.displayPos);let C=c.displayPos.toScreen(p);e.lineTo(C.x,C.y);let M=_.toScreen(p);e.lineTo(M.x,M.y),e.stroke(),g.inc(g.sub(v).factor(.25));let z=GameInventoryManager.getItem(this.parent.cosmetics.head),B=this.drawHeadAngle;z.draw(e,g.x,g.y,B,d,this.dir,1)}fixedUpdate(){for(let e of this.springs)e.fixedUpdate();for(let e of this.masses)e.fixedUpdate()}update(){for(let e of this.masses)e.update(...arguments);this.updateDrawHeadAngle()}lateUpdate(){for(let e of this.masses)e.lateUpdate()}updateDrawHeadAngle(){let e=this.head.displayPos,t=this.waist.displayPos;this.dir<0&&([e,t]=[t,e]);let s=e.x,i=e.y,a=s-t.x,o=i-t.y;this.drawHeadAngle=-(Math.atan2(a,o)+Math.PI)}},bike=class extends vehicle{static Sounds={BikeAir:"bike_air",BikeFall:e=>`bike_fall_${e}`,BikeGround:"bike_ground"};cosmeticHead=null;cosmeticRearWheel=null;cosmeticFrontWheel=null;pedala=0;swapped=!1;ragdoll=null;createSprings(){let e=new spring(this.head,this.rearWheel,this),t=new spring(this.rearWheel,this.frontWheel,this),s=new spring(this.frontWheel,this.head,this);this.springs.push(e),this.springs.push(t),this.springs.push(s),this.rearSpring=e,this.chasse=t,this.frontSpring=s}createRagdoll(){this.ragdoll=new ragdoll(this.getStickMan(),this),this.ragdoll.zero(this.head.vel,this.rearWheel.vel),this.ragdoll.dir=this.dir,this.rearWheel.motor=0,this.rearWheel.brake=!1,this.frontWheel.brake=!1,this.head.collide=!1,this.updateCameraFocalPoint(),this.player.isInFocus()&&this.playBailSound(),this.dead()}playBailSound(){let e=this.scene.sound,t=Math.min(this.speed/50,1),s=Math.ceil(3*Math.random());e.play(this.constructor.Sounds.BikeFall(s),t)}updateCameraFocalPoint(){this.focalPoint=this.ragdoll?this.ragdoll.head:this.head}updateSpeed(){this.speed=Math.abs(Math.round(this.focalPoint.vel.x+this.focalPoint.vel.y))}getStickMan(){let e=this.dir,t=this.head,s=this.frontWheel,i=this.rearWheel,a=this.pedala,o=s.displayPos.sub(i.displayPos),r=t.displayPos.sub(s.displayPos.add(i.displayPos).factor(.5)),n=new cartesian(o.y*e,-o.x*e),h={};h.head=i.displayPos.add(o.factor(.35)).add(r.factor(1.2)),h.lHand=h.rHand=i.displayPos.add(o.factor(.8)).add(n.factor(.68));var l=h.head.sub(h.lHand);l=new cartesian(l.y*e,-l.x*e),h.lElbow=h.rElbow=h.head.add(h.lHand).factor(.5).add(l.factor(130/l.lenSqr())),h.waist=i.displayPos.add(o.factor(.2)).add(n.factor(.5));var c=new cartesian(6*Math.cos(a),6*Math.sin(a));return h.lFoot=i.displayPos.add(o.factor(.4)).add(n.factor(.05)).add(c),l=h.waist.sub(h.lFoot),l=new cartesian(-l.y*e,l.x*e),h.lKnee=h.waist.add(h.lFoot).factor(.5).add(l.factor(160/l.lenSqr())),h.rFoot=i.displayPos.add(o.factor(.4)).add(n.factor(.05)).sub(c),l=h.waist.sub(h.rFoot),l=new cartesian(-l.y*e,l.x*e),h.rKnee=h.waist.add(h.rFoot).factor(.5).add(l.factor(160/l.lenSqr())),h}fixedUpdate(){if(!super.fixedUpdate()){let e=this.springs,t=this.masses;for(let t=e.length-1;t>=0;t--)e[t].fixedUpdate();for(let e=t.length-1;e>=0;e--)t[e].fixedUpdate();if(this.rearWheel.contact&&this.frontWheel.contact&&(this.slow=!1),!1===this.slow){!1===this.crashed&&this.control();for(let t=e.length-1;t>=0;t--)e[t].fixedUpdate();for(let e=t.length-1;e>=0;e--)t[e].fixedUpdate()}this.ragdoll&&this.ragdoll.fixedUpdate()}this.updateCameraFocalPoint()}update(){(this.scene.game.interpolation||this.scene.camera.playerFocus?.isGhost()||!this.scene.camera.playerFocus?.isAlive())&&super.update(...arguments),this.ragdoll?this.ragdoll.update(...arguments):this.updateDrawHeadAngle()}lateUpdate(){super.lateUpdate(...arguments),this.ragdoll&&this.ragdoll.lateUpdate(...arguments)}updateSound(){if(this.player.isInFocus()){this.updateSpeed();let e=Math.min(this.speed/50,1),t=this.scene.sound;this.rearWheel.contact||this.frontWheel.contact?(t.play(this.constructor.Sounds.BikeGround,e),t.stop(this.constructor.Sounds.BikeAir)):(t.play(this.constructor.Sounds.BikeAir,e),t.stop(this.constructor.Sounds.BikeGround))}}swap(){this.dir=-1*this.dir,this.chasse.swap();let e=this.rearSpring.leff;this.rearSpring.leff=this.frontSpring.leff,this.frontSpring.leff=e}draw(e){super.draw(...arguments)||this.scene.game.emit(this.scene.game.constructor.Events.PlayerBaseVehicleDraw,this)||(e.imageSmoothingEnabled=!0,e.mozImageSmoothingEnabled=!0,e.webkitImageSmoothingEnabled=!0,this.drawBikeFrame(e))}drawBikeFrame(e,t){const s=this.scene,i=s.camera.zoom,a=s.settings.physicsLineColor;e.globalAlpha=t??this.player._opacity,e.strokeStyle=this.frontWheel.color||a,e.lineWidth=3*i}updateDrawHeadAngle(){let e=this.frontWheel.displayPos,t=this.rearWheel.displayPos,s=e.x,i=e.y,a=s-t.x,o=i-t.y;this.drawHeadAngle=-(Math.atan2(a,o)-Math.PI/2)}close(){super.close(),this.ragdoll=null}},bmx=class extends bike{vehicleName="BMX";constructor(e,t,s,i){super(e),this.createMasses(t,i),this.createSprings(),this.updateCameraFocalPoint(),this.stopSounds(),-1===s&&this.swap()}createMasses(e,t){var s=new mass(new cartesian(e.x,e.y-36),this),i=new wheel(new cartesian(e.x+21,e.y+3),this),a=new wheel(new cartesian(e.x+-21,e.y+3),this);s.drive=this.createRagdoll.bind(this),a.radius=11.7,i.radius=11.7,s.radius=14,s.vel.equ(t),a.vel.equ(t),i.vel.equ(t),this.masses.push(s),this.masses.push(a),this.masses.push(i),this.head=s,this.frontWheel=i,this.rearWheel=a}createSprings(){super.createSprings(),this.chasse.lrest=42,this.chasse.leff=42,this.chasse.springConstant=.35,this.chasse.dampConstant=.3,this.rearSpring.lrest=45,this.rearSpring.leff=45,this.rearSpring.springConstant=.35,this.rearSpring.dampConstant=.3,this.frontSpring.lrest=45,this.frontSpring.leff=45,this.frontSpring.springConstant=.35,this.frontSpring.dampConstant=.3}control(){let e=this.gamepad,t=e.isButtonDown("up"),s=e.isButtonDown("down"),i=e.isButtonDown("left"),a=e.isButtonDown("right"),o=e.isButtonDown("z"),r=this.rearWheel;r.motor+=(t-r.motor)/10,o&&!this.swapped&&(this.swap(),this.swapped=!0),o||(this.swapped=!1),t&&(this.pedala+=this.rearWheel.speed/5),r.brake=s,s&&this.frontSpring.contract(-10,10),this.frontWheel.brake=!!(this.dir>0&&a&&s)||!!(this.dir<0&&i&&s);let n=i-a;this.rearSpring.contract(5*n*this.dir,5),this.frontSpring.contract(5*-n*this.dir,5),this.chasse.rotate(n/6),!n&&t&&(this.rearSpring.contract(-7,5),this.frontSpring.contract(7,5))}drawBikeFrame(e,t=this.player._opacity){let s=this.scene,i=new cartesian(this.rearWheel.displayPos.x,this.rearWheel.displayPos.y),a=new cartesian(this.frontWheel.displayPos.x,this.frontWheel.displayPos.y),o=new cartesian(this.head.displayPos.x,this.head.displayPos.y),r=i.toScreen(s),n=a.toScreen(s),h=o.toScreen(s),l=n.sub(r),c=this.dir,p=new cartesian((n.y-r.y)*c,(r.x-n.x)*c),d=this.pedala,u=s.camera.zoom,m=s.settings.physicsLineColor;super.drawBikeFrame(...arguments),e.fillStyle=s.settings.sceneryLineColor.padEnd(7,s.settings.sceneryLineColor.slice(1,4))+"33",this.frontWheel.draw(e),this.frontWheel.fill||e.fill(),this.frontWheel.stroke||e.stroke(),this.rearWheel.draw(e),this.rearWheel.fill||e.fill(),this.rearWheel.stroke||e.stroke();let g=r.add(l.factor(.3)).add(p.factor(.25)),y=r.add(l.factor(.4)).add(p.factor(.05)),w=r.add(l.factor(.84)).add(p.factor(.42)),f=r.add(l.factor(.84)).add(p.factor(.37));e.beginPath(),e.strokeStyle=this.color,e.moveTo(r.x,r.y),e.lineTo(g.x,g.y),e.lineTo(w.x,w.y),e.moveTo(f.x,f.y),e.lineTo(y.x,y.y),e.lineTo(r.x,r.y),e.stroke(),e.beginPath(),e.lineWidth=Math.max(1*u,.5),e.arc(y.x,y.y,3*u,0,2*Math.PI,!1),e.stroke();let x=new cartesian(6*Math.cos(d)*u,6*Math.sin(d)*u),v=y.add(x),b=y.sub(x);e.beginPath(),e.moveTo(v.x,v.y),e.lineTo(b.x,b.y),e.stroke();let T=r.add(l.factor(.25)).add(p.factor(.4)),k=r.add(l.factor(.17)).add(p.factor(.38)),P=r.add(l.factor(.3)).add(p.factor(.45));e.beginPath(),e.lineWidth=3*u,e.moveTo(k.x,k.y),e.lineTo(P.x,P.y),e.moveTo(y.x,y.y),e.lineTo(T.x,T.y);let S=r.add(l.factor(1)).add(p.factor(0)),_=r.add(l.factor(.97)).add(p.factor(0)),C=r.add(l.factor(.8)).add(p.factor(.48));e.moveTo(S.x,S.y),e.lineTo(_.x,_.y),e.lineTo(C.x,C.y);let M=r.add(l.factor(.86)).add(p.factor(.5)),z=r.add(l.factor(.82)).add(p.factor(.65)),B=r.add(l.factor(.78)).add(p.factor(.67));if(e.lineTo(M.x,M.y),e.lineTo(z.x,z.y),e.lineTo(B.x,B.y),e.stroke(),this.crashed)this.ragdoll&&this.ragdoll.draw(e);else{p=h.sub(r.add(l.factor(.5)));let s=g.add(l.factor(-.1)).add(p.factor(.3)),i=v.sub(s),a=new cartesian(i.y*c,-i.x*c);a=a.factor(u*u);let o=s.add(i.factor(.5)).add(a.factor(200/i.lenSqr())),n=v.add(i.factor(.12)).add(a.factor(50/i.lenSqr()));i=b.sub(s),a=new cartesian(i.y*c,-i.x*c),a=a.factor(u*u);let d=s.add(i.factor(.5)).add(a.factor(200/i.lenSqr())),y=b.add(i.factor(.12)).add(a.factor(50/i.lenSqr()));m=this.player&&this.player.color||m,e.strokeStyle=m+Math.min(255,Math.round(127.5*t)).toString(16).padStart(Math.floor(m.length/3),0),e.lineWidth=6*u,e.beginPath(),e.moveTo(b.x,b.y),e.lineTo(d.x,d.y),e.lineTo(s.x,s.y),e.stroke(),e.lineWidth=4*u,e.beginPath(),e.moveTo(b.x,b.y),e.lineTo(y.x,y.y),e.stroke(),e.lineWidth=6*u,e.strokeStyle=m,e.beginPath(),e.moveTo(s.x,s.y),e.lineTo(o.x,o.y),e.lineTo(v.x,v.y),e.lineTo(n.x,n.y),e.stroke();let w=g.add(l.factor(.05)).add(p.factor(.9));e.lineWidth=8*u,e.beginPath(),e.moveTo(s.x,s.y),e.lineTo(w.x,w.y),e.stroke();let f=g.add(l.factor(.15)).add(p.factor(1.05));l=w.sub(B),p=new cartesian(l.y*c,-l.x*c),p=p.factor(u*u);let x=B.add(l.factor(.4)).add(p.factor(130/l.lenSqr()));e.lineWidth=5*u,e.beginPath(),e.moveTo(w.x,w.y),e.lineTo(x.x,x.y),e.lineTo(B.x,B.y),e.stroke(),GameInventoryManager.getItem(this.cosmetics.head).draw(e,f.x,f.y,this.drawHeadAngle,u,this.dir),e.globalAlpha=1}}},prop=class extends mass{motor=0;angle=new cartesian;speed=0;fixedUpdate(){let e=this.vel,t=this.angle,s=this.pos,i=this.old,a=this.motor;e.inc(t.factor(2*a)),s.inc(e.factor(.99)),this.contact=!1,this.collide&&this.scene.track.collide(this),this.vel.equ(s.sub(i)),this.lastFixedPos.recorded&&(this.lastFixedPos.equ(i),this.lastFixedPos.recorded=!1,this.lastFixedPos.rendered=!1,this.lastTime=0),i.equ(s)}},vehicles_helicopter=class extends vehicle{static Sounds={Helicopter:"helicopter"};swapped=!1;vehicleName="Helicopter";constructor(e,t,s){super(e),this.createMasses(t),this.createSprings(),this.createCockpit(),this.updateCameraFocalPoint(),this.stopSounds(),-1===s&&this.swap()}createCockpit(){let e=document.createElement("canvas");Object.defineProperty(this,"canvasCockpit",{value:e}),Object.defineProperty(this,"ctx",{value:e.getContext("2d")}),this.ctx.fillStyle=this.color,this.ctx.strokeStyle=this.color}createMasses(e){var t=[];t.push(new prop(new cartesian(e.x+0,e.y+18),this));var s=new mass(new cartesian(e.x+-17,e.y+42),this),i=new mass(new cartesian(e.x+17,e.y+42),this),a=new mass(new cartesian(e.x+-40,e.y+15),this),o=new mass(new cartesian(e.x+40,e.y+15),this);t.push(s),t.push(i),t.push(a),t.push(o),t[0].radius=18,t[1].radius=8,t[2].radius=8,t[3].grav=!1,t[4].grav=t[4].collide=!1,t[1].friction=.2,t[2].friction=.2,this.head=t[0],this.mass2=t[1],this.mass3=t[2],this.mass4=t[3],this.rotor=0,this.rotor2=0,this.dir=1;let r=this;t[3].drive=this.head.drive=function(){r.explode()},this.focalPoint=t[0],this.masses=t}createSprings(){let e=this.masses,t=this.springs;t.push(new spring(e[0],e[1],this)),t.push(new spring(e[2],e[0],this)),t.push(new spring(e[2],e[1],this)),t.push(new spring(e[0],e[3],this)),t.push(new spring(e[1],e[3],this)),t.push(new spring(e[0],e[4],this)),t.push(new spring(e[2],e[4],this)),this.spring1=t[0],this.spring2=t[1],this.spring3=t[2],this.spring4=t[3],this.spring5=t[4],this.spring6=t[5],this.spring7=t[6],t[0].leff=t[4].lrest=30,t[1].leff=t[4].lrest=30,t[2].leff=t[4].lrest=35,t[4].leff=t[4].lrest=35,t[6].leff=t[4].lrest=35;for(let e of t)e.dampConstant=.4,e.springConstant=.5}drawCockpit(){let e=this.canvasCockpit,t=this.scene.camera.zoom,s=50*t,i=50*t,a=Math.max(2*t,1),o=this.ctx;if(s!==e.width||i!==e.height||o.fillStyle!==this.color||o.strokeStyle!==this.color||o.lineWidth!==a){e.width=s,e.height=i;let r=this.masses[0].radius*t*.9;o.save(),o.translate(s/2,i/2),o.scale(1.3,1),o.beginPath(),o.arc(0,0,r,0,1.5*Math.PI,!1),o.lineTo(0,0),o.lineTo(r,0),o.closePath(),o.restore(),o.fillStyle=this.color,o.fill(),o.lineWidth=a,o.strokeStyle=this.color,o.stroke(),o.save(),o.translate(s/2,i/2),o.scale(1.3,1),o.beginPath(),o.arc(0,0,r,0,1.5*Math.PI,!0),o.restore(),o.stroke()}return e}updateCameraFocalPoint(){}fixedUpdate(){if(!super.fixedUpdate()){for(var e=this.springs,t=e.length,s=t-1;s>=0;s--)e[s].fixedUpdate();for(var i=this.masses,a=i.length,o=a-1;o>=0;o--)i[o].fixedUpdate();if((this.masses[1].contact||this.masses[2].contact)&&(this.slow=!1),!1===this.slow){for(!1===this.crashed&&this.control(),s=t-1;s>=0;s--)e[s].fixedUpdate();for(o=a-1;o>=0;o--)i[o].fixedUpdate()}this.updateCockpitAngle()}}update(){super.update(...arguments)}updateSound(){if(this.player.isInFocus()){let e=this.scene.sound,t=Math.min(this.head.motor,1);e.play(this.constructor.Sounds.Helicopter,t)}}swap(){let e=this.dir,t=this.springs,s=this.masses;e*=-1,t[2].swap();let i=new cartesian(0,0),a=new cartesian(0,0),o=new cartesian(0,0);i.equ(s[3].pos),a.equ(s[3].old),o.equ(s[3].vel),s[3].pos.equ(s[4].pos),s[3].old.equ(s[4].old),s[3].vel.equ(s[4].vel),s[4].pos.equ(i),s[4].old.equ(a),s[4].vel.equ(o),this.dir=e}control(){let e=this.player.getGamepad(),t=e.isButtonDown("up"),s=e.isButtonDown("back"),i=e.isButtonDown("left"),a=e.isButtonDown("right"),o=e.isButtonDown("z"),r=this.masses,n=this.springs;o&&!this.swapped&&(this.swap(),this.swapped=!0),o||(this.swapped=!1);let h=r[1].pos.add(r[2].pos).factor(.5);h=r[0].pos.sub(h),h=h.factor(1/h.len()),r[0].angle.equ(h);let l=t?1:0;r[0].motor+=(l-r[0].motor)/10;let c=i?1:0;c+=a?-1:0,n[2].rotate(c/6),s&&(this.scene.restartTrack=!0)}updateCockpitAngle(){let e=this.masses,t=e[0].displayPos,s=e[3].displayPos,i=t.x,a=t.y,o=i-s.x,r=a-s.y;this.cockpitAngle=-(Math.atan2(o,r)-Math.PI/2),this.rotor+=.5*this.head.motor+.05,this.rotor>6.2831&&(this.rotor-=6.2831),this.rotor2+=.5,this.rotor2>6.2831&&(this.rotor2-=6.2831)}draw(e){if(!super.draw(...arguments)){if(e.imageSmoothingEnabled=!0,e.webkitImageSmoothingEnabled=!0,e.mozImageSmoothingEnabled=!0,this.scene.ticks>0&&!this.player.isGhost()){if(!this.scene.state.playing){let t=window.lite&&parseInt(lite.storage.get("snapshots"));if(t>0){for(let s of this.player._checkpoints.filter(((e,s,i)=>s>i.length-(t+1)&&e._tempVehicle))){let i=document.createElement("canvas");this.drawHelicopter.call(Object.assign({},this,{player:this.player,scene:this.scene},JSON.parse(s._tempVehicle),{canvasCockpit:i,ctx:i.getContext("2d"),drawCockpit:this.drawCockpit}),e,t/300*this.player._checkpoints.indexOf(s)%1)}for(let s of this.player._cache.filter(((e,s,i)=>s>i.length-(t+1)&&e._tempVehicle))){let i=document.createElement("canvas");this.drawHelicopter.call(Object.assign({},this,{player:this.player,scene:this.scene},JSON.parse(s._tempVehicle),{canvasCockpit:i,ctx:i.getContext("2d"),drawCockpit:this.drawCockpit}),e,t/300*this.player._cache.indexOf(s)%1)}}}if(window.lite&&lite.storage.get("playerTrail"))for(let t of lite.snapshots.filter((e=>e._tempVehicle))){let s=document.createElement("canvas");this.drawHelicopter.call(Object.assign({},this,{player:this.player,scene:this.scene},JSON.parse(t._tempVehicle),{canvasCockpit:s,ctx:s.getContext("2d"),drawCockpit:this.drawCockpit}),e,lite.snapshots.length/(200*lite.snapshots.length)*parseInt(lite.snapshots.indexOf(t))%1)}}this.drawHelicopter(e)}}drawHelicopter(e,t=this.player._opacity){e.globalAlpha=t;let s=this.dir,i=this.rotor,a=this.rotor2,o=this.scene,r=o.camera.zoom,n=new cartesian(this.head.displayPos.x,this.head.displayPos.y),h=new cartesian(this.mass2.displayPos.x,this.mass2.displayPos.y).add(this.mass3.displayPos).factor(.5),l=n.sub(h).factor(r),c=new cartesian(-l.y*s,l.x*s),p=n.toScreen(o);e.strokeStyle=this.color,e.lineWidth=5*r,e.beginPath(),e.moveTo(p.x+.5*l.x,p.y+.5*l.y),e.lineTo(p.x+.8*l.x,p.y+.8*l.y),e.stroke(),e.lineWidth=3*r,e.beginPath();var d=.9*Math.cos(i);e.moveTo(p.x+.9*l.x+c.x*d,p.y+.8*l.y+c.y*d),e.lineTo(p.x+.9*l.x-c.x*d,p.y+.8*l.y-c.y*d),e.stroke();var u=new cartesian(this.mass2.displayPos.x,this.mass2.displayPos.y).toScreen(o),m=new cartesian(this.mass3.displayPos.x,this.mass3.displayPos.y).toScreen(o);e.lineWidth=3*r,e.strokeStyle="#".padEnd(7,/^(darker|midnight)$/.test(window.lite.storage.get("theme"))?"8":"dark"===window.lite.storage.get("theme")?"9":"6"),e.beginPath(),e.moveTo(u.x-.2*l.x,u.y-.2*l.y),e.lineTo(p.x,p.y),e.lineTo(m.x-.2*l.x,m.y-.2*l.y),e.stroke(),e.lineWidth=4*r,e.beginPath(),e.moveTo(u.x-.2*c.x-.1*l.x,u.y-.2*c.y-.1*l.y),e.lineTo(u.x-.25*l.x,u.y-.25*l.y),e.lineTo(m.x-.25*l.x,m.y-.25*l.y),e.lineTo(m.x+.2*c.x-.1*l.x,m.y+.2*c.y-.1*l.y),e.stroke(),e.lineWidth=6*r,e.strokeStyle=this.color,e.beginPath();var g=new cartesian(this.mass4.displayPos.x,this.mass4.displayPos.y).toScreen(o);e.moveTo(p.x,p.y),e.lineTo(g.x,g.y),e.lineTo(p.x-.1*l.x,p.y-.3*l.y),e.stroke(),e.lineWidth=2*r,e.strokeStyle=this.color,e.beginPath();var y=7*r,w=new cartesian(y*Math.sin(-a),y*Math.cos(-a));e.moveTo(g.x+w.x,g.y+w.y),e.lineTo(g.x-w.x,g.y-w.y),e.moveTo(g.x-w.y,g.y+w.x),e.lineTo(g.x+w.y,g.y-w.x),e.stroke(),e.beginPath(),e.lineWidth=2*r,e.arc(g.x,g.y,this.mass4.radius*r,0,2*Math.PI,!1),e.stroke(),h=this.drawCockpit();var f=h.width,x=h.height,v=p.x+5*r*this.dir,b=p.y+2*r,T=-f/2,k=-x/2,P=this.cockpitAngle,S=-1===s,_=this.cosmetics,C=GameInventoryManager.getItem(_.head),M=this.cockpitAngle;C.draw(e,v+5*r*s,b-5*r,M,.7*r,s),e.translate(v,b),e.rotate(P),S&&e.scale(1,-1),e.drawImage(h,T,k,f,x),S&&e.scale(1,-1),e.rotate(-P),e.translate(-v,-b),e.globalAlpha=1}};class InventoryManager{cache={};inventory={};loaded=new Set;constructor(){Object.defineProperty(this,"cache",{enumerable:!1}),Object.defineProperty(this,"loaded",{enumerable:!1})}getItem(e){let t=e.classname,s=e.script,i=e.options,a=e.type;this.inventory[t]||("1"===a&&(t="forward_cap",i={back:"white"}),!s||this.loaded.has(s)||(this.loaded.add(s),GameManager.loadFile(s)));let o=this.generateID(a,t,i);return this.cache[o]||=new this.inventory[t](i)}redraw(){let e=this.cache;for(let t in e)e[t].setDirty()}generateID(e,t,s){if(t=e+t,s)for(let e in s)s.hasOwnProperty(e)&&(t+=s[e]);return t}register(e,t){this.inventory[e]=t}clear(){this.cache={},this.inventory={},this.loaded.clear()}}window.GameInventoryManager=new InventoryManager;const head=GameInventoryManager.HeadClass=class{static Defaults={Outline:"hsl(0, 0%, 0%)",Skin:"hsl(0, 0%, 100%)"};versions={};createVersion(){let e=this.colors,t=this.getVersions(),s="";for(let t in e)s+=e[t];this.versionName=s,t[s]||={dirty:!0,canvas:document.createElement("canvas")}}draw(e,t,s,i,a,o){let r=this.getCache(a),n=this.getScale(),h=this.getBaseWidth()*a*n,l=this.getBaseHeight()*a*n,c=this.getDrawOffsetX()*a-h/2,p=this.getDrawOffsetY()*a-l/2,d=-1===o;e.translate(t,s),e.rotate(i),d&&e.scale(1,-1),e.drawImage(r,c,p,h,l),d&&e.scale(1,-1),e.rotate(-i),e.translate(-t,-s)}getCache(e){let t=this.getVersions();return t[this.versionName].dirty&&this.cache(e),t[this.versionName].canvas}getVersions(){return this.versions}setDirty(){this.getVersions()[this.versionName].dirty=!0}};class ForwardCap extends GameInventoryManager.HeadClass{drawAngle=0;constructor(e){super(),this.colors=e,this.createVersion()}cache(e){let t=this.versions[this.versionName],s=t.canvas,i=this.getScale()*Math.max(e,1);t.dirty=!1,s.width=this.getBaseWidth()*i,s.height=this.getBaseHeight()*i;let a=s.getContext("2d"),o=this.colors,r=Math.PI/12;a.scale(i,i),a.strokeStyle=o.outline||window.lite&&lite.storage.get("theme").startsWith("dark")?"hsl(0, 0%, 98%)":"midnight"===lite.storage.get("theme")?"hsl(0, 0%, 80%)":GameInventoryManager.HeadClass.Defaults.Outline,a.lineCap="round",a.lineJoin="miter",a.lineWidth=7,a.miterLimit=4,a.fillStyle=o.skin||window.lite&&"darker"===lite.storage.get("theme")?"hsl(231, 16%, 8%)":"dark"===lite.storage.get("theme")?"hsl(0, 0%, 11%)":"midnight"===lite.storage.get("theme")?"hsl(207, 16%, 14%)":GameInventoryManager.HeadClass.Defaults.Skin,a.save(),a.beginPath(),a.arc(42.4,52.5,30.3+a.lineWidth/2,0,2*Math.PI,!0),a.fill(),a.stroke(),a.clip(),a.beginPath(),a.arc(42.4,52.5,30.3,-r,Math.PI-r,!0),a.fillStyle=o.back,a.fill(),o.front&&(a.beginPath(),a.arc(42.4,52.5,30.3,-r,r-Math.PI/1.75,!0),a.lineTo(52.501,44.894999999999996),a.fillStyle=o.front,a.fill()),a.restore(),a.lineWidth=12,a.beginPath(),a.moveTo(16.3,60),a.lineTo(103.5,36.5),a.stroke()}getBaseWidth(){return 115}getBaseHeight(){return 112}getDrawOffsetX(){return 2.2}getDrawOffsetY(){return 1}getScale(){return.17}}GameInventoryManager&&GameInventoryManager.register("forward_cap",ForwardCap);const mtb=class extends bike{vehicleName="MTB";constructor(e,t,s,i){super(e),this.createMasses(t,i),this.createSprings(),this.updateCameraFocalPoint(),this.stopSounds(),-1===s&&this.swap()}createMasses(e,t){var s=new mass(new cartesian(e.x+2,e.y+-38),this),i=new wheel(new cartesian(e.x+23,e.y),this),a=new wheel(new cartesian(e.x+-23,e.y),this);s.drive=this.createRagdoll.bind(this),a.radius=14,i.radius=14,s.radius=14,s.vel.equ(t),a.vel.equ(t),i.vel.equ(t),this.masses.push(s),this.masses.push(a),this.masses.push(i),this.head=s,this.frontWheel=i,this.rearWheel=a}createSprings(){super.createSprings(),this.chasse.lrest=45,this.chasse.leff=45,this.chasse.springConstant=.2,this.chasse.dampConstant=.3,this.rearSpring.lrest=47,this.rearSpring.leff=47,this.rearSpring.springConstant=.2,this.rearSpring.dampConstant=.3,this.frontSpring.lrest=45,this.frontSpring.leff=45,this.frontSpring.springConstant=.2,this.frontSpring.dampConstant=.3}control(){let e=this.gamepad,t=e.isButtonDown("up"),s=e.isButtonDown("down"),i=e.isButtonDown("left"),a=e.isButtonDown("right"),o=e.isButtonDown("z"),r=this.rearWheel;r.motor+=(t-r.motor)/10,o&&!this.swapped&&(this.swap(),this.swapped=!0),o||(this.swapped=!1),t&&(this.pedala+=this.rearWheel.speed/5),r.brake=s,this.frontWheel.brake=!!(this.dir>0&&a&&s)||!!(this.dir<0&&i&&s);let n=i-a;this.rearSpring.contract(5*n*this.dir,5),this.frontSpring.contract(5*-n*this.dir,5),this.chasse.rotate(n/8),!n&&t&&(this.rearSpring.contract(-7,5),this.frontSpring.contract(7,5))}drawBikeFrame(e,t=this.player._opacity){let s=this.scene,i=new cartesian(this.frontWheel.displayPos.x,this.frontWheel.displayPos.y),a=new cartesian(this.rearWheel.displayPos.x,this.rearWheel.displayPos.y),o=new cartesian(this.head.displayPos.x,this.head.displayPos.y),r=i.toScreen(s),n=a.toScreen(s),h=o.toScreen(s),l=s.camera.zoom,c=r.sub(n),p=new cartesian(r.y-n.y,n.x-r.x),d=c.factor(.5),u=s.settings.physicsLineColor,m=s.settings.sceneryLineColor,g=m.padEnd(7,m.slice(1,4));p.factorSelf(this.dir),n.addOut(d,d),h.subOut(d,d),super.drawBikeFrame(...arguments),e.fillStyle=g+"33",this.frontWheel.draw(e),this.frontWheel.fill||e.fill(),this.frontWheel.stroke||e.stroke(),this.rearWheel.draw(e),this.rearWheel.fill||e.fill(),this.rearWheel.stroke||e.stroke(),e.strokeStyle="rgba(128,128,128,0.8)",e.fillStyle=m,e.lineWidth=1,e.beginPath(),e.arc(r.x,r.y,6*l,0,2*Math.PI,!1),e.fill(),e.stroke(),e.beginPath(),e.arc(n.x,n.y,6*l,0,2*Math.PI,!1),e.fill(),e.stroke(),e.beginPath(),e.strokeStyle=this.color,e.lineWidth=5*l,e.moveTo(n.x,n.y),e.lineTo(n.x+.4*c.x+.05*p.x,n.y+.4*c.y+.05*p.y),e.moveTo(n.x+.72*c.x+.64*d.x,n.y+.72*c.y+.64*d.y),e.lineTo(n.x+.46*c.x+.4*d.x,n.y+.46*c.y+.4*d.y),e.lineTo(n.x+.4*c.x+.05*p.x,n.y+.4*c.y+.05*p.y),e.stroke(),e.beginPath(),e.lineWidth=2*l,e.moveTo(n.x+.72*c.x+.64*d.x,n.y+.72*c.y+.64*d.y),e.lineTo(n.x+.43*c.x+.05*p.x,n.y+.43*c.y+.05*p.y),e.stroke(),e.beginPath(),e.lineWidth=1*l,e.moveTo(n.x+.46*c.x+.4*d.x,n.y+.46*c.y+.4*d.y),e.lineTo(n.x+.28*c.x+.5*d.x,n.y+.28*c.y+.5*d.y),e.stroke(),e.beginPath(),e.lineWidth=2*l,e.moveTo(n.x+.45*c.x+.3*d.x,n.y+.45*c.y+.3*d.y),e.lineTo(n.x+.3*c.x+.4*d.x,n.y+.3*c.y+.4*d.y),e.lineTo(n.x+.25*c.x+.6*d.x,n.y+.25*c.y+.6*d.y),e.moveTo(n.x+.17*c.x+.6*d.x,n.y+.17*c.y+.6*d.y),e.lineTo(n.x+.3*c.x+.6*d.x,n.y+.3*c.y+.6*d.y),e.stroke(),e.beginPath(),e.lineWidth=3*l,e.moveTo(r.x,r.y),e.lineTo(n.x+.71*c.x+.73*d.x,n.y+.71*c.y+.73*d.y),e.lineTo(n.x+.73*c.x+.77*d.x,n.y+.73*c.y+.77*d.y),e.lineTo(n.x+.7*c.x+.8*d.x,n.y+.7*c.y+.8*d.y),e.stroke(),e.beginPath(),e.lineWidth=1*l;let y=new cartesian(6*Math.cos(this.pedala)*l,6*Math.sin(this.pedala)*l);if(e.moveTo(n.x+.43*c.x+.05*p.x+y.x,n.y+.43*c.y+.05*p.y+y.y),e.lineTo(n.x+.43*c.x+.05*p.x-y.x,n.y+.43*c.y+.05*p.y-y.y),e.stroke(),this.crashed)this.ragdoll&&this.ragdoll.draw&&this.ragdoll.draw(e);else{c.factorOut(.5,p),n.addOut(p,p),h.subOut(p,p);let s=c.factor(.3);s.x=n.x+s.x+.25*p.x,s.y=n.y+s.y+.25*p.y;let i=c.factor(.4);i.x=n.x+i.x+.05*p.x,i.y=n.y+i.y+.05*p.y;let a=i.add(y),o=i.sub(y),r=c.factor(.67);r.x=n.x+r.x+.8*p.x,r.y=n.y+r.y+.8*p.y;let m=c.factor(-.05);m.x=s.x+m.x+.42*p.x,m.y=s.y+m.y+.42*p.y;let w=a.sub(m),f=w.lenSqr();d.x=w.y*this.dir,d.y=-w.x*this.dir,d.factorSelf(l**2);let x=w.factor(.5);x.x=m.x+x.x+d.x*(200/w.lenSqr()),x.y=m.y+x.y+d.y*(200/w.lenSqr());let v=w.factor(.12);v.x=a.x+v.x+d.x*(50/f),v.y=a.y+v.y+d.y*(50/f),o.subOut(m,w),f=w.lenSqr(),d.x=w.y*this.dir,d.y=-w.x*this.dir,d.factorSelf(l*l);let b=w.factor(.5);b.x=m.x+b.x+d.x*(200/f),b.y=m.y+b.y+d.y*(200/f);let T=w.factor(.12);T.x=o.x+T.x+d.x*(50/f),T.y=o.y+T.y+d.y*(50/f),g=this.player&&this.player.color||g,e.strokeStyle=g+Math.min(255,Math.round(127.5*t)).toString(16).padStart(Math.floor(g.length/3),0),e.lineWidth=6*l,e.beginPath(),e.moveTo(o.x,o.y),e.lineTo(b.x,b.y),e.lineTo(m.x,m.y),e.stroke(),e.lineWidth=4*l,e.beginPath(),e.moveTo(o.x,o.y),e.lineTo(T.x,T.y),e.stroke(),e.lineWidth=6*l,e.strokeStyle=u,e.beginPath(),e.moveTo(a.x,a.y),e.lineTo(x.x,x.y),e.lineTo(m.x,m.y),e.stroke(),e.lineWidth=4*l,e.beginPath(),e.moveTo(a.x,a.y),e.lineTo(v.x,v.y),e.stroke();let k=c.factor(.1);k.x=s.x+k.x+.95*p.x,k.y=s.y+k.y+.95*p.y,e.lineWidth=8*l,e.beginPath(),e.moveTo(m.x,m.y),e.lineTo(k.x,k.y),e.stroke();let P=c.factor(.2);P.x=s.x+P.x+1.09*p.x,P.y=s.y+P.y+1.09*p.y,e.beginPath(),e.lineWidth=2*l,k.subOut(r,c);let S=c.lenSqr();p.x=c.y*this.dir,p.y=-c.x*this.dir,p.factorSelf(l*l);let _=c.factor(.3);_.x=r.x+_.x+p.x*(80/S),_.y=r.y+_.y+p.y*(80/S),e.lineWidth=5*l,e.beginPath(),e.moveTo(k.x,k.y),e.lineTo(_.x,_.y),e.lineTo(r.x,r.y),e.stroke(),GameInventoryManager.getItem(this.cosmetics.head).draw(e,P.x,P.y,this.drawHeadAngle,l,this.dir),e.globalAlpha=1}}},vehicles_truck=class extends vehicle{static Sounds={TruckGround:"truck_idle"};color="#444";swapped=!1;vehicleName="TRUCK";constructor(e,t,s){super(e),this.createMasses(t),this.createSprings(),this.stopSounds(),this.updateCameraFocalPoint(),-1===s&&this.swap()}createMasses(e){this.masses.push(new mass(new cartesian(e.x-15,e.y+7),this)),this.masses.push(new mass(new cartesian(e.x+15,e.y+7),this)),this.masses[0].friction=.1,this.masses[1].friction=.1,this.masses.push(new wheel(new cartesian(e.x-20,e.y+35),this)),this.masses.push(new wheel(new cartesian(e.x+20,e.y+35),this)),this.masses[2].radius=this.masses[3].radius=14,this.masses[0].radius=this.masses[1].radius=7,this.head=this.masses[0],this.backMass=this.masses[1],this.rearWheel=this.masses[2],this.frontWheel=this.masses[3]}createSprings(){let e=this.masses;this.springs.push(new spring(e[0],e[1],this)),this.springs.push(new spring(e[0],e[2],this)),this.springs.push(new spring(e[1],e[3],this)),this.springs.push(new spring(e[0],e[3],this)),this.springs.push(new spring(e[1],e[2],this)),this.springs.push(new spring(e[2],e[3],this)),this.springs[0].leff=this.springs[0].lrest=30,this.springs[1].leff=this.springs[1].lrest=30,this.springs[2].leff=this.springs[2].lrest=30,this.springs[3].leff=this.springs[3].lrest=45,this.springs[4].leff=this.springs[4].lrest=45;for(let e in this.springs)this.springs[e].springConstant=.3}updateCameraFocalPoint(){}fixedUpdate(){if(!super.fixedUpdate()){for(var e=this.springs,t=e.length,s=t-1;s>=0;s--)e[s].fixedUpdate();for(var i=this.masses,a=i.length,o=a-1;o>=0;o--)i[o].fixedUpdate();if(this.rearWheel.contact&&this.frontWheel.contact&&(this.slow=!1),!1===this.slow){for(!1===this.crashed&&this.control(),s=t-1;s>=0;s--)e[s].fixedUpdate();for(o=a-1;o>=0;o--)i[o].fixedUpdate()}this.updateDrawHeadAngle(),this.updateCameraFocalPoint()}}updateSound(){if(this.player.isInFocus()){let e=this.scene.sound;if(this.rearWheel.contact){let t=Math.min(this.rearWheel.motor,1);e.play(this.constructor.Sounds.TruckGround,t)}else if(this.frontWheel.contact){let t=Math.min(this.frontWheel.motor,1);e.play(this.constructor.Sounds.TruckGround,t)}else e.stop(this.constructor.Sounds.TruckGround)}}updateCameraFocalPoint(){this.focalPoint=1===this.dir?this.head:this.backMass}updateDrawHeadAngle(){let e=this.frontWheel.displayPos,t=this.rearWheel.displayPos,s=e.x,i=e.y,a=s-t.x,o=i-t.y;this.drawHeadAngle=-(Math.atan2(a,o)-Math.PI/2)}swap(){this.dir=-1*this.dir,this.springs[0].swap(),this.springs[5].swap()}control(){let e=this.gamepad,t=e.isButtonDown("up"),s=e.isButtonDown("down"),i=e.isButtonDown("left"),a=e.isButtonDown("right"),o=e.isButtonDown("z");o&&!this.swapped&&(this.swap(),this.swapped=!0),o||(this.swapped=!1);let r=t?1:0,n=this.rearWheel,h=this.frontWheel;n.motor+=(.8*r-n.motor)/10,h.motor+=(.8*r-h.motor)/10,n.brake=s,h.brake=s;let l=i?1:0;l+=a?-1:0;let c=this.springs;c[0].rotate(l/8),c[5].rotate(l/8)}draw(e){if(!super.draw(...arguments)){if(this.scene.ticks>0&&!this.player.isGhost()){if(!this.scene.state.playing){let t=window.lite.storage.get("snapshots");if(t>0){for(let s of this.player._checkpoints.filter(((e,s,i)=>s>i.length-(t+1)&&e._tempVehicle)))e.globalAlpha=t/300*this.player._checkpoints.indexOf(s)%1,this.drawTruck.call(Object.assign({},this,{player:this.player,scene:this.scene},JSON.parse(s._tempVehicle),{tire:this.tire}),e);for(let s of this.player._cache.filter(((e,s,i)=>s>i.length-(t+1)&&e._tempVehicle)))e.globalAlpha=t/300*this.player._cache.indexOf(s)%1,this.drawTruck.call(Object.assign({},this,{player:this.player,scene:this.scene},JSON.parse(s._tempVehicle),{tire:this.tire}),e)}}if(window.lite&&lite.storage.get("playerTrail"))for(let t of lite.snapshots.filter((e=>e._tempVehicle)))e.globalAlpha=lite.snapshots.length/(200*lite.snapshots.length)*lite.snapshots.indexOf(t)%1,this.drawTruck.call(Object.assign({},this,{player:this.player,scene:this.scene},JSON.parse(t._tempVehicle),{tire:this.tire}),e)}if(e.imageSmoothingEnabled=!0,e.mozImageSmoothingEnabled=!0,e.webkitImageSmoothingEnabled=!0,this.settings.developerMode)for(let e=this.masses,t=e.length-1;t>=0;t--)e[t].draw();e.globalAlpha=this.player._opacity,this.drawTruck(e),e.globalAlpha=1}}drawTruck(e){let t=this.scene,s=t.camera.zoom,i=GameInventoryManager.getItem(this.cosmetics.head),a=this.drawHeadAngle,o=this.dir,r=new cartesian(this.frontWheel.displayPos.x,this.frontWheel.displayPos.y).toScreen(t),n=new cartesian(this.rearWheel.displayPos.x,this.rearWheel.displayPos.y).toScreen(t),h=new cartesian(this.head.displayPos.x,this.head.displayPos.y).toScreen(t),l=new cartesian(this.backMass.displayPos.x,this.backMass.displayPos.y).toScreen(t),c=(this.backMass.displayPos.x-this.head.displayPos.x)*s,p=(this.backMass.displayPos.y-this.head.displayPos.y)*s,d=(.5*(this.head.displayPos.x+this.backMass.displayPos.x)-.5*(this.rearWheel.displayPos.x+this.frontWheel.displayPos.x))*s,u=(.5*(this.head.displayPos.y+this.backMass.displayPos.y)-.5*(this.rearWheel.displayPos.y+this.frontWheel.displayPos.y))*s,m="#".padEnd(7,/^(darker|midnight)$/.test(window.lite.storage.get("theme"))?"a":"dark"===lite.storage.get("theme")?"b":"4");e.lineWidth=3*s;let g=l.x-h.x,y=l.y-h.y,w=Math.sqrt(g**2+y**2),f=g/w,x=y/w;i.draw(e,l.x-.5*f*s*20,l.y-x*s*20*.5,a,.45*s,o),e.strokeStyle=m,e.beginPath(),e.moveTo(h.x-.4*c-.9*d,h.y-.4*p-.9*u),e.lineTo(h.x+.8*c-.9*d,h.y+.8*p-.9*u),e.stroke(),e.closePath(),e.save(),e.fillStyle="#808080",e.beginPath(),e.moveTo(h.x-.4*c-.7*d,h.y-.4*p-.7*u),e.lineTo(h.x-.4*c-.7*d,h.y-.4*p-.7*u),e.lineTo(h.x+1.4*c-.7*d,h.y+1.4*p-.7*u),e.lineTo(h.x+1.35*c-.2*d,h.y+1.35*p-.2*u),e.lineTo(h.x+.9*c-.1*d,h.y+.9*p-.1*u),e.lineTo(h.x+.5*c-.1*d,h.y+.5*p-.1*u),e.lineTo(h.x+.5*c+.2*d,h.y+.5*p+.2*u),e.lineTo(h.x-.35*c+.2*d,h.y-.35*p+.2*u),e.closePath(),e.fill(),e.save(),e.lineWidth=2*s,e.strokeStyle=m,e.beginPath(),e.moveTo(h.x-.4*c-.7*d,h.y-.4*p-.7*u),e.lineTo(h.x-.35*c+.2*d,h.y-.35*p+.2*u),e.lineTo(h.x+.8*c+.2*d,h.y+.8*p+.2*u),e.lineTo(h.x+.9*c-.1*d,h.y+.9*p-.1*u),e.lineTo(h.x+1.35*c-.2*d,h.y+1.35*p-.2*u),e.lineTo(h.x+1.4*c-.7*d,h.y+1.4*p-.7*u),e.lineTo(h.x-.4*c-.7*d,h.y-.4*p-.7*u),e.closePath(),e.stroke(),e.lineWidth=s,e.beginPath(),e.moveTo(h.x+.5*c-.1*d,h.y+.5*p-.1*u),e.lineTo(h.x+.9*c-.1*d,h.y+.9*p-.1*u),e.lineTo(h.x+.8*c+.2*d,h.y+.8*p+.2*u),e.lineTo(h.x+.5*c+.2*d,h.y+.5*p+.2*u),e.lineTo(h.x+.5*c-.1*d,h.y+.5*p-.1*u),e.closePath(),e.stroke(),e.strokeStyle=t.settings.physicsLineColor,this.tire(e,n.x,n.y,10*s,s,this.rearWheel.angle),this.tire(e,r.x,r.y,10*s,s,this.frontWheel.angle),e.restore()}tire(e,t,s,i,a,o){e.beginPath(),e.arc(t,s,10*a,0,2*Math.PI,!1),e.fillStyle="#888888",e.fill(),e.lineWidth=5.9*a,e.closePath(),e.stroke(),e.beginPath(),e.lineWidth=2*a,i+=3*a;let r=0,n=2*Math.PI;for(;r++<8;)e.moveTo(t+i*Math.cos(o+n*r/8),s+i*Math.sin(o+n*r/8)),e.lineTo(t+i*Math.cos(o+n*(r+.5)/8),s+i*Math.sin(o+n*(r+.5)/8));for(e.stroke(),e.closePath(),e.beginPath(),r=0,i+=-9*a;r++<5;)e.moveTo(t+i*Math.cos(o+n*r/5),s+i*Math.sin(o+n*r/5)),e.lineTo(t+i*Math.cos(o+n*(r+.2)/5),s+i*Math.sin(o+n*(r+.2)/5));e.closePath(),e.stroke()}};let g=0,v={BMX:bmx,MTB:mtb,HELI:vehicles_helicopter,TRUCK:vehicles_truck,BALLOON:vehicles_balloon,BLOB:vehicles_blob};function m(e,t){for(var s in t)try{e[s]=t[s].constructor==Object?m(e[s],t[s]):t[s]}catch(i){e[s]=t[s]}return e}const player=class{_ghost=!1;color="#000000";id=g++;constructor(e,t){Object.defineProperties(this,{_scene:{value:e,writable:!0},_game:{value:e.game,writable:!0}}),this._user=t,this._settings=e.settings;let s=e.settings.startVehicle;e.settings.track&&(s=e.settings.track.vehicle),this._baseVehicleType=s,this._gamepad=new gamepad(e),t.color&&(this._color=t.color),this.setDefaults(),this.createBaseVehicle(new cartesian(0,35),1,new cartesian(0,0))}getCheckpointCount(){return this._checkpoints.length}setDefaults(){this._baseVehicle=!1,this._tempVehicleType=null,this._tempVehicle=!1,this._tempVehicleTicks=0,this._temp_vehicle_options=null,this._addCheckpoint=!1,this._checkpoints=[],this._cache=[],this._crashed=!1,this._effect=!1,this._effectTicks=0,this._opacity=1,this.complete=!1,this._powerupsConsumed={checkpoints:[],targets:[],misc:[]}}hasCheckpoints(){return this._checkpoints.length>0}setColor(e){this._color=e}dead(){if(this._crashed=!0,!1===this._ghost){let e=this._scene,t=e.message;e.state.playerAlive=this.isAlive(),t.show(this._checkpoints.length>0?"Press Enter For Checkpoint":"Press Enter To Restart!",!1)}}setAsGhost(){this._ghost=!0,this._replayIterator=this.createReplayIterator()}isGhost(){return this._ghost}isAlive(){return!this._crashed}getTargetsHit(){return this._scene.track.targets.filter((e=>this._powerupsConsumed.targets.includes(e.id))).reduce(((e,t)=>e+t.multiplier),0)}getGamepad(){return this._gamepad}setBaseVehicle(e){this._baseVehicleType!==e&&(this._baseVehicleType=e,this.reset())}createBaseVehicle(e,t,s){this._tempVehicle&&this._tempVehicle.stopSounds(),this._baseVehicle=new v[this._baseVehicleType](this,e,t,s),this._game.emit("baseVehicleCreate",this._baseVehicle),this._tempVehicle=!1,this._tempVehicleType=!1,this._tempVehicleTicks=0}setTempVehicle(e,t,s,i){this._temp_vehicle_options&&this._temp_vehicle_options.type===e&&(t=this._temp_vehicle_options.ticks+t),this._temp_vehicle_options={type:e,ticks:t,position:s,direction:i}}createTempVehicle(e,t,s,i){if(this._temp_vehicle_options){let a=this._temp_vehicle_options;e=a.type,t=a.ticks,s=a.position,i=a.direction,this._temp_vehicle_options=null}this._tempVehicleType===e?this._tempVehicleTicks+=t:(this.getActiveVehicle().stopSounds(),this._effect=new explosion(s,this._scene),this._effectTicks=45,this._tempVehicleType=e,this._tempVehicle=new v[e](this,s,i),this._game.emit("tempVehicleCreate",this._tempVehicle),this._tempVehicleTicks=t)}fixedUpdate(){let e=this._baseVehicle;this._temp_vehicle_options&&this.createTempVehicle(),this._tempVehicleTicks>0&&(e=this._tempVehicle,!1===this._crashed&&this._tempVehicleTicks--,this._tempVehicleTicks<=0&&!1===this._crashed&&(this._effectTicks=45,this._effect=new explosion(this._tempVehicle.focalPoint.displayPos,this._scene),this.createBaseVehicle(this._tempVehicle.focalPoint.pos,this._tempVehicle.dir,this._tempVehicle.masses[0].vel),e=this._baseVehicle)),this._effectTicks>0&&(this._effectTicks--,this._effect.fixedUpdate()),window.hasOwnProperty("lite")&&lite.storage.get("playerTrail")&&this.isGhost()||this.isAlive()&&lite.snapshots.push(this._createSnapshot()),e.fixedUpdate(),this._addCheckpoint&&(this._createCheckpoint(),this._addCheckpoint=!1)}update(){this.getActiveVehicle().update(...arguments)}lateUpdate(){this.getActiveVehicle().lateUpdate(...arguments)}*createReplayIterator(e=0){const t=new Map;for(this._gamepad.playbackTicks=0;!1===this.complete;){if(t.has(this._gamepad.playbackTicks)||this.isAlive()&&t.set(this._gamepad.playbackTicks,{downButtons:Object.assign({},this._gamepad.downButtons),snapshot:this._createSnapshot()}),this._gamepad.playbackTicks>=e){const s=yield this._gamepad.playbackTicks;if(isFinite(s)){if(t.has(s)){let{downButtons:e,snapshot:i}=t.get(s);this._checkpoints.push(i),this.gotoCheckpoint(),this._checkpoints.pop(),this._gamepad.playbackTicks=s,this._gamepad.downButtons=Object.assign({},e)}else s<e&&this.reset();this._scene.camera.focusIndex=this._scene.playerManager._players.indexOf(this),this._scene.camera.focusOnPlayer(),e=s;continue}e=this._gamepad.playbackTicks+1/(this._game.config.tickRate/30)}this._gamepad.update(),this.checkKeys(),this.fixedUpdate(),!this.complete&&(this._gamepad.playbackTicks+=1/(this._game.config.tickRate/30)),this.isInFocus()&&this._game.emit("replayTick",this._gamepad.playbackTicks)}return this.loop&&(this.reset(),this._replayIterator=this.createReplayIterator()),t}isInFocus(){return this._scene.camera.playerFocus&&this._scene.camera.playerFocus===this}updateOpacity(){let e=1;if(this._scene.camera.playerFocus&&this._scene.camera.playerFocus!==this){var t=this.getDistanceBetweenPlayers(this._scene.camera.playerFocus);1200>t&&(e=Math.min(t/500,1))}this._opacity=e}drawName(e){let t=this.getActiveVehicle().focalPoint.displayPos.toScreen(this._scene);e.globalAlpha=this._opacity,e.textAlign="center",this._user.badges&&this._user.badges.size>0?(e.font=10*this._scene.game.pixelRatio*this._scene.camera.zoom+"pt helsinki",e.strokeText(Array.from(this._user.badges)[0],t.x,t.y-40*this._scene.camera.zoom)):(e.beginPath(),e.fillStyle=this._color,e.moveTo(t.x,t.y-40*this._scene.camera.zoom),e.lineTo(t.x-5*this._scene.camera.zoom,t.y-50*this._scene.camera.zoom),e.lineTo(t.x+5*this._scene.camera.zoom,t.y-50*this._scene.camera.zoom),e.lineTo(t.x,t.y-40*this._scene.camera.zoom),e.fill()),e.font=9*this._scene.game.pixelRatio*Math.max(this._scene.camera.zoom,1)+"pt helsinki";let s=t.y-60*this._scene.camera.zoom;if(this._user.gradient&&this._user.gradient.length>0){let i=e.measureText(this._user.d_name),a=e.createLinearGradient(i.width/2,s-(i.fontBoundingBoxAscent+i.fontBoundingBoxDescent)/2,i.width/2,s+(i.fontBoundingBoxAscent+i.fontBoundingBoxDescent)/2);for(let e in this._user.gradient)a.addColorStop(e,this._user.gradient[e]);a.addColorStop(this._user.gradient.length,this._color),e.fillStyle=a,e.save(),e.lineWidth=.8*this._scene.game.pixelRatio*Math.max(this._scene.camera.zoom,1),e.strokeStyle=this._color,e.strokeText(this._user.d_name,t.x,s),e.restore()}else e.fillStyle=this._color;e.fillText(this._user.d_name,t.x,s),e.globalAlpha=1}draw(e){this.updateOpacity();let t=this._baseVehicle;this._tempVehicleTicks>0&&(t=this._tempVehicle),this._effectTicks>0&&this._effect.draw(e,this._effectTicks/100),t.draw(e),window.hasOwnProperty("lite")&&lite.storage.get("confirmRestart")&&this._gamepad.isButtonDown("restart")&&this.drawRestart(e),this.isGhost()&&this.drawName(e)}drawRestart(e){let t=this.getActiveVehicle().focalPoint.displayPos.toScreen(this._scene),s=this._scene.ticks-this._restartTimeout,i=16*this._scene.camera.zoom;e.save(),e.fillStyle=this._settings.UITextColor||this._settings.physicsLineColor,e.font=i+"px Helsinki",1!==e.globalAlpha&&(e.globalAlpha=1),e.lineWidth=i/2.5,e.strokeStyle=this._settings.UITextColor||this._settings.physicsLineColor,e.textAlign="center",e.textBaseline="bottom",e.fillText("R",t.x,t.y-50*this._scene.camera.zoom),e.beginPath(),e.arc(t.x,t.y-i/1.6-50*this._scene.camera.zoom,1.25*i,0,2*Math.PI*((12-s)/12),!0),e.globalAlpha=Math.min(1,Math.max(.1,s/12)),e.stroke(),e.restore()}checkKeys(){let e,t=this._gamepad,s=this._ghost,i=this._scene;!t.isButtonDown("enter")&&!t.isButtonDown("backspace")&&t.areKeysDown()&&this._cache.length>0&&(this._cache=[]),t.isButtonDown("shift")&&t.isButtonDown("enter")&&(e=t.getButtonDownOccurances("enter"),this.returnToCheckpoint(e),t.setButtonUp("enter")),!1===s&&(t.areKeysDown()&&!this._crashed&&i.play(),t.isButtonDown("restart")?(!window.hasOwnProperty("lite")||!lite.storage.get("confirmRestart")||!(this._restartTimeout??(i.ticks>0&&Object.defineProperty(this,"_restartTimeout",{value:i.ticks,writable:!0}))))&&(i.restartTrack=!0,t.setButtonUp("restart")):this._restartTimeout=null,(t.isButtonDown("up")||t.isButtonDown("down")||(!i.camera.focusIndex||(e=i.camera.playerFocus)&&e._gamepad.playbackTicks<1)&&(t.isButtonDown("left")||t.isButtonDown("right")))&&i.camera.focusOnMainPlayer()),t.isButtonDown("enter")&&(this.gotoCheckpoint(),t.setButtonUp("enter")),t.isButtonDown("backspace")&&(e=t.getButtonDownOccurances("backspace"),this.removeCheckpoint(e),t.setButtonUp("backspace"))}getDistanceBetweenPlayers(e){const t=e.getActiveVehicle(),s=this.getActiveVehicle();return t.focalPoint.displayPos.sub(s.focalPoint.displayPos).len()}getActiveVehicle(){return this._tempVehicleTicks>0?this._tempVehicle:this._baseVehicle}_createCheckpoint(){this._checkpoints.push(this._createSnapshot())}_createSnapshot(){let e={};return this._tempVehicleTicks>0?(e._tempVehicleType=this._tempVehicleType,e._tempVehicle=JSON.stringify(this._tempVehicle,this._snapshotFilter),e._tempVehicleTicks=this._tempVehicleTicks):(e._baseVehicleType=this._baseVehicleType,e._baseVehicle=JSON.stringify(this._baseVehicle,this._snapshotFilter)),e._powerupsConsumed=JSON.stringify(this._powerupsConsumed),e._crashed=this._crashed,e}_snapshotFilter(e,t){switch(e){case"parent":case"player":case"scene":case"settings":case"masses":case"springs":case"focalPoint":case"gamepad":return;case"explosion":return!1;default:return t}}setCheckpointOnUpdate(){this._addCheckpoint=!0}crashed(){this._crashed=!0}gotoCheckpoint(){let e=this._gamepad.replaying,t=this._scene;if(this._checkpoints.length>0){let s=this._checkpoints[this._checkpoints.length-1];if(s._tempVehicle){this._baseVehicle.stopSounds();let e=this._tempVehicle;this._tempVehicleType!==s._tempVehicleType&&(e=new v[s._tempVehicleType](this,{x:0,y:0})),m(e,JSON.parse(s._tempVehicle)),this._tempVehicle=e,this._tempVehicleType=s._tempVehicleType,this._tempVehicleTicks=s._tempVehicleTicks,e.updateCameraFocalPoint()}else{let e=this._baseVehicle;m(e,JSON.parse(s._baseVehicle)),this._tempVehicle&&this._tempVehicle.stopSounds(),this._tempVehicleTicks=0,this._tempVehicleType=!1,e.updateCameraFocalPoint()}if(this._powerupsConsumed=JSON.parse(s._powerupsConsumed),this._crashed=s._crashed,!1===e){let e=t.settings;t.state.playerAlive=this.isAlive(),t.message.show("Press Backspace To Go Back Further",5,"#826cdc","#FFFFFF"),t.track.updatePowerupState(this),e.waitAtCheckpoints&&(t.state.playing=!1),t.camera.focusOnMainPlayer()}t.camera.playerFocus===this&&t.camera.fastforward()}else!1===e&&this.restartScene()}restartScene(){!1===this._gamepad.replaying&&(this._scene.restartTrack=!0)}removeCheckpoint(e){if(this._checkpoints.length>1){for(let t=0;e>t;t++)this._cache.push(this._checkpoints.pop());this.gotoCheckpoint()}else this.restartScene()}returnToCheckpoint(e){if(this._cache.length>0){for(var t=0;e>t;t++)this._checkpoints.push(this._cache.pop());this.gotoCheckpoint()}}close(){this.id=null,this._scene=null,this._game=null,this._user=null,this._settings=null,this._baseVehicleType=null,this._gamepad.close(),this._gamepad=null,this._baseVehicle=null,this._tempVehicleType=null,this._tempVehicle=null,this._tempVehicleTicks=null,this._addCheckpoint=null,this._checkpoints=null,this._cache=null,this._crashed=null,this._effect=null,this._effectTicks=null,this._powerupsConsumed=null}reset(){this._restartTimeout=null,this._tempVehicle&&this._tempVehicle.stopSounds(),this._baseVehicle.stopSounds(),this.setDefaults(),this.createBaseVehicle(new cartesian(0,35),1,new cartesian(0,0)),this._gamepad.reset(),this._scene.state.playerAlive=this.isAlive(),this._game.emit("playerReset",this)}},player_manager=class{_players=[];_playerLookup={};firstPlayer=null;constructor(e){Object.defineProperty(this,"scene",{value:e,writable:!0}),Object.defineProperty(this,"game",{value:e.game,writable:!0}),this.settings=e.settings}fixedUpdate(){if(!this.scene.camera.focusIndex)for(const e of this._players.filter((e=>!e.complete&&!e.isGhost())))e.fixedUpdate();for(const{_replayIterator:e}of this._players.filter((e=>!e.complete&&e.isGhost())))e.next();window.hasOwnProperty("lite")&&lite.storage.get("confirmRestart")&&this.firstPlayer&&this.firstPlayer._gamepad.isButtonDown("restart")&&this.firstPlayer._restartTimeout&&this.scene.ticks-this.firstPlayer._restartTimeout>=10&&(this.scene.restartTrack=!0,this.firstPlayer._gamepad.setButtonUp("restart"))}update(){for(const e of this._players.filter((e=>!e.complete)))e.update(...arguments)}lateUpdate(){for(const e of this._players.filter((e=>!e.complete)))e.lateUpdate(...arguments)}mutePlayers(){for(let e=this._players,t=e.length,s=0;t>s;s++)e[s].getActiveVehicle().stopSounds()}updateGamepads(){for(const{_gamepad:e}of this._players.filter((e=>!e.isGhost())))e.update()}createPlayer(e,t){return new player(this.scene,t)}addPlayer(e){this._players.push(e),this._playerLookup[e.id]=e,this.game.emit("playerAdd",e)}checkKeys(){for(const e of this._players.filter((e=>!e.isGhost())))e.checkKeys()}draw(e){for(const t of this._players)t.draw(e)}getPlayerByIndex(e){return this._players[e]}getPlayerById(e){return this._playerLookup[e]}getPlayerCount(){return this._players.length}removePlayer(e){let t=this._players,s=this._playerLookup,i=t.find((t=>e==t._user.u_id&&t.isGhost()));t.splice(t.indexOf(i),1),delete s[i.id],this.game.emit("playerRemove",i)}reset(){for(const e of this._players)e.reset(),e.isGhost()&&(e._replayIterator=e.createReplayIterator())}clear(){this._players.splice(1);for(const e in this._playerLookup)e!==this.firstPlayer.id&&delete this._playerLookup[e];this.scene.camera.focusIndex>0&&this.scene.camera.unfocus()}_closePlayers(){for(const e of this._players)e.close()}close(){this._closePlayers(),this._players=null,this._playerLookup=null,this.firstPlayer=null,this.scene=null,this.game=null,this.settings=null}},camera=class{desiredZoom=1;focusIndex=0;playerFocus=null;position=new cartesian;settings=null;zoom=1;zooming=!1;zoomPercentage=0;zoomPoint=!1;constructor(e){Object.defineProperty(this,"scene",{value:e,writable:!0}),this.settings=e.settings,this.desiredZoom=e.settings.cameraStartZoom*e.game.pixelRatio,this.zoom=this.desiredZoom,this.zoomPercentage=this.getZoomAsPercentage()}focusOnNextPlayer(){this.focusIndex=(this.focusIndex+1)%this.scene.playerManager.getPlayerCount(),this.focusOnPlayer()}focusOnPlayer(){this.scene.playerManager.getPlayerCount()<=this.focusIndex&&(this.focusIndex=0);let e=this.scene.playerManager.getPlayerByIndex(this.focusIndex);this.playerFocus!==e&&(0===this.focusIndex&&(this.scene.playerManager._players.filter((e=>e.isGhost())).forEach((e=>e._replayIterator.next(this.scene.ticks))),this.focusIndex=0),this.playerFocus=e,this.scene.vehicleTimer.setPlayer(e),this.playerFocus?e.getDistanceBetweenPlayers(this.playerFocus)>1500&&this.fastforward():this.fastforward(),this.scene.game.emit("cameraFocus",e))}focusOnMainPlayer(){0===this.focusIndex&&this.playerFocus||(this.focusIndex=0,this.focusOnPlayer())}update(){if(!this.playerFocus)return;const{focalPoint:e}=this.playerFocus.getActiveVehicle(),{displayPos:t}=e,s=t.sub(this.position).len(),i=1-Math.exp(s/500*-3);this.position.lerpTo(t,i)}updateZoom(e){this.desiredZoom!==this.zoom&&(this.scene.loading=!0,this._performZoom(e),this.zoom===this.desiredZoom&&this.zoomComplete())}zoomToPoint(e){this.position.x=this.scene.screen.toReal(this.zoomPoint.x,"x")-this.scene.screen.width/e*this.zoomPoint.x/this.scene.screen.width+this.scene.screen.width/e/2,this.position.y=this.scene.screen.toReal(this.zoomPoint.y,"y")-this.scene.screen.height/e*this.zoomPoint.y/this.scene.screen.height+this.scene.screen.height/e/2}_performZoom(e){let t=this.zoom+(this.desiredZoom-this.zoom)/(3/e);Math.abs(this.desiredZoom-this.zoom)<.05&&(t=this.desiredZoom),this.zoomPoint&&this.zoomToPoint(t),this.zoom=t}zoomComplete(){this.scene.redraw(),this.zooming=!1,this.scene.loading=!1}setZoom(e,t){this.desiredZoom=Math.round(e*window.devicePixelRatio*10)/10,this.zooming=!0,this.desiredZoom===this.zoom&&(this.zooming=!1,this.scene.state.loading=!1),this.zoomPoint=!1,null===this.playerFocus&&t&&(this.zoomPoint=t),this.zoomPercentage=this.getZoomAsPercentage(),this.scene.updateState()}resetZoom(){this.setZoom(this.settings.cameraStartZoom)}getZoomAsPercentage(){return this.desiredZoom/window.devicePixelRatio/this.scene.settings.cameraStartZoom*100|0}increaseZoom(){this.setZoom((this.desiredZoom+2*this.scene.settings.cameraSensitivity)/window.devicePixelRatio),this.desiredZoom>this.scene.settings.cameraZoomMax*window.devicePixelRatio&&this.setZoom(this.scene.settings.cameraZoomMax)}decreaseZoom(){this.setZoom((this.desiredZoom-2*this.scene.settings.cameraSensitivity)/window.devicePixelRatio),this.desiredZoom<this.scene.settings.cameraZoomMin*window.devicePixelRatio&&this.setZoom(this.scene.settings.cameraZoomMin)}unfocus(){this.focusIndex=0,this.playerFocus=null,this.scene.vehicleTimer.removePlayer()}fastforward(){if(!this.playerFocus)return;const{focalPoint:{displayPos:e}}=this.playerFocus.getActiveVehicle();this.position.equ(e)}close(){this.zoom=null,this.scene=null,this.position=null,this.playerFocus=null}},view_screen=class{center=new cartesian;size=new cartesian;width=0;height=0;constructor(e){Object.defineProperties(this,{scene:{value:e,writable:!0},game:{value:e.game,writable:!0}}),this.setScreen()}setScreen(){this.width=this.game.width,this.height=this.game.height,this.size.x=this.game.width,this.size.y=this.game.height,this.center.x=this.game.width/2,this.center.y=this.game.height/2}update(){(this.game.width!==this.width||this.game.height!==this.height)&&this.setScreen()}realToScreen(e,t){return(e-this.scene.camera.position[t])*this.scene.camera.zoom+this.scene.screen.center[t]}toReal(e,t){return(e-this.scene.screen.center[t])/this.scene.camera.zoom+this.scene.camera.position[t]}close(){this.width=null,this.height=null,this.center=null,this.size=null,this.game=null,this.scene=null}},BaseScene=class{assets=null;settings=null;camera=null;screen=null;mouse=null;track=null;ticks=0;state=null;oldState=null;vehicle="Mtb";importCode=!1;message=new messagemanager(this);constructor(e){Object.defineProperty(this,"game",{value:e,writable:!0}),this.assets=e.assets,this.settings=e.settings,this.mouse=new mousehandler(this),this.camera=new camera(this),this.score=new score(this),this.screen=new view_screen(this),this.sound=new soundmanager(this),this.createTrack(),this.loadingcircle=new loadingcircle(this),this.playerManager=new player_manager(this),this.vehicleTimer=new vehicletimer(this)}buttonDown(e){let t=this.camera;switch(e){case"change_camera":t.focusOnNextPlayer();break;case"pause":this.state.paused=!this.state.paused,"mediaSession"in navigator&&(navigator.mediaSession.playbackState=this.state.paused?"paused":"playing"),this.state.paused&&Object.defineProperty(this,"_idleStateTimeout",{value:setTimeout((()=>this.state.idle=this.state.paused),300),writable:!0})||(this._idleStateTimeout&&clearTimeout(this._idleStateTimeout),this.state.idle=!1),this.updateState();break;case"settings":this.openDialog("settings");break;case"exit_fullscreen":this.exitFullscreen();break;case"change_vehicle":this.toggleVehicle(),this.updateState();break;case"zoom_increase":t.increaseZoom(),this.updateState();break;case"zoom_decrease":t.decreaseZoom(),this.updateState();break;case"fullscreen":this.toggleFullscreen(),this.updateState()}}createMainPlayer(){let e=this.playerManager.createPlayer(this,this.settings.user),t=e.getGamepad();return t.onButtonDown=this.buttonDown.bind(this),t.listen(),this.playerManager.firstPlayer=e,this.playerManager.addPlayer(e),t}createTrack(){this.track&&this.track.close();let e=new track(this);return this.track=e,e}command(e,...t){switch(e){case"resize":this.resize();break;case"dialog":var s=t[0];!1===s?this.listen():this.unlisten(),this.openDialog(s);break;case"focused":!0===t[0]?(this.state.inFocus=!0,!1===this.state.showDialog&&this.listen()):(this.state.inFocus=!1,this.unlisten(),this.state.playing=!1);break;case"add track":this.importCode=t[0].code}}draw(e){e.clearRect(0,0,e.canvas.width,e.canvas.height),this.game.emit(this.game.constructor.Events.Clear,e),this.game.emit(this.game.constructor.Events.BeforeDraw,e)||(this.toolHandler.drawGrid(e),this.track.draw(e),this.score.draw(e),this.playerManager.draw(e),this.vehicleTimer.player&&this.vehicleTimer.player._tempVehicleTicks>0&&this.vehicleTimer.draw(e),this.toolHandler.draw(e),this.loading&&this.loadingcircle.draw(e),this.message.draw(e))}fixedUpdate(){!this.game.interpolation&&!this.camera.playerFocus?.isGhost()&&this.camera.playerFocus?.isAlive()&&this.camera.update(),!this.state.paused&&!this.state.showDialog&&(this.playerManager.updateGamepads(),this.playerManager.checkKeys()),!this.state.paused&&this.state.playing&&(this.message.update(),this.playerManager.fixedUpdate(),!this.camera.focusIndex&&(this.playerManager.firstPlayer.complete?this.trackComplete():this.ticks++)),this.vehicleTimer.fixedUpdate()}update(e){this.restartTrack&&this.restart(),this.updateToolHandler(),this.mouse.update(),this.score.update(),this.sound.update(),this.playerManager.update(e)}lateUpdate(e){!this.state.paused&&this.state.playing&&this.playerManager.lateUpdate(),(this.game.interpolation||this.camera.playerFocus?.isGhost()||!this.camera.playerFocus?.isAlive())&&this.camera.update(e),this.camera.updateZoom(e),this.isStateDirty()&&this.updateState(),this.importCode&&this.createTrack()}exitFullscreen(){return!!this.settings.fullscreenAvailable&&(this.settings.fullscreen=!1,this.state.fullscreen=!1,!0)}getAvailableTrackCode(){let e=this.settings,t=!1;return e.importCode&&t!=e.importCode?(t=e.importCode,e.importCode=null):this.importCode&&(t=this.importCode,this.importCode=null),t}initAnalytics(){Object.defineProperty(this,"analytics",{value:{deaths:0},writable:!0})}interactWithControls(){}isStateDirty(){let e=!1;for(let t in this.state)this.state[t]!==this.oldState[t]&&(e=!0,this.oldState[t]=this.state[t]);return e}redraw(){this.score.redraw(),this.track.undraw(),GameInventoryManager.redraw(),this.toolHandler.resize()}redrawControls(){}registerTools(){let e=new toolhandler(this);return this.toolHandler=e,e.registerTool(Camera),e}updateState(e=structuredClone(this.state)){let t=this.state;t.zoomPercentage=this.camera.zoomPercentage,t.vehicle=this.vehicle,this.game.emit("stateChange",e,structuredClone(this.state)),null!==this.game.onStateChange&&this.game.onStateChange(this.state)}toggleVehicle(){let e=this.track.allowedVehicles,t=e.length,s=(this.state.vehicle||this.vehicle).toUpperCase(),i=e.indexOf(s);s=e[++i%t],this.selectVehicle(s)}updateToolHandler(){this.toolHandler.update()}selectVehicle(e){-1!==this.track.allowedVehicles.indexOf(e)&&(this.settings.track.vehicle=e,this.vehicle=e,this.playerManager.firstPlayer.setBaseVehicle(e),this.restartTrack=!0)}listen(){this.playerManager.firstPlayer.getGamepad().listen()}unlisten(){this.playerManager.firstPlayer.getGamepad().unlisten()}openDialog(e){this.state.playing=!1,this.state.showDialog=e}setStateDefaults(){let e={};return e.playing=!this.settings.waitForKeyPress,e.showDialog=!1,e.dialogOptions=!1,e.preloading=!0,e.fullscreen=this.settings.fullscreen,e.inFocus=!0,e}stopAudio(){this.sound&&this.sound.stop_all()}toggleFullscreen(){if(!this.settings.fullscreenAvailable)return!1;let e=!this.settings.fullscreen;return this.settings.fullscreen=e,this.state.fullscreen=e,!0}close(){this._onresize=null,this.score=null,this.mouse.close(),this.mouse=null,this.camera.close(),this.camera=null,this.screen.close(),this.screen=null,this.vehicleTimer.close(),this.vehicleTimer=null,this.playerManager.close(),this.playerManager=null,this.stopAudio(),this.sound.close(),this.sound=null,this.track.close(),this.toolHandler.close(),this.game=null,this.assets=null,this.settings=null,this.track=null,this.state=null}},controls=class{defaultControlOptions={visible:!0};name=null;controlsSpriteSheetData={};controlData=null;game=null;scene=null;settings=null;controlsSprite=null;gamepad=null;properties={right:0,scaleX:window.devicePixelRatio/2,scaleY:window.devicePixelRatio/2,top:60,visible:!0,x:0,y:0};constructor(e){this.scene=e,this.game=e.game,this.assets=e.assets,this.settings=e.settings,this.mouse=e.mouse,this.playerManager=e.playerManager}init(){this.createSprite(),this.resize()}click(){for(const e in this.controlData){const t=this.controlData[e];t.disabled||this.isMouseOverComponent(t)&&this.scene.buttonDown(t.key)}}createSprite(){let e=this.scene.assets.getResult(this.name);this.controlsSpriteSheetData.images=[e],this.controlsSprite=e}draw(e){if(!this.properties.visible)return;let t=e.globalAlpha;"number"==typeof this.properties.alpha&&(e.globalAlpha=this.properties.alpha);for(const t in this.controlData){const s=this.controlData[t];let i=this.controlsSpriteSheetData[(s.image||t)+"_btn"],a=i[2]*this.properties.scaleX,o=i[3]*this.properties.scaleY;"number"==typeof s.alpha&&(e.globalAlpha=("number"!=typeof this.properties.alpha||this.properties.alpha)*((s.alpha+(Boolean(s.active)&&.25))/(2-!s.disabled))),e.drawImage(this.controlsSpriteSheetData.images[0],...i,this.game.width-s.right*this.properties.scaleX-a/2,s.top*this.properties.scaleY-o/2,a,o)}t!==e.globalAlpha&&(e.globalAlpha=t)}isMouseOverComponent(e){const{x:t,y:s}=this.mouse.touch.pos;return Math.sqrt((t-e.x)**2+(s-e.y)**2)<e.width/2*e.scaleX}isVisible(){return this.properties.visible}hide(){this.setVisibility(!1)}show(){this.setVisibility(!0)}setVisibility(e){this.properties.visible=e}mouseOver(e){e&&(e.alpha=this.mouse.touch.down?1:.8),this.mouse.enabled=!1,this.game.canvas.style.setProperty("cursor","pointer")}mouseOut(e){e&&(e.alpha=.5),this.mouse.enabled=!0,this.game.canvas.style.removeProperty("cursor")}controlDown(e){let t=e.target,s=t.buttonDetails,i=this.playerManager.firstPlayer.getGamepad();if(s.key&&i.setButtonDown(s.key),s.keys)for(let e=s.keys,t=0;e.length>t;t++)i.setButtonDown(e[t]);s.downCallback&&s.downCallback(e),this.mouse.enabled=!1,t.alpha=1}controlUp(e){let t=e.target,s=t.buttonDetails,i=this.playerManager.firstPlayer.getGamepad();if(s.key&&i.setButtonUp(s.key),s.keys)for(let e=s.keys,t=0;e.length>t;t++)i.setButtonUp(e[t]);s.upCallback&&s.upCallback(e),this.mouse.enabled=!0,t.alpha=.8}close(){}redraw(){for(const e in this.controlData){const t=this.controlData[e];!t.disabled&&this.isMouseOverComponent(t)?(this.mouseOver(t),t.hovering=!0):t.hovering&&!this.mouse.enabled&&(this.mouseOut(t),delete t.hovering)}}resize(){let e=this.scene.game,t=e.width,s=e.height;this.properties.scaleX=this.properties.scaleY=window.devicePixelRatio/2,this.properties.bottom&&(this.properties.y=s-this.properties.bottom*this.properties.scaleY),this.properties.left&&(this.properties.x=this.properties.left*this.properties.scaleX),this.properties.right&&(this.properties.x=t-this.properties.right*this.properties.scaleX),this.properties.top&&(this.properties.y=this.properties.top*this.properties.scaleY);for(const e in this.controlData){const i=this.controlData[e];i.scaleX=i.scaleY=window.devicePixelRatio/2,i.bottom&&(i.y=s-i.bottom*i.scaleY),i.left&&(i.x=i.left*i.scaleX),i.right&&(i.x=t-i.right*i.scaleX),i.top&&(i.y=i.top*i.scaleY)}}update(){}},pause=class extends controls{name="pause_controls";paused=!1;controlsSpriteSheetData={pause_btn:[230,2,76,76],play_btn:[78,2,76,76]};controlData={pause:{alpha:.5,key:"pause",top:60,right:70,width:76,height:76}};constructor(){super(...arguments),this.init()}update(){let e=this.scene.state.paused;this.paused!==e&&(e?(this.controlData.pause.image="play",this.paused=!0):(this.controlData.pause.image="pause",this.paused=!1))}},redoundo=class extends controls{name="redo_undo_controls";controlsSpriteSheetData={redo_btn:[78,2,76,76],undo_btn:[2,2,76,76]};controlData={redo:{keys:["ctrl","y"],alpha:.5,top:60,right:160,width:76,height:76},undo:{keys:["ctrl","z"],alpha:.5,top:60,right:240,width:76,height:76}};constructor(){super(...arguments),this.init()}click(){for(const e in this.controlData){const t=this.controlData[e];this.isMouseOverComponent(t)&&this.scene.toolHandler[("undo"==e?"revert":"apply")+"Action"]()}}update(){let e=this.scene.toolHandler;this.controlData.undo.disabled=0===e.actionTimelinePointer,this.controlData.redo.disabled=e.actionTimelinePointer>=e.actionTimeline.length}};class StraightLine extends Tool{active=!1;name="straightline";options={};p1=new cartesian;p2=new cartesian;shouldDrawMetadata=!1;reset(){this.active=!1}press(){if(!this.active){let e=this.mouse.touch.real;this.p1.x=e.x,this.p1.y=e.y,this.active=!0}}getOptions(){let e=this.toolhandler,t=this.options;return t.lineType=e.options.lineType,t.snap=e.options.snap,t}hold(){let e=this.mouse.touch.real;this.p2.x=e.x,this.p2.y=e.y,this.toolhandler.moveCameraTowardsMouse()}release(){let e=this.p1,t=this.p2,s=this.scene.track,i=this.toolhandler,a=!1;a=s["add"+("physics"===i.options.lineType?"Physics":"Scenery")+"Line"](e.x,e.y,t.x,t.y),a&&i.addActionToTimeline({type:"add",objects:[a]});let o=i.snapPoint;o.x=t.x,o.y=t.y,this.reset()}update(){super.update();let e=this.toolhandler,t=e.gamepad;e.options.snap&&(this.active=!0,this.p1=e.snapPoint,this.hold()),this.shouldDrawMetadata=t.isButtonDown("ctrl")}draw(e){super.draw(e);let t=this.scene.camera.zoom;e.save(),this.drawCursor(e),this.active&&(this.drawLine(e,t),this.drawPoint(e,this.p1,t),this.drawPoint(e,this.p2,t),this.shouldDrawMetadata&&this.drawPointData(e,this.p2,t)),e.restore()}drawCursor(e){let t=this.mouse.touch.real.toScreen(this.scene),s=this.camera.zoom,i=this.toolhandler.options.grid;if(e.beginPath(),i){let i=5*s;e.moveTo(t.x,t.y-i),e.lineTo(t.x,t.y+i),e.moveTo(t.x-i,t.y),e.lineTo(t.x+i,t.y),e.lineWidth=1*s,e.stroke()}else e.arc(t.x,t.y,1*s,0,2*Math.PI,!1),e.lineWidth=1,e.fillStyle="#1884cf",e.fill()}drawPoint(e,t,s){let i=t.toScreen(this.scene),a=this.p2.delta(this.p1);e.beginPath(),e.arc(i.x,i.y,1*s,0,2*Math.PI,!1),e.lineWidth=1,e.fillStyle=a<2?"#cc4444":"#1884cf",e.fill()}drawPointData(e,t){let s=t.toScreen(this.scene),i=this.p1.getAngleInDegrees(this.p2).toFixed(2),a=this.game.pixelRatio;e.fillStyle=this.scene.settings.physicsLineColor,e.strokeStyle=this.scene.settings.physicsLineColor,e.font=8*a+"pt arial",e.fillText(i+"°",s.x+10,s.y+10),e.strokeText(i+"°",s.x+10,s.y+10)}drawLine(e,t){let s=this.toolhandler.options.lineType,i=this.p1.toScreen(this.scene),a=this.p2.toScreen(this.scene),o=this.p2.delta(this.p1);e.beginPath(),e.lineWidth=Math.max(.5,2*t),e.lineCap="round",e.strokeStyle=o<2?"#cc4444":this.scene.settings[s+"LineColor"],e.moveTo(i.x,i.y),e.lineTo(a.x,a.y),e.stroke()}}class Brush extends StraightLine{name="brush";constructor(e){super(e);let t=e.scene.settings.brush;this.addedObjects=[],this.options={breakLength:t.breakLength,maxBreakLength:t.maxBreakLength,minBreakLength:t.minBreakLength,breakLengthSensitivity:t.breakLengthSensitivity,trailSpeed:t.trailSpeed,maxTrailSpeed:t.maxTrailSpeed,minTrailSpeed:t.minTrailSpeed,trailSpeedSensitivity:t.trailSpeedSensitivity}}reset(){this.recordActionsToToolhandler(),super.reset()}recordActionsToToolhandler(){var e,t=this.addedObjects,s=t.length;if(s)for(e=0;s>e;e++)this.toolhandler.addActionToTimeline({type:"add",objects:[t[e]]});this.addedObjects=[]}press(){if(this.recordActionsToToolhandler(),super.press(),!this.active){let e=this.mouse.touch.real;this.p2.x=e.x,this.p2.y=e.y}}hold(){let e=this.mouse.touch.real,t=this.p1,s=this.p2,i=this.options.trailSpeed,a=this.options.breakLength;s.inc(e.sub(s).factor(i));let o=screen.height+e.sub(s).len();if(o*=a,s.sub(t).lenSqr()>o){let e=!1;e=this.scene.track["add"+("physics"===this.toolhandler.options.lineType?"Physics":"Scenery")+"Line"](t.x,t.y,s.x,s.y),e&&this.addedObjects.push(e),t.equ(s),this.toolhandler.snapPoint.x=s.x,this.toolhandler.snapPoint.y=s.y}this.toolhandler.moveCameraTowardsMouse()}release(){let e=this.p1,t=this.p2,s=!1;s=this.scene.track["add"+("physics"===this.toolhandler.options.lineType?"Physics":"Scenery")+"Line"](e.x,e.y,t.x,t.y),s&&this.addedObjects.push(s),this.recordActionsToToolhandler();let i=this.toolhandler.snapPoint;i.x=t.x,i.y=t.y,this.active=!1}update(){let e=this.toolhandler,t=e.gamepad,s=this.mouse;t.isButtonDown("alt")?!1!==s.mousewheel&&this.adjustTrailSpeed(s.mousewheel):t.isButtonDown("shift")&&!1!==s.mousewheel&&this.adjustBreakLength(s.mousewheel),super.update(),e.options.snap&&(this.p2=s.touch.real)}adjustTrailSpeed(e){let t=this.options.trailSpeed,s=this.options.trailSpeedSensitivity,i=this.options.maxTrailSpeed,a=this.options.minTrailSpeed;e>0?(t+=s,t>i&&(t=i)):(t-=s,a>t&&(t=a)),this.setOption("trailSpeed",t)}adjustBreakLength(e){let t=this.options.breakLength,s=this.options.breakLengthSensitivity,i=this.options.maxBreakLength,a=this.options.minBreakLength;e>0?(t+=s,t>i&&(t=i)):(t-=s,a>t&&(t=a)),this.setOption("breakLength",t)}setOption(e,t){this.options[e]=t}drawText(e){let t=this.name,s=this.options.breakLength,i=this.options.trailSpeed,a=this.game.pixelRatio;e.fillStyle=this.scene.settings.physicsLineColor,e.font=12*a+"pt arial",e.fillText(t,10*a,20*a),e.font=8*a+"pt arial",i|=0,e.fillText("Trail speed : "+i,10*a,40*a),e.fillText("Break length : "+s,10*a,60*a)}}function curvedivision(...e){let t=e.pop(),s=[],i=e.reduce(((t,s,i)=>t+s.delta(e[(i<1?e.length:i)-1])),0)/e.length,a=Math.max(2,100*t.breakLength);for(let t=0;t<i;t+=a){let a=t/i,[o,r]=multiCurve(a,...e);if(s.length>0){let e=s[s.length-2],t=s[s.length-1];if(Math.sqrt((o-e)**2+(r-t)**2)<2)continue}s.push(o,r)}let o=e[0];s[0]===o.x&&s[1]===o.y||s.unshift(o.x,o.y);let r=e.at(-1);return s[s.length-2]===r.x&&s[s.length-1]===r.y||s.push(r.x,r.y),s}function binomialCoefficient(e,t){if(Number.isNaN(e)||Number.isNaN(t))return NaN;if(t<0||t>e)return 0;if(0===t||t===e)return 1;if(1===t||t===e-1)return e;e-t<t&&(t=e-t);let s=e;for(let i=2;i<=t;i++)s*=(e-i+1)/i;return Math.round(s)}function multiCurve(e,...t){let s=t.length-1;return[t.reduce(((t,{x:i},a)=>t+binomialCoefficient(s,a)*(1-e)**(s-a)*e**a*i),0),t.reduce(((t,{y:i},a)=>t+binomialCoefficient(s,a)*(1-e)**(s-a)*e**a*i),0)]}class Curve extends StraightLine{name="curve";midpoint=new cartesian;anchoring=!1;controlPoints=[];options={breakLength:.2,breakLengthSensitivity:.1,controlPoints:1,maxBreakLength:3,minBreakLength:.02};getControlPoints(e){let t=Array.from(this.controlPoints);return t.length<this.options.controlPoints&&t.push(...Array.from({length:e??this.options.controlPoints-t.length},(()=>this.midpoint.factor(1)))),t}hold(){let e=this.mouse.touch.real;this.p2.x=e.x,this.p2.y=e.y;let t=this.p1,s=this.p2;this.midpoint.x=(t.x+s.x)/2,this.midpoint.y=(t.y+s.y)/2,this.toolhandler.moveCameraTowardsMouse()}release(){let e=this.p1,t=this.p2,s=this.midpoint;if(this.anchoring){if(s.x===t.x&&s.y===t.y)super.release();else{if(this.options.controlPoints>this.controlPoints.length+1)return void this.controlPoints.push(this.midpoint.factor(1));this.splitAndAddCurve()}this.reset()}else{let s=t.x-e.x,i=t.y-e.y;Math.sqrt(s**2+i**2)>0?this.anchoring=!0:this.active=!1}}reset(){super.reset(),this.anchoring=!1,this.controlPoints.splice(0)}updateAnchor(){let e=this.mouse.touch.real;if(this.midpoint.x=e.x,this.midpoint.y=e.y,window.hasOwnProperty("lite")&&lite.storage.get("preciseEditorTools")){if(this.options.controlPoints>1)return;let e=this.p1.add(this.p2).factor(.5);this.midpoint.inc(this.midpoint.sub(e))}}splitAndAddCurve(){for(var e=curvedivision(this.p1,...this.getControlPoints(),this.p2,this.getOptions()),t=this.scene.track,s=e.length,i=this.toolhandler,a=[],o=0;s-2>o;o+=2){let s=e[o],r=e[o+1],n=e[o+2],h=e[o+3],l=t["add"+("physics"===i.options.lineType?"Physics":"Scenery")+"Line"](s,r,n,h);l&&a.push(l),i.snapPoint.x=n,i.snapPoint.y=h}a.length>0&&i.addActionToTimeline({type:"add",objects:a})}update(){let e=this.mouse,t=e.touch,s=e.secondaryTouch,i=this.toolhandler.gamepad,a=this.toolhandler;a.options.snap&&(this.active=!0,this.p1=a.snapPoint,this.anchoring||this.hold());var o=this.toolhandler.options,r=i.isButtonDown("shift");o.rightClickMove&&(r=s.old.down),r?(t.old.down||o.rightClickMove)&&this.moveCamera():(t.press&&!this.anchoring&&this.press(),t.old.down&&!this.anchoring&&this.hold(),t.release&&this.release(),this.anchoring&&this.updateAnchor()),!1!==e.mousewheel&&(!1===i.isButtonDown("shift")?this.mousewheel(e.mousewheel):this.adjustBreakLength(e.mousewheel))}drawPoint(e,t,s){let i=t.toScreen(this.scene),a=this.getControlPoints(1).concat(this.p2);a.unshift(this.p1);let o=a.reduce(((e,t,s)=>e+t.delta(a[(s<1?a.length:s)-1])),0)/a.length;e.beginPath(),e.arc(i.x,i.y,1*s,0,2*Math.PI,!1),e.lineWidth=1,e.fillStyle=o<2?"#cc4444":"#1884cf",e.fill()}drawLine(e,t){let s=this.toolhandler.options.lineType,i=this.getControlPoints(1).concat(this.p2);i.unshift(this.p1);let a=i.reduce(((e,t,s)=>e+t.delta(i[(s<1?i.length:s)-1])),0)/i.length;e.beginPath(),e.lineWidth=Math.max(.5,2*t),e.lineCap="round",e.strokeStyle=a<2?"#cc4444":this.scene.settings[s+"LineColor"];let o=this.p1.toScreen(this.scene),r=this.p2.toScreen(this.scene),n=this.midpoint.toScreen(this.scene);if(e.moveTo(o.x,o.y),this.options.controlPoints>1){let t=curvedivision(o,...this.getControlPoints().map((e=>e.toScreen(this.scene))),r,this.getOptions());for(let s=0;s<t.length;s+=2)e.lineTo(Math.floor(t[s]),Math.floor(t[s+1]))}else e.quadraticCurveTo(n.x,n.y,r.x,r.y);e.stroke()}adjustBreakLength(e){let t=this.options.breakLength,s=this.options.breakLengthSensitivity,i=this.options.maxBreakLength,a=this.options.minBreakLength;e>0?(t+=s,t>i&&(t=i)):(t-=s,a>t&&(t=a)),this.setOption("breakLength",t)}setOption(e,t){this.options[e]=t}}class Eraser extends Tool{erasedObjects=[];eraserPoint=new cartesian;name="eraser";options=null;constructor(e){super(e),this.options=e.scene.settings.eraser}reset(){this.recordActionsToToolhandler()}press(){this.recordActionsToToolhandler()}recordActionsToToolhandler(){this.erasedObjects.length>0&&this.toolhandler.addActionToTimeline({type:"remove",objects:this.erasedObjects.flat()}),this.erasedObjects=[]}release(){this.recordActionsToToolhandler()}hold(){let e=this.mouse.touch.pos,t=this.scene.track,s=this.scene.screen,i=this.scene.camera,a=s.center,o=i.position,r=(e.x-a.x)/i.zoom+o.x,n=(e.y-a.y)/i.zoom+o.y;this.eraserPoint.x=Math.round(r),this.eraserPoint.y=Math.round(n);let h=t.erase(this.eraserPoint,this.options.radius/this.scene.camera.zoom,this.options.types);h.length>0&&this.erasedObjects.push(h)}draw(e){super.draw(e),this.drawEraser(e)}drawEraser(e){let t=this.mouse.touch.pos,s=window.lite&&lite.storage.get("theme");e.save(),e.beginPath(),e.arc(t.x,t.y,this.options.radius,0,2*Math.PI,!1),e.lineWidth=1,e.fillStyle=/^midnight$/i.test(s)?"rgba(29,35,40,0.8)":/^dark$/i.test(s)?"rgba(33,33,33,0.8)":"rgba(255,255,255,0.8)",e.fill(),e.strokeStyle=this.scene.settings.physicsLineColor,e.stroke(),e.restore()}setOption(e,t){this.options[e]=t}update(){let e=this.toolhandler.gamepad,t=this.mouse;e.isButtonDown("shift")&&!1!==t.mousewheel&&this.adjustRadius(t.mousewheel),super.update()}adjustRadius(e){let t=this.options.radius,s=this.options.radiusSizeSensitivity,i=this.options.maxRadius,a=this.options.minRadius;t+=e>0?s:-s,this.setOption("radius",Math.min(i,Math.max(a,t)))}}class BasePowerupTool extends Tool{name="";powerupTools={};registerTool(e){this.powerupTools[this.toolhandler.constructor.parseToolName(e.name)]=e}setOption(e,t){this.options[e]=t}press(){let e=this.options.selected;this.powerupTools[e].press()}hold(){let e=this.options.selected;this.powerupTools[e].hold()}release(){let e=this.options.selected;this.powerupTools[e].release()}draw(e){super.draw(e),this.powerupTools[this.options.selected].draw(e)}}class poweruptool_BasePowerupTool extends Tool{active=!1;p1=new cartesian;powerup=null;draw(e){let t=this.mouse.touch,s=this.camera.zoom,i=this.scene.settings.device,a=this.scene.screen;if(!0===this.active){let t=a.realToScreen(this.p1.x,"x"),i=a.realToScreen(this.p1.y,"y");e.globalAlpha=.4,this.powerup.draw(t,i,s,e),e.globalAlpha=1}else if("desktop"===i){let i=a.realToScreen(t.real.x,"x"),o=a.realToScreen(t.real.y,"y");e.globalAlpha=.8,this.powerup.draw(i,o,s,e),e.globalAlpha=1}}press(){let e=this.mouse.touch.real;this.p1.x=e.x,this.p1.y=e.y,this.active=!0}release(){let e=this.scene.track,t=new this.powerup.constructor(this.p1.x,this.p1.y,e);e.addPowerup(t),this.active=!1,this.toolhandler.addActionToTimeline({type:"add",objects:[t]})}}class Antigravity extends poweruptool_BasePowerupTool{name="antigravity";constructor(e){super(e),this.powerup=new antigravity(0,0,e.scene.track)}press(){let e=this.mouse.touch.real;this.p1.x=e.x,this.p1.y=e.y;let t=this.scene.track,s=new this.powerup.constructor(this.p1.x,this.p1.y,t);t.addPowerup(s),this.toolhandler.addActionToTimeline({type:"add",objects:[s]})}release(){}}class Bomb extends poweruptool_BasePowerupTool{name="bomb";constructor(e){super(e),this.powerup=new bomb(0,0,e.scene.track)}}class directionalpoweruptool_Boost extends poweruptool_BasePowerupTool{color=null;p2=new cartesian;press(){super.press(),this.p2.x=this.p1.x,this.p2.y=this.p1.y}hold(){let e=this.mouse.touch.real;this.p2.x=e.x,this.p2.y=e.y}release(){let e=this.scene.track,t=new this.powerup.constructor(this.p1.x,this.p1.y,this.powerup.angle-(90+this.powerup.constructor.angleOffset),e);e.addPowerup(t),this.active=!1,this.toolhandler.addActionToTimeline({type:"add",objects:[t]})}draw(e){let t=this.mouse.touch,s=this.camera.zoom,i=this.scene.screen,a=this.scene.settings.device;if(!0===this.active){let t=i.realToScreen(this.p1.x,"x"),a=i.realToScreen(this.p1.y,"y"),o=this.p1,r=this.p2,n=o.y-r.y,h=o.x-r.x,l=Math.atan2(o.y-r.y,o.x-r.x);0===h&&0===n&&(l=Math.PI-Math.PI/2),0>l&&(l+=2*Math.PI),this.drawPathToMouse(e,l),this.powerup.angle=l*(180/Math.PI)+this.powerup.constructor.angleOffset|0,this.powerup.draw(t,a,s,e)}else if("desktop"===a){e.globalAlpha=.8,this.powerup.angle=90+this.powerup.constructor.angleOffset;let a=i.realToScreen(t.real.x,"x"),o=i.realToScreen(t.real.y,"y");this.powerup.draw(a,o,s,e),e.globalAlpha=1}}drawPathToMouse(e,t){let s=this.p1,i=this.p2,a=this.scene.screen,o=this.scene.camera.zoom,r=a.realToScreen(s.x,"x"),n=a.realToScreen(s.y,"y"),h=a.realToScreen(i.x,"x"),l=a.realToScreen(i.y,"y"),c=Math.sqrt((h-r)**2+(l-n)**2);30*o>c&&(c=30*o),e.strokeStyle=this.outline,e.lineWidth=Math.max(1,2*o),e.beginPath(),e.moveTo(r+c,n),e.lineTo(r,n),e.lineTo(h,l),e.stroke();let p=t+Math.PI/180*180,d=Math.min(c,50*o);e.beginPath(),e.moveTo(r,n),e.arc(r,n,d,p,0,!1),e.stroke(),e.fillStyle=this.color,e.fill()}}class Boost extends directionalpoweruptool_Boost{color="rgba(173, 207, 125,0.2)";name="boost";outline="#ADCF7D";constructor(e){super(e),this.powerup=new boost(0,0,0,e.scene.track)}}class Checkpoint extends poweruptool_BasePowerupTool{name="checkpoint";constructor(e){super(e),this.powerup=new checkpoint(0,0,e.scene.track)}}class Goal extends poweruptool_BasePowerupTool{name="goal";constructor(e){super(e),this.powerup=new target(0,0,e.scene.track)}release(){let e=this.scene.track,t=new this.powerup.constructor(this.p1.x,this.p1.y,e);e.addTarget(t),e.addPowerup(t),this.active=!1,this.toolhandler.addActionToTimeline({type:"add",objects:[t]})}}class Gravity extends directionalpoweruptool_Boost{color="rgba(162, 183, 210,0.2)";name="gravity";outline="#A2B7D2";constructor(e){super(e),this.powerup=new gravity(0,0,0,e.scene.track)}}class Slowmo extends poweruptool_BasePowerupTool{name="slowmo";constructor(e){super(e),this.powerup=new slowmo(0,0,e.scene.track)}}class Teleport extends poweruptool_BasePowerupTool{name="teleport";p2=null;constructor(e){super(e),this.p2=new cartesian(0,0),this.powerup=new teleport(0,0,e.scene.track)}press(){super.press(),this.portal1=new this.powerup.constructor(this.p1.x,this.p1.y,this.scene.track)}hold(){let e=this.mouse.touch.real;this.p2.x=e.x,this.p2.y=e.y}release(){let e=Math.abs(this.p2.x-this.p1.x),t=Math.abs(this.p2.y-this.p1.y);if(e>40||t>40){let e=this.scene.track;this.portal2=new this.powerup.constructor(this.p2.x,this.p2.y,e),this.portal1.addOtherPortalRef(this.portal2),this.portal2.addOtherPortalRef(this.portal1),e.addPowerup(this.portal1),e.addPowerup(this.portal2),this.toolhandler.addActionToTimeline({type:"add",objects:[this.portal1,this.portal2]})}else this.portal1=null;this.active=!1}draw(e){let t=this.mouse.touch,s=this.camera.zoom,i=this.scene.screen,a=this.scene.settings.device;if(!0===this.active){let t=i.realToScreen(this.p1.x,"x"),a=i.realToScreen(this.p1.y,"y"),o=i.realToScreen(this.p2.x,"x"),r=i.realToScreen(this.p2.y,"y"),n=this.p1,h=this.p2,l=n.y-h.y,c=n.x-h.x,p=Math.atan2(n.y-h.y,n.x-h.x);0===c&&0===l&&(p=Math.PI-Math.PI/2),0>p&&(p+=2*Math.PI),this.drawPathToMouse(e,p),this.portal1.draw(t,a,s,e),this.powerup.draw(o,r,s,e)}else if("desktop"===a){e.globalAlpha=.8;let a=i.realToScreen(t.real.x,"x"),o=i.realToScreen(t.real.y,"y");this.powerup.draw(a,o,s,e),e.globalAlpha=1}}drawPathToMouse(e){let t=this.p1,s=this.p2,i=this.scene.screen,a=this.scene.camera.zoom,o=i.realToScreen(t.x,"x"),r=i.realToScreen(t.y,"y"),n=i.realToScreen(s.x,"x"),h=i.realToScreen(s.y,"y"),l=Math.sqrt(Math.pow(n-o,2)+Math.pow(h-r,2));30*a>l&&(l=30*a),e.strokeStyle="#dd45ec",e.lineWidth=Math.max(1,2*a),e.beginPath(),e.moveTo(o,r),e.lineTo(n,h),e.stroke(),e.closePath()}}class Powerup extends BasePowerupTool{name="powerup";options={selected:"goal"};constructor(e){super(e),this.registerPowerupTools()}registerPowerupTools(){this.registerTool(new Goal(this.toolhandler)),this.registerTool(new Boost(this.toolhandler)),this.registerTool(new Gravity(this.toolhandler)),this.registerTool(new Slowmo(this.toolhandler)),this.registerTool(new Bomb(this.toolhandler)),this.registerTool(new Checkpoint(this.toolhandler)),this.registerTool(new Antigravity(this.toolhandler)),this.registerTool(new Teleport(this.toolhandler))}update(){let e=this.toolhandler.gamepad,t=this.options;e.isButtonDown("opt1")&&(t.selected="goal",e.setButtonUp("opt1"),this.scene.updateState()),e.isButtonDown("opt2")&&(t.selected="boost",e.setButtonUp("opt2"),this.scene.updateState()),e.isButtonDown("opt3")&&(t.selected="gravity",e.setButtonUp("opt3"),this.scene.updateState()),e.isButtonDown("opt4")&&(t.selected="slowmo",e.setButtonUp("opt4"),this.scene.updateState()),e.isButtonDown("opt5")&&(t.selected="bomb",e.setButtonUp("opt5"),this.scene.updateState()),e.isButtonDown("opt6")&&(t.selected="checkpoint",e.setButtonUp("opt6"),this.scene.updateState()),e.isButtonDown("opt7")&&(t.selected="antigravity",e.setButtonUp("opt7"),this.scene.updateState()),e.isButtonDown("opt8")&&Application.User.get("classic")&&(t.selected="teleport",e.setButtonUp("opt8"),this.scene.updateState()),super.update()}}const path=class{start=null;end=null;verticies=[];build(e){let t=e.pop();this.start=t.p1,this.end=t.p2,this.verticies.push(t);for(let t=e.length-1;t>=0;t--){let s=e[t],i=s.p1,a=s.p2;this.start.x===a.x&&this.start.y===a.y?(this.verticies.unshift(s),this.start=s.p1,e.splice(t,1)):this.end.x===i.x&&this.end.y===i.y&&(this.verticies.push(s),this.end=s.p2,e.splice(t,1))}}};class Select extends Tool{name="select";passive=!1;active=!1;dashOffset=0;p1=new cartesian;p2=new cartesian;travelDistance=5;addedObjects=[];selectedElements=[];selectedSegments=[];constructor(e){super(e),document.addEventListener("keydown",this.keyPress.bind(this))}press(){if(this.selectedElements.length>0&&this.passive)return;let e=this.mouse.touch.real;this.passive=!1,this.active=!0,this.p1.x=e.x,this.p1.y=e.y,this.p2.x=e.x,this.p2.y=e.y}hold(){if(this.passive)return void this.moveSelected(this.mouse.touch.real.sub(this.mouse.touch.old.real));let e=this.mouse.touch.real;this.p2.x=e.x,this.p2.y=e.y}unselectElements(){for(let e of this.selectedElements)e.highlight=!1;this.selectedElements=[],this.selectedSegments=[]}moveSelected(e){this.p1.inc(e),this.p2.inc(e);for(let t in this.selectedSegments)this.selectedSegments.find((e=>e.otherPortal==t))?this.selectedSegments.splice(t,1):(this.selectedSegments[t].move(e.x,e.y),this.scene.track.undraw())}fillSelected(){let e=Math.min(this.p1.y,this.p2.y),t=Math.max(this.p1.y,this.p2.y);for(let s=e;s<t;s++)this.selectedSegments.push(this.scene.track.addPhysicsLine(this.p1.x,s,this.p2.x,s));this.selectedElements.push(...this.selectedSegments),this.selectedSegments.length>0&&this.toolhandler.addActionToTimeline({type:"add",objects:this.selectedSegments.flat()})}rotateSelected(){let e=(this.travelDistance||0)*Math.PI/180,t=this.selectedSegments;this.selectedSegments=[];for(let s of t.filter((e=>"physics"==e.constructor.type||"scenery"==e.constructor.type)))this.selectedSegments.push(this.scene.track["physics"==s.constructor.type?"addPhysicsLine":"addSceneryLine"](Math.cos(e)*s.p1.x+Math.sin(e)*s.p1.y,-Math.sin(e)*s.p1.x+Math.cos(e)*s.p1.y,Math.cos(e)*s.p2.x+Math.sin(e)*s.p2.y,-Math.sin(e)*s.p2.x+Math.cos(e)*s.p2.y)),s.removeAllReferences()}copyAndPasteSelected(){for(let e of this.selectedSegments.filter((e=>"physics"==e.constructor.type||"scenery"==e.constructor.type)))this.scene.track["add"+("physics"==e.constructor.type?"Physics":"Scenery")+"Line"](e.p1.x,e.p1.y,e.p2.x,e.p2.y)}release(){if(this.unselectElements(),this.passive)return this.active=!1,this.passive=!1,void(this._reset&&(this.toolhandler.setTool(this.toolhandler.previousTool),this._reset=!1));for(let e of this.scene.track.select(this.p1,this.p2))this.intersectsLine(e.x?e:e.p1,e.x?e:e.p2)&&this.selectedSegments.push(e);this.selectedElements=this.selectedSegments,this.active=!1,this.passive=!0,this.toolhandler.currentTool!==this.name&&(this.toolhandler.setTool(this.name),this._reset=!0)}keyPress(e){if(this.passive){switch(e.preventDefault(),e.key){case"=":case"+":this.travelDistance++,this.scene.message.show("Increased travel distance for the Select Tool - "+this.travelDistance,!1);break;case"-":this.travelDistance--,this.scene.message.show("Decreased travel distance for the Select Tool - "+this.travelDistance,!1);break;case"c":this.copyAndPasteSelected(e.key),this.scene.message.show("Copied selected area",!1);break;case"Delete":this.selectedElements.length>0&&this.toolhandler.addActionToTimeline({type:"remove",objects:this.selectedElements.flatMap((e=>e))});for(const e of this.selectedElements)e.removeAllReferences();this.reset(),this.scene.message.show("Deleted selected area",!1);break;case"f":confirm("Are you sure you would you like to fill the selected area?")&&(this.fillSelected(),this.scene.message.show("Filled selected area",!1));break;case"r":this.rotateSelected(),this.scene.message.show("Rotated selected area",!1);break;case"`":case"Escape":this.reset()}this.timeout=setTimeout((()=>this.scene.message.hide()),1e3)}}buildPaths(e){for(let t=[];e.length>0;){let s=new path;s.build(e),t.push(s)}}intersectsLine(e,t){let s=Math.min(this.p1.y,this.p2.y),i=Math.min(this.p1.x,this.p2.x),a=Math.max(this.p1.y,this.p2.y),o=Math.max(this.p1.x,this.p2.x),r=Math.abs(o-i),n=Math.abs(s-a),h=e.x,l=t.x;if(e.x>t.x&&(h=t.x,l=e.x),l>i+r&&(l=i+r),i>h&&(h=i),h>l)return!1;let c=e.y,p=t.y,d=t.x-e.x;if(Math.abs(d)>1e-7){let s=(t.y-e.y)/d,i=e.y-s*e.x;c=s*h+i,p=s*l+i}return c>p&&([p,c]=[c,p]),p>s+n&&(p=s+n),s>c&&(c=s),!(c>p)}toScreen(e,t){let s=this.scene.camera,i=this.scene.screen;return(e-s.position[t])*s.zoom+i.center[t]}draw(e){let t=this.scene;if(this.active||this.passive){let s=this.p1.toScreen(t),i=this.p2.toScreen(t),a=i.x-s.x,o=i.y-s.y;e.save(),this.active?(e.beginPath(),e.rect(s.x,s.y,a,o),e.fillStyle="rgba(24, 132, 207, 0.2)",e.fill(),e.lineWidth=2,e.strokeStyle="rgba(24, 132, 207, 0.7)",e.stroke()):this.passive&&(e.strokeStyle="rgba(24, 132, 207, 0.7)",e.lineWidth=2,e.strokeRect(s.x,s.y,a,o)),e.restore()}}reset(){this.p1.x=0,this.p1.y=0,this.p2.x=0,this.p2.y=0,this.active=!1,this.passive=!1,this.unselectElements()}close(){super.close(),this.dashOffset=0,this.selectedElements=null,this.p2=null,this.p1=null,this.active=!1,this.passive=!1}}class BaseVehiclePowerupTool extends poweruptool_BasePowerupTool{options=null;constructor(e,t){super(t),this.options=e.options}release(){let e=this.scene.track,t=new this.powerup.constructor(this.p1.x,this.p1.y,this.options.time,e);e.addPowerup(t),this.active=!1,this.toolhandler.addActionToTimeline({type:"add",objects:[t]})}}class Balloon extends BaseVehiclePowerupTool{name="balloon";constructor(e,t){super(e,t),this.powerup=new balloon(0,0,0,t.scene.track)}}class Blob extends BaseVehiclePowerupTool{name="blob";constructor(e,t){super(e,t),this.powerup=new blob(0,0,0,t.scene.track)}}class Helicopter extends BaseVehiclePowerupTool{name="helicopter";constructor(e,t){super(e,t),this.powerup=new helicopter(0,0,0,t.scene.track)}}class Truck extends BaseVehiclePowerupTool{name="truck";constructor(e,t){super(e,t),this.powerup=new truck(0,0,0,t.scene.track)}}class VehiclePowerup extends BasePowerupTool{name="vehiclepowerup";constructor(e){super(e),this.options=e.scene.settings.vehiclePowerup,this.registerPowerupTools()}registerPowerupTools(){this.registerTool(new Helicopter(this,this.toolhandler)),this.registerTool(new Truck(this,this.toolhandler)),this.registerTool(new Balloon(this,this.toolhandler)),this.registerTool(new Blob(this,this.toolhandler))}}const Editor=class extends BaseScene{clear=!1;redoundoControls=null;verified=!1;constructor(e){super(e),this.mouse.disableContextMenu(),this.createMainPlayer(),this.createControls(),this.registerTools(),this.state=this.setStateDefaults(),this.oldState=this.setStateDefaults(),this.restart(),!1!==e.settings.analyticsEnabled&&this.initAnalytics(),Object.defineProperty(this,"_pasteEvent",{value:({clipboardData:e})=>{if("import"===this.state.showDialog)return;let t=e.getData("text");this.state.dialogOptions={},this.state.dialogOptions.code=t,this.openDialog("import"),window.hasOwnProperty("lite")&&lite.constructor.waitForElm(".importDialog-code",this.game.updateInterval).then((e=>{e.focus(),e.value=t}))},writable:!0}),document.addEventListener("paste",this._pasteEvent,{passive:!0})}createMainPlayer(){super.createMainPlayer().setKeyMap(this.settings.editorHotkeys)}buttonDown(e){super.buttonDown(e);let t=this.camera;switch(this.state.playing=!0,e){case"up":case"down":case"left":case"right":t.focusOnMainPlayer()}}createTrack(){let e=super.createTrack(),t=this.getAvailableTrackCode();0!=t?(e.read(t),this.state.preloading=!1,this.state.loading=!1):e.addDefaultLine(),this.importCode=!1,this.restartTrack=!0,this.clear=!1}getCanvasOffset(){return{height:this.settings.isStandalone?202:90,width:0}}initAnalytics(){super.initAnalytics(),Object.assign(this.analytics,{mouseEvents:0}),this.trackAction("editor-open","open")}createControls(){this.redoundoControls=new redoundo(this),this.pauseControls=new pause(this)}redrawControls(){this.pauseControls.redraw(),this.redoundoControls.redraw()}registerTools(){let e=super.registerTools();e.enableGridUse(),e.registerTool(Curve),e.registerTool(StraightLine),e.registerTool(Brush),e.registerTool(Select),e.registerTool(Eraser),e.registerTool(Powerup),e.registerTool(VehiclePowerup),e.setTool(this.settings.startTool)}play(){this.state.playing=!0}interactWithControls(){this.pauseControls.click(),this.redoundoControls.click()}updateControls(){this.pauseControls.update(),this.redoundoControls.update()}update(){super.update(...arguments),this.updateControls()}lateUpdate(){super.lateUpdate(...arguments),this.clear&&this.createTrack()}draw(e){super.draw(...arguments),this.pauseControls.draw(e),this.redoundoControls.draw(e)}restart(){this.verified=!this.settings.requireTrackVerification,this.track.dirty=!1,this.track.resetPowerups(),this.message.hide(),this.restartTrack=!1,this.state.playing=!1,this.ticks=0,this.playerManager.reset(),this.camera.focusOnPlayer(),this.camera.fastforward(),this.score.update()}resize(){this.pauseControls.resize(),this.redoundoControls.resize()}updateState(){let e=this.state,t=structuredClone(e);e&&(e.tool=this.toolHandler.currentTool,e.toolOptions=this.toolHandler.getToolOptions(),e.grid=this.toolHandler.options.grid,e.cameraLocked=this.toolHandler.options.cameraLocked,super.updateState(t))}setStateDefaults(){let e=super.setStateDefaults();return e.paused=this.settings.startPaused,e.loading=!1,e.playing=this.settings.waitForKeyPress,e.preloading=!1,e.tool=this.toolHandler.currentTool,e.toolOptions=this.toolHandler.getToolOptions(),e.grid=this.toolHandler.options.grid,e.cameraLocked=this.toolHandler.options.cameraLocked,e.zoomPercentage=this.camera.zoomPercentage,e.vehicle=this.vehicle,e}trackAction(e,t){if(!1!==this.game.settings.analyticsEnabled){var s={category:"create",action:e,label:t,value:this.toolHandler.analytics.actions+this.mouse.analytics.clicks,non_interaction:!0};Application.Helpers.GoogleAnalyticsHelper.track_event(s)}}openDialog(e){switch(super.openDialog(e),this.state.dialogOptions={},e){case"import":break;case"export":setTimeout(this.getTrackCode.bind(this,!0),this.game.updateInterval);break;case"upload":"undefined"==typeof isChromeApp&&setTimeout(this.getTrackCode.bind(this),this.game.updateInterval)}}getTrackCode(e){this.state.dialogOptions={},this.state.dialogOptions.verified=this.verified;let t=this.track.getCode(),s=(window.lite&&lite.storage.get("exportThreshold"))??4e5;e&&t.length<s&&(e=!1),this.state.dialogOptions.code=e?"Track code too large to display":t}trackComplete(){this.verified=!this.track.dirty}hideControlPanel(){}showControlPanel(){}command(e,...t){switch(super.command(...arguments),e){case"change tool":let e=t[0];this.toolHandler.setTool(e);break;case"change tool option":let s=t[0],i=t[1];void 0!==t[2]?this.toolHandler.setToolOption(s,i,t[2]):this.toolHandler.setToolOption(s,i);break;case"snap":this.toolHandler.toggleSnap();break;case"redraw":this.redraw();break;case"fullscreen":this.settings.fullscreen=this.state.fullscreen=!this.settings.fullscreen;break;case"grid":this.toolHandler.toggleGrid();break;case"lock camera":this.toolHandler.toggleCameraLock();break;case"toggle vehicle":this.toggleVehicle(),this.updateState();break;case"reset zoom":this.camera.resetZoom();break;case"increase zoom":this.camera.increaseZoom();break;case"decrease zoom":this.camera.decreaseZoom();break;case"change lineType":let a=t[0];this.toolHandler.options.lineType=a,this.updateState();break;case"clear track":!1!==this.settings.analyticsEnabled&&this.trackAction("editor-action","clear"),this.clear=!0;break;case"import":let o=t[0];o.length<=0&&(o=!1),this.importCode=o,this.clear=t[1],this.command("dialog",!1)}}close(){!1!==this.settings.analyticsEnabled&&this.trackAction("editor-exit","exit"),document.removeEventListener("paste",this._pasteEvent),this._pasteEvent=null,super.close()}},campaignscore=class extends gui{sprite=null;spriteSheet={bronze_medal:[548,68,44,44],center_panel:[2,68,452,56],silver_medal:[502,68,44,44],left_panel:[2,2,588,64],gold_medal:[456,68,44,44]};bronze_container=new container({alpha:.4,inline:!0},this.container);silver_container=new container({alpha:.4,inline:!0},this.container);gold_container=new container({alpha:.4,inline:!0},this.container);constructor(e){super(e,{font:{size:12},gap:6.4,inline:!0,x:6.4,y:32}),this.settings=e.settings;let t=e.settings.campaignData.goals;this.sprite=e.assets.getResult("campaign_icons"),this.bronze_container.addChild(new component.A({cached:!0,image:{canvas:this.sprite,x:548,y:68,width:44,height:44},width:18,height:18})),this.bronze_container.addChild(new component.A({text:t.third,x:4,y:3})),this.silver_container.addChild(new component.A({cached:!0,image:{canvas:this.sprite,x:502,y:68,width:44,height:44},width:18,height:18})),this.silver_container.addChild(new component.A({text:t.second,x:4,y:3})),this.gold_container.addChild(new component.A({cached:!0,image:{canvas:this.sprite,x:456,y:68,width:44,height:44},width:18,height:18})),this.gold_container.addChild(new component.A({text:t.first,x:4,y:3})),this.updateState()}updateState(){switch(this.settings.campaignData.user.has_goal){case 1:case"first":this.gold_container.alpha=1;case 2:case"second":this.silver_container.alpha=1;case 3:case"third":this.bronze_container.alpha=1}this.redraw()}centerContainer(){let e=this.scene.screen,t=this.container,s=t.width;t.x=e.width/2/window.devicePixelRatio-s/2,t.y=40}update(){this.updateState()}},racetimes=class extends gui{raceCount=0;raceList=null;highlightedRace=null;raceOpacity=.3;raceYOffset=20;mobileRaceXOffset=72;maxRaces=10;constructor(e){super(e,{font:{size:10},x:6,y:32}),this.scene.settings.isCampaign&&(this.container.y+=24),this.scene.settings.mobile&&(this.maxRaces=3),this.raceList=this.container.children}addRace(e,t){if(this.raceCount<this.maxRaces){let s=this.scene,i=e.user,a=e.race,o=s.settings,r=o.drawFPS,n=new container({alpha:this.raceOpacity,color:"#".padEnd(7,/^midnight$/i.test(window.lite?.storage.get("theme"))?"d":/^dark(er)?$/i.test(window.lite?.storage.get("theme"))?"f":"0"),data:e,inline:!0,textAlign:"center",textBaseline:"middle"},this.container);o.mobile?n.x=t*this.mobileRaceXOffset:n.y=t*this.raceYOffset,n.addChild(new component.A({background:i.color,borderRadius:"100%",font:{size:10},radius:8,text:i.d_name.charAt(0).toUpperCase(),textAlign:"center"})),n.addChild(new component.A({font:{size:12},text:formatnumber(parseInt(a.run_ticks)/r*1e3),x:4,y:2})),n.addChild(new component.A({font:{size:12},text:"0/"+s.track.targetCount,x:4,y:2})),this.raceCount++,this.redraw()}}centerContainer(){let e=this.scene,t=e.screen,s=this.container,i=s.width;s.x=t.width/2/window.devicePixelRatio-i/2,e.settings.isCampaign&&(s.visible=!1),s.y=40}clear(){this.container.children.splice(0),this.raceCount=0,this.redraw()}highlightRace(e){if(this.highlightedRace!==this.raceList[e]){this.unhighlightRace();let t=this.raceList[e];t.alpha=1,this.highlightedRace=t,this.redraw()}}unhighlightRace(){this.highlightedRace&&(this.highlightedRace.alpha=this.raceOpacity,this.highlightedRace=null,this.redraw())}update(){if(this.raceCount>0){let e=this.scene.camera;e.focusIndex>0&&e.focusIndex<this.maxRaces?this.highlightRace(e.focusIndex-1):this.unhighlightRace()}}},raceprogress=class extends gui{bar=new component.A({background:"hsl(53deg 95% 59% / 85%)",border:"round",borderRadius:"100%",color:"white",data:{delta:0,oldDelta:0,progress:0},height:"100% - 4",x:2,y:2,width:0},this.container);progress=new component.A({color:"white",height:"100%",text:"0/0",textAlign:"center",textBaseline:"middle",width:"100%"},this.container);steps=new component.A({height:"100%",width:"100%"},this.container);constructor(e){super(e,{background:"hsl(0deg 0% 50% / 75%)",borderWidth:2,borderRadius:"100%",verticalAlign:"bottom",x:60,y:32}),this.sprite=e.assets.getResult("targets_icon"),this.resize()}resize(){let e=this.scene.game.canvas,t=Math.min(12,Math.max(8,e.height/8));this.container.width=e.width/3,this.container.x=e.width/2-this.container.width/2,this.container.y=e.height-1.5*t-8,this.container.height=t}update(e){if(!this.enabled)return;let t=this.scene.track,s=e._powerupsConsumed.targets,i=s.length/t.targetCount,a=t.targets.find((e=>e.id==("function"==typeof s.at?s.at(-1):s[s.length-1])))||{x:0,y:0},o=new cartesian(a.x,a.y),r=(t.targets.length<=1?t.targets:Array(...(e._tempVehicle||e._baseVehicle).masses).map((e=>t.targets.filter((e=>!s.includes(e.id))).sort(((t,s)=>new cartesian(t.x,t.y).sub(e.pos).len()-new cartesian(s.x,s.y).sub(e.pos).len()))[0]))).sort(((e,t)=>o.sub(new cartesian(e.x,e.y).len())-o.sub(new cartesian(t.x,t.y).len())))[0],n=r&&new cartesian(r.x,r.y),h=(r&&o.sub(n).len())??0,l=(r&&Math.min(...(e._tempVehicle||e._baseVehicle).masses.map((e=>n.sub(e.pos).len())).sort(((e,t)=>e-t))))??0,c=100*Math.min(1,Math.max(0,(h-l)/h))/t.targetCount,p=s.length>0&&Array(...(e._tempVehicle||e._baseVehicle).masses).map((e=>new cartesian(a.x,a.y).sub(e.pos).len())).sort(((e,t)=>e-t))[0];i+=c/100,this.bar.data.oldDelta=p??null,this.bar.data.delta=l,this.bar.data.progress=i;let d=Math.max(1,Math.min(1.5,(500-Math.min(500,Math.min(this.bar.data.delta,this.bar.data.oldDelta)))/250));this.container.scale.x=d,this.container.scale.y=d,this.bar.width=(this.container.width-4)*i,this.progress.text=!(l<=500)||this.bar.oldDelta&&this.bar.oldDelta<=250?s.length+"/"+t.targetCount:Math.floor(l)+"m",this.redraw()}};class PathTracer extends Tool{active=!1;name="pathtracer";p1=new cartesian;p2=new cartesian;path=[];points=[];reset(){this.active=!1}press(){if(super.press(),!this.active){let e=this.mouse.touch.real;this.p1.x=e.x,this.p1.y=e.y,this.p2.x=e.x,this.p2.y=e.y}}hold(){let e=this.mouse.touch.real,t=this.p1,s=this.p2;s.inc(e.sub(s)),screen.height,e.sub(s).len(),s.sub(t).len()>4&&(this.points.push(s.factor(1)),t.equ(s),this.toolhandler.snapPoint.x=s.x,this.toolhandler.snapPoint.y=s.y),this.toolhandler.moveCameraTowardsMouse()}release(){let e=this.p2,t=this.toolhandler.snapPoint;t.x=e.x,t.y=e.y,this.active=!1}update(){let e=this.toolhandler,t=this.mouse;super.update(),e.options.snap&&(this.p2=t.touch.real)}draw(e){super.draw(e);let t=this.scene.camera.zoom;e.save(),this.drawCursor(e),this.active&&(this.drawLine(e,t),this.drawPoint(e,this.p1,t),this.drawPoint(e,this.p2,t)),e.restore()}drawCursor(e){let t=this.mouse.touch.real.toScreen(this.scene),s=this.camera.zoom,i=this.toolhandler.options.grid;if(e.beginPath(),i){let i=5*s;e.moveTo(t.x,t.y-i),e.lineTo(t.x,t.y+i),e.moveTo(t.x-i,t.y),e.lineTo(t.x+i,t.y),e.lineWidth=1*s,e.stroke()}else e.arc(t.x,t.y,1*s,0,2*Math.PI,!1),e.lineWidth=1,e.fillStyle="#1884cf",e.fill()}drawPoint(e,t,s){let i=t.toScreen(this.scene);e.beginPath(),e.arc(i.x,i.y,1*s,0,2*Math.PI,!1),e.lineWidth=1,e.fillStyle="#1884cf",e.fill()}drawLine(e,t){let s=this.p1.toScreen(this.scene),i=this.p2.toScreen(this.scene);e.beginPath(),e.lineWidth=Math.max(.5,2*t),e.lineCap="round",e.strokeStyle="#1884cf80",e.moveTo(s.x,s.y);for(let t of this.points.map((e=>e.toScreen(this.scene))))e.lineTo(t.x,t.y);e.lineTo(i.x,i.y),e.stroke()}}async function digestMessage(e){const t=(new TextEncoder).encode(e),s=await crypto.subtle.digest("SHA-256",t);return Array.from(new Uint8Array(s)).map((e=>e.toString(16).padStart(2,"0"))).join("")}const Main=class extends BaseScene{races=[];playing=!1;raceTimes=new racetimes(this);ready=!1;loading=!1;constructor(e){super(e),this.raceProgress=new raceprogress(this),this.settings.isCampaign&&(this.campaignScore=new campaignscore(this)),this.state=this.setStateDefaults(),this.oldState=this.setStateDefaults(),this.createMainPlayer(),this.registerTools(),this.setStartingVehicle(),this.restart(),!1!==e.settings.analyticsEnabled&&this.initAnalytics(),GameManager.once("gameComplete",(()=>{let t={race:structuredClone(this.state.dialogOptions.postData),user:e.settings.user};this.settings.bestGhostEnabled&&-1===this.races.findIndex((e=>this.uniqesByUserIdIterator(t)==this.uniqesByUserIdIterator(e)&&e.race.run_ticks<=t.race.run_ticks))&&this.addRaces([t]),this.settings.fullscreen&&this.command("focused",!0),e.emit("trackRaceUploadSuccess",t)}))}getCanvasOffset(){return{height:0,width:0}}createMainPlayer(){let e=super.createMainPlayer();e.setKeyMap(this.settings.playHotkeys),e.recordKeys(this.settings.keysToRecord)}createTrack(){let e=super.createTrack(),t=this.getAvailableTrackCode();0!=t&&(e.read(t),this.setTrackAllowedVehicles(),this.state.preloading=!1,this.loading=!1,this.restartTrack=!0,this.ready=!0)}play(){this.state.playing||(this.state.playing=!0,this.hideControlPlanel())}buttonDown(e){if("exit_fullscreen"===e&&(this.state.playing=!1,!this.state.fullscreen)){const e="settings";this.state.showDialog===e?this.state.showDialog=null:this.openDialog("settings")}this.state.showDialog||super.buttonDown(e)}exitFullscreen(){if(!super.exitFullscreen())return!1;!1!==this.settings.analyticsEnabled&&this.trackEvent("game-ui","game-fullscreen-toggle","game-out-fullscreen")}toggleFullscreen(){super.toggleFullscreen()&&!1!==this.settings.analyticsEnabled&&this.trackEvent("game-ui","game-fullscreen-toggle",this.settings.fullscreen?"game-into-fullscreen":"game-out-fullscreen")}trackEvent(e,t,s){Application.Helpers.GoogleAnalyticsHelper.track_event({category:e,action:t,label:s,value:0,non_interaction:!0})}setTrackAllowedVehicles(){let e=this.track,t=this.settings.track;t&&(e.allowedVehicles=t.vehicles)}registerTools(){let e=super.registerTools();e.registerTool(PathTracer),e.setTool("Camera")}fixedUpdate(){this.ready&&super.fixedUpdate()}update(){super.update(...arguments),this.updateScore()}draw(e){super.draw(...arguments),this.campaignScore&&this.campaignScore.draw(e),window.hasOwnProperty("lite")&&lite.storage.get("raceProgress")&&this.state.inFocus&&this.camera.playerFocus&&this.raceProgress.draw(e),this.raceTimes.draw(e)}isStateDirty(){let e=this.state;return e.fullscreen!=this.settings.fullscreen&&(e.fullscreen=this.settings.fullscreen),super.isStateDirty()}updateScore(){this.campaignScore&&this.campaignScore.update(),window.hasOwnProperty("lite")&&lite.storage.get("raceProgress")&&this.camera.playerFocus&&this.raceProgress.update(this.camera.playerFocus),this.raceTimes.update()}restart(){this.message.show("Press Any Key To Start",1),this.track.resetPowerups(),this.restartTrack=!1,this.state.paused=!1,this.state.playing=!this.settings.waitForKeyPress,this.ticks=0,this.playerManager.reset(),this.playerManager.getPlayerCount()>0&&(this.camera.focusIndex=1),this.camera.focusOnPlayer(),this.camera.fastforward(),this.showControlPlanel("main"),this.resetRaceTimes()}setStartingVehicle(){let e=this.settings,t=e.startVehicle;e.track&&(t=e.track.vehicle),this.vehicle=t}updatePlayers(){this.playerManager.update()}hideControlPlanel(){this.state.showSkip&&(this.state.showSkip=!1),!1!==this.state.showControls&&(this.state.showControls=!1)}showControlPlanel(e){this.settings.isCampaign&&this.settings.campaignData.can_skip&&this.analytics&&this.analytics.deaths>5&&(this.state.showSkip=!0),this.state.showControls!==e&&this.settings.showHelpControls&&(this.state.showControls=e)}resize(){this.raceProgress.resize()}setStateDefaults(){let e=super.setStateDefaults();return e.paused=!1,e.playerAlive=!0,e.showControls=!1,e.showSkip=!1,e}command(e,...t){switch(super.command(...arguments),e){case"clear race":this.races.splice(0),this.restartTrack=!0,this.raceTimes.clear();break;case"add race":let e=t[0],s=t[1];this.addRaces(e),s&&(this.state.dialogOptions={races:this.races},this.command("dialog","race_dialog"));break;case"change vehicle":let i=t[0];this.selectVehicle(i);break;case"restart":this.command("dialog",!1),this.restartTrack=!0;break;case"resume":this.state.paused=!1;break;case"fullscreen":this.toggleFullscreen();break;case"exit_fullscreen":this.exitFullscreen()}}addRaces(e){this.mergeRaces(e),this.sortRaces(),this.formatRaces(),this.game.emit("trackChallengeUpdate",this.races),this.addRaceTimes(),this.addPlayers(),this.restartTrack=!0}addRaceTimes(){let e=this.settings.raceColors,t=e.length,s=this.races,i=this.raceTimes;i.clear();for(let a in s){let o=s[a];o.user.color=window.hasOwnProperty("lite")&&lite.constructor.integrateBadges(o.user)||e[a%t],i.addRace(o,a)}}addPlayers(){let e=this.playerManager;e.clear();let t=this.settings.keysToRecord;for(let{user:s,race:i}of this.races){let a=i.code;"string"==typeof a&&(a=JSON.parse(a));let o=e.createPlayer(this,s);o.setBaseVehicle(i.vehicle),o.setAsGhost(),o.getGamepad().loadPlayback(a,t),e.addPlayer(o)}}clearRaces(){this.races.splice(0),this.game.emit("trackChallengeUpdate",this.races),this.raceTimes.clear(),this.playerManager.clear()}formatRaces(e){e||=this.races;for(let{race:t}of e.filter((e=>"string"==typeof e.race.code))){let e=JSON.parse(t.code);e.hasOwnProperty("bike_options")&&e.bike_options instanceof Array&&(e.bike_options=new Map(e.bike_options.map((e=>e.split(/\s*:\s*/)))));for(let t of Object.keys(Object.fromEntries(Object.entries(e).filter((([,e])=>e instanceof Array)))))e[t]=e[t].reduce(((e,t)=>(e[t]=1+~~e[t],e)),{});t.code=e}return e}removeDuplicateRaces(){this.races=this.races.filter(((e,t,s)=>t===s.findIndex((t=>this.uniqesByUserIdIterator(t)==this.uniqesByUserIdIterator(e)))))}removeRaces(e){e=Array.from(e).map((e=>parseInt(e)));let t=this.races;for(let s of t.filter((({user:t})=>e.includes(t.u_id))))s=t.splice(t.indexOf(s),1),this.playerManager.removePlayer(e),this.game.emit("trackRaceDelete",s[0]);this.game.emit("trackChallengeUpdate",this.races),this.addRaceTimes(),this.camera.focusOnMainPlayer()}uniqesByUserIdIterator(e){let t=e.user;return String(t.u_id)}sortRaces(){this.races.length>1?this.races.sort(((e,t)=>this.sortByRunTicksIterator(e)-this.sortByRunTicksIterator(t))):this.sortByRunTicksIterator(this.races[0])}mergeRaces(e){let t=this.races;e&&e.forEach((e=>{let s=t.find((t=>this.uniqesByUserIdIterator(t)==this.uniqesByUserIdIterator(e)));s?(s.runTime=null,this.sortByRunTicksIterator(Object.assign(s,e))):(t.push(e),this.game.emit("trackRaceCreate",e))}))}resetRaceTimes(){for(let e of this.raceTimes.raceList.filter((e=>e.children.length>2)))e.children[2].text="0/"+this.track.targetCount,e.setDirty()}redraw(){super.redraw(),this.raceProgress.redraw(),this.raceTimes.redraw()}sortByRunTicksIterator(e){let t=parseInt(e.race.run_ticks);return e.runTime||=formatnumber(t/this.settings.drawFPS*1e3),t}toggleFullscreen(){if(!this.settings.embedded)return super.toggleFullscreen();let e=this.settings,t=e.basePlatformUrl+"/t/"+e.track.url;window.open(t)}verifyComplete(){let e=this.playerManager.firstPlayer._powerupsConsumed.targets;return-1===this.track.targets.findIndex((t=>-1===e.indexOf(t.id)))}async trackComplete(){if(this.verifyComplete()){this.sound.play("victory_sound");let e=this.playerManager;e.mutePlayers();let t=e.firstPlayer,s=t.getGamepad(),i=s.getReplayString(),a=this.settings,o=this.ticks,r=formatnumber(o/a.drawFPS*1e3),n={t_id:$("#track-data").data("t_id"),u_id:a.user.u_id,code:i,vehicle:t._baseVehicleType,run_ticks:o,fps:25,time:r};n.sig=await digestMessage(n.t_id+"|"+n.u_id+"|"+n.code+"|"+n.run_ticks+"|"+n.vehicle+"|"+n.fps+"|erxrHHcksIHHksktt8933XhwlstTekz");let h=this.races;h.length>0&&(n.races=h.map((({user:e})=>e.u_id))),a.isCampaign&&(n.is_campaign=!0);let l={postData:n,analytics:this.analytics};this.state.dialogOptions=Object.assign({},l),navigator.onLine?this.game.emit("trackRaceUpload",l):(this.state.dialogOptions.postData={},this.game.emit("trackRaceUploadError",Object.defineProperty(new Error("Network Error: Failed to upload race"),"data",{value:Object.assign({},l)}))),this.command("dialog",(a.isCampaign?"campaign":"track")+"_complete"),s.reset(!0),this.listen()}}close(){this.raceTimes=null,this.score=null,this.campaignScore=null,super.close()}},events={BeforeDraw:"beforeDraw",Clear:"clear",Debug:"debug",Draw:"draw",Error:"error",PlayerBaseVehicleCreate:"playerBaseVehicleCreate",PlayerBaseVehicleDraw:"playerBaseVehicleDraw",PlayerCreate:"playerCreate",PlayerDraw:"playerDraw",PlayerTempVehicleCreate:"playerTempVehicleCreate",PlayerTempVehicleDraw:"playerTempVehicleDraw",PlayerUpdate:"playerUpdate",PlayerVehicleCreate:"playerVehicleCreate",PlayerVehicleDraw:"playerVehicleDraw",Ready:"ready",Resize:"resize",SceneChange:"sceneChange",SoundCreate:"soundCreate",SoundDelete:"soundDelete",SoundUpdate:"soundUpdate",StateChange:"stateChange",Stats:"stats",Tick:"tick"},SCENES={Editor,Main};class Game extends EventEmitter{static Events=events;#s=0;#i=performance.now();#a=performance.now();#o=0;stats={fps:0,ups:0};config={maxFrameRate:null,tickRate:30};frameInterval=1e3/this.config.maxFrameRate;interpolation=!0;updateInterval=1e3/this.config.tickRate;assets=null;canvas=null;currentScene=null;gameContainer=null;height=0;onStateChange=null;pixelRatio=window.devicePixelRatio;width=0;constructor(e,t,s){super(),Object.defineProperties(this,{lastTime:{value:performance.now(),writable:!0},linearInterpolation:{value:!0,writable:!0},progress:{value:0,writable:!0}}),this.assets=t,s.UIDarkerGrayColor||="#777777",s.UIGrayColor||="#808080",s.UITextColor||="#000000",this.settings=s,this.initCanvas(),this.setSize(),this.switchScene(e),(globalThis.createjs||={}).Ticker||=this,Object.defineProperty(this,"updateCallback",{value:requestAnimationFrame(this.update.bind(this)),writable:!0}),this.emit(events.Ready)}command(){this.currentScene.command.apply(this.currentScene,arguments)}freeze(){cancelAnimationFrame(this.updateCallback)}initCanvas(){this.canvas=document.createElement("canvas"),this.canvas.addEventListener("dblclick",(()=>this.currentScene instanceof Main&&this.currentScene.toggleFullscreen()),{passive:!0}),this.ctx=this.canvas.getContext("2d"),this.gameContainer=document.getElementById(this.settings.defaultContainerID),null!==this.gameContainer&&this.gameContainer.appendChild(this.canvas)}resetFrameProgress(){this.lastTime=performance.now(),this.progress=0,this.config.maxFrameRate&&(this.#i=this.lastTime)}resume(){this.updateCallback=requestAnimationFrame(this.update.bind(this))}setMaxFrameRate(e){this.config.maxFrameRate=e,this.frameInterval=1e3/e}setSize(){let e=window.innerHeight,t=window.innerWidth;this.settings.fullscreen||this.settings.isStandalone||(e=this.gameContainer.clientHeight,t=this.gameContainer.clientWidth),this.currentScene&&(e-=this.currentScene.getCanvasOffset().height);let s=1;window.devicePixelRatio&&(s=window.devicePixelRatio),this.settings.lowQualityMode&&(s=1);let i=t*s,a=e*s;(i!==this.width||a!==this.height)&&(this.width=i,this.height=a,this.canvas.width=i,this.canvas.height=a),this.pixelRatio=s,this.canvas.style.width=t+"px",this.canvas.style.height=e+"px",this.ctx.imageSmoothingEnabled=!1,this.ctx.lineCap="round",this.ctx.lineJoin="round",this.ctx.strokeStyle=this.settings.physicsLineColor,this.currentScene&&(this.currentScene.command("resize"),this.currentScene.screen.update(),(this.currentScene.state.paused||!this.currentScene.state.playing)&&this.currentScene.draw(this.ctx)),this.emit(events.Resize,{devicePixelRatio:s,height:a,width:i})}switchScene(e){null!==this.currentScene&&this.currentScene.close(),this.currentScene=new SCENES[e](this),this.emit(events.SceneChange,this.currentScene)}update(e){if(null!==this._lastRafTime){let t=e-this._lastRafTime;(this._rafDeltaHist||=[]).push(t),this._rafDeltaHist.length>300&&this._rafDeltaHist.shift(),t>20&&console.warn(`Slow rAF frame: ${Math.round(t)}ms`)}this._lastRafTime=e,this.updateCallback=requestAnimationFrame(this.update.bind(this)),this._wasPaused!==this.currentScene.state.paused&&(this._wasPaused=this.currentScene.state.paused,!this.currentScene.state.paused&&this.resetFrameProgress(),this.lastTime=e);let t=e-this.lastTime;for(t>=1e3&&(t=this.updateInterval),this.progress+=t/this.updateInterval,this.lastTime=e;this.progress>=1;)this.progress--,this.emit(events.Tick,this.currentScene.ticks)||(this.currentScene.fixedUpdate(),this.#o++);(!this.config.maxFrameRate||e-this.#i>=this.frameInterval)&&(this.config.maxFrameRate&&(this.#i=e),this.currentScene.update(this.progress),this.currentScene.lateUpdate(this.progress),this.currentScene.draw(this.ctx),this.emit(events.Draw,this.ctx),this.#s++),e-this.#a>=1e3&&(this.#a=e,this.stats.ups=this.#o,this.stats.fps=this.#s,this.#o=0,this.#s=0,this.emit(events.Stats,{fps:this.stats.fps,ups:this.stats.ups}))}close(){this.freeze(),this.updateCallback=null,this.currentScene.close(),this.currentScene=null,this.assets=null,this.settings=null,this.canvas.remove(),this.canvas=null,this.ctx=null,this.height=null,this.width=null}}Object.defineProperty(self,"Game",{value:Game,writable:!0})})();